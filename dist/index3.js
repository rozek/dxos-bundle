import{P as j,y as Ie,a as w,z as y,B as ue,b as f,l as c,R as D,F as Pe,G as ge,T as W,d as q,H,k as Ue,J as K,K as Y,L as _e,N as we,O as ye,t as fe,U as m,V as M,W as me,g as v,X as Z,Y as Q,_ as R,Z as ve,h as Ne,$ as S,a0 as je,a1 as F,A as Se,a2 as De,a3 as We,a4 as qe,a5 as He,a6 as Ke,a7 as $e,a8 as ze,a9 as Be,aa as Ge,ab as Ve,ac as Je,ad as Xe,ae as Ye,af as Ze,ag as Qe,ah as et,ai as tt,aj as st,ak as rt,al as nt,am as it,an as at,ao as ot,ap as ct,aq as lt,ar as ht,as as dt,__tla as pt}from"./index.js";import{at as ut,au as gt,__tla as _t}from"./index.js";let $,ee,L,E,I,z,k,ke,B,C,Ce,G,te,se,re,ne,wt=Promise.all([(()=>{try{return pt}catch{}})(),(()=>{try{return _t}catch{}})()]).then(async()=>{const be=Object.freeze(Object.defineProperty({__proto__:null,Connection:Ge,ConnectionLimiter:Ve,ConnectionLog:Je,get ConnectionState(){return Xe},get EventType(){return Ye},LibDataChannelTransport:Ze,MAX_CONCURRENT_INITIATING_CONNECTIONS:Qe,MMSTTopology:et,MemoryTransport:tt,MemoryTransportFactory:st,NetworkManager:rt,SimplePeerTransport:nt,SimplePeerTransportService:it,Swarm:at,SwarmMapper:ot,SwarmMessenger:ct,get TransportKind(){return lt},createLibDataChannelTransportFactory:ve,createSimplePeerTransportFactory:ht,createTeleportProtocolFactory:dt},Symbol.toStringTag,{value:"Module"}));var xe="dxos-client-worker";class T extends Error{}T.prototype.name="InvalidTokenError";function Me(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,s)=>{let n=s.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function Re(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Me(e)}catch{return atob(e)}}function ie(t,e){if(typeof t!="string")throw new T("Invalid token specified: must be a string");e||(e={});const s=e.header===!0?0:1,n=t.split(".")[s];if(typeof n!="string")throw new T(`Invalid token specified: missing part #${s+1}`);let i;try{i=Re(n)}catch(r){throw new T(`Invalid token specified: invalid base64 for part #${s+1} (${r.message})`)}try{return JSON.parse(i)}catch(r){throw new T(`Invalid token specified: invalid json for part #${s+1} (${r.message})`)}}var V;(function(t){(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SUCCESS=1]="SUCCESS",e[e.NOT_AUTHORIZED=2]="NOT_AUTHORIZED",e[e.ERROR=3]="ERROR"})(t.InitAuthSequenceResult||(t.InitAuthSequenceResult={}))})(V||(V={}));var Le={};function Te(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let ae;ae="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/agent.ts",ne=(t,e="unix")=>`${e}://`+ze(Be,t,"agent.sock"),$=class{constructor(t){this._profile=t,this.closed=new w}get descriptors(){return S}get services(){return this._client.rpc}async open(){const{WebsocketRpcClient:t}=await R(async()=>{const{WebsocketRpcClient:e}=await import("./index.js").then(async s=>(await s.__tla,s)).then(s=>s.aw);return{WebsocketRpcClient:e}},[]);this._client=new t({url:ne(this._profile,"ws+unix"),requested:S,exposed:{},handlers:{}}),this._client.error.on(e=>{this.closed.emit(e)}),await this._client.open()}async close(){var t;try{await((t=this._client)==null?void 0:t.close())}catch(e){c.warn("Failed to close",e,{F:ae,L:72,S:this,C:(s,n)=>s(...n)})}}},$=Te([v.resource({annotation:Z})],$);function P(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let oe,ce;oe="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/local-client-services.ts",G=async(t=new Q,e,s,n)=>{const i=await ce(t,{},()=>n?{...r.signalMetadataTags,...s?{group:s}:{}}:{}),r=new k({config:t,...i,...e});return r},ce=async(t,e={},s)=>{const{MemorySignalManager:n,MemorySignalManagerContext:i,WebsocketSignalManager:r}=await R(async()=>{const{MemorySignalManager:h,MemorySignalManagerContext:g,WebsocketSignalManager:p}=await import("./index.js").then(async u=>(await u.__tla,u)).then(u=>u.av);return{MemorySignalManager:h,MemorySignalManagerContext:g,WebsocketSignalManager:p}},[]),{createSimplePeerTransportFactory:a,MemoryTransportFactory:o}=await R(async()=>{const{createSimplePeerTransportFactory:h,MemoryTransportFactory:g}=await Promise.resolve().then(()=>be);return{createSimplePeerTransportFactory:h,MemoryTransportFactory:g}},void 0),d=t.get("runtime.services.signaling");if(d){const{signalManager:h=new r(d,s),transportFactory:g=Le.MOCHA_ENV==="nodejs"?ve({iceServers:t.get("runtime.services.ice")}):a({iceServers:t.get("runtime.services.ice")})}=e;return{signalManager:h,transportFactory:g}}return c.warn("P2P network is not configured.",void 0,{F:oe,L:82,S:void 0,C:(h,g)=>h(...g)}),{signalManager:new n(new i),transportFactory:o}},k=class{constructor(t){this.closed=new w,this._ctx=new Ne,this.signalMetadataTags={runtime:"local-client-services"},this._isOpen=!1,this._params=t,typeof window>"u"?this.signalMetadataTags.origin="undefined":globalThis.__args?(this.signalMetadataTags.runtime="native",this.signalMetadataTags.origin=window.location.origin):this.signalMetadataTags.origin=window.location.origin}get descriptors(){return S}get services(){var t;return((t=this._host)==null?void 0:t.services)??{}}get host(){return this._host}async open(){if(this._isOpen)return;const{ClientServicesHost:t}=await R(async()=>{const{ClientServicesHost:e}=await import("./index.js").then(async s=>(await s.__tla,s)).then(s=>s.ax);return{ClientServicesHost:e}},[]);this._host=new t({...this._params,callbacks:{...this._params.callbacks,onReset:async()=>{var e,s;this.closed.emit(void 0),await((s=(e=this._params.callbacks)==null?void 0:e.onReset)==null?void 0:s.call(e))}}}),await this._host.open(this._ctx),this._isOpen=!0,je({identityService:this._host.services.IdentityService,devicesService:this._host.services.DevicesService,setTag:(e,s)=>{this.signalMetadataTags[e]=s}})}async close(){var t;this._isOpen&&(await((t=this._host)==null?void 0:t.close()),this._isOpen=!1)}},P([v.info()],k.prototype,"_isOpen",void 0),P([F],k.prototype,"open",null),P([F],k.prototype,"close",null),k=P([v.resource({annotation:Z})],k);let J,O,le;J="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/socket.ts",se=async(t,e)=>{const s=new w;let n;return{get closed(){return s},get descriptors(){return S},get services(){return n.rpc},open:async()=>{const{WebsocketRpcClient:i}=await R(async()=>{const{WebsocketRpcClient:r}=await import("./index.js").then(async a=>(await a.__tla,a)).then(a=>a.aw);return{WebsocketRpcClient:r}},[]);n=new i({url:t,authenticationToken:e,requested:S,exposed:{},handlers:{}}),n.error.on(async r=>{c.warn("websocket rpc client error",{error:r},{F:J,L:42,S:void 0,C:(a,o)=>a(...o)}),r.message.includes("401")&&c.warn("websocket authentication failed",void 0,{F:J,L:45,S:void 0,C:(a,o)=>a(...o)}),s.emit(new Se("websocket error"))}),await n.open()},close:async()=>{await n.close()}}},z=class{constructor({source:t,onOpen:e,onMessage:s}){this._source=t,this._onOpen=e,this._onMessage=s,this._messageHandler=this._messageHandler.bind(this)}get source(){return this._source}get iframe(){return this._iframe}async open(){var e;if(this._iframe)return;window.addEventListener("message",this._messageHandler);const t=`__DXOS_CLIENT_${j.random().toHex()}__`;this._iframe=Ie(this._source.toString(),t,{allow:"clipboard-read; clipboard-write"}),await((e=this._onOpen)==null?void 0:e.call(this))}async close(){var t;window.removeEventListener("message",this._messageHandler),(t=this._iframe)==null||t.remove(),this._iframe=void 0}async _messageHandler(t){var e;(e=this._onMessage)==null||e.call(this,t)}},O="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/shell-manager.ts",le=Object.entries({display:"none",position:"fixed",top:0,left:0,width:"100vw",height:"100vh",border:0,"z-index":60}).reduce((t,[e,s])=>`${t}${e}: ${s};`,""),B=class{constructor(t,e=ue){this._iframeManager=t,this._channel=e,this.contextUpdate=new w,this._display=y.NONE}get display(){return this._display}async setLayout(t){f(this._shellRpc,"ShellManager not open",{F:O,L:57,S:this,A:["this._shellRpc","'ShellManager not open'"]}),c("set layout",t,{F:O,L:58,S:this,C:(e,s)=>e(...s)}),this._display=y.FULLSCREEN,this.contextUpdate.emit({display:this._display}),await this._shellRpc.rpc.ShellService.setLayout(t,{timeout:D})}async setInvitationUrl(t){var e;c("set invitation url",t,{F:O,L:65,S:this,C:(s,n)=>s(...n)}),await((e=this._shellRpc)==null?void 0:e.rpc.ShellService.setInvitationUrl(t,{timeout:D}))}async open(){if(this._shellRpc)return;await this._iframeManager.open();const t=this._iframeManager.iframe;t.setAttribute("style",le),t.setAttribute("name","dxos-shell"),t.setAttribute("data-testid","dxos-shell"),this.contextUpdate.on(({display:n,reload:i})=>{i&&window.location.reload(),t.style.display=n===y.NONE?"none":"",n===y.NONE&&t.blur()});const e=this._iframeManager.source.origin==="null"?this._iframeManager.source.toString().split("/").slice(0,3).join("/"):this._iframeManager.source.origin,s=Pe({origin:e,channel:this._channel,iframe:this._iframeManager.iframe});this._shellRpc=ge({requested:De,exposed:We,handlers:{AppService:{setContext:async n=>{c("set context",n,{F:O,L:110,S:this,C:(i,r)=>i(...r)}),n.display&&(this._display=n.display),this.contextUpdate.emit(n)}}},port:s}),await this._shellRpc.open()}async close(){var t;this._shellRpc&&(await((t=this._shellRpc)==null?void 0:t.close()),this._shellRpc=void 0)}};function Oe(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}E=class{constructor({host:t,source:e=Y,vault:s=_e,timeout:n=we}){this.closed=new w,this._host=t,this._source=e,this._vault=s,this._timeout=n;const i=new W;this._iframeManager=new z({source:new URL(this._source,window.location.origin),onOpen:async()=>{var r,a,o;await q(i.wait(),this._timeout,new H("Vault failed to load")),(o=(a=(r=this._iframeManager)==null?void 0:r.iframe)==null?void 0:a.contentWindow)==null||o.postMessage({channel:this._vault,payload:"init"},this._iframeManager.source.origin)},onMessage:r=>{var d,h,g;const{channel:a,payload:o}=r.data;if(a===this._vault){if(o==="loaded")i.wake();else if(o==="client"){const p=new MessageChannel,u=Ue({services:this._host.descriptors,handlers:this._host.services,port:K({port:p.port1})});(g=(h=(d=this._iframeManager)==null?void 0:d.iframe)==null?void 0:h.contentWindow)==null||g.postMessage({channel:this._vault,payload:{command:"port",port:p.port2}},this._iframeManager.source.origin,[p.port2]),u.open()}}}}),this._shellManager=new B(this._iframeManager)}get descriptors(){return this._host.descriptors}get services(){return this._host.services}async open(){await this._host.open(),await this._shellManager.open()}async close(){await this._shellManager.close(),await this._iframeManager.close(),await this._host.close()}},E=Oe([v.resource()],E);function Ae(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let X;X="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/service-proxy.ts",L=class{constructor(t,e=3e4){this._port=t,this._timeout=e,this.closed=new w}get proxy(){return f(this._proxy,"Client services not open",{F:X,L:30,S:this,A:["this._proxy","'Client services not open'"]}),this._proxy}get descriptors(){return S}get services(){return f(this._proxy,"Client services not open",{F:X,L:39,S:this,A:["this._proxy","'Client services not open'"]}),this._proxy.rpc}async open(){this._proxy||(this._proxy=ge({requested:S,exposed:{},handlers:{},port:this._port}),await q(this._proxy.open(),this._timeout,new H("Failed to establish dxrpc connection",{timeout:this._timeout})))}async close(){this._proxy&&(await this._proxy.close(),this._proxy=void 0)}},L=Ae([v.resource({annotation:Z})],L);function Fe(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let b;b="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/iframe-service-proxy.ts",I=class{constructor({source:t=Y,shell:e=ue,vault:s=_e,timeout:n=we,logFilter:i="error,warn"}={}){this.closed=new w,this._instanceId=j.random().toHex(),this._source=t,this._shell=e,this._vault=s,this._logFilter=ye(i),this._timeout=n;const r=new W,a=new W;this._iframeManager=new z({source:new URL(typeof this._shell=="string"?this._source:`${this._source}#disableshell`,window.location.origin),onOpen:async()=>{var d,h;await q(r.wait(),this._timeout,new H("Vault failed to load")),(h=(d=this._iframeManager.iframe)==null?void 0:d.contentWindow)==null||h.postMessage({channel:this._vault,payload:"init"},this._iframeManager.source.origin);const o=await q(a.wait(),this._timeout,new H("Vault failed to provide MessagePort"));this._appPort=K({port:o})},onMessage:async o=>{const{channel:d,payload:h}=o.data;d===this._vault&&(h==="loaded"?r.wake():(h==null?void 0:h.command)==="init"&&a.wake(h.port))}}),typeof this._shell=="string"&&(this._shellManager=new B(this._iframeManager))}get proxy(){return this._clientServicesProxy.proxy}get descriptors(){return this._clientServicesProxy.descriptors}get services(){return this._clientServicesProxy.services}async open(){var t;this._clientServicesProxy||(c.trace("dxos.sdk.iframe-clientTraceices-proxy",fe.begin({id:this._instanceId}),{F:b,L:142,S:this,C:(e,s)=>e(...s)}),await this._iframeManager.open(),this._clientServicesProxy=new L(this._appPort),await this._clientServicesProxy.open(),this._loggingStream=this._clientServicesProxy.services.LoggingService.queryLogs({filters:this._logFilter},{timeout:D}),this._loggingStream.subscribe(e=>{switch(e.level){case m.DEBUG:c.debug(`[vault] ${e.message}`,e.context,{F:b,L:157,S:this,C:(s,n)=>s(...n)});break;case m.INFO:c.info(`[vault] ${e.message}`,e.context,{F:b,L:160,S:this,C:(s,n)=>s(...n)});break;case m.WARN:c.warn(`[vault] ${e.message}`,e.context,{F:b,L:163,S:this,C:(s,n)=>s(...n)});break;case m.ERROR:c.error(`[vault] ${e.message}`,e.context,{F:b,L:166,S:this,C:(s,n)=>s(...n)});break}}),await((t=this._shellManager)==null?void 0:t.open()))}async close(){var t,e,s;await((t=this._shellManager)==null?void 0:t.close()),await this._iframeManager.close(),await((e=this._loggingStream)==null?void 0:e.close()),await((s=this._clientServicesProxy)==null?void 0:s.close()),this._clientServicesProxy=void 0,c.trace("dxos.sdk.iframe-clientTraceices-proxy",fe.end({id:this._instanceId}),{F:b,L:180,S:this,C:(n,i)=>n(...i)})}},I=Fe([v.resource()],I);let he;he="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/utils.ts",te=async(t=new Q,e={})=>{if(c("creating client services",{config:t},{F:he,L:25,S:void 0,C:(n,i)=>n(...i)}),typeof window>"u")throw new Se("Cannot configure IFrame bridge outside of browser environment.");const s=t.get("runtime.client.remoteSource");return e.vault||qe()?new E({host:await He(G(t)),source:s,vault:e.vault,timeout:e.timeout}):new I({source:s,...e})};function U(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let x;x="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/worker-client-services.ts",re=async(t=new Q,e)=>new C({config:t,...e}),C=class{constructor({config:t,createWorker:e,logFilter:s="error,warn",observabilityGroup:n,signalTelemetryEnabled:i}){this.closed=new w,this.joinedSpace=new w,this._isOpen=!1,this._config=t,this._createWorker=e,this._logFilter=ye(s),this._observabilityGroup=n,this._signalTelemetryEnabled=i??!1}get descriptors(){return S}get services(){return this._services.services}get runtime(){return this._runtime}async open(){if(this._isOpen)return;c("opening...",void 0,{F:x,L:88,S:this,C:(r,a)=>r(...a)});const{SharedWorkerConnection:t}=await R(async()=>{const{SharedWorkerConnection:r}=await import("./index.js").then(async a=>(await a.__tla,a)).then(a=>a.ax);return{SharedWorkerConnection:r}},[]),e=new W,s=this._createWorker();s.port.postMessage({dxlog:localStorage.getItem("dxlog")}),s.port.onmessage=r=>{const{command:a,payload:o}=r.data;a==="init"&&e.wake(o)};const{systemPort:n,appPort:i}=await e.wait();this._runtime=new t({config:this._config,systemPort:K({port:n})}),await this._runtime.open({origin:location.origin,observabilityGroup:this._observabilityGroup,signalTelemetryEnabled:this._signalTelemetryEnabled}),this._services=new L(K({port:i})),await this._services.open(),navigator.locks.request(xe,()=>{c("terminated",void 0,{F:x,L:115,S:this,C:(r,a)=>r(...a)}),this._isOpen&&this.closed.emit(new Error("Shared worker terminated."))}),this._loggingStream=this._services.services.LoggingService.queryLogs({filters:this._logFilter},{timeout:D}),this._loggingStream.subscribe(r=>{switch(r.level){case m.DEBUG:c.debug(r.message,r.context,A(r.meta));break;case m.INFO:c.info(r.message,r.context,A(r.meta));break;case m.WARN:c.warn(r.message,r.context,A(r.meta));break;case m.ERROR:c.error(r.message,r.context,A(r.meta));break}}),c("opened",void 0,{F:x,L:144,S:this,C:(r,a)=>r(...a)}),this._isOpen=!0}async close(){var t;this._isOpen&&(c("closing...",void 0,{F:x,L:154,S:this,C:(e,s)=>e(...s)}),await((t=this._loggingStream)==null?void 0:t.close()),await this._runtime.close(),await this._services.close(),c("closed",void 0,{F:x,L:159,S:this,C:(e,s)=>e(...s)}),this._isOpen=!1)}},U([v.info()],C.prototype,"_isOpen",void 0),U([F],C.prototype,"open",null),U([F],C.prototype,"close",null),C=U([v.resource()],C);let A,de;A=t=>{var e;return t&&{F:t.file,L:t.line,S:{...t.scope,remoteSessionId:(e=t.scope)==null?void 0:e.hostSessionId,hostSessionId:void 0}}},de="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/client-services-factory.tsx",Ce=(t,e,s,n)=>{var r,a,o,d;const i=(a=(r=t.values.runtime)==null?void 0:r.client)==null?void 0:a.remoteSource;if(i)switch(new URL(i).protocol.slice(0,-1)){case"ws":case"wss":return se(i,(d=(o=t.values.runtime)==null?void 0:o.client)==null?void 0:d.remoteSourceAuthenticationToken);case"http":case"https":return c.warn("IFrame services deprecated.",void 0,{F:de,L:40,S:void 0,C:(h,g)=>h(...g)}),te(t)}return e&&typeof SharedWorker<"u"?re(t,{createWorker:e,observabilityGroup:s,signalTelemetryEnabled:n}):G(t,{},s,n)},ke=class{constructor({shellManager:t,identity:e,devices:s,spaces:n}){this._shellManager=t,this._identity=e,this._devices=s,this._spaces=n}async setInvitationUrl(t){await this._shellManager.setInvitationUrl(t)}async open(t=M.IDENTITY,e={}){await this._shellManager.setLayout({layout:t,...e})}async initializeIdentity({invitationCode:t}={}){return await this._shellManager.setLayout({layout:M.INITIALIZE_IDENTITY,invitationCode:t}),new Promise(e=>{this._shellManager.contextUpdate.on(s=>{s.display===y.NONE&&e({cancelled:!0})}),this._identity.subscribe(s=>{s&&e({identity:s,cancelled:!1})})})}async shareIdentity(){if(!this._identity.get())return{error:new Error("Identity does not exist"),cancelled:!1};const t=new me(e=>e.toHex(),this._devices.get().map(e=>e.deviceKey));return await this._shellManager.setLayout({layout:M.SHARE_IDENTITY}),new Promise(e=>{this._shellManager.contextUpdate.on(s=>{if(s.display===y.NONE){const n=this._devices.get().find(i=>!t.has(i.deviceKey));e({device:n,cancelled:!n})}})})}async shareSpace({spaceKey:t,target:e}){if(!this._identity.get())return{error:new Error("Identity does not exist"),cancelled:!1};const s=this._spaces.get().find(i=>i.key.equals(t));if(!s)return{error:new Error("Space does not exist"),cancelled:!1};const n=new me(i=>i.toHex(),s.members.get().map(i=>i.identity.identityKey));return await this._shellManager.setLayout({layout:M.SPACE,spaceKey:t,target:e}),new Promise(i=>{this._shellManager.contextUpdate.on(r=>{if(r.display===y.NONE){const a=s.members.get().filter(o=>!n.has(o.identity.identityKey));i({members:a,cancelled:a.length===0})}})})}async joinSpace({invitationCode:t}={}){return this._identity.get()?(await this._shellManager.setLayout({layout:M.JOIN_SPACE,invitationCode:t}),new Promise(e=>{this._shellManager.contextUpdate.on(s=>{const n=s.spaceKey&&this._spaces.get().find(i=>{var r;return(r=s.spaceKey)==null?void 0:r.equals(i.key)});n&&e({space:n,target:s.target,cancelled:!1}),s.display===y.NONE&&e({cancelled:!0})})})):{error:new Error("Identity does not exist"),cancelled:!1}}};function Ee(t,e,s,n){var i=arguments.length,r=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,s):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(t,e,s,n);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(i<3?a(r):i>3?a(e,s,r):a(e,s))||r);return i>3&&r&&Object.defineProperty(e,s,r),r}let l,_,pe,N;l="/home/runner/work/dxos/dxos/packages/sdk/client/src/services/agent-hosting-provider.ts",_=class extends Error{},pe={name:"default",baseUrl:"http://localhost:8082/v1alpha1/",username:"dxos"},N="COMPOSER-BETA",ee=class{constructor(t,e){this._clientConfig=t,this._halo=e,this.DXRPC_PATH="dxrpc",this._rpcState="disconnected",this._authToken=null;const s=this._clientConfig.get("runtime.services.agentHosting");f(s,"agentHosting config not found",{F:l,L:73,S:this,A:["runtimeAgentHostingConfig","'agentHosting config not found'"]}),f(s.server,"agentHosting server not found",{F:l,L:74,S:this,A:["runtimeAgentHostingConfig.server","'agentHosting server not found'"]}),this._config={...pe,baseUrl:s.server,password:this._clientConfig.get("runtime.app.env.DX_AGENTHOSTING_PASSWORD")},this._config.baseUrl.endsWith("/")||(this._config.baseUrl+="/"),this._wsDxrpcUrl=new URL(this.DXRPC_PATH,this._config.baseUrl.replace("http","ws")).href}init(t){return!!this._checkAuthorization(t)}_checkAuthorization(t){if(Object.fromEntries(document.cookie.split("; ").map(s=>s.split(/=(.*)/s).map(decodeURIComponent)))[N]==null)return!1;const e=this._decodeComposerBetaJwt();return!!(e&&e.auth_agent)}_decodeComposerBetaJwt(){return ie(this._getComposerBetaCookie())}_getComposerBetaCookie(){const t=Object.fromEntries(document.cookie.split("; ").map(e=>e.split(/=(.*)/s).map(decodeURIComponent)));return t[N]==null?null:t[N]}requestInitWithCredentials(t){return{...t,headers:{...t.headers,Authorization:"Basic "+Buffer.from(`${this._config.username}:${this._config.password}`).toString("base64")}}}requestInitWithAuthToken(t){return{...t,headers:{...t.headers,Authorization:"Bearer "+this._authToken}}}async checkEligibility(t){return!0}async _ensureAuthenticated(){if(this._validAuthToken())return;const{deviceKey:t}=this._halo.device;f(t,"deviceKey not found",{F:l,L:173,S:this,A:["deviceKey","'deviceKey not found'"]});const e=await this._queryCredentials("dxos.halo.credentials.AuthorizedDevice",s=>j.equals(s.subject.id,t));f(e.length===1,"Improper number of authorized devices",{F:l,L:178,S:this,A:["authDeviceCreds.length === 1","'Improper number of authorized devices'"]}),await this._agentManagerAuth(e[0])}async _openRpc(){if(this._rpcState!=="connected"){this._rpc=new Ke({url:this._wsDxrpcUrl,requested:{AgentManager:$e.getService("dxos.service.agentmanager.AgentManager")},noHandshake:!0}),this._rpc.connected.on(()=>{this._rpcState="connected"}),this._rpc.disconnected.on(()=>{this._rpcState="disconnected"}),this._rpc.error.on(t=>{c.info("rpc error",{err:t},{F:l,L:201,S:this,C:(e,s)=>e(...s)}),this._rpcState="disconnected"});try{await this._rpc.open()}catch(t){throw c.warn("failed to open rpc",{err:t},{F:l,L:207,S:this,C:(e,s)=>e(...s)}),new Error("Failed to open rpc")}}}async _agentManagerAuth(t){var g;await this._openRpc(),f(this._rpc,"RPC not initialized",{F:l,L:215,S:this,A:["this._rpc","'RPC not initialized'"]});const{result:e,nonce:s,agentmanagerKey:n,initAuthResponseReason:i}=await this._rpc.rpc.AgentManager.initAuthSequence({authToken:this._getComposerBetaCookie()});if(e!==V.InitAuthSequenceResult.SUCCESS||!s||!n)throw c("auth init failed",{result:e,nonce:s,agentmanagerKey:n,initAuthResponseReason:i},{F:l,L:220,S:this,C:(p,u)=>p(...u)}),new Error("Failed to initialize auth sequence");const r=await this._queryCredentials("dxos.halo.credentials.ServiceAccess",p=>j.equals(p.issuer,n));r.length?c.info("access credentials found - requesting session token..",void 0,{F:l,L:229,S:this,C:(p,u)=>p(...u)}):c.info("no access credentials - requesting...",void 0,{F:l,L:227,S:this,C:(p,u)=>p(...u)});const a=[t.id,(g=r[0])==null?void 0:g.id].filter(Boolean),o=await this._halo.presentCredentials({ids:a,nonce:s}),{token:d,credential:h}=await this._rpc.rpc.AgentManager.authenticate({presentation:o});if(d){if(this._authToken=d,!this._validAuthToken())throw c("received invalid authToken",{token:d},{F:l,L:242,S:this,C:(p,u)=>p(...u)}),new _("Received invalid authToken")}else f(h,"No credential or token received",{F:l,L:246,S:this,A:["credential","'No credential or token received'"]}),c("received credential, writing to HALO",{credential:h},{F:l,L:247,S:this,C:(p,u)=>p(...u)}),await this._halo.writeCredentials([h]),await this._agentManagerAuth(t)}_validAuthToken(){if(!this._authToken)return null;const t=ie(this._authToken);return t.exp?t.exp*1e3<Date.now()?(c("authToken expired",{decoded:t},{F:l,L:264,S:this,C:(e,s)=>e(...s)}),null):t:(c.warn("authToken missing expiry",{decoded:t},{F:l,L:260,S:this,C:(e,s)=>e(...s)}),null)}async _queryCredentials(t,e){return this._halo.credentials.get().filter(s=>!(t&&s.subject.assertion["@type"]!==t||e&&!e(s)))}async createAgent(t,e){await this._ensureAuthenticated();const s=await fetch(new URL("agent",this._config.baseUrl),this.requestInitWithAuthToken({method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invitation:t,identityKey:e})}));try{return(await s.json()).metadata.uid}catch(n){throw n instanceof TypeError?(c.warn("failed to parse response from agent create",{res:s},{F:l,L:306,S:this,C:(i,r)=>i(...r)}),new _("failed to parse response from hosting provider")):(c.warn("bad response from agent create",{res:s},{F:l,L:309,S:this,C:(i,r)=>i(...r)}),new _("bad response from hosting provider"))}}async getAgent(t){await this._ensureAuthenticated();const e=await fetch(new URL("agent/"+t,this._config.baseUrl),this.requestInitWithAuthToken({method:"GET"}));switch(e.status){case 200:break;case 404:return null;case 401:throw new _("unauthorized");case 403:throw new _("forbidden");case 500:throw c.warn("request to agent get failed",{res:e},{F:l,L:334,S:this,C:(s,n)=>s(...n)}),new _("internal server error from hosting provider");default:throw c.warn("request to agent get failed",{res:e},{F:l,L:337,S:this,C:(s,n)=>s(...n)}),new _("unknown API error")}c.info("getAgent",{res:e},{F:l,L:341,S:this,C:(s,n)=>s(...n)});try{return(await e.json()).metadata.uid}catch(s){throw s instanceof TypeError?(c.warn("failed to parse response from agent get",{err:s},{F:l,L:348,S:this,C:(n,i)=>n(...i)}),new _("failed to parse response from hosting provider")):(c.warn("bad response from agent get",{res:e},{F:l,L:351,S:this,C:(n,i)=>n(...i)}),new _("bad response from hosting provider"))}}async destroyAgent(t){await this._ensureAuthenticated();const e=await fetch(new URL("agent/"+t,this._config.baseUrl),this.requestInitWithAuthToken({method:"DELETE"}));switch(e.status){case 204:return!0;case 404:return c.warn("requested destroy on non-existent agent",void 0,{F:l,L:370,S:this,C:(s,n)=>s(...n)}),!1;case 403:throw new _("forbidden");case 500:throw c.warn("request to agent destroy failed",{res:e},{F:l,L:375,S:this,C:(s,n)=>s(...n)}),new _("internal server error from hosting provider");default:throw c.warn("request to agent destroy failed",{res:e},{F:l,L:378,S:this,C:(s,n)=>s(...n)}),new _("unknown API error")}}},Ee([F],ee.prototype,"_ensureAuthenticated",null)});export{$ as AgentClientServiceProvider,ee as AgentManagerClient,L as ClientServicesProxy,ut as DEFAULT_VAULT_ORIGIN,Y as DEFAULT_VAULT_URL,E as IFrameClientServicesHost,I as IFrameClientServicesProxy,z as IFrameManager,k as LocalClientServices,ke as Shell,y as ShellDisplay,M as ShellLayout,B as ShellManager,gt as SystemStatus,C as WorkerClientServices,wt as __tla,Ce as createClientServices,G as fromHost,te as fromIFrame,se as fromSocket,re as fromWorker,ne as getUnixSocket};
