var ga=Object.defineProperty;var ya=Object.getPrototypeOf;var ma=Reflect.get;var Ks=Et=>{throw TypeError(Et)};var ba=(Et,kt,Bt)=>kt in Et?ga(Et,kt,{enumerable:!0,configurable:!0,writable:!0,value:Bt}):Et[kt]=Bt;var ie=(Et,kt,Bt)=>ba(Et,typeof kt!="symbol"?kt+"":kt,Bt),Ei=(Et,kt,Bt)=>kt.has(Et)||Ks("Cannot "+Bt);var Ae=(Et,kt,Bt)=>(Ei(Et,kt,"read from private field"),Bt?Bt.call(Et):kt.get(Et)),dt=(Et,kt,Bt)=>kt.has(Et)?Ks("Cannot add the same private member more than once"):kt instanceof WeakSet?kt.add(Et):kt.set(Et,Bt),$t=(Et,kt,Bt,zr)=>(Ei(Et,kt,"write to private field"),zr?zr.call(Et,Bt):kt.set(Et,Bt),Bt),vt=(Et,kt,Bt)=>(Ei(Et,kt,"access private method"),Bt);var Ii=(Et,kt,Bt,zr)=>({set _(xn){$t(Et,kt,xn,Bt)},get _(){return Ae(Et,kt,zr)}}),yt=(Et,kt,Bt)=>ma(ya(Et),Bt,kt);let clientServiceBundle,ApiError,DEFAULT_SHELL_CHANNEL,ConnectionState$2,DeviceKind,EventSubscriptions,createIFramePort,createProtoRpcPeer,RemoteServiceConnectionTimeout,InvitationsProxy,createWorkerPort,DEFAULT_VAULT_URL,DEFAULT_INTERNAL_CHANNEL,MulticastObservable,PROXY_CONNECTION_TIMEOUT,parseFilter,PublicKey,QueryOptions,RPC_TIMEOUT,SpaceProxy,Trigger,LogLevel,ShellLayout,ComplexSet,ClientServicesProviderResource,Config,createLibDataChannelTransportFactory,__vitePreload,Event$1,setIdentityTags,synchronized,shellServiceBundle,appServiceBundle,safariCheck,getAsyncValue,WebsocketRpcClient,schema,getProfilePath,DX_RUNTIME,Connection,ConnectionLimiter,ConnectionLog,ConnectionState,EventType,LibDataChannelTransport,MAX_CONCURRENT_INITIATING_CONNECTIONS,MMSTTopology,MemoryTransport,MemoryTransportFactory,NetworkManager,SimplePeerTransport,SimplePeerTransportService,Swarm,SwarmMapper,SwarmMessenger,TransportKind,createSimplePeerTransportFactory,createTeleportProtocolFactory,DEFAULT_VAULT_ORIGIN,SystemStatus,index$2,index$1,index,invariant$1,Invitation,asyncTimeout,export_inspect,AUTH_TIMEOUT,trace,Context,inspectObject,TRACE_PROCESSOR,createBundledRpcServer,log,importModule,joinTables,PushStream$1,SpaceState,defaultKey,failUndefined,scheduleTask,trace$1,CREATE_SPACE_TIMEOUT,create$2,todo,Properties,createIFrame,ShellDisplay,__tla=(async()=>{var Et,kt,Bt,zr,xn,mn,$n,Tn,hn,Fn,jn,Un,Kn,Fr,Ci,Qs,zs,xi,Pi,Zn,kr,Bi,Fi,ji,Ui,Ki,qi,Hi,Qi,zi,Yi,Gi,Vi,Wi,Ji,Xi,Zi,es,ts,rs,ns,is,ss,cs,ls,hs,us,ds,ps,_s,gs,ys,bs,Ss,vs,As,Es,Is,Cs,xs,$s,Ts,ks,Os,Sn,qn,Hn,kn,On,Rs,Rn,Yr,An,Zo,Zt,ei,Ln,ti,vr,gi,yi,Oi,ea,Ls,un,Ir,Rr,dn,wn,fn,Mn,Ri,ta,Ms,Lr,bn,li,hi,Qn,Nn,Dn,Ns,cr,En,pn,zn,Yn,_n,ra,na,oa,ia,Ds,jr,Cr,Pn,yr,Gn,Vn,ri,er,ni,Lt,sa,aa,ca,mi,la,ha,bi,Si,Li,ai,Mi,Ps,In,Cn,oi,gn,Ni,ua,Di,Bs,Ur,ur,Kr,Mr,Gr,Vr,da,ii,fa,ci,Fs,Wn,Bn,Jn;function _mergeNamespaces(e,t){for(var r=0;r<t.length;r++){const n=t[r];if(typeof n!="string"&&!Array.isArray(n)){for(const o in n)if(o!=="default"&&!(o in e)){const s=Object.getOwnPropertyDescriptor(n,o);s&&Object.defineProperty(e,o,s.get?s:{enumerable:!0,get:()=>n[o]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();let scriptRel,assetsURL,seen;scriptRel="modulepreload",assetsURL=function(e){return"/"+e},seen={},__vitePreload=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),s=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.all(t.map(a=>{if(a=assetsURL(a),a in seen)return;seen[a]=!0;const c=a.endsWith(".css"),l=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${l}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":scriptRel,c||(h.as="script",h.crossOrigin=""),h.href=a,s&&h.setAttribute("nonce",s),document.head.appendChild(h),c)return new Promise((u,d)=>{h.addEventListener("load",u),h.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${a}`)))})}))}return n.then(()=>e()).catch(o=>{const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=o,window.dispatchEvent(s),!s.defaultPrevented)throw o})};var __create$2=Object.create,__defProp$3=Object.defineProperty,__getOwnPropDesc$2=Object.getOwnPropertyDescriptor,__getOwnPropNames$2=Object.getOwnPropertyNames,__getProtoOf$2=Object.getPrototypeOf,__hasOwnProp$2=Object.prototype.hasOwnProperty,__commonJS$2=(e,t)=>function(){return t||(0,e[__getOwnPropNames$2(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps$2=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of __getOwnPropNames$2(t))!__hasOwnProp$2.call(e,o)&&o!==r&&__defProp$3(e,o,{get:()=>t[o],enumerable:!(n=__getOwnPropDesc$2(t,o))||n.enumerable});return e},__toESM$2=(e,t,r)=>(r=e!=null?__create$2(__getProtoOf$2(e)):{},__copyProps$2(!e||!e.__esModule?__defProp$3(r,"default",{value:e,enumerable:!0}):r,e)),define_process_env_default$3={},require_shams=__commonJS$2({"node_modules/.pnpm/has-symbols@1.0.3/node_modules/has-symbols/shams.js"(e,t){t.exports=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var r={},n=Symbol("test"),o=Object(n);if(typeof n=="string"||Object.prototype.toString.call(n)!=="[object Symbol]"||Object.prototype.toString.call(o)!=="[object Symbol]")return!1;var s=42;r[n]=s;for(n in r)return!1;if(typeof Object.keys=="function"&&Object.keys(r).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(r).length!==0)return!1;var a=Object.getOwnPropertySymbols(r);if(a.length!==1||a[0]!==n||!Object.prototype.propertyIsEnumerable.call(r,n))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var c=Object.getOwnPropertyDescriptor(r,n);if(c.value!==s||c.enumerable!==!0)return!1}return!0}}}),require_shams2=__commonJS$2({"node_modules/.pnpm/has-tostringtag@1.0.0/node_modules/has-tostringtag/shams.js"(e,t){var r=require_shams();t.exports=function(){return r()&&!!Symbol.toStringTag}}}),require_has_symbols=__commonJS$2({"node_modules/.pnpm/has-symbols@1.0.3/node_modules/has-symbols/index.js"(e,t){var r=typeof Symbol<"u"&&Symbol,n=require_shams();t.exports=function(){return typeof r!="function"||typeof Symbol!="function"||typeof r("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:n()}}}),require_has_proto=__commonJS$2({"node_modules/.pnpm/has-proto@1.0.1/node_modules/has-proto/index.js"(e,t){var r={foo:{}},n=Object;t.exports=function(){return{__proto__:r}.foo===r.foo&&!({__proto__:null}instanceof n)}}}),require_implementation=__commonJS$2({"node_modules/.pnpm/function-bind@1.1.2/node_modules/function-bind/implementation.js"(e,t){var r="Function.prototype.bind called on incompatible ",n=Object.prototype.toString,o=Math.max,s="[object Function]",a=function(h,u){for(var d=[],f=0;f<h.length;f+=1)d[f]=h[f];for(var _=0;_<u.length;_+=1)d[_+h.length]=u[_];return d},c=function(h,u){for(var d=[],f=u,_=0;f<h.length;f+=1,_+=1)d[_]=h[f];return d},l=function(h,u){for(var d="",f=0;f<h.length;f+=1)d+=h[f],f+1<h.length&&(d+=u);return d};t.exports=function(h){var u=this;if(typeof u!="function"||n.apply(u)!==s)throw new TypeError(r+u);for(var d=c(arguments,1),f,_=function(){if(this instanceof f){var x=u.apply(this,a(d,arguments));return Object(x)===x?x:this}return u.apply(h,a(d,arguments))},p=o(0,u.length-d.length),y=[],w=0;w<p;w++)y[w]="$"+w;if(f=Function("binder","return function ("+l(y,",")+"){ return binder.apply(this,arguments); }")(_),u.prototype){var E=function(){};E.prototype=u.prototype,f.prototype=new E,E.prototype=null}return f}}}),require_function_bind=__commonJS$2({"node_modules/.pnpm/function-bind@1.1.2/node_modules/function-bind/index.js"(e,t){var r=require_implementation();t.exports=Function.prototype.bind||r}}),require_hasown=__commonJS$2({"node_modules/.pnpm/hasown@2.0.0/node_modules/hasown/index.js"(e,t){var r=Function.prototype.call,n=Object.prototype.hasOwnProperty,o=require_function_bind();t.exports=o.call(r,n)}}),require_get_intrinsic=__commonJS$2({"node_modules/.pnpm/get-intrinsic@1.2.2/node_modules/get-intrinsic/index.js"(e,t){var r,n=SyntaxError,o=Function,s=TypeError,a=function(he){try{return o('"use strict"; return ('+he+").constructor;")()}catch{}},c=Object.getOwnPropertyDescriptor;if(c)try{c({},"")}catch{c=null}var l=function(){throw new s},h=c?function(){try{return arguments.callee,l}catch{try{return c(arguments,"callee").get}catch{return l}}}():l,u=require_has_symbols()(),d=require_has_proto()(),f=Object.getPrototypeOf||(d?function(he){return he.__proto__}:null),_={},p=typeof Uint8Array>"u"||!f?r:f(Uint8Array),y={"%AggregateError%":typeof AggregateError>"u"?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?r:ArrayBuffer,"%ArrayIteratorPrototype%":u&&f?f([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":_,"%AsyncGenerator%":_,"%AsyncGeneratorFunction%":_,"%AsyncIteratorPrototype%":_,"%Atomics%":typeof Atomics>"u"?r:Atomics,"%BigInt%":typeof BigInt>"u"?r:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?r:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":typeof Float32Array>"u"?r:Float32Array,"%Float64Array%":typeof Float64Array>"u"?r:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?r:FinalizationRegistry,"%Function%":o,"%GeneratorFunction%":_,"%Int8Array%":typeof Int8Array>"u"?r:Int8Array,"%Int16Array%":typeof Int16Array>"u"?r:Int16Array,"%Int32Array%":typeof Int32Array>"u"?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":u&&f?f(f([][Symbol.iterator]())):r,"%JSON%":typeof JSON=="object"?JSON:r,"%Map%":typeof Map>"u"?r:Map,"%MapIteratorPrototype%":typeof Map>"u"||!u||!f?r:f(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?r:Promise,"%Proxy%":typeof Proxy>"u"?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":typeof Reflect>"u"?r:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?r:Set,"%SetIteratorPrototype%":typeof Set>"u"||!u||!f?r:f(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":u&&f?f(""[Symbol.iterator]()):r,"%Symbol%":u?Symbol:r,"%SyntaxError%":n,"%ThrowTypeError%":h,"%TypedArray%":p,"%TypeError%":s,"%Uint8Array%":typeof Uint8Array>"u"?r:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?r:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?r:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":typeof WeakMap>"u"?r:WeakMap,"%WeakRef%":typeof WeakRef>"u"?r:WeakRef,"%WeakSet%":typeof WeakSet>"u"?r:WeakSet};if(f)try{null.error}catch(he){w=f(f(he)),y["%Error.prototype%"]=w}var w,E=function he(V){var _e;if(V==="%AsyncFunction%")_e=a("async function () {}");else if(V==="%GeneratorFunction%")_e=a("function* () {}");else if(V==="%AsyncGeneratorFunction%")_e=a("async function* () {}");else if(V==="%AsyncGenerator%"){var ee=he("%AsyncGeneratorFunction%");ee&&(_e=ee.prototype)}else if(V==="%AsyncIteratorPrototype%"){var W=he("%AsyncGenerator%");W&&f&&(_e=f(W.prototype))}return y[V]=_e,_e},x={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},B=require_function_bind(),P=require_hasown(),U=B.call(Function.call,Array.prototype.concat),F=B.call(Function.apply,Array.prototype.splice),G=B.call(Function.call,String.prototype.replace),H=B.call(Function.call,String.prototype.slice),te=B.call(Function.call,RegExp.prototype.exec),J=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,le=/\\(\\)?/g,z=function(he){var V=H(he,0,1),_e=H(he,-1);if(V==="%"&&_e!=="%")throw new n("invalid intrinsic syntax, expected closing `%`");if(_e==="%"&&V!=="%")throw new n("invalid intrinsic syntax, expected opening `%`");var ee=[];return G(he,J,function(W,re,ne,ge){ee[ee.length]=ne?G(ge,le,"$1"):re||W}),ee},q=function(he,V){var _e=he,ee;if(P(x,_e)&&(ee=x[_e],_e="%"+ee[0]+"%"),P(y,_e)){var W=y[_e];if(W===_&&(W=E(_e)),typeof W>"u"&&!V)throw new s("intrinsic "+he+" exists, but is not available. Please file an issue!");return{alias:ee,name:_e,value:W}}throw new n("intrinsic "+he+" does not exist!")};t.exports=function(he,V){if(typeof he!="string"||he.length===0)throw new s("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof V!="boolean")throw new s('"allowMissing" argument must be a boolean');if(te(/^%?[^%]*%?$/,he)===null)throw new n("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var _e=z(he),ee=_e.length>0?_e[0]:"",W=q("%"+ee+"%",V),re=W.name,ne=W.value,ge=!1,de=W.alias;de&&(ee=de[0],F(_e,U([0,1],de)));for(var ye=1,Ce=!0;ye<_e.length;ye+=1){var ke=_e[ye],ae=H(ke,0,1),Q=H(ke,-1);if((ae==='"'||ae==="'"||ae==="`"||Q==='"'||Q==="'"||Q==="`")&&ae!==Q)throw new n("property names with quotes must have matching quotes");if((ke==="constructor"||!Ce)&&(ge=!0),ee+="."+ke,re="%"+ee+"%",P(y,re))ne=y[re];else if(ne!=null){if(!(ke in ne)){if(!V)throw new s("base intrinsic for "+he+" exists, but the property is not available.");return}if(c&&ye+1>=_e.length){var C=c(ne,ke);Ce=!!C,Ce&&"get"in C&&!("originalValue"in C.get)?ne=C.get:ne=ne[ke]}else Ce=P(ne,ke),ne=ne[ke];Ce&&!ge&&(y[re]=ne)}}return ne}}}),require_has_property_descriptors=__commonJS$2({"node_modules/.pnpm/has-property-descriptors@1.0.0/node_modules/has-property-descriptors/index.js"(e,t){var r=require_get_intrinsic(),n=r("%Object.defineProperty%",!0),o=function(){if(n)try{return n({},"a",{value:1}),!0}catch{return!1}return!1};o.hasArrayLengthDefineBug=function(){if(!o())return null;try{return n([],"length",{value:1}).length!==1}catch{return!0}},t.exports=o}}),require_gopd=__commonJS$2({"node_modules/.pnpm/gopd@1.0.1/node_modules/gopd/index.js"(e,t){var r=require_get_intrinsic(),n=r("%Object.getOwnPropertyDescriptor%",!0);if(n)try{n([],"length")}catch{n=null}t.exports=n}}),require_define_data_property=__commonJS$2({"node_modules/.pnpm/define-data-property@1.1.1/node_modules/define-data-property/index.js"(e,t){var r=require_has_property_descriptors()(),n=require_get_intrinsic(),o=r&&n("%Object.defineProperty%",!0);if(o)try{o({},"a",{value:1})}catch{o=!1}var s=n("%SyntaxError%"),a=n("%TypeError%"),c=require_gopd();t.exports=function(l,h,u){if(!l||typeof l!="object"&&typeof l!="function")throw new a("`obj` must be an object or a function`");if(typeof h!="string"&&typeof h!="symbol")throw new a("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new a("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new a("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new a("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new a("`loose`, if provided, must be a boolean");var d=arguments.length>3?arguments[3]:null,f=arguments.length>4?arguments[4]:null,_=arguments.length>5?arguments[5]:null,p=arguments.length>6?arguments[6]:!1,y=!!c&&c(l,h);if(o)o(l,h,{configurable:_===null&&y?y.configurable:!_,enumerable:d===null&&y?y.enumerable:!d,value:u,writable:f===null&&y?y.writable:!f});else if(p||!d&&!f&&!_)l[h]=u;else throw new s("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")}}}),require_set_function_length=__commonJS$2({"node_modules/.pnpm/set-function-length@1.1.1/node_modules/set-function-length/index.js"(e,t){var r=require_get_intrinsic(),n=require_define_data_property(),o=require_has_property_descriptors()(),s=require_gopd(),a=r("%TypeError%"),c=r("%Math.floor%");t.exports=function(l,h){if(typeof l!="function")throw new a("`fn` is not a function");if(typeof h!="number"||h<0||h>4294967295||c(h)!==h)throw new a("`length` must be a positive 32-bit integer");var u=arguments.length>2&&!!arguments[2],d=!0,f=!0;if("length"in l&&s){var _=s(l,"length");_&&!_.configurable&&(d=!1),_&&!_.writable&&(f=!1)}return(d||f||!u)&&(o?n(l,"length",h,!0,!0):n(l,"length",h)),l}}}),require_call_bind=__commonJS$2({"node_modules/.pnpm/call-bind@1.0.5/node_modules/call-bind/index.js"(e,t){var r=require_function_bind(),n=require_get_intrinsic(),o=require_set_function_length(),s=n("%TypeError%"),a=n("%Function.prototype.apply%"),c=n("%Function.prototype.call%"),l=n("%Reflect.apply%",!0)||r.call(c,a),h=n("%Object.defineProperty%",!0),u=n("%Math.max%");if(h)try{h({},"a",{value:1})}catch{h=null}t.exports=function(f){if(typeof f!="function")throw new s("a function is required");var _=l(r,c,arguments);return o(_,1+u(0,f.length-(arguments.length-1)),!0)};var d=function(){return l(r,a,arguments)};h?h(t.exports,"apply",{value:d}):t.exports.apply=d}}),require_callBound=__commonJS$2({"node_modules/.pnpm/call-bind@1.0.5/node_modules/call-bind/callBound.js"(e,t){var r=require_get_intrinsic(),n=require_call_bind(),o=n(r("String.prototype.indexOf"));t.exports=function(s,a){var c=r(s,!!a);return typeof c=="function"&&o(s,".prototype.")>-1?n(c):c}}}),require_is_arguments=__commonJS$2({"node_modules/.pnpm/is-arguments@1.1.1/node_modules/is-arguments/index.js"(e,t){var r=require_shams2()(),n=require_callBound(),o=n("Object.prototype.toString"),s=function(l){return r&&l&&typeof l=="object"&&Symbol.toStringTag in l?!1:o(l)==="[object Arguments]"},a=function(l){return s(l)?!0:l!==null&&typeof l=="object"&&typeof l.length=="number"&&l.length>=0&&o(l)!=="[object Array]"&&o(l.callee)==="[object Function]"},c=function(){return s(arguments)}();s.isLegacyArguments=a,t.exports=c?s:a}}),require_is_generator_function=__commonJS$2({"node_modules/.pnpm/is-generator-function@1.0.10/node_modules/is-generator-function/index.js"(e,t){var r=Object.prototype.toString,n=Function.prototype.toString,o=/^\s*(?:function)?\*/,s=require_shams2()(),a=Object.getPrototypeOf,c=function(){if(!s)return!1;try{return Function("return function*() {}")()}catch{}},l;t.exports=function(h){if(typeof h!="function")return!1;if(o.test(n.call(h)))return!0;if(!s){var u=r.call(h);return u==="[object GeneratorFunction]"}if(!a)return!1;if(typeof l>"u"){var d=c();l=d?a(d):!1}return a(h)===l}}}),require_is_callable=__commonJS$2({"node_modules/.pnpm/is-callable@1.2.7/node_modules/is-callable/index.js"(e,t){var r=Function.prototype.toString,n=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,o,s;if(typeof n=="function"&&typeof Object.defineProperty=="function")try{o=Object.defineProperty({},"length",{get:function(){throw s}}),s={},n(function(){throw 42},null,o)}catch(P){P!==s&&(n=null)}else n=null;var a=/^\s*class\b/,c=function(P){try{var U=r.call(P);return a.test(U)}catch{return!1}},l=function(P){try{return c(P)?!1:(r.call(P),!0)}catch{return!1}},h=Object.prototype.toString,u="[object Object]",d="[object Function]",f="[object GeneratorFunction]",_="[object HTMLAllCollection]",p="[object HTML document.all class]",y="[object HTMLCollection]",w=typeof Symbol=="function"&&!!Symbol.toStringTag,E=!(0 in[,]),x=function(){return!1};typeof document=="object"&&(B=document.all,h.call(B)===h.call(document.all)&&(x=function(P){if((E||!P)&&(typeof P>"u"||typeof P=="object"))try{var U=h.call(P);return(U===_||U===p||U===y||U===u)&&P("")==null}catch{}return!1}));var B;t.exports=n?function(P){if(x(P))return!0;if(!P||typeof P!="function"&&typeof P!="object")return!1;try{n(P,null,o)}catch(U){if(U!==s)return!1}return!c(P)&&l(P)}:function(P){if(x(P))return!0;if(!P||typeof P!="function"&&typeof P!="object")return!1;if(w)return l(P);if(c(P))return!1;var U=h.call(P);return U!==d&&U!==f&&!/^\[object HTML/.test(U)?!1:l(P)}}}),require_for_each=__commonJS$2({"node_modules/.pnpm/for-each@0.3.3/node_modules/for-each/index.js"(e,t){var r=require_is_callable(),n=Object.prototype.toString,o=Object.prototype.hasOwnProperty,s=function(h,u,d){for(var f=0,_=h.length;f<_;f++)o.call(h,f)&&(d==null?u(h[f],f,h):u.call(d,h[f],f,h))},a=function(h,u,d){for(var f=0,_=h.length;f<_;f++)d==null?u(h.charAt(f),f,h):u.call(d,h.charAt(f),f,h)},c=function(h,u,d){for(var f in h)o.call(h,f)&&(d==null?u(h[f],f,h):u.call(d,h[f],f,h))},l=function(h,u,d){if(!r(u))throw new TypeError("iterator must be a function");var f;arguments.length>=3&&(f=d),n.call(h)==="[object Array]"?s(h,u,f):typeof h=="string"?a(h,u,f):c(h,u,f)};t.exports=l}}),require_available_typed_arrays=__commonJS$2({"node_modules/.pnpm/available-typed-arrays@1.0.5/node_modules/available-typed-arrays/index.js"(e,t){var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],n=typeof globalThis>"u"?global:globalThis;t.exports=function(){for(var o=[],s=0;s<r.length;s++)typeof n[r[s]]=="function"&&(o[o.length]=r[s]);return o}}}),require_call_bind2=__commonJS$2({"node_modules/.pnpm/call-bind@1.0.2/node_modules/call-bind/index.js"(e,t){var r=require_function_bind(),n=require_get_intrinsic(),o=n("%Function.prototype.apply%"),s=n("%Function.prototype.call%"),a=n("%Reflect.apply%",!0)||r.call(s,o),c=n("%Object.getOwnPropertyDescriptor%",!0),l=n("%Object.defineProperty%",!0),h=n("%Math.max%");if(l)try{l({},"a",{value:1})}catch{l=null}t.exports=function(d){var f=a(r,s,arguments);if(c&&l){var _=c(f,"length");_.configurable&&l(f,"length",{value:1+h(0,d.length-(arguments.length-1))})}return f};var u=function(){return a(r,o,arguments)};l?l(t.exports,"apply",{value:u}):t.exports.apply=u}}),require_callBound2=__commonJS$2({"node_modules/.pnpm/call-bind@1.0.2/node_modules/call-bind/callBound.js"(e,t){var r=require_get_intrinsic(),n=require_call_bind2(),o=n(r("String.prototype.indexOf"));t.exports=function(s,a){var c=r(s,!!a);return typeof c=="function"&&o(s,".prototype.")>-1?n(c):c}}}),require_getOwnPropertyDescriptor=__commonJS$2({"node_modules/.pnpm/es-abstract@1.20.4/node_modules/es-abstract/helpers/getOwnPropertyDescriptor.js"(e,t){var r=require_get_intrinsic(),n=r("%Object.getOwnPropertyDescriptor%",!0);if(n)try{n([],"length")}catch{n=null}t.exports=n}}),require_which_typed_array=__commonJS$2({"node_modules/.pnpm/which-typed-array@1.1.13/node_modules/which-typed-array/index.js"(e,t){var r=require_for_each(),n=require_available_typed_arrays(),o=require_call_bind(),s=require_callBound(),a=require_gopd(),c=s("Object.prototype.toString"),l=require_shams2()(),h=typeof globalThis>"u"?global:globalThis,u=n(),d=s("String.prototype.slice"),f=Object.getPrototypeOf,_=s("Array.prototype.indexOf",!0)||function(E,x){for(var B=0;B<E.length;B+=1)if(E[B]===x)return B;return-1},p={__proto__:null};l&&a&&f?r(u,function(E){var x=new h[E];if(Symbol.toStringTag in x){var B=f(x),P=a(B,Symbol.toStringTag);if(!P){var U=f(B);P=a(U,Symbol.toStringTag)}p["$"+E]=o(P.get)}}):r(u,function(E){var x=new h[E],B=x.slice||x.set;B&&(p["$"+E]=o(B))});var y=function(E){var x=!1;return r(p,function(B,P){if(!x)try{"$"+B(E)===P&&(x=d(P,1))}catch{}}),x},w=function(E){var x=!1;return r(p,function(B,P){if(!x)try{B(E),x=d(P,1)}catch{}}),x};t.exports=function(E){if(!E||typeof E!="object")return!1;if(!l){var x=d(c(E),8,-1);return _(u,x)>-1?x:x!=="Object"?!1:w(E)}return a?y(E):null}}}),require_is_typed_array=__commonJS$2({"node_modules/.pnpm/is-typed-array@1.1.12/node_modules/is-typed-array/index.js"(e,t){var r=require_which_typed_array();t.exports=function(n){return!!r(n)}}}),require_which_typed_array2=__commonJS$2({"node_modules/.pnpm/which-typed-array@1.1.8/node_modules/which-typed-array/index.js"(e,t){var r=require_for_each(),n=require_available_typed_arrays(),o=require_callBound2(),s=o("Object.prototype.toString"),a=require_shams2()(),c=typeof globalThis>"u"?global:globalThis,l=n(),h=o("String.prototype.slice"),u={},d=require_getOwnPropertyDescriptor(),f=Object.getPrototypeOf;a&&d&&f&&r(l,function(y){if(typeof c[y]=="function"){var w=new c[y];if(Symbol.toStringTag in w){var E=f(w),x=d(E,Symbol.toStringTag);if(!x){var B=f(E);x=d(B,Symbol.toStringTag)}u[y]=x.get}}});var _=function(y){var w=!1;return r(u,function(E,x){if(!w)try{var B=E.call(y);B===x&&(w=B)}catch{}}),w},p=require_is_typed_array();t.exports=function(y){return p(y)?!a||!(Symbol.toStringTag in y)?h(s(y),8,-1):_(y):!1}}}),require_is_typed_array2=__commonJS$2({"node_modules/.pnpm/is-typed-array@1.1.9/node_modules/is-typed-array/index.js"(e,t){var r=require_for_each(),n=require_available_typed_arrays(),o=require_callBound2(),s=o("Object.prototype.toString"),a=require_shams2()(),c=typeof globalThis>"u"?global:globalThis,l=n(),h=o("Array.prototype.indexOf",!0)||function(y,w){for(var E=0;E<y.length;E+=1)if(y[E]===w)return E;return-1},u=o("String.prototype.slice"),d={},f=require_getOwnPropertyDescriptor(),_=Object.getPrototypeOf;a&&f&&_&&r(l,function(y){var w=new c[y];if(Symbol.toStringTag in w){var E=_(w),x=f(E,Symbol.toStringTag);if(!x){var B=_(E);x=f(B,Symbol.toStringTag)}d[y]=x.get}});var p=function(y){var w=!1;return r(d,function(E,x){if(!w)try{w=E.call(y)===x}catch{}}),w};t.exports=function(y){if(!y||typeof y!="object")return!1;if(!a||!(Symbol.toStringTag in y)){var w=u(s(y),8,-1);return h(l,w)>-1}return f?p(y):!1}}}),require_types=__commonJS$2({"node_modules/.pnpm/util@0.12.5/node_modules/util/support/types.js"(e){var t=require_is_arguments(),r=require_is_generator_function(),n=require_which_typed_array2(),o=require_is_typed_array2();function s(Fe){return Fe.call.bind(Fe)}var a=typeof BigInt<"u",c=typeof Symbol<"u",l=s(Object.prototype.toString),h=s(Number.prototype.valueOf),u=s(String.prototype.valueOf),d=s(Boolean.prototype.valueOf);a&&(f=s(BigInt.prototype.valueOf));var f;c&&(_=s(Symbol.prototype.valueOf));var _;function p(Fe,st){if(typeof Fe!="object")return!1;try{return st(Fe),!0}catch{return!1}}e.isArgumentsObject=t,e.isGeneratorFunction=r,e.isTypedArray=o;function y(Fe){return typeof Promise<"u"&&Fe instanceof Promise||Fe!==null&&typeof Fe=="object"&&typeof Fe.then=="function"&&typeof Fe.catch=="function"}e.isPromise=y;function w(Fe){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(Fe):o(Fe)||ye(Fe)}e.isArrayBufferView=w;function E(Fe){return n(Fe)==="Uint8Array"}e.isUint8Array=E;function x(Fe){return n(Fe)==="Uint8ClampedArray"}e.isUint8ClampedArray=x;function B(Fe){return n(Fe)==="Uint16Array"}e.isUint16Array=B;function P(Fe){return n(Fe)==="Uint32Array"}e.isUint32Array=P;function U(Fe){return n(Fe)==="Int8Array"}e.isInt8Array=U;function F(Fe){return n(Fe)==="Int16Array"}e.isInt16Array=F;function G(Fe){return n(Fe)==="Int32Array"}e.isInt32Array=G;function H(Fe){return n(Fe)==="Float32Array"}e.isFloat32Array=H;function te(Fe){return n(Fe)==="Float64Array"}e.isFloat64Array=te;function J(Fe){return n(Fe)==="BigInt64Array"}e.isBigInt64Array=J;function le(Fe){return n(Fe)==="BigUint64Array"}e.isBigUint64Array=le;function z(Fe){return l(Fe)==="[object Map]"}z.working=typeof Map<"u"&&z(new Map);function q(Fe){return typeof Map>"u"?!1:z.working?z(Fe):Fe instanceof Map}e.isMap=q;function he(Fe){return l(Fe)==="[object Set]"}he.working=typeof Set<"u"&&he(new Set);function V(Fe){return typeof Set>"u"?!1:he.working?he(Fe):Fe instanceof Set}e.isSet=V;function _e(Fe){return l(Fe)==="[object WeakMap]"}_e.working=typeof WeakMap<"u"&&_e(new WeakMap);function ee(Fe){return typeof WeakMap>"u"?!1:_e.working?_e(Fe):Fe instanceof WeakMap}e.isWeakMap=ee;function W(Fe){return l(Fe)==="[object WeakSet]"}W.working=typeof WeakSet<"u"&&W(new WeakSet);function re(Fe){return W(Fe)}e.isWeakSet=re;function ne(Fe){return l(Fe)==="[object ArrayBuffer]"}ne.working=typeof ArrayBuffer<"u"&&ne(new ArrayBuffer);function ge(Fe){return typeof ArrayBuffer>"u"?!1:ne.working?ne(Fe):Fe instanceof ArrayBuffer}e.isArrayBuffer=ge;function de(Fe){return l(Fe)==="[object DataView]"}de.working=typeof ArrayBuffer<"u"&&typeof DataView<"u"&&de(new DataView(new ArrayBuffer(1),0,1));function ye(Fe){return typeof DataView>"u"?!1:de.working?de(Fe):Fe instanceof DataView}e.isDataView=ye;var Ce=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:void 0;function ke(Fe){return l(Fe)==="[object SharedArrayBuffer]"}function ae(Fe){return typeof Ce>"u"?!1:(typeof ke.working>"u"&&(ke.working=ke(new Ce)),ke.working?ke(Fe):Fe instanceof Ce)}e.isSharedArrayBuffer=ae;function Q(Fe){return l(Fe)==="[object AsyncFunction]"}e.isAsyncFunction=Q;function C(Fe){return l(Fe)==="[object Map Iterator]"}e.isMapIterator=C;function $(Fe){return l(Fe)==="[object Set Iterator]"}e.isSetIterator=$;function j(Fe){return l(Fe)==="[object Generator]"}e.isGeneratorObject=j;function O(Fe){return l(Fe)==="[object WebAssembly.Module]"}e.isWebAssemblyCompiledModule=O;function k(Fe){return p(Fe,h)}e.isNumberObject=k;function ue(Fe){return p(Fe,u)}e.isStringObject=ue;function pe(Fe){return p(Fe,d)}e.isBooleanObject=pe;function Oe(Fe){return a&&p(Fe,f)}e.isBigIntObject=Oe;function Le(Fe){return c&&p(Fe,_)}e.isSymbolObject=Le;function Me(Fe){return k(Fe)||ue(Fe)||pe(Fe)||Oe(Fe)||Le(Fe)}e.isBoxedPrimitive=Me;function We(Fe){return typeof Uint8Array<"u"&&(ge(Fe)||ae(Fe))}e.isAnyArrayBuffer=We,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(Fe){Object.defineProperty(e,Fe,{enumerable:!1,value:function(){throw new Error(Fe+" is not supported in userland")}})})}}),require_isBufferBrowser=__commonJS$2({"node_modules/.pnpm/util@0.12.5/node_modules/util/support/isBufferBrowser.js"(e,t){t.exports=function(r){return r&&typeof r=="object"&&typeof r.copy=="function"&&typeof r.fill=="function"&&typeof r.readUInt8=="function"}}}),require_inherits_browser$1=__commonJS$2({"node_modules/.pnpm/inherits@2.0.4/node_modules/inherits/inherits_browser.js"(e,t){typeof Object.create=="function"?t.exports=function(r,n){n&&(r.super_=n,r.prototype=Object.create(n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(r,n){if(n){r.super_=n;var o=function(){};o.prototype=n.prototype,r.prototype=new o,r.prototype.constructor=r}}}}),require_util=__commonJS$2({"node_modules/.pnpm/util@0.12.5/node_modules/util/util.js"(e){var t=Object.getOwnPropertyDescriptors||function(de){for(var ye=Object.keys(de),Ce={},ke=0;ke<ye.length;ke++)Ce[ye[ke]]=Object.getOwnPropertyDescriptor(de,ye[ke]);return Ce},r=/%[sdj%]/g;e.format=function(de){if(!U(de)){for(var ye=[],Ce=0;Ce<arguments.length;Ce++)ye.push(a(arguments[Ce]));return ye.join(" ")}for(var Ce=1,ke=arguments,ae=ke.length,Q=String(de).replace(r,function(j){if(j==="%%")return"%";if(Ce>=ae)return j;switch(j){case"%s":return String(ke[Ce++]);case"%d":return Number(ke[Ce++]);case"%j":try{return JSON.stringify(ke[Ce++])}catch{return"[Circular]"}default:return j}}),C=ke[Ce];Ce<ae;C=ke[++Ce])x(C)||!te(C)?Q+=" "+C:Q+=" "+a(C);return Q},e.deprecate=function(de,ye){if(typeof process<"u"&&process.noDeprecation===!0)return de;if(typeof process>"u")return function(){return e.deprecate(de,ye).apply(this,arguments)};var Ce=!1;function ke(){if(!Ce){if(process.throwDeprecation)throw new Error(ye);process.traceDeprecation?console.trace(ye):console.error(ye),Ce=!0}return de.apply(this,arguments)}return ke};var n={},o=/^$/;define_process_env_default$3.NODE_DEBUG&&(s=define_process_env_default$3.NODE_DEBUG,s=s.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+s+"$","i"));var s;e.debuglog=function(de){if(de=de.toUpperCase(),!n[de])if(o.test(de)){var ye=process.pid;n[de]=function(){var Ce=e.format.apply(e,arguments);console.error("%s %d: %s",de,ye,Ce)}}else n[de]=function(){};return n[de]};function a(de,ye){var Ce={seen:[],stylize:l};return arguments.length>=3&&(Ce.depth=arguments[2]),arguments.length>=4&&(Ce.colors=arguments[3]),E(ye)?Ce.showHidden=ye:ye&&e._extend(Ce,ye),G(Ce.showHidden)&&(Ce.showHidden=!1),G(Ce.depth)&&(Ce.depth=2),G(Ce.colors)&&(Ce.colors=!1),G(Ce.customInspect)&&(Ce.customInspect=!0),Ce.colors&&(Ce.stylize=c),u(Ce,de,Ce.depth)}e.inspect=a,a.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},a.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function c(de,ye){var Ce=a.styles[ye];return Ce?"\x1B["+a.colors[Ce][0]+"m"+de+"\x1B["+a.colors[Ce][1]+"m":de}function l(de,ye){return de}function h(de){var ye={};return de.forEach(function(Ce,ke){ye[Ce]=!0}),ye}function u(de,ye,Ce){if(de.customInspect&&ye&&z(ye.inspect)&&ye.inspect!==e.inspect&&!(ye.constructor&&ye.constructor.prototype===ye)){var ke=ye.inspect(Ce,de);return U(ke)||(ke=u(de,ke,Ce)),ke}var ae=d(de,ye);if(ae)return ae;var Q=Object.keys(ye),C=h(Q);if(de.showHidden&&(Q=Object.getOwnPropertyNames(ye)),le(ye)&&(Q.indexOf("message")>=0||Q.indexOf("description")>=0))return f(ye);if(Q.length===0){if(z(ye)){var $=ye.name?": "+ye.name:"";return de.stylize("[Function"+$+"]","special")}if(H(ye))return de.stylize(RegExp.prototype.toString.call(ye),"regexp");if(J(ye))return de.stylize(Date.prototype.toString.call(ye),"date");if(le(ye))return f(ye)}var j="",O=!1,k=["{","}"];if(w(ye)&&(O=!0,k=["[","]"]),z(ye)){var ue=ye.name?": "+ye.name:"";j=" [Function"+ue+"]"}if(H(ye)&&(j=" "+RegExp.prototype.toString.call(ye)),J(ye)&&(j=" "+Date.prototype.toUTCString.call(ye)),le(ye)&&(j=" "+f(ye)),Q.length===0&&(!O||ye.length==0))return k[0]+j+k[1];if(Ce<0)return H(ye)?de.stylize(RegExp.prototype.toString.call(ye),"regexp"):de.stylize("[Object]","special");de.seen.push(ye);var pe;return O?pe=_(de,ye,Ce,C,Q):pe=Q.map(function(Oe){return p(de,ye,Ce,C,Oe,O)}),de.seen.pop(),y(pe,j,k)}function d(de,ye){if(G(ye))return de.stylize("undefined","undefined");if(U(ye)){var Ce="'"+JSON.stringify(ye).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return de.stylize(Ce,"string")}if(P(ye))return de.stylize(""+ye,"number");if(E(ye))return de.stylize(""+ye,"boolean");if(x(ye))return de.stylize("null","null")}function f(de){return"["+Error.prototype.toString.call(de)+"]"}function _(de,ye,Ce,ke,ae){for(var Q=[],C=0,$=ye.length;C<$;++C)W(ye,String(C))?Q.push(p(de,ye,Ce,ke,String(C),!0)):Q.push("");return ae.forEach(function(j){j.match(/^\d+$/)||Q.push(p(de,ye,Ce,ke,j,!0))}),Q}function p(de,ye,Ce,ke,ae,Q){var C,$,j;if(j=Object.getOwnPropertyDescriptor(ye,ae)||{value:ye[ae]},j.get?j.set?$=de.stylize("[Getter/Setter]","special"):$=de.stylize("[Getter]","special"):j.set&&($=de.stylize("[Setter]","special")),W(ke,ae)||(C="["+ae+"]"),$||(de.seen.indexOf(j.value)<0?(x(Ce)?$=u(de,j.value,null):$=u(de,j.value,Ce-1),$.indexOf(`
`)>-1&&(Q?$=$.split(`
`).map(function(O){return"  "+O}).join(`
`).slice(2):$=`
`+$.split(`
`).map(function(O){return"   "+O}).join(`
`))):$=de.stylize("[Circular]","special")),G(C)){if(Q&&ae.match(/^\d+$/))return $;C=JSON.stringify(""+ae),C.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(C=C.slice(1,-1),C=de.stylize(C,"name")):(C=C.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),C=de.stylize(C,"string"))}return C+": "+$}function y(de,ye,Ce){var ke=de.reduce(function(ae,Q){return Q.indexOf(`
`)>=0,ae+Q.replace(/\u001b\[\d\d?m/g,"").length+1},0);return ke>60?Ce[0]+(ye===""?"":ye+`
 `)+" "+de.join(`,
  `)+" "+Ce[1]:Ce[0]+ye+" "+de.join(", ")+" "+Ce[1]}e.types=require_types();function w(de){return Array.isArray(de)}e.isArray=w;function E(de){return typeof de=="boolean"}e.isBoolean=E;function x(de){return de===null}e.isNull=x;function B(de){return de==null}e.isNullOrUndefined=B;function P(de){return typeof de=="number"}e.isNumber=P;function U(de){return typeof de=="string"}e.isString=U;function F(de){return typeof de=="symbol"}e.isSymbol=F;function G(de){return de===void 0}e.isUndefined=G;function H(de){return te(de)&&he(de)==="[object RegExp]"}e.isRegExp=H,e.types.isRegExp=H;function te(de){return typeof de=="object"&&de!==null}e.isObject=te;function J(de){return te(de)&&he(de)==="[object Date]"}e.isDate=J,e.types.isDate=J;function le(de){return te(de)&&(he(de)==="[object Error]"||de instanceof Error)}e.isError=le,e.types.isNativeError=le;function z(de){return typeof de=="function"}e.isFunction=z;function q(de){return de===null||typeof de=="boolean"||typeof de=="number"||typeof de=="string"||typeof de=="symbol"||typeof de>"u"}e.isPrimitive=q,e.isBuffer=require_isBufferBrowser();function he(de){return Object.prototype.toString.call(de)}function V(de){return de<10?"0"+de.toString(10):de.toString(10)}var _e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function ee(){var de=new Date,ye=[V(de.getHours()),V(de.getMinutes()),V(de.getSeconds())].join(":");return[de.getDate(),_e[de.getMonth()],ye].join(" ")}e.log=function(){console.log("%s - %s",ee(),e.format.apply(e,arguments))},e.inherits=require_inherits_browser$1(),e._extend=function(de,ye){if(!ye||!te(ye))return de;for(var Ce=Object.keys(ye),ke=Ce.length;ke--;)de[Ce[ke]]=ye[Ce[ke]];return de};function W(de,ye){return Object.prototype.hasOwnProperty.call(de,ye)}var re=typeof Symbol<"u"?Symbol("util.promisify.custom"):void 0;e.promisify=function(de){if(typeof de!="function")throw new TypeError('The "original" argument must be of type Function');if(re&&de[re]){var ye=de[re];if(typeof ye!="function")throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(ye,re,{value:ye,enumerable:!1,writable:!1,configurable:!0}),ye}function ye(){for(var Ce,ke,ae=new Promise(function($,j){Ce=$,ke=j}),Q=[],C=0;C<arguments.length;C++)Q.push(arguments[C]);Q.push(function($,j){$?ke($):Ce(j)});try{de.apply(this,Q)}catch($){ke($)}return ae}return Object.setPrototypeOf(ye,Object.getPrototypeOf(de)),re&&Object.defineProperty(ye,re,{value:ye,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(ye,t(de))},e.promisify.custom=re;function ne(de,ye){if(!de){var Ce=new Error("Promise was rejected with a falsy value");Ce.reason=de,de=Ce}return ye(de)}function ge(de){if(typeof de!="function")throw new TypeError('The "original" argument must be of type Function');function ye(){for(var Ce=[],ke=0;ke<arguments.length;ke++)Ce.push(arguments[ke]);var ae=Ce.pop();if(typeof ae!="function")throw new TypeError("The last argument must be of type Function");var Q=this,C=function(){return ae.apply(Q,arguments)};de.apply(this,Ce).then(function($){process.nextTick(C.bind(null,null,$))},function($){process.nextTick(ne.bind(null,$,C))})}return Object.setPrototypeOf(ye,Object.getPrototypeOf(de)),Object.defineProperties(ye,t(de)),ye}e.callbackify=ge}});function nextTick$3(e,...t){t.length>0?queueMicrotask(()=>e(...t)):queueMicrotask(e)}var title="browser",platform$2="browser",browser$6=!0,env={},argv=[],version="",versions={},release={},config$2={};function noop$a(){}var on=noop$a,addListener=noop$a,once$5=noop$a,off=noop$a,removeListener=noop$a,removeAllListeners=noop$a,emit=noop$a;function binding(e){throw new Error("process.binding is not supported")}function cwd(){return"/"}function chdir(e){throw new Error("process.chdir is not supported")}function umask(){return 0}var performance$1=globalThis.performance||{},performanceNow=performance$1.now||performance$1.mozNow||performance$1.msNow||performance$1.oNow||performance$1.webkitNow||function(){return new Date().getTime()};function hrtime(e){var t=performanceNow.call(performance$1)*.001,r=Math.floor(t),n=Math.floor(t%1*1e9);return e&&(r=r-e[0],n=n-e[1],n<0&&(r--,n+=1e9)),[r,n]}hrtime.bigint=function(){var e=performanceNow.call(performance$1)*.001,t=Math.floor(e),r=Math.floor(e%1*1e9);return BigInt(t*1e9)+BigInt(r)};var startTime=new Date;function uptime(){var e=new Date,t=e-startTime;return t/1e3}var process$1={nextTick:nextTick$3,title,browser:browser$6,env,argv,version,versions,on,addListener,once:once$5,off,removeListener,removeAllListeners,emit,binding,cwd,chdir,umask,hrtime,platform:platform$2,release,config:config$2,uptime},defines={};Object.keys(defines).forEach(e=>{const t=e.split(".");let r=process$1;for(let n=0;n<t.length;n++){const o=t[n];n===t.length-1?r[o]=defines[e]:r=r[o]||(r[o]={})}});var require_base64_js=__commonJS$2({"node_modules/.pnpm/base64-js@1.5.1/node_modules/base64-js/index.js"(e){e.byteLength=l,e.toByteArray=u,e.fromByteArray=_;var t=[],r=[],n=typeof Uint8Array<"u"?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(s=0,a=o.length;s<a;++s)t[s]=o[s],r[o.charCodeAt(s)]=s;var s,a;r[45]=62,r[95]=63;function c(p){var y=p.length;if(y%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var w=p.indexOf("=");w===-1&&(w=y);var E=w===y?0:4-w%4;return[w,E]}function l(p){var y=c(p),w=y[0],E=y[1];return(w+E)*3/4-E}function h(p,y,w){return(y+w)*3/4-w}function u(p){var y,w=c(p),E=w[0],x=w[1],B=new n(h(p,E,x)),P=0,U=x>0?E-4:E,F;for(F=0;F<U;F+=4)y=r[p.charCodeAt(F)]<<18|r[p.charCodeAt(F+1)]<<12|r[p.charCodeAt(F+2)]<<6|r[p.charCodeAt(F+3)],B[P++]=y>>16&255,B[P++]=y>>8&255,B[P++]=y&255;return x===2&&(y=r[p.charCodeAt(F)]<<2|r[p.charCodeAt(F+1)]>>4,B[P++]=y&255),x===1&&(y=r[p.charCodeAt(F)]<<10|r[p.charCodeAt(F+1)]<<4|r[p.charCodeAt(F+2)]>>2,B[P++]=y>>8&255,B[P++]=y&255),B}function d(p){return t[p>>18&63]+t[p>>12&63]+t[p>>6&63]+t[p&63]}function f(p,y,w){for(var E,x=[],B=y;B<w;B+=3)E=(p[B]<<16&16711680)+(p[B+1]<<8&65280)+(p[B+2]&255),x.push(d(E));return x.join("")}function _(p){for(var y,w=p.length,E=w%3,x=[],B=16383,P=0,U=w-E;P<U;P+=B)x.push(f(p,P,P+B>U?U:P+B));return E===1?(y=p[w-1],x.push(t[y>>2]+t[y<<4&63]+"==")):E===2&&(y=(p[w-2]<<8)+p[w-1],x.push(t[y>>10]+t[y>>4&63]+t[y<<2&63]+"=")),x.join("")}}}),require_ieee754=__commonJS$2({"node_modules/.pnpm/ieee754@1.2.1/node_modules/ieee754/index.js"(e){e.read=function(t,r,n,o,s){var a,c,l=s*8-o-1,h=(1<<l)-1,u=h>>1,d=-7,f=n?s-1:0,_=n?-1:1,p=t[r+f];for(f+=_,a=p&(1<<-d)-1,p>>=-d,d+=l;d>0;a=a*256+t[r+f],f+=_,d-=8);for(c=a&(1<<-d)-1,a>>=-d,d+=o;d>0;c=c*256+t[r+f],f+=_,d-=8);if(a===0)a=1-u;else{if(a===h)return c?NaN:(p?-1:1)*(1/0);c=c+Math.pow(2,o),a=a-u}return(p?-1:1)*c*Math.pow(2,a-o)},e.write=function(t,r,n,o,s,a){var c,l,h,u=a*8-s-1,d=(1<<u)-1,f=d>>1,_=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=o?0:a-1,y=o?1:-1,w=r<0||r===0&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(l=isNaN(r)?1:0,c=d):(c=Math.floor(Math.log(r)/Math.LN2),r*(h=Math.pow(2,-c))<1&&(c--,h*=2),c+f>=1?r+=_/h:r+=_*Math.pow(2,1-f),r*h>=2&&(c++,h/=2),c+f>=d?(l=0,c=d):c+f>=1?(l=(r*h-1)*Math.pow(2,s),c=c+f):(l=r*Math.pow(2,f-1)*Math.pow(2,s),c=0));s>=8;t[n+p]=l&255,p+=y,l/=256,s-=8);for(c=c<<s|l,u+=s;u>0;t[n+p]=c&255,p+=y,c/=256,u-=8);t[n+p-y]|=w*128}}}),require_buffer=__commonJS$2({"node_modules/.pnpm/buffer@6.0.3/node_modules/buffer/index.js"(e){var t=require_base64_js(),r=require_ieee754(),n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=c,e.SlowBuffer=x,e.INSPECT_MAX_BYTES=50;var o=2147483647;e.kMaxLength=o,c.TYPED_ARRAY_SUPPORT=s(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function s(){try{const g=new Uint8Array(1),b={foo:function(){return 42}};return Object.setPrototypeOf(b,Uint8Array.prototype),Object.setPrototypeOf(g,b),g.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function a(g){if(g>o)throw new RangeError('The value "'+g+'" is invalid for option "size"');const b=new Uint8Array(g);return Object.setPrototypeOf(b,c.prototype),b}function c(g,b,T){if(typeof g=="number"){if(typeof b=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return d(g)}return l(g,b,T)}c.poolSize=8192;function l(g,b,T){if(typeof g=="string")return f(g,b);if(ArrayBuffer.isView(g))return p(g);if(g==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g);if(rt(g,ArrayBuffer)||g&&rt(g.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(rt(g,SharedArrayBuffer)||g&&rt(g.buffer,SharedArrayBuffer)))return y(g,b,T);if(typeof g=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const ce=g.valueOf&&g.valueOf();if(ce!=null&&ce!==g)return c.from(ce,b,T);const fe=w(g);if(fe)return fe;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof g[Symbol.toPrimitive]=="function")return c.from(g[Symbol.toPrimitive]("string"),b,T);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g)}c.from=function(g,b,T){return l(g,b,T)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function h(g){if(typeof g!="number")throw new TypeError('"size" argument must be of type number');if(g<0)throw new RangeError('The value "'+g+'" is invalid for option "size"')}function u(g,b,T){return h(g),g<=0?a(g):b!==void 0?typeof T=="string"?a(g).fill(b,T):a(g).fill(b):a(g)}c.alloc=function(g,b,T){return u(g,b,T)};function d(g){return h(g),a(g<0?0:E(g)|0)}c.allocUnsafe=function(g){return d(g)},c.allocUnsafeSlow=function(g){return d(g)};function f(g,b){if((typeof b!="string"||b==="")&&(b="utf8"),!c.isEncoding(b))throw new TypeError("Unknown encoding: "+b);const T=B(g,b)|0;let ce=a(T);const fe=ce.write(g,b);return fe!==T&&(ce=ce.slice(0,fe)),ce}function _(g){const b=g.length<0?0:E(g.length)|0,T=a(b);for(let ce=0;ce<b;ce+=1)T[ce]=g[ce]&255;return T}function p(g){if(rt(g,Uint8Array)){const b=new Uint8Array(g);return y(b.buffer,b.byteOffset,b.byteLength)}return _(g)}function y(g,b,T){if(b<0||g.byteLength<b)throw new RangeError('"offset" is outside of buffer bounds');if(g.byteLength<b+(T||0))throw new RangeError('"length" is outside of buffer bounds');let ce;return b===void 0&&T===void 0?ce=new Uint8Array(g):T===void 0?ce=new Uint8Array(g,b):ce=new Uint8Array(g,b,T),Object.setPrototypeOf(ce,c.prototype),ce}function w(g){if(c.isBuffer(g)){const b=E(g.length)|0,T=a(b);return T.length===0||g.copy(T,0,0,b),T}if(g.length!==void 0)return typeof g.length!="number"||lt(g.length)?a(0):_(g);if(g.type==="Buffer"&&Array.isArray(g.data))return _(g.data)}function E(g){if(g>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return g|0}function x(g){return+g!=g&&(g=0),c.alloc(+g)}c.isBuffer=function(g){return g!=null&&g._isBuffer===!0&&g!==c.prototype},c.compare=function(g,b){if(rt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),rt(b,Uint8Array)&&(b=c.from(b,b.offset,b.byteLength)),!c.isBuffer(g)||!c.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(g===b)return 0;let T=g.length,ce=b.length;for(let fe=0,ve=Math.min(T,ce);fe<ve;++fe)if(g[fe]!==b[fe]){T=g[fe],ce=b[fe];break}return T<ce?-1:ce<T?1:0},c.isEncoding=function(g){switch(String(g).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(g,b){if(!Array.isArray(g))throw new TypeError('"list" argument must be an Array of Buffers');if(g.length===0)return c.alloc(0);let T;if(b===void 0)for(b=0,T=0;T<g.length;++T)b+=g[T].length;const ce=c.allocUnsafe(b);let fe=0;for(T=0;T<g.length;++T){let ve=g[T];if(rt(ve,Uint8Array))fe+ve.length>ce.length?(c.isBuffer(ve)||(ve=c.from(ve)),ve.copy(ce,fe)):Uint8Array.prototype.set.call(ce,ve,fe);else if(c.isBuffer(ve))ve.copy(ce,fe);else throw new TypeError('"list" argument must be an Array of Buffers');fe+=ve.length}return ce};function B(g,b){if(c.isBuffer(g))return g.length;if(ArrayBuffer.isView(g)||rt(g,ArrayBuffer))return g.byteLength;if(typeof g!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof g);const T=g.length,ce=arguments.length>2&&arguments[2]===!0;if(!ce&&T===0)return 0;let fe=!1;for(;;)switch(b){case"ascii":case"latin1":case"binary":return T;case"utf8":case"utf-8":return Me(g).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T*2;case"hex":return T>>>1;case"base64":return st(g).length;default:if(fe)return ce?-1:Me(g).length;b=(""+b).toLowerCase(),fe=!0}}c.byteLength=B;function P(g,b,T){let ce=!1;if((b===void 0||b<0)&&(b=0),b>this.length||((T===void 0||T>this.length)&&(T=this.length),T<=0)||(T>>>=0,b>>>=0,T<=b))return"";for(g||(g="utf8");;)switch(g){case"hex":return re(this,b,T);case"utf8":case"utf-8":return he(this,b,T);case"ascii":return ee(this,b,T);case"latin1":case"binary":return W(this,b,T);case"base64":return q(this,b,T);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ne(this,b,T);default:if(ce)throw new TypeError("Unknown encoding: "+g);g=(g+"").toLowerCase(),ce=!0}}c.prototype._isBuffer=!0;function U(g,b,T){const ce=g[b];g[b]=g[T],g[T]=ce}c.prototype.swap16=function(){const g=this.length;if(g%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let b=0;b<g;b+=2)U(this,b,b+1);return this},c.prototype.swap32=function(){const g=this.length;if(g%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let b=0;b<g;b+=4)U(this,b,b+3),U(this,b+1,b+2);return this},c.prototype.swap64=function(){const g=this.length;if(g%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let b=0;b<g;b+=8)U(this,b,b+7),U(this,b+1,b+6),U(this,b+2,b+5),U(this,b+3,b+4);return this},c.prototype.toString=function(){const g=this.length;return g===0?"":arguments.length===0?he(this,0,g):P.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(g){if(!c.isBuffer(g))throw new TypeError("Argument must be a Buffer");return this===g?!0:c.compare(this,g)===0},c.prototype.inspect=function(){let g="";const b=e.INSPECT_MAX_BYTES;return g=this.toString("hex",0,b).replace(/(.{2})/g,"$1 ").trim(),this.length>b&&(g+=" ... "),"<Buffer "+g+">"},n&&(c.prototype[n]=c.prototype.inspect),c.prototype.compare=function(g,b,T,ce,fe){if(rt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),!c.isBuffer(g))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof g);if(b===void 0&&(b=0),T===void 0&&(T=g?g.length:0),ce===void 0&&(ce=0),fe===void 0&&(fe=this.length),b<0||T>g.length||ce<0||fe>this.length)throw new RangeError("out of range index");if(ce>=fe&&b>=T)return 0;if(ce>=fe)return-1;if(b>=T)return 1;if(b>>>=0,T>>>=0,ce>>>=0,fe>>>=0,this===g)return 0;let ve=fe-ce,Ne=T-b;const tt=Math.min(ve,Ne),ct=this.slice(ce,fe),ot=g.slice(b,T);for(let it=0;it<tt;++it)if(ct[it]!==ot[it]){ve=ct[it],Ne=ot[it];break}return ve<Ne?-1:Ne<ve?1:0};function F(g,b,T,ce,fe){if(g.length===0)return-1;if(typeof T=="string"?(ce=T,T=0):T>2147483647?T=2147483647:T<-2147483648&&(T=-2147483648),T=+T,lt(T)&&(T=fe?0:g.length-1),T<0&&(T=g.length+T),T>=g.length){if(fe)return-1;T=g.length-1}else if(T<0)if(fe)T=0;else return-1;if(typeof b=="string"&&(b=c.from(b,ce)),c.isBuffer(b))return b.length===0?-1:G(g,b,T,ce,fe);if(typeof b=="number")return b=b&255,typeof Uint8Array.prototype.indexOf=="function"?fe?Uint8Array.prototype.indexOf.call(g,b,T):Uint8Array.prototype.lastIndexOf.call(g,b,T):G(g,[b],T,ce,fe);throw new TypeError("val must be string, number or Buffer")}function G(g,b,T,ce,fe){let ve=1,Ne=g.length,tt=b.length;if(ce!==void 0&&(ce=String(ce).toLowerCase(),ce==="ucs2"||ce==="ucs-2"||ce==="utf16le"||ce==="utf-16le")){if(g.length<2||b.length<2)return-1;ve=2,Ne/=2,tt/=2,T/=2}function ct(it,ut){return ve===1?it[ut]:it.readUInt16BE(ut*ve)}let ot;if(fe){let it=-1;for(ot=T;ot<Ne;ot++)if(ct(g,ot)===ct(b,it===-1?0:ot-it)){if(it===-1&&(it=ot),ot-it+1===tt)return it*ve}else it!==-1&&(ot-=ot-it),it=-1}else for(T+tt>Ne&&(T=Ne-tt),ot=T;ot>=0;ot--){let it=!0;for(let ut=0;ut<tt;ut++)if(ct(g,ot+ut)!==ct(b,ut)){it=!1;break}if(it)return ot}return-1}c.prototype.includes=function(g,b,T){return this.indexOf(g,b,T)!==-1},c.prototype.indexOf=function(g,b,T){return F(this,g,b,T,!0)},c.prototype.lastIndexOf=function(g,b,T){return F(this,g,b,T,!1)};function H(g,b,T,ce){T=Number(T)||0;const fe=g.length-T;ce?(ce=Number(ce),ce>fe&&(ce=fe)):ce=fe;const ve=b.length;ce>ve/2&&(ce=ve/2);let Ne;for(Ne=0;Ne<ce;++Ne){const tt=parseInt(b.substr(Ne*2,2),16);if(lt(tt))return Ne;g[T+Ne]=tt}return Ne}function te(g,b,T,ce){return ft(Me(b,g.length-T),g,T,ce)}function J(g,b,T,ce){return ft(We(b),g,T,ce)}function le(g,b,T,ce){return ft(st(b),g,T,ce)}function z(g,b,T,ce){return ft(Fe(b,g.length-T),g,T,ce)}c.prototype.write=function(g,b,T,ce){if(b===void 0)ce="utf8",T=this.length,b=0;else if(T===void 0&&typeof b=="string")ce=b,T=this.length,b=0;else if(isFinite(b))b=b>>>0,isFinite(T)?(T=T>>>0,ce===void 0&&(ce="utf8")):(ce=T,T=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const fe=this.length-b;if((T===void 0||T>fe)&&(T=fe),g.length>0&&(T<0||b<0)||b>this.length)throw new RangeError("Attempt to write outside buffer bounds");ce||(ce="utf8");let ve=!1;for(;;)switch(ce){case"hex":return H(this,g,b,T);case"utf8":case"utf-8":return te(this,g,b,T);case"ascii":case"latin1":case"binary":return J(this,g,b,T);case"base64":return le(this,g,b,T);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return z(this,g,b,T);default:if(ve)throw new TypeError("Unknown encoding: "+ce);ce=(""+ce).toLowerCase(),ve=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function q(g,b,T){return b===0&&T===g.length?t.fromByteArray(g):t.fromByteArray(g.slice(b,T))}function he(g,b,T){T=Math.min(g.length,T);const ce=[];let fe=b;for(;fe<T;){const ve=g[fe];let Ne=null,tt=ve>239?4:ve>223?3:ve>191?2:1;if(fe+tt<=T){let ct,ot,it,ut;switch(tt){case 1:ve<128&&(Ne=ve);break;case 2:ct=g[fe+1],(ct&192)===128&&(ut=(ve&31)<<6|ct&63,ut>127&&(Ne=ut));break;case 3:ct=g[fe+1],ot=g[fe+2],(ct&192)===128&&(ot&192)===128&&(ut=(ve&15)<<12|(ct&63)<<6|ot&63,ut>2047&&(ut<55296||ut>57343)&&(Ne=ut));break;case 4:ct=g[fe+1],ot=g[fe+2],it=g[fe+3],(ct&192)===128&&(ot&192)===128&&(it&192)===128&&(ut=(ve&15)<<18|(ct&63)<<12|(ot&63)<<6|it&63,ut>65535&&ut<1114112&&(Ne=ut))}}Ne===null?(Ne=65533,tt=1):Ne>65535&&(Ne-=65536,ce.push(Ne>>>10&1023|55296),Ne=56320|Ne&1023),ce.push(Ne),fe+=tt}return _e(ce)}var V=4096;function _e(g){const b=g.length;if(b<=V)return String.fromCharCode.apply(String,g);let T="",ce=0;for(;ce<b;)T+=String.fromCharCode.apply(String,g.slice(ce,ce+=V));return T}function ee(g,b,T){let ce="";T=Math.min(g.length,T);for(let fe=b;fe<T;++fe)ce+=String.fromCharCode(g[fe]&127);return ce}function W(g,b,T){let ce="";T=Math.min(g.length,T);for(let fe=b;fe<T;++fe)ce+=String.fromCharCode(g[fe]);return ce}function re(g,b,T){const ce=g.length;(!b||b<0)&&(b=0),(!T||T<0||T>ce)&&(T=ce);let fe="";for(let ve=b;ve<T;++ve)fe+=At[g[ve]];return fe}function ne(g,b,T){const ce=g.slice(b,T);let fe="";for(let ve=0;ve<ce.length-1;ve+=2)fe+=String.fromCharCode(ce[ve]+ce[ve+1]*256);return fe}c.prototype.slice=function(g,b){const T=this.length;g=~~g,b=b===void 0?T:~~b,g<0?(g+=T,g<0&&(g=0)):g>T&&(g=T),b<0?(b+=T,b<0&&(b=0)):b>T&&(b=T),b<g&&(b=g);const ce=this.subarray(g,b);return Object.setPrototypeOf(ce,c.prototype),ce};function ge(g,b,T){if(g%1!==0||g<0)throw new RangeError("offset is not uint");if(g+b>T)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g],fe=1,ve=0;for(;++ve<b&&(fe*=256);)ce+=this[g+ve]*fe;return ce},c.prototype.readUintBE=c.prototype.readUIntBE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g+--b],fe=1;for(;b>0&&(fe*=256);)ce+=this[g+--b]*fe;return ce},c.prototype.readUint8=c.prototype.readUInt8=function(g,b){return g=g>>>0,b||ge(g,1,this.length),this[g]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(g,b){return g=g>>>0,b||ge(g,2,this.length),this[g]|this[g+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(g,b){return g=g>>>0,b||ge(g,2,this.length),this[g]<<8|this[g+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),(this[g]|this[g+1]<<8|this[g+2]<<16)+this[g+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]*16777216+(this[g+1]<<16|this[g+2]<<8|this[g+3])},c.prototype.readBigUInt64LE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=b+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24,fe=this[++g]+this[++g]*2**8+this[++g]*2**16+T*2**24;return BigInt(ce)+(BigInt(fe)<<BigInt(32))}),c.prototype.readBigUInt64BE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=b*2**24+this[++g]*2**16+this[++g]*2**8+this[++g],fe=this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+T;return(BigInt(ce)<<BigInt(32))+BigInt(fe)}),c.prototype.readIntLE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g],fe=1,ve=0;for(;++ve<b&&(fe*=256);)ce+=this[g+ve]*fe;return fe*=128,ce>=fe&&(ce-=Math.pow(2,8*b)),ce},c.prototype.readIntBE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=b,fe=1,ve=this[g+--ce];for(;ce>0&&(fe*=256);)ve+=this[g+--ce]*fe;return fe*=128,ve>=fe&&(ve-=Math.pow(2,8*b)),ve},c.prototype.readInt8=function(g,b){return g=g>>>0,b||ge(g,1,this.length),this[g]&128?(255-this[g]+1)*-1:this[g]},c.prototype.readInt16LE=function(g,b){g=g>>>0,b||ge(g,2,this.length);const T=this[g]|this[g+1]<<8;return T&32768?T|4294901760:T},c.prototype.readInt16BE=function(g,b){g=g>>>0,b||ge(g,2,this.length);const T=this[g+1]|this[g]<<8;return T&32768?T|4294901760:T},c.prototype.readInt32LE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]|this[g+1]<<8|this[g+2]<<16|this[g+3]<<24},c.prototype.readInt32BE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]<<24|this[g+1]<<16|this[g+2]<<8|this[g+3]},c.prototype.readBigInt64LE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=this[g+4]+this[g+5]*2**8+this[g+6]*2**16+(T<<24);return(BigInt(ce)<<BigInt(32))+BigInt(b+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24)}),c.prototype.readBigInt64BE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=(b<<24)+this[++g]*2**16+this[++g]*2**8+this[++g];return(BigInt(ce)<<BigInt(32))+BigInt(this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+T)}),c.prototype.readFloatLE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),r.read(this,g,!0,23,4)},c.prototype.readFloatBE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),r.read(this,g,!1,23,4)},c.prototype.readDoubleLE=function(g,b){return g=g>>>0,b||ge(g,8,this.length),r.read(this,g,!0,52,8)},c.prototype.readDoubleBE=function(g,b){return g=g>>>0,b||ge(g,8,this.length),r.read(this,g,!1,52,8)};function de(g,b,T,ce,fe,ve){if(!c.isBuffer(g))throw new TypeError('"buffer" argument must be a Buffer instance');if(b>fe||b<ve)throw new RangeError('"value" argument is out of bounds');if(T+ce>g.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(g,b,T,ce){if(g=+g,b=b>>>0,T=T>>>0,!ce){const Ne=Math.pow(2,8*T)-1;de(this,g,b,T,Ne,0)}let fe=1,ve=0;for(this[b]=g&255;++ve<T&&(fe*=256);)this[b+ve]=g/fe&255;return b+T},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(g,b,T,ce){if(g=+g,b=b>>>0,T=T>>>0,!ce){const Ne=Math.pow(2,8*T)-1;de(this,g,b,T,Ne,0)}let fe=T-1,ve=1;for(this[b+fe]=g&255;--fe>=0&&(ve*=256);)this[b+fe]=g/ve&255;return b+T},c.prototype.writeUint8=c.prototype.writeUInt8=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,1,255,0),this[b]=g&255,b+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,65535,0),this[b]=g&255,this[b+1]=g>>>8,b+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,65535,0),this[b]=g>>>8,this[b+1]=g&255,b+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,4294967295,0),this[b+3]=g>>>24,this[b+2]=g>>>16,this[b+1]=g>>>8,this[b]=g&255,b+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,4294967295,0),this[b]=g>>>24,this[b+1]=g>>>16,this[b+2]=g>>>8,this[b+3]=g&255,b+4};function ye(g,b,T,ce,fe){k(b,ce,fe,g,T,7);let ve=Number(b&BigInt(4294967295));g[T++]=ve,ve=ve>>8,g[T++]=ve,ve=ve>>8,g[T++]=ve,ve=ve>>8,g[T++]=ve;let Ne=Number(b>>BigInt(32)&BigInt(4294967295));return g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,T}function Ce(g,b,T,ce,fe){k(b,ce,fe,g,T,7);let ve=Number(b&BigInt(4294967295));g[T+7]=ve,ve=ve>>8,g[T+6]=ve,ve=ve>>8,g[T+5]=ve,ve=ve>>8,g[T+4]=ve;let Ne=Number(b>>BigInt(32)&BigInt(4294967295));return g[T+3]=Ne,Ne=Ne>>8,g[T+2]=Ne,Ne=Ne>>8,g[T+1]=Ne,Ne=Ne>>8,g[T]=Ne,T+8}c.prototype.writeBigUInt64LE=qe(function(g,b=0){return ye(this,g,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=qe(function(g,b=0){return Ce(this,g,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(g,b,T,ce){if(g=+g,b=b>>>0,!ce){const tt=Math.pow(2,8*T-1);de(this,g,b,T,tt-1,-tt)}let fe=0,ve=1,Ne=0;for(this[b]=g&255;++fe<T&&(ve*=256);)g<0&&Ne===0&&this[b+fe-1]!==0&&(Ne=1),this[b+fe]=(g/ve>>0)-Ne&255;return b+T},c.prototype.writeIntBE=function(g,b,T,ce){if(g=+g,b=b>>>0,!ce){const tt=Math.pow(2,8*T-1);de(this,g,b,T,tt-1,-tt)}let fe=T-1,ve=1,Ne=0;for(this[b+fe]=g&255;--fe>=0&&(ve*=256);)g<0&&Ne===0&&this[b+fe+1]!==0&&(Ne=1),this[b+fe]=(g/ve>>0)-Ne&255;return b+T},c.prototype.writeInt8=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,1,127,-128),g<0&&(g=255+g+1),this[b]=g&255,b+1},c.prototype.writeInt16LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,32767,-32768),this[b]=g&255,this[b+1]=g>>>8,b+2},c.prototype.writeInt16BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,32767,-32768),this[b]=g>>>8,this[b+1]=g&255,b+2},c.prototype.writeInt32LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,2147483647,-2147483648),this[b]=g&255,this[b+1]=g>>>8,this[b+2]=g>>>16,this[b+3]=g>>>24,b+4},c.prototype.writeInt32BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,2147483647,-2147483648),g<0&&(g=4294967295+g+1),this[b]=g>>>24,this[b+1]=g>>>16,this[b+2]=g>>>8,this[b+3]=g&255,b+4},c.prototype.writeBigInt64LE=qe(function(g,b=0){return ye(this,g,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=qe(function(g,b=0){return Ce(this,g,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ke(g,b,T,ce,fe,ve){if(T+ce>g.length)throw new RangeError("Index out of range");if(T<0)throw new RangeError("Index out of range")}function ae(g,b,T,ce,fe){return b=+b,T=T>>>0,fe||ke(g,b,T,4),r.write(g,b,T,ce,23,4),T+4}c.prototype.writeFloatLE=function(g,b,T){return ae(this,g,b,!0,T)},c.prototype.writeFloatBE=function(g,b,T){return ae(this,g,b,!1,T)};function Q(g,b,T,ce,fe){return b=+b,T=T>>>0,fe||ke(g,b,T,8),r.write(g,b,T,ce,52,8),T+8}c.prototype.writeDoubleLE=function(g,b,T){return Q(this,g,b,!0,T)},c.prototype.writeDoubleBE=function(g,b,T){return Q(this,g,b,!1,T)},c.prototype.copy=function(g,b,T,ce){if(!c.isBuffer(g))throw new TypeError("argument should be a Buffer");if(T||(T=0),!ce&&ce!==0&&(ce=this.length),b>=g.length&&(b=g.length),b||(b=0),ce>0&&ce<T&&(ce=T),ce===T||g.length===0||this.length===0)return 0;if(b<0)throw new RangeError("targetStart out of bounds");if(T<0||T>=this.length)throw new RangeError("Index out of range");if(ce<0)throw new RangeError("sourceEnd out of bounds");ce>this.length&&(ce=this.length),g.length-b<ce-T&&(ce=g.length-b+T);const fe=ce-T;return this===g&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(b,T,ce):Uint8Array.prototype.set.call(g,this.subarray(T,ce),b),fe},c.prototype.fill=function(g,b,T,ce){if(typeof g=="string"){if(typeof b=="string"?(ce=b,b=0,T=this.length):typeof T=="string"&&(ce=T,T=this.length),ce!==void 0&&typeof ce!="string")throw new TypeError("encoding must be a string");if(typeof ce=="string"&&!c.isEncoding(ce))throw new TypeError("Unknown encoding: "+ce);if(g.length===1){const ve=g.charCodeAt(0);(ce==="utf8"&&ve<128||ce==="latin1")&&(g=ve)}}else typeof g=="number"?g=g&255:typeof g=="boolean"&&(g=Number(g));if(b<0||this.length<b||this.length<T)throw new RangeError("Out of range index");if(T<=b)return this;b=b>>>0,T=T===void 0?this.length:T>>>0,g||(g=0);let fe;if(typeof g=="number")for(fe=b;fe<T;++fe)this[fe]=g;else{const ve=c.isBuffer(g)?g:c.from(g,ce),Ne=ve.length;if(Ne===0)throw new TypeError('The value "'+g+'" is invalid for argument "value"');for(fe=0;fe<T-b;++fe)this[fe+b]=ve[fe%Ne]}return this};var C={};function $(g,b,T){C[g]=class extends T{constructor(){super(),Object.defineProperty(this,"message",{value:b.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${g}]`,this.stack,delete this.name}get code(){return g}set code(ce){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:ce,writable:!0})}toString(){return`${this.name} [${g}]: ${this.message}`}}}$("ERR_BUFFER_OUT_OF_BOUNDS",function(g){return g?`${g} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),$("ERR_INVALID_ARG_TYPE",function(g,b){return`The "${g}" argument must be of type number. Received type ${typeof b}`},TypeError),$("ERR_OUT_OF_RANGE",function(g,b,T){let ce=`The value of "${g}" is out of range.`,fe=T;return Number.isInteger(T)&&Math.abs(T)>2**32?fe=j(String(T)):typeof T=="bigint"&&(fe=String(T),(T>BigInt(2)**BigInt(32)||T<-(BigInt(2)**BigInt(32)))&&(fe=j(fe)),fe+="n"),ce+=` It must be ${b}. Received ${fe}`,ce},RangeError);function j(g){let b="",T=g.length;const ce=g[0]==="-"?1:0;for(;T>=ce+4;T-=3)b=`_${g.slice(T-3,T)}${b}`;return`${g.slice(0,T)}${b}`}function O(g,b,T){ue(b,"offset"),(g[b]===void 0||g[b+T]===void 0)&&pe(b,g.length-(T+1))}function k(g,b,T,ce,fe,ve){if(g>T||g<b){const Ne=typeof b=="bigint"?"n":"";let tt;throw b===0||b===BigInt(0)?tt=`>= 0${Ne} and < 2${Ne} ** ${(ve+1)*8}${Ne}`:tt=`>= -(2${Ne} ** ${(ve+1)*8-1}${Ne}) and < 2 ** ${(ve+1)*8-1}${Ne}`,new C.ERR_OUT_OF_RANGE("value",tt,g)}O(ce,fe,ve)}function ue(g,b){if(typeof g!="number")throw new C.ERR_INVALID_ARG_TYPE(b,"number",g)}function pe(g,b,T){throw Math.floor(g)!==g?(ue(g,T),new C.ERR_OUT_OF_RANGE("offset","an integer",g)):b<0?new C.ERR_BUFFER_OUT_OF_BOUNDS:new C.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${b}`,g)}var Oe=/[^+/0-9A-Za-z-_]/g;function Le(g){if(g=g.split("=")[0],g=g.trim().replace(Oe,""),g.length<2)return"";for(;g.length%4!==0;)g=g+"=";return g}function Me(g,b){b=b||1/0;let T;const ce=g.length;let fe=null;const ve=[];for(let Ne=0;Ne<ce;++Ne){if(T=g.charCodeAt(Ne),T>55295&&T<57344){if(!fe){if(T>56319){(b-=3)>-1&&ve.push(239,191,189);continue}else if(Ne+1===ce){(b-=3)>-1&&ve.push(239,191,189);continue}fe=T;continue}if(T<56320){(b-=3)>-1&&ve.push(239,191,189),fe=T;continue}T=(fe-55296<<10|T-56320)+65536}else fe&&(b-=3)>-1&&ve.push(239,191,189);if(fe=null,T<128){if((b-=1)<0)break;ve.push(T)}else if(T<2048){if((b-=2)<0)break;ve.push(T>>6|192,T&63|128)}else if(T<65536){if((b-=3)<0)break;ve.push(T>>12|224,T>>6&63|128,T&63|128)}else if(T<1114112){if((b-=4)<0)break;ve.push(T>>18|240,T>>12&63|128,T>>6&63|128,T&63|128)}else throw new Error("Invalid code point")}return ve}function We(g){const b=[];for(let T=0;T<g.length;++T)b.push(g.charCodeAt(T)&255);return b}function Fe(g,b){let T,ce,fe;const ve=[];for(let Ne=0;Ne<g.length&&!((b-=2)<0);++Ne)T=g.charCodeAt(Ne),ce=T>>8,fe=T%256,ve.push(fe),ve.push(ce);return ve}function st(g){return t.toByteArray(Le(g))}function ft(g,b,T,ce){let fe;for(fe=0;fe<ce&&!(fe+T>=b.length||fe>=g.length);++fe)b[fe+T]=g[fe];return fe}function rt(g,b){return g instanceof b||g!=null&&g.constructor!=null&&g.constructor.name!=null&&g.constructor.name===b.name}function lt(g){return g!==g}var At=function(){const g="0123456789abcdef",b=new Array(256);for(let T=0;T<16;++T){const ce=T*16;for(let fe=0;fe<16;++fe)b[ce+fe]=g[T]+g[fe]}return b}();function qe(g){return typeof BigInt>"u"?Je:g}function Je(){throw new Error("BigInt not supported")}}}),import_buffer$1=__toESM$2(require_buffer());globalThis.global=globalThis,globalThis.Buffer=import_buffer$1.Buffer,globalThis.process=process$1;let import_util,import_util2,util_default,export_callbackify;import_util=__toESM$2(require_util()),import_util2=__toESM$2(require_util()),util_default=import_util.default,export_callbackify=import_util2.callbackify,export_inspect=import_util2.inspect,import_util2.promisify;var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(e.__esModule)return e;var t=e.default;if(typeof t=="function"){var r=function n(){return this instanceof n?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(r,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}),r}var funcTag$2="[object Function]",genTag$2="[object GeneratorFunction]",reRegExpChar$2=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor$2=/^\[object .+?Constructor\]$/,freeGlobal$3=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf$3=typeof self=="object"&&self&&self.Object===Object&&self,root$4=freeGlobal$3||freeSelf$3||Function("return this")();function getValue$2(e,t){return e==null?void 0:e[t]}function isHostObject$2(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}var funcProto$2=Function.prototype,objectProto$2=Object.prototype,coreJsData$2=root$4["__core-js_shared__"],maskSrcKey$2=function(){var e=/[^.]+$/.exec(coreJsData$2&&coreJsData$2.keys&&coreJsData$2.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),funcToString$2=funcProto$2.toString,hasOwnProperty$3=objectProto$2.hasOwnProperty,objectToString$2=objectProto$2.toString,reIsNative$2=RegExp("^"+funcToString$2.call(hasOwnProperty$3).replace(reRegExpChar$2,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Symbol$4=root$4.Symbol;Symbol$4&&Symbol$4.isConcatSpreadable,getNative$2(root$4,"Map"),getNative$2(Object,"create");function baseIsNative$2(e){if(!isObject$4(e)||isMasked$2(e))return!1;var t=isFunction$4(e)||isHostObject$2(e)?reIsNative$2:reIsHostCtor$2;return t.test(toSource$2(e))}function getNative$2(e,t){var r=getValue$2(e,t);return baseIsNative$2(r)?r:void 0}function isMasked$2(e){return!!maskSrcKey$2&&maskSrcKey$2 in e}function toSource$2(e){if(e!=null){try{return funcToString$2.call(e)}catch{}try{return e+""}catch{}}return""}function isFunction$4(e){var t=isObject$4(e)?objectToString$2.call(e):"";return t==funcTag$2||t==genTag$2}function isObject$4(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}var freeGlobal$2=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf$2=typeof self=="object"&&self&&self.Object===Object&&self,root$3=freeGlobal$2||freeSelf$2||Function("return this")(),Symbol$3=root$3.Symbol;Symbol$3&&Symbol$3.isConcatSpreadable;var ansiStyles$1={exports:{}},colorName,hasRequiredColorName;function requireColorName(){return hasRequiredColorName||(hasRequiredColorName=1,colorName={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}),colorName}var conversions,hasRequiredConversions;function requireConversions(){if(hasRequiredConversions)return conversions;hasRequiredConversions=1;const e=requireColorName(),t={};for(const o of Object.keys(e))t[e[o]]=o;const r={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};conversions=r;for(const o of Object.keys(r)){if(!("channels"in r[o]))throw new Error("missing channels property: "+o);if(!("labels"in r[o]))throw new Error("missing channel labels property: "+o);if(r[o].labels.length!==r[o].channels)throw new Error("channel and label counts mismatch: "+o);const{channels:s,labels:a}=r[o];delete r[o].channels,delete r[o].labels,Object.defineProperty(r[o],"channels",{value:s}),Object.defineProperty(r[o],"labels",{value:a})}r.rgb.hsl=function(o){const s=o[0]/255,a=o[1]/255,c=o[2]/255,l=Math.min(s,a,c),h=Math.max(s,a,c),u=h-l;let d,f;h===l?d=0:s===h?d=(a-c)/u:a===h?d=2+(c-s)/u:c===h&&(d=4+(s-a)/u),d=Math.min(d*60,360),d<0&&(d+=360);const _=(l+h)/2;return h===l?f=0:_<=.5?f=u/(h+l):f=u/(2-h-l),[d,f*100,_*100]},r.rgb.hsv=function(o){let s,a,c,l,h;const u=o[0]/255,d=o[1]/255,f=o[2]/255,_=Math.max(u,d,f),p=_-Math.min(u,d,f),y=function(w){return(_-w)/6/p+1/2};return p===0?(l=0,h=0):(h=p/_,s=y(u),a=y(d),c=y(f),u===_?l=c-a:d===_?l=.3333333333333333+s-c:f===_&&(l=.6666666666666666+a-s),l<0?l+=1:l>1&&(l-=1)),[l*360,h*100,_*100]},r.rgb.hwb=function(o){const s=o[0],a=o[1];let c=o[2];const l=r.rgb.hsl(o)[0],h=1/255*Math.min(s,Math.min(a,c));return c=1-.00392156862745098*Math.max(s,Math.max(a,c)),[l,h*100,c*100]},r.rgb.cmyk=function(o){const s=o[0]/255,a=o[1]/255,c=o[2]/255,l=Math.min(1-s,1-a,1-c),h=(1-s-l)/(1-l)||0,u=(1-a-l)/(1-l)||0,d=(1-c-l)/(1-l)||0;return[h*100,u*100,d*100,l*100]};function n(o,s){return(o[0]-s[0])**2+(o[1]-s[1])**2+(o[2]-s[2])**2}return r.rgb.keyword=function(o){const s=t[o];if(s)return s;let a=1/0,c;for(const l of Object.keys(e)){const h=e[l],u=n(o,h);u<a&&(a=u,c=l)}return c},r.keyword.rgb=function(o){return e[o]},r.rgb.xyz=function(o){let s=o[0]/255,a=o[1]/255,c=o[2]/255;s=s>.04045?((s+.055)/1.055)**2.4:s/12.92,a=a>.04045?((a+.055)/1.055)**2.4:a/12.92,c=c>.04045?((c+.055)/1.055)**2.4:c/12.92;const l=s*.4124+a*.3576+c*.1805,h=s*.2126+a*.7152+c*.0722,u=s*.0193+a*.1192+c*.9505;return[l*100,h*100,u*100]},r.rgb.lab=function(o){const s=r.rgb.xyz(o);let a=s[0],c=s[1],l=s[2];a/=95.047,c/=100,l/=108.883,a=a>.008856?a**.3333333333333333:7.787*a+.13793103448275862,c=c>.008856?c**.3333333333333333:7.787*c+.13793103448275862,l=l>.008856?l**.3333333333333333:7.787*l+.13793103448275862;const h=116*c-16,u=500*(a-c),d=200*(c-l);return[h,u,d]},r.hsl.rgb=function(o){const s=o[0]/360,a=o[1]/100,c=o[2]/100;let l,h,u;if(a===0)return u=c*255,[u,u,u];c<.5?l=c*(1+a):l=c+a-c*a;const d=2*c-l,f=[0,0,0];for(let _=0;_<3;_++)h=s+.3333333333333333*-(_-1),h<0&&h++,h>1&&h--,6*h<1?u=d+(l-d)*6*h:2*h<1?u=l:3*h<2?u=d+(l-d)*(.6666666666666666-h)*6:u=d,f[_]=u*255;return f},r.hsl.hsv=function(o){const s=o[0];let a=o[1]/100,c=o[2]/100,l=a;const h=Math.max(c,.01);c*=2,a*=c<=1?c:2-c,l*=h<=1?h:2-h;const u=(c+a)/2,d=c===0?2*l/(h+l):2*a/(c+a);return[s,d*100,u*100]},r.hsv.rgb=function(o){const s=o[0]/60,a=o[1]/100;let c=o[2]/100;const l=Math.floor(s)%6,h=s-Math.floor(s),u=255*c*(1-a),d=255*c*(1-a*h),f=255*c*(1-a*(1-h));switch(c*=255,l){case 0:return[c,f,u];case 1:return[d,c,u];case 2:return[u,c,f];case 3:return[u,d,c];case 4:return[f,u,c];case 5:return[c,u,d]}},r.hsv.hsl=function(o){const s=o[0],a=o[1]/100,c=o[2]/100,l=Math.max(c,.01);let h,u;u=(2-a)*c;const d=(2-a)*l;return h=a*l,h/=d<=1?d:2-d,h=h||0,u/=2,[s,h*100,u*100]},r.hwb.rgb=function(o){const s=o[0]/360;let a=o[1]/100,c=o[2]/100;const l=a+c;let h;l>1&&(a/=l,c/=l);const u=Math.floor(6*s),d=1-c;h=6*s-u,u&1&&(h=1-h);const f=a+h*(d-a);let _,p,y;switch(u){default:case 6:case 0:_=d,p=f,y=a;break;case 1:_=f,p=d,y=a;break;case 2:_=a,p=d,y=f;break;case 3:_=a,p=f,y=d;break;case 4:_=f,p=a,y=d;break;case 5:_=d,p=a,y=f;break}return[_*255,p*255,y*255]},r.cmyk.rgb=function(o){const s=o[0]/100,a=o[1]/100,c=o[2]/100,l=o[3]/100,h=1-Math.min(1,s*(1-l)+l),u=1-Math.min(1,a*(1-l)+l),d=1-Math.min(1,c*(1-l)+l);return[h*255,u*255,d*255]},r.xyz.rgb=function(o){const s=o[0]/100,a=o[1]/100,c=o[2]/100;let l,h,u;return l=s*3.2406+a*-1.5372+c*-.4986,h=s*-.9689+a*1.8758+c*.0415,u=s*.0557+a*-.204+c*1.057,l=l>.0031308?1.055*l**.4166666666666667-.055:l*12.92,h=h>.0031308?1.055*h**.4166666666666667-.055:h*12.92,u=u>.0031308?1.055*u**.4166666666666667-.055:u*12.92,l=Math.min(Math.max(0,l),1),h=Math.min(Math.max(0,h),1),u=Math.min(Math.max(0,u),1),[l*255,h*255,u*255]},r.xyz.lab=function(o){let s=o[0],a=o[1],c=o[2];s/=95.047,a/=100,c/=108.883,s=s>.008856?s**.3333333333333333:7.787*s+.13793103448275862,a=a>.008856?a**.3333333333333333:7.787*a+.13793103448275862,c=c>.008856?c**.3333333333333333:7.787*c+.13793103448275862;const l=116*a-16,h=500*(s-a),u=200*(a-c);return[l,h,u]},r.lab.xyz=function(o){const s=o[0],a=o[1],c=o[2];let l,h,u;h=(s+16)/116,l=a/500+h,u=h-c/200;const d=h**3,f=l**3,_=u**3;return h=d>.008856?d:(h-.13793103448275862)/7.787,l=f>.008856?f:(l-.13793103448275862)/7.787,u=_>.008856?_:(u-.13793103448275862)/7.787,l*=95.047,h*=100,u*=108.883,[l,h,u]},r.lab.lch=function(o){const s=o[0],a=o[1],c=o[2];let l;l=Math.atan2(c,a)*360/2/Math.PI,l<0&&(l+=360);const h=Math.sqrt(a*a+c*c);return[s,h,l]},r.lch.lab=function(o){const s=o[0],a=o[1],c=o[2]/360*2*Math.PI,l=a*Math.cos(c),h=a*Math.sin(c);return[s,l,h]},r.rgb.ansi16=function(o,s=null){const[a,c,l]=o;let h=s===null?r.rgb.hsv(o)[2]:s;if(h=Math.round(h/50),h===0)return 30;let u=30+(Math.round(l/255)<<2|Math.round(c/255)<<1|Math.round(a/255));return h===2&&(u+=60),u},r.hsv.ansi16=function(o){return r.rgb.ansi16(r.hsv.rgb(o),o[2])},r.rgb.ansi256=function(o){const s=o[0],a=o[1],c=o[2];return s===a&&a===c?s<8?16:s>248?231:Math.round((s-8)/247*24)+232:16+36*Math.round(s/255*5)+6*Math.round(a/255*5)+Math.round(c/255*5)},r.ansi16.rgb=function(o){let s=o%10;if(s===0||s===7)return o>50&&(s+=3.5),s=s/10.5*255,[s,s,s];const a=(~~(o>50)+1)*.5,c=(s&1)*a*255,l=(s>>1&1)*a*255,h=(s>>2&1)*a*255;return[c,l,h]},r.ansi256.rgb=function(o){if(o>=232){const h=(o-232)*10+8;return[h,h,h]}o-=16;let s;const a=Math.floor(o/36)/5*255,c=Math.floor((s=o%36)/6)/5*255,l=s%6/5*255;return[a,c,l]},r.rgb.hex=function(o){const s=(((Math.round(o[0])&255)<<16)+((Math.round(o[1])&255)<<8)+(Math.round(o[2])&255)).toString(16).toUpperCase();return"000000".substring(s.length)+s},r.hex.rgb=function(o){const s=o.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!s)return[0,0,0];let a=s[0];s[0].length===3&&(a=a.split("").map(d=>d+d).join(""));const c=parseInt(a,16),l=c>>16&255,h=c>>8&255,u=c&255;return[l,h,u]},r.rgb.hcg=function(o){const s=o[0]/255,a=o[1]/255,c=o[2]/255,l=Math.max(Math.max(s,a),c),h=Math.min(Math.min(s,a),c),u=l-h;let d,f;return u<1?d=h/(1-u):d=0,u<=0?f=0:l===s?f=(a-c)/u%6:l===a?f=2+(c-s)/u:f=4+(s-a)/u,f/=6,f%=1,[f*360,u*100,d*100]},r.hsl.hcg=function(o){const s=o[1]/100,a=o[2]/100,c=a<.5?2*s*a:2*s*(1-a);let l=0;return c<1&&(l=(a-.5*c)/(1-c)),[o[0],c*100,l*100]},r.hsv.hcg=function(o){const s=o[1]/100,a=o[2]/100,c=s*a;let l=0;return c<1&&(l=(a-c)/(1-c)),[o[0],c*100,l*100]},r.hcg.rgb=function(o){const s=o[0]/360,a=o[1]/100,c=o[2]/100;if(a===0)return[c*255,c*255,c*255];const l=[0,0,0],h=s%1*6,u=h%1,d=1-u;let f=0;switch(Math.floor(h)){case 0:l[0]=1,l[1]=u,l[2]=0;break;case 1:l[0]=d,l[1]=1,l[2]=0;break;case 2:l[0]=0,l[1]=1,l[2]=u;break;case 3:l[0]=0,l[1]=d,l[2]=1;break;case 4:l[0]=u,l[1]=0,l[2]=1;break;default:l[0]=1,l[1]=0,l[2]=d}return f=(1-a)*c,[(a*l[0]+f)*255,(a*l[1]+f)*255,(a*l[2]+f)*255]},r.hcg.hsv=function(o){const s=o[1]/100,a=o[2]/100,c=s+a*(1-s);let l=0;return c>0&&(l=s/c),[o[0],l*100,c*100]},r.hcg.hsl=function(o){const s=o[1]/100,a=o[2]/100*(1-s)+.5*s;let c=0;return a>0&&a<.5?c=s/(2*a):a>=.5&&a<1&&(c=s/(2*(1-a))),[o[0],c*100,a*100]},r.hcg.hwb=function(o){const s=o[1]/100,a=o[2]/100,c=s+a*(1-s);return[o[0],(c-s)*100,(1-c)*100]},r.hwb.hcg=function(o){const s=o[1]/100,a=1-o[2]/100,c=a-s;let l=0;return c<1&&(l=(a-c)/(1-c)),[o[0],c*100,l*100]},r.apple.rgb=function(o){return[o[0]/65535*255,o[1]/65535*255,o[2]/65535*255]},r.rgb.apple=function(o){return[o[0]/255*65535,o[1]/255*65535,o[2]/255*65535]},r.gray.rgb=function(o){return[o[0]/100*255,o[0]/100*255,o[0]/100*255]},r.gray.hsl=function(o){return[0,0,o[0]]},r.gray.hsv=r.gray.hsl,r.gray.hwb=function(o){return[0,100,o[0]]},r.gray.cmyk=function(o){return[0,0,0,o[0]]},r.gray.lab=function(o){return[o[0],0,0]},r.gray.hex=function(o){const s=Math.round(o[0]/100*255)&255,a=((s<<16)+(s<<8)+s).toString(16).toUpperCase();return"000000".substring(a.length)+a},r.rgb.gray=function(o){return[(o[0]+o[1]+o[2])/3/255*100]},conversions}var route,hasRequiredRoute;function requireRoute(){if(hasRequiredRoute)return route;hasRequiredRoute=1;const e=requireConversions();function t(){const s={},a=Object.keys(e);for(let c=a.length,l=0;l<c;l++)s[a[l]]={distance:-1,parent:null};return s}function r(s){const a=t(),c=[s];for(a[s].distance=0;c.length;){const l=c.pop(),h=Object.keys(e[l]);for(let u=h.length,d=0;d<u;d++){const f=h[d],_=a[f];_.distance===-1&&(_.distance=a[l].distance+1,_.parent=l,c.unshift(f))}}return a}function n(s,a){return function(c){return a(s(c))}}function o(s,a){const c=[a[s].parent,s];let l=e[a[s].parent][s],h=a[s].parent;for(;a[h].parent;)c.unshift(a[h].parent),l=n(e[a[h].parent][h],l),h=a[h].parent;return l.conversion=c,l}return route=function(s){const a=r(s),c={},l=Object.keys(a);for(let h=l.length,u=0;u<h;u++){const d=l[u];a[d].parent!==null&&(c[d]=o(d,a))}return c},route}var colorConvert,hasRequiredColorConvert;function requireColorConvert(){if(hasRequiredColorConvert)return colorConvert;hasRequiredColorConvert=1;const e=requireConversions(),t=requireRoute(),r={},n=Object.keys(e);function o(a){const c=function(...l){const h=l[0];return h==null?h:(h.length>1&&(l=h),a(l))};return"conversion"in a&&(c.conversion=a.conversion),c}function s(a){const c=function(...l){const h=l[0];if(h==null)return h;h.length>1&&(l=h);const u=a(l);if(typeof u=="object")for(let d=u.length,f=0;f<d;f++)u[f]=Math.round(u[f]);return u};return"conversion"in a&&(c.conversion=a.conversion),c}return n.forEach(a=>{r[a]={},Object.defineProperty(r[a],"channels",{value:e[a].channels}),Object.defineProperty(r[a],"labels",{value:e[a].labels});const c=t(a);Object.keys(c).forEach(l=>{const h=c[l];r[a][l]=s(h),r[a][l].raw=o(h)})}),colorConvert=r,colorConvert}ansiStyles$1.exports,function(e){const t=(u,d)=>(...f)=>`\x1B[${u(...f)+d}m`,r=(u,d)=>(...f)=>{const _=u(...f);return`\x1B[${38+d};5;${_}m`},n=(u,d)=>(...f)=>{const _=u(...f);return`\x1B[${38+d};2;${_[0]};${_[1]};${_[2]}m`},o=u=>u,s=(u,d,f)=>[u,d,f],a=(u,d,f)=>{Object.defineProperty(u,d,{get:()=>{const _=f();return Object.defineProperty(u,d,{value:_,enumerable:!0,configurable:!0}),_},enumerable:!0,configurable:!0})};let c;const l=(u,d,f,_)=>{c===void 0&&(c=requireColorConvert());const p=_?10:0,y={};for(const[w,E]of Object.entries(c)){const x=w==="ansi16"?"ansi":w;w===d?y[x]=u(f,p):typeof E=="object"&&(y[x]=u(E[d],p))}return y};function h(){const u=new Map,d={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};d.color.gray=d.color.blackBright,d.bgColor.bgGray=d.bgColor.bgBlackBright,d.color.grey=d.color.blackBright,d.bgColor.bgGrey=d.bgColor.bgBlackBright;for(const[f,_]of Object.entries(d)){for(const[p,y]of Object.entries(_))d[p]={open:`\x1B[${y[0]}m`,close:`\x1B[${y[1]}m`},_[p]=d[p],u.set(y[0],y[1]);Object.defineProperty(d,f,{value:_,enumerable:!1})}return Object.defineProperty(d,"codes",{value:u,enumerable:!1}),d.color.close="\x1B[39m",d.bgColor.close="\x1B[49m",a(d.color,"ansi",()=>l(t,"ansi16",o,!1)),a(d.color,"ansi256",()=>l(r,"ansi256",o,!1)),a(d.color,"ansi16m",()=>l(n,"rgb",s,!1)),a(d.bgColor,"ansi",()=>l(t,"ansi16",o,!0)),a(d.bgColor,"ansi256",()=>l(r,"ansi256",o,!0)),a(d.bgColor,"ansi16m",()=>l(n,"rgb",s,!0)),d}Object.defineProperty(e,"exports",{enumerable:!0,get:h})}(ansiStyles$1);var ansiStylesExports=ansiStyles$1.exports,browser$5={stdout:!1,stderr:!1};const stringReplaceAll$1=(e,t,r)=>{let n=e.indexOf(t);if(n===-1)return e;const o=t.length;let s=0,a="";do a+=e.substr(s,n-s)+t+r,s=n+o,n=e.indexOf(t,s);while(n!==-1);return a+=e.substr(s),a},stringEncaseCRLFWithFirstIndex$1=(e,t,r,n)=>{let o=0,s="";do{const a=e[n-1]==="\r";s+=e.substr(o,(a?n-1:n)-o)+t+(a?`\r
`:`
`)+r,o=n+1,n=e.indexOf(`
`,o)}while(n!==-1);return s+=e.substr(o),s};var util$8={stringReplaceAll:stringReplaceAll$1,stringEncaseCRLFWithFirstIndex:stringEncaseCRLFWithFirstIndex$1},templates,hasRequiredTemplates;function requireTemplates(){if(hasRequiredTemplates)return templates;hasRequiredTemplates=1;const e=/(?:\\(u(?:[a-f\d]{4}|\{[a-f\d]{1,6}\})|x[a-f\d]{2}|.))|(?:\{(~)?(\w+(?:\([^)]*\))?(?:\.\w+(?:\([^)]*\))?)*)(?:[ \t]|(?=\r?\n)))|(\})|((?:.|[\r\n\f])+?)/gi,t=/(?:^|\.)(\w+)(?:\(([^)]*)\))?/g,r=/^(['"])((?:\\.|(?!\1)[^\\])*)\1$/,n=/\\(u(?:[a-f\d]{4}|{[a-f\d]{1,6}})|x[a-f\d]{2}|.)|([^\\])/gi,o=new Map([["n",`
`],["r","\r"],["t","	"],["b","\b"],["f","\f"],["v","\v"],["0","\0"],["\\","\\"],["e","\x1B"],["a","\x07"]]);function s(h){const u=h[0]==="u",d=h[1]==="{";return u&&!d&&h.length===5||h[0]==="x"&&h.length===3?String.fromCharCode(parseInt(h.slice(1),16)):u&&d?String.fromCodePoint(parseInt(h.slice(2,-1),16)):o.get(h)||h}function a(h,u){const d=[],f=u.trim().split(/\s*,\s*/g);let _;for(const p of f){const y=Number(p);if(!Number.isNaN(y))d.push(y);else if(_=p.match(r))d.push(_[2].replace(n,(w,E,x)=>E?s(E):x));else throw new Error(`Invalid Chalk template style argument: ${p} (in style '${h}')`)}return d}function c(h){t.lastIndex=0;const u=[];let d;for(;(d=t.exec(h))!==null;){const f=d[1];if(d[2]){const _=a(f,d[2]);u.push([f].concat(_))}else u.push([f])}return u}function l(h,u){const d={};for(const _ of u)for(const p of _.styles)d[p[0]]=_.inverse?null:p.slice(1);let f=h;for(const[_,p]of Object.entries(d))if(Array.isArray(p)){if(!(_ in f))throw new Error(`Unknown Chalk style: ${_}`);f=p.length>0?f[_](...p):f[_]}return f}return templates=(h,u)=>{const d=[],f=[];let _=[];if(u.replace(e,(p,y,w,E,x,B)=>{if(y)_.push(s(y));else if(E){const P=_.join("");_=[],f.push(d.length===0?P:l(h,d)(P)),d.push({inverse:w,styles:c(E)})}else if(x){if(d.length===0)throw new Error("Found extraneous } in Chalk template literal");f.push(l(h,d)(_.join(""))),_=[],d.pop()}else _.push(B)}),f.push(_.join("")),d.length>0){const p=`Chalk template literal is missing ${d.length} closing bracket${d.length===1?"":"s"} (\`}\`)`;throw new Error(p)}return f.join("")},templates}const ansiStyles=ansiStylesExports,{stdout:stdoutColor,stderr:stderrColor}=browser$5,{stringReplaceAll,stringEncaseCRLFWithFirstIndex}=util$8,{isArray:isArray$4}=Array,levelMapping=["ansi","ansi","ansi256","ansi16m"],styles=Object.create(null),applyOptions=(e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=stdoutColor?stdoutColor.level:0;e.level=t.level===void 0?r:t.level};class ChalkClass{constructor(t){return chalkFactory(t)}}const chalkFactory=e=>{const t={};return applyOptions(t,e),t.template=(...r)=>chalkTag(t.template,...r),Object.setPrototypeOf(t,Chalk.prototype),Object.setPrototypeOf(t.template,t),t.template.constructor=()=>{throw new Error("`chalk.constructor()` is deprecated. Use `new chalk.Instance()` instead.")},t.template.Instance=ChalkClass,t.template};function Chalk(e){return chalkFactory(e)}for(const[e,t]of Object.entries(ansiStyles))styles[e]={get(){const r=createBuilder(this,createStyler(t.open,t.close,this._styler),this._isEmpty);return Object.defineProperty(this,e,{value:r}),r}};styles.visible={get(){const e=createBuilder(this,this._styler,!0);return Object.defineProperty(this,"visible",{value:e}),e}};const usedModels=["rgb","hex","keyword","hsl","hsv","hwb","ansi","ansi256"];for(const e of usedModels)styles[e]={get(){const{level:t}=this;return function(...r){const n=createStyler(ansiStyles.color[levelMapping[t]][e](...r),ansiStyles.color.close,this._styler);return createBuilder(this,n,this._isEmpty)}}};for(const e of usedModels){const t="bg"+e[0].toUpperCase()+e.slice(1);styles[t]={get(){const{level:r}=this;return function(...n){const o=createStyler(ansiStyles.bgColor[levelMapping[r]][e](...n),ansiStyles.bgColor.close,this._styler);return createBuilder(this,o,this._isEmpty)}}}}const proto$3=Object.defineProperties(()=>{},{...styles,level:{enumerable:!0,get(){return this._generator.level},set(e){this._generator.level=e}}}),createStyler=(e,t,r)=>{let n,o;return r===void 0?(n=e,o=t):(n=r.openAll+e,o=t+r.closeAll),{open:e,close:t,openAll:n,closeAll:o,parent:r}},createBuilder=(e,t,r)=>{const n=(...o)=>isArray$4(o[0])&&isArray$4(o[0].raw)?applyStyle(n,chalkTag(n,...o)):applyStyle(n,o.length===1?""+o[0]:o.join(" "));return Object.setPrototypeOf(n,proto$3),n._generator=e,n._styler=t,n._isEmpty=r,n},applyStyle=(e,t)=>{if(e.level<=0||!t)return e._isEmpty?"":t;let r=e._styler;if(r===void 0)return t;const{openAll:n,closeAll:o}=r;if(t.indexOf("\x1B")!==-1)for(;r!==void 0;)t=stringReplaceAll(t,r.close,r.open),r=r.parent;const s=t.indexOf(`
`);return s!==-1&&(t=stringEncaseCRLFWithFirstIndex(t,o,n,s)),n+t+o};let template;const chalkTag=(e,...t)=>{const[r]=t;if(!isArray$4(r)||!isArray$4(r.raw))return t.join(" ");const n=t.slice(1),o=[r.raw[0]];for(let s=1;s<r.length;s++)o.push(String(n[s-1]).replace(/[{}\\]/g,"\\$&"),String(r.raw[s]));return template===void 0&&(template=requireTemplates()),template(e,o.join(""))};Object.defineProperties(Chalk.prototype,styles);const chalk=Chalk();chalk.supportsColor=stdoutColor,chalk.stderr=Chalk({level:stderrColor?stderrColor.level:0}),chalk.stderr.supportsColor=stderrColor;var source=chalk;const chalk$1=getDefaultExportFromCjs(source);var lodash_defaultsdeep={exports:{}};lodash_defaultsdeep.exports,function(e,t){var r=200,n="__lodash_hash_undefined__",o=800,s=16,a=9007199254740991,c="[object Arguments]",l="[object Array]",h="[object AsyncFunction]",u="[object Boolean]",d="[object Date]",f="[object Error]",_="[object Function]",p="[object GeneratorFunction]",y="[object Map]",w="[object Number]",E="[object Null]",x="[object Object]",B="[object Proxy]",P="[object RegExp]",U="[object Set]",F="[object String]",G="[object Undefined]",H="[object WeakMap]",te="[object ArrayBuffer]",J="[object DataView]",le="[object Float32Array]",z="[object Float64Array]",q="[object Int8Array]",he="[object Int16Array]",V="[object Int32Array]",_e="[object Uint8Array]",ee="[object Uint8ClampedArray]",W="[object Uint16Array]",re="[object Uint32Array]",ne=/[\\^$.*+?()[\]{}|]/g,ge=/^\[object .+?Constructor\]$/,de=/^(?:0|[1-9]\d*)$/,ye={};ye[le]=ye[z]=ye[q]=ye[he]=ye[V]=ye[_e]=ye[ee]=ye[W]=ye[re]=!0,ye[c]=ye[l]=ye[te]=ye[u]=ye[J]=ye[d]=ye[f]=ye[_]=ye[y]=ye[w]=ye[x]=ye[P]=ye[U]=ye[F]=ye[H]=!1;var Ce=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,ke=typeof self=="object"&&self&&self.Object===Object&&self,ae=Ce||ke||Function("return this")(),Q=t&&!t.nodeType&&t,C=Q&&!0&&e&&!e.nodeType&&e,$=C&&C.exports===Q,j=$&&Ce.process,O=function(){try{var oe=C&&C.require&&C.require("util").types;return oe||j&&j.binding&&j.binding("util")}catch{}}(),k=O&&O.isTypedArray;function ue(oe,Ee,Te){switch(Te.length){case 0:return oe.call(Ee);case 1:return oe.call(Ee,Te[0]);case 2:return oe.call(Ee,Te[0],Te[1]);case 3:return oe.call(Ee,Te[0],Te[1],Te[2])}return oe.apply(Ee,Te)}function pe(oe,Ee){for(var Te=-1,He=Array(oe);++Te<oe;)He[Te]=Ee(Te);return He}function Oe(oe){return function(Ee){return oe(Ee)}}function Le(oe,Ee){return oe==null?void 0:oe[Ee]}function Me(oe,Ee){return function(Te){return oe(Ee(Te))}}var We=Array.prototype,Fe=Function.prototype,st=Object.prototype,ft=ae["__core-js_shared__"],rt=Fe.toString,lt=st.hasOwnProperty,At=function(){var oe=/[^.]+$/.exec(ft&&ft.keys&&ft.keys.IE_PROTO||"");return oe?"Symbol(src)_1."+oe:""}(),qe=st.toString,Je=rt.call(Object),g=RegExp("^"+rt.call(lt).replace(ne,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=$?ae.Buffer:void 0,T=ae.Symbol,ce=ae.Uint8Array;b&&b.allocUnsafe;var fe=Me(Object.getPrototypeOf,Object),ve=Object.create,Ne=st.propertyIsEnumerable,tt=We.splice,ct=T?T.toStringTag:void 0,ot=function(){try{var oe=ze(Object,"defineProperty");return oe({},"",{}),oe}catch{}}(),it=b?b.isBuffer:void 0,ut=Math.max,dr=Date.now,tr=ze(ae,"Map"),ir=ze(Object,"create"),Wr=function(){function oe(){}return function(Ee){if(!St(Ee))return{};if(ve)return ve(Ee);oe.prototype=Ee;var Te=new oe;return oe.prototype=void 0,Te}}();function qt(oe){var Ee=-1,Te=oe==null?0:oe.length;for(this.clear();++Ee<Te;){var He=oe[Ee];this.set(He[0],He[1])}}function fr(){this.__data__=ir?ir(null):{},this.size=0}function pr(oe){var Ee=this.has(oe)&&delete this.__data__[oe];return this.size-=Ee?1:0,Ee}function Qt(oe){var Ee=this.__data__;if(ir){var Te=Ee[oe];return Te===n?void 0:Te}return lt.call(Ee,oe)?Ee[oe]:void 0}function Nr(oe){var Ee=this.__data__;return ir?Ee[oe]!==void 0:lt.call(Ee,oe)}function Ar(oe,Ee){var Te=this.__data__;return this.size+=this.has(oe)?0:1,Te[oe]=ir&&Ee===void 0?n:Ee,this}qt.prototype.clear=fr,qt.prototype.delete=pr,qt.prototype.get=Qt,qt.prototype.has=Nr,qt.prototype.set=Ar;function jt(oe){var Ee=-1,Te=oe==null?0:oe.length;for(this.clear();++Ee<Te;){var He=oe[Ee];this.set(He[0],He[1])}}function Jr(){this.__data__=[],this.size=0}function Xr(oe){var Ee=this.__data__,Te=lr(Ee,oe);if(Te<0)return!1;var He=Ee.length-1;return Te==He?Ee.pop():tt.call(Ee,Te,1),--this.size,!0}function Ut(oe){var Ee=this.__data__,Te=lr(Ee,oe);return Te<0?void 0:Ee[Te][1]}function Zr(oe){return lr(this.__data__,oe)>-1}function Dr(oe,Ee){var Te=this.__data__,He=lr(Te,oe);return He<0?(++this.size,Te.push([oe,Ee])):Te[He][1]=Ee,this}jt.prototype.clear=Jr,jt.prototype.delete=Xr,jt.prototype.get=Ut,jt.prototype.has=Zr,jt.prototype.set=Dr;function Yt(oe){var Ee=-1,Te=oe==null?0:oe.length;for(this.clear();++Ee<Te;){var He=oe[Ee];this.set(He[0],He[1])}}function _r(){this.size=0,this.__data__={hash:new qt,map:new(tr||jt),string:new qt}}function en(oe){var Ee=Ye(this,oe).delete(oe);return this.size-=Ee?1:0,Ee}function Gt(oe){return Ye(this,oe).get(oe)}function tn(oe){return Ye(this,oe).has(oe)}function rn(oe,Ee){var Te=Ye(this,oe),He=Te.size;return Te.set(oe,Ee),this.size+=Te.size==He?0:1,this}Yt.prototype.clear=_r,Yt.prototype.delete=en,Yt.prototype.get=Gt,Yt.prototype.has=tn,Yt.prototype.set=rn;function rr(oe){var Ee=this.__data__=new jt(oe);this.size=Ee.size}function sr(){this.__data__=new jt,this.size=0}function nn(oe){var Ee=this.__data__,Te=Ee.delete(oe);return this.size=Ee.size,Te}function gr(oe){return this.__data__.get(oe)}function sn(oe){return this.__data__.has(oe)}function an(oe,Ee){var Te=this.__data__;if(Te instanceof jt){var He=Te.__data__;if(!tr||He.length<r-1)return He.push([oe,Ee]),this.size=++Te.size,this;Te=this.__data__=new Yt(He)}return Te.set(oe,Ee),this.size=Te.size,this}rr.prototype.clear=sr,rr.prototype.delete=nn,rr.prototype.get=gr,rr.prototype.has=sn,rr.prototype.set=an;function Ht(oe,Ee){var Te=De(oe),He=!Te&&be(oe),et=!Te&&!He&&gt(oe),Ze=!Te&&!He&&!et&&Ot(oe),nt=Te||He||et||Ze,pt=nt?pe(oe.length,String):[],bt=pt.length;for(var Nt in oe)nt&&(Nt=="length"||et&&(Nt=="offset"||Nt=="parent")||Ze&&(Nt=="buffer"||Nt=="byteLength"||Nt=="byteOffset")||_t(Nt,bt))||pt.push(Nt);return pt}function nr(oe,Ee,Te){(Te!==void 0&&!Ge(oe[Ee],Te)||Te===void 0&&!(Ee in oe))&&ar(oe,Ee,Te)}function cn(oe,Ee,Te){var He=oe[Ee];(!(lt.call(oe,Ee)&&Ge(He,Te))||Te===void 0&&!(Ee in oe))&&ar(oe,Ee,Te)}function lr(oe,Ee){for(var Te=oe.length;Te--;)if(Ge(oe[Te][0],Ee))return Te;return-1}function ar(oe,Ee,Te){Ee=="__proto__"&&ot?ot(oe,Ee,{configurable:!0,enumerable:!0,value:Te,writable:!0}):oe[Ee]=Te}var qr=Ke();function Wt(oe){return oe==null?oe===void 0?G:E:ct&&ct in Object(oe)?Ve(oe):mr(oe)}function Jt(oe){return wt(oe)&&Wt(oe)==c}function xr(oe){if(!St(oe)||Rt(oe))return!1;var Ee=at(oe)?g:ge;return Ee.test(je(oe))}function wr(oe){return wt(oe)&&mt(oe.length)&&!!ye[Wt(oe)]}function hr(oe){if(!St(oe))return Vt(oe);var Ee=It(oe),Te=[];for(var He in oe)He=="constructor"&&(Ee||!lt.call(oe,He))||Te.push(He);return Te}function $r(oe,Ee,Te,He,et){oe!==Ee&&qr(Ee,function(Ze,nt){if(et||(et=new rr),St(Ze))Pr(oe,Ee,nt,Te,$r,He,et);else{var pt=He?He(br(oe,nt),Ze,nt+"",oe,Ee,et):void 0;pt===void 0&&(pt=Ze),nr(oe,nt,pt)}},Ft)}function Pr(oe,Ee,Te,He,et,Ze,nt){var pt=br(oe,Te),bt=br(Ee,Te),Nt=nt.get(bt);if(Nt){nr(oe,Te,Nt);return}var Pt=Ze?Ze(pt,bt,Te+"",oe,Ee,nt):void 0,Xt=Pt===void 0;if(Xt){var Er=De(bt),Br=!Er&&gt(bt),yn=!Er&&!Br&&Ot(bt);Pt=bt,Er||Br||yn?De(pt)?Pt=pt:Xe(pt)?Pt=Pe(pt):Br?(Xt=!1,Pt=me(bt)):yn?(Xt=!1,Pt=Ie(bt)):Pt=[]:xt(bt)||be(bt)?(Pt=pt,be(pt)?Pt=Mt(pt):(!St(pt)||at(pt))&&(Pt=ht(bt))):Xt=!1}Xt&&(nt.set(bt,Pt),et(Pt,bt,He,Ze,nt),nt.delete(bt)),nr(oe,Te,Pt)}function Hr(oe,Ee){return Tr(zt(oe,Ee,se),oe+"")}var Qr=ot?function(oe,Ee){return ot(oe,"toString",{configurable:!0,enumerable:!1,value:we(Ee),writable:!0})}:se;function me(oe,Ee){return oe.slice()}function xe(oe){var Ee=new oe.constructor(oe.byteLength);return new ce(Ee).set(new ce(oe)),Ee}function Ie(oe,Ee){var Te=xe(oe.buffer);return new oe.constructor(Te,oe.byteOffset,oe.length)}function Pe(oe,Ee){var Te=-1,He=oe.length;for(Ee||(Ee=Array(He));++Te<He;)Ee[Te]=oe[Te];return Ee}function Re(oe,Ee,Te,He){var et=!Te;Te||(Te={});for(var Ze=-1,nt=Ee.length;++Ze<nt;){var pt=Ee[Ze],bt=void 0;bt===void 0&&(bt=oe[pt]),et?ar(Te,pt,bt):cn(Te,pt,bt)}return Te}function Be(oe){return Hr(function(Ee,Te){var He=-1,et=Te.length,Ze=et>1?Te[et-1]:void 0,nt=et>2?Te[2]:void 0;for(Ze=oe.length>3&&typeof Ze=="function"?(et--,Ze):void 0,nt&&Tt(Te[0],Te[1],nt)&&(Ze=et<3?void 0:Ze,et=1),Ee=Object(Ee);++He<et;){var pt=Te[He];pt&&oe(Ee,pt,He,Ze)}return Ee})}function Ke(oe){return function(Ee,Te,He){for(var et=-1,Ze=Object(Ee),nt=He(Ee),pt=nt.length;pt--;){var bt=nt[++et];if(Te(Ze[bt],bt,Ze)===!1)break}return Ee}}function Qe(oe,Ee,Te,He,et,Ze){return St(oe)&&St(Ee)&&(Ze.set(Ee,oe),$r(oe,Ee,void 0,Qe,Ze),Ze.delete(Ee)),oe}function Ye(oe,Ee){var Te=oe.__data__;return Ct(Ee)?Te[typeof Ee=="string"?"string":"hash"]:Te.map}function ze(oe,Ee){var Te=Le(oe,Ee);return xr(Te)?Te:void 0}function Ve(oe){var Ee=lt.call(oe,ct),Te=oe[ct];try{oe[ct]=void 0;var He=!0}catch{}var et=qe.call(oe);return He&&(Ee?oe[ct]=Te:delete oe[ct]),et}function ht(oe){return typeof oe.constructor=="function"&&!It(oe)?Wr(fe(oe)):{}}function _t(oe,Ee){var Te=typeof oe;return Ee=Ee??a,!!Ee&&(Te=="number"||Te!="symbol"&&de.test(oe))&&oe>-1&&oe%1==0&&oe<Ee}function Tt(oe,Ee,Te){if(!St(Te))return!1;var He=typeof Ee;return(He=="number"?Ue(Te)&&_t(Ee,Te.length):He=="string"&&Ee in Te)?Ge(Te[Ee],oe):!1}function Ct(oe){var Ee=typeof oe;return Ee=="string"||Ee=="number"||Ee=="symbol"||Ee=="boolean"?oe!=="__proto__":oe===null}function Rt(oe){return!!At&&At in oe}function It(oe){var Ee=oe&&oe.constructor,Te=typeof Ee=="function"&&Ee.prototype||st;return oe===Te}function Vt(oe){var Ee=[];if(oe!=null)for(var Te in Object(oe))Ee.push(Te);return Ee}function mr(oe){return qe.call(oe)}function zt(oe,Ee,Te){return Ee=ut(Ee===void 0?oe.length-1:Ee,0),function(){for(var He=arguments,et=-1,Ze=ut(He.length-Ee,0),nt=Array(Ze);++et<Ze;)nt[et]=He[Ee+et];et=-1;for(var pt=Array(Ee+1);++et<Ee;)pt[et]=He[et];return pt[Ee]=Te(nt),ue(oe,this,pt)}}function br(oe,Ee){if(!(Ee==="constructor"&&typeof oe[Ee]=="function")&&Ee!="__proto__")return oe[Ee]}var Tr=$e(Qr);function $e(oe){var Ee=0,Te=0;return function(){var He=dr(),et=s-(He-Te);if(Te=He,et>0){if(++Ee>=o)return arguments[0]}else Ee=0;return oe.apply(void 0,arguments)}}function je(oe){if(oe!=null){try{return rt.call(oe)}catch{}try{return oe+""}catch{}}return""}function Ge(oe,Ee){return oe===Ee||oe!==oe&&Ee!==Ee}var be=Jt(function(){return arguments}())?Jt:function(oe){return wt(oe)&&lt.call(oe,"callee")&&!Ne.call(oe,"callee")},De=Array.isArray;function Ue(oe){return oe!=null&&mt(oe.length)&&!at(oe)}function Xe(oe){return wt(oe)&&Ue(oe)}var gt=it||Se;function at(oe){if(!St(oe))return!1;var Ee=Wt(oe);return Ee==_||Ee==p||Ee==h||Ee==B}function mt(oe){return typeof oe=="number"&&oe>-1&&oe%1==0&&oe<=a}function St(oe){var Ee=typeof oe;return oe!=null&&(Ee=="object"||Ee=="function")}function wt(oe){return oe!=null&&typeof oe=="object"}function xt(oe){if(!wt(oe)||Wt(oe)!=x)return!1;var Ee=fe(oe);if(Ee===null)return!0;var Te=lt.call(Ee,"constructor")&&Ee.constructor;return typeof Te=="function"&&Te instanceof Te&&rt.call(Te)==Je}var Ot=k?Oe(k):wr;function Mt(oe){return Re(oe,Ft(oe))}var Dt=Hr(function(oe){return oe.push(void 0,Qe),ue(Kt,void 0,oe)});function Ft(oe){return Ue(oe)?Ht(oe):hr(oe)}var Kt=Be(function(oe,Ee,Te,He){$r(oe,Ee,Te,He)});function we(oe){return function(){return oe}}function se(oe){return oe}function Se(){return!1}e.exports=Dt}(lodash_defaultsdeep,lodash_defaultsdeep.exports);var lodash_defaultsdeepExports=lodash_defaultsdeep.exports;const defaultsDeep=getDefaultExportFromCjs(lodash_defaultsdeepExports);let import_buffer,export_Buffer,InvariantViolation,getRelativeFilename$1,failedInvariant,require_events,import_events,events_default,export_EventEmitter,ErrorStream,raise$1,SnoopLevel;import_buffer=__toESM$2(require_buffer()),export_Buffer=import_buffer.Buffer,invariant$1=(e,t,r)=>{if(e)return;if(t!=null&&t.startsWith("BUG"))debugger;let n="invariant violation";throw t&&(n+=`: ${t}`),r!=null&&r.A&&(n+=` [${r.A[0]}]`),r!=null&&r.F&&(n+=` at ${getRelativeFilename$1(r.F)}:${r.L}`),new InvariantViolation(n)},InvariantViolation=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}},getRelativeFilename$1=e=>{const t=e.match(/.+\/(packages\/.+\/.+)/);if(t){const[,r]=t;return r}return e},failedInvariant=(e,t,r)=>{let n="invariant violation";const o=[e,t].filter(s=>typeof s=="string").join(" ");throw o&&(n+=`: ${o}`),new InvariantViolation(n)},require_events=__commonJS$2({"node_modules/.pnpm/events@3.3.0/node_modules/events/events.js"(e,t){var r=typeof Reflect=="object"?Reflect:null,n=r&&typeof r.apply=="function"?r.apply:function(F,G,H){return Function.prototype.apply.call(F,G,H)},o;r&&typeof r.ownKeys=="function"?o=r.ownKeys:Object.getOwnPropertySymbols?o=function(F){return Object.getOwnPropertyNames(F).concat(Object.getOwnPropertySymbols(F))}:o=function(F){return Object.getOwnPropertyNames(F)};function s(F){console&&console.warn&&console.warn(F)}var a=Number.isNaN||function(F){return F!==F};function c(){c.init.call(this)}t.exports=c,t.exports.once=B,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var l=10;function h(F){if(typeof F!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof F)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(F){if(typeof F!="number"||F<0||a(F))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+F+".");l=F}}),c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(F){if(typeof F!="number"||F<0||a(F))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+F+".");return this._maxListeners=F,this};function u(F){return F._maxListeners===void 0?c.defaultMaxListeners:F._maxListeners}c.prototype.getMaxListeners=function(){return u(this)},c.prototype.emit=function(F){for(var G=[],H=1;H<arguments.length;H++)G.push(arguments[H]);var te=F==="error",J=this._events;if(J!==void 0)te=te&&J.error===void 0;else if(!te)return!1;if(te){var le;if(G.length>0&&(le=G[0]),le instanceof Error)throw le;var z=new Error("Unhandled error."+(le?" ("+le.message+")":""));throw z.context=le,z}var q=J[F];if(q===void 0)return!1;if(typeof q=="function")n(q,this,G);else for(var he=q.length,V=w(q,he),H=0;H<he;++H)n(V[H],this,G);return!0};function d(F,G,H,te){var J,le,z;if(h(H),le=F._events,le===void 0?(le=F._events=Object.create(null),F._eventsCount=0):(le.newListener!==void 0&&(F.emit("newListener",G,H.listener?H.listener:H),le=F._events),z=le[G]),z===void 0)z=le[G]=H,++F._eventsCount;else if(typeof z=="function"?z=le[G]=te?[H,z]:[z,H]:te?z.unshift(H):z.push(H),J=u(F),J>0&&z.length>J&&!z.warned){z.warned=!0;var q=new Error("Possible EventEmitter memory leak detected. "+z.length+" "+String(G)+" listeners added. Use emitter.setMaxListeners() to increase limit");q.name="MaxListenersExceededWarning",q.emitter=F,q.type=G,q.count=z.length,s(q)}return F}c.prototype.addListener=function(F,G){return d(this,F,G,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(F,G){return d(this,F,G,!0)};function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _(F,G,H){var te={fired:!1,wrapFn:void 0,target:F,type:G,listener:H},J=f.bind(te);return J.listener=H,te.wrapFn=J,J}c.prototype.once=function(F,G){return h(G),this.on(F,_(this,F,G)),this},c.prototype.prependOnceListener=function(F,G){return h(G),this.prependListener(F,_(this,F,G)),this},c.prototype.removeListener=function(F,G){var H,te,J,le,z;if(h(G),te=this._events,te===void 0)return this;if(H=te[F],H===void 0)return this;if(H===G||H.listener===G)--this._eventsCount===0?this._events=Object.create(null):(delete te[F],te.removeListener&&this.emit("removeListener",F,H.listener||G));else if(typeof H!="function"){for(J=-1,le=H.length-1;le>=0;le--)if(H[le]===G||H[le].listener===G){z=H[le].listener,J=le;break}if(J<0)return this;J===0?H.shift():E(H,J),H.length===1&&(te[F]=H[0]),te.removeListener!==void 0&&this.emit("removeListener",F,z||G)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(F){var G,H,te;if(H=this._events,H===void 0)return this;if(H.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):H[F]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete H[F]),this;if(arguments.length===0){var J=Object.keys(H),le;for(te=0;te<J.length;++te)le=J[te],le!=="removeListener"&&this.removeAllListeners(le);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(G=H[F],typeof G=="function")this.removeListener(F,G);else if(G!==void 0)for(te=G.length-1;te>=0;te--)this.removeListener(F,G[te]);return this};function p(F,G,H){var te=F._events;if(te===void 0)return[];var J=te[G];return J===void 0?[]:typeof J=="function"?H?[J.listener||J]:[J]:H?x(J):w(J,J.length)}c.prototype.listeners=function(F){return p(this,F,!0)},c.prototype.rawListeners=function(F){return p(this,F,!1)},c.listenerCount=function(F,G){return typeof F.listenerCount=="function"?F.listenerCount(G):y.call(F,G)},c.prototype.listenerCount=y;function y(F){var G=this._events;if(G!==void 0){var H=G[F];if(typeof H=="function")return 1;if(H!==void 0)return H.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?o(this._events):[]};function w(F,G){for(var H=new Array(G),te=0;te<G;++te)H[te]=F[te];return H}function E(F,G){for(;G+1<F.length;G++)F[G]=F[G+1];F.pop()}function x(F){for(var G=new Array(F.length),H=0;H<G.length;++H)G[H]=F[H].listener||F[H];return G}function B(F,G){return new Promise(function(H,te){function J(z){F.removeListener(G,le),te(z)}function le(){typeof F.removeListener=="function"&&F.removeListener("error",J),H([].slice.call(arguments))}U(F,G,le,{once:!0}),G!=="error"&&P(F,J,{once:!0})})}function P(F,G,H){typeof F.on=="function"&&U(F,"error",G,H)}function U(F,G,H,te){if(typeof F.on=="function")te.once?F.once(G,H):F.on(G,H);else if(typeof F.addEventListener=="function")F.addEventListener(G,function J(le){te.once&&F.removeEventListener(G,J),H(le)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof F)}}}),import_events=__toESM$2(require_events()),events_default={EventEmitter:import_events.EventEmitter},export_EventEmitter=import_events.EventEmitter,ErrorStream=class{constructor(){this._unhandledErrors=0}assertNoUnhandledErrors(){if(this._unhandledErrors>0)throw new Error(`Assertion failed: expected no unhandled errors to be thrown, but ${this._unhandledErrors} were thrown.`)}raise(e){this._handler?this._handler(e):this._unhandledError(e)}handle(e){this._handler=e}pipeTo(e){this.handle(t=>e.raise(t))}_unhandledError(e){this._unhandledErrors++,setTimeout(()=>{throw e})}},failUndefined=()=>{throw new Error("Required value was null or undefined.")},inspectObject=e=>{const t=Object.getPrototypeOf(e).constructor.name;return e.toJSON?`${t}(${export_inspect(e.toJSON())})`:String(e)},raise$1=e=>{throw e},function(e){e[e.DEFAULT=0]="DEFAULT",e[e.VERBOSE=1]="VERBOSE",e[e.BOLD=2]="BOLD"}(SnoopLevel||(SnoopLevel={}));var StackTrace=class{constructor(){this._stack=new Error}getStack(e=0){return this._stack.stack.split(`
`).slice(e+2).join(`
`)}},truncateKey$1=(e,t=8)=>{const r=String(e);return r.length<=t?r:r.slice(0,t)},warnAfterTimeout=async(e,t,r)=>{const n=new StackTrace,o=setTimeout(()=>{console.warn(`Action \`${t}\` is taking more then ${e.toLocaleString()}ms to complete. This might be a bug.
${n.getStack()}`)},e);try{return await r()}finally{clearTimeout(o)}};function timed(e){return(t,r,n)=>{const o=n.value;n.value=function(...s){return warnAfterTimeout(e,`${t.constructor.name}.${r}`,()=>o.apply(this,s))}}}let devtoolsFormatter,register;todo=e=>{throw new Error(e??"Not implemented.")},devtoolsFormatter=Symbol.for("devtoolsFormatter"),register=()=>{typeof window<"u"&&(window.devtoolsFormatters??(window.devtoolsFormatters=[])).push({header:(e,t)=>{const r=e[devtoolsFormatter];if(r===void 0)return null;if(typeof r!="object"||r===null||typeof r.header!="function")throw new Error(`Invalid devtools formatter for ${e.constructor.name}`);return r.header(t)},hasBody:(e,t)=>{const r=e[devtoolsFormatter];return!r||!r.hasBody?!1:r.hasBody(t)},body:(e,t)=>{const r=e[devtoolsFormatter];return!r||!r.body?null:r.body(t)}})},register();let equalsSymbol,isEquatable,isEqual$1,loadashEqualityFn,exposeModule,EXPOSED_MODULES,__require$1,__dxlog_file$y,PUBLIC_KEY_LENGTH,SECRET_KEY_LENGTH,randomBytes$2,__dxlog_file$x,assignDeep,getDeep,createBinder,__dxlog_file2$l,BitField,__dxlog_file3$i,Callback,MAX_SERIALIZATION_LENGTH,ComplexMap,deferFunction,entry,MapEntry,DEFAULT_WORDLIST,HumanHasher,hasher,humanize,exponentialBackoffInterval,arrayToBuffer,bufferToArray,MAX_DEPTH,LOG_MAX_DEPTH,jsonify$1,jsonlogify,jsonKeyReplacer,defaultMap,isNode,range$1,rangeFromTo,accessBy,median,numericalValues,instanceTag,safeInstanceof,Tracer,tracer,nonNullable,isNotNullOrUndefined,symbol$2,instanceContexts,getPrototypeSpecificInstanceId,getDebugName,forEachAsync,mapValues$1,deepMapValues,DeepMapper;equalsSymbol=Symbol.for("dxos.common.equals"),isEquatable=e=>typeof e=="object"&&e!==null&&typeof e[equalsSymbol]=="function",isEqual$1=(e,t)=>e[equalsSymbol](t),loadashEqualityFn=(e,t)=>{if(isEquatable(e))return isEqual$1(e,t)},exposeModule=(e,t)=>{EXPOSED_MODULES[e]=t},importModule=e=>{if(EXPOSED_MODULES[e])return EXPOSED_MODULES[e];throw new Error(`Module ${e} is not exposed.`)},EXPOSED_MODULES={},__require$1=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')}),__dxlog_file$y="/home/runner/work/dxos/dxos/packages/common/keys/src/public-key.ts",PUBLIC_KEY_LENGTH=32,SECRET_KEY_LENGTH=64,PublicKey=class Sr{static from(t){if(invariant$1(t,void 0,{F:__dxlog_file$y,L:30,S:this,A:["source",""]}),t instanceof Sr)return t;if(t instanceof Buffer)return new Sr(new Uint8Array(t.buffer,t.byteOffset,t.byteLength));if(t instanceof Uint8Array)return new Sr(t);if(t instanceof ArrayBuffer)return new Sr(new Uint8Array(t));if(typeof t=="string")return Sr.fromHex(t);if(t.asUint8Array)return new Sr(t.asUint8Array());throw new TypeError(`Unable to create PublicKey from ${t}`)}static safeFrom(t){if(t)try{return Sr.from(t)}catch{return}}static fromHex(t){t.startsWith("0x")&&(t=t.slice(2));const r=Buffer.from(t,"hex");return new Sr(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}static random(){return Sr.from(randomBytes$2(PUBLIC_KEY_LENGTH))}static*randomSequence(){for(let t=0;t<1e4;t++)yield Sr.random();throw new Error("Too many keys requested")}static isPublicKey(t){return t instanceof Sr}static assertValidPublicKey(t){if(!this.isPublicKey(t))throw new TypeError("Invalid PublicKey")}static equals(t,r){return Sr.from(t).equals(r)}static bufferize(t){return invariant$1(typeof t=="string","Invalid type",{F:__dxlog_file$y,L:129,S:this,A:["typeof str === 'string'","'Invalid type'"]}),Buffer.from(t,"hex")}static stringify(t){return t instanceof Sr?t=t.asBuffer():t instanceof Uint8Array&&(t=Buffer.from(t.buffer,t.byteOffset,t.byteLength)),invariant$1(t instanceof Buffer,"Invalid type",{F:__dxlog_file$y,L:148,S:this,A:["key instanceof Buffer","'Invalid type'"]}),t.toString("hex")}static hash(t){return t.toHex()}constructor(t){if(this._value=t,!(t instanceof Uint8Array))throw new TypeError(`Expected Uint8Array, got: ${t}`)}toString(){return this.toHex()}toJSON(){return this.toHex()}toJSONL(){return this.truncate()}get length(){return this._value.length}toHex(){return this.asBuffer().toString("hex")}truncate(t=void 0){return truncateKey$1(this,t)}asBuffer(){return Buffer.from(this._value.buffer,this._value.byteOffset,this._value.byteLength)}asUint8Array(){return this._value}getInsecureHash(t){return Math.abs(this._value.reduce((r,n)=>r^n|0,0))%t}[export_inspect.custom](t,r){if(!r.colors||typeof process.stdout.hasColors!="function"||!process.stdout.hasColors())return`<PublicKey ${this.truncate()}>`;const n=a=>`\x1B[${a}m`,o=["red","green","yellow","blue","magenta","cyan","redBright","greenBright","yellowBright","blueBright","magentaBright","cyanBright","whiteBright"],s=o[this.getInsecureHash(o.length)];return`PublicKey(${n(export_inspect.colors[s][0])}${this.truncate()}${n(export_inspect.colors.reset[0])})`}get[devtoolsFormatter](){return{header:()=>{const t=["darkred","green","orange","blue","darkmagenta","darkcyan","red","green","orange","blue","magenta","darkcyan","black"],r=t[this.getInsecureHash(t.length)];return["span",{},["span",{},"PublicKey("],["span",{style:`color: ${r};`},this.truncate()],["span",{},")"]]}}}equals(t){const r=Sr.from(t);if(this._value.length!==r._value.length)return!1;let n=!0;for(let o=0;o<this._value.length;o++)n&&(n=this._value[o]===r._value[o]);return n}[equalsSymbol](t){return Sr.isPublicKey(t)?this.equals(t):!1}},randomBytes$2=e=>{const t=globalThis.crypto??__require$1("@dxos/node-std/crypto").webcrypto,r=new Uint8Array(e);return t.getRandomValues(r),r},__dxlog_file$x="/home/runner/work/dxos/dxos/packages/common/util/src/assign.ts",assignDeep=(e,t,r)=>{invariant$1(t.length>0,void 0,{F:__dxlog_file$x,L:12,S:void 0,A:["path.length > 0",""]});let n=e;for(const o of t.slice(0,-1))n[o]??(n[o]={}),n=n[o];return n[t.at(-1)]=r,n[t.at(-1)]},getDeep=(e,t)=>{let r=e;for(const n of t)r=r==null?void 0:r[n];return r},createBinder=e=>({fn:t=>t.bind(e),async:t=>util_default.promisify(t.bind(e))}),__dxlog_file2$l="/home/runner/work/dxos/dxos/packages/common/util/src/bitfield.ts",BitField=class qs{static get(t,r){return!!(t[r>>3]>>7-r%8&1)}static set(t,r,n){n?t[r>>3]=t[r>>3]|1<<7-r%8:t[r>>3]=t[r>>3]&~(1<<7-r%8)}static count(t,r,n){let o=0;for(let s=r;s<n;s++){const a=t[s>>3]>>7-s%8&1;o+=a}return o}static invert(t){const r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=~t[n];return r}static and(t,r){invariant$1(t.length===r.length,"Bitfields must be of the same length",{F:__dxlog_file2$l,L:52,S:this,A:["first.length === second.length","'Bitfields must be of the same length'"]});const n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t[o]&r[o];return n}static findIndexes(t,r={}){const{start:n=0,end:o=t.length*8,value:s=!0}=r,a=[];for(let c=n;c<o;c++)qs.get(t,c)===s&&a.push(c);return a}static ones(t){const r=new Uint8Array(Math.ceil(Math.ceil(t)/8)).fill(255),n=Math.ceil(t%8);return r[r.length-1]=255<<8-n,r}static zeros(t){return new Uint8Array(Math.ceil(Math.ceil(t)/8)).fill(0)}},__dxlog_file3$i="/home/runner/work/dxos/dxos/packages/common/util/src/callback.ts",Callback=class{call(...e){return invariant$1(this._callback,"Callback not set",{F:__dxlog_file3$i,L:20,S:this,A:["this._callback","'Callback not set'"]}),this._callback(...e)}callIfSet(...e){var t;return(t=this._callback)==null?void 0:t.call(this,...e)}set(e){invariant$1(!this._callback,"Callback already set",{F:__dxlog_file3$i,L:29,S:this,A:["!this._callback","'Callback already set'"]}),this._callback=e}isSet(){return!!this._callback}},MAX_SERIALIZATION_LENGTH=10,ComplexSet=class{constructor(e,t){if(this._projection=e,this._values=new Map,t)for(const r of t)this.add(r)}toString(){return inspectObject(this)}toJSON(){return this._values.size>MAX_SERIALIZATION_LENGTH?{size:this._values.size}:Array.from(this._values.values())}[export_inspect.custom](){return inspectObject(this)}add(e){return this._values.set(this._projection(e),e),this}clear(){this._values.clear()}delete(e){return this._values.delete(this._projection(e))}forEach(e,t){t&&(e=e.bind(t)),this._values.forEach(r=>e(r,r,this))}has(e){return this._values.has(this._projection(e))}get size(){return this._values.size}[Symbol.iterator](){return this._values.values()}*entries(){for(const e of this._values.values())yield[e,e]}keys(){return this[Symbol.iterator]()}values(){return this[Symbol.iterator]()}get[Symbol.toStringTag](){return"ComplexSet"}},ComplexMap=class Hs{constructor(t,r){if(this._keyProjection=t,this._keys=new Map,this._values=new Map,r)for(const[n,o]of r)this.set(n,o)}toString(){return inspectObject(this)}toJSON(){return this._values.size>MAX_SERIALIZATION_LENGTH?{size:this._values.size}:Array.from(this._values.values())}[export_inspect.custom](){return inspectObject(this)}clear(){this._keys.clear(),this._values.clear()}delete(t){const r=this._keys.delete(this._keyProjection(t)),n=this._values.delete(this._keyProjection(t));return r||n}forEach(t,r){r&&(t=t.bind(r)),this._keys.forEach((n,o)=>t(this._values.get(o)??raise$1(new Error("Map corrupted.")),n,this))}get(t){return this._values.get(this._keyProjection(t))}has(t){return this._keys.has(this._keyProjection(t))}set(t,r){const n=this._keyProjection(t);return this._keys.set(n,t),this._values.set(n,r),this}get size(){return this._keys.size}*[Symbol.iterator](){for(const[t,r]of this._keys){const n=this._values.get(t)??raise$1(new Error("Map corrupted."));yield[r,n]}}entries(){return this[Symbol.iterator]()}keys(){return this._keys.values()}values(){return this._values.values()}mapValues(t){return new Hs(this._keyProjection,[...this.entries()].map(([r,n])=>[r,t(n,r)]))}get[Symbol.toStringTag](){return"ComplexMap"}},deferFunction=e=>(...t)=>e()(...t),entry=(e,t)=>new MapEntry(e,t),MapEntry=class{constructor(e,t){this._map=e,this._key=t}get key(){return this._key}get value(){return this._map.get(this._key)}orInsert(e){return this._map.has(this._key)||this._map.set(this._key,e),this}deep(e){return entry(this.value,e)}},DEFAULT_WORDLIST=["ack","alabama","alanine","alaska","alpha","angel","apart","april","arizona","arkansas","artist","asparagus","aspen","august","autumn","avocado","bacon","bakerloo","batman","beer","berlin","beryllium","black","blossom","blue","bluebird","bravo","bulldog","burger","butter","california","carbon","cardinal","carolina","carpet","cat","ceiling","charlie","chicken","coffee","cola","cold","colorado","comet","connecticut","crazy","cup","dakota","december","delaware","delta","diet","don","double","early","earth","east","echo","edward","eight","eighteen","eleven","emma","enemy","equal","failed","fanta","fifteen","fillet","finch","fish","five","fix","floor","florida","football","four","fourteen","foxtrot","freddie","friend","fruit","gee","georgia","glucose","golf","green","grey","hamper","happy","harry","hawaii","helium","high","hot","hotel","hydrogen","idaho","illinois","india","indigo","ink","iowa","island","item","jersey","jig","johnny","juliet","july","jupiter","kansas","kentucky","kilo","king","kitten","lactose","lake","lamp","lemon","leopard","lima","lion","lithium","london","louisiana","low","magazine","magnesium","maine","mango","march","mars","maryland","massachusetts","may","mexico","michigan","mike","minnesota","mirror","mississippi","missouri","mobile","mockingbird","monkey","montana","moon","mountain","muppet","music","nebraska","neptune","network","nevada","nine","nineteen","nitrogen","north","november","nuts","october","ohio","oklahoma","one","orange","oranges","oregon","oscar","oven","oxygen","papa","paris","pasta","pennsylvania","pip","pizza","pluto","potato","princess","purple","quebec","queen","quiet","red","river","robert","robin","romeo","rugby","sad","salami","saturn","september","seven","seventeen","shade","sierra","single","sink","six","sixteen","skylark","snake","social","sodium","solar","south","spaghetti","speaker","spring","stairway","steak","stream","summer","sweet","table","tango","ten","tennessee","tennis","texas","thirteen","three","timing","triple","twelve","twenty","two","uncle","undress","uniform","uranus","utah","vegan","venus","vermont","victor","video","violet","virginia","washington","west","whiskey","white","william","winner","winter","wisconsin","wolfram","wyoming","xray","yankee","yellow","zebra","zulu"],HumanHasher=class{constructor(e=DEFAULT_WORDLIST){if(this.wordlist=e,e.length!==256)throw new Error("Wordlist must have exactly 256 items");this.wordlist=e}humanize(e,t=4,r="-"){const n=e.match(/(..?)/g);if(!n)throw new Error("");const o=n.map(s=>parseInt(s,16));return this._compress(o,t).map(s=>this.wordlist[s]).join(r)}_compress(e,t){const r=e.length;if(t>r)throw new Error("Fewer input bytes than requested output");const n=r/t>>0,o=[];for(let s=0;s<n*t;s+=n)o.push(e.slice(s,s+n));return o[o.length-1]=o[o.length-1].concat(e.slice(t*n)),o.map(s=>s.reduce((a,c)=>a^c))}},hasher=new HumanHasher,humanize=e=>(e instanceof export_Buffer||e instanceof Uint8Array||e instanceof ArrayBuffer?e=PublicKey.stringify(e):e instanceof PublicKey&&(e=e.toHex()),hasher.humanize(e)),exponentialBackoffInterval=(e,t)=>{let r=t;const n=()=>{e(),r*=2,o=setTimeout(n,r)};let o=setTimeout(n,r);return()=>clearTimeout(o)},arrayToBuffer=e=>export_Buffer.from(e.buffer,e.byteOffset,e.byteLength),bufferToArray=e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),MAX_DEPTH=5,LOG_MAX_DEPTH=7,jsonify$1=(e,t=0,r=new WeakSet)=>{if(t>MAX_DEPTH||typeof e=="function")return null;if(typeof e=="object"&&e!==null){if(r.has(e))return null;r.add(e);try{if(e instanceof Uint8Array)return arrayToBuffer(e).toString("hex");if(Array.isArray(e))return e.map(n=>jsonify$1(n,t+1,r));if(typeof e.toJSON=="function")return e.toJSON();{const n={};for(const o of Object.keys(e))n[o]=jsonify$1(e[o],t+1,r);return n}}finally{r.delete(e)}}else return e},jsonlogify=(e,t=0,r=new WeakSet)=>{if(t>LOG_MAX_DEPTH||typeof e=="function")return null;if(typeof e=="object"&&e!==null){if(r.has(e))return null;r.add(e);try{if(e instanceof Uint8Array)return arrayToBuffer(e).toString("hex");if(Array.isArray(e))return e.map(n=>jsonlogify(n,t+1,r));if(typeof e.toJSONL=="function")return e.toJSONL();if(typeof e.toJSON=="function")return e.toJSON();{const n={};for(const o of Object.keys(e))n[o]=jsonlogify(e[o],t+1,r);return n}}finally{r.delete(e)}}else return e},jsonKeyReplacer=(e={})=>(t,r)=>{if(typeof r=="string"){const n=PublicKey.fromHex(r);if(n.toHex()===r)return e.humanize?humanize(n):e.truncate?n.truncate():n.toHex()}return r},defaultMap=(e,t,r)=>{let n=e.get(t);return n===void 0&&(n=typeof r=="function"?r():r,e.set(t,n)),n},isNode=()=>typeof process$1<"u"&&process$1.versions!=null&&process$1.versions.node!=null,safariCheck=()=>typeof navigator<"u"&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),range$1=(e,t)=>{const r=Array.from(Array(e).keys());return t==null?r:r.map(t)},rangeFromTo=(e,t,r)=>r==null?range$1(t-e,n=>n+e):range$1(t-e,n=>r(n+e)),accessBy=(e,t)=>typeof t=="function"?t(e):e[t],median=e=>{const t=Math.floor(e.length/2);return e.length%2===1?e[t]:(e[t-1]+e[t])/2},numericalValues=(e,t)=>{const r={total:0,count:0},n=e.map(o=>{const s=accessBy(o,t);if(!(s===void 0||isNaN(s)))return r.total+=s,(r.min===void 0||s<r.min)&&(r.min=s),(r.max===void 0||s>r.max)&&(r.max=s),s}).filter(o=>o!==void 0).sort((o,s)=>o-s);return n.length&&Object.assign(r,{count:n.length,mean:r.total/n.length,median:median(n)}),r},instanceTag=Symbol("instanceTag"),safeInstanceof=e=>t=>{t.prototype[instanceTag]=e,Object.defineProperty(t.prototype,Symbol.hasInstance,{value:r=>(r==null?void 0:r[instanceTag])===e}),Object.defineProperty(t,Symbol.hasInstance,{value:r=>(r==null?void 0:r[instanceTag])===e})},Tracer=class{constructor(){this._events=new Map,this._recording=!1}get recording(){return this._recording}keys(){return Array.from(this._events.keys())}get(e,t){const r=this._events.get(e);return t?r==null?void 0:r.filter(n=>Object.entries(t).every(([o,s])=>(n==null?void 0:n.value[o])===s)):r}clear(){this._events.clear()}start(){return this._recording=!0,this}stop(){return this._recording=!1,this}emit(e,t){this._post(this._createEvent(e,t))}mark(e,t){const r=this._createEvent(e,t),n=performance.now();return{start:n,end:()=>{r.duration=performance.now()-n,this._post(r)}}}_createEvent(e,t){const r={id:e,timestamp:Date.now()};return t!==void 0&&(r.value=t),r}_post(e){this._recording&&defaultMap(this._events,e.id,[]).push(e)}},tracer=new Tracer,nonNullable=e=>e!=null,isNotNullOrUndefined=e=>e!=null,getAsyncValue=async e=>typeof e=="function"?e():e,symbol$2=Symbol.for("dxos.instance-contexts"),instanceContexts=globalThis[symbol$2]??(globalThis[symbol$2]=new WeakMap),getPrototypeSpecificInstanceId=e=>{const t=Object.getPrototypeOf(e),r=defaultMap(instanceContexts,t,()=>({nextId:0,instanceIds:new WeakMap}));let n=r.instanceIds.get(e);return n===void 0&&(n=r.nextId++,r.instanceIds.set(e,n)),n},getDebugName=e=>e==null?"null":`${Object.getPrototypeOf(e).constructor.name}#${getPrototypeSpecificInstanceId(e)}`,forEachAsync=(e,t)=>Promise.all(e.map(t)),mapValues$1=(e,t)=>{const r={};return Object.keys(e).forEach(n=>{r[n]=t(e[n],n)}),r},deepMapValues=(e,t)=>new DeepMapper(t).map(e),DeepMapper=class{constructor(e){this._fn=e,this._cyclic=new Map,this._recurse=t=>{if(this._cyclic.has(t))return this._cyclic.get(t);if(Array.isArray(t)){const r=new Array(t.length);this._cyclic.set(t,r);for(let n=0;n<t.length;n++)r[n]=this.map(t[n]);return r}else if(t!==null&&typeof t=="object"){const r={};this._cyclic.set(t,r);for(const n in t)r[n]=this.map(t[n]);return r}else return t}}map(e){return this._cyclic.has(e)?this._cyclic.get(e):this._fn(e,this._recurse)}},Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose")),Symbol.asyncDispose??(Symbol.asyncDispose=Symbol("Symbol.asyncDispose"));let defer,DeferGuard,throwUnhandledError,notAvailable,appendFileSync,mkdirSync,openSync,require_path_browserify,path$1,import_path_browserify,path_default;defer=e=>new DeferGuard(e),DeferGuard=class{constructor(e){this._fn=e}[Symbol.dispose](){if(this._fn()instanceof Promise)throw new Error("Async functions in defer are not supported. Use deferAsync instead.")}},joinTables=(e,t,r,n)=>{const o=new Map,s=new Set;for(const c of n)o.set(c[t],c);const a=[];for(const c of r){const l=o.get(c[e]);s.add(l),a.push(Object.assign(l??{},c))}for(const c of n)s.has(c)||a.push(c);return a},throwUnhandledError=e=>{queueMicrotask(()=>{throw e})},notAvailable=()=>{throw new Error("Not available on this platform")},appendFileSync=()=>notAvailable(),mkdirSync=()=>notAvailable(),openSync=()=>notAvailable(),require_path_browserify=__commonJS$2({"node_modules/.pnpm/path-browserify@1.0.1/node_modules/path-browserify/index.js"(e,t){function r(a){if(typeof a!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(a))}function n(a,c){for(var l="",h=0,u=-1,d=0,f,_=0;_<=a.length;++_){if(_<a.length)f=a.charCodeAt(_);else{if(f===47)break;f=47}if(f===47){if(!(u===_-1||d===1))if(u!==_-1&&d===2){if(l.length<2||h!==2||l.charCodeAt(l.length-1)!==46||l.charCodeAt(l.length-2)!==46){if(l.length>2){var p=l.lastIndexOf("/");if(p!==l.length-1){p===-1?(l="",h=0):(l=l.slice(0,p),h=l.length-1-l.lastIndexOf("/")),u=_,d=0;continue}}else if(l.length===2||l.length===1){l="",h=0,u=_,d=0;continue}}c&&(l.length>0?l+="/..":l="..",h=2)}else l.length>0?l+="/"+a.slice(u+1,_):l=a.slice(u+1,_),h=_-u-1;u=_,d=0}else f===46&&d!==-1?++d:d=-1}return l}function o(a,c){var l=c.dir||c.root,h=c.base||(c.name||"")+(c.ext||"");return l?l===c.root?l+h:l+a+h:h}var s={resolve:function(){for(var a="",c=!1,l,h=arguments.length-1;h>=-1&&!c;h--){var u;h>=0?u=arguments[h]:(l===void 0&&(l=process.cwd()),u=l),r(u),u.length!==0&&(a=u+"/"+a,c=u.charCodeAt(0)===47)}return a=n(a,!c),c?a.length>0?"/"+a:"/":a.length>0?a:"."},normalize:function(a){if(r(a),a.length===0)return".";var c=a.charCodeAt(0)===47,l=a.charCodeAt(a.length-1)===47;return a=n(a,!c),a.length===0&&!c&&(a="."),a.length>0&&l&&(a+="/"),c?"/"+a:a},isAbsolute:function(a){return r(a),a.length>0&&a.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var a,c=0;c<arguments.length;++c){var l=arguments[c];r(l),l.length>0&&(a===void 0?a=l:a+="/"+l)}return a===void 0?".":s.normalize(a)},relative:function(a,c){if(r(a),r(c),a===c||(a=s.resolve(a),c=s.resolve(c),a===c))return"";for(var l=1;l<a.length&&a.charCodeAt(l)===47;++l);for(var h=a.length,u=h-l,d=1;d<c.length&&c.charCodeAt(d)===47;++d);for(var f=c.length,_=f-d,p=u<_?u:_,y=-1,w=0;w<=p;++w){if(w===p){if(_>p){if(c.charCodeAt(d+w)===47)return c.slice(d+w+1);if(w===0)return c.slice(d+w)}else u>p&&(a.charCodeAt(l+w)===47?y=w:w===0&&(y=0));break}var E=a.charCodeAt(l+w),x=c.charCodeAt(d+w);if(E!==x)break;E===47&&(y=w)}var B="";for(w=l+y+1;w<=h;++w)(w===h||a.charCodeAt(w)===47)&&(B.length===0?B+="..":B+="/..");return B.length>0?B+c.slice(d+y):(d+=y,c.charCodeAt(d)===47&&++d,c.slice(d))},_makeLong:function(a){return a},dirname:function(a){if(r(a),a.length===0)return".";for(var c=a.charCodeAt(0),l=c===47,h=-1,u=!0,d=a.length-1;d>=1;--d)if(c=a.charCodeAt(d),c===47){if(!u){h=d;break}}else u=!1;return h===-1?l?"/":".":l&&h===1?"//":a.slice(0,h)},basename:function(a,c){if(c!==void 0&&typeof c!="string")throw new TypeError('"ext" argument must be a string');r(a);var l=0,h=-1,u=!0,d;if(c!==void 0&&c.length>0&&c.length<=a.length){if(c.length===a.length&&c===a)return"";var f=c.length-1,_=-1;for(d=a.length-1;d>=0;--d){var p=a.charCodeAt(d);if(p===47){if(!u){l=d+1;break}}else _===-1&&(u=!1,_=d+1),f>=0&&(p===c.charCodeAt(f)?--f===-1&&(h=d):(f=-1,h=_))}return l===h?h=_:h===-1&&(h=a.length),a.slice(l,h)}else{for(d=a.length-1;d>=0;--d)if(a.charCodeAt(d)===47){if(!u){l=d+1;break}}else h===-1&&(u=!1,h=d+1);return h===-1?"":a.slice(l,h)}},extname:function(a){r(a);for(var c=-1,l=0,h=-1,u=!0,d=0,f=a.length-1;f>=0;--f){var _=a.charCodeAt(f);if(_===47){if(!u){l=f+1;break}continue}h===-1&&(u=!1,h=f+1),_===46?c===-1?c=f:d!==1&&(d=1):c!==-1&&(d=-1)}return c===-1||h===-1||d===0||d===1&&c===h-1&&c===l+1?"":a.slice(c,h)},format:function(a){if(a===null||typeof a!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof a);return o("/",a)},parse:function(a){r(a);var c={root:"",dir:"",base:"",ext:"",name:""};if(a.length===0)return c;var l=a.charCodeAt(0),h=l===47,u;h?(c.root="/",u=1):u=0;for(var d=-1,f=0,_=-1,p=!0,y=a.length-1,w=0;y>=u;--y){if(l=a.charCodeAt(y),l===47){if(!p){f=y+1;break}continue}_===-1&&(p=!1,_=y+1),l===46?d===-1?d=y:w!==1&&(w=1):d!==-1&&(w=-1)}return d===-1||_===-1||w===0||w===1&&d===_-1&&d===f+1?_!==-1&&(f===0&&h?c.base=c.name=a.slice(1,_):c.base=c.name=a.slice(f,_)):(f===0&&h?(c.name=a.slice(1,d),c.base=a.slice(1,_)):(c.name=a.slice(f,d),c.base=a.slice(f,_)),c.ext=a.slice(d,_)),f>0?c.dir=a.slice(0,f-1):h&&(c.dir="/"),c},sep:"/",delimiter:":",win32:null,posix:null};s.posix=s,t.exports=s}}),path$1=__toESM$2(require_path_browserify()),import_path_browserify=__toESM$2(require_path_browserify()),path_default=path$1,import_path_browserify.basename;var export_dirname=import_path_browserify.dirname;import_path_browserify.extname,import_path_browserify.format,import_path_browserify.isAbsolute;var export_join=import_path_browserify.join;import_path_browserify.normalize,import_path_browserify.parse,import_path_browserify.relative,import_path_browserify.resolve;var define_process_env_default$2={},LogLevel$1;(function(e){e[e.TRACE=5]="TRACE",e[e.DEBUG=10]="DEBUG",e[e.INFO=11]="INFO",e[e.WARN=12]="WARN",e[e.ERROR=13]="ERROR"})(LogLevel$1||(LogLevel$1={}));var levels={trace:5,debug:10,info:11,warn:12,error:13},LogProcessorType;(function(e){e.CONSOLE="console",e.BROWSER="browser",e.DEBUG="debug"})(LogProcessorType||(LogProcessorType={}));var logInfoProperties=Symbol("logInfoProperties"),logInfo=(e,t,r)=>{(e[logInfoProperties]??(e[logInfoProperties]=[])).push(t)},gatherLogInfoFromScope=e=>{if(!e)return{};const t={},r=Object.getPrototypeOf(e)[logInfoProperties]??[];for(const n of r)try{t[n]=typeof e[n]=="function"?e[n]():e[n]}catch(o){t[n]=o.message}return t},matchFilter$1=(e,t,r)=>t>=e.level&&(!e.pattern||r.includes(e.pattern)),shouldLog$1=(e,t)=>t===void 0?!0:t.some(r=>{var n;return matchFilter$1(r,e.level,((n=e.meta)==null?void 0:n.F)??"")}),getContextFromEntry=e=>{let t;if(e.meta){const n=gatherLogInfoFromScope(e.meta.S);Object.keys(n).length>0&&(t=Object.assign(t??{},n))}const r=typeof e.context=="function"?e.context():e.context;if(r)if(r instanceof Error){const n=r.context;t=Object.assign(t??{},{error:r.stack,...n})}else typeof r=="object"&&(t=Object.assign(t??{},r));if(e.error){const n=e.error.context;t=Object.assign(t??{},{error:e.error,...n})}return t&&Object.keys(t).length>0?t:void 0},nextPromiseId=0,createMethodLogDecorator=e=>(t,r,n)=>(o,s,a)=>{const c=a.value,l=s;a.value=function(...h){const u={F:"",L:0,...n??{},S:this},d=h.map(f=>export_inspect(f,!1,1,!0)).join(", ");try{const f=performance.now(),_=c.apply(this,h);if(isThenable(_)){const p=nextPromiseId++;logAsyncBegin(e,l,d,p,u),_.then(y=>{logAsyncResolved(e,l,y,p,f,u)},y=>{logAsyncRejected(e,l,y,p,f,u)})}else logSyncCall(e,l,d,_,u);return _}catch(f){throw logSyncError(e,l,d,f,u),f}},Object.defineProperty(a.value,"name",{value:l+"$log"})},isThenable=e=>e&&typeof e.then=="function",logSyncCall=(e,t,r,n,o)=>{e.info(`.${formatFunction(t)} (${r}) ${chalk$1.gray("=>")} ${export_inspect(n,!1,1,!0)}`,{},o)},logSyncError=(e,t,r,n,o)=>{e.error(`.${formatFunction(t)} (${r}) \u{1F525} ${n}`,{},o)},logAsyncBegin=(e,t,r,n,o)=>{e.info(`.${formatFunction(t)} \u21B4 (${r}) ${chalk$1.gray("=>")} ${formatPromise(n)}`,{},o)},logAsyncResolved=(e,t,r,n,o,s)=>{r!==void 0?e.info(`.${formatFunction(t)} \u21B2 ${greenCheck} ${chalk$1.gray("resolve")} ${formatPromise(n)} ${formatTimeElapsed(o)} ${chalk$1.gray("=>")} ${export_inspect(r,!1,1,!0)}`,{},s):e.info(`.${formatFunction(t)} \u21B2 ${greenCheck} ${chalk$1.gray("resolve")} ${formatPromise(n)} ${formatTimeElapsed(o)}`,{},s)},logAsyncRejected=(e,t,r,n,o,s)=>{e.info(`.${formatFunction(t)} \u21B2 \u{1F525} ${chalk$1.gray("reject")} ${formatPromise(n)} ${formatTimeElapsed(o)} ${chalk$1.gray("=>")} ${r}`,{},s)},greenCheck=chalk$1.green("\u2714"),formatTimeElapsed=e=>chalk$1.gray(`${(performance.now()-e).toFixed(0)}ms`),COLOR_FUNCTION=[220,220,170],formatFunction=e=>chalk$1.bold(chalk$1.rgb(...COLOR_FUNCTION)(e)),formatPromise=e=>chalk$1.blue(`Promise#${e}`),loadOptions=e=>{try{let t;return typeof localStorage>"u"?globalThis.localStorage_dxlog&&(t=globalThis.localStorage_dxlog):t=localStorage.getItem("dxlog")??void 0,t?JSON.parse(t):void 0}catch(t){console.info("can't parse dxlog config",t);return}},CONSOLE_PROCESSOR=()=>{},DEBUG_PROCESSOR=(e,t)=>{console.log(export_inspect(t,!1,null,!0))},getRelativeFilename=e=>{const t=e.match(/.+\/(packages\/.+\/.+)/);if(t){const[,r]=t;return r}return e},CONFIG=typeof mochaExecutor<"u"?{useTestProcessor:!0,printFileLinks:!0}:{useTestProcessor:!1,printFileLinks:!1},APP_BROWSER_PROCESSOR=(e,t)=>{var h,u,d,f;if(!shouldLog$1(t,e.filters))return;const r=e.prefix??"https://vscode.dev/github.com/dxos/dxos/blob/main/",n=[];let o="";if(t.meta){const _=getRelativeFilename(t.meta.F);o=`${`${r.replace(/\/$/,"")}/${_}`}#L${t.meta.L}`}let s=[];if((h=t.meta)!=null&&h.S){const _=(u=t.meta)==null?void 0:u.S,p=_.name||getDebugName(_),y=(d=t.meta.S)!=null&&d.hostSessionId?"[worker] ":"";s.push(`%c${y}${p}`,"color:#C026D3;font-weight:bold")}s.push(t.message);const a=getContextFromEntry(t);a&&s.push(a);const c={[LogLevel$1.ERROR]:console.error,[LogLevel$1.WARN]:console.warn,[LogLevel$1.DEBUG]:console.log};(CONFIG.printFileLinks||safariCheck())&&(n!=null&&n.length?s=[`%c${o}
%c${s.join(" ")}`,...n]:s=[o+`
`,...s]);const l=c[t.level]??console.log;typeof((f=t.meta)==null?void 0:f.C)=="function"?t.meta.C(l,s):l(...s)},TEST_BROWSER_PROCESSOR=(e,t)=>{var l,h,u;if(!shouldLog$1(t,e.filters))return;let r="";t.meta&&(r=`${getRelativeFilename(t.meta.F)}:${t.meta.L}`);let n=[];const o=(h=(l=t.meta)==null?void 0:l.S)!=null&&h.hostSessionId?"[worker] ":"";n.push(`${o}${t.message}`);const s=getContextFromEntry(t);s&&n.push(s);const a={[LogLevel$1.ERROR]:console.error,[LogLevel$1.WARN]:console.warn,[LogLevel$1.DEBUG]:console.log};CONFIG.printFileLinks&&(n=[r,...n]);const c=a[t.level]??console.log;typeof((u=t.meta)==null?void 0:u.C)=="function"?t.meta.C(c,n):c(...n)},BROWSER_PROCESSOR=CONFIG.useTestProcessor?TEST_BROWSER_PROCESSOR:APP_BROWSER_PROCESSOR,getRelativeFilename2=e=>{const t=e.match(/.+\/(packages\/.+\/.+)/);if(t){const[,r]=t;return r}return e},EAGAIN_MAX_DURATION=1e3,createFileProcessor=({pathOrFd:e,levels:t,filters:r})=>{let n;return(o,s)=>{if(t.length>0&&!t.includes(s.level)||!shouldLog$1(s,r))return;if(typeof e=="number")n=e;else{try{mkdirSync(export_dirname(e))}catch{}n=openSync()}const a={...s,timestamp:Date.now(),...s.meta?{meta:{file:getRelativeFilename2(s.meta.F),line:s.meta.L}}:{},context:jsonlogify(getContextFromEntry(s))};let c=0;for(;;)try{return appendFileSync(n,JSON.stringify(a)+`
`)}catch(l){if(l.code!=="EAGAIN")throw l;if(c===0)c=performance.now();else if(performance.now()-c>EAGAIN_MAX_DURATION)throw console.log(`could not write after ${EAGAIN_MAX_DURATION}ms of EAGAIN failures, giving up`),l}}},logFilePath,getLogFilePath=()=>(logFilePath??(logFilePath=define_process_env_default$2.LOG_FILE??(define_process_env_default$2.HOME?`${define_process_env_default$2.HOME}/.dxlog/${new Date().toISOString()}.log`:void 0)),logFilePath);createFileProcessor({pathOrFd:getLogFilePath(),levels:[LogLevel$1.ERROR,LogLevel$1.WARN,LogLevel$1.INFO,LogLevel$1.TRACE]});let processors,IS_BROWSER,DEFAULT_PROCESSORS,getConfig,createLog,getFormattedStackTrace,kDebugInfoProperties;processors={[LogProcessorType.CONSOLE]:CONSOLE_PROCESSOR,[LogProcessorType.BROWSER]:BROWSER_PROCESSOR,[LogProcessorType.DEBUG]:DEBUG_PROCESSOR},IS_BROWSER=typeof window<"u"||typeof navigator<"u",DEFAULT_PROCESSORS=[IS_BROWSER?BROWSER_PROCESSOR:CONSOLE_PROCESSOR],parseFilter=e=>{if(typeof e=="number")return[{level:e}];const t=(r,n=LogLevel$1.WARN)=>levels[r.toLowerCase()]??n;return(typeof e=="string"?e.split(/,\s*/):e).map(r=>{const[n,o]=r.split(":");return o?{level:t(o),pattern:n}:{level:t(n)}})},getConfig=e=>{const t="process"in globalThis?{file:define_process_env_default$2.LOG_CONFIG,filter:define_process_env_default$2.LOG_FILTER,processor:define_process_env_default$2.LOG_PROCESSOR}:void 0,r=defaultsDeep({},loadOptions(t==null?void 0:t.file),t,e);return{options:r,filters:parseFilter(r.filter??LogLevel$1.INFO),captureFilters:parseFilter(r.captureFilter??LogLevel$1.WARN),processors:r.processor?[processors[r.processor]]:DEFAULT_PROCESSORS,prefix:r.prefix}},createLog=()=>{const e=(...r)=>t(LogLevel$1.DEBUG,...r);e._config=getConfig(),Object.defineProperty(e,"runtimeConfig",{get:()=>e._config}),e.addProcessor=r=>{DEFAULT_PROCESSORS.filter(n=>n===r).length===0&&DEFAULT_PROCESSORS.push(r),e._config.processors.filter(n=>n===r).length===0&&e._config.processors.push(r)},e.config=r=>{e._config=getConfig(r)},e.trace=(...r)=>t(LogLevel$1.TRACE,...r),e.debug=(...r)=>t(LogLevel$1.DEBUG,...r),e.info=(...r)=>t(LogLevel$1.INFO,...r),e.warn=(...r)=>t(LogLevel$1.WARN,...r),e.error=(...r)=>t(LogLevel$1.ERROR,...r),e.catch=(r,n,o)=>t(LogLevel$1.ERROR,r.message,n,o,r),e.break=()=>e.info("\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014\u2014"),e.stack=(r,n,o)=>t(LogLevel$1.INFO,`${r??"Stack Dump"}
${getFormattedStackTrace()}`,n,o),e.method=createMethodLogDecorator(e);const t=(r,n,o={},s,a)=>{e._config.processors.forEach(c=>c(e._config,{level:r,message:n,context:o,meta:s,error:a}))};return e},log=globalThis.dx_log??(globalThis.dx_log=createLog()),getFormattedStackTrace=()=>new Error().stack.split(`
`).slice(3).join(`
`),kDebugInfoProperties=Symbol("kDebugInfoProperties"),class{constructor(e,t){this.constr=e,this.parent=t}getInfo(){if(!this.instance)return{};const e=this.constr.prototype[kDebugInfoProperties]??[],t={};for(const r of e)t[r]=this.instance[r];return t}[export_inspect.custom](){return{className:this.constr.name,info:this.getInfo(),parent:this.parent}}};var ContextDisposedError=class extends Error{constructor(){super("Context disposed.")}};function _ts_decorate$i(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file$w,MAX_SAFE_DISPOSE_CALLBACKS,DEFAULT_ERROR_HANDLER,_a$1,_b$1;__dxlog_file$w="/home/runner/work/dxos/dxos/packages/common/context/src/context.ts",MAX_SAFE_DISPOSE_CALLBACKS=300,DEFAULT_ERROR_HANDLER=(e,t)=>{if(!(e instanceof ContextDisposedError))throw t.dispose(),e},Context=(Tn=class{constructor({name:t,parent:r,attributes:n={},onError:o=DEFAULT_ERROR_HANDLER}={}){dt(this,Et);dt(this,kt);dt(this,Bt);dt(this,zr);dt(this,xn);dt(this,mn);dt(this,$n);$t(this,Et,[]),$t(this,kt,void 0),$t(this,Bt,void 0),$t(this,mn,!1),$t(this,$n,void 0),this.maxSafeDisposeCallbacks=MAX_SAFE_DISPOSE_CALLBACKS,this[_a$1]="Context",this[_b$1]=()=>this.toString(),$t(this,kt,t),$t(this,Bt,r),$t(this,zr,n),$t(this,xn,o)}static default(){return new Tn}get disposed(){return Ae(this,mn)}get disposeCallbacksLength(){return Ae(this,Et).length}onDispose(t){return Ae(this,mn)&&(async()=>{try{await t()}catch(r){log.catch(r,void 0,{F:__dxlog_file$w,L:88,S:this,C:(n,o)=>n(...o)})}})(),Ae(this,Et).push(t),Ae(this,Et).length>this.maxSafeDisposeCallbacks&&log.warn("Context has a large number of dispose callbacks (this might be a memory leak).",{count:Ae(this,Et).length},{F:__dxlog_file$w,L:95,S:this,C:(r,n)=>r(...n)}),()=>{const r=Ae(this,Et).indexOf(t);r!==-1&&Ae(this,Et).splice(r,1)}}async dispose(t=!1){if(Ae(this,$n))return Ae(this,$n);$t(this,mn,!0);let r;const n=new Promise(l=>{r=l});$t(this,$n,n);const o=Array.from(Ae(this,Et)).reverse();Ae(this,Et).length=0,Ae(this,kt)&&log("disposing",{context:Ae(this,kt),count:o.length},{F:__dxlog_file$w,L:137,S:this,C:(l,h)=>l(...h)});let s=0,a=!0;const c=[];for(const l of o)try{await l(),s++}catch(h){a=!1,t?c.push(h):log.catch(h,{context:Ae(this,kt),callback:s,count:o.length},{F:__dxlog_file$w,L:152,S:this,C:(u,d)=>u(...d)})}if(c.length>0)throw new AggregateError(c);return r(a),Ae(this,kt)&&log("disposed",{context:Ae(this,kt)},{F:__dxlog_file$w,L:163,S:this,C:(l,h)=>l(...h)}),a}raise(t){if(!Ae(this,mn))try{Ae(this,xn).call(this,t,this)}catch(r){Promise.reject(r)}}derive({onError:t,attributes:r}={}){const n=new Tn({onError:async s=>{if(!t)this.raise(s);else try{await t(s,this)}catch{this.raise(s)}},attributes:r}),o=this.onDispose(()=>n.dispose());return n.onDispose(o),n}getAttribute(t){if(t in Ae(this,zr))return Ae(this,zr)[t];if(Ae(this,Bt))return Ae(this,Bt).getAttribute(t)}toString(){return`Context(${Ae(this,mn)?"disposed":"active"})`}},Et=new WeakMap,kt=new WeakMap,Bt=new WeakMap,zr=new WeakMap,xn=new WeakMap,mn=new WeakMap,$n=new WeakMap,_a$1=Symbol.toStringTag,_b$1=export_inspect.custom,Tn),Context=_ts_decorate$i([safeInstanceof("Context")],Context);var rejectOnDispose=(e,t=new ContextDisposedError)=>new Promise((r,n)=>{e.onDispose(()=>n(t))}),cancelWithContext=(e,t)=>{let r;return Promise.race([t,new Promise((n,o)=>{r=e.onDispose(()=>o(new ContextDisposedError))})]).finally(()=>r==null?void 0:r())},LifecycleState;(function(e){e.CLOSED="CLOSED",e.OPEN="OPEN",e.ERROR="ERROR"})(LifecycleState||(LifecycleState={}));var Resource=(Pi=class{constructor(){dt(this,Fr);dt(this,hn,"CLOSED");dt(this,Fn,null);dt(this,jn,null);dt(this,Un,vt(this,Fr,xi).call(this));dt(this,Kn,new Context({name:Ae(this,Fr,Ci)}))}get _lifecycleState(){return Ae(this,hn)}get _ctx(){return Ae(this,Un)}async _open(e){}async _close(e){}async _catch(e){throw e}async open(e){switch(Ae(this,hn)){case"OPEN":return this;case"ERROR":throw new Error(`Invalid state: ${Ae(this,hn)}`)}return await Ae(this,jn),await(Ae(this,Fn)??$t(this,Fn,vt(this,Fr,Qs).call(this,e))),this}async close(e){return Ae(this,hn)==="CLOSED"?this:(await Ae(this,Fn),await(Ae(this,jn)??$t(this,jn,vt(this,Fr,zs).call(this,e))),this)}async[Symbol.asyncDispose](){await this.close()}},hn=new WeakMap,Fn=new WeakMap,jn=new WeakMap,Un=new WeakMap,Kn=new WeakMap,Fr=new WeakSet,Ci=function(){return Object.getPrototypeOf(this).constructor.name},Qs=async function(e){$t(this,jn,null),e&&$t(this,Kn,e.derive({name:Ae(this,Fr,Ci)})),await this._open(Ae(this,Kn)),$t(this,hn,"OPEN")},zs=async function(e=Context.default()){$t(this,Fn,null),await Ae(this,Un).dispose(),await this._close(e),$t(this,Un,vt(this,Fr,xi).call(this)),$t(this,hn,"CLOSED")},xi=function(){return new Context({onError:e=>queueMicrotask(async()=>{try{await this._catch(e)}catch(t){$t(this,hn,"ERROR"),Ae(this,Kn).raise(t)}})})},Pi),Observable$5={};Object.defineProperty(Observable$5,"__esModule",{value:!0}),Observable$5.Observable=void 0;const hasSymbol$1=e=>!!Symbol[e],getSymbol$1=e=>hasSymbol$1(e)?Symbol[e]:"@@"+e,SymbolIterator$1=getSymbol$1("iterator"),SymbolObservable$1=getSymbol$1("observable"),SymbolSpecies$1=getSymbol$1("species");function getMethod$1(e,t){let r=e[t];if(r!=null){if(typeof r!="function")throw new TypeError(r+" is not a function");return r}}function getSpecies$1(e){let t=e.constructor;return t!==void 0&&(t=t[SymbolSpecies$1],t===null&&(t=void 0)),t!==void 0?t:Observable$4}function isObservable$1(e){return e instanceof Observable$4}function hostReportError$1(e){hostReportError$1.log?hostReportError$1.log(e):setTimeout(()=>{throw e})}function enqueue$1(e){Promise.resolve().then(()=>{try{e()}catch(t){hostReportError$1(t)}})}function cleanupSubscription$1(e){let t=e._cleanup;if(t!==void 0&&(e._cleanup=void 0,!!t))try{if(typeof t=="function")t();else{let r=getMethod$1(t,"unsubscribe");r&&r.call(t)}}catch(r){hostReportError$1(r)}}function closeSubscription$1(e){e._observer=void 0,e._queue=void 0,e._state="closed"}function flushSubscription$1(e){let t=e._queue;if(t){e._queue=void 0,e._state="ready";for(let r=0;r<t.length&&(notifySubscription$1(e,t[r].type,t[r].value),e._state!=="closed");++r);}}function notifySubscription$1(e,t,r){e._state="running";let n=e._observer;try{let o=getMethod$1(n,t);switch(t){case"next":o&&o.call(n,r);break;case"error":if(closeSubscription$1(e),o)o.call(n,r);else throw r;break;case"complete":closeSubscription$1(e),o&&o.call(n);break}}catch(o){hostReportError$1(o)}e._state==="closed"?cleanupSubscription$1(e):e._state==="running"&&(e._state="ready")}function onNotify$1(e,t,r){if(e._state!=="closed"){if(e._state==="buffering"){e._queue.push({type:t,value:r});return}if(e._state!=="ready"){e._state="buffering",e._queue=[{type:t,value:r}],enqueue$1(()=>flushSubscription$1(e));return}notifySubscription$1(e,t,r)}}let Subscription$1=class{constructor(e,t){this._cleanup=void 0,this._observer=e,this._queue=void 0,this._state="initializing";let r=this,n={get closed(){return r._state==="closed"},next(o){onNotify$1(r,"next",o)},error(o){onNotify$1(r,"error",o)},complete(){onNotify$1(r,"complete")}};try{this._cleanup=t.call(void 0,n)}catch(o){n.error(o)}this._state==="initializing"&&(this._state="ready")}get closed(){return this._state==="closed"}unsubscribe(){this._state!=="closed"&&(closeSubscription$1(this),cleanupSubscription$1(this))}},Observable$4=class fi{constructor(t){if(!(this instanceof fi))throw new TypeError("Observable cannot be called as a function");if(typeof t!="function")throw new TypeError("Observable initializer must be a function");this._subscriber=t}subscribe(t){return(typeof t!="object"||t===null)&&(t={next:t,error:arguments[1],complete:arguments[2]}),new Subscription$1(t,this._subscriber)}forEach(t){return new Promise((r,n)=>{if(typeof t!="function"){n(new TypeError(t+" is not a function"));return}function o(){s.unsubscribe(),r()}let s=this.subscribe({next(a){try{t(a,o)}catch(c){n(c),s.unsubscribe()}},error:n,complete:r})})}map(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies$1(this);return new r(n=>this.subscribe({next(o){try{o=t(o)}catch(s){return n.error(s)}n.next(o)},error(o){n.error(o)},complete(){n.complete()}}))}filter(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies$1(this);return new r(n=>this.subscribe({next(o){try{if(!t(o))return}catch(s){return n.error(s)}n.next(o)},error(o){n.error(o)},complete(){n.complete()}}))}reduce(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies$1(this),n=arguments.length>1,o=!1,s=arguments[1];return new r(a=>this.subscribe({next(c){let l=!o;if(o=!0,!l||n)try{s=t(s,c)}catch(h){return a.error(h)}else s=c},error(c){a.error(c)},complete(){if(!o&&!n)return a.error(new TypeError("Cannot reduce an empty sequence"));a.next(s),a.complete()}}))}async all(){let t=[];return await this.forEach(r=>t.push(r)),t}concat(...t){let r=getSpecies$1(this);return new r(n=>{let o,s=0;function a(c){o=c.subscribe({next(l){n.next(l)},error(l){n.error(l)},complete(){s===t.length?(o=void 0,n.complete()):a(r.from(t[s++]))}})}return a(this),()=>{o&&(o.unsubscribe(),o=void 0)}})}flatMap(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies$1(this);return new r(n=>{let o=[],s=this.subscribe({next(c){if(t)try{c=t(c)}catch(h){return n.error(h)}let l=r.from(c).subscribe({next(h){n.next(h)},error(h){n.error(h)},complete(){let h=o.indexOf(l);h>=0&&o.splice(h,1),a()}});o.push(l)},error(c){n.error(c)},complete(){a()}});function a(){s.closed&&o.length===0&&n.complete()}return()=>{o.forEach(c=>c.unsubscribe()),s.unsubscribe()}})}[SymbolObservable$1](){return this}static from(t){let r=typeof this=="function"?this:fi;if(t==null)throw new TypeError(t+" is not an object");let n=getMethod$1(t,SymbolObservable$1);if(n){let o=n.call(t);if(Object(o)!==o)throw new TypeError(o+" is not an object");return isObservable$1(o)&&o.constructor===r?o:new r(s=>o.subscribe(s))}if(hasSymbol$1("iterator")&&(n=getMethod$1(t,SymbolIterator$1),n))return new r(o=>{enqueue$1(()=>{if(!o.closed){for(let s of n.call(t))if(o.next(s),o.closed)return;o.complete()}})});if(Array.isArray(t))return new r(o=>{enqueue$1(()=>{if(!o.closed){for(let s=0;s<t.length;++s)if(o.next(t[s]),o.closed)return;o.complete()}})});throw new TypeError(t+" is not observable")}static of(...t){let r=typeof this=="function"?this:fi;return new r(n=>{enqueue$1(()=>{if(!n.closed){for(let o=0;o<t.length;++o)if(n.next(t[o]),n.closed)return;n.complete()}})})}static get[SymbolSpecies$1](){return this}};Observable$5.Observable=Observable$4,Object.defineProperty(Observable$4,Symbol("extensions"),{value:{symbol:SymbolObservable$1,hostReportError:hostReportError$1},configurable:!0});var zenObservable$1=Observable$5.Observable;const Observable$3=getDefaultExportFromCjs(zenObservable$1);var Observable$2={};Object.defineProperty(Observable$2,"__esModule",{value:!0}),Observable$2.Observable=void 0;const hasSymbol=e=>!!Symbol[e],getSymbol=e=>hasSymbol(e)?Symbol[e]:"@@"+e;!hasSymbol("observable")&&Object.isExtensible(Symbol)&&(Symbol.observable=Symbol("observable"));const SymbolIterator=getSymbol("iterator"),SymbolObservable=getSymbol("observable"),SymbolSpecies=getSymbol("species");function getMethod(e,t){let r=e[t];if(r!=null){if(typeof r!="function")throw new TypeError(r+" is not a function");return r}}function getSpecies(e){let t=e.constructor;return t!==void 0&&(t=t[SymbolSpecies],t===null&&(t=void 0)),t!==void 0?t:Observable$1}function isObservable(e){return e instanceof Observable$1}function hostReportError(e){hostReportError.log?hostReportError.log(e):setTimeout(()=>{throw e})}function enqueue(e){Promise.resolve().then(()=>{try{e()}catch(t){hostReportError(t)}})}function cleanupSubscription(e){let t=e._cleanup;if(t!==void 0&&(e._cleanup=void 0,!!t))try{if(typeof t=="function")t();else{let r=getMethod(t,"unsubscribe");r&&r.call(t)}}catch(r){hostReportError(r)}}function closeSubscription(e){e._observer=void 0,e._queue=void 0,e._state="closed"}function flushSubscription(e){let t=e._queue;if(t){e._queue=void 0,e._state="ready";for(let r=0;r<t.length&&(notifySubscription(e,t[r].type,t[r].value),e._state!=="closed");++r);}}function notifySubscription(e,t,r){e._state="running";let n=e._observer;try{let o=getMethod(n,t);switch(t){case"next":o&&o.call(n,r);break;case"error":if(closeSubscription(e),o)o.call(n,r);else throw r;break;case"complete":closeSubscription(e),o&&o.call(n);break}}catch(o){hostReportError(o)}e._state==="closed"?cleanupSubscription(e):e._state==="running"&&(e._state="ready")}function onNotify(e,t,r){if(e._state!=="closed"){if(e._state==="buffering"){e._queue.push({type:t,value:r});return}if(e._state!=="ready"){e._state="buffering",e._queue=[{type:t,value:r}],enqueue(()=>flushSubscription(e));return}notifySubscription(e,t,r)}}class Subscription{constructor(t,r){this._cleanup=void 0,this._observer=t,this._queue=void 0,this._state="initializing";let n=this,o={get closed(){return n._state==="closed"},next(s){onNotify(n,"next",s)},error(s){onNotify(n,"error",s)},complete(){onNotify(n,"complete")}};try{this._cleanup=r.call(void 0,o)}catch(s){o.error(s)}this._state==="initializing"&&(this._state="ready")}get closed(){return this._state==="closed"}unsubscribe(){this._state!=="closed"&&(closeSubscription(this),cleanupSubscription(this))}}let Observable$1=class pi{constructor(t){if(!(this instanceof pi))throw new TypeError("Observable cannot be called as a function");if(typeof t!="function")throw new TypeError("Observable initializer must be a function");this._subscriber=t}subscribe(t){return(typeof t!="object"||t===null)&&(t={next:t,error:arguments[1],complete:arguments[2]}),new Subscription(t,this._subscriber)}forEach(t){return new Promise((r,n)=>{if(typeof t!="function"){n(new TypeError(t+" is not a function"));return}function o(){s.unsubscribe(),r()}let s=this.subscribe({next(a){try{t(a,o)}catch(c){n(c),s.unsubscribe()}},error:n,complete:r})})}map(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies(this);return new r(n=>this.subscribe({next(o){try{o=t(o)}catch(s){return n.error(s)}n.next(o)},error(o){n.error(o)},complete(){n.complete()}}))}filter(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies(this);return new r(n=>this.subscribe({next(o){try{if(!t(o))return}catch(s){return n.error(s)}n.next(o)},error(o){n.error(o)},complete(){n.complete()}}))}reduce(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies(this),n=arguments.length>1,o=!1,s=arguments[1];return new r(a=>this.subscribe({next(c){let l=!o;if(o=!0,!l||n)try{s=t(s,c)}catch(h){return a.error(h)}else s=c},error(c){a.error(c)},complete(){if(!o&&!n)return a.error(new TypeError("Cannot reduce an empty sequence"));a.next(s),a.complete()}}))}async all(){let t=[];return await this.forEach(r=>t.push(r)),t}concat(...t){let r=getSpecies(this);return new r(n=>{let o,s=0;function a(c){o=c.subscribe({next(l){n.next(l)},error(l){n.error(l)},complete(){s===t.length?(o=void 0,n.complete()):a(r.from(t[s++]))}})}return a(this),()=>{o&&(o.unsubscribe(),o=void 0)}})}flatMap(t){if(typeof t!="function")throw new TypeError(t+" is not a function");let r=getSpecies(this);return new r(n=>{let o=[],s=this.subscribe({next(c){if(t)try{c=t(c)}catch(h){return n.error(h)}let l=r.from(c).subscribe({next(h){n.next(h)},error(h){n.error(h)},complete(){let h=o.indexOf(l);h>=0&&o.splice(h,1),a()}});o.push(l)},error(c){n.error(c)},complete(){a()}});function a(){s.closed&&o.length===0&&n.complete()}return()=>{o.forEach(c=>c.unsubscribe()),s.unsubscribe()}})}[SymbolObservable](){return this}static from(t){let r=typeof this=="function"?this:pi;if(t==null)throw new TypeError(t+" is not an object");let n=getMethod(t,SymbolObservable);if(n){let o=n.call(t);if(Object(o)!==o)throw new TypeError(o+" is not an object");return isObservable(o)&&o.constructor===r?o:new r(s=>o.subscribe(s))}if(hasSymbol("iterator")&&(n=getMethod(t,SymbolIterator),n))return new r(o=>{enqueue(()=>{if(!o.closed){for(let s of n.call(t))if(o.next(s),o.closed)return;o.complete()}})});if(Array.isArray(t))return new r(o=>{enqueue(()=>{if(!o.closed){for(let s=0;s<t.length;++s)if(o.next(t[s]),o.closed)return;o.complete()}})});throw new TypeError(t+" is not observable")}static of(...t){let r=typeof this=="function"?this:pi;return new r(n=>{enqueue(()=>{if(!n.closed){for(let o=0;o<t.length;++o)if(n.next(t[o]),n.closed)return;n.complete()}})})}static get[SymbolSpecies](){return this}};Observable$2.Observable=Observable$1,Object.defineProperty(Observable$1,Symbol("extensions"),{value:{symbol:SymbolObservable,hostReportError},configurable:!0});var zenObservable=Observable$2.Observable,Observable=zenObservable;function send(e,t,r){if(e._observer)sendMessage(e._observer,t,r);else if(e._observers){var n=[];e._observers.forEach(function(o){n.push(o)}),n.forEach(function(o){sendMessage(o,t,r)})}}function sendMessage(e,t,r){if(!e.closed)switch(t){case"next":return e.next(r);case"error":return e.error(r);case"complete":return e.complete()}}function hasObserver(e){return e._observer||e._observers&&e._observers.size>0}function addObserver(e,t){e._observers?e._observers.add(t):e._observer?(e._observers=new Set,e._observers.add(e._observer),e._observers.add(t),e._observer=null):e._observer=t}function deleteObserver(e,t){e._observers?e._observers.delete(t):e._observer===t&&(e._observer=null)}function notifyStart(e,t){!hasObserver(e)&&t&&t.start&&t.start()}function notifyPause(e,t){!hasObserver(e)&&t&&t.pause&&t.pause()}class PushStream{constructor(t){this._observer=null,this._observers=null,this._observable=new Observable(r=>(notifyStart(this,t),addObserver(this,r),()=>{deleteObserver(this,r),notifyPause(this,t)}))}get observable(){return this._observable}get observed(){return hasObserver(this)}next(t){send(this,"next",t)}error(t){send(this,"error",t)}complete(){send(this,"complete")}static multicast(t){let r=new this;return t.subscribe(r),r.observable}}var zenPush=PushStream;PushStream$1=getDefaultExportFromCjs(zenPush);var readableBrowser={exports:{}},events$1={exports:{}},R=typeof Reflect=="object"?Reflect:null,ReflectApply=R&&typeof R.apply=="function"?R.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},ReflectOwnKeys;R&&typeof R.ownKeys=="function"?ReflectOwnKeys=R.ownKeys:Object.getOwnPropertySymbols?ReflectOwnKeys=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:ReflectOwnKeys=function(e){return Object.getOwnPropertyNames(e)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e)}var NumberIsNaN=Number.isNaN||function(e){return e!==e};function EventEmitter$3(){EventEmitter$3.init.call(this)}events$1.exports=EventEmitter$3,events$1.exports.once=once$4,EventEmitter$3.EventEmitter=EventEmitter$3,EventEmitter$3.prototype._events=void 0,EventEmitter$3.prototype._eventsCount=0,EventEmitter$3.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(EventEmitter$3,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if(typeof e!="number"||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}}),EventEmitter$3.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter$3.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||NumberIsNaN(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function _getMaxListeners(e){return e._maxListeners===void 0?EventEmitter$3.defaultMaxListeners:e._maxListeners}EventEmitter$3.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter$3.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n=e==="error",o=this._events;if(o!==void 0)n=n&&o.error===void 0;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=o[e];if(c===void 0)return!1;if(typeof c=="function")ReflectApply(c,this,t);else for(var l=c.length,h=arrayClone(c,l),r=0;r<l;++r)ReflectApply(h[r],this,t);return!0};function _addListener(e,t,r,n){var o,s,a;if(checkListener(r),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),a===void 0)a=s[t]=r,++e._eventsCount;else if(typeof a=="function"?a=s[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),o=_getMaxListeners(e),o>0&&a.length>o&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,ProcessEmitWarning(c)}return e}EventEmitter$3.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter$3.prototype.on=EventEmitter$3.prototype.addListener,EventEmitter$3.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)};function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},o=onceWrapper.bind(n);return o.listener=r,n.wrapFn=o,o}EventEmitter$3.prototype.once=function(e,t){return checkListener(t),this.on(e,_onceWrap(this,e,t)),this},EventEmitter$3.prototype.prependOnceListener=function(e,t){return checkListener(t),this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter$3.prototype.removeListener=function(e,t){var r,n,o,s,a;if(checkListener(t),n=this._events,n===void 0)return this;if(r=n[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(o=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){a=r[s].listener,o=s;break}if(o<0)return this;o===0?r.shift():spliceOne(r,o),r.length===1&&(n[e]=r[0]),n.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this},EventEmitter$3.prototype.off=EventEmitter$3.prototype.removeListener,EventEmitter$3.prototype.removeAllListeners=function(e){var t,r,n;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var o=Object.keys(r),s;for(n=0;n<o.length;++n)s=o[n],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function _listeners(e,t,r){var n=e._events;if(n===void 0)return[];var o=n[t];return o===void 0?[]:typeof o=="function"?r?[o.listener||o]:[o]:r?unwrapListeners(o):arrayClone(o,o.length)}EventEmitter$3.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter$3.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter$3.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter$3.prototype.listenerCount=listenerCount;function listenerCount(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}EventEmitter$3.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function spliceOne(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function unwrapListeners(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function once$4(e,t){return new Promise(function(r,n){function o(a){e.removeListener(t,s),n(a)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",o),r([].slice.call(arguments))}eventTargetAgnosticAddListener(e,t,s,{once:!0}),t!=="error"&&addErrorHandlerIfEventEmitter(e,o,{once:!0})})}function addErrorHandlerIfEventEmitter(e,t,r){typeof e.on=="function"&&eventTargetAgnosticAddListener(e,"error",t,r)}function eventTargetAgnosticAddListener(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function o(s){n.once&&e.removeEventListener(t,o),r(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var eventsExports=events$1.exports,streamBrowser=eventsExports.EventEmitter,buffer={},base64Js={};base64Js.byteLength=byteLength$5,base64Js.toByteArray=toByteArray,base64Js.fromByteArray=fromByteArray;for(var lookup$1=[],revLookup=[],Arr=typeof Uint8Array<"u"?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup$1[i]=code[i],revLookup[code.charCodeAt(i)]=i;revLookup[45]=62,revLookup[95]=63;function getLens(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");r===-1&&(r=t);var n=r===t?0:4-r%4;return[r,n]}function byteLength$5(e){var t=getLens(e),r=t[0],n=t[1];return(r+n)*3/4-n}function _byteLength(e,t,r){return(t+r)*3/4-r}function toByteArray(e){var t,r=getLens(e),n=r[0],o=r[1],s=new Arr(_byteLength(e,n,o)),a=0,c=o>0?n-4:n,l;for(l=0;l<c;l+=4)t=revLookup[e.charCodeAt(l)]<<18|revLookup[e.charCodeAt(l+1)]<<12|revLookup[e.charCodeAt(l+2)]<<6|revLookup[e.charCodeAt(l+3)],s[a++]=t>>16&255,s[a++]=t>>8&255,s[a++]=t&255;return o===2&&(t=revLookup[e.charCodeAt(l)]<<2|revLookup[e.charCodeAt(l+1)]>>4,s[a++]=t&255),o===1&&(t=revLookup[e.charCodeAt(l)]<<10|revLookup[e.charCodeAt(l+1)]<<4|revLookup[e.charCodeAt(l+2)]>>2,s[a++]=t>>8&255,s[a++]=t&255),s}function tripletToBase64(e){return lookup$1[e>>18&63]+lookup$1[e>>12&63]+lookup$1[e>>6&63]+lookup$1[e&63]}function encodeChunk$1(e,t,r){for(var n,o=[],s=t;s<r;s+=3)n=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(e[s+2]&255),o.push(tripletToBase64(n));return o.join("")}function fromByteArray(e){for(var t,r=e.length,n=r%3,o=[],s=16383,a=0,c=r-n;a<c;a+=s)o.push(encodeChunk$1(e,a,a+s>c?c:a+s));return n===1?(t=e[r-1],o.push(lookup$1[t>>2]+lookup$1[t<<4&63]+"==")):n===2&&(t=(e[r-2]<<8)+e[r-1],o.push(lookup$1[t>>10]+lookup$1[t>>4&63]+lookup$1[t<<2&63]+"=")),o.join("")}var ieee754={};ieee754.read=function(e,t,r,n,o){var s,a,c=o*8-n-1,l=(1<<c)-1,h=l>>1,u=-7,d=r?o-1:0,f=r?-1:1,_=e[t+d];for(d+=f,s=_&(1<<-u)-1,_>>=-u,u+=c;u>0;s=s*256+e[t+d],d+=f,u-=8);for(a=s&(1<<-u)-1,s>>=-u,u+=n;u>0;a=a*256+e[t+d],d+=f,u-=8);if(s===0)s=1-h;else{if(s===l)return a?NaN:(_?-1:1)*(1/0);a=a+Math.pow(2,n),s=s-h}return(_?-1:1)*a*Math.pow(2,s-n)},ieee754.write=function(e,t,r,n,o,s){var a,c,l,h=s*8-o-1,u=(1<<h)-1,d=u>>1,f=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,_=n?0:s-1,p=n?1:-1,y=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(c=isNaN(t)?1:0,a=u):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),a+d>=1?t+=f/l:t+=f*Math.pow(2,1-d),t*l>=2&&(a++,l/=2),a+d>=u?(c=0,a=u):a+d>=1?(c=(t*l-1)*Math.pow(2,o),a=a+d):(c=t*Math.pow(2,d-1)*Math.pow(2,o),a=0));o>=8;e[r+_]=c&255,_+=p,c/=256,o-=8);for(a=a<<o|c,h+=o;h>0;e[r+_]=a&255,_+=p,a/=256,h-=8);e[r+_-p]|=y*128},function(e){const t=base64Js,r=ieee754,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=c,e.SlowBuffer=x,e.INSPECT_MAX_BYTES=50;const o=2147483647;e.kMaxLength=o,c.TYPED_ARRAY_SUPPORT=s(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function s(){try{const g=new Uint8Array(1),b={foo:function(){return 42}};return Object.setPrototypeOf(b,Uint8Array.prototype),Object.setPrototypeOf(g,b),g.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function a(g){if(g>o)throw new RangeError('The value "'+g+'" is invalid for option "size"');const b=new Uint8Array(g);return Object.setPrototypeOf(b,c.prototype),b}function c(g,b,T){if(typeof g=="number"){if(typeof b=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return d(g)}return l(g,b,T)}c.poolSize=8192;function l(g,b,T){if(typeof g=="string")return f(g,b);if(ArrayBuffer.isView(g))return p(g);if(g==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g);if(rt(g,ArrayBuffer)||g&&rt(g.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(rt(g,SharedArrayBuffer)||g&&rt(g.buffer,SharedArrayBuffer)))return y(g,b,T);if(typeof g=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const ce=g.valueOf&&g.valueOf();if(ce!=null&&ce!==g)return c.from(ce,b,T);const fe=w(g);if(fe)return fe;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof g[Symbol.toPrimitive]=="function")return c.from(g[Symbol.toPrimitive]("string"),b,T);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof g)}c.from=function(g,b,T){return l(g,b,T)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function h(g){if(typeof g!="number")throw new TypeError('"size" argument must be of type number');if(g<0)throw new RangeError('The value "'+g+'" is invalid for option "size"')}function u(g,b,T){return h(g),g<=0?a(g):b!==void 0?typeof T=="string"?a(g).fill(b,T):a(g).fill(b):a(g)}c.alloc=function(g,b,T){return u(g,b,T)};function d(g){return h(g),a(g<0?0:E(g)|0)}c.allocUnsafe=function(g){return d(g)},c.allocUnsafeSlow=function(g){return d(g)};function f(g,b){if((typeof b!="string"||b==="")&&(b="utf8"),!c.isEncoding(b))throw new TypeError("Unknown encoding: "+b);const T=B(g,b)|0;let ce=a(T);const fe=ce.write(g,b);return fe!==T&&(ce=ce.slice(0,fe)),ce}function _(g){const b=g.length<0?0:E(g.length)|0,T=a(b);for(let ce=0;ce<b;ce+=1)T[ce]=g[ce]&255;return T}function p(g){if(rt(g,Uint8Array)){const b=new Uint8Array(g);return y(b.buffer,b.byteOffset,b.byteLength)}return _(g)}function y(g,b,T){if(b<0||g.byteLength<b)throw new RangeError('"offset" is outside of buffer bounds');if(g.byteLength<b+(T||0))throw new RangeError('"length" is outside of buffer bounds');let ce;return b===void 0&&T===void 0?ce=new Uint8Array(g):T===void 0?ce=new Uint8Array(g,b):ce=new Uint8Array(g,b,T),Object.setPrototypeOf(ce,c.prototype),ce}function w(g){if(c.isBuffer(g)){const b=E(g.length)|0,T=a(b);return T.length===0||g.copy(T,0,0,b),T}if(g.length!==void 0)return typeof g.length!="number"||lt(g.length)?a(0):_(g);if(g.type==="Buffer"&&Array.isArray(g.data))return _(g.data)}function E(g){if(g>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return g|0}function x(g){return+g!=g&&(g=0),c.alloc(+g)}c.isBuffer=function(g){return g!=null&&g._isBuffer===!0&&g!==c.prototype},c.compare=function(g,b){if(rt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),rt(b,Uint8Array)&&(b=c.from(b,b.offset,b.byteLength)),!c.isBuffer(g)||!c.isBuffer(b))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(g===b)return 0;let T=g.length,ce=b.length;for(let fe=0,ve=Math.min(T,ce);fe<ve;++fe)if(g[fe]!==b[fe]){T=g[fe],ce=b[fe];break}return T<ce?-1:ce<T?1:0},c.isEncoding=function(g){switch(String(g).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(g,b){if(!Array.isArray(g))throw new TypeError('"list" argument must be an Array of Buffers');if(g.length===0)return c.alloc(0);let T;if(b===void 0)for(b=0,T=0;T<g.length;++T)b+=g[T].length;const ce=c.allocUnsafe(b);let fe=0;for(T=0;T<g.length;++T){let ve=g[T];if(rt(ve,Uint8Array))fe+ve.length>ce.length?(c.isBuffer(ve)||(ve=c.from(ve)),ve.copy(ce,fe)):Uint8Array.prototype.set.call(ce,ve,fe);else if(c.isBuffer(ve))ve.copy(ce,fe);else throw new TypeError('"list" argument must be an Array of Buffers');fe+=ve.length}return ce};function B(g,b){if(c.isBuffer(g))return g.length;if(ArrayBuffer.isView(g)||rt(g,ArrayBuffer))return g.byteLength;if(typeof g!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof g);const T=g.length,ce=arguments.length>2&&arguments[2]===!0;if(!ce&&T===0)return 0;let fe=!1;for(;;)switch(b){case"ascii":case"latin1":case"binary":return T;case"utf8":case"utf-8":return Me(g).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T*2;case"hex":return T>>>1;case"base64":return st(g).length;default:if(fe)return ce?-1:Me(g).length;b=(""+b).toLowerCase(),fe=!0}}c.byteLength=B;function P(g,b,T){let ce=!1;if((b===void 0||b<0)&&(b=0),b>this.length||((T===void 0||T>this.length)&&(T=this.length),T<=0)||(T>>>=0,b>>>=0,T<=b))return"";for(g||(g="utf8");;)switch(g){case"hex":return re(this,b,T);case"utf8":case"utf-8":return he(this,b,T);case"ascii":return ee(this,b,T);case"latin1":case"binary":return W(this,b,T);case"base64":return q(this,b,T);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ne(this,b,T);default:if(ce)throw new TypeError("Unknown encoding: "+g);g=(g+"").toLowerCase(),ce=!0}}c.prototype._isBuffer=!0;function U(g,b,T){const ce=g[b];g[b]=g[T],g[T]=ce}c.prototype.swap16=function(){const g=this.length;if(g%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let b=0;b<g;b+=2)U(this,b,b+1);return this},c.prototype.swap32=function(){const g=this.length;if(g%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let b=0;b<g;b+=4)U(this,b,b+3),U(this,b+1,b+2);return this},c.prototype.swap64=function(){const g=this.length;if(g%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let b=0;b<g;b+=8)U(this,b,b+7),U(this,b+1,b+6),U(this,b+2,b+5),U(this,b+3,b+4);return this},c.prototype.toString=function(){const g=this.length;return g===0?"":arguments.length===0?he(this,0,g):P.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(g){if(!c.isBuffer(g))throw new TypeError("Argument must be a Buffer");return this===g?!0:c.compare(this,g)===0},c.prototype.inspect=function(){let g="";const b=e.INSPECT_MAX_BYTES;return g=this.toString("hex",0,b).replace(/(.{2})/g,"$1 ").trim(),this.length>b&&(g+=" ... "),"<Buffer "+g+">"},n&&(c.prototype[n]=c.prototype.inspect),c.prototype.compare=function(g,b,T,ce,fe){if(rt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),!c.isBuffer(g))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof g);if(b===void 0&&(b=0),T===void 0&&(T=g?g.length:0),ce===void 0&&(ce=0),fe===void 0&&(fe=this.length),b<0||T>g.length||ce<0||fe>this.length)throw new RangeError("out of range index");if(ce>=fe&&b>=T)return 0;if(ce>=fe)return-1;if(b>=T)return 1;if(b>>>=0,T>>>=0,ce>>>=0,fe>>>=0,this===g)return 0;let ve=fe-ce,Ne=T-b;const tt=Math.min(ve,Ne),ct=this.slice(ce,fe),ot=g.slice(b,T);for(let it=0;it<tt;++it)if(ct[it]!==ot[it]){ve=ct[it],Ne=ot[it];break}return ve<Ne?-1:Ne<ve?1:0};function F(g,b,T,ce,fe){if(g.length===0)return-1;if(typeof T=="string"?(ce=T,T=0):T>2147483647?T=2147483647:T<-2147483648&&(T=-2147483648),T=+T,lt(T)&&(T=fe?0:g.length-1),T<0&&(T=g.length+T),T>=g.length){if(fe)return-1;T=g.length-1}else if(T<0)if(fe)T=0;else return-1;if(typeof b=="string"&&(b=c.from(b,ce)),c.isBuffer(b))return b.length===0?-1:G(g,b,T,ce,fe);if(typeof b=="number")return b=b&255,typeof Uint8Array.prototype.indexOf=="function"?fe?Uint8Array.prototype.indexOf.call(g,b,T):Uint8Array.prototype.lastIndexOf.call(g,b,T):G(g,[b],T,ce,fe);throw new TypeError("val must be string, number or Buffer")}function G(g,b,T,ce,fe){let ve=1,Ne=g.length,tt=b.length;if(ce!==void 0&&(ce=String(ce).toLowerCase(),ce==="ucs2"||ce==="ucs-2"||ce==="utf16le"||ce==="utf-16le")){if(g.length<2||b.length<2)return-1;ve=2,Ne/=2,tt/=2,T/=2}function ct(it,ut){return ve===1?it[ut]:it.readUInt16BE(ut*ve)}let ot;if(fe){let it=-1;for(ot=T;ot<Ne;ot++)if(ct(g,ot)===ct(b,it===-1?0:ot-it)){if(it===-1&&(it=ot),ot-it+1===tt)return it*ve}else it!==-1&&(ot-=ot-it),it=-1}else for(T+tt>Ne&&(T=Ne-tt),ot=T;ot>=0;ot--){let it=!0;for(let ut=0;ut<tt;ut++)if(ct(g,ot+ut)!==ct(b,ut)){it=!1;break}if(it)return ot}return-1}c.prototype.includes=function(g,b,T){return this.indexOf(g,b,T)!==-1},c.prototype.indexOf=function(g,b,T){return F(this,g,b,T,!0)},c.prototype.lastIndexOf=function(g,b,T){return F(this,g,b,T,!1)};function H(g,b,T,ce){T=Number(T)||0;const fe=g.length-T;ce?(ce=Number(ce),ce>fe&&(ce=fe)):ce=fe;const ve=b.length;ce>ve/2&&(ce=ve/2);let Ne;for(Ne=0;Ne<ce;++Ne){const tt=parseInt(b.substr(Ne*2,2),16);if(lt(tt))return Ne;g[T+Ne]=tt}return Ne}function te(g,b,T,ce){return ft(Me(b,g.length-T),g,T,ce)}function J(g,b,T,ce){return ft(We(b),g,T,ce)}function le(g,b,T,ce){return ft(st(b),g,T,ce)}function z(g,b,T,ce){return ft(Fe(b,g.length-T),g,T,ce)}c.prototype.write=function(g,b,T,ce){if(b===void 0)ce="utf8",T=this.length,b=0;else if(T===void 0&&typeof b=="string")ce=b,T=this.length,b=0;else if(isFinite(b))b=b>>>0,isFinite(T)?(T=T>>>0,ce===void 0&&(ce="utf8")):(ce=T,T=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const fe=this.length-b;if((T===void 0||T>fe)&&(T=fe),g.length>0&&(T<0||b<0)||b>this.length)throw new RangeError("Attempt to write outside buffer bounds");ce||(ce="utf8");let ve=!1;for(;;)switch(ce){case"hex":return H(this,g,b,T);case"utf8":case"utf-8":return te(this,g,b,T);case"ascii":case"latin1":case"binary":return J(this,g,b,T);case"base64":return le(this,g,b,T);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return z(this,g,b,T);default:if(ve)throw new TypeError("Unknown encoding: "+ce);ce=(""+ce).toLowerCase(),ve=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function q(g,b,T){return b===0&&T===g.length?t.fromByteArray(g):t.fromByteArray(g.slice(b,T))}function he(g,b,T){T=Math.min(g.length,T);const ce=[];let fe=b;for(;fe<T;){const ve=g[fe];let Ne=null,tt=ve>239?4:ve>223?3:ve>191?2:1;if(fe+tt<=T){let ct,ot,it,ut;switch(tt){case 1:ve<128&&(Ne=ve);break;case 2:ct=g[fe+1],(ct&192)===128&&(ut=(ve&31)<<6|ct&63,ut>127&&(Ne=ut));break;case 3:ct=g[fe+1],ot=g[fe+2],(ct&192)===128&&(ot&192)===128&&(ut=(ve&15)<<12|(ct&63)<<6|ot&63,ut>2047&&(ut<55296||ut>57343)&&(Ne=ut));break;case 4:ct=g[fe+1],ot=g[fe+2],it=g[fe+3],(ct&192)===128&&(ot&192)===128&&(it&192)===128&&(ut=(ve&15)<<18|(ct&63)<<12|(ot&63)<<6|it&63,ut>65535&&ut<1114112&&(Ne=ut))}}Ne===null?(Ne=65533,tt=1):Ne>65535&&(Ne-=65536,ce.push(Ne>>>10&1023|55296),Ne=56320|Ne&1023),ce.push(Ne),fe+=tt}return _e(ce)}const V=4096;function _e(g){const b=g.length;if(b<=V)return String.fromCharCode.apply(String,g);let T="",ce=0;for(;ce<b;)T+=String.fromCharCode.apply(String,g.slice(ce,ce+=V));return T}function ee(g,b,T){let ce="";T=Math.min(g.length,T);for(let fe=b;fe<T;++fe)ce+=String.fromCharCode(g[fe]&127);return ce}function W(g,b,T){let ce="";T=Math.min(g.length,T);for(let fe=b;fe<T;++fe)ce+=String.fromCharCode(g[fe]);return ce}function re(g,b,T){const ce=g.length;(!b||b<0)&&(b=0),(!T||T<0||T>ce)&&(T=ce);let fe="";for(let ve=b;ve<T;++ve)fe+=At[g[ve]];return fe}function ne(g,b,T){const ce=g.slice(b,T);let fe="";for(let ve=0;ve<ce.length-1;ve+=2)fe+=String.fromCharCode(ce[ve]+ce[ve+1]*256);return fe}c.prototype.slice=function(g,b){const T=this.length;g=~~g,b=b===void 0?T:~~b,g<0?(g+=T,g<0&&(g=0)):g>T&&(g=T),b<0?(b+=T,b<0&&(b=0)):b>T&&(b=T),b<g&&(b=g);const ce=this.subarray(g,b);return Object.setPrototypeOf(ce,c.prototype),ce};function ge(g,b,T){if(g%1!==0||g<0)throw new RangeError("offset is not uint");if(g+b>T)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g],fe=1,ve=0;for(;++ve<b&&(fe*=256);)ce+=this[g+ve]*fe;return ce},c.prototype.readUintBE=c.prototype.readUIntBE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g+--b],fe=1;for(;b>0&&(fe*=256);)ce+=this[g+--b]*fe;return ce},c.prototype.readUint8=c.prototype.readUInt8=function(g,b){return g=g>>>0,b||ge(g,1,this.length),this[g]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(g,b){return g=g>>>0,b||ge(g,2,this.length),this[g]|this[g+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(g,b){return g=g>>>0,b||ge(g,2,this.length),this[g]<<8|this[g+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),(this[g]|this[g+1]<<8|this[g+2]<<16)+this[g+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]*16777216+(this[g+1]<<16|this[g+2]<<8|this[g+3])},c.prototype.readBigUInt64LE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=b+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24,fe=this[++g]+this[++g]*2**8+this[++g]*2**16+T*2**24;return BigInt(ce)+(BigInt(fe)<<BigInt(32))}),c.prototype.readBigUInt64BE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=b*2**24+this[++g]*2**16+this[++g]*2**8+this[++g],fe=this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+T;return(BigInt(ce)<<BigInt(32))+BigInt(fe)}),c.prototype.readIntLE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=this[g],fe=1,ve=0;for(;++ve<b&&(fe*=256);)ce+=this[g+ve]*fe;return fe*=128,ce>=fe&&(ce-=Math.pow(2,8*b)),ce},c.prototype.readIntBE=function(g,b,T){g=g>>>0,b=b>>>0,T||ge(g,b,this.length);let ce=b,fe=1,ve=this[g+--ce];for(;ce>0&&(fe*=256);)ve+=this[g+--ce]*fe;return fe*=128,ve>=fe&&(ve-=Math.pow(2,8*b)),ve},c.prototype.readInt8=function(g,b){return g=g>>>0,b||ge(g,1,this.length),this[g]&128?(255-this[g]+1)*-1:this[g]},c.prototype.readInt16LE=function(g,b){g=g>>>0,b||ge(g,2,this.length);const T=this[g]|this[g+1]<<8;return T&32768?T|4294901760:T},c.prototype.readInt16BE=function(g,b){g=g>>>0,b||ge(g,2,this.length);const T=this[g+1]|this[g]<<8;return T&32768?T|4294901760:T},c.prototype.readInt32LE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]|this[g+1]<<8|this[g+2]<<16|this[g+3]<<24},c.prototype.readInt32BE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),this[g]<<24|this[g+1]<<16|this[g+2]<<8|this[g+3]},c.prototype.readBigInt64LE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=this[g+4]+this[g+5]*2**8+this[g+6]*2**16+(T<<24);return(BigInt(ce)<<BigInt(32))+BigInt(b+this[++g]*256+this[++g]*65536+this[++g]*16777216)}),c.prototype.readBigInt64BE=qe(function(g){g=g>>>0,ue(g,"offset");const b=this[g],T=this[g+7];(b===void 0||T===void 0)&&pe(g,this.length-8);const ce=(b<<24)+this[++g]*2**16+this[++g]*2**8+this[++g];return(BigInt(ce)<<BigInt(32))+BigInt(this[++g]*16777216+this[++g]*65536+this[++g]*256+T)}),c.prototype.readFloatLE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),r.read(this,g,!0,23,4)},c.prototype.readFloatBE=function(g,b){return g=g>>>0,b||ge(g,4,this.length),r.read(this,g,!1,23,4)},c.prototype.readDoubleLE=function(g,b){return g=g>>>0,b||ge(g,8,this.length),r.read(this,g,!0,52,8)},c.prototype.readDoubleBE=function(g,b){return g=g>>>0,b||ge(g,8,this.length),r.read(this,g,!1,52,8)};function de(g,b,T,ce,fe,ve){if(!c.isBuffer(g))throw new TypeError('"buffer" argument must be a Buffer instance');if(b>fe||b<ve)throw new RangeError('"value" argument is out of bounds');if(T+ce>g.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(g,b,T,ce){if(g=+g,b=b>>>0,T=T>>>0,!ce){const Ne=Math.pow(2,8*T)-1;de(this,g,b,T,Ne,0)}let fe=1,ve=0;for(this[b]=g&255;++ve<T&&(fe*=256);)this[b+ve]=g/fe&255;return b+T},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(g,b,T,ce){if(g=+g,b=b>>>0,T=T>>>0,!ce){const Ne=Math.pow(2,8*T)-1;de(this,g,b,T,Ne,0)}let fe=T-1,ve=1;for(this[b+fe]=g&255;--fe>=0&&(ve*=256);)this[b+fe]=g/ve&255;return b+T},c.prototype.writeUint8=c.prototype.writeUInt8=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,1,255,0),this[b]=g&255,b+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,65535,0),this[b]=g&255,this[b+1]=g>>>8,b+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,65535,0),this[b]=g>>>8,this[b+1]=g&255,b+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,4294967295,0),this[b+3]=g>>>24,this[b+2]=g>>>16,this[b+1]=g>>>8,this[b]=g&255,b+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,4294967295,0),this[b]=g>>>24,this[b+1]=g>>>16,this[b+2]=g>>>8,this[b+3]=g&255,b+4};function ye(g,b,T,ce,fe){k(b,ce,fe,g,T,7);let ve=Number(b&BigInt(4294967295));g[T++]=ve,ve=ve>>8,g[T++]=ve,ve=ve>>8,g[T++]=ve,ve=ve>>8,g[T++]=ve;let Ne=Number(b>>BigInt(32)&BigInt(4294967295));return g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,Ne=Ne>>8,g[T++]=Ne,T}function Ce(g,b,T,ce,fe){k(b,ce,fe,g,T,7);let ve=Number(b&BigInt(4294967295));g[T+7]=ve,ve=ve>>8,g[T+6]=ve,ve=ve>>8,g[T+5]=ve,ve=ve>>8,g[T+4]=ve;let Ne=Number(b>>BigInt(32)&BigInt(4294967295));return g[T+3]=Ne,Ne=Ne>>8,g[T+2]=Ne,Ne=Ne>>8,g[T+1]=Ne,Ne=Ne>>8,g[T]=Ne,T+8}c.prototype.writeBigUInt64LE=qe(function(g,b=0){return ye(this,g,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=qe(function(g,b=0){return Ce(this,g,b,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(g,b,T,ce){if(g=+g,b=b>>>0,!ce){const tt=Math.pow(2,8*T-1);de(this,g,b,T,tt-1,-tt)}let fe=0,ve=1,Ne=0;for(this[b]=g&255;++fe<T&&(ve*=256);)g<0&&Ne===0&&this[b+fe-1]!==0&&(Ne=1),this[b+fe]=(g/ve>>0)-Ne&255;return b+T},c.prototype.writeIntBE=function(g,b,T,ce){if(g=+g,b=b>>>0,!ce){const tt=Math.pow(2,8*T-1);de(this,g,b,T,tt-1,-tt)}let fe=T-1,ve=1,Ne=0;for(this[b+fe]=g&255;--fe>=0&&(ve*=256);)g<0&&Ne===0&&this[b+fe+1]!==0&&(Ne=1),this[b+fe]=(g/ve>>0)-Ne&255;return b+T},c.prototype.writeInt8=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,1,127,-128),g<0&&(g=255+g+1),this[b]=g&255,b+1},c.prototype.writeInt16LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,32767,-32768),this[b]=g&255,this[b+1]=g>>>8,b+2},c.prototype.writeInt16BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,2,32767,-32768),this[b]=g>>>8,this[b+1]=g&255,b+2},c.prototype.writeInt32LE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,2147483647,-2147483648),this[b]=g&255,this[b+1]=g>>>8,this[b+2]=g>>>16,this[b+3]=g>>>24,b+4},c.prototype.writeInt32BE=function(g,b,T){return g=+g,b=b>>>0,T||de(this,g,b,4,2147483647,-2147483648),g<0&&(g=4294967295+g+1),this[b]=g>>>24,this[b+1]=g>>>16,this[b+2]=g>>>8,this[b+3]=g&255,b+4},c.prototype.writeBigInt64LE=qe(function(g,b=0){return ye(this,g,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=qe(function(g,b=0){return Ce(this,g,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ke(g,b,T,ce,fe,ve){if(T+ce>g.length)throw new RangeError("Index out of range");if(T<0)throw new RangeError("Index out of range")}function ae(g,b,T,ce,fe){return b=+b,T=T>>>0,fe||ke(g,b,T,4),r.write(g,b,T,ce,23,4),T+4}c.prototype.writeFloatLE=function(g,b,T){return ae(this,g,b,!0,T)},c.prototype.writeFloatBE=function(g,b,T){return ae(this,g,b,!1,T)};function Q(g,b,T,ce,fe){return b=+b,T=T>>>0,fe||ke(g,b,T,8),r.write(g,b,T,ce,52,8),T+8}c.prototype.writeDoubleLE=function(g,b,T){return Q(this,g,b,!0,T)},c.prototype.writeDoubleBE=function(g,b,T){return Q(this,g,b,!1,T)},c.prototype.copy=function(g,b,T,ce){if(!c.isBuffer(g))throw new TypeError("argument should be a Buffer");if(T||(T=0),!ce&&ce!==0&&(ce=this.length),b>=g.length&&(b=g.length),b||(b=0),ce>0&&ce<T&&(ce=T),ce===T||g.length===0||this.length===0)return 0;if(b<0)throw new RangeError("targetStart out of bounds");if(T<0||T>=this.length)throw new RangeError("Index out of range");if(ce<0)throw new RangeError("sourceEnd out of bounds");ce>this.length&&(ce=this.length),g.length-b<ce-T&&(ce=g.length-b+T);const fe=ce-T;return this===g&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(b,T,ce):Uint8Array.prototype.set.call(g,this.subarray(T,ce),b),fe},c.prototype.fill=function(g,b,T,ce){if(typeof g=="string"){if(typeof b=="string"?(ce=b,b=0,T=this.length):typeof T=="string"&&(ce=T,T=this.length),ce!==void 0&&typeof ce!="string")throw new TypeError("encoding must be a string");if(typeof ce=="string"&&!c.isEncoding(ce))throw new TypeError("Unknown encoding: "+ce);if(g.length===1){const ve=g.charCodeAt(0);(ce==="utf8"&&ve<128||ce==="latin1")&&(g=ve)}}else typeof g=="number"?g=g&255:typeof g=="boolean"&&(g=Number(g));if(b<0||this.length<b||this.length<T)throw new RangeError("Out of range index");if(T<=b)return this;b=b>>>0,T=T===void 0?this.length:T>>>0,g||(g=0);let fe;if(typeof g=="number")for(fe=b;fe<T;++fe)this[fe]=g;else{const ve=c.isBuffer(g)?g:c.from(g,ce),Ne=ve.length;if(Ne===0)throw new TypeError('The value "'+g+'" is invalid for argument "value"');for(fe=0;fe<T-b;++fe)this[fe+b]=ve[fe%Ne]}return this};const C={};function $(g,b,T){C[g]=class extends T{constructor(){super(),Object.defineProperty(this,"message",{value:b.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${g}]`,this.stack,delete this.name}get code(){return g}set code(ce){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:ce,writable:!0})}toString(){return`${this.name} [${g}]: ${this.message}`}}}$("ERR_BUFFER_OUT_OF_BOUNDS",function(g){return g?`${g} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),$("ERR_INVALID_ARG_TYPE",function(g,b){return`The "${g}" argument must be of type number. Received type ${typeof b}`},TypeError),$("ERR_OUT_OF_RANGE",function(g,b,T){let ce=`The value of "${g}" is out of range.`,fe=T;return Number.isInteger(T)&&Math.abs(T)>4294967296?fe=j(String(T)):typeof T=="bigint"&&(fe=String(T),(T>BigInt(2)**BigInt(32)||T<-(BigInt(2)**BigInt(32)))&&(fe=j(fe)),fe+="n"),ce+=` It must be ${b}. Received ${fe}`,ce},RangeError);function j(g){let b="",T=g.length;const ce=g[0]==="-"?1:0;for(;T>=ce+4;T-=3)b=`_${g.slice(T-3,T)}${b}`;return`${g.slice(0,T)}${b}`}function O(g,b,T){ue(b,"offset"),(g[b]===void 0||g[b+T]===void 0)&&pe(b,g.length-(T+1))}function k(g,b,T,ce,fe,ve){if(g>T||g<b){const Ne=typeof b=="bigint"?"n":"";let tt;throw b===0||b===BigInt(0)?tt=`>= 0${Ne} and < 2${Ne} ** ${(ve+1)*8}${Ne}`:tt=`>= -(2${Ne} ** ${(ve+1)*8-1}${Ne}) and < 2 ** ${(ve+1)*8-1}${Ne}`,new C.ERR_OUT_OF_RANGE("value",tt,g)}O(ce,fe,ve)}function ue(g,b){if(typeof g!="number")throw new C.ERR_INVALID_ARG_TYPE(b,"number",g)}function pe(g,b,T){throw Math.floor(g)!==g?(ue(g,T),new C.ERR_OUT_OF_RANGE("offset","an integer",g)):b<0?new C.ERR_BUFFER_OUT_OF_BOUNDS:new C.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${b}`,g)}const Oe=/[^+/0-9A-Za-z-_]/g;function Le(g){if(g=g.split("=")[0],g=g.trim().replace(Oe,""),g.length<2)return"";for(;g.length%4!==0;)g=g+"=";return g}function Me(g,b){b=b||1/0;let T;const ce=g.length;let fe=null;const ve=[];for(let Ne=0;Ne<ce;++Ne){if(T=g.charCodeAt(Ne),T>55295&&T<57344){if(!fe){if(T>56319){(b-=3)>-1&&ve.push(239,191,189);continue}else if(Ne+1===ce){(b-=3)>-1&&ve.push(239,191,189);continue}fe=T;continue}if(T<56320){(b-=3)>-1&&ve.push(239,191,189),fe=T;continue}T=(fe-55296<<10|T-56320)+65536}else fe&&(b-=3)>-1&&ve.push(239,191,189);if(fe=null,T<128){if((b-=1)<0)break;ve.push(T)}else if(T<2048){if((b-=2)<0)break;ve.push(T>>6|192,T&63|128)}else if(T<65536){if((b-=3)<0)break;ve.push(T>>12|224,T>>6&63|128,T&63|128)}else if(T<1114112){if((b-=4)<0)break;ve.push(T>>18|240,T>>12&63|128,T>>6&63|128,T&63|128)}else throw new Error("Invalid code point")}return ve}function We(g){const b=[];for(let T=0;T<g.length;++T)b.push(g.charCodeAt(T)&255);return b}function Fe(g,b){let T,ce,fe;const ve=[];for(let Ne=0;Ne<g.length&&!((b-=2)<0);++Ne)T=g.charCodeAt(Ne),ce=T>>8,fe=T%256,ve.push(fe),ve.push(ce);return ve}function st(g){return t.toByteArray(Le(g))}function ft(g,b,T,ce){let fe;for(fe=0;fe<ce&&!(fe+T>=b.length||fe>=g.length);++fe)b[fe+T]=g[fe];return fe}function rt(g,b){return g instanceof b||g!=null&&g.constructor!=null&&g.constructor.name!=null&&g.constructor.name===b.name}function lt(g){return g!==g}const At=function(){const g="0123456789abcdef",b=new Array(256);for(let T=0;T<16;++T){const ce=T*16;for(let fe=0;fe<16;++fe)b[ce+fe]=g[T]+g[fe]}return b}();function qe(g){return typeof BigInt>"u"?Je:g}function Je(){throw new Error("BigInt not supported")}}(buffer);const __viteBrowserExternal={},__viteBrowserExternal$1=Object.freeze(Object.defineProperty({__proto__:null,default:__viteBrowserExternal},Symbol.toStringTag,{value:"Module"})),require$$3=getAugmentedNamespace(__viteBrowserExternal$1);var buffer_list,hasRequiredBuffer_list;function requireBuffer_list(){if(hasRequiredBuffer_list)return buffer_list;hasRequiredBuffer_list=1;function e(p,y){var w=Object.keys(p);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(p);y&&(E=E.filter(function(x){return Object.getOwnPropertyDescriptor(p,x).enumerable})),w.push.apply(w,E)}return w}function t(p){for(var y=1;y<arguments.length;y++){var w=arguments[y]!=null?arguments[y]:{};y%2?e(Object(w),!0).forEach(function(E){r(p,E,w[E])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(w)):e(Object(w)).forEach(function(E){Object.defineProperty(p,E,Object.getOwnPropertyDescriptor(w,E))})}return p}function r(p,y,w){return y=a(y),y in p?Object.defineProperty(p,y,{value:w,enumerable:!0,configurable:!0,writable:!0}):p[y]=w,p}function n(p,y){if(!(p instanceof y))throw new TypeError("Cannot call a class as a function")}function o(p,y){for(var w=0;w<y.length;w++){var E=y[w];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(p,a(E.key),E)}}function s(p,y,w){return y&&o(p.prototype,y),Object.defineProperty(p,"prototype",{writable:!1}),p}function a(p){var y=c(p,"string");return typeof y=="symbol"?y:String(y)}function c(p,y){if(typeof p!="object"||p===null)return p;var w=p[Symbol.toPrimitive];if(w!==void 0){var E=w.call(p,y||"default");if(typeof E!="object")return E;throw new TypeError("@@toPrimitive must return a primitive value.")}return(y==="string"?String:Number)(p)}var l=buffer,h=l.Buffer,u=require$$3,d=u.inspect,f=d&&d.custom||"inspect";function _(p,y,w){h.prototype.copy.call(p,y,w)}return buffer_list=function(){function p(){n(this,p),this.head=null,this.tail=null,this.length=0}return s(p,[{key:"push",value:function(y){var w={data:y,next:null};this.length>0?this.tail.next=w:this.head=w,this.tail=w,++this.length}},{key:"unshift",value:function(y){var w={data:y,next:this.head};this.length===0&&(this.tail=w),this.head=w,++this.length}},{key:"shift",value:function(){if(this.length!==0){var y=this.head.data;return this.length===1?this.head=this.tail=null:this.head=this.head.next,--this.length,y}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(y){if(this.length===0)return"";for(var w=this.head,E=""+w.data;w=w.next;)E+=y+w.data;return E}},{key:"concat",value:function(y){if(this.length===0)return h.alloc(0);for(var w=h.allocUnsafe(y>>>0),E=this.head,x=0;E;)_(E.data,w,x),x+=E.data.length,E=E.next;return w}},{key:"consume",value:function(y,w){var E;return y<this.head.data.length?(E=this.head.data.slice(0,y),this.head.data=this.head.data.slice(y)):y===this.head.data.length?E=this.shift():E=w?this._getString(y):this._getBuffer(y),E}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(y){var w=this.head,E=1,x=w.data;for(y-=x.length;w=w.next;){var B=w.data,P=y>B.length?B.length:y;if(P===B.length?x+=B:x+=B.slice(0,y),y-=P,y===0){P===B.length?(++E,w.next?this.head=w.next:this.head=this.tail=null):(this.head=w,w.data=B.slice(P));break}++E}return this.length-=E,x}},{key:"_getBuffer",value:function(y){var w=h.allocUnsafe(y),E=this.head,x=1;for(E.data.copy(w),y-=E.data.length;E=E.next;){var B=E.data,P=y>B.length?B.length:y;if(B.copy(w,w.length-y,0,P),y-=P,y===0){P===B.length?(++x,E.next?this.head=E.next:this.head=this.tail=null):(this.head=E,E.data=B.slice(P));break}++x}return this.length-=x,w}},{key:f,value:function(y,w){return d(this,t(t({},w),{},{depth:0,customInspect:!1}))}}]),p}(),buffer_list}function destroy(e,t){var r=this,n=this._readableState&&this._readableState.destroyed,o=this._writableState&&this._writableState.destroyed;return n||o?(t?t(e):e&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,process.nextTick(emitErrorNT,this,e)):process.nextTick(emitErrorNT,this,e)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,function(s){!t&&s?r._writableState?r._writableState.errorEmitted?process.nextTick(emitCloseNT,r):(r._writableState.errorEmitted=!0,process.nextTick(emitErrorAndCloseNT,r,s)):process.nextTick(emitErrorAndCloseNT,r,s):t?(process.nextTick(emitCloseNT,r),t(s)):process.nextTick(emitCloseNT,r)}),this)}function emitErrorAndCloseNT(e,t){emitErrorNT(e,t),emitCloseNT(e)}function emitCloseNT(e){e._writableState&&!e._writableState.emitClose||e._readableState&&!e._readableState.emitClose||e.emit("close")}function undestroy(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}function emitErrorNT(e,t){e.emit("error",t)}function errorOrDestroy(e,t){var r=e._readableState,n=e._writableState;r&&r.autoDestroy||n&&n.autoDestroy?e.destroy(t):e.emit("error",t)}var destroy_1={destroy,undestroy,errorOrDestroy},errorsBrowser={};function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var codes$1={};function createErrorType(e,t,r){r||(r=Error);function n(s,a,c){return typeof t=="string"?t:t(s,a,c)}var o=function(s){_inheritsLoose(a,s);function a(c,l,h){return s.call(this,n(c,l,h))||this}return a}(r);o.prototype.name=r.name,o.prototype.code=e,codes$1[e]=o}function oneOf(e,t){if(Array.isArray(e)){var r=e.length;return e=e.map(function(n){return String(n)}),r>2?"one of ".concat(t," ").concat(e.slice(0,r-1).join(", "),", or ")+e[r-1]:r===2?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}else return"of ".concat(t," ").concat(String(e))}function startsWith(e,t,r){return e.substr(0,t.length)===t}function endsWith(e,t,r){return(r===void 0||r>e.length)&&(r=e.length),e.substring(r-t.length,r)===t}function includes(e,t,r){return typeof r!="number"&&(r=0),r+t.length>e.length?!1:e.indexOf(t,r)!==-1}createErrorType("ERR_INVALID_OPT_VALUE",function(e,t){return'The value "'+t+'" is invalid for option "'+e+'"'},TypeError),createErrorType("ERR_INVALID_ARG_TYPE",function(e,t,r){var n;typeof t=="string"&&startsWith(t,"not ")?(n="must not be",t=t.replace(/^not /,"")):n="must be";var o;if(endsWith(e," argument"))o="The ".concat(e," ").concat(n," ").concat(oneOf(t,"type"));else{var s=includes(e,".")?"property":"argument";o='The "'.concat(e,'" ').concat(s," ").concat(n," ").concat(oneOf(t,"type"))}return o+=". Received type ".concat(typeof r),o},TypeError),createErrorType("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),createErrorType("ERR_METHOD_NOT_IMPLEMENTED",function(e){return"The "+e+" method is not implemented"}),createErrorType("ERR_STREAM_PREMATURE_CLOSE","Premature close"),createErrorType("ERR_STREAM_DESTROYED",function(e){return"Cannot call "+e+" after a stream was destroyed"}),createErrorType("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),createErrorType("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),createErrorType("ERR_STREAM_WRITE_AFTER_END","write after end"),createErrorType("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),createErrorType("ERR_UNKNOWN_ENCODING",function(e){return"Unknown encoding: "+e},TypeError),createErrorType("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),errorsBrowser.codes=codes$1;var ERR_INVALID_OPT_VALUE=errorsBrowser.codes.ERR_INVALID_OPT_VALUE;function highWaterMarkFrom(e,t,r){return e.highWaterMark!=null?e.highWaterMark:t?e[r]:null}function getHighWaterMark(e,t,r,n){var o=highWaterMarkFrom(t,n,r);if(o!=null){if(!(isFinite(o)&&Math.floor(o)===o)||o<0){var s=n?r:"highWaterMark";throw new ERR_INVALID_OPT_VALUE(s,o)}return Math.floor(o)}return e.objectMode?16:16384}var state={getHighWaterMark},inherits_browser={exports:{}};typeof Object.create=="function"?inherits_browser.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:inherits_browser.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}};var inherits_browserExports=inherits_browser.exports;const import$inherits=getDefaultExportFromCjs(inherits_browserExports);var browser$4=deprecate;function deprecate(e,t){if(config$1("noDeprecation"))return e;var r=!1;function n(){if(!r){if(config$1("throwDeprecation"))throw new Error(t);config$1("traceDeprecation")?console.trace(t):console.warn(t),r=!0}return e.apply(this,arguments)}return n}function config$1(e){try{if(!commonjsGlobal.localStorage)return!1}catch{return!1}var t=commonjsGlobal.localStorage[e];return t==null?!1:String(t).toLowerCase()==="true"}var _stream_writable,hasRequired_stream_writable;function require_stream_writable(){if(hasRequired_stream_writable)return _stream_writable;hasRequired_stream_writable=1,_stream_writable=H;function e(ae){var Q=this;this.next=null,this.entry=null,this.finish=function(){ke(Q,ae)}}var t;H.WritableState=F;var r={deprecate:browser$4},n=streamBrowser,o=buffer.Buffer,s=(typeof commonjsGlobal<"u"?commonjsGlobal:typeof window<"u"?window:typeof self<"u"?self:{}).Uint8Array||function(){};function a(ae){return o.from(ae)}function c(ae){return o.isBuffer(ae)||ae instanceof s}var l=destroy_1,h=state,u=h.getHighWaterMark,d=errorsBrowser.codes,f=d.ERR_INVALID_ARG_TYPE,_=d.ERR_METHOD_NOT_IMPLEMENTED,p=d.ERR_MULTIPLE_CALLBACK,y=d.ERR_STREAM_CANNOT_PIPE,w=d.ERR_STREAM_DESTROYED,E=d.ERR_STREAM_NULL_VALUES,x=d.ERR_STREAM_WRITE_AFTER_END,B=d.ERR_UNKNOWN_ENCODING,P=l.errorOrDestroy;inherits_browserExports(H,n);function U(){}function F(ae,Q,C){t=t||require_stream_duplex(),ae=ae||{},typeof C!="boolean"&&(C=Q instanceof t),this.objectMode=!!ae.objectMode,C&&(this.objectMode=this.objectMode||!!ae.writableObjectMode),this.highWaterMark=u(this,ae,"writableHighWaterMark",C),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var $=ae.decodeStrings===!1;this.decodeStrings=!$,this.defaultEncoding=ae.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(j){_e(Q,j)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=ae.emitClose!==!1,this.autoDestroy=!!ae.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new e(this)}F.prototype.getBuffer=function(){for(var ae=this.bufferedRequest,Q=[];ae;)Q.push(ae),ae=ae.next;return Q},function(){try{Object.defineProperty(F.prototype,"buffer",{get:r.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}();var G;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(G=Function.prototype[Symbol.hasInstance],Object.defineProperty(H,Symbol.hasInstance,{value:function(ae){return G.call(this,ae)?!0:this!==H?!1:ae&&ae._writableState instanceof F}})):G=function(ae){return ae instanceof this};function H(ae){t=t||require_stream_duplex();var Q=this instanceof t;if(!Q&&!G.call(H,this))return new H(ae);this._writableState=new F(ae,this,Q),this.writable=!0,ae&&(typeof ae.write=="function"&&(this._write=ae.write),typeof ae.writev=="function"&&(this._writev=ae.writev),typeof ae.destroy=="function"&&(this._destroy=ae.destroy),typeof ae.final=="function"&&(this._final=ae.final)),n.call(this)}H.prototype.pipe=function(){P(this,new y)};function te(ae,Q){var C=new x;P(ae,C),process.nextTick(Q,C)}function J(ae,Q,C,$){var j;return C===null?j=new E:typeof C!="string"&&!Q.objectMode&&(j=new f("chunk",["string","Buffer"],C)),j?(P(ae,j),process.nextTick($,j),!1):!0}H.prototype.write=function(ae,Q,C){var $=this._writableState,j=!1,O=!$.objectMode&&c(ae);return O&&!o.isBuffer(ae)&&(ae=a(ae)),typeof Q=="function"&&(C=Q,Q=null),O?Q="buffer":Q||(Q=$.defaultEncoding),typeof C!="function"&&(C=U),$.ending?te(this,C):(O||J(this,$,ae,C))&&($.pendingcb++,j=z(this,$,O,ae,Q,C)),j},H.prototype.cork=function(){this._writableState.corked++},H.prototype.uncork=function(){var ae=this._writableState;ae.corked&&(ae.corked--,!ae.writing&&!ae.corked&&!ae.bufferProcessing&&ae.bufferedRequest&&re(this,ae))},H.prototype.setDefaultEncoding=function(ae){if(typeof ae=="string"&&(ae=ae.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((ae+"").toLowerCase())>-1))throw new B(ae);return this._writableState.defaultEncoding=ae,this},Object.defineProperty(H.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}});function le(ae,Q,C){return!ae.objectMode&&ae.decodeStrings!==!1&&typeof Q=="string"&&(Q=o.from(Q,C)),Q}Object.defineProperty(H.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}});function z(ae,Q,C,$,j,O){if(!C){var k=le(Q,$,j);$!==k&&(C=!0,j="buffer",$=k)}var ue=Q.objectMode?1:$.length;Q.length+=ue;var pe=Q.length<Q.highWaterMark;if(pe||(Q.needDrain=!0),Q.writing||Q.corked){var Oe=Q.lastBufferedRequest;Q.lastBufferedRequest={chunk:$,encoding:j,isBuf:C,callback:O,next:null},Oe?Oe.next=Q.lastBufferedRequest:Q.bufferedRequest=Q.lastBufferedRequest,Q.bufferedRequestCount+=1}else q(ae,Q,!1,ue,$,j,O);return pe}function q(ae,Q,C,$,j,O,k){Q.writelen=$,Q.writecb=k,Q.writing=!0,Q.sync=!0,Q.destroyed?Q.onwrite(new w("write")):C?ae._writev(j,Q.onwrite):ae._write(j,O,Q.onwrite),Q.sync=!1}function he(ae,Q,C,$,j){--Q.pendingcb,C?(process.nextTick(j,$),process.nextTick(ye,ae,Q),ae._writableState.errorEmitted=!0,P(ae,$)):(j($),ae._writableState.errorEmitted=!0,P(ae,$),ye(ae,Q))}function V(ae){ae.writing=!1,ae.writecb=null,ae.length-=ae.writelen,ae.writelen=0}function _e(ae,Q){var C=ae._writableState,$=C.sync,j=C.writecb;if(typeof j!="function")throw new p;if(V(C),Q)he(ae,C,$,Q,j);else{var O=ne(C)||ae.destroyed;!O&&!C.corked&&!C.bufferProcessing&&C.bufferedRequest&&re(ae,C),$?process.nextTick(ee,ae,C,O,j):ee(ae,C,O,j)}}function ee(ae,Q,C,$){C||W(ae,Q),Q.pendingcb--,$(),ye(ae,Q)}function W(ae,Q){Q.length===0&&Q.needDrain&&(Q.needDrain=!1,ae.emit("drain"))}function re(ae,Q){Q.bufferProcessing=!0;var C=Q.bufferedRequest;if(ae._writev&&C&&C.next){var $=Q.bufferedRequestCount,j=new Array($),O=Q.corkedRequestsFree;O.entry=C;for(var k=0,ue=!0;C;)j[k]=C,C.isBuf||(ue=!1),C=C.next,k+=1;j.allBuffers=ue,q(ae,Q,!0,Q.length,j,"",O.finish),Q.pendingcb++,Q.lastBufferedRequest=null,O.next?(Q.corkedRequestsFree=O.next,O.next=null):Q.corkedRequestsFree=new e(Q),Q.bufferedRequestCount=0}else{for(;C;){var pe=C.chunk,Oe=C.encoding,Le=C.callback,Me=Q.objectMode?1:pe.length;if(q(ae,Q,!1,Me,pe,Oe,Le),C=C.next,Q.bufferedRequestCount--,Q.writing)break}C===null&&(Q.lastBufferedRequest=null)}Q.bufferedRequest=C,Q.bufferProcessing=!1}H.prototype._write=function(ae,Q,C){C(new _("_write()"))},H.prototype._writev=null,H.prototype.end=function(ae,Q,C){var $=this._writableState;return typeof ae=="function"?(C=ae,ae=null,Q=null):typeof Q=="function"&&(C=Q,Q=null),ae!=null&&this.write(ae,Q),$.corked&&($.corked=1,this.uncork()),$.ending||Ce(this,$,C),this},Object.defineProperty(H.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function ne(ae){return ae.ending&&ae.length===0&&ae.bufferedRequest===null&&!ae.finished&&!ae.writing}function ge(ae,Q){ae._final(function(C){Q.pendingcb--,C&&P(ae,C),Q.prefinished=!0,ae.emit("prefinish"),ye(ae,Q)})}function de(ae,Q){!Q.prefinished&&!Q.finalCalled&&(typeof ae._final=="function"&&!Q.destroyed?(Q.pendingcb++,Q.finalCalled=!0,process.nextTick(ge,ae,Q)):(Q.prefinished=!0,ae.emit("prefinish")))}function ye(ae,Q){var C=ne(Q);if(C&&(de(ae,Q),Q.pendingcb===0&&(Q.finished=!0,ae.emit("finish"),Q.autoDestroy))){var $=ae._readableState;(!$||$.autoDestroy&&$.endEmitted)&&ae.destroy()}return C}function Ce(ae,Q,C){Q.ending=!0,ye(ae,Q),C&&(Q.finished?process.nextTick(C):ae.once("finish",C)),Q.ended=!0,ae.writable=!1}function ke(ae,Q,C){var $=ae.entry;for(ae.entry=null;$;){var j=$.callback;Q.pendingcb--,j(C),$=$.next}Q.corkedRequestsFree.next=ae}return Object.defineProperty(H.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState===void 0?!1:this._writableState.destroyed},set:function(ae){this._writableState&&(this._writableState.destroyed=ae)}}),H.prototype.destroy=l.destroy,H.prototype._undestroy=l.undestroy,H.prototype._destroy=function(ae,Q){Q(ae)},_stream_writable}var _stream_duplex,hasRequired_stream_duplex;function require_stream_duplex(){if(hasRequired_stream_duplex)return _stream_duplex;hasRequired_stream_duplex=1;var e=Object.keys||function(h){var u=[];for(var d in h)u.push(d);return u};_stream_duplex=a;var t=require_stream_readable(),r=require_stream_writable();inherits_browserExports(a,t);for(var n=e(r.prototype),o=0;o<n.length;o++){var s=n[o];a.prototype[s]||(a.prototype[s]=r.prototype[s])}function a(h){if(!(this instanceof a))return new a(h);t.call(this,h),r.call(this,h),this.allowHalfOpen=!0,h&&(h.readable===!1&&(this.readable=!1),h.writable===!1&&(this.writable=!1),h.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",c)))}Object.defineProperty(a.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(a.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(a.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}});function c(){this._writableState.ended||process.nextTick(l,this)}function l(h){h.end()}return Object.defineProperty(a.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0||this._writableState===void 0?!1:this._readableState.destroyed&&this._writableState.destroyed},set:function(h){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=h,this._writableState.destroyed=h)}}),_stream_duplex}var string_decoder={},safeBuffer={exports:{}};(function(e,t){var r=buffer,n=r.Buffer;function o(a,c){for(var l in a)c[l]=a[l]}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?e.exports=r:(o(r,t),t.Buffer=s);function s(a,c,l){return n(a,c,l)}s.prototype=Object.create(n.prototype),o(n,s),s.from=function(a,c,l){if(typeof a=="number")throw new TypeError("Argument must not be a number");return n(a,c,l)},s.alloc=function(a,c,l){if(typeof a!="number")throw new TypeError("Argument must be a number");var h=n(a);return c!==void 0?typeof l=="string"?h.fill(c,l):h.fill(c):h.fill(0),h},s.allocUnsafe=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return n(a)},s.allocUnsafeSlow=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return r.SlowBuffer(a)}})(safeBuffer,safeBuffer.exports);var safeBufferExports=safeBuffer.exports,hasRequiredString_decoder;function requireString_decoder(){if(hasRequiredString_decoder)return string_decoder;hasRequiredString_decoder=1;var e=safeBufferExports.Buffer,t=e.isEncoding||function(E){switch(E=""+E,E&&E.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function r(E){if(!E)return"utf8";for(var x;;)switch(E){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return E;default:if(x)return;E=(""+E).toLowerCase(),x=!0}}function n(E){var x=r(E);if(typeof x!="string"&&(e.isEncoding===t||!t(E)))throw new Error("Unknown encoding: "+E);return x||E}string_decoder.StringDecoder=o;function o(E){this.encoding=n(E);var x;switch(this.encoding){case"utf16le":this.text=d,this.end=f,x=4;break;case"utf8":this.fillLast=l,x=4;break;case"base64":this.text=_,this.end=p,x=3;break;default:this.write=y,this.end=w;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=e.allocUnsafe(x)}o.prototype.write=function(E){if(E.length===0)return"";var x,B;if(this.lastNeed){if(x=this.fillLast(E),x===void 0)return"";B=this.lastNeed,this.lastNeed=0}else B=0;return B<E.length?x?x+this.text(E,B):this.text(E,B):x||""},o.prototype.end=u,o.prototype.text=h,o.prototype.fillLast=function(E){if(this.lastNeed<=E.length)return E.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);E.copy(this.lastChar,this.lastTotal-this.lastNeed,0,E.length),this.lastNeed-=E.length};function s(E){return E<=127?0:E>>5===6?2:E>>4===14?3:E>>3===30?4:E>>6===2?-1:-2}function a(E,x,B){var P=x.length-1;if(P<B)return 0;var U=s(x[P]);return U>=0?(U>0&&(E.lastNeed=U-1),U):--P<B||U===-2?0:(U=s(x[P]),U>=0?(U>0&&(E.lastNeed=U-2),U):--P<B||U===-2?0:(U=s(x[P]),U>=0?(U>0&&(U===2?U=0:E.lastNeed=U-3),U):0))}function c(E,x,B){if((x[0]&192)!==128)return E.lastNeed=0,"\uFFFD";if(E.lastNeed>1&&x.length>1){if((x[1]&192)!==128)return E.lastNeed=1,"\uFFFD";if(E.lastNeed>2&&x.length>2&&(x[2]&192)!==128)return E.lastNeed=2,"\uFFFD"}}function l(E){var x=this.lastTotal-this.lastNeed,B=c(this,E);if(B!==void 0)return B;if(this.lastNeed<=E.length)return E.copy(this.lastChar,x,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);E.copy(this.lastChar,x,0,E.length),this.lastNeed-=E.length}function h(E,x){var B=a(this,E,x);if(!this.lastNeed)return E.toString("utf8",x);this.lastTotal=B;var P=E.length-(B-this.lastNeed);return E.copy(this.lastChar,0,P),E.toString("utf8",x,P)}function u(E){var x=E&&E.length?this.write(E):"";return this.lastNeed?x+"\uFFFD":x}function d(E,x){if((E.length-x)%2===0){var B=E.toString("utf16le",x);if(B){var P=B.charCodeAt(B.length-1);if(P>=55296&&P<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=E[E.length-2],this.lastChar[1]=E[E.length-1],B.slice(0,-1)}return B}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=E[E.length-1],E.toString("utf16le",x,E.length-1)}function f(E){var x=E&&E.length?this.write(E):"";if(this.lastNeed){var B=this.lastTotal-this.lastNeed;return x+this.lastChar.toString("utf16le",0,B)}return x}function _(E,x){var B=(E.length-x)%3;return B===0?E.toString("base64",x):(this.lastNeed=3-B,this.lastTotal=3,B===1?this.lastChar[0]=E[E.length-1]:(this.lastChar[0]=E[E.length-2],this.lastChar[1]=E[E.length-1]),E.toString("base64",x,E.length-B))}function p(E){var x=E&&E.length?this.write(E):"";return this.lastNeed?x+this.lastChar.toString("base64",0,3-this.lastNeed):x}function y(E){return E.toString(this.encoding)}function w(E){return E&&E.length?this.write(E):""}return string_decoder}var ERR_STREAM_PREMATURE_CLOSE=errorsBrowser.codes.ERR_STREAM_PREMATURE_CLOSE;function once$3(e){var t=!1;return function(){if(!t){t=!0;for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];e.apply(this,n)}}}function noop$9(){}function isRequest$1(e){return e.setHeader&&typeof e.abort=="function"}function eos$1(e,t,r){if(typeof t=="function")return eos$1(e,null,t);t||(t={}),r=once$3(r||noop$9);var n=t.readable||t.readable!==!1&&e.readable,o=t.writable||t.writable!==!1&&e.writable,s=function(){e.writable||c()},a=e._writableState&&e._writableState.finished,c=function(){o=!1,a=!0,n||r.call(e)},l=e._readableState&&e._readableState.endEmitted,h=function(){n=!1,l=!0,o||r.call(e)},u=function(_){r.call(e,_)},d=function(){var _;if(n&&!l)return(!e._readableState||!e._readableState.ended)&&(_=new ERR_STREAM_PREMATURE_CLOSE),r.call(e,_);if(o&&!a)return(!e._writableState||!e._writableState.ended)&&(_=new ERR_STREAM_PREMATURE_CLOSE),r.call(e,_)},f=function(){e.req.on("finish",c)};return isRequest$1(e)?(e.on("complete",c),e.on("abort",d),e.req?f():e.on("request",f)):o&&!e._writableState&&(e.on("end",s),e.on("close",s)),e.on("end",h),e.on("finish",c),t.error!==!1&&e.on("error",u),e.on("close",d),function(){e.removeListener("complete",c),e.removeListener("abort",d),e.removeListener("request",f),e.req&&e.req.removeListener("finish",c),e.removeListener("end",s),e.removeListener("close",s),e.removeListener("finish",c),e.removeListener("end",h),e.removeListener("error",u),e.removeListener("close",d)}}var endOfStream=eos$1,async_iterator,hasRequiredAsync_iterator;function requireAsync_iterator(){if(hasRequiredAsync_iterator)return async_iterator;hasRequiredAsync_iterator=1;var e;function t(B,P,U){return P=r(P),P in B?Object.defineProperty(B,P,{value:U,enumerable:!0,configurable:!0,writable:!0}):B[P]=U,B}function r(B){var P=n(B,"string");return typeof P=="symbol"?P:String(P)}function n(B,P){if(typeof B!="object"||B===null)return B;var U=B[Symbol.toPrimitive];if(U!==void 0){var F=U.call(B,P||"default");if(typeof F!="object")return F;throw new TypeError("@@toPrimitive must return a primitive value.")}return(P==="string"?String:Number)(B)}var o=endOfStream,s=Symbol("lastResolve"),a=Symbol("lastReject"),c=Symbol("error"),l=Symbol("ended"),h=Symbol("lastPromise"),u=Symbol("handlePromise"),d=Symbol("stream");function f(B,P){return{value:B,done:P}}function _(B){var P=B[s];if(P!==null){var U=B[d].read();U!==null&&(B[h]=null,B[s]=null,B[a]=null,P(f(U,!1)))}}function p(B){process.nextTick(_,B)}function y(B,P){return function(U,F){B.then(function(){if(P[l]){U(f(void 0,!0));return}P[u](U,F)},F)}}var w=Object.getPrototypeOf(function(){}),E=Object.setPrototypeOf((e={get stream(){return this[d]},next:function(){var B=this,P=this[c];if(P!==null)return Promise.reject(P);if(this[l])return Promise.resolve(f(void 0,!0));if(this[d].destroyed)return new Promise(function(H,te){process.nextTick(function(){B[c]?te(B[c]):H(f(void 0,!0))})});var U=this[h],F;if(U)F=new Promise(y(U,this));else{var G=this[d].read();if(G!==null)return Promise.resolve(f(G,!1));F=new Promise(this[u])}return this[h]=F,F}},t(e,Symbol.asyncIterator,function(){return this}),t(e,"return",function(){var B=this;return new Promise(function(P,U){B[d].destroy(null,function(F){if(F){U(F);return}P(f(void 0,!0))})})}),e),w),x=function(B){var P,U=Object.create(E,(P={},t(P,d,{value:B,writable:!0}),t(P,s,{value:null,writable:!0}),t(P,a,{value:null,writable:!0}),t(P,c,{value:null,writable:!0}),t(P,l,{value:B._readableState.endEmitted,writable:!0}),t(P,u,{value:function(F,G){var H=U[d].read();H?(U[h]=null,U[s]=null,U[a]=null,F(f(H,!1))):(U[s]=F,U[a]=G)},writable:!0}),P));return U[h]=null,o(B,function(F){if(F&&F.code!=="ERR_STREAM_PREMATURE_CLOSE"){var G=U[a];G!==null&&(U[h]=null,U[s]=null,U[a]=null,G(F)),U[c]=F;return}var H=U[s];H!==null&&(U[h]=null,U[s]=null,U[a]=null,H(f(void 0,!0))),U[l]=!0}),B.on("readable",p.bind(null,U)),U};return async_iterator=x,async_iterator}var fromBrowser,hasRequiredFromBrowser;function requireFromBrowser(){return hasRequiredFromBrowser||(hasRequiredFromBrowser=1,fromBrowser=function(){throw new Error("Readable.from is not available in the browser")}),fromBrowser}var _stream_readable,hasRequired_stream_readable;function require_stream_readable(){if(hasRequired_stream_readable)return _stream_readable;hasRequired_stream_readable=1,_stream_readable=te;var e;te.ReadableState=H,eventsExports.EventEmitter;var t=function(O,k){return O.listeners(k).length},r=streamBrowser,n=buffer.Buffer,o=(typeof commonjsGlobal<"u"?commonjsGlobal:typeof window<"u"?window:typeof self<"u"?self:{}).Uint8Array||function(){};function s(O){return n.from(O)}function a(O){return n.isBuffer(O)||O instanceof o}var c=require$$3,l;c&&c.debuglog?l=c.debuglog("stream"):l=function(){};var h=requireBuffer_list(),u=destroy_1,d=state,f=d.getHighWaterMark,_=errorsBrowser.codes,p=_.ERR_INVALID_ARG_TYPE,y=_.ERR_STREAM_PUSH_AFTER_EOF,w=_.ERR_METHOD_NOT_IMPLEMENTED,E=_.ERR_STREAM_UNSHIFT_AFTER_END_EVENT,x,B,P;inherits_browserExports(te,r);var U=u.errorOrDestroy,F=["error","close","destroy","pause","resume"];function G(O,k,ue){if(typeof O.prependListener=="function")return O.prependListener(k,ue);!O._events||!O._events[k]?O.on(k,ue):Array.isArray(O._events[k])?O._events[k].unshift(ue):O._events[k]=[ue,O._events[k]]}function H(O,k,ue){e=e||require_stream_duplex(),O=O||{},typeof ue!="boolean"&&(ue=k instanceof e),this.objectMode=!!O.objectMode,ue&&(this.objectMode=this.objectMode||!!O.readableObjectMode),this.highWaterMark=f(this,O,"readableHighWaterMark",ue),this.buffer=new h,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=O.emitClose!==!1,this.autoDestroy=!!O.autoDestroy,this.destroyed=!1,this.defaultEncoding=O.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,O.encoding&&(x||(x=requireString_decoder().StringDecoder),this.decoder=new x(O.encoding),this.encoding=O.encoding)}function te(O){if(e=e||require_stream_duplex(),!(this instanceof te))return new te(O);var k=this instanceof e;this._readableState=new H(O,this,k),this.readable=!0,O&&(typeof O.read=="function"&&(this._read=O.read),typeof O.destroy=="function"&&(this._destroy=O.destroy)),r.call(this)}Object.defineProperty(te.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState===void 0?!1:this._readableState.destroyed},set:function(O){this._readableState&&(this._readableState.destroyed=O)}}),te.prototype.destroy=u.destroy,te.prototype._undestroy=u.undestroy,te.prototype._destroy=function(O,k){k(O)},te.prototype.push=function(O,k){var ue=this._readableState,pe;return ue.objectMode?pe=!0:typeof O=="string"&&(k=k||ue.defaultEncoding,k!==ue.encoding&&(O=n.from(O,k),k=""),pe=!0),J(this,O,k,!1,pe)},te.prototype.unshift=function(O){return J(this,O,null,!0,!1)};function J(O,k,ue,pe,Oe){l("readableAddChunk",k);var Le=O._readableState;if(k===null)Le.reading=!1,_e(O,Le);else{var Me;if(Oe||(Me=z(Le,k)),Me)U(O,Me);else if(Le.objectMode||k&&k.length>0)if(typeof k!="string"&&!Le.objectMode&&Object.getPrototypeOf(k)!==n.prototype&&(k=s(k)),pe)Le.endEmitted?U(O,new E):le(O,Le,k,!0);else if(Le.ended)U(O,new y);else{if(Le.destroyed)return!1;Le.reading=!1,Le.decoder&&!ue?(k=Le.decoder.write(k),Le.objectMode||k.length!==0?le(O,Le,k,!1):re(O,Le)):le(O,Le,k,!1)}else pe||(Le.reading=!1,re(O,Le))}return!Le.ended&&(Le.length<Le.highWaterMark||Le.length===0)}function le(O,k,ue,pe){k.flowing&&k.length===0&&!k.sync?(k.awaitDrain=0,O.emit("data",ue)):(k.length+=k.objectMode?1:ue.length,pe?k.buffer.unshift(ue):k.buffer.push(ue),k.needReadable&&ee(O)),re(O,k)}function z(O,k){var ue;return!a(k)&&typeof k!="string"&&k!==void 0&&!O.objectMode&&(ue=new p("chunk",["string","Buffer","Uint8Array"],k)),ue}te.prototype.isPaused=function(){return this._readableState.flowing===!1},te.prototype.setEncoding=function(O){x||(x=requireString_decoder().StringDecoder);var k=new x(O);this._readableState.decoder=k,this._readableState.encoding=this._readableState.decoder.encoding;for(var ue=this._readableState.buffer.head,pe="";ue!==null;)pe+=k.write(ue.data),ue=ue.next;return this._readableState.buffer.clear(),pe!==""&&this._readableState.buffer.push(pe),this._readableState.length=pe.length,this};var q=1073741824;function he(O){return O>=q?O=q:(O--,O|=O>>>1,O|=O>>>2,O|=O>>>4,O|=O>>>8,O|=O>>>16,O++),O}function V(O,k){return O<=0||k.length===0&&k.ended?0:k.objectMode?1:O!==O?k.flowing&&k.length?k.buffer.head.data.length:k.length:(O>k.highWaterMark&&(k.highWaterMark=he(O)),O<=k.length?O:k.ended?k.length:(k.needReadable=!0,0))}te.prototype.read=function(O){l("read",O),O=parseInt(O,10);var k=this._readableState,ue=O;if(O!==0&&(k.emittedReadable=!1),O===0&&k.needReadable&&((k.highWaterMark!==0?k.length>=k.highWaterMark:k.length>0)||k.ended))return l("read: emitReadable",k.length,k.ended),k.length===0&&k.ended?C(this):ee(this),null;if(O=V(O,k),O===0&&k.ended)return k.length===0&&C(this),null;var pe=k.needReadable;l("need readable",pe),(k.length===0||k.length-O<k.highWaterMark)&&(pe=!0,l("length less than watermark",pe)),k.ended||k.reading?(pe=!1,l("reading or ended",pe)):pe&&(l("do read"),k.reading=!0,k.sync=!0,k.length===0&&(k.needReadable=!0),this._read(k.highWaterMark),k.sync=!1,k.reading||(O=V(ue,k)));var Oe;return O>0?Oe=Q(O,k):Oe=null,Oe===null?(k.needReadable=k.length<=k.highWaterMark,O=0):(k.length-=O,k.awaitDrain=0),k.length===0&&(k.ended||(k.needReadable=!0),ue!==O&&k.ended&&C(this)),Oe!==null&&this.emit("data",Oe),Oe};function _e(O,k){if(l("onEofChunk"),!k.ended){if(k.decoder){var ue=k.decoder.end();ue&&ue.length&&(k.buffer.push(ue),k.length+=k.objectMode?1:ue.length)}k.ended=!0,k.sync?ee(O):(k.needReadable=!1,k.emittedReadable||(k.emittedReadable=!0,W(O)))}}function ee(O){var k=O._readableState;l("emitReadable",k.needReadable,k.emittedReadable),k.needReadable=!1,k.emittedReadable||(l("emitReadable",k.flowing),k.emittedReadable=!0,process.nextTick(W,O))}function W(O){var k=O._readableState;l("emitReadable_",k.destroyed,k.length,k.ended),!k.destroyed&&(k.length||k.ended)&&(O.emit("readable"),k.emittedReadable=!1),k.needReadable=!k.flowing&&!k.ended&&k.length<=k.highWaterMark,ae(O)}function re(O,k){k.readingMore||(k.readingMore=!0,process.nextTick(ne,O,k))}function ne(O,k){for(;!k.reading&&!k.ended&&(k.length<k.highWaterMark||k.flowing&&k.length===0);){var ue=k.length;if(l("maybeReadMore read 0"),O.read(0),ue===k.length)break}k.readingMore=!1}te.prototype._read=function(O){U(this,new w("_read()"))},te.prototype.pipe=function(O,k){var ue=this,pe=this._readableState;switch(pe.pipesCount){case 0:pe.pipes=O;break;case 1:pe.pipes=[pe.pipes,O];break;default:pe.pipes.push(O);break}pe.pipesCount+=1,l("pipe count=%d opts=%j",pe.pipesCount,k);var Oe=(!k||k.end!==!1)&&O!==process.stdout&&O!==process.stderr,Le=Oe?We:Je;pe.endEmitted?process.nextTick(Le):ue.once("end",Le),O.on("unpipe",Me);function Me(g,b){l("onunpipe"),g===ue&&b&&b.hasUnpiped===!1&&(b.hasUnpiped=!0,ft())}function We(){l("onend"),O.end()}var Fe=ge(ue);O.on("drain",Fe);var st=!1;function ft(){l("cleanup"),O.removeListener("close",At),O.removeListener("finish",qe),O.removeListener("drain",Fe),O.removeListener("error",lt),O.removeListener("unpipe",Me),ue.removeListener("end",We),ue.removeListener("end",Je),ue.removeListener("data",rt),st=!0,pe.awaitDrain&&(!O._writableState||O._writableState.needDrain)&&Fe()}ue.on("data",rt);function rt(g){l("ondata");var b=O.write(g);l("dest.write",b),b===!1&&((pe.pipesCount===1&&pe.pipes===O||pe.pipesCount>1&&j(pe.pipes,O)!==-1)&&!st&&(l("false write response, pause",pe.awaitDrain),pe.awaitDrain++),ue.pause())}function lt(g){l("onerror",g),Je(),O.removeListener("error",lt),t(O,"error")===0&&U(O,g)}G(O,"error",lt);function At(){O.removeListener("finish",qe),Je()}O.once("close",At);function qe(){l("onfinish"),O.removeListener("close",At),Je()}O.once("finish",qe);function Je(){l("unpipe"),ue.unpipe(O)}return O.emit("pipe",ue),pe.flowing||(l("pipe resume"),ue.resume()),O};function ge(O){return function(){var k=O._readableState;l("pipeOnDrain",k.awaitDrain),k.awaitDrain&&k.awaitDrain--,k.awaitDrain===0&&t(O,"data")&&(k.flowing=!0,ae(O))}}te.prototype.unpipe=function(O){var k=this._readableState,ue={hasUnpiped:!1};if(k.pipesCount===0)return this;if(k.pipesCount===1)return O&&O!==k.pipes?this:(O||(O=k.pipes),k.pipes=null,k.pipesCount=0,k.flowing=!1,O&&O.emit("unpipe",this,ue),this);if(!O){var pe=k.pipes,Oe=k.pipesCount;k.pipes=null,k.pipesCount=0,k.flowing=!1;for(var Le=0;Le<Oe;Le++)pe[Le].emit("unpipe",this,{hasUnpiped:!1});return this}var Me=j(k.pipes,O);return Me===-1?this:(k.pipes.splice(Me,1),k.pipesCount-=1,k.pipesCount===1&&(k.pipes=k.pipes[0]),O.emit("unpipe",this,ue),this)},te.prototype.on=function(O,k){var ue=r.prototype.on.call(this,O,k),pe=this._readableState;return O==="data"?(pe.readableListening=this.listenerCount("readable")>0,pe.flowing!==!1&&this.resume()):O==="readable"&&!pe.endEmitted&&!pe.readableListening&&(pe.readableListening=pe.needReadable=!0,pe.flowing=!1,pe.emittedReadable=!1,l("on readable",pe.length,pe.reading),pe.length?ee(this):pe.reading||process.nextTick(ye,this)),ue},te.prototype.addListener=te.prototype.on,te.prototype.removeListener=function(O,k){var ue=r.prototype.removeListener.call(this,O,k);return O==="readable"&&process.nextTick(de,this),ue},te.prototype.removeAllListeners=function(O){var k=r.prototype.removeAllListeners.apply(this,arguments);return(O==="readable"||O===void 0)&&process.nextTick(de,this),k};function de(O){var k=O._readableState;k.readableListening=O.listenerCount("readable")>0,k.resumeScheduled&&!k.paused?k.flowing=!0:O.listenerCount("data")>0&&O.resume()}function ye(O){l("readable nexttick read 0"),O.read(0)}te.prototype.resume=function(){var O=this._readableState;return O.flowing||(l("resume"),O.flowing=!O.readableListening,Ce(this,O)),O.paused=!1,this};function Ce(O,k){k.resumeScheduled||(k.resumeScheduled=!0,process.nextTick(ke,O,k))}function ke(O,k){l("resume",k.reading),k.reading||O.read(0),k.resumeScheduled=!1,O.emit("resume"),ae(O),k.flowing&&!k.reading&&O.read(0)}te.prototype.pause=function(){return l("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(l("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this};function ae(O){var k=O._readableState;for(l("flow",k.flowing);k.flowing&&O.read()!==null;);}te.prototype.wrap=function(O){var k=this,ue=this._readableState,pe=!1;O.on("end",function(){if(l("wrapped end"),ue.decoder&&!ue.ended){var Me=ue.decoder.end();Me&&Me.length&&k.push(Me)}k.push(null)}),O.on("data",function(Me){if(l("wrapped data"),ue.decoder&&(Me=ue.decoder.write(Me)),!(ue.objectMode&&Me==null)&&!(!ue.objectMode&&(!Me||!Me.length))){var We=k.push(Me);We||(pe=!0,O.pause())}});for(var Oe in O)this[Oe]===void 0&&typeof O[Oe]=="function"&&(this[Oe]=function(Me){return function(){return O[Me].apply(O,arguments)}}(Oe));for(var Le=0;Le<F.length;Le++)O.on(F[Le],this.emit.bind(this,F[Le]));return this._read=function(Me){l("wrapped _read",Me),pe&&(pe=!1,O.resume())},this},typeof Symbol=="function"&&(te.prototype[Symbol.asyncIterator]=function(){return B===void 0&&(B=requireAsync_iterator()),B(this)}),Object.defineProperty(te.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(te.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(te.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(O){this._readableState&&(this._readableState.flowing=O)}}),te._fromList=Q,Object.defineProperty(te.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}});function Q(O,k){if(k.length===0)return null;var ue;return k.objectMode?ue=k.buffer.shift():!O||O>=k.length?(k.decoder?ue=k.buffer.join(""):k.buffer.length===1?ue=k.buffer.first():ue=k.buffer.concat(k.length),k.buffer.clear()):ue=k.buffer.consume(O,k.decoder),ue}function C(O){var k=O._readableState;l("endReadable",k.endEmitted),k.endEmitted||(k.ended=!0,process.nextTick($,k,O))}function $(O,k){if(l("endReadableNT",O.endEmitted,O.length),!O.endEmitted&&O.length===0&&(O.endEmitted=!0,k.readable=!1,k.emit("end"),O.autoDestroy)){var ue=k._writableState;(!ue||ue.autoDestroy&&ue.finished)&&k.destroy()}}typeof Symbol=="function"&&(te.from=function(O,k){return P===void 0&&(P=requireFromBrowser()),P(te,O,k)});function j(O,k){for(var ue=0,pe=O.length;ue<pe;ue++)if(O[ue]===k)return ue;return-1}return _stream_readable}var _stream_transform=Transform$2,_require$codes$1=errorsBrowser.codes,ERR_METHOD_NOT_IMPLEMENTED=_require$codes$1.ERR_METHOD_NOT_IMPLEMENTED,ERR_MULTIPLE_CALLBACK=_require$codes$1.ERR_MULTIPLE_CALLBACK,ERR_TRANSFORM_ALREADY_TRANSFORMING=_require$codes$1.ERR_TRANSFORM_ALREADY_TRANSFORMING,ERR_TRANSFORM_WITH_LENGTH_0=_require$codes$1.ERR_TRANSFORM_WITH_LENGTH_0,Duplex$1=require_stream_duplex();inherits_browserExports(Transform$2,Duplex$1);function afterTransform$1(e,t){var r=this._transformState;r.transforming=!1;var n=r.writecb;if(n===null)return this.emit("error",new ERR_MULTIPLE_CALLBACK);r.writechunk=null,r.writecb=null,t!=null&&this.push(t),n(e);var o=this._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}function Transform$2(e){if(!(this instanceof Transform$2))return new Transform$2(e);Duplex$1.call(this,e),this._transformState={afterTransform:afterTransform$1.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&(typeof e.transform=="function"&&(this._transform=e.transform),typeof e.flush=="function"&&(this._flush=e.flush)),this.on("prefinish",prefinish)}function prefinish(){var e=this;typeof this._flush=="function"&&!this._readableState.destroyed?this._flush(function(t,r){done$3(e,t,r)}):done$3(this,null,null)}Transform$2.prototype.push=function(e,t){return this._transformState.needTransform=!1,Duplex$1.prototype.push.call(this,e,t)},Transform$2.prototype._transform=function(e,t,r){r(new ERR_METHOD_NOT_IMPLEMENTED("_transform()"))},Transform$2.prototype._write=function(e,t,r){var n=this._transformState;if(n.writecb=r,n.writechunk=e,n.writeencoding=t,!n.transforming){var o=this._readableState;(n.needTransform||o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}},Transform$2.prototype._read=function(e){var t=this._transformState;t.writechunk!==null&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},Transform$2.prototype._destroy=function(e,t){Duplex$1.prototype._destroy.call(this,e,function(r){t(r)})};function done$3(e,t,r){if(t)return e.emit("error",t);if(r!=null&&e.push(r),e._writableState.length)throw new ERR_TRANSFORM_WITH_LENGTH_0;if(e._transformState.transforming)throw new ERR_TRANSFORM_ALREADY_TRANSFORMING;return e.push(null)}var _stream_passthrough=PassThrough$1,Transform$1=_stream_transform;inherits_browserExports(PassThrough$1,Transform$1);function PassThrough$1(e){if(!(this instanceof PassThrough$1))return new PassThrough$1(e);Transform$1.call(this,e)}PassThrough$1.prototype._transform=function(e,t,r){r(null,e)};var eos;function once$2(e){var t=!1;return function(){t||(t=!0,e.apply(void 0,arguments))}}var _require$codes=errorsBrowser.codes,ERR_MISSING_ARGS=_require$codes.ERR_MISSING_ARGS,ERR_STREAM_DESTROYED=_require$codes.ERR_STREAM_DESTROYED;function noop$8(e){if(e)throw e}function isRequest(e){return e.setHeader&&typeof e.abort=="function"}function destroyer(e,t,r,n){n=once$2(n);var o=!1;e.on("close",function(){o=!0}),eos===void 0&&(eos=endOfStream),eos(e,{readable:t,writable:r},function(a){if(a)return n(a);o=!0,n()});var s=!1;return function(a){if(!o&&!s){if(s=!0,isRequest(e))return e.abort();if(typeof e.destroy=="function")return e.destroy();n(a||new ERR_STREAM_DESTROYED("pipe"))}}}function call$1(e){e()}function pipe$1(e,t){return e.pipe(t)}function popCallback(e){return!e.length||typeof e[e.length-1]!="function"?noop$8:e.pop()}function pipeline$1(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=popCallback(t);if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw new ERR_MISSING_ARGS("streams");var o,s=t.map(function(a,c){var l=c<t.length-1,h=c>0;return destroyer(a,l,h,function(u){o||(o=u),u&&s.forEach(call$1),!l&&(s.forEach(call$1),n(o))})});return t.reduce(pipe$1)}var pipeline_1=pipeline$1;(function(e,t){t=e.exports=require_stream_readable(),t.Stream=t,t.Readable=t,t.Writable=require_stream_writable(),t.Duplex=require_stream_duplex(),t.Transform=_stream_transform,t.PassThrough=_stream_passthrough,t.finished=endOfStream,t.pipeline=pipeline_1})(readableBrowser,readableBrowser.exports);let readableBrowserExports,define_process_env_default$1,createPromiseFromCallback,TimeoutError$2,sleep,unrefTimeout,sleepWithContext,EventListener,weakListenersState,weakListeners,__dxlog_file$v,latch,TriggerState;readableBrowserExports=readableBrowser.exports,define_process_env_default$1={},createPromiseFromCallback=e=>new Promise((t,r)=>{e((n,o)=>{n?r(n):t(o)})}),TimeoutError$2=class extends Error{constructor(e,t){super(e?`Timeout [${e.toLocaleString()}ms]${t===void 0?"":`: ${t}`}`:"Timeout")}},sleep=e=>new Promise(t=>{const r=Date.now()+e,n=()=>{const o=r-Date.now();o>0?setTimeout(n,o):t()};n()}),asyncTimeout=async(e,t,r)=>{let n;const o=r===void 0||typeof r=="string"?new TimeoutError$2(t,r):r,s=new Promise((c,l)=>{n=setTimeout(()=>{l(o)},t),unrefTimeout(n)}),a=typeof e=="function"?createPromiseFromCallback(e):e;return await Promise.race([a,s]).finally(()=>{clearTimeout(n)})},unrefTimeout=e=>{typeof e=="object"&&"unref"in e&&e.unref()},sleepWithContext=(e,t)=>{const r=new ContextDisposedError;return new Promise((n,o)=>{if(e.disposed){o(r);return}const s=setTimeout(()=>{a(),n()},t),a=e.onDispose(()=>{clearTimeout(s),o(r)})})},EventSubscriptions=class{constructor(){this._listeners=[]}add(e){this._listeners.push(e)}clear(){this._listeners.forEach(e=>e()),this._listeners.length=0}},Event$1=class $i{constructor(){this._listeners=new Set,this._effects=new Set}static wrap(t,r){const n=new $i;return n.addEffect(()=>{const o=s=>n.emit(s);return t.on(r,o),()=>t.off(r,o)}),n}emit(t){for(const r of this._listeners)r.trigger(t),r.once&&this._listeners.delete(r)}on(t,r,n){const[o,s]=t instanceof Context?[t,r]:[new Context,t],a=!!(n!=null&&n.weak),c=!!(n!=null&&n.once),l=new EventListener(this,s,o,c,a);return this._addListener(l),()=>{this._removeListener(l)}}off(t){for(const r of this._listeners)r.derefCallback()===t&&this._removeListener(r)}once(t,r){const[n,o]=t instanceof Context?[t,r]:[new Context,t],s=new EventListener(this,o,n,!0,!1);return this._addListener(s),()=>{this._removeListener(s)}}async*[Symbol.asyncIterator](){for(;;)yield await new Promise(t=>{this.once(t)})}waitFor(t){return new Promise(r=>{const n=this.on(o=>{t(o)&&(n(),r(o))})})}waitForCount(t){let r=0;return this.waitFor(()=>++r===t)}async waitForCondition(t){t()||await this.waitFor(t)}listenerCount(){return this._listeners.size}addEffect(t){const r={effect:t,cleanup:void 0};return this.listenerCount()>0&&(r.cleanup=r.effect()),this._effects.add(r),()=>{var n;(n=r.cleanup)==null||n.call(r),this._effects.delete(r)}}debounce(t=0){let r,n;const o=new $i;return o.addEffect(()=>{const s=this.on(()=>{if(!r){const a=!n||Date.now()-n>t?t/8:t;r=setTimeout(()=>{n=Date.now(),r=void 0,o.emit()},a)}});return()=>{s(),clearTimeout(r)}}),o}discardParameter(){return this}toJSON(){return{listenerCount:this.listenerCount()}}_addListener(t){this._listeners.add(t),this.listenerCount()===1&&this._runEffects()}_removeListener(t){this._listeners.delete(t),t.remove(),this.listenerCount()===0&&this._cleanupEffects()}_runEffects(){for(const t of this._effects)t.cleanup=t.effect()}_cleanupEffects(){var t;for(const r of this._effects)(t=r.cleanup)==null||t.call(r),r.cleanup=void 0}},EventListener=class{constructor(e,t,r,n,o){this.ctx=r,this.once=n,this.weak=o,this._clearDispose=void 0,this._clearDispose=r.onDispose(()=>{e._removeListener(this)}),o?(this.callback=new WeakRef(t),weakListeners().registry.register(t,{event:new WeakRef(e),listener:this},this)):this.callback=t}derefCallback(){return this.weak?this.callback.deref():this.callback}async trigger(e){var t;try{await((t=this.derefCallback())==null?void 0:t(e))}catch(r){this.ctx.raise(r)}}remove(){var e;(e=this._clearDispose)==null||e.call(this),weakListeners().registry.unregister(this)}},weakListenersState=null,weakListeners=()=>(weakListenersState??(weakListenersState=new FinalizationRegistry(({event:e,listener:t})=>{var r;(r=e.deref())==null||r._removeListener(t)})),{registry:weakListenersState}),__dxlog_file$v="/home/runner/work/dxos/dxos/packages/common/async/src/latch.ts",latch=({count:e=1,timeout:t}={})=>{invariant$1(e>=0,void 0,{F:__dxlog_file$v,L:19,S:void 0,A:["count >= 0",""]});let r,n,o;const s=new Promise((c,l)=>{n=h=>{clearTimeout(r),c(h)},o=h=>{clearTimeout(r),l(h)}});e===0?setTimeout(()=>{n(0)}):t&&(r=setTimeout(()=>{o(new Error(`Timed out after ${t.toLocaleString()}ms`))},t));let a=0;return[async()=>await s,()=>(++a===e&&n(a),a),c=>o(c)]},function(e){e.WAITING="WAITING",e.RESOLVED="RESOLVED",e.REJECTED="REJECTED"}(TriggerState||(TriggerState={}));let EMPTY_OBSERVABLE,Mutex,MutexGuard,classMutexSymbol,enableWarning,__dxlog_file2$k,enabled$1,openResources,handleSymbol,trackResource,trackLeaks,dumpLeaks;Trigger=class{constructor(e={autoReset:!1}){this._options=e,this._state="WAITING",this.reset()}get state(){return this._state}async wait({timeout:e}={}){return e?asyncTimeout(this._promise,e,new TimeoutError$2(e)):this._promise}wake(e){return this._state="RESOLVED",this._resolve(e),this._options.autoReset?this.reset():this}reset(){return this._state="WAITING",this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this._promise.catch(()=>{}),this}throw(e){return this._state="REJECTED",this._reject(e),this._options.autoReset?this.reset():this}},MulticastObservable=class ln extends Observable$3{constructor(t,r){super(n=>this._subscribe(n)),this._value=r,this._observers=new Set,this._completed=new Trigger,this._handlers={next:n=>{this._value=n,this._observers.forEach(o=>{var s;return(s=o.next)==null?void 0:s.call(o,n)})},error:n=>{this._observers.forEach(o=>{var s;return(s=o.error)==null?void 0:s.call(o,n)})},complete:()=>{this._completed.wake(),this._observers.forEach(n=>{var o;return(o=n.complete)==null?void 0:o.call(n)})}},this._observable=typeof t=="function"?new Observable$3(t):t,this._observable.subscribe(this._handlers)}static from(t,r){if("emit"in t)return new ln(o=>{t.on(s=>{o.next(s)})},r);const n=Observable$3.from(t);return new ln(n,r)}static of(...t){return new ln(Observable$3.of(...t.slice(1)),t[0])}static empty(){return EMPTY_OBSERVABLE}get(){if(this._value===void 0)throw new Error("MulticastObservable is not initialized.");return this._value}async wait({timeout:t}={}){return await this._completed.wait({timeout:t}),this.get()}forEach(t){return this._observable.forEach(t)}map(t){return new ln(this._observable.map(t),this._value&&t(this._value))}filter(t){return new ln(this._observable.filter(t),this._value&&t(this._value)?this._value:void 0)}reduce(t,r){return new ln(r?this._observable.reduce(t,r):this._observable.reduce(t),r??this._value)}flatMap(t){return new ln(this._observable.flatMap(t),this._value&&t(this._value).get())}concat(...t){return new ln(this._observable.concat(...t),this._value)}losslessConcat(t,...r){const n=r.filter(s=>s instanceof ln),o=t(this._value,n.map(s=>s.get()));return new ln(this._observable.concat(...r),o)}_subscribe(t){var r;return this._observers.has(t)||this._observers.add(t),this._value!==void 0&&((r=t.next)==null||r.call(t,this._value)),()=>{this._observers.delete(t)}}},EMPTY_OBSERVABLE=MulticastObservable.of(null),Mutex=class{constructor(){this._queue=Promise.resolve(),this._queueLength=0,this._tag=null}get tag(){return this._tag}isLocked(){return this._queueLength>0}async acquire(e){const t=this._queue;let r;return this._queueLength++,this._queue=new Promise(n=>{r=new MutexGuard(()=>{this._queueLength--,this._tag=null,n()})}),await t,e!==void 0&&(this._tag=e),r}async executeSynchronized(e){const t=await this.acquire();try{return await e()}finally{t.release()}}},MutexGuard=class{constructor(e){this._release=e}release(){this._release()}[Symbol.dispose](){this.release()}},classMutexSymbol=Symbol("class-mutex"),enableWarning=globalThis.mochaExecutor,synchronized=(e,t,r)=>{const n=r.value;r.value=async function(...o){const s=this[classMutexSymbol]??(this[classMutexSymbol]=new Mutex),a=`${e.constructor.name}.${t}`;let c;enableWarning?c=await warnAfterTimeout(1e4,`lock on ${a} (taken by ${s.tag})`,()=>s.acquire(a)):c=await s.acquire(a);try{return await n.apply(this,o)}finally{c.release()}},Object.defineProperty(r.value,"name",{value:t+"$synchronized"})},__dxlog_file2$k="/home/runner/work/dxos/dxos/packages/common/async/src/track-leaks.ts",enabled$1=typeof process<"u"&&!!define_process_env_default$1.DX_TRACK_LEAKS,openResources=new Set,handleSymbol=Symbol("checkLeaksHandle"),trackResource=e=>{if(!enabled$1)return()=>{};const t=e();return openResources.add(t),()=>{openResources.delete(t)}},trackLeaks=(e,t)=>r=>{if(!enabled$1)return;const n=r.prototype[e],o=r.prototype[t];if(!n||!o)throw new Error(`Cannot find ${e} or ${t} method in ${r.name}`);r.prototype[e]=async function(...s){return this[handleSymbol]=trackResource(()=>({name:r.name,openStack:new StackTrace})),n.apply(this,s)},Object.defineProperty(r.prototype[e],"name",{value:e+"$checkLeaks"}),r.prototype[t]=async function(...s){var a;return(a=this[handleSymbol])==null||a.call(this),o.apply(this,s)},Object.defineProperty(r.prototype[t],"name",{value:t+"$checkLeaks"})},dumpLeaks=()=>{if(enabled$1){log.info(`Leaked resources ${openResources.size}:`,void 0,{F:__dxlog_file2$k,L:82,S:void 0,C:(e,t)=>e(...t)});for(const e of openResources)log.info(`- ${e.name} at`,void 0,{F:__dxlog_file2$k,L:84,S:void 0,C:(t,r)=>t(...r)}),log.info(e.openStack.getStack(1),void 0,{F:__dxlog_file2$k,L:85,S:void 0,C:(t,r)=>t(...r)}),log.info(`
`,void 0,{F:__dxlog_file2$k,L:86,S:void 0,C:(t,r)=>t(...r)})}},enabled$1&&(global.dxDumpLeaks=dumpLeaks);let DeferredTask,runInContext,runInContextAsync,scheduleMicroTask,scheduleTaskInterval,scheduleExponentialBackoffTaskInterval,TIME_PERIOD,UpdateScheduler,_Buffer;DeferredTask=class{constructor(e,t){this._ctx=e,this._callback=t,this._scheduled=!1,this._currentTask=null,this._nextTask=new Trigger}schedule(){this._scheduled||(scheduleTask(this._ctx,async()=>{await this._currentTask,this._scheduled=!1;const e=this._nextTask;this._nextTask=new Trigger,this._currentTask=runInContextAsync(this._ctx,()=>this._callback()).then(()=>{e.wake()})}),this._scheduled=!0)}async runBlocking(){if(this._ctx.disposed)throw new ContextDisposedError;this.schedule(),await this._nextTask.wait()}async join(){await this._currentTask}},runInContext=(e,t)=>{try{t()}catch(r){e.raise(r)}},runInContextAsync=async(e,t)=>{try{await t()}catch(r){e.raise(r)}},scheduleMicroTask=(e,t)=>{queueMicrotask(async()=>{e.disposed||await runInContextAsync(e,t)})},scheduleTask=(e,t,r)=>{const n=trackResource(()=>({name:`task (${t.name||"anonymous"})`,openStack:new StackTrace})),o=setTimeout(async()=>{s(),await runInContextAsync(e,t),n()},r),s=e.onDispose(()=>{n(),clearTimeout(o)})},scheduleTaskInterval=(e,t,r)=>{const n=trackResource(()=>({name:`repeating task (${t.name||"anonymous"})`,openStack:new StackTrace}));let o;const s=async()=>{await runInContextAsync(e,t),!e.disposed&&(o=setTimeout(s,r))};o=setTimeout(s,r),e.onDispose(()=>{n(),clearTimeout(o)})},scheduleExponentialBackoffTaskInterval=(e,t,r)=>{const n=trackResource(()=>({name:`repeating task (${t.name||"anonymous"})`,openStack:new StackTrace}));let o,s=r;const a=async()=>{await runInContextAsync(e,t),!e.disposed&&(s*=2,o=setTimeout(a,s))};o=setTimeout(a,s),e.onDispose(()=>{n(),clearTimeout(o)})},TIME_PERIOD=1e3,UpdateScheduler=class{constructor(e,t,r={}){this._ctx=e,this._callback=t,this._params=r,this._promise=null,this._scheduled=!1,this._lastUpdateTime=-TIME_PERIOD,e.onDispose(async()=>{await this._promise})}trigger(){this._scheduled||(scheduleMicroTask(this._ctx,async()=>{if(await this._promise,this._params.maxFrequency){const e=performance.now(),t=this._lastUpdateTime+TIME_PERIOD/this._params.maxFrequency-e;t>0&&await new Promise(r=>{const n=this._ctx.onDispose(()=>{clearTimeout(o),r()}),o=setTimeout(()=>{n(),r()},t)})}this._ctx.disposed||(this._lastUpdateTime=performance.now(),this._scheduled=!1,this._promise=this._callback().then(()=>{this._promise=null},e=>{this._promise=null,this._ctx.raise(e)}))}),this._scheduled=!0)}forceTrigger(){scheduleMicroTask(this._ctx,async()=>{this._callback().catch(e=>this._ctx.raise(e))})}},_Buffer=safeBufferExports.Buffer;function base$2(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var n=0;n<e.length;n++){var o=e.charAt(n),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=n}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function u(_){if((Array.isArray(_)||_ instanceof Uint8Array)&&(_=_Buffer.from(_)),!_Buffer.isBuffer(_))throw new TypeError("Expected Buffer");if(_.length===0)return"";for(var p=0,y=0,w=0,E=_.length;w!==E&&_[w]===0;)w++,p++;for(var x=(E-w)*h+1>>>0,B=new Uint8Array(x);w!==E;){for(var P=_[w],U=0,F=x-1;(P!==0||U<y)&&F!==-1;F--,U++)P+=256*B[F]>>>0,B[F]=P%a>>>0,P=P/a>>>0;if(P!==0)throw new Error("Non-zero carry");y=U,w++}for(var G=x-y;G!==x&&B[G]===0;)G++;for(var H=c.repeat(p);G<x;++G)H+=e.charAt(B[G]);return H}function d(_){if(typeof _!="string")throw new TypeError("Expected String");if(_.length===0)return _Buffer.alloc(0);for(var p=0,y=0,w=0;_[p]===c;)y++,p++;for(var E=(_.length-p)*l+1>>>0,x=new Uint8Array(E);_[p];){var B=t[_.charCodeAt(p)];if(B===255)return;for(var P=0,U=E-1;(B!==0||P<w)&&U!==-1;U--,P++)B+=a*x[U]>>>0,x[U]=B%256>>>0,B=B/256>>>0;if(B!==0)throw new Error("Non-zero carry");w=P,p++}for(var F=E-w;F!==E&&x[F]===0;)F++;var G=_Buffer.allocUnsafe(y+(E-F));G.fill(0,0,y);for(var H=y;F!==E;)G[H++]=x[F++];return G}function f(_){var p=d(_);if(p)return p;throw new Error("Non-base"+a+" character")}return{encode:u,decodeUnsafe:d,decode:f}}var src$3=base$2;const base$3=getDefaultExportFromCjs(src$3);class BaseError extends Error{constructor(r,n,o){super(n??r);ie(this,"code");ie(this,"context");this.code=r,this.context=o,this.name=r,Object.setPrototypeOf(this,new.target.prototype)}}ApiError=class extends BaseError{};class SystemError extends BaseError{}class DatabaseError extends BaseError{}const reconstructError=e=>{const{name:t,message:r,context:n}=e;return errorFromCode(t,r,n)},errorRegistry=new Map,registerError=(e,t)=>{invariant$1(!errorRegistry.has(e),`Error code already registered: ${e}`),errorRegistry.set(e,t)},registerErrorNoArgs=(e,t)=>{registerError(e,()=>new t)},registerErrorMessageContext=(e,t)=>{registerError(e,(r,n)=>new t(r,n))},errorFromCode=(e,t,r)=>e&&errorRegistry.has(e)?errorRegistry.get(e)(t,r):new SystemError(e??"Error",t,r),encodeError=e=>typeof e=="object"&&(e!=null&&e.message)?{name:e.name,message:e.message,context:e.context,stack:e.stack}:typeof e=="string"?{message:e}:{message:JSON.stringify(e)},decodeError=(e,{appendStack:t}={})=>{const r=reconstructError(e);return t?r.stack=(e.stack??`${r.message}
`)+t:r.stack=e.stack,r};class RpcClosedError extends SystemError{constructor(){super("RPC_CLOSED","Request was terminated because the RPC endpoint is closed.")}}registerErrorNoArgs("RPC_CLOSED",RpcClosedError);class RpcNotOpenError extends SystemError{constructor(){super("RPC_NOT_OPEN","RPC has not been opened.")}}registerErrorNoArgs("RPC_NOT_OPEN",RpcNotOpenError);class CancelledError extends SystemError{constructor(t,r){super("CANCELLED",t,r)}}registerErrorMessageContext("CANCELLED",CancelledError);class InvalidConfigError extends ApiError{constructor(t,r){super("INVALID_CONFIG",t,r)}}registerErrorMessageContext("INVALID_CONFIG",InvalidConfigError);class RemoteServiceConnectionError extends ApiError{constructor(t,r){super("REMOTE_SERVICE_CONNECTION_ERROR",t,r)}}registerErrorMessageContext("REMOTE_SERVICE_CONNECTION_ERROR",RemoteServiceConnectionError),RemoteServiceConnectionTimeout=class extends ApiError{constructor(e,t){super("REMOTE_SERVICE_CONNECTION_TIMEOUT",e,t)}},registerErrorMessageContext("REMOTE_SERVICE_CONNECTION_TIMEOUT",RemoteServiceConnectionTimeout);class DataCorruptionError extends SystemError{constructor(t,r){super("DATA_CORRUPTION",t,r)}}registerErrorMessageContext("DATA_CORRUPTION",DataCorruptionError);class InvalidInvitationExtensionRoleError extends SystemError{constructor(t,r){super("INVALID_INVITATION_EXTENSION_ROLE",t,r)}}registerErrorMessageContext("INVALID_INVITATION_EXTENSION_ROLE",InvalidInvitationExtensionRoleError);class IdentityNotInitializedError extends DatabaseError{constructor(t,r){super("IDENTITY_NOT_INITIALIZED",t,r)}}registerErrorMessageContext("IDENTITY_NOT_INITIALIZED",IdentityNotInitializedError);class InvalidInvitationError extends DatabaseError{constructor(t,r){super("INVALID_INVITATION",t,r)}}registerErrorMessageContext("INVALID_INVITATION",InvalidInvitationError);class AlreadyJoinedError extends DatabaseError{constructor(t,r){super("ALREADY_JOINED",t,r)}}registerErrorMessageContext("ALREADY_JOINED",AlreadyJoinedError);class ConnectionResetError extends BaseError{constructor(t,r){super("CONNECTION_RESET",t,r)}}registerErrorMessageContext("CONNECTION_RESET",ConnectionResetError);let TimeoutError$1=class extends BaseError{constructor(e,t){super("TIMEOUT",e,t)}};registerErrorMessageContext("TIMEOUT",TimeoutError$1);class ProtocolError extends BaseError{constructor(t,r){super("PROTOCOL_ERROR",t,r)}}registerErrorMessageContext("PROTOCOL_ERROR",ProtocolError);class ConnectivityError extends BaseError{constructor(t,r){super("CONNECTIVITY_ERROR",t,r)}}registerErrorMessageContext("CONNECTIVITY_ERROR",ConnectivityError);class RateLimitExceededError extends BaseError{constructor(t,r){super("RATE_LIMIT_EXCEEDED",t,r)}}registerErrorMessageContext("RATE_LIMIT_EXCEEDED",RateLimitExceededError);class UnknownProtocolError extends BaseError{constructor(t,r){super("UNKNOWN_PROTOCOL_ERROR",t,r)}}registerErrorMessageContext("UNKNOWN_PROTOCOL_ERROR",UnknownProtocolError);class InvalidStorageVersionError extends DatabaseError{constructor(t,r){super("INVALID_STORAGE_VERSION","Invalid storage version.",{expected:t,actual:r})}}registerError("INVALID_STORAGE_VERSION",(e,t)=>new InvalidStorageVersionError(t.expected??NaN,t.actual??NaN));class SpaceNotFoundError extends DatabaseError{constructor(t){super("SPACE_NOT_FOUND","Space not found.",{spaceKey:t})}}registerError("SPACE_NOT_FOUND",(e,t)=>new SpaceNotFoundError(PublicKey.safeFrom(t.spaceKey)??PublicKey.from("00")));class EntityNotFoundError extends DatabaseError{constructor(t){super("ITEM_NOT_FOUND","Item not found.",{entityId:t})}}registerError("ITEM_NOT_FOUND",(e,t)=>new EntityNotFoundError(t.entityId));class UnknownModelError extends DatabaseError{constructor(t){super("UNKNOWN_MODEL","Unknown model.",{model:t})}}registerError("UNKNOWN_MODEL",(e,t)=>new UnknownModelError(t.model));class AuthorizationError extends ApiError{constructor(t,r){super("AUTHORIZATION_ERROR",t,r)}}registerErrorMessageContext("AUTHORIZATION_ERROR",AuthorizationError);const V1_PREFIX="#01";var ObjectPointerVersion;(function(e){e[e.V0=0]="V0",e[e.V1=1]="V1"})(ObjectPointerVersion||(ObjectPointerVersion={}));const objectPointerCodec={encode:({spaceKey:e,documentId:t,objectId:r})=>e===void 0?`${t}|${r}`:`${V1_PREFIX}|${e}|${t}|${r}`,decode:e=>{if(e.startsWith(V1_PREFIX)){const[t,r,n,o]=e.split("|");return{spaceKey:r,documentId:n,objectId:o}}else{const[t,r]=e.split("|");return{spaceKey:void 0,documentId:t,objectId:r}}},getVersion:e=>e.startsWith(V1_PREFIX)?ObjectPointerVersion.V1:ObjectPointerVersion.V0,convertV1ToV0:e=>{const{documentId:t,objectId:r}=objectPointerCodec.decode(e);return objectPointerCodec.encode({documentId:t,objectId:r,spaceKey:void 0})}};var src$2={exports:{}},indexLight={exports:{}},indexMinimal={},minimal={},aspromise=asPromise$1;function asPromise$1(e,t){for(var r=new Array(arguments.length-1),n=0,o=2,s=!0;o<arguments.length;)r[n++]=arguments[o++];return new Promise(function(a,c){r[n]=function(l){if(s)if(s=!1,l)c(l);else{for(var h=new Array(arguments.length-1),u=0;u<h.length;)h[u++]=arguments[u];a.apply(null,h)}};try{e.apply(t||null,r)}catch(l){s&&(s=!1,c(l))}})}var base64$2={};(function(e){var t=e;t.length=function(a){var c=a.length;if(!c)return 0;for(var l=0;--c%4>1&&a.charAt(c)==="=";)++l;return Math.ceil(a.length*3)/4-l};for(var r=new Array(64),n=new Array(123),o=0;o<64;)n[r[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;t.encode=function(a,c,l){for(var h=null,u=[],d=0,f=0,_;c<l;){var p=a[c++];switch(f){case 0:u[d++]=r[p>>2],_=(p&3)<<4,f=1;break;case 1:u[d++]=r[_|p>>4],_=(p&15)<<2,f=2;break;case 2:u[d++]=r[_|p>>6],u[d++]=r[p&63],f=0;break}d>8191&&((h||(h=[])).push(String.fromCharCode.apply(String,u)),d=0)}return f&&(u[d++]=r[_],u[d++]=61,f===1&&(u[d++]=61)),h?(d&&h.push(String.fromCharCode.apply(String,u.slice(0,d))),h.join("")):String.fromCharCode.apply(String,u.slice(0,d))};var s="invalid encoding";t.decode=function(a,c,l){for(var h=l,u=0,d,f=0;f<a.length;){var _=a.charCodeAt(f++);if(_===61&&u>1)break;if((_=n[_])===void 0)throw Error(s);switch(u){case 0:d=_,u=1;break;case 1:c[l++]=d<<2|(_&48)>>4,d=_,u=2;break;case 2:c[l++]=(d&15)<<4|(_&60)>>2,d=_,u=3;break;case 3:c[l++]=(d&3)<<6|_,u=0;break}}if(u===1)throw Error(s);return l-h},t.test=function(a){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(a)}})(base64$2);var eventemitter=EventEmitter$2;function EventEmitter$2(){this._listeners={}}EventEmitter$2.prototype.on=function(e,t,r){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:r||this}),this},EventEmitter$2.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var r=this._listeners[e],n=0;n<r.length;)r[n].fn===t?r.splice(n,1):++n;return this},EventEmitter$2.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var r=[],n=1;n<arguments.length;)r.push(arguments[n++]);for(n=0;n<t.length;)t[n].fn.apply(t[n++].ctx,r)}return this};var float=factory(factory);function factory(e){return typeof Float32Array<"u"?function(){var t=new Float32Array([-0]),r=new Uint8Array(t.buffer),n=r[3]===128;function o(l,h,u){t[0]=l,h[u]=r[0],h[u+1]=r[1],h[u+2]=r[2],h[u+3]=r[3]}function s(l,h,u){t[0]=l,h[u]=r[3],h[u+1]=r[2],h[u+2]=r[1],h[u+3]=r[0]}e.writeFloatLE=n?o:s,e.writeFloatBE=n?s:o;function a(l,h){return r[0]=l[h],r[1]=l[h+1],r[2]=l[h+2],r[3]=l[h+3],t[0]}function c(l,h){return r[3]=l[h],r[2]=l[h+1],r[1]=l[h+2],r[0]=l[h+3],t[0]}e.readFloatLE=n?a:c,e.readFloatBE=n?c:a}():function(){function t(n,o,s,a){var c=o<0?1:0;if(c&&(o=-o),o===0)n(1/o>0?0:2147483648,s,a);else if(isNaN(o))n(2143289344,s,a);else if(o>3402823466385289e23)n((c<<31|2139095040)>>>0,s,a);else if(o<11754943508222875e-54)n((c<<31|Math.round(o/1401298464324817e-60))>>>0,s,a);else{var l=Math.floor(Math.log(o)/Math.LN2),h=Math.round(o*Math.pow(2,-l)*8388608)&8388607;n((c<<31|l+127<<23|h)>>>0,s,a)}}e.writeFloatLE=t.bind(null,writeUintLE),e.writeFloatBE=t.bind(null,writeUintBE);function r(n,o,s){var a=n(o,s),c=(a>>31)*2+1,l=a>>>23&255,h=a&8388607;return l===255?h?NaN:c*(1/0):l===0?c*1401298464324817e-60*h:c*Math.pow(2,l-150)*(h+8388608)}e.readFloatLE=r.bind(null,readUintLE),e.readFloatBE=r.bind(null,readUintBE)}(),typeof Float64Array<"u"?function(){var t=new Float64Array([-0]),r=new Uint8Array(t.buffer),n=r[7]===128;function o(l,h,u){t[0]=l,h[u]=r[0],h[u+1]=r[1],h[u+2]=r[2],h[u+3]=r[3],h[u+4]=r[4],h[u+5]=r[5],h[u+6]=r[6],h[u+7]=r[7]}function s(l,h,u){t[0]=l,h[u]=r[7],h[u+1]=r[6],h[u+2]=r[5],h[u+3]=r[4],h[u+4]=r[3],h[u+5]=r[2],h[u+6]=r[1],h[u+7]=r[0]}e.writeDoubleLE=n?o:s,e.writeDoubleBE=n?s:o;function a(l,h){return r[0]=l[h],r[1]=l[h+1],r[2]=l[h+2],r[3]=l[h+3],r[4]=l[h+4],r[5]=l[h+5],r[6]=l[h+6],r[7]=l[h+7],t[0]}function c(l,h){return r[7]=l[h],r[6]=l[h+1],r[5]=l[h+2],r[4]=l[h+3],r[3]=l[h+4],r[2]=l[h+5],r[1]=l[h+6],r[0]=l[h+7],t[0]}e.readDoubleLE=n?a:c,e.readDoubleBE=n?c:a}():function(){function t(n,o,s,a,c,l){var h=a<0?1:0;if(h&&(a=-a),a===0)n(0,c,l+o),n(1/a>0?0:2147483648,c,l+s);else if(isNaN(a))n(0,c,l+o),n(2146959360,c,l+s);else if(a>17976931348623157e292)n(0,c,l+o),n((h<<31|2146435072)>>>0,c,l+s);else{var u;if(a<22250738585072014e-324)u=a/5e-324,n(u>>>0,c,l+o),n((h<<31|u/4294967296)>>>0,c,l+s);else{var d=Math.floor(Math.log(a)/Math.LN2);d===1024&&(d=1023),u=a*Math.pow(2,-d),n(u*4503599627370496>>>0,c,l+o),n((h<<31|d+1023<<20|u*1048576&1048575)>>>0,c,l+s)}}}e.writeDoubleLE=t.bind(null,writeUintLE,0,4),e.writeDoubleBE=t.bind(null,writeUintBE,4,0);function r(n,o,s,a,c){var l=n(a,c+o),h=n(a,c+s),u=(h>>31)*2+1,d=h>>>20&2047,f=4294967296*(h&1048575)+l;return d===2047?f?NaN:u*(1/0):d===0?u*5e-324*f:u*Math.pow(2,d-1075)*(f+4503599627370496)}e.readDoubleLE=r.bind(null,readUintLE,0,4),e.readDoubleBE=r.bind(null,readUintBE,4,0)}(),e}function writeUintLE(e,t,r){t[r]=e&255,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}function writeUintBE(e,t,r){t[r]=e>>>24,t[r+1]=e>>>16&255,t[r+2]=e>>>8&255,t[r+3]=e&255}function readUintLE(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function readUintBE(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}var inquire_1=inquire$1;function inquire$1(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}var utf8$3={};(function(e){var t=e;t.length=function(r){for(var n=0,o=0,s=0;s<r.length;++s)o=r.charCodeAt(s),o<128?n+=1:o<2048?n+=2:(o&64512)===55296&&(r.charCodeAt(s+1)&64512)===56320?(++s,n+=4):n+=3;return n},t.read=function(r,n,o){var s=o-n;if(s<1)return"";for(var a=null,c=[],l=0,h;n<o;)h=r[n++],h<128?c[l++]=h:h>191&&h<224?c[l++]=(h&31)<<6|r[n++]&63:h>239&&h<365?(h=((h&7)<<18|(r[n++]&63)<<12|(r[n++]&63)<<6|r[n++]&63)-65536,c[l++]=55296+(h>>10),c[l++]=56320+(h&1023)):c[l++]=(h&15)<<12|(r[n++]&63)<<6|r[n++]&63,l>8191&&((a||(a=[])).push(String.fromCharCode.apply(String,c)),l=0);return a?(l&&a.push(String.fromCharCode.apply(String,c.slice(0,l))),a.join("")):String.fromCharCode.apply(String,c.slice(0,l))},t.write=function(r,n,o){for(var s=o,a,c,l=0;l<r.length;++l)a=r.charCodeAt(l),a<128?n[o++]=a:a<2048?(n[o++]=a>>6|192,n[o++]=a&63|128):(a&64512)===55296&&((c=r.charCodeAt(l+1))&64512)===56320?(a=65536+((a&1023)<<10)+(c&1023),++l,n[o++]=a>>18|240,n[o++]=a>>12&63|128,n[o++]=a>>6&63|128,n[o++]=a&63|128):(n[o++]=a>>12|224,n[o++]=a>>6&63|128,n[o++]=a&63|128);return o-s}})(utf8$3);var pool_1=pool;function pool(e,t,r){var n=r||8192,o=n>>>1,s=null,a=n;return function(c){if(c<1||c>o)return e(c);a+c>n&&(s=e(n),a=0);var l=t.call(s,a,a+=c);return a&7&&(a=(a|7)+1),l}}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=t;var e=requireMinimal();function t(s,a){this.lo=s>>>0,this.hi=a>>>0}var r=t.zero=new t(0,0);r.toNumber=function(){return 0},r.zzEncode=r.zzDecode=function(){return this},r.length=function(){return 1};var n=t.zeroHash="\0\0\0\0\0\0\0\0";t.fromNumber=function(s){if(s===0)return r;var a=s<0;a&&(s=-s);var c=s>>>0,l=(s-c)/4294967296>>>0;return a&&(l=~l>>>0,c=~c>>>0,++c>4294967295&&(c=0,++l>4294967295&&(l=0))),new t(c,l)},t.from=function(s){if(typeof s=="number")return t.fromNumber(s);if(e.isString(s))if(e.Long)s=e.Long.fromString(s);else return t.fromNumber(parseInt(s,10));return s.low||s.high?new t(s.low>>>0,s.high>>>0):r},t.prototype.toNumber=function(s){if(!s&&this.hi>>>31){var a=~this.lo+1>>>0,c=~this.hi>>>0;return a||(c=c+1>>>0),-(a+c*4294967296)}return this.lo+this.hi*4294967296},t.prototype.toLong=function(s){return e.Long?new e.Long(this.lo|0,this.hi|0,!!s):{low:this.lo|0,high:this.hi|0,unsigned:!!s}};var o=String.prototype.charCodeAt;return t.fromHash=function(s){return s===n?r:new t((o.call(s,0)|o.call(s,1)<<8|o.call(s,2)<<16|o.call(s,3)<<24)>>>0,(o.call(s,4)|o.call(s,5)<<8|o.call(s,6)<<16|o.call(s,7)<<24)>>>0)},t.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},t.prototype.zzEncode=function(){var s=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^s)>>>0,this.lo=(this.lo<<1^s)>>>0,this},t.prototype.zzDecode=function(){var s=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^s)>>>0,this.hi=(this.hi>>>1^s)>>>0,this},t.prototype.length=function(){var s=this.lo,a=(this.lo>>>28|this.hi<<4)>>>0,c=this.hi>>>24;return c===0?a===0?s<16384?s<128?1:2:s<2097152?3:4:a<16384?a<128?5:6:a<2097152?7:8:c<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(e){var t=e;t.asPromise=aspromise,t.base64=base64$2,t.EventEmitter=eventemitter,t.float=float,t.inquire=inquire_1,t.utf8=utf8$3,t.pool=pool_1,t.LongBits=requireLongbits(),t.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),t.global=t.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||commonjsGlobal,t.emptyArray=Object.freeze?Object.freeze([]):[],t.emptyObject=Object.freeze?Object.freeze({}):{},t.isInteger=Number.isInteger||function(o){return typeof o=="number"&&isFinite(o)&&Math.floor(o)===o},t.isString=function(o){return typeof o=="string"||o instanceof String},t.isObject=function(o){return o&&typeof o=="object"},t.isset=t.isSet=function(o,s){var a=o[s];return a!=null&&o.hasOwnProperty(s)?typeof a!="object"||(Array.isArray(a)?a.length:Object.keys(a).length)>0:!1},t.Buffer=function(){try{var o=t.inquire("buffer").Buffer;return o.prototype.utf8Write?o:null}catch{return null}}(),t._Buffer_from=null,t._Buffer_allocUnsafe=null,t.newBuffer=function(o){return typeof o=="number"?t.Buffer?t._Buffer_allocUnsafe(o):new t.Array(o):t.Buffer?t._Buffer_from(o):typeof Uint8Array>"u"?o:new Uint8Array(o)},t.Array=typeof Uint8Array<"u"?Uint8Array:Array,t.Long=t.global.dcodeIO&&t.global.dcodeIO.Long||t.global.Long||t.inquire("long"),t.key2Re=/^true|false|0|1$/,t.key32Re=/^-?(?:0|[1-9][0-9]*)$/,t.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,t.longToHash=function(o){return o?t.LongBits.from(o).toHash():t.LongBits.zeroHash},t.longFromHash=function(o,s){var a=t.LongBits.fromHash(o);return t.Long?t.Long.fromBits(a.lo,a.hi,s):a.toNumber(!!s)};function r(o,s,a){for(var c=Object.keys(s),l=0;l<c.length;++l)(o[c[l]]===void 0||!a)&&(o[c[l]]=s[c[l]]);return o}t.merge=r,t.lcFirst=function(o){return o.charAt(0).toLowerCase()+o.substring(1)};function n(o){function s(a,c){if(!(this instanceof s))return new s(a,c);Object.defineProperty(this,"message",{get:function(){return a}}),Error.captureStackTrace?Error.captureStackTrace(this,s):Object.defineProperty(this,"stack",{value:new Error().stack||""}),c&&r(this,c)}return s.prototype=Object.create(Error.prototype,{constructor:{value:s,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return o},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),s}t.newError=n,t.ProtocolError=n("ProtocolError"),t.oneOfGetter=function(o){for(var s={},a=0;a<o.length;++a)s[o[a]]=1;return function(){for(var c=Object.keys(this),l=c.length-1;l>-1;--l)if(s[c[l]]===1&&this[c[l]]!==void 0&&this[c[l]]!==null)return c[l]}},t.oneOfSetter=function(o){return function(s){for(var a=0;a<o.length;++a)o[a]!==s&&delete this[o[a]]}},t.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},t._configure=function(){var o=t.Buffer;if(!o){t._Buffer_from=t._Buffer_allocUnsafe=null;return}t._Buffer_from=o.from!==Uint8Array.from&&o.from||function(s,a){return new o(s,a)},t._Buffer_allocUnsafe=o.allocUnsafe||function(s){return new o(s)}}}(minimal)),minimal}var writer=Writer$1,util$7=requireMinimal(),BufferWriter$1,LongBits$1=util$7.LongBits,base64$1=util$7.base64,utf8$2=util$7.utf8;function Op(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}function noop$7(){}function State(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function Writer$1(){this.len=0,this.head=new Op(noop$7,0,0),this.tail=this.head,this.states=null}var create$4=function e(){return util$7.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};Writer$1.create=create$4(),Writer$1.alloc=function e(t){return new util$7.Array(t)},util$7.Array!==Array&&(Writer$1.alloc=util$7.pool(Writer$1.alloc,util$7.Array.prototype.subarray)),Writer$1.prototype._push=function e(t,r,n){return this.tail=this.tail.next=new Op(t,r,n),this.len+=r,this};function writeByte(e,t,r){t[r]=e&255}function writeVarint32(e,t,r){for(;e>127;)t[r++]=e&127|128,e>>>=7;t[r]=e}function VarintOp(e,t){this.len=e,this.next=void 0,this.val=t}VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=writeVarint32,Writer$1.prototype.uint32=function e(t){return this.len+=(this.tail=this.tail.next=new VarintOp((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},Writer$1.prototype.int32=function e(t){return t<0?this._push(writeVarint64,10,LongBits$1.fromNumber(t)):this.uint32(t)},Writer$1.prototype.sint32=function e(t){return this.uint32((t<<1^t>>31)>>>0)};function writeVarint64(e,t,r){for(;e.hi;)t[r++]=e.lo&127|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[r++]=e.lo&127|128,e.lo=e.lo>>>7;t[r++]=e.lo}Writer$1.prototype.uint64=function e(t){var r=LongBits$1.from(t);return this._push(writeVarint64,r.length(),r)},Writer$1.prototype.int64=Writer$1.prototype.uint64,Writer$1.prototype.sint64=function e(t){var r=LongBits$1.from(t).zzEncode();return this._push(writeVarint64,r.length(),r)},Writer$1.prototype.bool=function e(t){return this._push(writeByte,1,t?1:0)};function writeFixed32(e,t,r){t[r]=e&255,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}Writer$1.prototype.fixed32=function e(t){return this._push(writeFixed32,4,t>>>0)},Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32,Writer$1.prototype.fixed64=function e(t){var r=LongBits$1.from(t);return this._push(writeFixed32,4,r.lo)._push(writeFixed32,4,r.hi)},Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64,Writer$1.prototype.float=function e(t){return this._push(util$7.float.writeFloatLE,4,t)},Writer$1.prototype.double=function e(t){return this._push(util$7.float.writeDoubleLE,8,t)};var writeBytes=util$7.Array.prototype.set?function e(t,r,n){r.set(t,n)}:function e(t,r,n){for(var o=0;o<t.length;++o)r[n+o]=t[o]};Writer$1.prototype.bytes=function e(t){var r=t.length>>>0;if(!r)return this._push(writeByte,1,0);if(util$7.isString(t)){var n=Writer$1.alloc(r=base64$1.length(t));base64$1.decode(t,n,0),t=n}return this.uint32(r)._push(writeBytes,r,t)},Writer$1.prototype.string=function e(t){var r=utf8$2.length(t);return r?this.uint32(r)._push(utf8$2.write,r,t):this._push(writeByte,1,0)},Writer$1.prototype.fork=function e(){return this.states=new State(this),this.head=this.tail=new Op(noop$7,0,0),this.len=0,this},Writer$1.prototype.reset=function e(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop$7,0,0),this.len=0),this},Writer$1.prototype.ldelim=function e(){var t=this.head,r=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=t.next,this.tail=r,this.len+=n),this},Writer$1.prototype.finish=function e(){for(var t=this.head.next,r=this.constructor.alloc(this.len),n=0;t;)t.fn(t.val,r,n),n+=t.len,t=t.next;return r},Writer$1._configure=function(e){BufferWriter$1=e,Writer$1.create=create$4(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$6=requireMinimal();function BufferWriter(){Writer.call(this)}BufferWriter._configure=function(){BufferWriter.alloc=util$6._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$6.Buffer&&util$6.Buffer.prototype instanceof Uint8Array&&util$6.Buffer.prototype.set.name==="set"?function(e,t,r){t.set(e,r)}:function(e,t,r){if(e.copy)e.copy(t,r,0,e.length);else for(var n=0;n<e.length;)t[r++]=e[n++]}},BufferWriter.prototype.bytes=function e(t){util$6.isString(t)&&(t=util$6._Buffer_from(t,"base64"));var r=t.length>>>0;return this.uint32(r),r&&this._push(BufferWriter.writeBytesBuffer,r,t),this};function writeStringBuffer(e,t,r){e.length<40?util$6.utf8.write(e,t,r):t.utf8Write?t.utf8Write(e,r):t.write(e,r)}BufferWriter.prototype.string=function e(t){var r=util$6.Buffer.byteLength(t);return this.uint32(r),r&&this._push(writeStringBuffer,r,t),this},BufferWriter._configure();var reader=Reader$1,util$5=requireMinimal(),BufferReader$1,LongBits=util$5.LongBits,utf8$1=util$5.utf8;function indexOutOfRange(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function Reader$1(e){this.buf=e,this.pos=0,this.len=e.length}var create_array=typeof Uint8Array<"u"?function e(t){if(t instanceof Uint8Array||Array.isArray(t))return new Reader$1(t);throw Error("illegal buffer")}:function e(t){if(Array.isArray(t))return new Reader$1(t);throw Error("illegal buffer")},create$3=function e(){return util$5.Buffer?function(t){return(Reader$1.create=function(r){return util$5.Buffer.isBuffer(r)?new BufferReader$1(r):create_array(r)})(t)}:create_array};Reader$1.create=create$3(),Reader$1.prototype._slice=util$5.Array.prototype.subarray||util$5.Array.prototype.slice,Reader$1.prototype.uint32=function e(){var t=4294967295;return function(){if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return t}}(),Reader$1.prototype.int32=function e(){return this.uint32()|0},Reader$1.prototype.sint32=function e(){var t=this.uint32();return t>>>1^-(t&1)|0};function readLongVarint(){var e=new LongBits(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw indexOutOfRange(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw indexOutOfRange(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}Reader$1.prototype.bool=function e(){return this.uint32()!==0};function readFixed32_end(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}Reader$1.prototype.fixed32=function e(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader$1.prototype.sfixed32=function e(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)|0};function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.prototype.float=function e(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var t=util$5.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},Reader$1.prototype.double=function e(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var t=util$5.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},Reader$1.prototype.bytes=function e(){var t=this.uint32(),r=this.pos,n=this.pos+t;if(n>this.len)throw indexOutOfRange(this,t);if(this.pos+=t,Array.isArray(this.buf))return this.buf.slice(r,n);if(r===n){var o=util$5.Buffer;return o?o.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,r,n)},Reader$1.prototype.string=function e(){var t=this.bytes();return utf8$1.read(t,0,t.length)},Reader$1.prototype.skip=function e(t){if(typeof t=="number"){if(this.pos+t>this.len)throw indexOutOfRange(this,t);this.pos+=t}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(this.buf[this.pos++]&128);return this},Reader$1.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},Reader$1._configure=function(e){BufferReader$1=e,Reader$1.create=create$3(),BufferReader$1._configure();var t=util$5.Long?"toLong":"toNumber";util$5.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[t](!1)},uint64:function(){return readLongVarint.call(this)[t](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[t](!1)},fixed64:function(){return readFixed64.call(this)[t](!0)},sfixed64:function(){return readFixed64.call(this)[t](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$4=requireMinimal();function BufferReader(e){Reader.call(this,e)}BufferReader._configure=function(){util$4.Buffer&&(BufferReader.prototype._slice=util$4.Buffer.prototype.slice)},BufferReader.prototype.string=function e(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},BufferReader._configure();var rpc={},service$1=Service$2,util$3=requireMinimal();(Service$2.prototype=Object.create(util$3.EventEmitter.prototype)).constructor=Service$2;function Service$2(e,t,r){if(typeof e!="function")throw TypeError("rpcImpl must be a function");util$3.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=!!t,this.responseDelimited=!!r}Service$2.prototype.rpcCall=function e(t,r,n,o,s){if(!o)throw TypeError("request must be specified");var a=this;if(!s)return util$3.asPromise(e,a,t,r,n,o);if(!a.rpcImpl){setTimeout(function(){s(Error("already ended"))},0);return}try{return a.rpcImpl(t,r[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(c,l){if(c)return a.emit("error",c,t),s(c);if(l===null){a.end(!0);return}if(!(l instanceof n))try{l=n[a.responseDelimited?"decodeDelimited":"decode"](l)}catch(h){return a.emit("error",h,t),s(h)}return a.emit("data",l,t),s(null,l)})}catch(c){a.emit("error",c,t),setTimeout(function(){s(c)},0);return}},Service$2.prototype.end=function e(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},function(e){var t=e;t.Service=service$1}(rpc);var roots={};(function(e){var t=e;t.build="minimal",t.Writer=writer,t.BufferWriter=writer_buffer,t.Reader=reader,t.BufferReader=reader_buffer,t.util=requireMinimal(),t.rpc=rpc,t.roots=roots,t.configure=r;function r(){t.util._configure(),t.Writer._configure(t.BufferWriter),t.Reader._configure(t.BufferReader)}r()})(indexMinimal);var util$2={exports:{}},codegen_1=codegen$1;function codegen$1(e,t){typeof e=="string"&&(t=e,e=void 0);var r=[];function n(s){if(typeof s!="string"){var a=o();if(codegen$1.verbose&&console.log("codegen: "+a),a="return "+a,s){for(var c=Object.keys(s),l=new Array(c.length+1),h=new Array(c.length),u=0;u<c.length;)l[u]=c[u],h[u]=s[c[u++]];return l[u]=a,Function.apply(null,l).apply(null,h)}return Function(a)()}for(var d=new Array(arguments.length-1),f=0;f<d.length;)d[f]=arguments[++f];if(f=0,s=s.replace(/%([%dfijs])/g,function(_,p){var y=d[f++];switch(p){case"d":case"f":return String(Number(y));case"i":return String(Math.floor(y));case"j":return JSON.stringify(y);case"s":return String(y)}return"%"}),f!==d.length)throw Error("parameter count mismatch");return r.push(s),n}function o(s){return"function "+(s||t||"")+"("+(e&&e.join(",")||"")+`){
  `+r.join(`
  `)+`
}`}return n.toString=o,n}codegen$1.verbose=!1;var fetch_1=fetch$1,asPromise=aspromise,inquire=inquire_1,fs=inquire("fs");function fetch$1(e,t,r){return typeof t=="function"?(r=t,t={}):t||(t={}),r?!t.xhr&&fs&&fs.readFile?fs.readFile(e,function(n,o){return n&&typeof XMLHttpRequest<"u"?fetch$1.xhr(e,t,r):n?r(n):r(null,t.binary?o:o.toString("utf8"))}):fetch$1.xhr(e,t,r):asPromise(fetch$1,this,e,t)}fetch$1.xhr=function e(t,r,n){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(o.readyState===4){if(o.status!==0&&o.status!==200)return n(Error("status "+o.status));if(r.binary){var s=o.response;if(!s){s=[];for(var a=0;a<o.responseText.length;++a)s.push(o.responseText.charCodeAt(a)&255)}return n(null,typeof Uint8Array<"u"?new Uint8Array(s):s)}return n(null,o.responseText)}},r.binary&&("overrideMimeType"in o&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.responseType="arraybuffer"),o.open("GET",t),o.send()};var path={};(function(e){var t=e,r=t.isAbsolute=function(o){return/^(?:\/|\w+:)/.test(o)},n=t.normalize=function(o){o=o.replace(/\\/g,"/").replace(/\/{2,}/g,"/");var s=o.split("/"),a=r(o),c="";a&&(c=s.shift()+"/");for(var l=0;l<s.length;)s[l]===".."?l>0&&s[l-1]!==".."?s.splice(--l,2):a?s.splice(l,1):++l:s[l]==="."?s.splice(l,1):++l;return c+s.join("/")};t.resolve=function(o,s,a){return a||(s=n(s)),r(s)?s:(a||(o=n(o)),(o=o.replace(/(?:\/|^)[^/]+$/,"")).length?n(o+"/"+s):s)}})(path);var types$1={},hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,function(e){var t=e,r=requireUtil(),n=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(s,a){var c=0,l={};for(a|=0;c<s.length;)l[n[c+a]]=s[c++];return l}t.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),t.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",r.emptyArray,null]),t.long=o([0,0,0,1,1],7),t.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),t.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0])}(types$1)),types$1}var field,hasRequiredField;function requireField(){if(hasRequiredField)return field;hasRequiredField=1,field=a;var e=requireObject();((a.prototype=Object.create(e.prototype)).constructor=a).className="Field";var t=require_enum(),r=requireTypes(),n=requireUtil(),o,s=/^required|optional|repeated$/;a.fromJSON=function(c,l){return new a(c,l.id,l.type,l.rule,l.extend,l.options,l.comment)};function a(c,l,h,u,d,f,_){if(n.isObject(u)?(_=d,f=u,u=d=void 0):n.isObject(d)&&(_=f,f=d,d=void 0),e.call(this,c,f),!n.isInteger(l)||l<0)throw TypeError("id must be a non-negative integer");if(!n.isString(h))throw TypeError("type must be a string");if(u!==void 0&&!s.test(u=u.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(d!==void 0&&!n.isString(d))throw TypeError("extend must be a string");u==="proto3_optional"&&(u="optional"),this.rule=u&&u!=="optional"?u:void 0,this.type=h,this.id=l,this.extend=d||void 0,this.required=u==="required",this.optional=!this.required,this.repeated=u==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=n.Long?r.long[h]!==void 0:!1,this.bytes=h==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=_}return Object.defineProperty(a.prototype,"packed",{get:function(){return this._packed===null&&(this._packed=this.getOption("packed")!==!1),this._packed}}),a.prototype.setOption=function(c,l,h){return c==="packed"&&(this._packed=null),e.prototype.setOption.call(this,c,l,h)},a.prototype.toJSON=function(c){var l=c?!!c.keepComments:!1;return n.toObject(["rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",l?this.comment:void 0])},a.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=r.defaults[this.type])===void 0?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof o?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof t&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&((this.options.packed===!0||this.options.packed!==void 0&&this.resolvedType&&!(this.resolvedType instanceof t))&&delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=n.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var c;n.base64.test(this.typeDefault)?n.base64.decode(this.typeDefault,c=n.newBuffer(n.base64.length(this.typeDefault)),0):n.utf8.write(this.typeDefault,c=n.newBuffer(n.utf8.length(this.typeDefault)),0),this.typeDefault=c}return this.map?this.defaultValue=n.emptyObject:this.repeated?this.defaultValue=n.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof o&&(this.parent.ctor.prototype[this.name]=this.defaultValue),e.prototype.resolve.call(this)},a.d=function(c,l,h,u){return typeof l=="function"?l=n.decorateType(l).name:l&&typeof l=="object"&&(l=n.decorateEnum(l).name),function(d,f){n.decorateType(d.constructor).add(new a(f,c,l,h,{default:u}))}},a._configure=function(c){o=c},field}var oneof,hasRequiredOneof;function requireOneof(){if(hasRequiredOneof)return oneof;hasRequiredOneof=1,oneof=n;var e=requireObject();((n.prototype=Object.create(e.prototype)).constructor=n).className="OneOf";var t=requireField(),r=requireUtil();function n(s,a,c,l){if(Array.isArray(a)||(c=a,a=void 0),e.call(this,s,c),!(a===void 0||Array.isArray(a)))throw TypeError("fieldNames must be an Array");this.oneof=a||[],this.fieldsArray=[],this.comment=l}n.fromJSON=function(s,a){return new n(s,a.oneof,a.options,a.comment)},n.prototype.toJSON=function(s){var a=s?!!s.keepComments:!1;return r.toObject(["options",this.options,"oneof",this.oneof,"comment",a?this.comment:void 0])};function o(s){if(s.parent)for(var a=0;a<s.fieldsArray.length;++a)s.fieldsArray[a].parent||s.parent.add(s.fieldsArray[a])}return n.prototype.add=function(s){if(!(s instanceof t))throw TypeError("field must be a Field");return s.parent&&s.parent!==this.parent&&s.parent.remove(s),this.oneof.push(s.name),this.fieldsArray.push(s),s.partOf=this,o(this),this},n.prototype.remove=function(s){if(!(s instanceof t))throw TypeError("field must be a Field");var a=this.fieldsArray.indexOf(s);if(a<0)throw Error(s+" is not a member of "+this);return this.fieldsArray.splice(a,1),a=this.oneof.indexOf(s.name),a>-1&&this.oneof.splice(a,1),s.partOf=null,this},n.prototype.onAdd=function(s){e.prototype.onAdd.call(this,s);for(var a=this,c=0;c<this.oneof.length;++c){var l=s.get(this.oneof[c]);l&&!l.partOf&&(l.partOf=a,a.fieldsArray.push(l))}o(this)},n.prototype.onRemove=function(s){for(var a=0,c;a<this.fieldsArray.length;++a)(c=this.fieldsArray[a]).parent&&c.parent.remove(c);e.prototype.onRemove.call(this,s)},n.d=function(){for(var s=new Array(arguments.length),a=0;a<arguments.length;)s[a]=arguments[a++];return function(c,l){r.decorateType(c.constructor).add(new n(l,s)),Object.defineProperty(c,l,{get:r.oneOfGetter(s),set:r.oneOfSetter(s)})}},oneof}var namespace,hasRequiredNamespace;function requireNamespace(){if(hasRequiredNamespace)return namespace;hasRequiredNamespace=1,namespace=l;var e=requireObject();((l.prototype=Object.create(e.prototype)).constructor=l).className="Namespace";var t=requireField(),r=requireUtil(),n=requireOneof(),o,s,a;l.fromJSON=function(u,d){return new l(u,d.options).addJSON(d.nested)};function c(u,d){if(u&&u.length){for(var f={},_=0;_<u.length;++_)f[u[_].name]=u[_].toJSON(d);return f}}l.arrayToJSON=c,l.isReservedId=function(u,d){if(u){for(var f=0;f<u.length;++f)if(typeof u[f]!="string"&&u[f][0]<=d&&u[f][1]>d)return!0}return!1},l.isReservedName=function(u,d){if(u){for(var f=0;f<u.length;++f)if(u[f]===d)return!0}return!1};function l(u,d){e.call(this,u,d),this.nested=void 0,this._nestedArray=null}function h(u){return u._nestedArray=null,u}return Object.defineProperty(l.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=r.toArray(this.nested))}}),l.prototype.toJSON=function(u){return r.toObject(["options",this.options,"nested",c(this.nestedArray,u)])},l.prototype.addJSON=function(u){var d=this;if(u)for(var f=Object.keys(u),_=0,p;_<f.length;++_)p=u[f[_]],d.add((p.fields!==void 0?o.fromJSON:p.values!==void 0?a.fromJSON:p.methods!==void 0?s.fromJSON:p.id!==void 0?t.fromJSON:l.fromJSON)(f[_],p));return this},l.prototype.get=function(u){return this.nested&&this.nested[u]||null},l.prototype.getEnum=function(u){if(this.nested&&this.nested[u]instanceof a)return this.nested[u].values;throw Error("no such enum: "+u)},l.prototype.add=function(u){if(!(u instanceof t&&u.extend!==void 0||u instanceof o||u instanceof n||u instanceof a||u instanceof s||u instanceof l))throw TypeError("object must be a valid nested object");if(!this.nested)this.nested={};else{var d=this.get(u.name);if(d)if(d instanceof l&&u instanceof l&&!(d instanceof o||d instanceof s)){for(var f=d.nestedArray,_=0;_<f.length;++_)u.add(f[_]);this.remove(d),this.nested||(this.nested={}),u.setOptions(d.options,!0)}else throw Error("duplicate name '"+u.name+"' in "+this)}return this.nested[u.name]=u,u.onAdd(this),h(this)},l.prototype.remove=function(u){if(!(u instanceof e))throw TypeError("object must be a ReflectionObject");if(u.parent!==this)throw Error(u+" is not a member of "+this);return delete this.nested[u.name],Object.keys(this.nested).length||(this.nested=void 0),u.onRemove(this),h(this)},l.prototype.define=function(u,d){if(r.isString(u))u=u.split(".");else if(!Array.isArray(u))throw TypeError("illegal path");if(u&&u.length&&u[0]==="")throw Error("path must be relative");for(var f=this;u.length>0;){var _=u.shift();if(f.nested&&f.nested[_]){if(f=f.nested[_],!(f instanceof l))throw Error("path conflicts with non-namespace objects")}else f.add(f=new l(_))}return d&&f.addJSON(d),f},l.prototype.resolveAll=function(){for(var u=this.nestedArray,d=0;d<u.length;)u[d]instanceof l?u[d++].resolveAll():u[d++].resolve();return this.resolve()},l.prototype.lookup=function(u,d,f){if(typeof d=="boolean"?(f=d,d=void 0):d&&!Array.isArray(d)&&(d=[d]),r.isString(u)&&u.length){if(u===".")return this.root;u=u.split(".")}else if(!u.length)return this;if(u[0]==="")return this.root.lookup(u.slice(1),d);var _=this.get(u[0]);if(_){if(u.length===1){if(!d||d.indexOf(_.constructor)>-1)return _}else if(_ instanceof l&&(_=_.lookup(u.slice(1),d,!0)))return _}else for(var p=0;p<this.nestedArray.length;++p)if(this._nestedArray[p]instanceof l&&(_=this._nestedArray[p].lookup(u,d,!0)))return _;return this.parent===null||f?null:this.parent.lookup(u,d)},l.prototype.lookupType=function(u){var d=this.lookup(u,[o]);if(!d)throw Error("no such type: "+u);return d},l.prototype.lookupEnum=function(u){var d=this.lookup(u,[a]);if(!d)throw Error("no such Enum '"+u+"' in "+this);return d},l.prototype.lookupTypeOrEnum=function(u){var d=this.lookup(u,[o,a]);if(!d)throw Error("no such Type or Enum '"+u+"' in "+this);return d},l.prototype.lookupService=function(u){var d=this.lookup(u,[s]);if(!d)throw Error("no such Service '"+u+"' in "+this);return d},l._configure=function(u,d,f){o=u,s=d,a=f},namespace}var mapfield,hasRequiredMapfield;function requireMapfield(){if(hasRequiredMapfield)return mapfield;hasRequiredMapfield=1,mapfield=n;var e=requireField();((n.prototype=Object.create(e.prototype)).constructor=n).className="MapField";var t=requireTypes(),r=requireUtil();function n(o,s,a,c,l,h){if(e.call(this,o,s,c,void 0,void 0,l,h),!r.isString(a))throw TypeError("keyType must be a string");this.keyType=a,this.resolvedKeyType=null,this.map=!0}return n.fromJSON=function(o,s){return new n(o,s.id,s.keyType,s.type,s.options,s.comment)},n.prototype.toJSON=function(o){var s=o?!!o.keepComments:!1;return r.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",s?this.comment:void 0])},n.prototype.resolve=function(){if(this.resolved)return this;if(t.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return e.prototype.resolve.call(this)},n.d=function(o,s,a){return typeof a=="function"?a=r.decorateType(a).name:a&&typeof a=="object"&&(a=r.decorateEnum(a).name),function(c,l){r.decorateType(c.constructor).add(new n(l,o,s,a))}},mapfield}var method,hasRequiredMethod;function requireMethod(){if(hasRequiredMethod)return method;hasRequiredMethod=1,method=r;var e=requireObject();((r.prototype=Object.create(e.prototype)).constructor=r).className="Method";var t=requireUtil();function r(n,o,s,a,c,l,h,u,d){if(t.isObject(c)?(h=c,c=l=void 0):t.isObject(l)&&(h=l,l=void 0),!(o===void 0||t.isString(o)))throw TypeError("type must be a string");if(!t.isString(s))throw TypeError("requestType must be a string");if(!t.isString(a))throw TypeError("responseType must be a string");e.call(this,n,h),this.type=o||"rpc",this.requestType=s,this.requestStream=c?!0:void 0,this.responseType=a,this.responseStream=l?!0:void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=u,this.parsedOptions=d}return r.fromJSON=function(n,o){return new r(n,o.type,o.requestType,o.responseType,o.requestStream,o.responseStream,o.options,o.comment,o.parsedOptions)},r.prototype.toJSON=function(n){var o=n?!!n.keepComments:!1;return t.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",o?this.comment:void 0,"parsedOptions",this.parsedOptions])},r.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),e.prototype.resolve.call(this))},method}var service,hasRequiredService;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=o;var e=requireNamespace();((o.prototype=Object.create(e.prototype)).constructor=o).className="Service";var t=requireMethod(),r=requireUtil(),n=rpc;function o(a,c){e.call(this,a,c),this.methods={},this._methodsArray=null}o.fromJSON=function(a,c){var l=new o(a,c.options);if(c.methods)for(var h=Object.keys(c.methods),u=0;u<h.length;++u)l.add(t.fromJSON(h[u],c.methods[h[u]]));return c.nested&&l.addJSON(c.nested),l.comment=c.comment,l},o.prototype.toJSON=function(a){var c=e.prototype.toJSON.call(this,a),l=a?!!a.keepComments:!1;return r.toObject(["options",c&&c.options||void 0,"methods",e.arrayToJSON(this.methodsArray,a)||{},"nested",c&&c.nested||void 0,"comment",l?this.comment:void 0])},Object.defineProperty(o.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=r.toArray(this.methods))}});function s(a){return a._methodsArray=null,a}return o.prototype.get=function(a){return this.methods[a]||e.prototype.get.call(this,a)},o.prototype.resolveAll=function(){for(var a=this.methodsArray,c=0;c<a.length;++c)a[c].resolve();return e.prototype.resolve.call(this)},o.prototype.add=function(a){if(this.get(a.name))throw Error("duplicate name '"+a.name+"' in "+this);return a instanceof t?(this.methods[a.name]=a,a.parent=this,s(this)):e.prototype.add.call(this,a)},o.prototype.remove=function(a){if(a instanceof t){if(this.methods[a.name]!==a)throw Error(a+" is not a member of "+this);return delete this.methods[a.name],a.parent=null,s(this)}return e.prototype.remove.call(this,a)},o.prototype.create=function(a,c,l){for(var h=new n.Service(a,c,l),u=0,d;u<this.methodsArray.length;++u){var f=r.lcFirst((d=this._methodsArray[u]).resolve().name).replace(/[^$\w_]/g,"");h[f]=r.codegen(["r","c"],r.isReserved(f)?f+"_":f)("return this.rpcCall(m,q,s,r,c)")({m:d,q:d.resolvedRequestType.ctor,s:d.resolvedResponseType.ctor})}return h},service}var message=Message$1,util$1=requireMinimal();function Message$1(e){if(e)for(var t=Object.keys(e),r=0;r<t.length;++r)this[t[r]]=e[t[r]]}Message$1.create=function e(t){return this.$type.create(t)},Message$1.encode=function e(t,r){return this.$type.encode(t,r)},Message$1.encodeDelimited=function e(t,r){return this.$type.encodeDelimited(t,r)},Message$1.decode=function e(t){return this.$type.decode(t)},Message$1.decodeDelimited=function e(t){return this.$type.decodeDelimited(t)},Message$1.verify=function e(t){return this.$type.verify(t)},Message$1.fromObject=function e(t){return this.$type.fromObject(t)},Message$1.toObject=function e(t,r){return this.$type.toObject(t,r)},Message$1.prototype.toJSON=function e(){return this.$type.toObject(this,util$1.toJSONOptions)};var decoder_1,hasRequiredDecoder;function requireDecoder(){if(hasRequiredDecoder)return decoder_1;hasRequiredDecoder=1,decoder_1=o;var e=require_enum(),t=requireTypes(),r=requireUtil();function n(s){return"missing required '"+s.name+"'"}function o(s){var a=r.codegen(["r","l"],s.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(s.fieldsArray.filter(function(f){return f.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");s.group&&a("if((t&7)===4)")("break"),a("switch(t>>>3){");for(var c=0;c<s.fieldsArray.length;++c){var l=s._fieldsArray[c].resolve(),h=l.resolvedType instanceof e?"int32":l.type,u="m"+r.safeProp(l.name);a("case %i: {",l.id),l.map?(a("if(%s===util.emptyObject)",u)("%s={}",u)("var c2 = r.uint32()+r.pos"),t.defaults[l.keyType]!==void 0?a("k=%j",t.defaults[l.keyType]):a("k=null"),t.defaults[h]!==void 0?a("value=%j",t.defaults[h]):a("value=null"),a("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",l.keyType)("case 2:"),t.basic[h]===void 0?a("value=types[%i].decode(r,r.uint32())",c):a("value=r.%s()",h),a("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),t.long[l.keyType]!==void 0?a('%s[typeof k==="object"?util.longToHash(k):k]=value',u):a("%s[k]=value",u)):l.repeated?(a("if(!(%s&&%s.length))",u,u)("%s=[]",u),t.packed[h]!==void 0&&a("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",u,h)("}else"),t.basic[h]===void 0?a(l.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",u,c):a("%s.push(r.%s())",u,h)):t.basic[h]===void 0?a(l.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",u,c):a("%s=r.%s()",u,h),a("break")("}")}for(a("default:")("r.skipType(t&7)")("break")("}")("}"),c=0;c<s._fieldsArray.length;++c){var d=s._fieldsArray[c];d.required&&a("if(!m.hasOwnProperty(%j))",d.name)("throw util.ProtocolError(%j,{instance:m})",n(d))}return a("return m")}return decoder_1}var verifier_1,hasRequiredVerifier;function requireVerifier(){if(hasRequiredVerifier)return verifier_1;hasRequiredVerifier=1,verifier_1=s;var e=require_enum(),t=requireUtil();function r(a,c){return a.name+": "+c+(a.repeated&&c!=="array"?"[]":a.map&&c!=="object"?"{k:"+a.keyType+"}":"")+" expected"}function n(a,c,l,h){if(c.resolvedType)if(c.resolvedType instanceof e){a("switch(%s){",h)("default:")("return%j",r(c,"enum value"));for(var u=Object.keys(c.resolvedType.values),d=0;d<u.length;++d)a("case %i:",c.resolvedType.values[u[d]]);a("break")("}")}else a("{")("var e=types[%i].verify(%s);",l,h)("if(e)")("return%j+e",c.name+".")("}");else switch(c.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":a("if(!util.isInteger(%s))",h)("return%j",r(c,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":a("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",h,h,h,h)("return%j",r(c,"integer|Long"));break;case"float":case"double":a('if(typeof %s!=="number")',h)("return%j",r(c,"number"));break;case"bool":a('if(typeof %s!=="boolean")',h)("return%j",r(c,"boolean"));break;case"string":a("if(!util.isString(%s))",h)("return%j",r(c,"string"));break;case"bytes":a('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',h,h,h)("return%j",r(c,"buffer"));break}return a}function o(a,c,l){switch(c.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":a("if(!util.key32Re.test(%s))",l)("return%j",r(c,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":a("if(!util.key64Re.test(%s))",l)("return%j",r(c,"integer|Long key"));break;case"bool":a("if(!util.key2Re.test(%s))",l)("return%j",r(c,"boolean key"));break}return a}function s(a){var c=t.codegen(["m"],a.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),l=a.oneofsArray,h={};l.length&&c("var p={}");for(var u=0;u<a.fieldsArray.length;++u){var d=a._fieldsArray[u].resolve(),f="m"+t.safeProp(d.name);if(d.optional&&c("if(%s!=null&&m.hasOwnProperty(%j)){",f,d.name),d.map)c("if(!util.isObject(%s))",f)("return%j",r(d,"object"))("var k=Object.keys(%s)",f)("for(var i=0;i<k.length;++i){"),o(c,d,"k[i]"),n(c,d,u,f+"[k[i]]")("}");else if(d.repeated)c("if(!Array.isArray(%s))",f)("return%j",r(d,"array"))("for(var i=0;i<%s.length;++i){",f),n(c,d,u,f+"[i]")("}");else{if(d.partOf){var _=t.safeProp(d.partOf.name);h[d.partOf.name]===1&&c("if(p%s===1)",_)("return%j",d.partOf.name+": multiple values"),h[d.partOf.name]=1,c("p%s=1",_)}n(c,d,u,f)}d.optional&&c("}")}return c("return null")}return verifier_1}var converter={},hasRequiredConverter;function requireConverter(){return hasRequiredConverter||(hasRequiredConverter=1,function(e){var t=e,r=require_enum(),n=requireUtil();function o(a,c,l,h){var u=!1;if(c.resolvedType)if(c.resolvedType instanceof r){a("switch(d%s){",h);for(var d=c.resolvedType.values,f=Object.keys(d),_=0;_<f.length;++_)d[f[_]]===c.typeDefault&&!u&&(a("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',h,h,h),c.repeated||a("break"),u=!0),a("case%j:",f[_])("case %i:",d[f[_]])("m%s=%j",h,d[f[_]])("break");a("}")}else a('if(typeof d%s!=="object")',h)("throw TypeError(%j)",c.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",h,l,h);else{var p=!1;switch(c.type){case"double":case"float":a("m%s=Number(d%s)",h,h);break;case"uint32":case"fixed32":a("m%s=d%s>>>0",h,h);break;case"int32":case"sint32":case"sfixed32":a("m%s=d%s|0",h,h);break;case"uint64":p=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":a("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",h,h,p)('else if(typeof d%s==="string")',h)("m%s=parseInt(d%s,10)",h,h)('else if(typeof d%s==="number")',h)("m%s=d%s",h,h)('else if(typeof d%s==="object")',h)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",h,h,h,p?"true":"");break;case"bytes":a('if(typeof d%s==="string")',h)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",h,h,h)("else if(d%s.length >= 0)",h)("m%s=d%s",h,h);break;case"string":a("m%s=String(d%s)",h,h);break;case"bool":a("m%s=Boolean(d%s)",h,h);break}}return a}t.fromObject=function(a){var c=a.fieldsArray,l=n.codegen(["d"],a.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!c.length)return l("return new this.ctor");l("var m=new this.ctor");for(var h=0;h<c.length;++h){var u=c[h].resolve(),d=n.safeProp(u.name);u.map?(l("if(d%s){",d)('if(typeof d%s!=="object")',d)("throw TypeError(%j)",u.fullName+": object expected")("m%s={}",d)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",d),o(l,u,h,d+"[ks[i]]")("}")("}")):u.repeated?(l("if(d%s){",d)("if(!Array.isArray(d%s))",d)("throw TypeError(%j)",u.fullName+": array expected")("m%s=[]",d)("for(var i=0;i<d%s.length;++i){",d),o(l,u,h,d+"[i]")("}")("}")):(u.resolvedType instanceof r||l("if(d%s!=null){",d),o(l,u,h,d),u.resolvedType instanceof r||l("}"))}return l("return m")};function s(a,c,l,h){if(c.resolvedType)c.resolvedType instanceof r?a("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",h,l,h,h,l,h,h):a("d%s=types[%i].toObject(m%s,o)",h,l,h);else{var u=!1;switch(c.type){case"double":case"float":a("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",h,h,h,h);break;case"uint64":u=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":a('if(typeof m%s==="number")',h)("d%s=o.longs===String?String(m%s):m%s",h,h,h)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",h,h,h,h,u?"true":"",h);break;case"bytes":a("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",h,h,h,h,h);break;default:a("d%s=m%s",h,h);break}}return a}t.toObject=function(a){var c=a.fieldsArray.slice().sort(n.compareFieldsById);if(!c.length)return n.codegen()("return {}");for(var l=n.codegen(["m","o"],a.name+"$toObject")("if(!o)")("o={}")("var d={}"),h=[],u=[],d=[],f=0;f<c.length;++f)c[f].partOf||(c[f].resolve().repeated?h:c[f].map?u:d).push(c[f]);if(h.length){for(l("if(o.arrays||o.defaults){"),f=0;f<h.length;++f)l("d%s=[]",n.safeProp(h[f].name));l("}")}if(u.length){for(l("if(o.objects||o.defaults){"),f=0;f<u.length;++f)l("d%s={}",n.safeProp(u[f].name));l("}")}if(d.length){for(l("if(o.defaults){"),f=0;f<d.length;++f){var _=d[f],p=n.safeProp(_.name);if(_.resolvedType instanceof r)l("d%s=o.enums===String?%j:%j",p,_.resolvedType.valuesById[_.typeDefault],_.typeDefault);else if(_.long)l("if(util.Long){")("var n=new util.Long(%i,%i,%j)",_.typeDefault.low,_.typeDefault.high,_.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",p)("}else")("d%s=o.longs===String?%j:%i",p,_.typeDefault.toString(),_.typeDefault.toNumber());else if(_.bytes){var y="["+Array.prototype.slice.call(_.typeDefault).join(",")+"]";l("if(o.bytes===String)d%s=%j",p,String.fromCharCode.apply(String,_.typeDefault))("else{")("d%s=%s",p,y)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",p,p)("}")}else l("d%s=%j",p,_.typeDefault)}l("}")}var w=!1;for(f=0;f<c.length;++f){var _=c[f],E=a._fieldsArray.indexOf(_),p=n.safeProp(_.name);_.map?(w||(w=!0,l("var ks2")),l("if(m%s&&(ks2=Object.keys(m%s)).length){",p,p)("d%s={}",p)("for(var j=0;j<ks2.length;++j){"),s(l,_,E,p+"[ks2[j]]")("}")):_.repeated?(l("if(m%s&&m%s.length){",p,p)("d%s=[]",p)("for(var j=0;j<m%s.length;++j){",p),s(l,_,E,p+"[j]")("}")):(l("if(m%s!=null&&m.hasOwnProperty(%j)){",p,_.name),s(l,_,E,p),_.partOf&&l("if(o.oneofs)")("d%s=%j",n.safeProp(_.partOf.name),_.name)),l("}")}return l("return d")}}(converter)),converter}var wrappers={};(function(e){var t=e,r=message;t[".google.protobuf.Any"]={fromObject:function(n){if(n&&n["@type"]){var o=n["@type"].substring(n["@type"].lastIndexOf("/")+1),s=this.lookup(o);if(s){var a=n["@type"].charAt(0)==="."?n["@type"].slice(1):n["@type"];return a.indexOf("/")===-1&&(a="/"+a),this.create({type_url:a,value:s.encode(s.fromObject(n)).finish()})}}return this.fromObject(n)},toObject:function(n,o){var s="type.googleapis.com/",a="",c="";if(o&&o.json&&n.type_url&&n.value){c=n.type_url.substring(n.type_url.lastIndexOf("/")+1),a=n.type_url.substring(0,n.type_url.lastIndexOf("/")+1);var l=this.lookup(c);l&&(n=l.decode(n.value))}if(!(n instanceof this.ctor)&&n instanceof r){var h=n.$type.toObject(n,o),u=n.$type.fullName[0]==="."?n.$type.fullName.slice(1):n.$type.fullName;return a===""&&(a=s),c=a+u,h["@type"]=c,h}return this.toObject(n,o)}}})(wrappers);var type$1,hasRequiredType;function requireType(){if(hasRequiredType)return type$1;hasRequiredType=1,type$1=y;var e=requireNamespace();((y.prototype=Object.create(e.prototype)).constructor=y).className="Type";var t=require_enum(),r=requireOneof(),n=requireField(),o=requireMapfield(),s=requireService(),a=message,c=reader,l=writer,h=requireUtil(),u=requireEncoder(),d=requireDecoder(),f=requireVerifier(),_=requireConverter(),p=wrappers;function y(E,x){e.call(this,E,x),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}Object.defineProperties(y.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var E=Object.keys(this.fields),x=0;x<E.length;++x){var B=this.fields[E[x]],P=B.id;if(this._fieldsById[P])throw Error("duplicate id "+P+" in "+this);this._fieldsById[P]=B}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=h.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=h.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=y.generateConstructor(this)())},set:function(E){var x=E.prototype;x instanceof a||((E.prototype=new a).constructor=E,h.merge(E.prototype,x)),E.$type=E.prototype.$type=this,h.merge(E,a,!0),this._ctor=E;for(var B=0;B<this.fieldsArray.length;++B)this._fieldsArray[B].resolve();var P={};for(B=0;B<this.oneofsArray.length;++B)P[this._oneofsArray[B].resolve().name]={get:h.oneOfGetter(this._oneofsArray[B].oneof),set:h.oneOfSetter(this._oneofsArray[B].oneof)};B&&Object.defineProperties(E.prototype,P)}}}),y.generateConstructor=function(E){for(var x=h.codegen(["p"],E.name),B=0,P;B<E.fieldsArray.length;++B)(P=E._fieldsArray[B]).map?x("this%s={}",h.safeProp(P.name)):P.repeated&&x("this%s=[]",h.safeProp(P.name));return x("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")};function w(E){return E._fieldsById=E._fieldsArray=E._oneofsArray=null,delete E.encode,delete E.decode,delete E.verify,E}return y.fromJSON=function(E,x){var B=new y(E,x.options);B.extensions=x.extensions,B.reserved=x.reserved;for(var P=Object.keys(x.fields),U=0;U<P.length;++U)B.add((typeof x.fields[P[U]].keyType<"u"?o.fromJSON:n.fromJSON)(P[U],x.fields[P[U]]));if(x.oneofs)for(P=Object.keys(x.oneofs),U=0;U<P.length;++U)B.add(r.fromJSON(P[U],x.oneofs[P[U]]));if(x.nested)for(P=Object.keys(x.nested),U=0;U<P.length;++U){var F=x.nested[P[U]];B.add((F.id!==void 0?n.fromJSON:F.fields!==void 0?y.fromJSON:F.values!==void 0?t.fromJSON:F.methods!==void 0?s.fromJSON:e.fromJSON)(P[U],F))}return x.extensions&&x.extensions.length&&(B.extensions=x.extensions),x.reserved&&x.reserved.length&&(B.reserved=x.reserved),x.group&&(B.group=!0),x.comment&&(B.comment=x.comment),B},y.prototype.toJSON=function(E){var x=e.prototype.toJSON.call(this,E),B=E?!!E.keepComments:!1;return h.toObject(["options",x&&x.options||void 0,"oneofs",e.arrayToJSON(this.oneofsArray,E),"fields",e.arrayToJSON(this.fieldsArray.filter(function(P){return!P.declaringField}),E)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",x&&x.nested||void 0,"comment",B?this.comment:void 0])},y.prototype.resolveAll=function(){for(var E=this.fieldsArray,x=0;x<E.length;)E[x++].resolve();var B=this.oneofsArray;for(x=0;x<B.length;)B[x++].resolve();return e.prototype.resolveAll.call(this)},y.prototype.get=function(E){return this.fields[E]||this.oneofs&&this.oneofs[E]||this.nested&&this.nested[E]||null},y.prototype.add=function(E){if(this.get(E.name))throw Error("duplicate name '"+E.name+"' in "+this);if(E instanceof n&&E.extend===void 0){if(this._fieldsById?this._fieldsById[E.id]:this.fieldsById[E.id])throw Error("duplicate id "+E.id+" in "+this);if(this.isReservedId(E.id))throw Error("id "+E.id+" is reserved in "+this);if(this.isReservedName(E.name))throw Error("name '"+E.name+"' is reserved in "+this);return E.parent&&E.parent.remove(E),this.fields[E.name]=E,E.message=this,E.onAdd(this),w(this)}return E instanceof r?(this.oneofs||(this.oneofs={}),this.oneofs[E.name]=E,E.onAdd(this),w(this)):e.prototype.add.call(this,E)},y.prototype.remove=function(E){if(E instanceof n&&E.extend===void 0){if(!this.fields||this.fields[E.name]!==E)throw Error(E+" is not a member of "+this);return delete this.fields[E.name],E.parent=null,E.onRemove(this),w(this)}if(E instanceof r){if(!this.oneofs||this.oneofs[E.name]!==E)throw Error(E+" is not a member of "+this);return delete this.oneofs[E.name],E.parent=null,E.onRemove(this),w(this)}return e.prototype.remove.call(this,E)},y.prototype.isReservedId=function(E){return e.isReservedId(this.reserved,E)},y.prototype.isReservedName=function(E){return e.isReservedName(this.reserved,E)},y.prototype.create=function(E){return new this.ctor(E)},y.prototype.setup=function(){for(var E=this.fullName,x=[],B=0;B<this.fieldsArray.length;++B)x.push(this._fieldsArray[B].resolve().resolvedType);this.encode=u(this)({Writer:l,types:x,util:h}),this.decode=d(this)({Reader:c,types:x,util:h}),this.verify=f(this)({types:x,util:h}),this.fromObject=_.fromObject(this)({types:x,util:h}),this.toObject=_.toObject(this)({types:x,util:h});var P=p[E];if(P){var U=Object.create(this);U.fromObject=this.fromObject,this.fromObject=P.fromObject.bind(U),U.toObject=this.toObject,this.toObject=P.toObject.bind(U)}return this},y.prototype.encode=function(E,x){return this.setup().encode(E,x)},y.prototype.encodeDelimited=function(E,x){return this.encode(E,x&&x.len?x.fork():x).ldelim()},y.prototype.decode=function(E,x){return this.setup().decode(E,x)},y.prototype.decodeDelimited=function(E){return E instanceof c||(E=c.create(E)),this.decode(E,E.uint32())},y.prototype.verify=function(E){return this.setup().verify(E)},y.prototype.fromObject=function(E){return this.setup().fromObject(E)},y.prototype.toObject=function(E,x){return this.setup().toObject(E,x)},y.d=function(E){return function(x){h.decorateType(x,E)}},type$1}var root$2,hasRequiredRoot;function requireRoot(){if(hasRequiredRoot)return root$2;hasRequiredRoot=1,root$2=l;var e=requireNamespace();((l.prototype=Object.create(e.prototype)).constructor=l).className="Root";var t=requireField(),r=require_enum(),n=requireOneof(),o=requireUtil(),s,a,c;function l(f){e.call(this,"",f),this.deferred=[],this.files=[]}l.fromJSON=function(f,_){return _||(_=new l),f.options&&_.setOptions(f.options),_.addJSON(f.nested)},l.prototype.resolvePath=o.path.resolve,l.prototype.fetch=o.fetch;function h(){}l.prototype.load=function f(_,p,y){typeof p=="function"&&(y=p,p=void 0);var w=this;if(!y)return o.asPromise(f,w,_,p);var E=y===h;function x(te,J){if(y){if(E)throw te;var le=y;y=null,le(te,J)}}function B(te){var J=te.lastIndexOf("google/protobuf/");if(J>-1){var le=te.substring(J);if(le in c)return le}return null}function P(te,J){try{if(o.isString(J)&&J.charAt(0)==="{"&&(J=JSON.parse(J)),!o.isString(J))w.setOptions(J.options).addJSON(J.nested);else{a.filename=te;var le=a(J,w,p),z,q=0;if(le.imports)for(;q<le.imports.length;++q)(z=B(le.imports[q])||w.resolvePath(te,le.imports[q]))&&U(z);if(le.weakImports)for(q=0;q<le.weakImports.length;++q)(z=B(le.weakImports[q])||w.resolvePath(te,le.weakImports[q]))&&U(z,!0)}}catch(he){x(he)}!E&&!F&&x(null,w)}function U(te,J){if(te=B(te)||te,!(w.files.indexOf(te)>-1)){if(w.files.push(te),te in c){E?P(te,c[te]):(++F,setTimeout(function(){--F,P(te,c[te])}));return}if(E){var le;try{le=o.fs.readFileSync(te).toString("utf8")}catch(z){J||x(z);return}P(te,le)}else++F,w.fetch(te,function(z,q){if(--F,!!y){if(z){J?F||x(null,w):x(z);return}P(te,q)}})}}var F=0;o.isString(_)&&(_=[_]);for(var G=0,H;G<_.length;++G)(H=w.resolvePath("",_[G]))&&U(H);if(E)return w;F||x(null,w)},l.prototype.loadSync=function(f,_){if(!o.isNode)throw Error("not supported");return this.load(f,_,h)},l.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(f){return"'extend "+f.extend+"' in "+f.parent.fullName}).join(", "));return e.prototype.resolveAll.call(this)};var u=/^[A-Z]/;function d(f,_){var p=_.parent.lookup(_.extend);if(p){var y=new t(_.fullName,_.id,_.type,_.rule,void 0,_.options);return p.get(y.name)||(y.declaringField=_,_.extensionField=y,p.add(y)),!0}return!1}return l.prototype._handleAdd=function(f){if(f instanceof t)f.extend!==void 0&&!f.extensionField&&(d(this,f)||this.deferred.push(f));else if(f instanceof r)u.test(f.name)&&(f.parent[f.name]=f.values);else if(!(f instanceof n)){if(f instanceof s)for(var _=0;_<this.deferred.length;)d(this,this.deferred[_])?this.deferred.splice(_,1):++_;for(var p=0;p<f.nestedArray.length;++p)this._handleAdd(f._nestedArray[p]);u.test(f.name)&&(f.parent[f.name]=f)}},l.prototype._handleRemove=function(f){if(f instanceof t){if(f.extend!==void 0)if(f.extensionField)f.extensionField.parent.remove(f.extensionField),f.extensionField=null;else{var _=this.deferred.indexOf(f);_>-1&&this.deferred.splice(_,1)}}else if(f instanceof r)u.test(f.name)&&delete f.parent[f.name];else if(f instanceof e){for(var p=0;p<f.nestedArray.length;++p)this._handleRemove(f._nestedArray[p]);u.test(f.name)&&delete f.parent[f.name]}},l._configure=function(f,_,p){s=f,a=_,c=p},root$2}var hasRequiredUtil;function requireUtil(){if(hasRequiredUtil)return util$2.exports;hasRequiredUtil=1;var e=util$2.exports=requireMinimal(),t=roots,r,n;e.codegen=codegen_1,e.fetch=fetch_1,e.path=path,e.fs=e.inquire("fs"),e.toArray=function(l){if(l){for(var h=Object.keys(l),u=new Array(h.length),d=0;d<h.length;)u[d]=l[h[d++]];return u}return[]},e.toObject=function(l){for(var h={},u=0;u<l.length;){var d=l[u++],f=l[u++];f!==void 0&&(h[d]=f)}return h};var o=/\\/g,s=/"/g;e.isReserved=function(l){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(l)},e.safeProp=function(l){return!/^[$\w_]+$/.test(l)||e.isReserved(l)?'["'+l.replace(o,"\\\\").replace(s,'\\"')+'"]':"."+l},e.ucFirst=function(l){return l.charAt(0).toUpperCase()+l.substring(1)};var a=/_([a-z])/g;e.camelCase=function(l){return l.substring(0,1)+l.substring(1).replace(a,function(h,u){return u.toUpperCase()})},e.compareFieldsById=function(l,h){return l.id-h.id},e.decorateType=function(l,h){if(l.$type)return h&&l.$type.name!==h&&(e.decorateRoot.remove(l.$type),l.$type.name=h,e.decorateRoot.add(l.$type)),l.$type;r||(r=requireType());var u=new r(h||l.name);return e.decorateRoot.add(u),u.ctor=l,Object.defineProperty(l,"$type",{value:u,enumerable:!1}),Object.defineProperty(l.prototype,"$type",{value:u,enumerable:!1}),u};var c=0;return e.decorateEnum=function(l){if(l.$type)return l.$type;n||(n=require_enum());var h=new n("Enum"+c++,l);return e.decorateRoot.add(h),Object.defineProperty(l,"$type",{value:h,enumerable:!1}),h},e.setProperty=function(l,h,u){function d(f,_,p){var y=_.shift();if(y==="__proto__"||y==="prototype")return f;if(_.length>0)f[y]=d(f[y]||{},_,p);else{var w=f[y];w&&(p=[].concat(w).concat(p)),f[y]=p}return f}if(typeof l!="object")throw TypeError("dst must be an object");if(!h)throw TypeError("path must be specified");return h=h.split("."),d(l,h,u)},Object.defineProperty(e,"decorateRoot",{get:function(){return t.decorated||(t.decorated=new(requireRoot()))}}),util$2.exports}var object,hasRequiredObject;function requireObject(){if(hasRequiredObject)return object;hasRequiredObject=1,object=r,r.className="ReflectionObject";var e=requireUtil(),t;function r(n,o){if(!e.isString(n))throw TypeError("name must be a string");if(o&&!e.isObject(o))throw TypeError("options must be an object");this.options=o,this.parsedOptions=null,this.name=n,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}return Object.defineProperties(r.prototype,{root:{get:function(){for(var n=this;n.parent!==null;)n=n.parent;return n}},fullName:{get:function(){for(var n=[this.name],o=this.parent;o;)n.unshift(o.name),o=o.parent;return n.join(".")}}}),r.prototype.toJSON=function(){throw Error()},r.prototype.onAdd=function(n){this.parent&&this.parent!==n&&this.parent.remove(this),this.parent=n,this.resolved=!1;var o=n.root;o instanceof t&&o._handleAdd(this)},r.prototype.onRemove=function(n){var o=n.root;o instanceof t&&o._handleRemove(this),this.parent=null,this.resolved=!1},r.prototype.resolve=function(){return this.resolved?this:(this.root instanceof t&&(this.resolved=!0),this)},r.prototype.getOption=function(n){if(this.options)return this.options[n]},r.prototype.setOption=function(n,o,s){return(!s||!this.options||this.options[n]===void 0)&&((this.options||(this.options={}))[n]=o),this},r.prototype.setParsedOption=function(n,o,s){this.parsedOptions||(this.parsedOptions=[]);var a=this.parsedOptions;if(s){var c=a.find(function(u){return Object.prototype.hasOwnProperty.call(u,n)});if(c){var l=c[n];e.setProperty(l,s,o)}else c={},c[n]=e.setProperty({},s,o),a.push(c)}else{var h={};h[n]=o,a.push(h)}return this},r.prototype.setOptions=function(n,o){if(n)for(var s=Object.keys(n),a=0;a<s.length;++a)this.setOption(s[a],n[s[a]],o);return this},r.prototype.toString=function(){var n=this.constructor.className,o=this.fullName;return o.length?n+" "+o:n},r._configure=function(n){t=n},object}var _enum,hasRequired_enum;function require_enum(){if(hasRequired_enum)return _enum;hasRequired_enum=1,_enum=n;var e=requireObject();((n.prototype=Object.create(e.prototype)).constructor=n).className="Enum";var t=requireNamespace(),r=requireUtil();function n(o,s,a,c,l,h){if(e.call(this,o,a),s&&typeof s!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=c,this.comments=l||{},this.valuesOptions=h,this.reserved=void 0,s)for(var u=Object.keys(s),d=0;d<u.length;++d)typeof s[u[d]]=="number"&&(this.valuesById[this.values[u[d]]=s[u[d]]]=u[d])}return n.fromJSON=function(o,s){var a=new n(o,s.values,s.options,s.comment,s.comments);return a.reserved=s.reserved,a},n.prototype.toJSON=function(o){var s=o?!!o.keepComments:!1;return r.toObject(["options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",s?this.comment:void 0,"comments",s?this.comments:void 0])},n.prototype.add=function(o,s,a,c){if(!r.isString(o))throw TypeError("name must be a string");if(!r.isInteger(s))throw TypeError("id must be an integer");if(this.values[o]!==void 0)throw Error("duplicate name '"+o+"' in "+this);if(this.isReservedId(s))throw Error("id "+s+" is reserved in "+this);if(this.isReservedName(o))throw Error("name '"+o+"' is reserved in "+this);if(this.valuesById[s]!==void 0){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+s+" in "+this);this.values[o]=s}else this.valuesById[this.values[o]=s]=o;return c&&(this.valuesOptions===void 0&&(this.valuesOptions={}),this.valuesOptions[o]=c||null),this.comments[o]=a||null,this},n.prototype.remove=function(o){if(!r.isString(o))throw TypeError("name must be a string");var s=this.values[o];if(s==null)throw Error("name '"+o+"' does not exist in "+this);return delete this.valuesById[s],delete this.values[o],delete this.comments[o],this.valuesOptions&&delete this.valuesOptions[o],this},n.prototype.isReservedId=function(o){return t.isReservedId(this.reserved,o)},n.prototype.isReservedName=function(o){return t.isReservedName(this.reserved,o)},_enum}var encoder_1,hasRequiredEncoder;function requireEncoder(){if(hasRequiredEncoder)return encoder_1;hasRequiredEncoder=1,encoder_1=o;var e=require_enum(),t=requireTypes(),r=requireUtil();function n(s,a,c,l){return a.resolvedType.group?s("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",c,l,(a.id<<3|3)>>>0,(a.id<<3|4)>>>0):s("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",c,l,(a.id<<3|2)>>>0)}function o(s){for(var a=r.codegen(["m","w"],s.name+"$encode")("if(!w)")("w=Writer.create()"),h,c,l=s.fieldsArray.slice().sort(r.compareFieldsById),h=0;h<l.length;++h){var u=l[h].resolve(),d=s._fieldsArray.indexOf(u),f=u.resolvedType instanceof e?"int32":u.type,_=t.basic[f];c="m"+r.safeProp(u.name),u.map?(a("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",c,u.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",c)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(u.id<<3|2)>>>0,8|t.mapKey[u.keyType],u.keyType),_===void 0?a("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",d,c):a(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|_,f,c),a("}")("}")):u.repeated?(a("if(%s!=null&&%s.length){",c,c),u.packed&&t.packed[f]!==void 0?a("w.uint32(%i).fork()",(u.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",c)("w.%s(%s[i])",f,c)("w.ldelim()"):(a("for(var i=0;i<%s.length;++i)",c),_===void 0?n(a,u,d,c+"[i]"):a("w.uint32(%i).%s(%s[i])",(u.id<<3|_)>>>0,f,c)),a("}")):(u.optional&&a("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",c,u.name),_===void 0?n(a,u,d,c):a("w.uint32(%i).%s(%s)",(u.id<<3|_)>>>0,f,c))}return a("return w")}return encoder_1}var protobuf$1=indexLight.exports=indexMinimal;protobuf$1.build="light";function load$3(e,t,r){return typeof t=="function"?(r=t,t=new protobuf$1.Root):t||(t=new protobuf$1.Root),t.load(e,r)}protobuf$1.load=load$3;function loadSync(e,t){return t||(t=new protobuf$1.Root),t.loadSync(e)}protobuf$1.loadSync=loadSync,protobuf$1.encoder=requireEncoder(),protobuf$1.decoder=requireDecoder(),protobuf$1.verifier=requireVerifier(),protobuf$1.converter=requireConverter(),protobuf$1.ReflectionObject=requireObject(),protobuf$1.Namespace=requireNamespace(),protobuf$1.Root=requireRoot(),protobuf$1.Enum=require_enum(),protobuf$1.Type=requireType(),protobuf$1.Field=requireField(),protobuf$1.OneOf=requireOneof(),protobuf$1.MapField=requireMapfield(),protobuf$1.Service=requireService(),protobuf$1.Method=requireMethod(),protobuf$1.Message=message,protobuf$1.wrappers=wrappers,protobuf$1.types=requireTypes(),protobuf$1.util=requireUtil(),protobuf$1.ReflectionObject._configure(protobuf$1.Root),protobuf$1.Namespace._configure(protobuf$1.Type,protobuf$1.Service,protobuf$1.Enum),protobuf$1.Root._configure(protobuf$1.Type),protobuf$1.Field._configure(protobuf$1.Type);var indexLightExports=indexLight.exports,tokenize_1=tokenize$1,delimRe=/[\s{}=;:[\],'"()<>]/g,stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,setCommentRe=/^ *[*/]+ */,setCommentAltRe=/^\s*\*?\/*/,setCommentSplitRe=/\n/g,whitespaceRe=/\s/,unescapeRe=/\\(.?)/g,unescapeMap={0:"\0",r:"\r",n:`
`,t:"	"};function unescape(e){return e.replace(unescapeRe,function(t,r){switch(r){case"\\":case"":return r;default:return unescapeMap[r]||""}})}tokenize$1.unescape=unescape;function tokenize$1(e,t){e=e.toString();var r=0,n=e.length,o=1,s=0,a={},c=[],l=null;function h(P){return Error("illegal "+P+" (line "+o+")")}function u(){var P=l==="'"?stringSingleRe:stringDoubleRe;P.lastIndex=r-1;var U=P.exec(e);if(!U)throw h("string");return r=P.lastIndex,w(l),l=null,unescape(U[1])}function d(P){return e.charAt(P)}function f(P,U,F){var G={type:e.charAt(P++),lineEmpty:!1,leading:F},H;t?H=2:H=3;var te=P-H,J;do if(--te<0||(J=e.charAt(te))===`
`){G.lineEmpty=!0;break}while(J===" "||J==="	");for(var le=e.substring(P,U).split(setCommentSplitRe),z=0;z<le.length;++z)le[z]=le[z].replace(t?setCommentAltRe:setCommentRe,"").trim();G.text=le.join(`
`).trim(),a[o]=G,s=o}function _(P){var U=p(P),F=e.substring(P,U),G=/^\s*\/\//.test(F);return G}function p(P){for(var U=P;U<n&&d(U)!==`
`;)U++;return U}function y(){if(c.length>0)return c.shift();if(l)return u();var P,U,F,G,H,te=r===0;do{if(r===n)return null;for(P=!1;whitespaceRe.test(F=d(r));)if(F===`
`&&(te=!0,++o),++r===n)return null;if(d(r)==="/"){if(++r===n)throw h("comment");if(d(r)==="/")if(t){if(G=r,H=!1,_(r-1)){H=!0;do if(r=p(r),r===n||(r++,!te))break;while(_(r))}else r=Math.min(n,p(r)+1);H&&(f(G,r,te),te=!0),o++,P=!0}else{for(H=d(G=r+1)==="/";d(++r)!==`
`;)if(r===n)return null;++r,H&&(f(G,r-1,te),te=!0),++o,P=!0}else if((F=d(r))==="*"){G=r+1,H=t||d(G)==="*";do{if(F===`
`&&++o,++r===n)throw h("comment");U=F,F=d(r)}while(U!=="*"||F!=="/");++r,H&&(f(G,r-2,te),te=!0),P=!0}else return"/"}}while(P);var J=r;delimRe.lastIndex=0;var le=delimRe.test(d(J++));if(!le)for(;J<n&&!delimRe.test(d(J));)++J;var z=e.substring(r,r=J);return(z==='"'||z==="'")&&(l=z),z}function w(P){c.push(P)}function E(){if(!c.length){var P=y();if(P===null)return null;w(P)}return c[0]}function x(P,U){var F=E(),G=F===P;if(G)return y(),!0;if(!U)throw h("token '"+F+"', '"+P+"' expected");return!1}function B(P){var U=null,F;return P===void 0?(F=a[o-1],delete a[o-1],F&&(t||F.type==="*"||F.lineEmpty)&&(U=F.leading?F.text:null)):(s<P&&E(),F=a[P],delete a[P],F&&!F.lineEmpty&&(t||F.type==="/")&&(U=F.leading?null:F.text)),U}return Object.defineProperty({next:y,peek:E,push:w,skip:x,cmnt:B},"line",{get:function(){return o}})}var parse_1=parse$3;parse$3.filename=null,parse$3.defaults={keepCase:!1};var tokenize=tokenize_1,Root=requireRoot(),Type$1=requireType(),Field=requireField(),MapField=requireMapfield(),OneOf=requireOneof(),Enum=require_enum(),Service$1=requireService(),Method=requireMethod(),types=requireTypes(),util=requireUtil(),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,fqTypeRefRe=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function parse$3(e,t,r){t instanceof Root||(r=t,t=new Root),r||(r=parse$3.defaults);var n=r.preferTrailingComment||!1,o=tokenize(e,r.alternateCommentMode||!1),s=o.next,a=o.push,c=o.peek,l=o.skip,h=o.cmnt,u=!0,d,f,_,p,y=!1,w=t,E=r.keepCase?function($){return $}:util.camelCase;function x($,j,O){var k=parse$3.filename;return O||(parse$3.filename=null),Error("illegal "+(j||"token")+" '"+$+"' ("+(k?k+", ":"")+"line "+o.line+")")}function B(){var $=[],j;do{if((j=s())!=='"'&&j!=="'")throw x(j);$.push(s()),l(j),j=c()}while(j==='"'||j==="'");return $.join("")}function P($){var j=s();switch(j){case"'":case'"':return a(j),B();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return F(j,!0)}catch{if(typeRefRe.test(j))return j;throw x(j,"value")}}function U($,j){var O,k;do j&&((O=c())==='"'||O==="'")?$.push(B()):$.push([k=G(s()),l("to",!0)?G(s()):k]);while(l(",",!0));var ue={options:void 0};ue.setOption=function(pe,Oe){this.options===void 0&&(this.options={}),this.options[pe]=Oe},z(ue,function(pe){if(pe==="option")ne(ue,pe),l(";");else throw x(pe)},function(){Ce(ue)})}function F($,j){var O=1;switch($.charAt(0)==="-"&&(O=-1,$=$.substring(1)),$){case"inf":case"INF":case"Inf":return O*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test($))return O*parseInt($,10);if(base16Re.test($))return O*parseInt($,16);if(base8Re.test($))return O*parseInt($,8);if(numberRe.test($))return O*parseFloat($);throw x($,"number",j)}function G($,j){switch($){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!j&&$.charAt(0)==="-")throw x($,"id");if(base10NegRe.test($))return parseInt($,10);if(base16NegRe.test($))return parseInt($,16);if(base8NegRe.test($))return parseInt($,8);throw x($,"id")}function H(){if(d!==void 0)throw x("package");if(d=s(),!typeRefRe.test(d))throw x(d,"name");w=w.define(d),l(";")}function te(){var $=c(),j;switch($){case"weak":j=_||(_=[]),s();break;case"public":s();default:j=f||(f=[]);break}$=B(),l(";"),j.push($)}function J(){if(l("="),p=B(),y=p==="proto3",!y&&p!=="proto2")throw x(p,"syntax");l(";")}function le($,j){switch(j){case"option":return ne($,j),l(";"),!0;case"message":return q($,j),!0;case"enum":return W($,j),!0;case"service":return ke($,j),!0;case"extend":return Q($,j),!0}return!1}function z($,j,O){var k=o.line;if($&&(typeof $.comment!="string"&&($.comment=h()),$.filename=parse$3.filename),l("{",!0)){for(var ue;(ue=s())!=="}";)j(ue);l(";",!0)}else O&&O(),l(";"),$&&(typeof $.comment!="string"||n)&&($.comment=h(k)||$.comment)}function q($,j){if(!nameRe.test(j=s()))throw x(j,"type name");var O=new Type$1(j);z(O,function(k){if(!le(O,k))switch(k){case"map":_e(O);break;case"required":case"repeated":he(O,k);break;case"optional":y?he(O,"proto3_optional"):he(O,"optional");break;case"oneof":ee(O,k);break;case"extensions":U(O.extensions||(O.extensions=[]));break;case"reserved":U(O.reserved||(O.reserved=[]),!0);break;default:if(!y||!typeRefRe.test(k))throw x(k);a(k),he(O,"optional");break}}),$.add(O)}function he($,j,O){var k=s();if(k==="group"){V($,j);return}for(;k.endsWith(".")||c().startsWith(".");)k+=s();if(!typeRefRe.test(k))throw x(k,"type");var ue=s();if(!nameRe.test(ue))throw x(ue,"name");ue=E(ue),l("=");var pe=new Field(ue,G(s()),k,j,O);if(z(pe,function(Le){if(Le==="option")ne(pe,Le),l(";");else throw x(Le)},function(){Ce(pe)}),j==="proto3_optional"){var Oe=new OneOf("_"+ue);pe.setOption("proto3_optional",!0),Oe.add(pe),$.add(Oe)}else $.add(pe);!y&&pe.repeated&&(types.packed[k]!==void 0||types.basic[k]===void 0)&&pe.setOption("packed",!1,!0)}function V($,j){var O=s();if(!nameRe.test(O))throw x(O,"name");var k=util.lcFirst(O);O===k&&(O=util.ucFirst(O)),l("=");var ue=G(s()),pe=new Type$1(O);pe.group=!0;var Oe=new Field(k,ue,O,j);Oe.filename=parse$3.filename,z(pe,function(Le){switch(Le){case"option":ne(pe,Le),l(";");break;case"required":case"repeated":he(pe,Le);break;case"optional":y?he(pe,"proto3_optional"):he(pe,"optional");break;case"message":q(pe,Le);break;case"enum":W(pe,Le);break;default:throw x(Le)}}),$.add(pe).add(Oe)}function _e($){l("<");var j=s();if(types.mapKey[j]===void 0)throw x(j,"type");l(",");var O=s();if(!typeRefRe.test(O))throw x(O,"type");l(">");var k=s();if(!nameRe.test(k))throw x(k,"name");l("=");var ue=new MapField(E(k),G(s()),j,O);z(ue,function(pe){if(pe==="option")ne(ue,pe),l(";");else throw x(pe)},function(){Ce(ue)}),$.add(ue)}function ee($,j){if(!nameRe.test(j=s()))throw x(j,"name");var O=new OneOf(E(j));z(O,function(k){k==="option"?(ne(O,k),l(";")):(a(k),he(O,"optional"))}),$.add(O)}function W($,j){if(!nameRe.test(j=s()))throw x(j,"name");var O=new Enum(j);z(O,function(k){switch(k){case"option":ne(O,k),l(";");break;case"reserved":U(O.reserved||(O.reserved=[]),!0);break;default:re(O,k)}}),$.add(O)}function re($,j){if(!nameRe.test(j))throw x(j,"name");l("=");var O=G(s(),!0),k={options:void 0};k.setOption=function(ue,pe){this.options===void 0&&(this.options={}),this.options[ue]=pe},z(k,function(ue){if(ue==="option")ne(k,ue),l(";");else throw x(ue)},function(){Ce(k)}),$.add(j,O,k.comment,k.options)}function ne($,j){var O=l("(",!0);if(!typeRefRe.test(j=s()))throw x(j,"name");var k=j,ue=k,pe;O&&(l(")"),k="("+k+")",ue=k,j=c(),fqTypeRefRe.test(j)&&(pe=j.slice(1),k+=j,s())),l("=");var Oe=ge($,k);ye($,ue,Oe,pe)}function ge($,j){if(l("{",!0)){for(var O={};!l("}",!0);){if(!nameRe.test(C=s()))throw x(C,"name");if(C===null)throw x(C,"end of input");var k,ue=C;if(l(":",!0),c()==="{")k=ge($,j+"."+C);else if(c()==="["){k=[];var pe;if(l("[",!0)){do pe=P(),k.push(pe);while(l(",",!0));l("]"),typeof pe<"u"&&de($,j+"."+C,pe)}}else k=P(),de($,j+"."+C,k);var Oe=O[ue];Oe&&(k=[].concat(Oe).concat(k)),O[ue]=k,l(",",!0),l(";",!0)}return O}var Le=P();return de($,j,Le),Le}function de($,j,O){$.setOption&&$.setOption(j,O)}function ye($,j,O,k){$.setParsedOption&&$.setParsedOption(j,O,k)}function Ce($){if(l("[",!0)){do ne($,"option");while(l(",",!0));l("]")}return $}function ke($,j){if(!nameRe.test(j=s()))throw x(j,"service name");var O=new Service$1(j);z(O,function(k){if(!le(O,k))if(k==="rpc")ae(O,k);else throw x(k)}),$.add(O)}function ae($,j){var O=h(),k=j;if(!nameRe.test(j=s()))throw x(j,"name");var ue=j,pe,Oe,Le,Me;if(l("("),l("stream",!0)&&(Oe=!0),!typeRefRe.test(j=s())||(pe=j,l(")"),l("returns"),l("("),l("stream",!0)&&(Me=!0),!typeRefRe.test(j=s())))throw x(j);Le=j,l(")");var We=new Method(ue,k,pe,Le,Oe,Me);We.comment=O,z(We,function(Fe){if(Fe==="option")ne(We,Fe),l(";");else throw x(Fe)}),$.add(We)}function Q($,j){if(!typeRefRe.test(j=s()))throw x(j,"reference");var O=j;z(null,function(k){switch(k){case"required":case"repeated":he($,k,O);break;case"optional":y?he($,"proto3_optional",O):he($,"optional",O);break;default:if(!y||!typeRefRe.test(k))throw x(k);a(k),he($,"optional",O);break}})}for(var C;(C=s())!==null;)switch(C){case"package":if(!u)throw x(C);H();break;case"import":if(!u)throw x(C);te();break;case"syntax":if(!u)throw x(C);J();break;case"option":ne(w,C),l(";");break;default:if(le(w,C)){u=!1;continue}throw x(C)}return parse$3.filename=null,{package:d,imports:f,weakImports:_,syntax:p,root:t}}var common_1=common$2,commonRe=/\/|\./;function common$2(e,t){commonRe.test(e)||(e="google/protobuf/"+e+".proto",t={nested:{google:{nested:{protobuf:{nested:t}}}}}),common$2[e]=t}common$2("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}});var timeType;common$2("duration",{Duration:timeType={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),common$2("timestamp",{Timestamp:timeType}),common$2("empty",{Empty:{fields:{}}}),common$2("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),common$2("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),common$2("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),common$2.get=function e(t){return common$2[t]||null};var protobuf=src$2.exports=indexLightExports;protobuf.build="full",protobuf.tokenize=tokenize_1,protobuf.parse=parse_1,protobuf.common=common_1,protobuf.Root._configure(protobuf.Type,protobuf.parse,protobuf.common);var srcExports=src$2.exports,protobufjs=srcExports;const protobufjs2=getDefaultExportFromCjs(protobufjs);var lodash_merge={exports:{}};lodash_merge.exports,function(e,t){var r=200,n="__lodash_hash_undefined__",o=800,s=16,a=9007199254740991,c="[object Arguments]",l="[object Array]",h="[object AsyncFunction]",u="[object Boolean]",d="[object Date]",f="[object Error]",_="[object Function]",p="[object GeneratorFunction]",y="[object Map]",w="[object Number]",E="[object Null]",x="[object Object]",B="[object Proxy]",P="[object RegExp]",U="[object Set]",F="[object String]",G="[object Undefined]",H="[object WeakMap]",te="[object ArrayBuffer]",J="[object DataView]",le="[object Float32Array]",z="[object Float64Array]",q="[object Int8Array]",he="[object Int16Array]",V="[object Int32Array]",_e="[object Uint8Array]",ee="[object Uint8ClampedArray]",W="[object Uint16Array]",re="[object Uint32Array]",ne=/[\\^$.*+?()[\]{}|]/g,ge=/^\[object .+?Constructor\]$/,de=/^(?:0|[1-9]\d*)$/,ye={};ye[le]=ye[z]=ye[q]=ye[he]=ye[V]=ye[_e]=ye[ee]=ye[W]=ye[re]=!0,ye[c]=ye[l]=ye[te]=ye[u]=ye[J]=ye[d]=ye[f]=ye[_]=ye[y]=ye[w]=ye[x]=ye[P]=ye[U]=ye[F]=ye[H]=!1;var Ce=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,ke=typeof self=="object"&&self&&self.Object===Object&&self,ae=Ce||ke||Function("return this")(),Q=t&&!t.nodeType&&t,C=Q&&!0&&e&&!e.nodeType&&e,$=C&&C.exports===Q,j=$&&Ce.process,O=function(){try{var se=C&&C.require&&C.require("util").types;return se||j&&j.binding&&j.binding("util")}catch{}}(),k=O&&O.isTypedArray;function ue(se,Se,oe){switch(oe.length){case 0:return se.call(Se);case 1:return se.call(Se,oe[0]);case 2:return se.call(Se,oe[0],oe[1]);case 3:return se.call(Se,oe[0],oe[1],oe[2])}return se.apply(Se,oe)}function pe(se,Se){for(var oe=-1,Ee=Array(se);++oe<se;)Ee[oe]=Se(oe);return Ee}function Oe(se){return function(Se){return se(Se)}}function Le(se,Se){return se==null?void 0:se[Se]}function Me(se,Se){return function(oe){return se(Se(oe))}}var We=Array.prototype,Fe=Function.prototype,st=Object.prototype,ft=ae["__core-js_shared__"],rt=Fe.toString,lt=st.hasOwnProperty,At=function(){var se=/[^.]+$/.exec(ft&&ft.keys&&ft.keys.IE_PROTO||"");return se?"Symbol(src)_1."+se:""}(),qe=st.toString,Je=rt.call(Object),g=RegExp("^"+rt.call(lt).replace(ne,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=$?ae.Buffer:void 0,T=ae.Symbol,ce=ae.Uint8Array;b&&b.allocUnsafe;var fe=Me(Object.getPrototypeOf,Object),ve=Object.create,Ne=st.propertyIsEnumerable,tt=We.splice,ct=T?T.toStringTag:void 0,ot=function(){try{var se=Ye(Object,"defineProperty");return se({},"",{}),se}catch{}}(),it=b?b.isBuffer:void 0,ut=Math.max,dr=Date.now,tr=Ye(ae,"Map"),ir=Ye(Object,"create"),Wr=function(){function se(){}return function(Se){if(!mt(Se))return{};if(ve)return ve(Se);se.prototype=Se;var oe=new se;return se.prototype=void 0,oe}}();function qt(se){var Se=-1,oe=se==null?0:se.length;for(this.clear();++Se<oe;){var Ee=se[Se];this.set(Ee[0],Ee[1])}}function fr(){this.__data__=ir?ir(null):{},this.size=0}function pr(se){var Se=this.has(se)&&delete this.__data__[se];return this.size-=Se?1:0,Se}function Qt(se){var Se=this.__data__;if(ir){var oe=Se[se];return oe===n?void 0:oe}return lt.call(Se,se)?Se[se]:void 0}function Nr(se){var Se=this.__data__;return ir?Se[se]!==void 0:lt.call(Se,se)}function Ar(se,Se){var oe=this.__data__;return this.size+=this.has(se)?0:1,oe[se]=ir&&Se===void 0?n:Se,this}qt.prototype.clear=fr,qt.prototype.delete=pr,qt.prototype.get=Qt,qt.prototype.has=Nr,qt.prototype.set=Ar;function jt(se){var Se=-1,oe=se==null?0:se.length;for(this.clear();++Se<oe;){var Ee=se[Se];this.set(Ee[0],Ee[1])}}function Jr(){this.__data__=[],this.size=0}function Xr(se){var Se=this.__data__,oe=lr(Se,se);if(oe<0)return!1;var Ee=Se.length-1;return oe==Ee?Se.pop():tt.call(Se,oe,1),--this.size,!0}function Ut(se){var Se=this.__data__,oe=lr(Se,se);return oe<0?void 0:Se[oe][1]}function Zr(se){return lr(this.__data__,se)>-1}function Dr(se,Se){var oe=this.__data__,Ee=lr(oe,se);return Ee<0?(++this.size,oe.push([se,Se])):oe[Ee][1]=Se,this}jt.prototype.clear=Jr,jt.prototype.delete=Xr,jt.prototype.get=Ut,jt.prototype.has=Zr,jt.prototype.set=Dr;function Yt(se){var Se=-1,oe=se==null?0:se.length;for(this.clear();++Se<oe;){var Ee=se[Se];this.set(Ee[0],Ee[1])}}function _r(){this.size=0,this.__data__={hash:new qt,map:new(tr||jt),string:new qt}}function en(se){var Se=Qe(this,se).delete(se);return this.size-=Se?1:0,Se}function Gt(se){return Qe(this,se).get(se)}function tn(se){return Qe(this,se).has(se)}function rn(se,Se){var oe=Qe(this,se),Ee=oe.size;return oe.set(se,Se),this.size+=oe.size==Ee?0:1,this}Yt.prototype.clear=_r,Yt.prototype.delete=en,Yt.prototype.get=Gt,Yt.prototype.has=tn,Yt.prototype.set=rn;function rr(se){var Se=this.__data__=new jt(se);this.size=Se.size}function sr(){this.__data__=new jt,this.size=0}function nn(se){var Se=this.__data__,oe=Se.delete(se);return this.size=Se.size,oe}function gr(se){return this.__data__.get(se)}function sn(se){return this.__data__.has(se)}function an(se,Se){var oe=this.__data__;if(oe instanceof jt){var Ee=oe.__data__;if(!tr||Ee.length<r-1)return Ee.push([se,Se]),this.size=++oe.size,this;oe=this.__data__=new Yt(Ee)}return oe.set(se,Se),this.size=oe.size,this}rr.prototype.clear=sr,rr.prototype.delete=nn,rr.prototype.get=gr,rr.prototype.has=sn,rr.prototype.set=an;function Ht(se,Se){var oe=be(se),Ee=!oe&&Ge(se),Te=!oe&&!Ee&&Xe(se),He=!oe&&!Ee&&!Te&&xt(se),et=oe||Ee||Te||He,Ze=et?pe(se.length,String):[],nt=Ze.length;for(var pt in se)et&&(pt=="length"||Te&&(pt=="offset"||pt=="parent")||He&&(pt=="buffer"||pt=="byteLength"||pt=="byteOffset")||ht(pt,nt))||Ze.push(pt);return Ze}function nr(se,Se,oe){(oe!==void 0&&!je(se[Se],oe)||oe===void 0&&!(Se in se))&&ar(se,Se,oe)}function cn(se,Se,oe){var Ee=se[Se];(!(lt.call(se,Se)&&je(Ee,oe))||oe===void 0&&!(Se in se))&&ar(se,Se,oe)}function lr(se,Se){for(var oe=se.length;oe--;)if(je(se[oe][0],Se))return oe;return-1}function ar(se,Se,oe){Se=="__proto__"&&ot?ot(se,Se,{configurable:!0,enumerable:!0,value:oe,writable:!0}):se[Se]=oe}var qr=Ke();function Wt(se){return se==null?se===void 0?G:E:ct&&ct in Object(se)?ze(se):Vt(se)}function Jt(se){return St(se)&&Wt(se)==c}function xr(se){if(!mt(se)||Ct(se))return!1;var Se=gt(se)?g:ge;return Se.test($e(se))}function wr(se){return St(se)&&at(se.length)&&!!ye[Wt(se)]}function hr(se){if(!mt(se))return It(se);var Se=Rt(se),oe=[];for(var Ee in se)Ee=="constructor"&&(Se||!lt.call(se,Ee))||oe.push(Ee);return oe}function $r(se,Se,oe,Ee,Te){se!==Se&&qr(Se,function(He,et){if(Te||(Te=new rr),mt(He))Pr(se,Se,et,oe,$r,Ee,Te);else{var Ze=Ee?Ee(zt(se,et),He,et+"",se,Se,Te):void 0;Ze===void 0&&(Ze=He),nr(se,et,Ze)}},Mt)}function Pr(se,Se,oe,Ee,Te,He,et){var Ze=zt(se,oe),nt=zt(Se,oe),pt=et.get(nt);if(pt){nr(se,oe,pt);return}var bt=He?He(Ze,nt,oe+"",se,Se,et):void 0,Nt=bt===void 0;if(Nt){var Pt=be(nt),Xt=!Pt&&Xe(nt),Er=!Pt&&!Xt&&xt(nt);bt=nt,Pt||Xt||Er?be(Ze)?bt=Ze:Ue(Ze)?bt=Pe(Ze):Xt?(Nt=!1,bt=me(nt)):Er?(Nt=!1,bt=Ie(nt)):bt=[]:wt(nt)||Ge(nt)?(bt=Ze,Ge(Ze)?bt=Ot(Ze):(!mt(Ze)||gt(Ze))&&(bt=Ve(nt))):Nt=!1}Nt&&(et.set(nt,bt),Te(bt,nt,Ee,He,et),et.delete(nt)),nr(se,oe,bt)}function Hr(se,Se){return br(mr(se,Se,Kt),se+"")}var Qr=ot?function(se,Se){return ot(se,"toString",{configurable:!0,enumerable:!1,value:Ft(Se),writable:!0})}:Kt;function me(se,Se){return se.slice()}function xe(se){var Se=new se.constructor(se.byteLength);return new ce(Se).set(new ce(se)),Se}function Ie(se,Se){var oe=xe(se.buffer);return new se.constructor(oe,se.byteOffset,se.length)}function Pe(se,Se){var oe=-1,Ee=se.length;for(Se||(Se=Array(Ee));++oe<Ee;)Se[oe]=se[oe];return Se}function Re(se,Se,oe,Ee){var Te=!oe;oe||(oe={});for(var He=-1,et=Se.length;++He<et;){var Ze=Se[He],nt=void 0;nt===void 0&&(nt=se[Ze]),Te?ar(oe,Ze,nt):cn(oe,Ze,nt)}return oe}function Be(se){return Hr(function(Se,oe){var Ee=-1,Te=oe.length,He=Te>1?oe[Te-1]:void 0,et=Te>2?oe[2]:void 0;for(He=se.length>3&&typeof He=="function"?(Te--,He):void 0,et&&_t(oe[0],oe[1],et)&&(He=Te<3?void 0:He,Te=1),Se=Object(Se);++Ee<Te;){var Ze=oe[Ee];Ze&&se(Se,Ze,Ee,He)}return Se})}function Ke(se){return function(Se,oe,Ee){for(var Te=-1,He=Object(Se),et=Ee(Se),Ze=et.length;Ze--;){var nt=et[++Te];if(oe(He[nt],nt,He)===!1)break}return Se}}function Qe(se,Se){var oe=se.__data__;return Tt(Se)?oe[typeof Se=="string"?"string":"hash"]:oe.map}function Ye(se,Se){var oe=Le(se,Se);return xr(oe)?oe:void 0}function ze(se){var Se=lt.call(se,ct),oe=se[ct];try{se[ct]=void 0;var Ee=!0}catch{}var Te=qe.call(se);return Ee&&(Se?se[ct]=oe:delete se[ct]),Te}function Ve(se){return typeof se.constructor=="function"&&!Rt(se)?Wr(fe(se)):{}}function ht(se,Se){var oe=typeof se;return Se=Se??a,!!Se&&(oe=="number"||oe!="symbol"&&de.test(se))&&se>-1&&se%1==0&&se<Se}function _t(se,Se,oe){if(!mt(oe))return!1;var Ee=typeof Se;return(Ee=="number"?De(oe)&&ht(Se,oe.length):Ee=="string"&&Se in oe)?je(oe[Se],se):!1}function Tt(se){var Se=typeof se;return Se=="string"||Se=="number"||Se=="symbol"||Se=="boolean"?se!=="__proto__":se===null}function Ct(se){return!!At&&At in se}function Rt(se){var Se=se&&se.constructor,oe=typeof Se=="function"&&Se.prototype||st;return se===oe}function It(se){var Se=[];if(se!=null)for(var oe in Object(se))Se.push(oe);return Se}function Vt(se){return qe.call(se)}function mr(se,Se,oe){return Se=ut(Se===void 0?se.length-1:Se,0),function(){for(var Ee=arguments,Te=-1,He=ut(Ee.length-Se,0),et=Array(He);++Te<He;)et[Te]=Ee[Se+Te];Te=-1;for(var Ze=Array(Se+1);++Te<Se;)Ze[Te]=Ee[Te];return Ze[Se]=oe(et),ue(se,this,Ze)}}function zt(se,Se){if(!(Se==="constructor"&&typeof se[Se]=="function")&&Se!="__proto__")return se[Se]}var br=Tr(Qr);function Tr(se){var Se=0,oe=0;return function(){var Ee=dr(),Te=s-(Ee-oe);if(oe=Ee,Te>0){if(++Se>=o)return arguments[0]}else Se=0;return se.apply(void 0,arguments)}}function $e(se){if(se!=null){try{return rt.call(se)}catch{}try{return se+""}catch{}}return""}function je(se,Se){return se===Se||se!==se&&Se!==Se}var Ge=Jt(function(){return arguments}())?Jt:function(se){return St(se)&&lt.call(se,"callee")&&!Ne.call(se,"callee")},be=Array.isArray;function De(se){return se!=null&&at(se.length)&&!gt(se)}function Ue(se){return St(se)&&De(se)}var Xe=it||we;function gt(se){if(!mt(se))return!1;var Se=Wt(se);return Se==_||Se==p||Se==h||Se==B}function at(se){return typeof se=="number"&&se>-1&&se%1==0&&se<=a}function mt(se){var Se=typeof se;return se!=null&&(Se=="object"||Se=="function")}function St(se){return se!=null&&typeof se=="object"}function wt(se){if(!St(se)||Wt(se)!=x)return!1;var Se=fe(se);if(Se===null)return!0;var oe=lt.call(Se,"constructor")&&Se.constructor;return typeof oe=="function"&&oe instanceof oe&&rt.call(oe)==Je}var xt=k?Oe(k):wr;function Ot(se){return Re(se,Mt(se))}function Mt(se){return De(se)?Ht(se):hr(se)}var Dt=Be(function(se,Se,oe){$r(se,Se,oe)});function Ft(se){return function(){return se}}function Kt(se){return se}function we(){return!1}e.exports=Dt}(lodash_merge,lodash_merge.exports);var lodash_mergeExports=lodash_merge.exports;const merge$5=getDefaultExportFromCjs(lodash_mergeExports);var dist$1={},core={},debug$1={};Object.defineProperty(debug$1,"__esModule",{value:!0});function getType(e){return Object.prototype.toString.call(e)}debug$1.getType=getType;function throwUnknownDataType(e){throw new TypeError("unsupported data type: "+getType(e))}debug$1.throwUnknownDataType=throwUnknownDataType;var encode$2={},number$4={};Object.defineProperty(number$4,"__esModule",{value:!0});let i_to_s="";for(let e=0;e<10;e++){const t=String.fromCharCode(48+e);i_to_s+=t}for(let e=0;e<26;e++){const t=String.fromCharCode(65+e);i_to_s+=t}for(let e=0;e<26;e++){const t=String.fromCharCode(97+e);i_to_s+=t}const N=i_to_s.length,s_to_i={};for(let e=0;e<N;e++){const t=i_to_s[e];s_to_i[t]=e}function s_to_int(e){let t=0,r=1;for(let n=e.length-1;n>=0;n--){const o=e[n];let s=s_to_i[o];s*=r,t+=s,r*=N}return t}number$4.s_to_int=s_to_int;function s_to_big_int(e){let t=BigInt(0),r=BigInt(1);const n=BigInt(N);for(let o=e.length-1;o>=0;o--){const s=e[o];let a=BigInt(s_to_i[s]);a*=r,t+=a,r*=n}return t}number$4.s_to_big_int=s_to_big_int;function int_to_s(e){if(e===0)return i_to_s[0];const t=[];for(;e!==0;){const r=e%N,n=i_to_s[r];t.push(n),e-=r,e/=N}return t.reverse().join("")}number$4.int_to_s=int_to_s;function big_int_to_s(e){const t=BigInt(0),r=BigInt(N);if(e===t)return i_to_s[0];const n=[];for(;e!==t;){const o=e%r,s=i_to_s[Number(o)];n.push(s),e/=r}return n.reverse().join("")}number$4.big_int_to_s=big_int_to_s;function reverse$3(e){return e.split("").reverse().join("")}function num_to_s(e){if(e<0)return"-"+num_to_s(-e);let[t,r]=e.toString().split(".");if(!r)return int_to_s(e);let n;r&&([r,n]=r.split("e")),t=int_str_to_s(t),r=reverse$3(r),r=int_str_to_s(r);let o=t+"."+r;if(n){switch(o+=".",n[0]){case"+":n=n.slice(1);break;case"-":o+="-",n=n.slice(1);break}n=reverse$3(n),n=int_str_to_s(n),o+=n}return o}number$4.num_to_s=num_to_s;function int_str_to_s(e){const t=+e;return t.toString()===e?int_to_s(t):":"+big_int_to_s(BigInt(e))}number$4.int_str_to_s=int_str_to_s;function s_to_int_str(e){return e[0]===":"?s_to_big_int(e.substring(1)).toString():s_to_int(e).toString()}function s_to_num(e){if(e[0]==="-")return-s_to_num(e.substr(1));let[t,r,n]=e.split(".");if(!r)return s_to_int(t);t=s_to_int_str(t),r=s_to_int_str(r),r=reverse$3(r);let o=t+"."+r;if(n){o+="e";let s=!1;n[0]==="-"&&(s=!0,n=n.slice(1)),n=s_to_int_str(n),n=reverse$3(n),o+=s?-n:+n}return+o}number$4.s_to_num=s_to_num,Object.defineProperty(encode$2,"__esModule",{value:!0});const number_1$1=number$4;function encodeNum(e){return"n|"+number_1$1.num_to_s(e)}encode$2.encodeNum=encodeNum;function decodeNum(e){return e=e.replace("n|",""),number_1$1.s_to_num(e)}encode$2.decodeNum=decodeNum;function decodeKey(e){return typeof e=="number"?e:number_1$1.s_to_int(e)}encode$2.decodeKey=decodeKey;function encodeBool(e){return e?"b|T":"b|F"}encode$2.encodeBool=encodeBool;function decodeBool(e){switch(e){case"b|T":return!0;case"b|F":return!1}return!!e}encode$2.decodeBool=decodeBool;function encodeStr(e){switch(e[0]+e[1]){case"b|":case"o|":case"n|":case"a|":case"s|":e="s|"+e}return e}encode$2.encodeStr=encodeStr;function decodeStr(e){return e[0]+e[1]==="s|"?e.substr(2):e}encode$2.decodeStr=decodeStr;var memory$5={},config={};Object.defineProperty(config,"__esModule",{value:!0}),config.config={sort_key:!1},Object.defineProperty(memory$5,"__esModule",{value:!0});const config_1=config,debug_1$1=debug$1,encode_1$2=encode$2,number_1=number$4;function memToValues(e){return e.store.toArray()}memory$5.memToValues=memToValues;function makeInMemoryStore(){const e=[];return{forEach(t){for(let r=0;r<e.length;r++)if(t(e[r])==="break")return},add(t){e.push(t)},toArray(){return e}}}memory$5.makeInMemoryStore=makeInMemoryStore;function makeInMemoryCache(){const e=Object.create(null),t=Object.create(null);return{getValue(r){return e[r]},getSchema(r){return t[r]},forEachValue(r){for(const[n,o]of Object.entries(e))if(r(n,o)==="break")return},forEachSchema(r){for(const[n,o]of Object.entries(t))if(r(n,o)==="break")return},setValue(r,n){e[r]=n},setSchema(r,n){t[r]=n},hasValue(r){return r in e},hasSchema(r){return r in t}}}memory$5.makeInMemoryCache=makeInMemoryCache;function makeInMemoryMemory(){return{store:makeInMemoryStore(),cache:makeInMemoryCache(),keyCount:0}}memory$5.makeInMemoryMemory=makeInMemoryMemory;function getValueKey(e,t){if(e.cache.hasValue(t))return e.cache.getValue(t);const r=e.keyCount++,n=number_1.num_to_s(r);return e.store.add(t),e.cache.setValue(t,n),n}function getSchema$1(e,t){config_1.config.sort_key&&t.sort();const r=t.join(",");if(e.cache.hasSchema(r))return e.cache.getSchema(r);const n=addValue(e,t,void 0);return e.cache.setSchema(r,n),n}function addValue(e,t,r){if(t===null)return"";switch(typeof t){case"undefined":if(Array.isArray(r))return addValue(e,null,r);break;case"object":if(t===null)return getValueKey(e,null);if(Array.isArray(t)){let n="a";for(let o=0;o<t.length;o++){const s=t[o],a=s===null?"_":addValue(e,s,t);n+="|"+a}return n==="a"&&(n="a|"),getValueKey(e,n)}else{const n=Object.keys(t);if(n.length===0)return getValueKey(e,"o|");let o="o";const s=getSchema$1(e,n);o+="|"+s;for(const a of n){const c=t[a],l=addValue(e,c,t);o+="|"+l}return getValueKey(e,o)}case"boolean":return getValueKey(e,encode_1$2.encodeBool(t));case"number":return getValueKey(e,encode_1$2.encodeNum(t));case"string":return getValueKey(e,encode_1$2.encodeStr(t))}return debug_1$1.throwUnknownDataType(t)}memory$5.addValue=addValue,Object.defineProperty(core,"__esModule",{value:!0});const debug_1=debug$1,encode_1$1=encode$2,memory_1$1=memory$5;function compress$2(e){const t=memory_1$1.makeInMemoryMemory(),r=memory_1$1.addValue(t,e,void 0);return[memory_1$1.memToValues(t),r]}core.compress=compress$2;function decodeObject(e,t){if(t==="o|")return{};const r={},n=t.split("|"),o=n[1];let s=decode$4(e,o);const a=n.length;a-2===1&&!Array.isArray(s)&&(s=[s]);for(let c=2;c<a;c++){const l=s[c-2];let h=n[c];h=decode$4(e,h),r[l]=h}return r}function decodeArray(e,t){if(t==="a|")return[];const r=t.split("|"),n=r.length-1,o=new Array(n);for(let s=0;s<n;s++){let a=r[s+1];a=decode$4(e,a),o[s]=a}return o}function decode$4(e,t){if(t===""||t==="_")return null;const r=encode_1$1.decodeKey(t),n=e[r];if(n===null)return n;switch(typeof n){case"undefined":return n;case"number":return n;case"string":switch(n[0]+n[1]){case"b|":return encode_1$1.decodeBool(n);case"o|":return decodeObject(e,n);case"n|":return encode_1$1.decodeNum(n);case"a|":return decodeArray(e,n);default:return encode_1$1.decodeStr(n)}}return debug_1.throwUnknownDataType(n)}core.decode=decode$4;function decompress$1(e){const[t,r]=e;return decode$4(t,r)}core.decompress=decompress$1;var helpers$3={};Object.defineProperty(helpers$3,"__esModule",{value:!0});function trimUndefined(e){for(const t in e)e[t]===void 0&&delete e[t]}helpers$3.trimUndefined=trimUndefined;function trimUndefinedRecursively(e){trimUndefinedRecursivelyLoop(e,new Set)}helpers$3.trimUndefinedRecursively=trimUndefinedRecursively;function trimUndefinedRecursivelyLoop(e,t){t.add(e);for(const r in e)if(e[r]===void 0)delete e[r];else{const n=e[r];n&&typeof n=="object"&&!t.has(n)&&trimUndefinedRecursivelyLoop(n,t)}}Object.defineProperty(dist$1,"__esModule",{value:!0});var core_1=core;dist$1.compress=core_1.compress;var decompress=dist$1.decompress=core_1.decompress,core_2=core;dist$1.decode=core_2.decode;var memory_1=memory$5;dist$1.addValue=memory_1.addValue;var helpers_1=helpers$3;dist$1.trimUndefined=helpers_1.trimUndefined,dist$1.trimUndefinedRecursively=helpers_1.trimUndefinedRecursively;var Ref=Symbol("Ref"),ref$1=e=>({[Ref]:!0,value:e}),isRef=e=>e[Ref]===!0,codegen=(e,t,r,n={})=>{const o={...n};let s=1,a="";r((l,...h)=>{const u=d=>{if(isRef(d)){const f=`anon${s++}`;return o[f]=d.value,f}else return d};a+=l.map((d,f)=>d+(f<h.length?u(h[f]):"")).join("")+`
`});const c=`return function ${e}(${t.join(", ")}) {
${a}
}`;return Function(...Object.keys(o),c)(...Object.values(o))},__dxlog_file$u="/home/runner/work/dxos/dxos/packages/common/codec-protobuf/src/precompiled-mapping/create-message-mapper.ts",createMessageMapper=(e,t)=>createMessageMapperCached(e,t,{}).map,createMessageMapperCached=(e,t,r)=>(r[e.fullName]||(r[e.fullName]={},r[e.fullName].map=codegen(`${e.name}$map`,["obj","extraArgs"],n=>{n`const res = {};`;for(const o of e.fieldsArray){o.resolve(),n`if(obj.${o.name} !== undefined && obj.${o.name} !== null) {`;{const s=a=>{const c=o.resolvedType&&t[o.resolvedType.fullName.slice(1)];if(c){const l={messageName:e.fullName.slice(1),fieldName:o.name};n`${ref$1(c)}(${a}, ${ref$1(l)}, ...extraArgs)`}else if(o.resolvedType&&o.resolvedType instanceof protobufjs.Type){const l=createMessageMapperCached(o.resolvedType,t,r);n`${ref$1(l)}.map(${a}, extraArgs)`}else n`${a}`};o.repeated?(n`res.${o.name} = obj.${o.name}.map(item => `,s("item"),n`);`):o.map?(invariant$1(o instanceof protobufjs.MapField,void 0,{F:__dxlog_file$u,L:52,S:void 0,A:["field instanceof pb.MapField",""]}),n`res.${o.name} = {};`,n`for(const key of Object.keys(obj.${o.name})) {`,n`res.${o.name}[key] = `,s(`obj.${o.name}[key]`),n`;`,n`}`):(n`res.${o.name} = `,s(`obj.${o.name}`),n`;`)}if(n`}`,!o.getOption("proto3_optional")&&!o.repeated&&!o.map&&!o.partOf){if(n`else {`,o.resolvedType instanceof protobufjs.Type){const s=createMessageMapperCached(o.resolvedType,t,r);n`res.${o.name} = ${ref$1(s)}.map({}, extraArgs);`}else o.resolvedType instanceof protobufjs.Enum?`${o.name}`:n`res.${o.name} = ${getDefaultValue(o.type)};`;n`}`}}n`return res;`})),r[e.fullName]),getDefaultValue=e=>{switch(e){case"double":case"float":case"int32":case"sfixed32":case"uint32":case"sint32":case"fixed32":return"0";case"sint64":case"int64":case"uint64":case"fixed64":case"sfixed64":return'"0"';case"bool":return"false";case"string":return'""';case"bytes":return"new Uint8Array()";default:throw new Error(`Unknown type: ${e}`)}},OBJECT_CONVERSION_OPTIONS={longs:String,arrays:!0},ProtoCodec=class{constructor(e,t,r){this._type=e,this._mapping=t,this._schema=r,this._encodeMapper=createMessageMapper(this._type,this._mapping.encode),this._decodeMapper=createMessageMapper(this._type,this._mapping.decode)}get protoType(){return this._type}get substitutionMappings(){return this._mapping}get schema(){return this._schema}encode(e,t={}){const r=this._encodeMapper(e,[this._schema,t]);return this._type.encode(r).finish()}decode(e,t={}){const r=this._type.toObject(this._type.decode(e),OBJECT_CONVERSION_OPTIONS);return this._decodeMapper(r,[this._schema,t])}encodeAsAny(e,t={}){return{"@type":"google.protobuf.Any",type_url:this._type.fullName.slice(1),value:this.encode(e,t)}}fromObject(e){return this._decodeMapper(this._type.fromObject(e).toJSON(),[this._schema])}addJson(e){this._schema.addJson(e)}},createMappingDescriptors=e=>{const t={},r={};for(const n of Object.keys(e))t[n]=e[n].encode,r[n]=e[n].decode;return{encode:t,decode:r}},__dxlog_file3$h="/home/runner/work/dxos/dxos/packages/common/codec-protobuf/src/stream.ts",Stream$2=class si{constructor(t){this._messageHandler=void 0,this._closeHandler=void 0,this._readyHandler=void 0,this._isClosed=!1,this._closeError=void 0,this._producerCleanup=void 0,this._isReady=!1,this._buffer=[],this._readyPromise=new Promise(r=>{this._resolveReadyPromise=r}),this._ctx=new Context({onError:r=>{var n,o;this._isClosed||(this._isClosed=!0,this._closeError=r,(n=this._producerCleanup)==null||n.call(this,r),(o=this._closeHandler)==null||o.call(this,r),this._ctx.dispose())}}),this._ctx.onDispose(()=>this.close());try{const r=t({ctx:this._ctx,ready:()=>{this._markAsReady()},next:n=>{if(this._isClosed){log("Stream is closed, dropping message.",void 0,{F:__dxlog_file3$h,L:207,S:this,C:(o,s)=>o(...s)});return}if(this._markAsReady(),this._messageHandler)try{this._messageHandler(n)}catch(o){throwUnhandledError(o)}else invariant$1(this._buffer,void 0,{F:__dxlog_file3$h,L:221,S:this,A:["this._buffer",""]}),this._buffer.push(n)},close:n=>{var o,s;if(!this._isClosed){this._isClosed=!0,this._closeError=n,(o=this._producerCleanup)==null||o.call(this,n);try{(s=this._closeHandler)==null||s.call(this,n)}catch(a){throwUnhandledError(a)}this._ctx.dispose()}}});r&&(this._producerCleanup=r)}catch(r){this._ctx.raise(r)}}static consume(t){return new Promise(r=>{const n=[];t.onReady(()=>{n.push({ready:!0})}),t.subscribe(o=>{n.push({data:o})},o=>{o?n.push({closed:!0,error:o}):n.push({closed:!0}),r(n)})})}static async consumeData(t){const r=await si.consume(t),n=[];for(const o of r)if("data"in o)n.push(o.data);else if("closed"in o&&o.closed===!0){if(o.error)throw o.error;break}return n}static async first(t){return new Promise((r,n)=>{t.subscribe(o=>{r(o),t.close()},o=>{o?n(o):r(void 0)})})}static map(t,r){return new si(({ready:n,next:o,close:s})=>(t.onReady(n),t.subscribe(a=>o(r(a)),s),()=>t.close()))}static unwrapPromise(t){return t instanceof si?t:new si(({ready:r,next:n,close:o})=>(t.then(s=>{s.onReady(r),s.subscribe(n,o)},s=>{o(s)}),()=>{t.then(s=>s.close(),s=>{})}))}_markAsReady(){var t;this._isReady||(this._isReady=!0,(t=this._readyHandler)==null||t.call(this),this._resolveReadyPromise())}subscribe(t,r){invariant$1(!this._messageHandler,"Stream is already subscribed to.",{F:__dxlog_file3$h,L:262,S:this,A:["!this._messageHandler","'Stream is already subscribed to.'"]}),invariant$1(!this._closeHandler,"Stream is already subscribed to.",{F:__dxlog_file3$h,L:263,S:this,A:["!this._closeHandler","'Stream is already subscribed to.'"]}),invariant$1(this._buffer,void 0,{F:__dxlog_file3$h,L:264,S:this,A:["this._buffer",""]});for(const n of this._buffer)try{t(n)}catch(o){throwUnhandledError(o)}if(this._buffer=null,this._isClosed){r==null||r(this._closeError);return}this._messageHandler=t,this._closeHandler=r}waitUntilReady(){return this._readyPromise}onReady(t){invariant$1(!this._readyHandler,"Stream already has a handler for the ready event.",{F:__dxlog_file3$h,L:299,S:this,A:["!this._readyHandler","'Stream already has a handler for the ready event.'"]}),this._readyHandler=t,this._isReady&&t()}async close(){var t,r;this._isClosed||(this._isClosed=!0,(t=this._producerCleanup)==null||t.call(this),(r=this._closeHandler)==null||r.call(this,void 0),await this._ctx.dispose(),this._messageHandler=void 0,this._closeHandler=void 0,this._producerCleanup=void 0)}},__dxlog_file4$b="/home/runner/work/dxos/dxos/packages/common/codec-protobuf/src/service.ts",ServiceDescriptor=class{constructor(e,t){this._service=e,this._schema=t}get serviceProto(){return this._service}get name(){return this._service.fullName.slice(1)}createClient(e,t){return new Service(e,this._service,this._schema,t)}createServer(e,t){return new ServiceHandler(this._service,this._schema,e,t)}},Service=class{constructor(e,t,r,n){for(const o of t.methodsArray){o.resolve(),invariant$1(o.resolvedRequestType,void 0,{F:__dxlog_file4$b,L:59,S:this,A:["method.resolvedRequestType",""]}),invariant$1(o.resolvedResponseType,void 0,{F:__dxlog_file4$b,L:60,S:this,A:["method.resolvedResponseType",""]}),invariant$1(!o.requestStream,"Streaming RPC requests are not supported.",{F:__dxlog_file4$b,L:61,S:this,A:["!method.requestStream","'Streaming RPC requests are not supported.'"]});const s=r.tryGetCodecForType(o.resolvedRequestType.fullName),a=r.tryGetCodecForType(o.resolvedResponseType.fullName),c=mapRpcMethodName(o.name);o.responseStream?this[c]=(l,h)=>{const u=s.encode(l,n),d=e.callStream(o.name,{value:u,type_url:o.resolvedRequestType.fullName},h);return Stream$2.map(d,f=>a.decode(f.value,n))}:this[c]=async(l,h)=>{const u=s.encode(l,n),d=await e.call(o.name,{value:u,type_url:o.resolvedRequestType.fullName},h);return a.decode(d.value,n)},Object.defineProperty(this[c],"name",{value:c})}}},ServiceHandler=class{constructor(e,t,r,n){this._serviceDefinition=e,this._schema=t,this._serviceProvider=r,this._encodingOptions=n}async call(e,t,r){const{method:n,requestCodec:o,responseCodec:s}=this._getMethodInfo(e);invariant$1(!n.requestStream,"Invalid RPC method call: request streaming mismatch.",{F:__dxlog_file4$b,L:120,S:this,A:["!method.requestStream","'Invalid RPC method call: request streaming mismatch.'"]}),invariant$1(!n.responseStream,`Invalid RPC method call: response streaming mismatch. ${e}`,{F:__dxlog_file4$b,L:121,S:this,A:["!method.responseStream","`Invalid RPC method call: response streaming mismatch. ${methodName}`"]});const a=mapRpcMethodName(e),c=await this._getHandler(a),l=o.decode(t.value,this._encodingOptions),h=await c(l,r);return{value:s.encode(h,this._encodingOptions),type_url:n.resolvedResponseType.fullName}}callStream(e,t,r){const{method:n,requestCodec:o,responseCodec:s}=this._getMethodInfo(e);invariant$1(!n.requestStream,"Invalid RPC method call: request streaming mismatch.",{F:__dxlog_file4$b,L:141,S:this,A:["!method.requestStream","'Invalid RPC method call: request streaming mismatch.'"]}),invariant$1(n.responseStream,`Invalid RPC method call: response streaming mismatch., ${e}`,{F:__dxlog_file4$b,L:142,S:this,A:["method.responseStream","`Invalid RPC method call: response streaming mismatch., ${methodName}`"]});const a=mapRpcMethodName(e),c=this._getHandler(a),l=o.decode(t.value,this._encodingOptions),h=Stream$2.unwrapPromise(c.then(u=>u(l,r)));return Stream$2.map(h,u=>({value:s.encode(u,this._encodingOptions),type_url:n.resolvedResponseType.fullName}))}async _getHandler(e){const t=await getAsyncValue(this._serviceProvider),r=t[e];return invariant$1(r,`Handler is missing: ${e}`,{F:__dxlog_file4$b,L:163,S:this,A:["handler","`Handler is missing: ${method}`"]}),r.bind(t)}_getMethodInfo(e){const t=this._serviceDefinition.methods[e];invariant$1(!!t,`Method not found: ${e}`,{F:__dxlog_file4$b,L:169,S:this,A:["!!method","`Method not found: ${methodName}`"]}),t.resolve(),invariant$1(t.resolvedRequestType,void 0,{F:__dxlog_file4$b,L:172,S:this,A:["method.resolvedRequestType",""]}),invariant$1(t.resolvedResponseType,void 0,{F:__dxlog_file4$b,L:173,S:this,A:["method.resolvedResponseType",""]});const r=this._schema.tryGetCodecForType(t.resolvedRequestType.fullName),n=this._schema.tryGetCodecForType(t.resolvedResponseType.fullName);return{method:t,requestCodec:r,responseCodec:n}}},mapRpcMethodName=e=>e[0].toLocaleLowerCase()+e.substring(1),Schema=class Ys{static fromJson(t,r={}){const n=protobufjs2.Root.fromJSON(t);return new Ys(n,r)}constructor(t,r){this._typesRoot=t,this._codecCache=new Map,this._mapping=createMappingDescriptors(r)}getCodecForType(t){if(typeof t!="string")throw new TypeError("Expected `typeName` argument to be a string");let r=this._codecCache.get(t);if(r)return r;if(r===null)throw new Error(`Type not found: "${t}"`);const n=this._typesRoot.lookupType(t);return r=new ProtoCodec(n,this._mapping,this),this._codecCache.set(t,r),r}hasType(t){if(t==="")return!1;if(this._codecCache.has(t))return!0;try{return this.tryGetCodecForType(t),!0}catch{return!1}}tryGetCodecForType(t){if(t==="")throw new Error(`Type not found: "${t}"`);if(typeof t!="string")throw new TypeError("Expected `typeName` argument to be a string");let r=this._codecCache.get(t);if(r)return r;if(r===null)throw new Error(`Type not found: "${t}"`);const n=this._typesRoot.lookupType(t);return r=new ProtoCodec(n,this._mapping,this),this._codecCache.set(t,r),r}getService(t){if(typeof t!="string")throw new TypeError("Expected `name` argument to be a string");const r=this._typesRoot.lookupService(t);return new ServiceDescriptor(r,this)}addJson(t){if(!t.nested)throw new Error("Invalid schema: missing nested object");this._typesRoot=protobufjs.Root.fromJSON(merge$5(this._typesRoot.toJSON(),t))}},encodeStructValue=(e,t)=>{switch(typeof e){case"undefined":return{nullValue:0};case"number":return{numberValue:e};case"string":return{stringValue:e};case"boolean":return{boolValue:e};case"object":{if(e===null||t.has(e))return{nullValue:0};try{return Array.isArray(e)?{listValue:{values:e.map(r=>encodeStructValue(r,t))}}:{structValue:encodeStruct(e,t)}}finally{t.delete(e)}}default:return{nullValue:0}}},encodeStruct=(e,t=new WeakSet)=>({fields:Object.fromEntries(Object.entries(e).map(([r,n])=>[r,encodeStructValue(n,t)]))}),decodeStructValue=e=>{const[t,r]=Object.entries(e)[0];switch(t){case"nullValue":return null;case"numberValue":return r;case"stringValue":return r;case"boolValue":return r;case"structValue":return decodeStruct(r);case"listValue":return r.values.map(decodeStructValue);default:throw new Error(`Unsupported type: ${t}`)}},decodeStruct=e=>Object.fromEntries(Object.entries(e.fields||{}).map(([t,r])=>[t,decodeStructValue(r)])),structSubstitutions={"google.protobuf.Struct":{encode:e=>encodeStruct(e),decode:e=>decodeStruct(e)}},anySubstitutions={"google.protobuf.Any":{encode:(e,t,r,n)=>{const o=r.getCodecForType(t.messageName).protoType.fields[t.fieldName];if(n.preserveAny||o.getOption("preserve_any")){if(e["@type"]&&e["@type"]!=="google.protobuf.Any")throw new Error("Can only encode google.protobuf.Any with @type set to google.protobuf.Any in preserveAny mode.");return e}if(typeof e["@type"]!="string")throw new Error("Cannot encode google.protobuf.Any without @type string field");return e["@type"]==="google.protobuf.Any"?e:e["@type"]==="google.protobuf.Struct"?r.tryGetCodecForType(e["@type"]).encodeAsAny(structSubstitutions["google.protobuf.Struct"].encode(e)):r.tryGetCodecForType(e["@type"]).encodeAsAny(e)},decode:(e,t,r,n)=>{const o=r.getCodecForType(t.messageName).protoType.fields[t.fieldName];if(n.preserveAny||o.getOption("preserve_any"))return{"@type":"google.protobuf.Any",type_url:e.type_url??"",value:e.value??new Uint8Array};if(!r.hasType(e.type_url))return{"@type":"google.protobuf.Any",...e};let s=r.tryGetCodecForType(e.type_url).decode(e.value);return e.type_url==="google.protobuf.Struct"&&(s=structSubstitutions["google.protobuf.Struct"].decode(s)),{...s,"@type":e.type_url}}}},timestampSubstitutions={"google.protobuf.Timestamp":{encode:e=>{const t=e.getTime();return{seconds:Math.floor(t/1e3).toString(),nanos:t%1e3*1e6}},decode:e=>new Date(parseInt(e.seconds??"0")*1e3+(e.nanos??0)/1e6)}},decompressSchema=e=>decompress(e),getFirstStreamValue=async(e,{timeout:t}={})=>{try{const r=new Trigger;return e.subscribe(n=>r.wake(n)),await r.wait({timeout:t})}finally{await e.close()}},Timeframe=class Xn{constructor(t=[]){this._frames=new Map;for(const[r,n]of t)this.set(r,n)}toJSON(){return this.frames().reduce((t,[r,n])=>(t[r.truncate()]=n,t),{})}toString(){return`(${this.frames().map(([t,r])=>`${t.truncate()}[${r}]`).join(", ")})`}equals(t){return this.size()===t.size()&&this.frames().every(([r,n])=>t.get(r)===n)}get(t){var r;return(r=this._frames.get(t.toHex()))==null?void 0:r.seq}set(t,r){const n=t.toHex();this._frames.set(n,{key:t,seq:r})}frames(){return Array.from(this._frames.values()).map(({key:t,seq:r})=>[t,r])}size(){return this._frames.size}isEmpty(){return this.size()===0}withoutKeys(t){return new Xn(this.frames().filter(([r])=>t.every(n=>!n.equals(r))))}map(t){return new Xn(this.frames().map(t))}totalMessages(){return Array.from(this._frames.values()).reduce((t,{seq:r})=>t+r+1,0)}newMessages(t){return Array.from(this._frames.entries()).reduce((r,[n,{seq:o}])=>{var s;return r+Math.max(o-(((s=t._frames.get(n))==null?void 0:s.seq)??-1),0)},0)}[export_inspect.custom](){return`Timeframe${this.toString()}`}[equalsSymbol](t){return t instanceof Xn?this.equals(t):!1}static merge(...t){const r=new Xn;for(const n of t)for(const[o,s]of n._frames){const a=r._frames.get(o);(a===void 0||s.seq>a.seq)&&r._frames.set(o,s)}return r}static dependencies(t,r){const n=new Xn;for(const[o,s]of t._frames){const a=r._frames.get(o);(a===void 0||a.seq<s.seq)&&n._frames.set(o,s)}return n}};let substitutions,substitutions$1,schemaJson,STORAGE_VERSION;substitutions={"dxos.keys.PublicKey":{encode:e=>({data:e.asUint8Array()}),decode:e=>PublicKey.from(e.data)},"dxos.keys.PrivateKey":{encode:e=>({data:new Uint8Array(e)}),decode:e=>PublicKey.from(new Uint8Array(e.data)).asBuffer()},"dxos.echo.timeframe.TimeframeVector":{encode:e=>({frames:e.frames().map(([t,r])=>({feedKey:t.asUint8Array(),seq:r}))}),decode:e=>new Timeframe((e.frames??[]).filter(t=>t.feedKey!=null&&t.seq!=null).map(t=>[PublicKey.from(t.feedKey),t.seq]))}},substitutions$1={...anySubstitutions,...structSubstitutions,...substitutions,...timestampSubstitutions},schemaJson=decompressSchema(JSON.parse(`[["nested","a|0","dxos","example","google","a|2|3|4","agent","bot","client","config","devtools","echo","error","gravity","halo","iframe","keys","mesh","registry","rpc","service","tracing","type","value","a|6|7|8|9|A|B|C|D|E|F|G|H|I|J|K|L|M|N","dashboard","echoproxy","epoch","functions","a|P|Q|R|S","AgentStatus","DashboardService","PluginState","a|U|V|W","oneofs","fields","comment","a|Y|Z|0|a","_memory","a|c","oneof","a|e","memory","a|g","o|f|h","o|d|i","status","plugins","a|k|g|l","id","a|M|n|a","Status","n|1","o|o|p|q|","options","a|M|n|s|a","Memory","n|2","proto3_optional","a|w","b|T","o|x|y","o|t|u|v|z|","rule","a|11|M|n|a","repeated","n|3","o|12|13|W|14|","o|m|r|10|15","a|u|p","a|Z|a","total","free","ramUsage","a|19|1A|1B","string","The total amount of system memory in bytes as a string.","o|o|1D|q|1E","The amount of free system memory in bytes as a string.","o|o|1D|v|1G","o|o|1D|14|","o|1C|1F|1H|1I","o|18|1J|","values","comments","a|1L|a|1M","ON","OFF","a|1O|1P","n|0","o|1Q|1R|q","o|1Q||","o|1N|1S||1T","o|17|1K|1U","o|b|j|16|1V|","methods","a|1X|a","a|k","requestType","responseType","responseStream","a|1a|1b|1c|a","google.protobuf.Empty","o|1d|1e|U|y|","o|1Z|1f","o|1Y|1g|","a|n|9","o|o|1D|q|","dxos.config.Runtime.Agent.Plugin","o|o|1k|v|","o|1i|1j|1l","o|18|1m|","o|X|1W|1h|1n","o|1|1o","Config","a|1q","a|Y|Z|a","_port","a|1t","port","a|1v","o|f|1w","o|1u|1x","int32","o|t|1z|q|z|","o|1w|20","o|1s|1y|21|","o|1r|22","o|1|23","EpochMonitorConfig","a|25","_minMessagesBetweenEpochs","_minTimeBetweenEpochs","_minInactivityBeforeEpoch","_maxInactivityDelay","a|27|28|29|2A","minMessagesBetweenEpochs","a|2C","o|f|2D","minTimeBetweenEpochs","a|2F","o|f|2G","minInactivityBeforeEpoch","a|2I","o|f|2J","maxInactivityDelay","a|2L","o|f|2M","o|2B|2E|2H|2K|2N","a|2C|2F|2I|2L","o|t|1z|v|z|","o|t|1z|14|z|","n|4","o|t|1z|2S|z|","o|2P|20|2Q|2R|2T","o|1s|2O|2U|","o|26|2V","o|1|2W","Function","FunctionRegistryService","FunctionsConfig","RegisterRequest","RegisterResponse","UnregisterRequest","UpdateRegistrationRequest","a|2Y|2Z|2a|2b|2c|2d|2e","route","a|n|2g","o|o|1D|v|","o|2h|1j|2i","o|18|2j|","Register","UpdateRegistration","Unregister","a|2l|2m|2n","a|1a|1b|a","o|2p|2b|2c|","o|2p|2e|1e|","o|2p|2d|1e|","o|2o|2q|2r|2s","o|1Y|2t|","_manifest","a|1t|2v","manifest","a|2x","o|f|2y","o|2w|1x|2z","a|1v|2x","o|t|1D|v|z|","o|31|20|32","o|1s|30|33|","endpoint","a|35","o|36|1j","o|18|37|","registrationId","a|39|35","o|3A|1j|2i","o|18|3B|","a|39","o|3D|1j","o|18|3E|","a|39|S","o|12|13|2Y|v|","o|3G|1j|3H","o|18|3I|","o|2f|2k|2u|34|38|3C|3F|3J","o|1|3K","o|T|1p|24|2X|3L","o|1|3M","Bot","BotFactoryService","BotPackageSpecifier","BotReport","BotService","GetBotsResponse","GetLogsRequest","GetLogsResponse","InitializeRequest","SendCommandRequest","SendCommandResponse","SpawnBotRequest","StartRequest","a|3O|3P|3Q|3R|3S|3T|3U|3V|3W|3X|3Y|3Z|3a","_status","_desiredState","_attemptsToAchieveDesiredState","_packageSpecifier","_lastStart","_spaceKey","_runtime","_report","a|3c|3d|3e|3f|3g|3h|3i|3j","o|f|1Z","desiredState","a|3m","o|f|3n","attemptsToAchieveDesiredState","a|3p","o|f|3q","packageSpecifier","a|3s","o|f|3t","lastStart","a|3v","o|f|3w","spaceKey","a|3y","o|f|3z","runtime","a|41","o|f|42","report","a|44","o|f|45","o|3k|3l|3o|3r|3u|3x|40|43|46","a|n|k|3m|3p|3s|3v|3y|41|44","o|t|p|v|z|","n|t","The state that the bot aims to be in. Can be only either RUNNING or STOPPED.","o|t|p|4A|z|4B","n|u","o|t|1z|4D|z|","o|t|3Q|14|z|","google.protobuf.Timestamp","o|t|4G|2S|z|","dxos.keys.PublicKey","n|5","o|t|4I|4J|z|","Runtime","n|6","o|t|4L|4M|z|","n|7","o|t|3R|4O|z|","o|48|1j|49|4C|4E|4F|4H|4K|4N|4P","a|4L|p","_exitCode","_exitSignal","_error","a|4S|4T|4U","exitCode","a|4W","o|f|4X","exitSignal","a|4Z","o|f|4a","a|C","o|f|4c","o|4V|4Y|4b|4d","a|4W|4Z|C","o|t|1D|14|z|","o|4f|20|32|4g","o|1s|4e|4h|","STOPPED","STARTING","RUNNING","STOPPING","SPAWNING","a|4j|4k|4l|4m|4n","o|4o|1R|q|v|14|2S","Starting bot process.","Bot is running.","Bot is stopping.","Bot is being spawned. Bot factory is downloading the bot bundle and initializing resources.","o|4o||4q|4r|4s|4t","o|1N|4p||4u","o|4R|4i|4v","o|b|47|4Q|4w|","GetBots","SpawnBot","Start","Stop","Remove","GetLogs","SendCommand","RemoveAll","a|4y|4z|50|51|52|53|54|55","o|2p|1e|3T|","o|2p|3Z|3O|","o|2p|3O|3O|","o|2p|3O|1e|","o|1d|3U|3V|y|","o|2p|3X|3Y|","o|2p|1e|1e|","o|56|57|58|59|59|5A|5B|5C|5D","Service that is used by clients to communicate with bot factory.","o|1Y|5E|5F","kind","a|5H","a|e|a","name","ipfsCid","localPath","a|5K|5L|5M","o|5J|5N|","o|5I|5O","DXN of the bot in the DXNS registry.","o|o|1D|q|5Q","o|5N|5R|2i|1I","o|1s|5P|5S|","_processedTimeframe","a|5U","processedTimeframe","a|5W","o|f|5X","o|5V|5Y","dxos.echo.timeframe.TimeframeVector","Details of the space the bot was spawned for.","o|t|5a|q|z|5b","o|5X|5c","o|1s|5Z|5d|","Initialize","Command","StartReporting","a|5f|50|5g|51|5h","Initialize Client, create profile, and join a space.","o|2p|3W|1e|5j","Start an initialized bot.","o|2p|3a|1e|5l","Custom commands sent to the bot factory.","o|2p|3X|3Y|5n","Stop the bot.","o|2p|1e|1e|5p","Send periodic reports of the bot's state.","o|1d|1e|3R|y|5r","o|5i|5k|5m|5o|5q|5s","Service that is used by bots communicating with bot factory.","o|1Y|5t|5u","bots","a|5w","o|12|13|3O|q|","o|5x|5y","o|18|5z|","botId","a|61","o|62|1j","o|18|63|","chunk","a|65","bytes","o|o|67|q|","o|66|68","o|18|69|","_config","_invitation","_id","a|6B|6C|6D","a|9","o|f|6F","invitation","a|6H","o|f|6I","a|n","o|f|6K","o|6E|6G|6J|6L","a|9|6H|n","dxos.config.Config","Bot runtime configuration.","o|t|6O|q|z|6P","dxos.client.services.Invitation","Invitation for the bot to join the target space.","o|t|6R|v|z|6S","ID of the bot.","o|t|1D|14|z|6U","o|6N|6Q|6T|6V","o|1s|6M|6W|","_botId","_command","a|6Y|6Z","o|f|62","command","a|6c","o|f|6d","o|6a|6b|6e","a|61|6c","o|t|1D|q|z|","o|t|67|v|z|","o|6g|6h|6i","o|1s|6f|6j|","_response","a|6l","response","a|6n","o|f|6o","o|6m|6p","o|t|67|q|z|","o|6o|6r","o|1s|6q|6s|","_package","a|6u|6C|3h","package","a|6w","o|f|6x","o|6v|6y|6J|40","a|6w|6H|3y","o|t|3Q|q|z|","Key of the space bot is invited to.","o|t|4I|14|z|72","o|70|71|6T|73","o|1s|6z|74|","o|o|6O|q|6P","o|6F|76","o|18|77|","o|3b|4x|5G|5T|5e|5v|60|64|6A|6X|6k|6t|75|78","o|1|79","services","a|7B","AcceptInvitationRequest","AdmissionKeypair","AuthenticationRequest","CancelInvitationRequest","ConnectionState","Contact","ContactsService","ControlMetricsRequest","ControlMetricsResponse","CreateEpochRequest","CreateIdentityRequest","Device","DeviceKind","DevicesService","GetDiagnosticsRequest","GetDiagnosticsResponse","Identity","IdentityService","Invitation","InvitationMethod","InvitationsService","LoadPersistentInvitationsResponse","LogEntry","LoggingService","LogLevel","Metrics","NetworkService","NetworkStatus","Platform","PostMessageRequest","QueryCredentialsRequest","QueryDevicesResponse","QueryIdentityResponse","QueryInvitationsResponse","QueryLogsRequest","QueryMetricsRequest","QueryMetricsResponse","QuerySpacesResponse","QueryStatusRequest","QueryStatusResponse","RecoverIdentityRequest","SignPresentationRequest","Space","SpaceMember","SpacesService","SpaceState","SubscribeMessagesRequest","SystemService","SystemStatus","UpdateConfigRequest","UpdateMemberRoleRequest","UpdateSpaceRequest","UpdateStatusRequest","WriteCredentialsRequest","a|7D|7E|7F|7G|7H|7I|7J|7K|7L|7M|7N|7O|7P|7Q|7R|7S|7T|7U|7V|7W|7X|7Y|7Z|7a|7b|7c|7d|7e|7f|7g|7h|7i|7j|7k|7l|7m|7n|7o|7p|7q|7r|7s|7t|7u|7v|7w|7x|7y|7z|80|81|82|83|84","_deviceProfile","a|86","deviceProfile","a|88","o|f|89","o|87|8A","a|6H|88","o|o|7V|q|","dxos.halo.credentials.DeviceProfileDocument","o|t|8E|v|z|","o|8C|8D|8F","o|1s|8B|8G|","_privateKey","a|8I","privateKey","a|8K","o|f|8L","o|8J|8M","publicKey","a|8O|8K","o|o|4I|q|","dxos.keys.PrivateKey","o|t|8R|v|z|","o|8P|8Q|8S","o|1s|8N|8T|","invitationId","authCode","a|8V|8W","o|8X|1j|2i","o|18|8Y|","a|8V","o|8a|1j","o|18|8b|","OFFLINE","ONLINE","a|8d|8e","o|8f|1R|q","o|8f||","o|1N|8g||8h","profile","a|8j","halo.credentials.ProfileDocument","o|o|8l|q|","o|8k|8m","o|18|8n|","UpdateContact","QueryContacts","a|8p|8q","o|2p|1e|7I|","o|1d|1e|7I|y|","o|8r|8s|8t","o|1Y|8u|","_reset","_record","a|8w|8x","reset","a|8z","o|f|90","record","a|92","o|f|93","o|8y|91|94","a|8z|92","bool","o|t|97|q|z|","o|t|97|v|z|","o|96|98|99","o|1s|95|9A|","_recording","a|9C","recording","a|9E","o|f|9F","o|9D|9G","o|9F|98","o|1s|9H|9I|","_migration","a|9K","migration","a|9M","o|f|9N","o|9L|9O","a|3y|9M","Migration","o|t|9R|v|z|","o|9Q|8Q|9S","a|9R","NONE","INIT_AUTOMERGE","PRUNE_AUTOMERGE_ROOT_HISTORY","FRAGMENT_AUTOMERGE_ROOT","a|9V|9W|9X|9Y","o|9Z|1R|q|v|14","Init empty automerge document as the space root. Disables legacy ECHO snapshot creation.","Init new automerge root by clonning the current space root. History is pruned.","Create a new space root and move objects from the current space root to separate automerge documents and.","o|9Z||9b|9c|9d","o|1N|9a||9e","o|9U|9f","o|b|9P|9T|9g|","reserved","a|Y|Z|9i|a","_profile","a|9k|86","o|f|8k","o|9l|9m|8A","a|8j|88","o|t|8l|q|z|","halo.credentials.DeviceProfileDocument","o|t|9q|14|z|","o|9o|9p|9r","a|v|v","a|9t","o|9j|9n|9s|9u|","a|9k","o|9w|9m","deviceKey","presence","a|9y|5H|8j|9z","o|o|7P|v|","PresenceState","o|o|A2|2S|","o|A0|8Q|A1|9r|A3","a|A2","REMOVED","a|8d|8e|A6","o|A7|1R|q|v","o|A7|||","o|1N|A8||A9","o|A5|AA","o|b|9x|A4|AB|","CURRENT","TRUSTED","a|AD|AE","o|AF|1R|q","o|AF||","o|1N|AG||AH","UpdateDevice","QueryDevices","a|AJ|AK","o|2p|9q|7O|","o|1d|1e|7i|y|","o|AL|AM|AN","o|1Y|AO|","_keys","a|AQ","a|G","o|f|AS","o|AR|AT","KEY_OPTION","o|t|AV|q|z|","o|AS|AW","a|AV","TRUNCATE","HUMANIZE","a|9V|AZ|Aa","o|Ab|1R|q|v","o|Ab|||","o|1N|Ac||Ad","o|AY|Ae","o|b|AU|AX|Af|","timestamp","diagnostics","a|Ah|Ai","o|o|4G|q|","google.protobuf.Struct","o|o|Al|v|","o|Aj|Ak|Am","o|18|An|","a|3h|9k","o|Ap|40|9m","identityKey","a|Ar|3y|8j","o|t|4I|v|z|","o|t|8l|14|z|","o|As|8Q|At|Au","o|1s|Aq|Av|","CreateIdentity","RecoverIdentity","QueryIdentity","UpdateProfile","SignPresentation","a|Ax|Ay|Az|B0|B1","o|2p|7N|7T|","o|2p|7r|7T|","o|1d|1e|7j|y|","o|2p|8l|7T|","dxos.halo.credentials.Presentation","o|2p|7s|B7|","o|B2|B3|B4|B5|B6|B8","o|1Y|B9|","_timeout","_identityKey","_authCode","_target","_persistent","_created","_lifetime","_multiUse","_guestKeypair","_delegationCredentialId","_role","a|BB|BC|3h|BD|BE|BF|BG|BH|BI|BJ|BK|BL","timeout","a|BN","o|f|BO","a|Ar","o|f|BQ","a|8W","o|f|BS","target","a|BU","o|f|BV","persistent","a|BX","o|f|BY","created","a|Ba","o|f|Bb","lifetime","a|Bd","o|f|Be","multiUse","a|Bg","o|f|Bh","guestKeypair","a|Bj","o|f|Bk","delegationCredentialId","a|Bm","o|f|Bn","role","a|Bp","o|f|Bq","o|BM|BP|BR|40|BT|BW|BZ|Bc|Bf|Bi|Bl|Bo|Br","authMethod","swarmKey","state","a|8V|M|5H|Bt|Bu|Bv|BN|Ar|3y|8W|BU|BX|Ba|Bd|Bg|Bj|Bm|Bp","Local identifier (random).","o|o|1D|q|Bx","Type","Determines the behavior of the invitation.","o|o|Bz|v|C0","Kind","Kind of access the invitation will grant.","o|o|C2|14|C3","AuthMethod","How the invitation is authenticated.","o|o|C5|2S|C6","Swarm rendezvous (random).","o|o|4I|4J|C8","State","Local state.","o|o|CA|4M|CB","Timeout for guest to complete invitation once connected (ms).","o|t|1z|4O|z|CD","n|8","Guest's identity.","o|t|4I|CF|z|CG","n|9","Space to join (only present if kind is SPACE).","o|t|4I|CI|z|CJ","n|A","Authentication code created by host (only present if auth_method is SHARED_SECRET).","o|t|1D|CL|z|CM","n|B","Path or identifier to navigate to after successful authentication.","o|t|1D|CO|z|CP","n|C","Host should resume invitation on startup until timeout.","o|t|97|CR|z|CS","n|D","o|t|4G|CU|z|","n|E","o|t|1z|CW|z|","n|F","Whether an invitation can be used multiple times.","o|t|97|CY|z|CZ","n|G","Guest's keypair required for AuthMethod.KNOWN_PUBLIC_KEY.","o|t|7E|Cb|z|Cc","n|H","Present on Type.DELEGATED invitations.","o|t|4I|Ce|z|Cf","dxos.halo.credentials.SpaceMember.Role","n|I","Role of the admitted member, defaults to ADMIN.","o|t|Ch|Ci|z|Cj","o|Bw|By|C1|C4|C7|C9|CC|CE|CH|CK|CN|CQ|CT|CV|CX|Ca|Cd|Cg|Ck","a|C5|C2|CA|Bz","SHARED_SECRET","KNOWN_PUBLIC_KEY","a|9V|Cn|Co","o|Cp|1R|q|v","No authentication is required. Guest should not call \`Authenticate\`.","Guest should call \`Authenticate\` with the shared secret.","Guest should prove they possess a private key corresponding to the known public key recorded in an invitation.","o|Cp|Cr|Cs|Ct","o|1N|Cq||Cu","DEVICE","SPACE","a|Cw|Cx","o|Cy|1R|q","o|Cy||","o|1N|Cz||D0","INIT","CONNECTING","CONNECTED","READY_FOR_AUTHENTICATION","AUTHENTICATING","SUCCESS","CANCELLED","TIMEOUT","ERROR","EXPIRED","a|D2|D3|D4|D5|D6|D7|D8|D9|DA|DB","o|DC|1R|q|v|14|2S|4J|4M|4O|CF|CI","o|DC||||||||||","o|1N|DD||DE","INTERACTIVE","DELEGATED","MULTIUSE","a|DG|DH|DI","o|DJ|1R|q|v","Requires both to be online to complete key exchange.","Invitation can be accepted by any valid peer.","Multi-use interactive invitations.\\n@deprecated use multiUse flag with type=interactive instead.","o|DJ|DL|DM|DN","o|1N|DK||DO","o|Cm|Cv|D1|DF|DP","Represents the invitation state passed between client and service.","o|b|Bs|Cl|DQ|DR","accepted","a|Ba|DT","o|5J|DU|","o|5I|DV","o|o|7V|v|","o|DU|8D|DX","o|1s|DW|DY|","CreateInvitation","AcceptInvitation","Authenticate","CancelInvitation","QueryInvitations","a|Da|Db|Dc|Dd|De","o|1d|7V|7V|y|","o|1d|7D|7V|y|","o|2p|7F|1e|","o|2p|7G|1e|","o|1d|1e|7k|y|","o|Df|Dg|Dh|Di|Dj|Dk","o|1Y|Dl|","invitations","a|Dn","o|12|13|7V|q|","o|Do|Dp","o|18|Dq|","_context","_meta","a|Ds|Dt|4U","context","a|Dv","o|f|Dw","meta","a|Dy","o|f|Dz","o|Du|Dx|E0|4d","level","message","a|E2|E3|Dv|Dy|C|Ah","o|o|7b|q|","o|t|Al|14|z|","Meta","o|t|E7|2S|z|","dxos.error.Error","o|t|E9|4J|z|","o|o|4G|4M|","o|E4|E5|2i|E6|E8|EA|EB","a|E7","_scope","_resourceId","a|EE|EF","scope","a|EH","o|f|EI","resourceId","a|EK","o|f|EL","o|EG|EJ|EM","file","line","a|EO|EP|EH|EK","o|o|1z|v|","o|EQ|1j|ER|E6|2T","o|1s|EN|ES|","o|ED|ET","o|b|E1|EC|EU|","ControlMetrics","QueryMetrics","QueryLogs","a|EW|EX|EY","o|2p|7K|7L|","o|1d|7m|7n|y|","o|1d|7l|7Z|y|","o|EZ|Ea|Eb|Ec","o|1Y|Ed|","TRACE","DEBUG","INFO","WARN","a|Ef|Eg|Eh|Ei|DA","o|Ej|4J|CL|CO|CR|CU","o|Ej|||||","o|1N|Ek||El","a|Z|0|a","a|Ah|1L","KeyPair","o|12|13|Ep|CL|","o|Eo|Ak|Eq","a|Ep","_key","_value","_stats","a|Et|Eu|Ev","key","a|Ex","o|f|Ey","a|N","o|f|F0","stats","a|F2","o|f|F3","o|Ew|Ez|F1|F4","a|Ex|N|F2","dxos.value.Value","o|t|F7|v|z|","dxos.value.Stats","o|t|F9|14|z|","o|F6|6h|F8|FA","o|1s|F5|FB|","o|Es|FC","o|En|Er|FD|","UpdateConfig","QueryStatus","a|FF|FG","o|2p|80|1e|","o|1d|1e|7e|y|","o|FH|FI|FJ","o|1Y|FK|","swarm","signaling","connectionInfo","a|FM|FN|FO","o|o|7H|q|","Signal","o|12|13|FR|v|","dxos.devtools.swarm.SwarmInfo","o|12|13|FT|14|","o|FP|FQ|FS|FU","a|FR","server","a|FX|Bv","dxos.mesh.signal.SignalState","o|o|FZ|v|","o|FY|1j|Fa","o|18|Fb|","o|FW|Fc","o|En|FV|Fd|","_userAgent","_platform","_arch","_uptime","a|Ff|Fg|Fh|3i|Fi|c","userAgent","a|Fk","o|f|Fl","platform","a|Fn","o|f|Fo","arch","a|Fq","o|f|Fr","uptime","a|Ft","o|f|Fu","o|Fj|Fm|Fp|Fs|43|Fv|i","a|M|Fk|Fn|Fq|41|Ft|g","PLATFORM_TYPE","o|o|Fy|q|","The User-Agent string from a browser","o|t|1D|v|z|G0","e.g process.platform from node, e.g. 'darwin', 'linux', 'win32'","o|t|1D|14|z|G2","the Node.JS arch string, e.g. 'arm64', 'x64'","o|t|1D|2S|z|G4","the node.js version string","o|t|1D|4J|z|G6","uint32","the number of seconds the client has been up","o|t|G8|4M|z|G9","e.g. NodeJS.MemoryUsage, subject to change","o|t|Al|4O|z|GB","o|Fx|Fz|G1|G3|G5|G7|GA|GC","a|Fy","BROWSER","SHARED_WORKER","NODE","a|GF|GG|GH","o|GI|1R|q|v","o|GI|||","o|1N|GJ||GK","o|GE|GL","o|b|Fw|GD|GM|","channel","a|3y|GO|E3","google.protobuf.Any","o|o|GQ|14|","o|GP|8Q|2i|GR","o|18|GS|","_noTail","a|GU","noTail","a|GW","o|f|GX","o|GV|GY","a|3y|GW","o|Ga|8Q|99","o|1s|GZ|Gb|","devices","a|Gd","o|12|13|7O|q|","o|Ge|Gf","o|18|Gg|","_identity","a|Gi","identity","a|Gk","o|f|Gl","o|Gj|Gm","o|t|7T|q|z|","o|Gl|Go","o|1s|Gn|Gp|","_existing","a|Gr","existing","a|Gt","o|f|Gu","o|Gs|Gv","action","a|Gx|M|Dn|Gt","Action","o|o|Gz|q|","o|o|Bz|v|","o|12|13|7V|14|","o|t|97|2S|z|","o|Gy|H0|H1|H2|H3","a|Gz|Bz","ADDED","SAVED","LOAD_COMPLETE","a|H6|A6|H7|H8","o|H9|1R|q|v|14","o|H9||||","o|1N|HA||HB","CREATED","ACCEPTED","a|HD|HE","o|HF|1R|q","o|HF||","o|1N|HG||HH","o|H5|HC|HI","o|b|Gw|H4|HJ|","_options","a|HL","a|s","o|f|HN","o|HM|HO","filters","a|HQ|s","Filter","o|12|13|HS|q|","MatchingOptions","o|t|HU|CL|z|","o|HR|HT|HV","a|HS|HU","_pattern","a|HY","pattern","a|Ha","o|f|Hb","o|HZ|Hc","a|E2|Ha","o|He|E5|32","o|1s|Hd|Hf|","INCLUSIVE","EXPLICIT","a|Hh|Hi","o|Hj|q|v","Filters match all log levels above. Default behaviour for the logger.","Explicitly specify all desired log levels.","o|Hj|Hl|Hm","o|1N|Hk||Hn","o|HX|Hg|Ho","o|b|HP|HW|Hp|","_interval","a|Hr","interval","a|Ht","o|f|Hu","o|Hs|Hv","o|Hu|20","o|1s|Hw|Hx|","metrics","a|Ah|Hz","o|o|7c|v|","o|I0|Ak|I1","o|18|I2|","spaces","a|I4","o|12|13|7t|q|","o|I5|I6","o|18|I7|","o|o|7z|q|","o|1Z|I9","o|18|IA|","recoveryKey","a|IC","o|ID|68","o|18|IE|","_nonce","a|IG","nonce","a|II","o|f|IJ","o|IH|IK","presentation","a|IM|II","o|o|B7|q|","o|IN|IO|6i","o|1s|IL|IP|","_pipeline","_creator","_cache","a|IR|4U|IS|IT","pipeline","a|IV","o|f|IW","creator","a|IY","o|f|IZ","cache","a|Ib","o|f|Ic","o|IU|IX|4d|Ia|Id","members","a|3y|Bv|IV|C|If|IY|Ib|Hz","o|o|7w|v|","PipelineState","o|t|Ii|14|z|","o|t|E9|2S|z|","o|12|13|7u|CL|","o|t|4I|CO|z|","dxos.echo.metadata.SpaceCache","n|K","o|t|In|Io|z|","n|L","o|o|7c|Iq|","o|Ig|8Q|Ih|Ij|Ik|Il|Im|Ip|Ir","a|7c|Ii","_open","_pipelineInitBegin","_controlPipelineReady","_dataPipelineOpen","_dataPipelineReady","_ready","a|Iu|Iv|Iw|Ix|Iy|Iz","open","a|J1","o|f|J2","pipelineInitBegin","a|J4","o|f|J5","controlPipelineReady","a|J7","o|f|J8","dataPipelineOpen","a|JA","o|f|JB","dataPipelineReady","a|JD","o|f|JE","ready","a|JG","o|f|JH","o|J0|J3|J6|J9|JC|JF|JI","a|J1|J4|J7|JA|JD|JG","o|t|4G|q|z|","o|t|4G|v|z|","o|t|4G|14|z|","o|t|4G|4J|z|","o|t|4G|4M|z|","o|JK|JL|JM|JN|4H|JO|JP","o|1s|JJ|JQ|","_controlFeedKey","_dataFeedKey","_currentEpoch","_appliedEpoch","_currentControlTimeframe","_targetControlTimeframe","_totalControlTimeframe","_knownControlTimeframe","_startDataTimeframe","_currentDataTimeframe","_targetDataTimeframe","_totalDataTimeframe","_knownDataTimeframe","a|JS|JT|JU|JV|JW|JX|JY|JZ|Ja|Jb|Jc|Jd|Je","controlFeedKey","a|Jg","o|f|Jh","dataFeedKey","a|Jj","o|f|Jk","currentEpoch","a|Jm","o|f|Jn","appliedEpoch","a|Jp","o|f|Jq","currentControlTimeframe","a|Js","o|f|Jt","targetControlTimeframe","a|Jv","o|f|Jw","totalControlTimeframe","a|Jy","o|f|Jz","knownControlTimeframe","a|K1","o|f|K2","startDataTimeframe","a|K4","o|f|K5","currentDataTimeframe","a|K7","o|f|K8","targetDataTimeframe","a|KA","o|f|KB","totalDataTimeframe","a|KD","o|f|KE","knownDataTimeframe","a|KG","o|f|KH","o|Jf|Ji|Jl|Jo|Jr|Ju|Jx|K0|K3|K6|K9|KC|KF|KI","controlFeeds","dataFeeds","a|Jg|Jj|KK|KL|Jm|Jp|Js|Jv|Jy|K1|K4|K7|KA|KD|KG","o|t|4I|q|z|","TODO(burdon): Normalize _key suffix.","o|12|13|4I|Ci|KO","n|J","o|12|13|4I|KQ|","dxos.halo.credentials.Credential","Last processed epoch. Might now have been applied yet.","o|t|KS|Io|z|KT","Epoch that is currently applied.","o|t|KS|Iq|z|KV","Mutations already processed.","o|t|5a|CL|z|KX","Minimum timeframe to consider the state to be up-to-date.","o|t|5a|CO|z|KZ","All mutations stored in feeds.","o|t|5a|CW|z|Kb","All mutations known to exist on the network.","o|t|5a|CY|z|Kd","n|1c","Start timeframe of the pipeline.","o|t|5a|Kf|z|Kg","o|t|5a|CR|z|KX","o|t|5a|CU|z|KZ","o|t|5a|Cb|z|Kb","o|t|5a|Ce|z|Kd","o|KM|KN|At|KP|KR|KU|KW|KY|Ka|Kc|Ke|Kh|Ki|Kj|Kk|Kl","o|1s|KJ|Km|","o|It|JR|Kn","o|b|Ie|Is|Ko|","peerStates","a|Gk|9z|Kq|Bp","o|o|7T|q|","o|o|A2|v|","dxos.mesh.presence.PeerState","o|12|13|Ku|14|","o|o|Ch|2S|","o|Kr|Ks|Kt|Kv|Kw","o|A5|8i","o|En|Kx|Ky|","CreateSpace","UpdateSpace","QuerySpaces","UpdateMemberRole","PostMessage","SubscribeMessages","WriteCredentials","QueryCredentials","CreateEpoch","a|L0|L1|L2|L3|L4|L5|L6|L7|L8","o|2p|1e|7t|","o|2p|82|1e|","o|1d|1e|7o|y|","o|2p|81|1e|","Broadcast an ephemeral message to the space swarm.","o|2p|7g|1e|LE","dxos.mesh.teleport.gossip.GossipMessage","Subscribe to messages from the space swarm.","o|1d|7x|LG|y|LH","Write credentials to the space control feed.","o|2p|84|1e|LJ","Query credentials from the space control feed.","o|1d|7h|KS|y|LL","o|2p|7M|1e|","o|L9|LA|LB|LC|LD|LF|LI|LK|LM|LN","o|1Y|LO|","INACTIVE","ACTIVE","CLOSED","CONTROL_ONLY","INITIALIZING","READY","a|LQ|LR|LS|LT|LU|LV|DA","o|LW|v|4M|q|4O|2S|14|4J","Runtime state of the space object.","Space is inactive. No swarming or replication will be done.","Space is active. Swarming and replication will be done.","Space is closed.","Data pipeline is inactive.","Data pipeline is initializing.","Data pipeline is ready.","Space errored.","o|LW|LZ|La|Lb|Lc|Ld|Le|Lf","o|1N|LX|LY|Lg","a|3y|GO","o|Li|8Q|2i","o|18|Lj|","GetConfig","GetDiagnostics","UpdateStatus","Reset","GetPlatform","a|Ll|Lm|Ln|FG|Lo|Lp","Get the static config of the client.","o|2p|1e|6O|Lr","Get the diagnostics snapshot.","o|2p|7R|7S|Lt","Update the status of the client. Used to re-activate an inactive client.","o|2p|83|1e|Lv","Stream the status of the client.","o|1d|7p|7q|y|Lx","Reset the client.","o|2p|1e|1e|Lz","Get platform Information","o|2p|1e|7f|M1","o|Lq|Ls|Lu|Lw|Ly|M0|M2","o|1Y|M3|","a|LR|LQ","o|M5|1R|q","o|M5||","o|1N|M6||M7","a|FM","o|M9|FQ","o|18|MA|","memberKey","newRole","a|3y|MC|MD","o|o|4I|v|","o|o|Ch|14|","o|ME|8Q|MF|MG","o|18|MH|","_state","a|MJ","a|Bv","o|f|ML","o|MK|MM","a|3y|Bv","Allowed values: ACTIVE, INACTIVE.","o|t|7w|v|z|MP","o|MO|8Q|MQ","o|1s|MN|MR|","credentials","a|3y|MT","o|12|13|KS|v|","o|MU|8Q|MV","o|18|MW|","o|85|8H|8U|8Z|8c|8i|8o|8v|9B|9J|9h|9v|AC|AI|AP|Ag|Ao|Aw|BA|DS|DZ|Dm|Dr|EV|Ee|Em|FE|FL|Fe|GN|GT|Gc|Gh|Gq|HK|Hq|Hy|I3|I8|Hy|IB|IF|IQ|Kp|Kz|LP|Lh|Lk|M4|M8|MB|MI|MS|IB|MX","o|1|MY","o|7C|MZ","o|1|Ma","a|s|0","go_package","a|Md","github.com/dxos/kube/proto/def/dxos/config","o|Me|Mf","_envVar","envVar","Module","Package","Repo","a|Mh|1q|Mi|Mj|Mk|Ml|4L","a|Mi","o|f|Mn","_version","a|Mp|6u|3i","version","a|Mr","o|f|Ms","o|Mq|Mt|6y|43","a|Mr|6w|41","o|t|Mk|v|z|","o|t|4L|14|z|","o|Mv|20|Mw|Mx","o|1s|Mu|My|","extend","a|M|n|N0|s|a","n|G8","google.protobuf.FieldOptions","o|N1|1D|N2|N3|z|","_name","_type","_displayName","_description","_bundle","_tunnel","_build","a|6D|N5|N6|N7|N8|N9|NA|NB|8x","a|5K","o|f|ND","a|M","o|f|NF","displayName","a|NH","o|f|NI","description","a|NK","o|f|NL","bundle","a|NN","o|f|NO","tunnel","a|NQ","o|f|NR","build","a|NT","o|f|NU","o|NC|6L|NE|NG|NJ|NM|NP|NS|NV|94","tags","deps","repos","a|n|5K|M|NH|NK|NX|NN|NQ|NY|NT|NZ|92","o|t|1D|CF|z|","o|t|1D|2S|z|","o|12|13|1D|4J|","o|t|67|4M|z|","o|t|97|4O|z|","o|12|13|Mj|CL|","Build","o|t|Nh|Kf|z|","n|1d","o|12|13|Ml|Nj|","n|3E","The data will be validated based on the type when being published.","o|t|GQ|Nl|z|Nm","o|Na|Nb|6h|32|4g|Nc|Nd|Ne|Nf|Ng|Ni|Nk|Nn","a|Nh","_outdir","_tag","_env","a|6Z|Nq|Mp|Nr|Ns","outdir","a|Nu","o|f|Nv","tag","a|Nx","o|f|Ny","env","a|O0","o|f|O1","o|Nt|6e|Nw|Mt|Nz|O2","a|6c|Nu|Mr|Nx|O0","o|t|Al|CL|z|","o|O4|6h|32|4g|Nc|O5","o|1s|O3|O6|","o|Np|O7","o|b|NW|No|O8|","_license","a|OA","license","a|OC","o|f|OD","o|OB|OE","modules","a|OC|NZ|OG","o|12|13|Ml|v|","o|12|13|Mj|14|","o|OH|6h|OI|OJ","o|1s|OF|OK|","_url","a|N5|OM|Mp","url","a|OO","o|f|OP","o|ON|NE|OQ|Mt","a|5K|OO|Mr","o|OS|6h|32|4g","o|1s|OR|OT|","_client","_app","_cli","_props","_services","_system","_kube","_agent","a|OV|OW|OX|OY|OZ|Oa|Ob|Oc","a|8","o|f|Oe","app","a|Og","o|f|Oh","cli","a|Oj","o|f|Ok","props","a|Om","o|f|On","o|f|7C","system","a|Oq","o|f|Or","kube","a|Ot","o|f|Ou","a|6","o|f|Ow","o|Od|Of|Oi|Ol|Oo|Op|Os|Ov|Ox","a|8|Og|Oj|Om|7B|Oq|Ot|G|6","Client","o|t|P0|q|z|","App","o|t|P2|v|z|","CLI","o|t|P4|14|z|","Props","o|t|P6|2S|z|","Services","o|t|P8|4J|z|","System","o|t|PA|4M|z|","Kube","o|t|PC|4O|z|","Keys","o|12|13|PE|CF|","Agent","o|t|PG|CI|z|","o|Oz|P1|P3|P5|P7|P9|PB|PD|PF|PH","a|PG|P2|P4|P0|PE|PC|P6|P8|PA","a|l","Plugin","o|12|13|PL|q|","o|PK|PM","a|PL","_enabled","a|N5|PP|6B","enabled","a|PR","o|f|PS","o|PQ|NE|PT|6G","a|n|5K|PR|9","o|t|97|14|z|","o|t|GQ|CL|z|","o|PV|1j|32|PW|PX","o|1s|PU|PY|","o|PO|PZ","o|En|PN|Pa|","_org","_theme","_website","_publicUrl","a|Pc|Pd|Pe|Pf|NB|Ns","org","a|Ph","o|f|Pi","theme","a|Pk","o|f|Pl","website","a|Pn","o|f|Po","publicUrl","a|Pq","o|f|Pr","o|Pg|Pj|Pm|Pp|Ps|NV|O2","a|Ph|Pk|Pn|Pq|NT|O0","(env_var)","a|Pv|w","PUBLIC_URL","o|Pw|Px|y","o|t|1D|2S|Py|","BuildInfo","o|t|Q0|Kf|z|","o|t|Al|Nj|z|","o|Pu|6h|32|4g|Pz|Q1|Q2","a|Q0","_timestamp","_commitHash","_branch","a|Q5|Q6|Mp|Q7","a|Ah","o|f|Q9","commitHash","a|QB","o|f|QC","branch","a|QE","o|f|QF","o|Q8|QA|QD|Mt|QG","a|Ah|QB|Mr|QE","RFC-3339 datetime string.","o|t|1D|q|z|QJ","Version from package.json.","o|t|1D|14|z|QL","o|QI|QK|32|QM|Nc","o|1s|QH|QN|","o|Q4|QO","o|b|Pt|Q3|QP|","_nodePath","_console","_mdns","_signal","_npmClient","_channel","a|QR|OW|QS|QT|QU|QV|QW","nodePath","a|QY","o|f|QZ","console","a|Qb","o|f|Qc","mdns","a|Qe","o|f|Qf","signal","a|Qh","o|f|Qi","npmClient","a|Qk","o|f|Ql","a|GO","o|f|Qn","o|QX|Qa|Oi|Qd|Qg|Qj|Qm|Qo","a|QY|Og|Qb|Qe|Qh|Qk|GO","AppServe","o|t|Qr|v|z|","o|t|Mk|14|z|","o|t|Mk|2S|z|","o|t|Mk|4J|z|","o|t|1D|4M|z|","o|t|1D|4O|z|","o|Qq|6h|Qs|Qt|Qu|Qv|Qw|Qx","a|Qr|Mk","_serve","a|R0","serve","a|R2","o|f|R3","o|R1|R4","Serve","o|t|R6|q|z|","o|R3|R7","a|R6","_loginApp","_keyPhrase","a|6B|RA|RB","loginApp","a|RD","o|f|RE","keyPhrase","a|RG","o|f|RH","o|RC|6G|RF|RI","a|9|RD|RG","o|RK|6h|32|4g","o|1s|RJ|RL|","o|R9|RM","o|b|R5|R8|RN|","_bin","a|6u|QW|RP|6B","bin","a|RR","o|f|RS","o|RQ|6y|Qo|RT|6G","a|6w|GO|RR|9","o|RV|6h|32|4g|Nc","o|1s|RU|RW|","o|Qz|RO|RX","o|b|Qp|Qy|RY|","_log","_storage","_enableSnapshots","_snapshotInterval","_invitationExpiration","_remoteSource","_remoteSourceAuthenticationToken","_devtoolsProxy","a|Ra|Rb|Rc|Rd|Re|Rf|Rg|Rh","log","a|Rj","o|f|Rk","storage","a|Rm","o|f|Rn","enableSnapshots","a|Rp","o|f|Rq","snapshotInterval","a|Rs","o|f|Rt","invitationExpiration","a|Rv","o|f|Rw","remoteSource","a|Ry","o|f|Rz","remoteSourceAuthenticationToken","a|S1","o|f|S2","devtoolsProxy","a|S4","o|f|S5","o|Ri|Rl|Ro|Rr|Ru|Rx|S0|S3|S6","a|Rj|Rm|Rp|Rs|Rv|Ry|S1|S4","Log","o|t|S9|q|z|","Storage","o|t|SB|v|z|","Milliseconds","o|t|1z|2S|z|SD","o|t|1z|4J|z|SD","Connect to and serve client services to a remote proxy.","o|t|1D|4O|z|SG","o|S8|SA|SC|PW|SE|SF|Qw|Nb|SH","a|S9|SB","_filter","_prefix","a|SK|SL","filter","a|SN","o|f|SO","prefix","a|SQ","o|f|SR","o|SM|SP|SS","a|SN|SQ","LOG_FILTER","o|Pw|SV|y","o|t|1D|q|SW|","LOG_PREFIX","o|Pw|SY|y","o|t|1D|v|SZ|","o|SU|SX|Sa","o|1s|ST|Sb|","_keyStore","_dataStore","_dataRoot","_spaceFragmentation","a|BF|Sd|Se|Sf|Sg","keyStore","a|Si","o|f|Sj","dataStore","a|Sl","o|f|Sm","dataRoot","a|So","o|f|Sp","spaceFragmentation","a|Sr","o|f|Ss","o|Sh|BZ|Sk|Sn|Sq|St","a|BX|Si|Sl|So|Sr","StorageDriver","o|t|Sw|v|z|","o|t|Sw|14|z|","@deprecated","o|t|97|4J|z|Sz","o|Sv|98|Sx|Sy|Nc|T0","a|Sw","RAM","IDB","CHROME","FIREFOX","WEBFS","LEVELJS","JSONDOWN","a|T3|T4|T5|T6|GH|T7|T8|T9","o|TA|1R|q|v|14|2S|4J|CO|CR","o|TA||||||||","o|1N|TB||TC","o|T2|TD","o|b|Su|T1|TE|","o|SJ|Sc|TF","o|b|S7|SI|TG|","a|N5|Eu","o|TI|NE|F1","a|5K|N","o|TK|6h|32","o|1s|TJ|TL|","host","autoupdate","https","p2p","confhost","alias","monitoring","trace","telemetry","appTunneling","ipfsApiAuthorizations","a|TN|1v|TO|TP|TQ|TR|O0|TS|TT|TU|TV|D|TW|5w|TX","Autoupdate","o|o|TZ|14|","Https","o|o|Tb|2S|","P2P","o|o|Td|4J|","o|o|1D|4M|","o|12|13|1D|4O|","o|12|13|1D|CF|","Monitoring","o|o|Ti|CI|","Trace","o|o|Tk|CL|","Telemetry","o|o|Tm|CO|","Gravity","o|o|To|CR|","AppTunneling","o|o|Tq|CU|","Bots","o|o|Ts|CW|","KuboApiAuthorization","o|12|13|Tu|CY|","o|TY|1j|2i|Ta|Tc|Te|Tf|Tg|Th|Tj|Tl|Tn|Tp|Tr|Tt|Tv","a|Tq|TZ|Ts|To|Tb|Tu|Ti|Td|Tm|Tk","commandTemplate","outputRe","a|PR|Ty|Tz|1v","o|o|97|q|","o|o|1D|2S|","o|U0|U1|2i|1I|U2","o|18|U3|","a|PR|Ht","Seconds","o|o|1z|v|U6","o|U5|U1|U7","o|18|U8|","Refresh interval - Seconds","o|o|1z|v|UA","o|U5|U1|UB","o|18|UC|","_logDir","a|UE","logDir","a|UG","o|f|UH","o|UF|UI","disabled","a|UK|5K|UG","o|UL|U1|2i|4g","o|1s|UJ|UM|","email","certfile","keyfile","dnsprovider","a|PR|1v|UO|UP|UQ|UR","o|o|1D|4J|","o|US|U1|2i|1I|U2|UT|Tf","o|18|UU|","authSecret","allowedPaths","a|5K|UW|UX","Just for organizational purposes.","o|o|1D|q|UZ","o|12|13|1D|14|","o|UY|Ua|2i|Ub","https://github.com/ipfs/kubo/blob/master/docs/config.md#apiauthorizations","o|18|Uc|Ud","a|PR|35|Ht","o|o|1z|14|U6","o|Uf|U1|2i|Ug","o|18|Uh|","privatekey","bootstrap","a|Uj|1v|Uk","o|Ul|1j|2i|Ub","o|18|Um|","a|UK|NX","o|12|13|1D|v|","o|Uo|U1|Up","o|18|Uq|","a|UK","o|Us|U1","o|18|Ut|","o|Tx|U4|U9|UD|UN|UV|Ue|Ui|Un|Ur|Uu","o|En|Tw|Uv|","_title","a|Ux","title","a|Uz","o|f|V0","o|Uy|V1","o|V0|6h","o|1s|V2|V3|","_dxns","_ipfs","_machine","_bot","_publisher","_supervisor","_tunneling","_faasd","_agentHosting","a|Ob|OW|V5|V6|V7|V8|V9|VA|VB|VC|VD","dxns","a|VF","o|f|VG","ipfs","a|VI","o|f|VJ","machine","a|VL","o|f|VM","a|7","o|f|VO","publisher","a|VQ","o|f|VR","supervisor","a|VT","o|f|VU","tunneling","a|VW","o|f|VX","faasd","a|VZ","o|f|Va","agentHosting","a|Vc","o|f|Vd","o|VE|Ov|Oi|VH|VK|VN|VP|VS|VV|VY|Vb|Ve","ice","a|Ot|Og|VF|VI|FN|Vg|VL|7|VQ|VT|VW|VZ|Vc","o|t|PC|q|z|","AppServer","o|t|Vj|v|z|","Dxns","o|t|Vl|14|z|","Ipfs","o|t|Vn|2S|z|","o|12|13|FR|4J|","Ice","o|12|13|Vq|4M|","Machine","o|t|Vs|4O|z|","BotHost","o|t|Vu|CF|z|","Publisher","o|t|Vw|CI|z|","Supervisor","o|t|Vy|CL|z|","Tunneling","o|t|W0|CO|z|","Faasd","o|t|W2|CR|z|","AgentHosting","o|t|W4|CU|z|","o|Vh|Vi|Vk|Vm|Vo|Vp|Vr|Vt|Vv|Vx|Vz|W1|W3|W5","a|W4|Vj|Vu|Vl|W2|Vq|Vn|PC|Vs|Vw|FR|Vy|W0","_server","a|W8|N6","a|FX","o|f|WA","o|W9|WB|NG","a|FX|M","o|WD|6h|32","o|1s|WC|WE|","a|SL|W8","o|WG|SS|WB","a|SQ|FX","o|WI|6h|32","o|1s|WH|WJ|","_proxy","a|WL","proxy","a|WN","o|f|WO","o|WM|WP","o|WO|6h","o|1s|WQ|WR|","_accountUri","_address","_account","_faucet","a|W8|WT|WU|WV|WW","accountUri","a|WY","o|f|WZ","address","a|Wb","o|f|Wc","account","a|We","o|f|Wf","faucet","a|Wh","o|f|Wi","o|WX|WB|Wa|Wd|Wg|Wj","a|FX|WY|Wb|We|Wh","DXNS endpoint.","o|t|1D|q|z|Wm","Substrate account URI. This is a secret.\\nKUBEs do not serve this with the config but we store it in profile.yml.\\n\\nTODO(dmaretskyi): Deprecate this and move it to keyring.","o|t|1D|v|z|Wo","Public Polkadot Address.","o|t|1D|14|z|Wq","Public address of a DXNS Account.","o|t|1D|2S|z|Ws","o|t|1D|4J|z|","o|Wl|Wn|Wp|Wr|Wt|Wu","o|1s|Wk|Wv|","_gateway","_username","_password","a|Wx|Wy|Wz","gateway","a|X1","o|f|X2","username","a|X4","o|f|X5","password","a|X7","o|f|X8","o|X0|X3|X6|X9","a|X1|X4|X7","o|XB|6h|32|4g","o|1s|XA|XC|","_urls","_credential","a|XE|Wy|XF","urls","a|XH","o|f|XI","credential","a|XK","o|f|XL","o|XG|XJ|X6|XM","a|XH|X4|XK","o|XO|6h|32|4g","o|1s|XN|XP|","_serverAuthSecret","a|W8|Wx|XR","serverAuthSecret","a|XT","o|f|XU","o|XS|WB|X3|XV","a|FX|X1|XT","Same secret format as https://github.com/ipfs/kubo/blob/master/docs/config.md#apiauthorizations","o|t|1D|14|z|XY","o|XX|6h|32|XZ","o|1s|XW|Xa|","_endpoints","a|Xc|Pf","endpoints","a|Xe","o|f|Xf","o|Xd|Xg|Ps","a|Xe|Pq","Endpoints","o|t|Xj|q|z|","o|Xi|Xk|32","a|Xj","_logs","_cert","a|Xn|OZ|Xo","logs","a|Xq","o|f|Xr","cert","a|Xt","o|f|Xu","o|Xp|Xs|Op|Xv","a|Xq|7B|Xt","o|Xx|6h|32|4g","o|1s|Xw|Xy|","o|Xm|Xz","o|b|Xh|Xl|Y0|","_doAccessToken","_githubAccessToken","_githubUsername","_dnsDomain","_npmAccessToken","a|Y2|Y3|Y4|Y5|Y6","doAccessToken","a|Y8","o|f|Y9","githubAccessToken","a|YB","o|f|YC","githubUsername","a|YE","o|f|YF","dnsDomain","a|YH","o|f|YI","npmAccessToken","a|YK","o|f|YL","o|Y7|YA|YD|YG|YJ|YM","a|Y8|YB|YE|YH|YK","o|YO|6h|32|4g|Nc|Wu","o|1s|YN|YP|","a|W8","o|YR|WB","o|WA|6h","o|1s|YS|YT|","_api","a|YV|3c","api","a|YX","o|f|YY","o|YW|YZ|3l","a|FX|YX|k","o|Yb|1j|32|4g","o|1s|Ya|Yc|","o|W7|WF|WK|WS|Ww|XD|XQ|Xb|Y1|YQ|YU|Yd|YU|YU","o|b|Vf|W6|Ye|","_debug","a|Yg","debug","a|Yi","o|f|Yj","o|Yh|Yk","o|Yj|6h","o|1s|Yl|Ym|","o|PJ|Pb|QQ|RZ|TH|TM|Uw|V4|Yf|Yn","o|b|Oy|PI|Yo|","o|Mm|Mo|Mz|N4|O9|OL|OU|Yp","o|Mc|Mg|Yq","a|TN|FM","ClearSnapshotsRequest","DevtoolsHost","DisableDebugLoggingRequest","DisableDebugLoggingResponse","EnableDebugLoggingRequest","EnableDebugLoggingResponse","Event","FeedStats","GetBlobsResponse","GetConfigResponse","GetNetworkPeersRequest","GetNetworkPeersResponse","GetSnapshotsResponse","GetSpaceSnapshotRequest","GetSpaceSnapshotResponse","PeerStats","ReadyEvent","ResetStorageRequest","SaveSpaceSnapshotRequest","SaveSpaceSnapshotResponse","SignalResponse","SpaceStats","StorageInfo","StoredSnapshotInfo","SubscribeToCredentialMessagesRequest","SubscribeToCredentialMessagesResponse","SubscribeToFeedBlocksRequest","SubscribeToFeedBlocksResponse","SubscribeToFeedsRequest","SubscribeToFeedsResponse","SubscribeToItemsRequest","SubscribeToItemsResponse","SubscribeToKeyringKeysRequest","SubscribeToKeyringKeysResponse","SubscribeToMetadataResponse","SubscribeToNetworkTopicsResponse","SubscribeToSignalStatusResponse","SubscribeToSpacesRequest","SubscribeToSpacesResponse","SubscribeToSwarmInfoRequest","SubscribeToSwarmInfoResponse","a|Yt|Yu|Yv|Yw|Yx|Yy|Yz|Z0|Z1|Z2|Z3|Z4|Z5|Z6|Z7|Z8|Z9|ZA|ZB|ZC|P8|ZD|ZE|ZF|ZG|ZH|ZI|ZJ|ZK|ZL|ZM|ZN|ZO|ZP|ZQ|ZR|ZS|ZT|ZU|ZV|ZW|ZX","o|","o|18|ZZ|","Events","GetStorageInfo","ResetStorage","GetBlobs","GetSnapshots","EnableDebugLogging","DisableDebugLogging","SubscribeToKeyringKeys","SubscribeToCredentialMessages","SubscribeToSpaces","SubscribeToItems","SubscribeToFeeds","SubscribeToFeedBlocks","SubscribeToMetadata","GetSpaceSnapshot","SaveSpaceSnapshot","ClearSnapshots","GetNetworkPeers","SubscribeToNetworkTopics","SubscribeToSignalStatus","SubscribeToSignal","SubscribeToSwarmInfo","a|Zb|Ll|Zc|Zd|Ze|Zf|Zg|Zh|Zi|Zj|Zk|Zl|Zm|Zn|Zo|Zp|Zq|Zr|Zs|Zt|Zu|Zv|Zw","o|1d|1e|Yz|y|","o|2p|1e|Z2|","o|2p|1e|ZF|","o|2p|ZA|1e|","o|2p|1e|Z1|","o|2p|1e|Z5|","o|2p|Yx|Yy|","o|1d|ZP|ZQ|y|","o|1d|ZH|ZI|y|","o|1d|ZU|ZV|y|","o|1d|ZN|ZO|y|","o|1d|ZL|ZM|y|","o|1d|ZJ|ZK|y|","o|1d|1e|ZR|y|","o|2p|Z6|Z7|","o|2p|ZB|ZC|","o|2p|Yt|1e|","o|2p|Z3|Z4|","o|1d|1e|ZS|y|","o|1d|1e|ZT|y|","o|1d|1e|ZD|y|","o|1d|ZW|ZX|y|","o|Zx|Zy|Zz|a0|a1|a2|a3|a4|a4|a5|a6|a7|a8|a9|aA|aB|aC|aD|aE|aF|aG|aH|aI|aJ","o|1Y|aK|","_namespaces","a|aM","namespaces","a|aO","o|f|aP","o|aN|aQ","o|aP|6h","o|1s|aR|aS|","_enabledNamespaces","a|aU","enabledNamespaces","a|aW","o|f|aX","o|aV|aY","o|aX|6h","o|1s|aZ|aa|","payload","a|ac","o|5J|JH|","o|ad|ae","o|o|Z9|q|","o|JH|ag","o|1s|af|ah|","length","a|Ex|aj","o|ak|8Q|ER","o|18|al|","blobs","a|an","dxos.echo.blob.BlobMeta","o|12|13|ap|q|","o|ao|aq","o|18|ar|","o|6F|1j","o|18|at|","topic","a|av","o|aw|68","o|18|ax|","peers","a|az","PeerInfo","o|12|13|b1|q|","o|b0|b2","a|b1","connections","a|n|Bv|b5","o|12|13|67|14|","o|b6|8Q|2i|b7","o|18|b8|","o|b4|b9","o|En|b3|bA|","snapshots","a|bC","o|12|13|ZG|q|","o|bD|bE","o|18|bF|","o|3z|8Q","o|18|bH|","_snapshot","a|bJ","snapshot","a|bL","o|f|bM","o|bK|bN","dxos.echo.snapshot.SpaceSnapshot","o|t|bP|q|z|","o|bM|bQ","o|1s|bO|bR|","controlFeed","dataFeed","a|bT|bU","o|o|Z0|q|","o|o|Z0|v|","o|bV|bW|bX","o|18|bY|","o|12|13|ZE|q|","o|I5|ba","o|18|bb|","data","_topic","a|bd|be","swarmEvent","a|bg|E3","o|5J|bh|","o|f|aw","o|bf|bi|bj","receivedAt","a|bg|E3|bl|av","dxos.mesh.signal.SwarmEvent","o|o|bn|q|","dxos.mesh.signal.Message","o|o|bp|v|","o|o|4G|14|","o|t|67|2S|z|","o|bm|bo|bq|br|bs","o|1s|bk|bt|","a|Ex|az","o|12|13|Z8|v|","o|bv|8Q|bw","o|18|bx|","storageUsage","originUsage","usageQuota","a|M|bz|c0|c1","o|o|G8|v|","o|o|G8|14|","o|o|G8|2S|","o|c2|1j|c3|c4|c5","o|18|c6|","size","a|Ex|c8","o|c9|1j|c3","o|18|cA|","a|3h","o|cC|40","o|3z|KN","o|1s|cD|cE|","messages","a|cG","dxos.halo.signed.SignedMessage","o|12|13|cI|q|","o|cH|cJ","o|18|cK|","_feedKey","_maxBlocks","a|3h|cM|cN","feedKey","a|cP","o|f|cQ","maxBlocks","a|cS","o|f|cT","o|cO|40|cR|cU","a|3y|cP|cS","o|cW|KN|At|2R","o|1s|cV|cX|","blocks","a|cZ","Block","o|12|13|cb|q|","o|ca|cc","a|cb","seq","a|cP|cf|bd","dxos.echo.feed.FeedMessage","o|o|ch|14|","o|cg|8Q|ER|ci","o|18|cj|","o|ce|ck","o|En|cd|cl|","feedKeys","a|cn","o|12|13|4I|q|","o|co|cp","o|18|cq|","feeds","a|cs","Feed","o|12|13|cu|q|","o|ct|cv","a|cu","downloaded","a|cP|aj|67|cy","o|o|1z|14|","Bitfield of downloaded blocks.","o|o|67|2S|d1","o|cz|8Q|ER|d0|d2","o|18|d3|","o|cx|d4","o|En|cw|d5|","a|bd","o|d7|1j","o|18|d8|","dxos.halo.keyring.KeyRecord","o|12|13|dA|q|","o|AS|dB","o|18|dC|","metadata","a|dE","dxos.echo.metadata.EchoMetadata","o|o|dG|q|","o|dF|dH","o|18|dI|","topics","a|dK","Topic","o|12|13|dM|q|","o|dL|dN","a|dM","_label","a|dQ","label","a|dS","o|f|dT","o|dR|dU","a|av|dS","o|dW|8Q|32","o|1s|dV|dX|","o|dP|dY","o|En|dO|dZ|","servers","a|db","SignalServer","o|12|13|dd|q|","o|dc|de","a|dd","a|4U","o|dh|4d","reconnectIn","connectionStarted","lastStateChange","a|TN|Bv|C|dj|dk|dl","o|o|1z|2S|","o|o|4G|4J|","o|dm|1j|Fa|4g|dn|do|EB","o|1s|di|dp|","o|dg|dq","o|En|df|dr|","spaceKeys","a|dt","o|du|cp","o|18|dv|","SpaceInfo","o|12|13|dx|q|","o|I5|dy","a|dx","_timeframe","a|e1","timeframe","a|e3","o|f|e4","o|e2|e5","isOpen","genesisFeed","a|Ex|e7|e3|e8|bT|bU","o|o|97|v|","o|t|5a|14|z|","o|o|4I|2S|","o|o|4I|4J|","o|o|4I|4M|","o|e9|8Q|eA|eB|eC|eD|eE","o|1s|e6|eF|","o|e0|eG","o|En|dz|eH|","o|12|13|FT|q|","o|d7|eJ","o|18|eK|","o|ZY|Za|aL|aT|ab|aT|ab|ai|am|as|au|ay|bB|bG|bI|bS|bZ|Za|Za|bI|bS|bc|bu|by|c7|cB|cF|cL|cY|cm|cr|d6|Za|d9|Za|dD|dJ|da|ds|dw|eI|Za|eL","o|1|eM","ConnectionEvent","ConnectionInfo","SwarmInfo","a|eO|eP|eQ","_newState","a|eS|4U","newState","a|eU","o|f|eV","o|eT|eW|4d","a|M|eU|C","o|eY|1j|32|4g","o|1s|eX|eZ|","_transport","_closeReason","_readBufferSize","_writeBufferSize","_lastUpdate","_transportDetails","_transportBytesSent","_transportBytesReceived","_transportPacketsSent","_transportPacketsReceived","a|eb|ec|Gi|ed|ee|ef|eg|eh|ei|ej|ek","transport","a|em","o|f|en","closeReason","a|ep","o|f|eq","readBufferSize","a|es","o|f|et","writeBufferSize","a|ev","o|f|ew","lastUpdate","a|ey","o|f|ez","transportDetails","a|f1","o|f|f2","transportBytesSent","a|f4","o|f|f5","transportBytesReceived","a|f7","o|f|f8","transportPacketsSent","a|fA","o|f|fB","transportPacketsReceived","a|fD","o|f|fE","o|el|eo|er|Gm|eu|ex|f0|f3|f6|f9|fC|fF","sessionId","remotePeerId","protocolExtensions","events","streams","a|Bv|fH|fI|em|fJ|fK|fL|ep|Gk|es|ev|ey|f1|f4|f7|fA|fD","o|o|4I|14|","o|12|13|eO|4M|","StreamStats","o|12|13|fP|4O|","o|t|1D|CI|z|","o|t|G8|CL|z|","o|t|G8|CO|z|","o|t|4G|CR|z|","o|t|1D|CU|z|","o|t|G8|CW|z|","o|t|G8|CY|z|","o|t|G8|Cb|z|","o|t|G8|Ce|z|","o|fM|1j|MF|fN|Nc|Nd|fO|fQ|Nb|fR|fS|fT|fU|fV|fW|fX|fY|fZ","a|fP","_contentType","_bytesSentRate","_bytesReceivedRate","a|fc|fd|fe|ee","contentType","a|fg","o|f|fh","bytesSentRate","a|fj","o|f|fk","bytesReceivedRate","a|fm","o|f|fn","o|ff|fi|fl|fo|ex","bytesSent","bytesReceived","a|n|Nx|fg|fq|fr|fj|fm|ev","o|o|G8|q|","o|t|G8|4M|z|","o|t|G8|4O|z|","o|t|G8|CF|z|","o|fs|ft|2i|Wu|c4|c5|fu|fv|fw","o|1s|fp|fx|","o|fb|fy","o|b|fG|fa|fz|","isActive","a|n|av|dS|g1|b5","o|o|97|2S|","o|12|13|eP|4J|","o|g2|8Q|MF|4g|g3|g4","o|1s|dV|g5|","o|eR|ea|g0|g6","o|1|g7","o|Ys|eN|g8","o|1|g9","blob","feed","indexing","model","object","query","a|gB|gC|SN|gD|dE|gE|gF|gG|K|bL|e3","BlobMeta","a|gI","_bitfield","_updated","a|gK|BG|gL","bitfield","a|gN","o|f|gO","updated","a|gQ","o|f|gR","o|gM|gP|Bc|gS","chunkSize","a|n|Bv|aj|gU|gN|Ba|gQ","Hash of blob content.","o|o|67|q|gW","o|o|CA|v|","Length of blob in bytes.","o|o|1z|14|gZ","Size of chunk in bytes. Must be a power of 2. Default is 4096.","o|o|1z|2S|gb","o|t|67|4J|z|","o|t|4G|4O|z|","o|gV|gX|gY|ga|gc|gd|JP|ge","a|CA","PARTIALLY_PRESENT","FULLY_PRESENT","a|gh|gi","o|gj|1R|q","o|gj||","o|1N|gk||gl","o|gg|gm","o|b|gT|gf|gn|","o|gJ|go","o|1|gp","CredentialsMessage","DataMessage","FeedMessage","a|gr|gs|gt","o|o|KS|q|","o|XL|gv","A container for dxos.credentials.Message","o|18|gw|gx","batch","a|gz","dxos.echo.object.EchoObjectBatch","o|o|h1|v|","o|h0|h2","A container ECHO database messages in data feeds.","o|18|h3|h4","a|e3|ac","o|o|5a|q|","Payload","o|o|h8|v|","o|h6|h7|h9","a|h8","a|XK|bd","o|5J|hC|","o|ad|hD","o|o|gr|CL|","o|o|gs|CO|","o|hC|hF|hG","o|1s|hE|hH|","o|hB|hI","Outer message type decoded by Codec.\\nThis is what is written to the feeds.","o|En|hA|hJ|hK","o|gu|gy|h5|hL","o|1|hM","QueryOptions","a|HS|hO","_properties","_text","_not","a|hQ|N6|hR|hS|HL","properties","a|hU","o|f|hV","text","a|hX","o|f|hY","not","a|ha","o|f|hb","o|hT|hW|NG|hZ|hc|HO","and","or","a|hU|M|hX|ha|he|hf|s","o|t|Al|q|z|","dxos.echo.model.document.Reference","o|t|hi|v|z|","o|12|13|HS|4J|","o|12|13|HS|4M|","o|t|hO|4O|z|","o|hg|hh|hj|4g|H3|hk|hl|hm","Protocol for ephemeral Filter serialization.","o|1s|hd|hn|ho","_deleted","_dataLocation","a|hq|hr","deleted","a|ht","o|f|hu","dataLocation","a|hw","o|f|hx","o|hs|hv|hy","models","a|ht|i0|I4|hw","ShowDeletedOption","Controls how deleted items are filtered.","o|t|i2|q|z|i3","Filter by model.\\n@default * Only DocumentModel.\\nTo querty all models, use \`models: [\\"*\\"]\`.","o|12|13|1D|v|i5","Query only in specific spaces.","o|12|13|4I|14|i7","DataLocation","Query only local spaces, or remote on agent.\\n@default \`QueryOptions.DataLocation.LOCAL\`","o|t|i9|2S|z|iA","o|i1|i4|i6|i8|iB","a|i9|i2","ALL","LOCAL","REMOTE","a|iE|iF|iG","o|iH|1R|q|v","o|iH|||","o|1N|iI||iJ","HIDE_DELETED","SHOW_DELETED","SHOW_DELETED_ONLY","a|iL|iM|iN","o|iO|1R|q|v","Do not return deleted items. Default behaviour.","Return deleted and regular items.","Return only deleted items.","o|iO|iQ|iR|iS","o|1N|iP||iT","o|iD|iK|iU","o|b|hz|iC|iV|","o|hP|hp|iW","o|1|iX","IndexConfig","IndexKind","a|iZ|ia","a|PP","o|ic|PT","indexes","a|ie|PR","o|12|13|ia|q|","Is indexing enabled (FEATURE FLAG).\\nIf not set, the default is false.\\nTODO(mykola): Delete once we promote it as a production feature.","o|t|97|v|z|ih","o|if|ig|ii","o|1s|id|ij|","_field","a|il","field","a|in","o|f|io","o|im|ip","a|5H|in","o|o|C2|q|","o|ir|is|32","a|C2","SCHEMA_MATCH","FIELD_MATCH","FULL_TEXT","a|iv|iw|ix","o|iy|1R|q|v","o|iy|||","o|1N|iz||j0","o|iu|j1","o|b|iq|it|j2|","o|ib|ik|j3","o|1|j4","ControlPipelineSnapshot","EchoMetadata","IdentityRecord","LargeSpaceMetadata","SmallSpaceMetadata","SpaceCache","SpaceMetadata","a|j6|j7|j8|j9|jA|jB|jC","a|e3|cG","timeframe.TimeframeVector","Timeframe of the last message included in the snapshot.","o|o|jF|q|jG","ControlMessage","o|12|13|jI|v|","o|jE|jH|jJ","a|jI","a|cP|XK","o|o|KS|v|","o|jM|8Q|jN","o|18|jO|","o|jL|jP","o|En|jK|jQ|","a|Mr|Ba|gQ|Gk|I4|Dn","Version number that is inceremnted every time there's a breaking change to the storage schema.\\nThis is used to detect if the storage schema has changed since the last time the client was run.\\nLoading data from a different version will might result in an error.","o|o|1z|q|jT","o|o|4G|v|","o|t|j8|CL|z|","List of the data spaces.","o|12|13|jC|CO|jX","o|12|13|6R|CR|","o|jS|jU|jV|br|jW|jY|jZ","Main metadata record.","o|1s|Gn|ja|jb","_profileSpace","a|jd|9k","profileSpace","a|jf","o|f|jg","o|je|jh|9m","haloSpace","a|Ar|9y|jj|jf|8j","o|o|jC|14|","TODO(burdon): Not yet implemented. Must be null.","o|t|jC|2S|z|jm","ProfileDocument","Cached profile.","o|t|jo|4J|z|jp","o|jk|8Q|MF|jl|jn|jq","Information needed to bootstrap an Identity.","o|1s|ji|jr|js","_controlPipelineSnapshot","a|ju","controlPipelineSnapshot","a|jw","o|f|jx","o|jv|jy","o|t|j6|q|z|","o|jx|k0","Per-space metadata. Infrequent updates.","o|1s|jz|k1|k2","Per-space metadata. Frequent updates. Keep small.","o|18|ZZ|k4","a|hQ","o|k6|hW","dxos.echo.model.document.ObjectSnapshot","Properties snapshot.","o|t|k8|q|z|k9","o|hV|kA","o|1s|k7|kB|","_genesisFeedKey","_controlTimeframe","_dataTimeframe","a|MJ|kD|JS|JT|kE|kF|IT","genesisFeedKey","a|kH","o|f|kI","controlTimeframe","a|kK","o|f|kL","dataTimeframe","a|kN","o|f|kO","o|kG|MM|kJ|Ji|Jl|kM|kP|Id","a|Ex|Bv|kH|Jg|cn|Jj|kK|kN|Ib","Space key.","o|o|4I|q|kS","ACTIVE, INACTIVE, etc.","o|t|7w|CL|z|kU","o|t|4I|4M|z|","Key of the wriatable control feed.","o|t|4I|2S|z|kX","List of all feed associated with the space.","o|12|13|4I|v|kZ","Key of the wriatable data feed.","o|t|4I|14|z|kb","o|t|jF|CF|z|","o|t|jF|4J|z|","o|t|jB|CI|z|","o|kR|kT|kV|kW|kY|ka|kc|kd|ke|kf","o|1s|kQ|kg|","o|jD|jR|jc|jt|k3|k5|kC|kh","o|1|ki","document","messenger","a|kk|kl|hX","Array","KeyValue","KeyValueObject","ObjectMutation","ObjectMutationSet","ObjectSnapshot","Predicate","Query","Reference","Value","YJS","a|kn|ko|kp|kq|kr|ks|kt|ku|kv|kw|kx","a|1L","o|12|13|kw|q|","o|kz|l0","Ordered collection of values.","o|18|l1|l2","a|Ex|N","o|o|kw|v|","o|l4|1j|l5","Key x Value tuple.","o|18|l6|l7","o|12|13|ko|q|","o|hV|l9","Object data definition.","o|18|lA|lB","_mutation","a|Eu|lD","mutation","a|lF","o|f|lG","o|lE|F1|lH","operation","a|lJ|Ex|N|lF","Operation","o|o|lL|q|","o|t|kw|14|z|","o|t|kx|2S|z|","o|lK|lM|2i|lN|lO","a|lL","SET","DELETE","ARRAY_PUSH","SET_ADD","SET_DELETE","a|lR|lS|lT|lU|lV|kx","o|lW|1R|q|v|2S|4J|4M","o|lW||||||","o|1N|lX||lY","o|lQ|lZ","Atomic mutation.","o|b|lI|lP|la|lb","_typeRef","a|N6|ld","typeRef","a|lf","o|f|lg","o|le|NG|lh","mutations","metaMutations","a|M|lf|lj|lk","o|t|kv|2S|z|","o|12|13|kq|v|","o|12|13|kq|14|","o|ll|6h|lm|ln|lo","Set of mutations.","o|1s|li|lp|lq","a|N6|ld|Dt","o|ls|NG|lh|E0","root","a|M|lf|lu|Dy","o|lv|6h|lm|l5|lN","State snapshot.","o|1s|lt|lw|lx","a|Et|Eu","o|lz|Ez|F1","op","predicates","a|m1|Ex|N|m2","o|12|13|kt|2S|","o|m3|lM|32|lN|m4","OR","AND","NOT","IN","EQUALS","GTE","GT","LTE","LT","PREFIX_MATCH","TEXT_MATCH","a|m6|m7|m8|m9|mA|mB|mC|mD|mE|mF|mG","o|mH|1R|q|v|CL|CO|CR|CU|CW|CY|Io|Iq","o|mH|||||||||||","o|1N|mI||mJ","o|lQ|mK","Query predicate.","o|b|m0|m5|mL|mM","a|lu","o|o|kt|q|","o|mO|mP","Query.","o|18|mQ|mR","_protocol","_host","a|mT|mU","protocol","a|mW","o|f|mX","a|TN","o|f|mZ","o|mV|mY|ma","itemId","a|mc|mW|TN","\\"space\\", or \\"protobuf\\"","o|t|1D|v|z|me","space key, FQN of the schema","o|t|1D|14|z|mg","o|md|1j|mf|mh","Reference to an Item.","o|1s|mb|mi|mj","a|Bz","null","int","float","datetime","array","reference","a|mm|97|mn|mo|1D|Ah|mp|67|gF|mq|mr","o|5J|ms|","o|ml|mt","int64","o|o|mv|14|","o|o|mo|2S|","o|o|1D|CL|","o|o|1D|CO|","o|o|67|CR|","o|o|kp|Io|","o|o|kn|Iq|","n|U","o|o|kv|n3|","o|ms|U1|eA|mw|mx|UT|my|mz|n0|n1|n2|n4","Generic value.","o|1s|mu|n5|n6","a|n|ac","o|o|67|v|","o|n8|68|n9","o|18|nA|","o|ky|l3|l8|lC|lc|lr|ly|mN|mS|mk|n7|nB","o|1|nC","Message","a|nE","sender","a|Ah|hX|nG","o|nH|1j|2i|1I","o|18|nI|","o|nF|nJ","o|1|nK","TextKind","TextMutation","TextSnapshot","a|nM|nN|nO","PLAIN","RICH","a|nQ|nR","o|nS|1R|q","o|nS||","o|1N|nT||nU","_update","_clientId","_kind","a|nW|nX|nY|il","update","a|na","o|f|nb","clientId","a|nd","o|f|ne","o|f|5I","o|nZ|nc|nf|ng|ip","a|na|nd|5H|in","o|t|nM|14|z|","o|ni|6r|2Q|nj|Nc","o|1s|nh|nk|","a|bd|5H|in","o|o|nM|v|","o|nm|68|nn|1I","o|18|no|","o|nP|nV|nl|np","o|1|nq","o|km|nD|nL|nr","o|1|ns","EchoObject","EchoObjectBatch","MutationMeta","a|nu|nv|nw","_genesis","a|Dt|ny|bJ","genesis","a|o0","o|f|o1","o|nz|E0|o2|bN","objectId","a|o4|Dy|o0|bL|lj","Metadata for the genesis mutation.","o|t|nw|v|z|o6","Genesis","Present in mutations creating new items and snapshots.","o|t|o8|CL|z|o9","Snapshot","o|t|oB|CU|z|","Mutation","May be present in snapshots. In that case the mutations must be applied on top of the snapshot.","o|12|13|oD|CW|oE","o|o5|1j|o7|oA|oC|oF","a|o8|oD|oB","_modelVersion","a|oI","modelVersion","a|oK","o|f|oL","o|oJ|oM","modelType","a|oO|oK","o|oP|2i|4g","o|1s|oN|oQ|","_parentId","_action","_model","a|Dt|oS|oT|oU","parentId","a|oW","o|f|oX","a|Gx","o|f|oZ","a|gE","o|f|ob","o|oV|E0|oY|oa|oc","a|Dy|oW|Gx|gE","o|t|nw|q|z|","Set parent id","o|t|1D|CL|z|og","o|t|Gz|CO|z|","preserve_any","a|oj|w","o|ok|y|y","o|t|GQ|CR|ol|","o|oe|of|oh|oi|om","a|Gz","NOOP","RESTORE","a|op|lS|oq","o|or|1R|q|v","o|or|||","o|1N|os||ot","o|oo|ou","o|b|od|on|ov|","a|hq|oS|oU","o|ox|hv|oY|oc","a|ht|oW|gE","Set the model to the provided snapshot.","o|t|GQ|CL|ol|p0","o|oz|98|32|p1","o|1s|oy|p2|","o|oH|oR|ow|p3","Wrapper for all ECHO messages.","o|b|o3|oG|p4|p5","objects","a|p7","o|12|13|nu|q|","o|p8|p9","o|18|pA|","_seq","_memberKey","a|cM|pC|pD|e1","a|cf","o|f|pF","a|MC","o|f|pH","o|pE|cR|pG|pI|e5","clientTag","a|cP|cf|MC|e3|pK","o|t|4I|14|z|","o|t|jF|2S|z|","If this mutation was created by this client, this field will be set to the tag in the mutation.","o|12|13|1D|4J|pO","o|pL|KN|2Q|pM|pN|pP","o|1s|pJ|pQ|","o|nx|p6|pB|pR","o|1|pS","Heads","QueryRequest","QueryResponse","QueryResult","QueryService","a|pU|pV|pW|pX|pY","hashes","a|pa","o|12|13|1D|q|","o|pb|pc","Automerge heads.\\nUsed for encoding in Index metadata store.\\n@see https://automerge.org/automerge-repo/types/_automerge_automerge_repo.Heads.html","o|18|pd|pe","_queryId","a|pg","queryId","a|pi","o|f|pj","o|ph|pk","a|pi|SN","dxos.echo.filter.Filter","o|o|pn|v|","o|pm|6h|po","o|1s|pl|pp|","results","a|pi|pr|p7","o|12|13|pX|v|","dxos.echo.object.EchoObject","o|12|13|pu|14|","o|ps|6h|pt|pv","o|1s|pl|pw|","rank","a|n|3y|py","o|o|mo|14|","o|pz|1j|MF|q0","o|18|q1|","SetConfig","ExecQuery","Reindex","a|q3|q4|q5","dxos.echo.indexing.IndexConfig","o|2p|q7|1e|","o|1d|pV|pW|y|","o|q6|q8|q9|5D","o|1Y|qA|","o|pZ|pf|pq|px|q2|qB","o|1|qC","DataService","EchoEvent","FlushRequest","HostInfo","MutationReceipt","SubscribeRequest","SyncRepoRequest","SyncRepoResponse","WriteRequest","a|qE|qF|qG|qH|qI|qJ|qK|qL|qM","Subscribe","Write","Flush","GetHostInfo","SyncRepo","SendSyncMessage","a|qO|qP|qQ|qR|qS|qT","o|1d|qJ|qF|y|","o|2p|qM|qI|","o|2p|qG|1e|","o|2p|1e|qH|","o|1d|qK|qL|y|","o|2p|qK|1e|","o|qU|qV|qW|qX|qY|qZ|qa","o|1Y|qb|","_clientTag","a|qd|cM|pC|oT","a|pK","o|f|qf","o|qe|qg|cR|pG|oa","a|pK|cP|cf|Gx|gz","If this event comes as a response to this client wirting the mutation, this field will be set to the tag in the mutation.","o|t|1D|q|z|qj","For mutations read from the feed store those fields will be set to the position of the mutation in the feed.","o|t|4I|v|z|ql","DatabaseAction","o|t|qn|2S|z|","o|o|h1|CL|","o|qi|qk|qm|2R|qo|qp","a|qn","RESET","a|qs","o|qt|1R","o|qt|","o|1N|qu||qv","o|qr|qw","o|b|qh|qq|qx|","states","a|3y|qz","DocState","Automerge specific document ids to wait to flush.","o|12|13|r1|v|r2","o|r0|KN|r3","a|r1","documentId","heads","a|r6|r7","o|r8|1j|Up","o|18|r9|","o|r5|rA","o|b|cD|r4|rB|","peerId","a|rD","o|rE|1j","o|18|rF|","a|cP|cf","o|rH|8Q|ER","o|18|rI|","_syncMessage","a|rK","syncMessage","a|rM","o|f|rN","o|rL|rO","a|n|rM","o|rQ|1j|6i","o|1s|rP|rR|","o|rN|6r","o|1s|rP|rT|","a|qd","o|rV|qg","a|3y|pK|gz","Ephermal tag to correlate events in the subscription.","o|t|1D|v|z|rY","o|rX|8Q|rZ|qp","o|1s|rW|ra|","o|qN|qc|qy|rC|rG|rJ|bI|rS|rU|rb","o|1|rc","EchoSnapshot","SpaceSnapshot","a|re|rf","items","a|rh","object.EchoObject","o|12|13|rj|q|","o|ri|rk","Database Snapshot","o|18|rl|rm","a|e1|Q5","o|ro|e5|QA","database","a|3y|e3|Ah|rq","o|t|jF|v|z|","o|o|re|CO|","o|rr|68|rs|2R|rt","Snapshots define full space state at a given point in time.\\nThey must have enough information to be able to recover the space state without reading the feed messages.\\n\\nEach snapshot is identified by a space key and a timeframe.\\nThe timeframe defines the set of feed messages that have already been processed.\\nWhen loading from the snapshot, application would skip all of the feed messages up to (and including) the provided timeframe.","o|1s|rp|ru|rv","o|rg|rn|rw","o|1|rx","github.com/dxos/kube/proto/def/dxos/echo/timeframe","o|Me|rz","TimeframeVector","a|s1","frames","a|s3","Frame","o|12|13|s5|q|","o|s4|s6","a|s5","o|rH|68|d0","o|18|s9|","o|s8|sA","Vector timestamp used to order messages.","o|En|s7|sB|sC","o|s2|sD","o|Mc|s0|sE","o|gH|gq|hN|iY|j5|kj|nt|pT|qD|rd|ry|sF","o|1|sG","github.com/dxos/kube/proto/def/dxos/error","o|Me|sI","Error","a|sK","_message","_stack","a|N5|sM|Ds|sN","a|E3","o|f|sP","stack","a|sR","o|f|sS","o|sO|NE|sQ|Dx|sT","a|5K|E3|Dv|sR","Also error code. Will be used to reconstruct a known error type.","o|t|1D|q|z|sW","o|t|Al|2S|z|","o|sV|sX|32|sY|4g","Serialized error.","o|1s|sU|sZ|sa","o|sL|sb","o|Mc|sJ|sc","AcceptSpaceInvitationCommand","AgentSpec","CommandSequence","CreateProfileCommand","CreateSpaceCommand","CreateSpaceInvitationCommand","SyncClient","SyncServer","TearDown","a|se|sf|5g|sg|sh|si|sj|sk|sl|sm","a|Bu","o|so|1j","o|18|sp|","_stateMachine","_startSequence","_stopSequence","a|Mp|sr|ss|st","stateMachine","a|sv","o|f|sw","startSequence","a|sy","o|f|sz","stopSequence","a|t1","o|f|t2","o|su|Mt|sx|t0|t3","testSequences","a|Mr|sv|sy|t1|t5","o|t|sg|14|z|","o|t|sg|2S|z|","o|12|13|sg|4J|","o|t6|20|32|t7|t8|t9","Root specification for Agent.","o|1s|t4|tA|tB","Cmd","a|tD","createProfile","createSpace","createSpaceInvitation","acceptSpaceInvitation","syncServer","syncClient","tearDown","a|tF|tG|tH|tI|tJ|tK|tL","o|5J|tM|","o|tE|tN","o|o|sh|q|","o|o|si|v|","o|o|sj|14|","o|o|se|2S|","o|o|sl|4J|","o|o|sk|4M|","o|o|sm|4O|","o|tM|tP|tQ|tR|tS|tT|tU|tV","Atomic async command.","o|1s|tO|tW|tX","commands","a|tZ","o|12|13|5g|q|","o|ta|tb","Commands that must be run sequentially.","o|18|tc|td","__noop_","a|tf","_noop_","a|th","o|f|ti","o|tg|tj","o|ti|98","o|1s|tk|tl|","a|6D","o|tn|6L","o|6K|6h","o|1s|to|tp|","a|n|Bu","o|tr|1j|2i","o|18|ts|","srvId","verbose","a|n|tu|TN|1v|tv","o|o|97|4J|","o|tw|1j|2i|1I|c5|tx","o|18|ty|","a|n|TN|1v|tv","o|u0|1j|2i|c4|g3","o|18|u1|","o|sn|sq|tC|tY|te|tm|tq|tt|tz|u2|tm","o|1|u3","keyring","signed","a|MT|Dn|u5|G|u6","github.com/dxos/kube/proto/def/dxos/halo/credentials","o|Me|u8","AdmittedFeed","auth","Auth","AuthorizedDevice","Chain","Claim","Credential","DeviceProfile","DeviceProfileDocument","DeviceType","Epoch","greet","HaloSpace","IdentityProfile","IdentityRecovery","KeyInfo","KubeAccess","MemberProfile","Presentation","Proof","ServiceAccess","SpaceGenesis","a|uA|uB|uC|uD|uE|uF|uG|uH|uI|uJ|uK|uL|uM|Gk|uN|uO|uP|uQ|uR|uS|jo|uT|uU|uV|7u","designation","a|3y|Ar|9y|uX","Owning identity.","o|o|4I|v|uZ","Owning device.","o|o|4I|14|ub","Designation","Feeds with different designations are consumed by separate pipelines.","o|o|ud|2S|ue","o|uY|8Q|ua|uc|uf","a|ud","GENERAL","CONTROL","DATA","a|ui|uj|uk","o|ul|1R|q|v","Classic general purpose feeds for both HALO and ECHO messages together. To be deprecated.","Contain system-level messages messages, such as credentials and epochs.","Database mutations.","o|ul|un|uo|up","o|1N|um||uq","o|uh|ur","o|En|ug|us|","a|uC","_feedAdmit","a|cM|uv","feedAdmit","a|ux","o|f|uy","o|uw|cR|uz","a|3y|9y|Ar|cP|ux","The publicKey of the target Space for these credentials.","o|o|4I|q|v2","The publicKey of the authenticating Device.","o|o|4I|v|v4","The publicKey of the authenticating Identity.","o|o|4I|14|v6","o|t|4I|2S|z|v6","FeedAdmit message to the should be written to a control feed in case the \`feed_key\` is not admitted to the space.","o|t|GQ|4J|z|v9","o|v1|v3|v5|v7|v8|vA","The payload for a SignedMessage sent during handshake for replication authentication.","o|1s|v0|vB|vC","o|uu|vD","o|1|vE","Assertion for agents authenticating in the space swarm.","o|18|ZZ|vG","a|Ar|9y","o|vI|8Q|MF","o|18|vJ|","Credential that authorizes the subject to issue new credentials (can be recursive).","o|o|uG|q|vL","o|XL|vM","A chain of credentials that establishes the delegated authority to issue new credentials.\\nEach key in the chain has an assotiated credential that establishes the authrity of that specific key.\\n\\nExample:\\nAlice/Device-2 => Alice/Device-1 => Alice\\n\\nThis chain would include 2 credentials:\\n1. Giving Alice/Device-2 the authority to issue credentials on behalf of Alice, signed by Alice/Device-1.\\n2. Giving Alice/Device-1 the authority to issue credentials on behalf of Alice, signed by Alice.","o|18|vN|vO","assertion","a|n|vQ","o|o|GQ|v|","o|vR|8Q|vS","o|18|vT|","_expirationDate","_expirationRef","_proof","a|6D|vV|vW|vX","expirationDate","a|vZ","o|f|va","expirationRef","a|vc","o|f|vd","proof","a|vf","o|f|vg","o|vY|6L|vb|ve|vh","issuer","issuanceDate","subject","parentCredentialIds","a|n|vj|vk|vZ|vc|vl|vf|vm","o|o|uF|CL|","o|t|uT|CO|z|","o|12|13|4I|CR|","o|vn|KN|MF|br|4H|gd|vo|vp|vq","o|1s|vi|vr|","o|o|uI|q|","o|8k|vt","[ASSERTION]: Sets device profile information.","o|18|vu|vv","_platformVersion","_architecture","_os","_osVersion","a|dQ|Fg|vx|vy|vz|w0|N6","platformVersion","a|w2","o|f|w3","architecture","a|w5","o|f|w6","os","a|w8","o|f|w9","osVersion","a|wB","o|f|wC","o|w1|dU|Fp|w4|w7|wA|wD|NG","a|dS|Fn|w2|w5|w8|wB|M","o|t|uJ|4O|z|","o|wF|6h|32|4g|Nc|Wu|Qw|wG","o|1s|wE|wH|","UNKNOWN","NATIVE","AGENT","AGENT_MANAGED","MOBILE","a|wJ|GF|wK|wL|wM|wN","o|wO|1R|q|v|14|2S|4J","o|wO||||||","o|1N|wP||wQ","_previousId","_snapshotCid","_automergeRoot","a|wS|wT|wU","previousId","a|wW","o|f|wX","snapshotCid","a|wZ","o|f|wa","automergeRoot","a|wc","o|f|wd","o|wV|wY|wb|we","number","a|wg|wW|e3|wZ|wc","Epoch number.","o|o|G8|q|wi","Id of the previous epoch. Identified by the credential id.","o|t|4I|v|z|wk","Epoch start timeframe. Indexes correspond to last mutations included into the snapshot.","o|o|5a|CL|wm","Epoch start snapshot.","o|t|1D|CO|z|wo","URL of the automerge document representing the space root.","o|t|1D|CR|z|wq","o|wh|wj|wl|wn|wp|wr","o|1s|wf|ws|","BeginResponse","ClaimResponse","HandshakeResponse","KeyHint","NotarizeResponse","a|wu|wv|5g|ww|wx|wy","info","a|x0","keyType","a|x2|M|n|a","o|x3|1D|GQ|q|","o|x1|x4","o|18|x5|","rendezvousKey","a|n|x7","o|x8|68|n9","o|18|x9|","_secret","a|xB","secret","a|xD","o|f|xE","o|xC|xF","params","a|6c|xD|xH","o|o|Bz|q|","o|12|13|GQ|CL|","o|xI|xJ|6i|xK","BEGIN","HANDSHAKE","NOTARIZE","FINISH","CLAIM","a|xM|xN|xO|xP|xQ","o|xR|1R|q|v|14|CL","o|xR|||||","o|1N|xS||xT","o|ml|xU","A Greeter command.","o|b|xG|xL|xV|xW","a|II|3y","o|xY|68|MF","o|18|xZ|","a|8O|M","keys.KeyType","o|o|xc|v|","o|xb|8Q|xd","o|18|xe|","copies","a|xg|e8","o|12|13|GQ|q|","o|xh|xi|fN","o|18|xj|","o|wz|x6|xA|xX|xa|xf|xk","o|1|xl","haloKey","a|Ar|xn","o|o|4I|v|kS","o|xo|8Q|xp","[ASSERTION]: Associates a space that will implement Agent's HALO with an Identity.","o|18|xq|xr","DeviceInfo","IdentityInfo","a|xt|xu","a|8O|NH","o|xw|8Q|2i","o|18|xx|","o|xv|xy|xy","o|1|xz","o|o|jo|q|","o|8k|y1","[ASSERTION]: Sets profile information.","o|18|y2|y3","a|Ar|IC","Public key derived from the recovery seedphrase.","o|o|4I|v|y6","o|y5|8Q|y7","[ASSERTION]: Grants recovery permissions to a recovery key.","o|18|y8|y9","a|N5","o|yB|NE","o|ND|6h","Subject must be a key being referenced.","o|1s|yC|yD|yE","kubeKey","capabilities","a|yG|Ar|yH","o|yI|8Q|MF|Ub","o|18|yJ|","o|t|jo|14|z|","o|8k|yL","o|1s|9x|yM|","proofs","a|MT|yO","o|12|13|uG|q|","o|12|13|uT|v|","o|yP|yQ|yR","o|18|yS|","_avatarCid","_data","a|N7|yU|yV","avatarCid","a|yX","o|f|yY","o|f|d7","o|yW|NJ|yZ|ya","a|NH|yX|bd","Custom user data.","o|t|Al|CL|z|yd","o|yc|6h|32|ye","o|1s|yb|yf|","_chain","a|IG|yh","chain","a|yj","o|f|yk","o|yi|IK|yl","creationDate","signer","a|M|yn|yo|II|N|yj","Signature (excluded from signed data).","o|o|67|4J|yq","Must be present if signer is not credential issuer.\\nEstablishes the authority of the signer. Proves that the signer can issue such credentials.\\nExcluded from signed data.","o|t|uE|4M|z|ys","o|yp|1j|jV|fN|bs|yr|yt","o|1s|ym|yu|","_serverMetadata","a|yw","serverMetadata","a|yy","o|f|yz","o|yx|z0","serverName","serverKey","a|z2|yy|z3|Ar|yH","o|t|Al|v|z|","o|z4|1j|z5|fN|eC|Nd","o|1s|z1|z6|","_invitationCredentialId","a|9k|z8","invitationCredentialId","a|zA","o|f|zB","o|z9|9m|zC","a|3y|Bp|8j|kH|zA","Role","o|o|zF|v|","Needed so that the admitted member can start replicating the space based on this credential alone.","o|o|4I|2S|zH","Present to associate SpaceMember admissions with delegated invitations.","o|t|4I|4J|z|zJ","o|zE|8Q|zG|yL|zI|zK","a|zF","INVALID","ADMIN","EDITOR","READER","OWNER","a|zN|zO|zP|zQ|zR|A6","o|zS|1R|q|v|14|2S|4J","Manage members.","Read and write.","Read-only.","Admin that can't be removed.","Revoked membership.","o|zS||zU|zV|zW|zX|zY","o|1N|zT||zZ","o|zM|za","o|b|zD|zL|zb|","o|uW|ut|vF|vH|vK|vP|vU|vs|vw|wI|wR|wt|xm|xs|y0|y4|yA|yF|yK|yN|yT|yg|yv|z7|bI|zc","o|Mc|u9|zd","AdmissionRequest","AdmissionResponse","AuthenticationResponse","CancelDelegatedInvitation","DelegateSpaceInvitation","DeviceAdmissionCredentials","DeviceAdmissionRequest","IntroductionRequest","IntroductionResponse","InvitationHostService","Options","SpaceAdmissionCredentials","SpaceAdmissionRequest","a|zf|zg|7F|zh|zi|zj|zk|zl|zm|zn|zo|zp|zq|zr","device","space","a|zt|zu","o|5J|zv|","o|5I|zw","o|o|zl|q|","o|o|zr|v|","o|zv|zy|zz","o|1s|zx|100|","o|o|zk|q|","o|o|zq|v|","o|zv|102|103","o|1s|zx|104|","_signedChallenge","a|BD|106","signedChallenge","a|108","o|f|109","o|107|BT|10A","a|8W|108","Present when auth_method is SHARED_SECRET.","o|t|1D|q|z|10D","Present when auth_method is KNOWN_PUBLIC_KEY.","o|t|67|v|z|10F","o|10C|10E|10G","o|1s|10B|10H|","a|3c","o|10J|3l","o|t|p|q|z|","o|1Z|10L","a|p","OK","INVALID_OTP","INVALID_OPT_ATTEMPTS","INTERNAL_ERROR","INVALID_SIGNATURE","a|10O|10P|10Q|10R|10S","o|10T|1R|q|v|14|2S","o|10T|||||","o|1N|10U||10V","o|10N|10W","o|b|10K|10M|10X|","credentialId","a|10Z","o|10a|8Q","o|18|10b|","_guestKey","_expiresOn","a|10d|10e","guestKey","a|10g","o|f|10h","expiresOn","a|10j","o|f|10k","o|10f|10i|10l","a|8V|Bt|Bu|Bp|10g|10j|Bg","dxos.client.services.Invitation.AuthMethod","o|o|10o|v|","Present for AuthMethod.KNOWN_PUBLIC_KEY, where guess needs to prove possession of a corresponding private key","o|t|4I|4J|z|10q","o|o|97|4O|","o|10n|1j|10p|fN|Kw|10r|JP|10s","o|1s|10m|10t|","a|kE","o|10v|kM","haloSpaceKey","a|Ar|10x|kH|kK","o|t|5a|2S|z|","o|10y|8Q|MF|fN|10z","o|1s|10w|110|","a|9y|Jg|Jj|8j","o|t|8E|2S|z|","o|112|8Q|MF|fN|113","o|1s|9x|114|","_invitationId","a|9k|116","o|f|8a","o|117|9m|118","a|8j|8V","Guest's profile.","o|t|8l|q|z|11B","o|11A|11C|32","o|1s|119|11D|","_challenge","a|11F|3h","challenge","a|11H","o|f|11I","o|11G|11J|40","a|Bt|11H|3y","o|o|10o|q|","Only present for testing invitation types.","o|t|4I|Kf|z|11N","o|11L|11M|10G|11O","o|1s|11K|11P|","Introduce","Admit","a|zp|11R|Dc|11S","Both peers must call this method before any other.","o|2p|zp|1e|11U","Introduce guest to the host. Only on the host.","o|2p|zm|zn|11W","Authenticate request. Only on the host.","o|2p|7F|zh|11Y","Process admission credentials. Only on the host.","o|2p|zf|zg|11a","o|11T|11V|11X|11Z|11b","o|1Y|11c|","Role of the peer.","o|o|zF|q|11e","o|Bq|11f","GUEST","HOST","a|11h|11i","o|11j|1R|q","o|11j||","o|1N|11k||11l","o|zM|11m","o|En|11g|11n|","a|kE|kF","o|11p|kM|kP","a|XK|kK|kN","Credential of type \`SpaceMember\` that grants Guest's identity access to the space.","o|o|KS|q|11s","Hint to the guest about the current control timeframe.","o|t|5a|v|z|11u","Hint to the guest about the current data timeframe.","o|t|5a|14|z|11w","o|11r|11t|11v|11x","o|1s|11q|11y|","a|Ar|9y|Jg|Jj","o|120|8Q|MF|fN|eC","o|18|121|","o|zs|101|105|10I|10Y|10c|10u|111|115|11E|11Q|11d|11o|11z|122","o|1|123","KeyRecord","a|125","o|8P|68|6i","o|1s|8N|127|","o|126|128","o|1|129","KeyChain","KeyRecordList","KeyType","a|12B|125|12C|12D","parents","a|8O|E3|12F","o|o|cI|v|","o|12|13|12B|14|","o|12G|8Q|12H|12I","o|18|12J|","_secretKey","_hint","_own","_trusted","_added","a|12L|12M|12N|12O|12P|BG","secretKey","a|12R","o|f|12S","hint","a|12U","o|f|12V","own","a|12X","o|f|12Y","trusted","a|12a","o|f|12b","added","a|12d","o|f|12e","o|12Q|12T|12W|12Z|12c|12f|Bc","a|M|8O|12R|12U|12X|12a|12d|Ba","The \`KeyType\` type of the key. This is often unknown for keys from other sources.","o|o|12D|q|12i","The public key as a Buffer (required).","o|o|4I|v|12k","The secret key as a Buffer (this will never be visible outside the Keyring).","o|t|8R|14|z|12m","Is this key from a Greeting \\"hint\\"?","o|t|97|2S|z|12o","Determines if this is our key?\\nUsually true if \`secret_key\` is present; may be false for \\"inception keys\\" such as the Space key.","o|t|97|4J|z|12q","Is this key to be trusted?","o|t|97|4M|z|12s","An RFC-3339 date/time string for when the key was added to the Keyring.","o|t|1D|4O|z|12u","An RFC-3339 date/time string for when the key was created.","o|t|1D|CF|z|12w","o|12h|12j|12l|12n|12p|12r|12t|12v|12x","o|1s|12g|12y|","o|12|13|125|q|","o|AS|130","o|18|131|","IDENTITY","FEED","DXNS_ADDRESS","a|wJ|133|Cw|Cx|134|135","o|136|1R|q|v|14|2S|4J","o|136||||||","o|1N|137||138","o|12E|12K|12z|132|139","o|1|13A","SignedMessage","a|nE|13C","o|o|GQ|q|","o|ad|13E","o|18|13F|","signatures","a|u6|13H","Signed","The signed message contents.","o|o|13J|q|13K","Signature","An array of Signatures, one for each key that signed the message.","o|12|13|13M|v|13N","o|13I|13L|13O","a|13M|13J","_keyChain","a|13R","keyChain","a|13T","o|f|13U","o|13S|13V","signature","a|Ex|13X|13T","The publicKey of the keypair that made this signature.","o|o|4I|q|13Z","The bytes of the signature.","o|o|67|v|13b","keys.KeyChain","The certification chain of SignedMessages for this key.","o|t|13d|14|z|13e","o|13Y|13a|13c|13f","o|1s|13W|13g|","a|Ba|II|ac","o|o|1D|q|QJ","The payload to be signed.","o|o|GQ|CL|13k","o|13i|13j|n9|13l","o|18|13m|","o|13Q|13h|13n","A generic container message used whenever messages are signed (e.g. SpaceCredential)","o|En|13P|13o|13p","o|13D|13G|13q","o|1|13r","o|u7|ze|124|12A|13B|13s","o|1|13t","AppContextRequest","AppService","InvitationUrlRequest","LayoutRequest","ShellDisplay","ShellLayout","ShellService","WorkerService","a|13v|13w|13x|13y|13z|140|141|3a|142","_display","_reload","a|144|3h|BE|145","display","a|147","o|f|148","reload","a|14A","o|f|14B","o|146|149|40|BW|14C","a|147|3y|BU|14A","The display mode that shell should use.","o|t|13z|q|z|14F","The key of the joined space.","o|t|4I|v|z|14H","Target to redirect to after a successful invitation.","o|t|1D|14|z|14J","Used after sign out/identity reset.","o|t|97|2S|z|14L","o|14E|14G|14I|14K|14M","o|1s|14D|14N|","SetContext","a|14P","o|2p|13v|1e|","o|14Q|14R","App RPCs for the shell.","o|1Y|14S|14T","invitationUrl","deviceInvitationParam","spaceInvitationParam","a|14V|14W|14X","Base URL for invitations.","o|o|1D|q|14Z","Query parameter for device invitations.","o|o|1D|v|14b","Query parameter for space invitations.","o|o|1D|14|14d","o|14Y|14a|14c|14e","o|18|14f|","_invitationCode","a|14h|3h|BE","invitationCode","a|14j","o|f|14k","o|14i|14l|40|BW","layout","a|14n|14j|3y|BU","Determins which panel of the shell is opened.","o|o|140|q|14p","Invitation code to join a space.","o|t|1D|v|z|14r","Key of the space to share.","o|t|4I|14|z|14t","Target to include in an invitation for redirecting after a successful invitation.","o|t|1D|2S|z|14v","o|14o|14q|14s|14u|14w","o|1s|14m|14x|","FULLSCREEN","a|9V|14z","o|150|1R|q","o|150||","o|1N|151||152","DEFAULT","INITIALIZE_IDENTITY","INITIALIZE_IDENTITY_FROM_INVITATION","SHARE_IDENTITY","EDIT_PROFILE","JOIN_SPACE","STATUS","a|154|155|156|133|157|158|Cx|159|15A","o|15B|1R|q|v|14|2S|4J|4M|4O|CF","o|15B|||||||||","o|1N|15C||15D","SetLayout","SetInvitationUrl","a|15F|15G","o|2p|13y|1e|","o|2p|13x|1e|","o|15H|15I|15J","Shell UI RPCs.","o|1Y|15K|15L","_lockKey","_observabilityGroup","_signalTelemetryEnabled","a|15N|15O|15P","lockKey","a|15R","o|f|15S","observabilityGroup","a|15U","o|f|15V","signalTelemetryEnabled","a|15X","o|f|15Y","o|15Q|15T|15W|15Z","origin","a|15b|15R|15U|15X","Key for the iframe resource lock used to determine when the service is closing.","o|t|1D|v|z|15d","o|15c|1j|15e|4g|H3","o|1s|15a|15f|","a|50|51","o|2p|3a|1e|","o|15h|15i|5D","Iframe-to-worker RPCs.","o|1Y|15j|15k","o|143|14O|14U|14g|14y|153|15E|15M|15g|15l","o|1|15m","github.com/dxos/kube/proto/def/dxos/keys","o|Me|15o","PrivateKey","PublicKey","a|15q|15r","o|d7|68","o|18|15t|","o|15s|15u|15u","o|Mc|15p|15v","bridge","broadcast","messaging","muxer","replicator","teleport","a|15x|15y|15z|160|9z|mW|161|Qh|FM|162","BridgeEvent","BridgeService","CloseRequest","ConnectionRequest","DataRequest","DetailsRequest","DetailsResponse","SignalRequest","StatsRequest","StatsResponse","a|164|165|166|167|7H|168|169|16A|16B|16C|16D","connection","a|16F|Qh|bd","o|5J|16G|","o|NF|16H","o|o|eO|q|","SignalEvent","o|o|16K|v|","DataEvent","o|o|16M|14|","o|16G|16J|16L|16N","a|eO|16M|16K","a|Bv|C","o|16Q|FQ|32","o|1s|di|16R|","o|ad|68","o|18|16T|","dxos.mesh.swarm.Signal","o|o|16V|q|","o|ad|16W","o|18|16X|","o|16P|16S|16U|16Y","o|b|16I|16O|16Z|","Open","SendSignal","SendData","Close","GetDetails","GetStats","a|16b|16c|16d|16e|16f|16g","","o|1d|167|164|y|16i","o|2p|16B|1e|16i","o|2p|168|1e|16i","o|2p|166|1e|16i","o|2p|169|16A|16i","o|2p|16C|16D|16i","o|16h|16j|16k|16l|16m|16n|16o","o|1Y|16p|","proxyId","a|16r","o|16s|8Q","o|18|16t|","initiator","a|16r|16v","o|16w|8Q|eA","o|18|16x|","a|zN|D3|D4|LS","o|16z|1R|q|v|14","o|16z||||","o|1N|170||171","a|16r|ac","o|173|8Q|n9","o|18|174|","details","a|176","o|177|1j","o|18|178|","a|16r|Qh","o|o|16V|v|","o|17A|8Q|17B","o|18|17C|","o|o|Al|q|","o|F3|17E","o|18|17F|","o|16E|16a|16q|16u|16y|172|175|16u|179|17D|16u|17G","o|1|17H","Packet","a|17J","_from","a|17L","from","a|17N","o|f|17O","o|17M|17P","a|cf|15b|17N|bd","o|t|67|14|z|","o|o|67|2S|","o|17R|68|n9|17S|17T","o|1s|17Q|17U|","o|17K|17V","o|1|17W","Acknowledgement","ReliablePayload","a|17Y|17Z","messageId","a|17b","MessageId of the Message that is being acknowledged.","o|o|4I|q|17d","o|17c|17e","o|18|17f|","a|17b|ac","Unique message identifier. Used for Acknolegment.","o|o|4I|q|17i","Payload for signal server netwrok.","o|o|GQ|v|17k","o|17h|17j|17l","o|18|17m|","o|17a|17g|17n","o|1|17o","Data","Destroy","OpenChannel","a|16e|5g|17q|17r|17s","Error that caused the termination.","o|t|1D|q|z|17u","o|4c|17v","o|1s|di|17w|","openChannel","destroy","close","a|17y|bd|17z|180","o|5J|181|","o|ad|182","o|o|17s|q|","o|o|17q|v|","o|o|17r|14|","o|o|16e|2S|","o|181|184|185|186|187","Root type for messages sent over the stream.","o|1s|183|188|189","channelId","a|18B|bd","Identifier for the channel as assigned by the remote peer.\\nNOTE: An OpenChannel message must received before any data is sent on a channel.\\nAny data messages sent before that, should be ignored.","o|o|1z|q|18D","o|18C|18E|n9","o|18|18F|","Terminate the connection. The other peer can expect the connection to be closed.","o|1s|di|17w|18H","a|fc","o|18J|fi","a|n|Nx|fg","Session-specific ID for the channel.","o|o|1z|q|18M","Stable identifier for the channel that is agreed upon by both peers.","o|o|1D|v|18O","Optional Mime-type or URL describing the protocol that is hosted ober this stream. Used for introspection.","o|t|1D|14|z|18Q","o|18L|18N|18P|18R","Notify the remote peer that we are opening a channel.\\n\\nMeans that we are ready to receive data on the channel.\\nThe remote peer could now send data messages with this channel id that will be atributed to this channel.\\n\\nThe local peer must buffer any data messages until the remote peer replies with OpenChannel for this tag.","o|1s|18K|18S|18T","o|17t|17x|18A|18G|18I|18U","o|1|18V","PeerState","a|18X","_peerId","a|18Z","o|f|rE","o|18a|18b","a|b5|Ar|rD","Will be used to build network graph","o|12|13|4I|q|18e","Omitted when sent over the network.","o|t|4I|14|z|18g","o|18d|18f|MF|18h","o|1s|18c|18i|","o|18Y|18j","o|1|18k","Buffer","a|18m|sK|nE","code","a|18o|E3","o|18p|1j|2i","o|18|18q|","nmId","nmResponse","nmEphemeral","nmData","a|18s|18t|18u|18v","o|o|97|14|","o|o|GQ|2S|","o|18w|1j|eA|18x|18y","o|18|18z|","o|18n|15u|18r|190","o|1|191","Container","a|193|cu","a|M|bd","o|12|13|GQ|v|","o|195|1j|196","o|18|197|","_discoveryKey","a|Et|199","discoveryKey","a|19B","o|f|19C","o|19A|Ez|19D","a|Ex|19B","o|19F|6r|6i","o|1s|19E|19G|","o|194|198|19H","o|1|19I","github.com/dxos/kube/proto/def/dxos/mesh/signal","o|Me|19K","HostEvent","JoinRequest","PeerEvent","ReceptionRequest","SignalState","SwarmEvent","a|19M|19N|nE|19O|19P|FR|19Q|19R","event","a|19T","announceBack","a|19V","o|5J|19W|","o|19U|19X","AnnounceBack","o|o|19Z|q|","o|19W|19a","a|19Z","peerAvailable","a|FM|19d","SwarmEvent.PeerAvailable","o|o|19f|v|","o|19e|68|19g","o|18|19h|","o|19c|19i","Goes on a Pub/Sub host topic.","o|b|19Y|19b|19j|19k","_metadata","a|19m","o|f|dF","o|19n|19o","peer","a|FM|19q|dE","o|19r|68|n9|E6","o|1s|19p|19s|","author","recipient","a|19u|19v|ac|dE","o|19w|68|n9|GR|sY","o|1s|19p|19x|","o|5J|sP|","o|19U|19z","o|o|nE|q|","o|sP|1A1","Goes on Pub/Sub peer topic.","o|1s|1A0|1A2|1A3","a|19q","o|1A5|68","o|18|1A6|","Join","ReceiveMessages","SendMessage","a|1A8|1A9|1AA","o|1d|19N|19R|y|","o|1d|19P|nE|y|","o|2p|nE|1e|","o|1AB|1AC|1AD|1AE","o|1Y|1AF|","RECONNECTING","DISCONNECTED","a|D3|1AH|D4|1AI|DA|LS","o|1AJ|1R|q|v|14|2S|4J","Connection is being established.","Connection is being re-established.","Connected.","Server terminated the connection. Socket will be reconnected.","Server terminated the connection with an ERROR. Socket will be reconnected.","Socket was closed.","o|1AJ|1AL|1AM|1AN|1AO|1AP|1AQ","o|1N|1AK||1AR","peerLeft","a|19d|1AT","o|5J|1AU|","o|19U|1AV","PeerAvailable","The peer was announced as available on the swarm.","o|o|1AX|q|1AY","PeerLeft","The peer left, or their announcement timed out.","o|o|1Aa|v|1Ab","o|1AU|1AZ|1Ac","a|1AX|1Aa","_until","_announceBackToHost","a|1Af|1Ag","until","a|1Ai","o|f|1Aj","announceBackToHost","a|1Al","o|f|1Am","o|1Ah|1Ak|1An","since","a|19q|1Ap|1Ai|1Al","Only relevant in Pub/Sub. Optional, the host topic to eagerly send PeerAvailable messages back to.","o|t|67|2S|z|1Ar","o|1Aq|68|jV|JN|1As","o|1s|1Ao|1At|","o|1Ae|1Au|1A7","Goes on Pub/Sub swarm topic and as a Join stream in RPC.","o|b|1AW|1Ad|1Av|1Aw","o|19S|19l|19t|19y|1A4|1A7|1AG|1AS|1Ax","o|Mc|19L|1Ay","Answer","MessageData","Offer","SignalBatch","SwarmMessage","a|1B0|1B1|1B2|FR|1B3|1B4","_offerMessageId","a|1B6","offerMessageId","a|1B8","o|f|1B9","o|1B7|1BA","accept","a|1BC|1B8","MessageId of the Offer being answered.","o|t|4I|v|z|1BE","o|1BD|U1|1BF","o|1s|1BB|1BG|","offer","answer","signalBatch","a|1BI|1BJ|Qh|1BK","o|5J|1BL|","o|ad|1BM","o|o|1B2|q|","o|o|1B0|v|","@deprecated Use SignalBatch instead.","o|o|FR|14|1BQ","o|o|1B3|2S|","o|1BL|1BO|1BP|1BR|1BS","o|1s|1BN|1BT|","o|ad|17E","o|18|1BV|","signals","a|1BX","o|12|13|FR|q|","o|1BY|1BZ","o|18|1Ba|","a|av|fH|bd|17b","Swarm identifier.","o|o|4I|14|1Bd","Unique connection identifier.","o|o|4I|2S|1Bf","Message payload.","o|o|1B1|4J|1Bh","Unique message identifier. Used for ACK and matching Answers to Offers.","o|o|4I|4M|1Bj","o|1Bc|1Be|1Bg|1Bi|1Bk","Use for:\\n- Initial peer discovery (initiate session id between two peers).\\n- RTC negotiation (SDP offer/answer and ICE).","o|18|1Bl|1Bm","o|1B5|1BH|1BU|Za|1BW|1Bb|1Bn","o|1|1Bo","automerge","blobsync","control","gossip","notarization","a|uB|1Bq|1Br|1Bs|1Bt|1Bu|161","AuthenticateRequest","AuthenticateResponse","AuthService","a|1Bw|1Bx|1By","o|11I|68","o|18|1C0|","o|XL|68","o|18|1C2|","a|Dc","o|2p|1Bw|1Bx|","o|1C4|1C5","o|1Y|1C6|","o|1Bz|1C1|1C3|1C7","o|1|1C8","AutomergeReplicatorService","SyncMessage","a|1CA|b1|1CB","StartReplication","a|1CD|qT","o|2p|b1|1e|","o|2p|1CB|1e|","o|1CE|1CF|1CG","o|1Y|1CH|","o|6K|1j","o|18|1CJ|","o|ad|n9","o|18|1CL|","o|1CC|1CI|1CK|1CM","o|1|1CN","BlobChunk","BlobSyncService","WantList","a|1CP|1CQ|1CR","_chunkSize","_chunkOffset","_totalLength","a|1CT|1CU|1CV","a|gU","o|f|1CX","chunkOffset","a|1CZ","o|f|1Ca","totalLength","a|1Cc","o|f|1Cd","o|1CW|1CY|1Cb|1Ce","a|n|gU|1CZ|1Cc|ac","In bytes","o|t|1z|v|z|1Ch","Offset from the start of blob in bytes.","o|t|1z|14|z|1Cj","Total length of blob.","o|t|1z|2S|z|1Cl","o|o|67|Kf|","o|1Cg|68|1Ci|1Ck|1Cm|1Cn","o|1s|1Cf|1Co|","Want","Push","a|1Cq|1Cr","Notify the peer that we want to receive specified objects.","o|2p|1CR|1e|1Ct","Send an object to the peer.","o|2p|1CP|1e|1Cv","o|1Cs|1Cu|1Cw","Allows synchronization of opaque data objects between two peers.\\nLoosely based on Bittorrent protocol.","o|1Y|1Cx|1Cy","Entry","Requested blobs. If bitfield is empty, all chunks are requested.","o|12|13|1D0|q|1D1","o|ao|1D2","a|1D0","a|1CT|gK","o|1D5|1CY|gP","a|n|gU|gN","Size of chunk in bytes. Must be a power of 2. Default is 4096.\\nIf chunk_size is missing, host will provide it.","o|t|1z|v|z|1D8","Bitfield of requested chunks.\\nEvery bit represents a chunk.\\nChunks are indexed from MSB to LSB.\\n\\nIf bitfield is missing, all chunks are requested.","o|t|67|14|z|1DA","o|1D7|68|1D9|1DB","o|1s|1D6|1DC|","o|1D4|1DD","o|En|1D3|1DE|","o|1CS|1Cp|1Cz|1DF","o|1|1DG","ControlHeartbeatRequest","ControlHeartbeatResponse","ControlService","RegisterExtensionRequest","a|1DI|1DJ|1DK|1DL","requestTimestamp","a|1DN","o|1DO|Ak","o|18|1DP|","RegisterExtension","Heartbeat","a|1DR|1DS","o|2p|1DL|1e|","o|2p|1DI|1DJ|","o|1DT|1DU|1DV","Controls the lifycycle of the teleport session and its exentsions.","o|1Y|1DW|1DX","Must not contain slashes: /[\\\\w_.]+/. Example: \`dxos.mesh.teleport.control\`.","o|o|1D|q|1DZ","o|ND|1Da","o|18|1Db|","o|1DM|1DQ|1DQ|1DY|1Dc","o|1|1Dd","GossipMessage","GossipService","a|1Df|1Dg","a|rD|18B|17b|Ah|ac","Used to route differnt payload types to correct listeners.","o|o|1D|v|1Dj","Peer tracks what had been sent by message id.","o|o|4I|14|1Dl","o|o|4G|2S|","o|o|GQ|CL|","o|1Di|8Q|1Dk|1Dm|1Dn|1Do","o|18|1Dp|","Announce","a|1Dr","o|2p|1Df|1e|","o|1Ds|1Dt","o|1Y|1Du|","o|1Dh|1Dq|1Dv","o|1|1Dw","NotarizationService","NotarizeRequest","a|1Dy|1Dz","Notarize","a|1E1","o|2p|1Dz|1e|","o|1E2|1E3","Allows peers to request their credentials be written to the control feed.\\nUseful for new devices bootstraping their feeds into the space.","o|1Y|1E4|1E5","a|MT","Write specified credentials to the control feed of the space.\\nCredentials with ids that are already present in the control pipeline must be skipped.","o|12|13|KS|q|1E8","o|1E7|1E9","o|18|1EA|","o|1E0|1E6|1EB","o|1|1EC","FeedInfo","ReplicatorService","StartReplicationRequest","StartReplicationResponse","StopReplicationRequest","UpdateFeedsRequest","a|1EE|1EF|1EG|1EH|1EI|1EJ","download","upload","a|cP|1EL|1EM","set if the peer whishes to download the data from the feed.","o|o|97|v|1EO","set if the peer whishes to updload the data from the feed.","o|o|97|14|1EQ","o|1EN|8Q|1EP|1ER","o|18|1ES|","UpdateFeeds","StopReplication","a|1EU|1CD|1EV","Notify about available feeds.","o|2p|1EJ|1e|1EX","Start replicating feed. If this feed is already being replicated, the existing replication session must be stopped.","o|2p|1EG|1EH|1EZ","Stop replicating feed.","o|2p|1EI|1e|1Eb","o|1EW|1EY|1Ea|1Ec","RPC verbs for replication teleport extension.\\nAssumes one peer is designated an initiator.\\nThe initiator will start and stop replication streams.\\nThe other peer will send updates using the UpdateFeeds method.","o|1Y|1Ed|1Ee","o|o|1EE|q|","o|x1|1Eg","o|18|1Eh|","_streamTag","a|1Ej","streamTag","a|1El","o|f|1Em","o|1Ek|1En","Tag of the stream the peers will use for the replication.\\nSet to null or \\"\\" (empty string) of the peer does not wish to replicate the feed.\\n\\nA new stream must be open with unique tag to start replicating. Existing streams cannot be reused.","o|t|1D|q|z|1Ep","o|1Em|1Eq","o|1s|1Eo|1Er|","o|12|13|1EE|q|","o|ct|1Et","o|18|1Eu|","o|1EK|1ET|1Ef|1Ei|1Es|1Ei|1Ev","o|1|1Ew","o|1Bv|1C9|1CO|1DH|1De|1Dx|1ED|1Ex","o|1|1Ey","o|163|17I|17X|17p|18W|18l|192|19J|1Az|1Bp|1Ez","o|1|1F0","Record","a|1F2","a|BG|N7|N8|5H","a|M|ac","o|5J|1F5|","o|1F4|Bc|NJ|NM|1F6","a|Ba|NH|NK|NX|M|ac","Record creation timetstamp.","o|t|4G|q|z|1F9","Human-readable name of record.","o|t|1D|v|z|1FB","Record description.","o|t|1D|14|z|1FD","Optional record tags.","o|12|13|1D|2S|1FF","Type record variant.","o|o|Bz|Kf|1FH","Extension","Data record variant.","o|o|1FJ|Nj|1FK","o|1F8|1FA|1FC|1FE|1FG|1FI|1FL","a|1FJ|Bz","typeRecord","a|1FO|bd","CID of type record.","o|o|67|q|1FQ","Serialized payload data.","o|o|67|v|1FS","o|1FP|1FR|1FT","Data with a reference to a type record that defines the encoding.","o|18|1FU|1FV","_protobufIpfsCid","a|1FX","protobufIpfsCid","a|1FZ","o|f|1Fa","o|1FY|1Fb","messageName","protobufDefs","a|1Fd|1Fe|1FZ","FQ protobuf message name.","o|o|1D|q|1Fg","Set of protobuf messages encoded.","o|o|Al|v|1Fi","CID of protobuf source file.","o|t|1D|14|z|1Fk","o|1Ff|1Fh|1Fj|1Fl","Types are system records that define protocol-buffer schema of other records.","o|1s|1Fc|1Fm|1Fn","o|1FN|1FW|1Fo","o|b|1F7|1FM|1Fp|","o|1F3|1Fq","o|1|1Fr","github.com/dxos/kube/proto/def/dxos/rpc","o|Me|1Ft","Bye","MessageTrace","Request","Response","RpcMessage","StreamClose","a|1Fv|1Fw|1Fx|1Fy|1Fz|1G0","Request to close the connection.\\nConnection is closed once both sides have received the Bye message.","o|18|ZZ|1G2","direction","a|1G4|bd","Direction","o|o|1G6|q|","o|1G5|1G7|n9","a|1G6","INCOMING","OUTGOING","a|1GA|1GB","o|1GC|1R|q","o|1GC||","o|1N|1GD||1GE","o|1G9|1GF","o|En|1G8|1GG|","method","stream","a|n|1GI|ac|1GJ","o|o|1z|q|","o|1GK|1GL|2i|GR|g3","o|18|1GM|","content","a|1GO","streamReady","a|ac|C|180|1GQ","o|5J|1GR|","o|1GP|1GS","a|n|ac|C|180|1GQ","o|o|E9|14|","Sent when stream is closed without an error.","o|o|97|2S|1GW","Sent when the server has processed a request with a streaming response.\\nCan be skipped by the server.\\nIn this case the first payload should be treated as the server being ready.","o|o|97|4J|1GY","o|1GU|1GL|vS|1GV|1GX|1GZ","o|1s|1GT|1Ga|","request","openAck","streamClose","bye","a|1Gc|6n|J1|1Gd|1Ge|1Gf","o|5J|1Gg|","o|1GP|1Gh","o|o|1Fx|q|","o|o|1Fy|v|","Means that the node is trying to open the connection.","o|o|97|14|1Gl","Means that the node has received the \\"open\\" message and is ready to perform requests.","o|o|97|2S|1Gn","o|o|1G0|4J|","Request to close the connection.","o|o|1Fv|4M|1Gq","o|1Gg|1Gj|1Gk|1Gm|1Go|1Gp|1Gr","o|1s|1Gi|1Gs|","o|6K|1GL","o|18|1Gu|","o|1G1|1G3|1GH|1GN|1Gb|1Gt|1Gv","o|Mc|1Fu|1Gw","agentmanager","a|1Gy|VQ|VT|NQ","github.com/dxos/kube/proto/def/dxos/service/agentmanager","o|Me|1H0","AgentManager","Authentication","InitAuthSequenceRequest","InitAuthSequenceResponse","a|1H2|1Bx|1H3|1H4|1H5","InitAuthSequence","a|1H7|Dc","o|2p|1H4|1H5|","o|2p|1H3|1Bx|","o|1H8|1H9|1HA","o|1Y|1HB|","_token","a|1HD|XF","token","a|1HF","o|f|1HG","o|1HE|1HH|XM","a|1HF|XK","o|t|KS|v|z|","o|1HJ|6h|1HK","o|1s|1HI|1HL|","a|IM","o|1HN|IO","o|18|1HO|","_authToken","a|1HQ","authToken","a|1HS","o|f|1HT","o|1HR|1HU","o|1HT|6h","o|1s|1HV|1HW|","_agentmanagerKey","_initAuthResponseReason","a|IG|1HY|1HZ","agentmanagerKey","a|1Hb","o|f|1Hc","initAuthResponseReason","a|1He","o|f|1Hf","o|1Ha|IK|1Hd|1Hg","result","a|1Hi|II|1Hb|1He","InitAuthSequenceResult","o|o|1Hk|q|","o|1Hj|1Hl|6i|pM|Nc","a|1Hk","NOT_AUTHORIZED","a|wJ|D7|1Ho|DA","o|1Hp|1R|q|v|14","o|1Hp||||","o|1N|1Hq||1Hr","o|1Hn|1Hs","o|b|1Hh|1Hm|1Ht|","o|1H6|1HC|1HM|1HP|1HX|1Hu","o|Mc|1H1|1Hv","github.com/dxos/kube/proto/def/dxos/service/publisher","o|Me|1Hx","ListResponse","PublishRequest","PublishResponse","ResetResponse","a|1Hz|Vw|1I0|1I1|1I2","a|OG","dxos.config.Module","o|12|13|1I5|q|","o|1I4|1I6","o|18|1I7|","Publish","List","a|1I9|1IA|Lo","o|2p|1I0|1I1|","o|2p|1e|1Hz|","o|2p|1e|1I2|","o|1IB|1IC|1ID|1IE","o|1Y|1IF|","_accessToken","a|1IH","accessToken","a|1IJ","o|f|1IK","o|1II|1IL","skipExisting","a|6w|1IN|1IJ","dxos.config.Package","o|o|1IP|q|","o|1IO|1IQ|eA|4g","o|1s|1IM|1IR|","PublishedModule","o|12|13|1IT|q|","o|1I4|1IU","a|1IT","module","a|1IX|XH","o|o|1I5|q|","o|1IY|1IZ|Up","o|18|1Ia|","o|1IW|1Ib","o|En|1IV|1Ic|","count","a|1Ie","o|1If|1GL","o|18|1Ig|","o|1I3|1I8|1IG|1IS|1Id|1Ih","o|Mc|1Hy|1Ii","github.com/dxos/kube/proto/def/dxos/service/supervisor","o|Me|1Ik","ConfigPair","Service","SetConfigRequest","SetConfigResponse","WellKnown","WellKnowns","a|1Bx|1H3|1Im|Z2|1H5|1In|P8|1Io|1Ip|Vy|1Iq|1Ir","o|l4|1j|2i","o|18|1It|","o|o|6O|q|","o|6F|1Iv","o|18|1Iw|","a|II|yG","o|1Iy|68|MF","o|18|1Iz|","addresses","wellKnowns","a|5K|k|1J1|M|1J2","o|o|p|v|","o|12|13|1D|2S|","o|o|Bz|4J|","o|12|13|1Iq|4M|","o|1J3|1j|1J4|1J5|1J6|1J7","a|p|Bz","STARTED","FAILED","a|wJ|1JA|4j|1JB","o|1JC|1R|q|v|14","o|1JC||||","o|1N|1JD||1JE","PROCESS","SERVICE","a|9V|1JG|1JH","o|1JI|1R|q|v","o|1JI|||","o|1N|1JJ||1JK","o|1J9|1JF|1JL","o|En|1J8|1JM|","o|12|13|1In|q|","o|7C|1JO","o|18|1JP|","o|o|1Im|q|","o|6F|1JR","o|18|1JS|","a|Dc|1H7|Ll|q3|p","o|2p|1e|1H5|","o|2p|1Io|1Ip|","o|2p|1e|P8|","o|1JU|1HA|1JV|Zz|1JW|1JX","o|1Y|1JY|","a|OO|NK","o|1Ja|1j|2i","o|18|1Jb|","a|1J2","WellKnownsByService","o|12|13|1Je|q|","o|1Jd|1Jf","a|1Je","serviceName","a|1Ji|1J2","o|12|13|1Iq|v|","o|1Jj|1j|1Jk","o|18|1Jl|","o|1Jh|1Jm","o|En|1Jg|1Jn|","o|1Is|1HM|1HP|1Iu|1Ix|1J0|1JN|1JQ|1JT|1JT|1JZ|1Jc|1Jo","o|Mc|1Il|1Jp","github.com/dxos/kube/proto/def/dxos/service/tunnel","o|Me|1Jr","ListTunnelsResponse","Tunnel","TunnelRequest","TunnelResponse","a|1Jt|1Ju|1Jv|1Jw","tunnels","a|1Jy","o|12|13|1Jw|q|","o|1Jz|1K0","o|18|1K1|","ListTunnels","a|1Ju|1K3","o|2p|1Jv|1Jw|","o|2p|1e|1Jt|","o|1K4|1K5|1K6","o|1Y|1K7|","a|5K|PR","o|1K9|1j|eA","o|18|1KA|","a|5K|PR|OO","o|1KC|1j|eA|1I","o|18|1KD|","o|1Jx|1K2|1K8|1KB|1KE","o|Mc|1Js|1KF","o|1Gz|1Hw|1Ij|1Jq|1KG","o|1|1KH","Metric","Resource","ResourceLink","Span","StreamTraceEvent","TraceLevel","TracingService","a|1KJ|1KK|1KL|1KM|1KN|1KO|1KP","a|kw","counter","timeSeries","multiCounter","custom","a|1KS|1KT|1KU|1KV","o|5J|1KW|","o|1KR|1KX","a|5K|1KS|1KT|1KU|1KV","Counter","o|o|1Ka|Kf|","TimeSeries","o|o|1Kc|Nj|","MultiCounter","n|1e","o|o|1Ke|1Kf|","Custom","n|3D","o|o|1Kh|1Ki|","o|1KZ|1j|1Kb|1Kd|1Kg|1Kj","a|1Ka|1Kh|1Ke|1Kc","_units","a|1Km","units","a|1Ko","o|f|1Kp","o|1Kn|1Kq","a|N|1Ko","double","o|o|1Kt|q|","o|1Ks|1Ku|32","o|1s|1Kr|1Kv|","records","a|1Kx|1Ko","o|12|13|1F2|q|","o|1Ky|1Kz|32","o|o|1Kt|v|","o|l4|1j|1L1","o|18|1L2|","o|1F3|1L3","o|b|1Kr|1L0|1L4|","tracks","a|1L6","Track","o|12|13|1L8|q|","o|1L7|1L9","Point","a|1LB|1L8","o|F0|1Ku","o|18|1LD|","points","a|5K|1Ko|1LF|19","o|12|13|1LB|CL|","o|o|1Kt|CO|","o|1LG|1j|32|1LH|1LI","o|1s|1Kr|1LJ|","o|1LC|1LE|1LK","o|En|1LA|1LL|","o|1Kl|1Kw|1BW|1L5|1LM","o|b|1KY|1Kk|1LN|","className","instanceId","links","a|n|1LP|1LQ|x0|1LR|Hz","o|o|Al|2S|","o|12|13|1KL|4J|","o|12|13|1KJ|4M|","o|1LS|1GL|2i|d0|1LT|1LU|1LV","o|18|1LW|","to","attributes","a|17N|1LY|1LZ","o|1La|1GL|ER|1LT","o|18|1Lb|","_endTs","a|oS|EF|1Ld|4U","endTs","a|1Lf","o|f|1Lg","o|1Le|oY|EM|1Lh|4d","methodName","startTs","a|n|oW|EK|1Lj|1Lk|1Lf|C","o|t|E9|CO|z|","o|1Ll|1GL|2Q|2R|U2|UT|Qw|1Lm","o|1s|1Li|1Ln|","resourceAdded","resourceRemoved","spanAdded","logAdded","a|1Lp|1Lq|1Lr|1Ls","ResourceAdded","o|12|13|1Lu|q|","ResourceRemoved","o|12|13|1Lw|v|","SpanAdded","o|12|13|1Ly|14|","LogAdded","o|12|13|1M0|2S|","o|1Lt|1Lv|1Lx|1Lz|1M1","a|1M0|1Lu|1Lw|1Ly","dxos.client.services.LogEntry","o|o|1M4|q|","o|Rk|1M5","o|18|1M6|","resource","a|1M8","o|o|1KK|q|","o|1M9|1MA","o|18|1MB|","span","a|1MD","o|o|1KM|q|","o|1ME|1MF","o|18|1MG|","o|1M3|1M7|1MC|1Gv|1MH","o|En|1M2|1MI|","DISABLED","PRODUCTION","DEVELOPMENT","a|1MK|1ML|1MM|Eg","o|1MN|1R|CL|Io|n3","o|1MN||||","o|1N|1MO||1MP","StreamTrace","a|1MR","o|1d|1e|1KN|y|","o|1MS|1MT","o|1Y|1MU|","o|1KQ|1LO|1LX|1Lc|1Lo|1MJ|1MQ|1MV","o|1|1MW","BotFactory","File","IPFS","KUBE","StateMachine","a|P2|Vj|3O|1MY|1MZ|1Ma|1Mb|Ml|1In|FR|1Mc","_extension","a|Mp|OA|N9|5H|1Me","web","a|1Mg","o|5J|1Mh|","extension","a|1Mj","o|f|1Mk","o|1Mf|Mt|OE|NP|1Mi|1Ml","a|Mr|OC|NZ|NN|1Mg|1Mj","Optional **semver 2.0** compliant record version.\\nShould conform to the semver regex (see https://semver.org/).","o|t|1D|q|z|1Mo","o|12|13|Ml|14|","App bundle content Id in the CID v0 format (https://docs.ipfs.io/concepts/content-addressing/#identifier-formats).","o|t|67|2S|z|1Mr","Web","o|o|1Mt|Kf|","dxos.registry.Record.Extension","o|t|1Mv|Nl|z|","o|1Mn|1Mp|32|1Mq|1Ms|1Mu|1Mw","a|1Mt","_indexFile","_entryPoint","a|1Mz|1N0","indexFile","a|1N2","o|f|1N3","entryPoint","a|1N5","o|f|1N6","o|1N1|1N4|1N7","a|1N2|1N5","Relative path in resource to entrypoint, defaults to index.html.","o|t|1D|q|z|1NA","Relative path in resource to entrypoint, defaults to main.js.","o|t|1D|v|z|1NC","o|1N9|1NB|1ND","o|1s|1N8|1NE|","o|1My|1NF","o|b|1Mm|1Mx|1NG|","a|OO|1Mj","o|o|1Mv|Kf|","o|1NI|1j|1NJ","o|18|1NK|","a|Mr|OC|NZ|NN|5M|1Mj","o|o|1D|q|1Mo","Bot bundle content Id in the CID v0 format (https://docs.ipfs.io/concepts/content-addressing/#identifier-formats).","o|o|67|2S|1NO","This would be the path to the bot executable in bot-factory's file-system.","o|o|1D|4J|1NQ","o|1NM|1NN|2i|1Mq|1NP|1NR|1NJ","o|18|1NS|","a|av|1Mj","o|1NU|1j|1NJ","o|18|1NV|","fileName","a|fg|1NX|NN|1Mj","File content Id in the CID v0 format (https://docs.ipfs.io/concepts/content-addressing/#identifier-formats).","o|o|67|14|1NZ","o|1NY|1j|2i|1Na|1NJ","o|18|1Nb|","a|mW|1J1|1Mj","o|1Nd|1j|Up|1NJ","o|18|1Ne|","o|OS|1j|2i|1I","o|18|1Ng|","a|M|Ot|1Mj","o|1Ni|1j|n9|1NJ","o|18|1Nj|","a|Uk|OO|1Mj","o|1Nl|1j|2i|1NJ","o|18|1Nm|","mutationProtobufDefs","snapshotProtobufDefs","codeIpfsCid","a|1No|1Np|1Nq","Set of protobuf messages.","o|o|Al|q|1Ns","o|o|Al|v|1Ns","o|o|67|14|","o|1Nr|1Nt|1Nu|1Nv","o|18|1Nw|","o|1Md|1NH|1NL|1NT|1NW|1Nc|1Nf|1NL|1Nh|1Nk|1Nn|1Nx","o|1|1Ny","Stats","a|1O0|kw","_min","_max","_mean","_median","_total","_count","a|1O2|1O3|1O4|1O5|1O6|1O7","min","a|1O9","o|f|1OA","max","a|1OC","o|f|1OD","mean","a|1OF","o|f|1OG","median","a|1OI","o|f|1OJ","a|19","o|f|1OL","o|f|1If","o|1O8|1OB|1OE|1OH|1OK|1OM|1ON","a|1O9|1OC|1OF|1OI|19|1Ie","o|t|mo|q|z|","o|t|mo|v|z|","o|t|mo|14|z|","o|t|mo|2S|z|","o|t|mo|4J|z|","o|t|mo|4M|z|","o|1OP|1OQ|1OR|1OS|1OT|1OU|1OV","o|1s|1OO|1OW|","_bool","_string","_int","_float","a|1OY|1OZ|1Oa|1Ob","a|97","o|f|1Od","a|1D","o|f|1Of","a|mn","o|f|1Oh","a|mo","o|f|1Oj","o|1Oc|1Oe|1Og|1Oi|1Ok","a|97|1D|mn|mo","o|1Om|98|32|2R|1OT","o|1s|1Ol|1On|","o|1O1|1OX|1Oo","o|1|1Op","o|O|3N|7A|Mb|Yr|gA|sH|sd|u4|13u|15n|15w|1F1|1Fs|1Gx|1KI|1MX|1Nz|1Oq","o|1|1Or","testing","a|1Ot","a|bd|J","TestItemMutation","TestItemSnapshot","TestListMutation","TestPayload","a|1Ow|1Ox|1Oy|1Oz","o|12|13|1Ow|q|","o|AS|1P1","o|18|1P2|","o|1P0|1Iu|1P3|d9|d9","o|1|1P4","github.com/dxos/kube/proto/def/example/testing/rpc","o|Me|1P6","MessageWithAny","PingReponse","PingRequest","PingService","TestAnyService","TestRpcRequest","TestRpcResponse","TestService","TestServiceWithStreams","TestStreamRpcRequest","TestStreamRpcResponse","TestStreamService","a|1P8|1P9|1PA|1PB|1PC|1PD|1PE|1PF|1PG|1PH|1PI|1PJ","o|IJ|1GL","o|18|1PL|","Ping","a|1PN","o|2p|1PA|1P9|","o|1PO|1PP","o|1Y|1PQ|","TestCall","a|1PS","o|2p|1P8|1P8|","o|1PT|1PU","o|1Y|1PV|","VoidCall","a|1PS|1PX","o|2p|1PD|1PE|","o|1PY|1PZ|5D","o|1Y|1Pa|","RequestTestStream","CloseTestStream","a|1Pc|1Pd","o|2p|1PH|1PE|","o|2p|1PD|1PI|","o|1Pe|1Pf|1Pg","o|1Y|1Ph|","streamLoadInterval","streamLoadChunkSize","a|bd|1Pj|1Pk","o|1Pl|1j|c3|c4","o|18|1Pm|","sendErrors","receiveErrors","runningTime","a|bd|fq|fr|1Po|1Pp|1Pq","o|o|G8|4J|","o|o|G8|4M|","o|1Pr|1j|c3|c4|c5|1Ps|1Pt","o|18|1Pu|","o|1d|1PD|1PE|y|","o|1PT|1Pw","o|1Y|1Px|","o|1PK|13G|1PM|1PM|1PR|1PW|d9|d9|1Pb|1Pi|1Pn|1Pv|1Py","o|Mc|1P7|1Pz","o|1Ov|1P5|1Q0","o|1|1Q1","o|1Ou|1Q2","o|1|1Q3","protobuf","a|1Q5","Any","BoolValue","BytesValue","DescriptorProto","DoubleValue","Empty","EnumDescriptorProto","EnumOptions","EnumValueDescriptorProto","EnumValueOptions","FieldDescriptorProto","FieldOptions","FileDescriptorProto","FileDescriptorSet","FileOptions","FloatValue","GeneratedCodeInfo","Int32Value","Int64Value","ListValue","MessageOptions","MethodDescriptorProto","MethodOptions","NullValue","OneofDescriptorProto","OneofOptions","ServiceDescriptorProto","ServiceOptions","SourceCodeInfo","StringValue","Struct","Timestamp","UInt32Value","UInt64Value","UninterpretedOption","a|1Q7|1Q8|1Q9|1QA|1QB|1QC|1QD|1QE|1QF|1QG|1QH|1QI|1QJ|1QK|1QL|1QM|1QN|1QO|1QP|1QQ|1QR|1QS|1QT|1QU|1QV|1QW|1QX|1QY|1QZ|1Qa|1Qb|1Qc|1Qd|1Qe|1Qf|kw","type_url","a|1Qh|N","a|M|n","o|1Qj|1D|q","o|1Qj|67|v","o|1Qi|1Qk|1Ql","o|18|1Qm|","o|1Qj|97|q","o|F0|1Qo","o|18|1Qp|","o|1Qj|67|q","o|F0|1Qr","o|18|1Qs|","nestedType","enumType","extensionRange","oneofDecl","reservedRange","reservedName","a|5K|in|1Mj|1Qu|1Qv|1Qw|1Qx|s|1Qy|1Qz","a|11|M|n","o|1R1|13|1QH|v","o|1R1|13|1QH|4M","o|1R1|13|1QA|14","o|1R1|13|1QD|2S","ExtensionRange","o|1R1|13|1R6|4J","o|1R1|13|1QV|CF","o|1Qj|1QR|4O","ReservedRange","o|1R1|13|1RA|CI","o|1R1|13|1D|CL","o|1R0|1Qk|1R2|1R3|1R4|1R5|1R7|1R8|1R9|1RB|1RC","a|1R6|1RA","start","end","a|1RF|1RG","o|1Qj|1z|q","o|1Qj|1z|v","o|1RH|1RI|1RJ","o|18|1RK|","o|1RE|1RL|1RL","o|En|1RD|1RM|","o|1Qj|1Kt|q","o|F0|1RO","o|18|1RP|","a|5K|N|s","o|1R1|13|1QF|v","o|1Qj|1QE|14","o|1RR|1Qk|1RS|1RT","o|18|1RU|","extensions","a|Z|1RW|a","allowAlias","deprecated","uninterpretedOption","a|1RY|1RZ|1Ra","o|1Qj|97|v","o|1Qj|97|14","n|G7","o|1R1|13|1Qf|1Re","o|1Rb|1Rc|1Rd|1Rf","n|aKeeF","a|N2|1Rh","a|1Ri","o|1RX|1Rg|1Rj|","a|5K|wg|s","o|1Qj|1QG|14","o|1Rl|1Qk|1RJ|1Rm","o|18|1Rn|","a|1RZ|1Ra","o|1Rp|1Qo|1Rf","o|1RX|1Rq|1Rj|","typeName","extendee","defaultValue","oneofIndex","jsonName","a|5K|wg|dS|M|1Rs|1Rt|1Ru|1Rv|1Rw|s","o|1Qj|1z|14","Label","o|1Qj|1Rz|2S","o|1Qj|Bz|4J","o|1Qj|1D|4M","o|1Qj|1D|v","o|1Qj|1D|4O","o|1Qj|1z|CI","o|1Qj|1D|CL","o|1Qj|1QI|CF","o|1Rx|1Qk|1Ry|1S0|1S1|1S2|1S3|1S4|1S5|1S6|1S7","a|1Rz|Bz","a|1L|1M","LABEL_OPTIONAL","LABEL_REQUIRED","LABEL_REPEATED","a|1SB|1SC|1SD","o|1SE|q|v|14","o|1SA|1SF|ZZ","TYPE_DOUBLE","TYPE_FLOAT","TYPE_INT64","TYPE_UINT64","TYPE_INT32","TYPE_FIXED64","TYPE_FIXED32","TYPE_BOOL","TYPE_STRING","TYPE_GROUP","TYPE_MESSAGE","TYPE_BYTES","TYPE_UINT32","TYPE_ENUM","TYPE_SFIXED32","TYPE_SFIXED64","TYPE_SINT32","TYPE_SINT64","a|1SH|1SI|1SJ|1SK|1SL|1SM|1SN|1SO|1SP|1SQ|1SR|1SS|1ST|1SU|1SV|1SW|1SX|1SY","o|1SZ|q|v|14|2S|4J|4M|4O|CF|CI|CL|CO|CR|CU|CW|CY|Cb|Ce|Ci","o|1SA|1Sa|ZZ","o|1S9|1SG|1Sb","o|En|1S8|1Sc|","a|Z|1RW|9i|0|a","ctype","packed","jstype","lazy","weak","a|1Sf|1Sg|1Sh|1Si|1RZ|1Sj|1Ra","a|M|n|s","CType","default","a|1Sn","STRING","o|1So|1Sp","o|1Sl|1Sm|q|1Sq","JSType","JS_NORMAL","o|1So|1St","o|1Sl|1Ss|4M|1Su","o|1Qj|97|4J","o|1Qj|97|CL","o|1Sk|1Sr|1Rc|1Sv|1Sw|1Rd|1Sx|1Rf","a|2S|2S","a|1Sz","a|1Sm|1Ss","CORD","STRING_PIECE","a|1Sp|1T2|1T3","o|1T4|1R|q|v","o|1SA|1T5|ZZ","JS_STRING","JS_NUMBER","a|1St|1T7|1T8","o|1T9|1R|q|v","o|1SA|1TA|ZZ","o|1T1|1T6|1TB","o|1Se|1Sy|1Rj|1T0|1TC|","dependency","publicDependency","weakDependency","messageType","sourceCodeInfo","syntax","a|5K|6w|1TE|1TF|1TG|1TH|1Qv|K|1Mj|s|1TI|1TJ","o|1R1|13|1D|14","a|11|M|n|s","a|1Sg","b|F","o|1TN|1TO","o|1TM|13|1z|CL|1TP","o|1TM|13|1z|CO|1TP","o|1R1|13|1QA|2S","o|1R1|13|1QD|4J","o|1R1|13|1QX|4M","o|1R1|13|1QH|4O","o|1Qj|1QL|CF","o|1Qj|1QZ|CI","o|1Qj|1D|CR","o|1TK|1Qk|1S3|1TL|1TQ|1TR|1TS|1TT|1TU|1TV|1TW|1TX|1TY","o|18|1TZ|","a|EO","o|1R1|13|1QJ|q","o|1Tb|1Tc","o|18|1Td|","javaPackage","javaOuterClassname","javaMultipleFiles","javaGenerateEqualsAndHash","javaStringCheckUtf8","optimizeFor","goPackage","ccGenericServices","javaGenericServices","pyGenericServices","ccEnableArenas","objcClassPrefix","csharpNamespace","a|1Tf|1Tg|1Th|1Ti|1Tj|1Tk|1Tl|1Tm|1Tn|1To|1RZ|1Tp|1Tq|1Tr|1Ra","o|1Qj|1D|CF","a|1RZ","o|1Tu|y","o|1Sl|97|Io|1Tv","n|R","o|1Qj|97|1Tx","OptimizeMode","SPEED","o|1So|1U0","o|1Sl|1Tz|CI|1U1","o|1Qj|1D|CO","o|1Qj|97|Cb","o|1Qj|97|Ce","o|1Qj|97|Ci","n|N","o|1Qj|97|1U7","n|V","o|1Qj|97|1U9","n|a","o|1Qj|1D|1UB","n|b","o|1Qj|1D|1UD","o|1Ts|1Qk|1Tt|1Sx|1Tw|1Ty|1U2|1U3|1U4|1U5|1U6|1U8|1UA|1UC|1UE|1Rf","n|c","a|1UG|1UG","a|1UH","a|1Tz","CODE_SIZE","LITE_RUNTIME","a|1U0|1UK|1UL","o|1UM|q|v|14","o|1SA|1UN|ZZ","o|1UJ|1UO","o|1Se|1UF|1Rj|1UI|1UP|","o|1Qj|mo|q","o|F0|1UR","o|18|1US|","annotation","a|1UU","Annotation","o|1R1|13|1UW|q","o|1UV|1UX","a|1UW","path","sourceFile","begin","a|1Ua|1Ub|1Uc|1RG","o|1R1|13|1z|q","o|1Qj|1z|2S","o|1Ud|1Ue|1S3|1Ry|1Uf","o|18|1Ug|","o|1UZ|1Uh","o|En|1UY|1Ui|","o|F0|1RI","o|18|1Uk|","o|1Qj|mv|q","o|F0|1Um","o|18|1Un|","o|1R1|13|kw|q","o|kz|1Up","o|18|1Uq|","a|Z|1RW|9i|a","messageSetWireFormat","noStandardDescriptorAccessor","mapEntry","a|1Ut|1Uu|1RZ|1Uv|1Ra","o|1Qj|97|4O","o|1Uw|1Qo|1Rc|1Rd|1Ux|1Rf","a|CF|CF","a|1Uz","o|1Us|1Uy|1Rj|1V0|","inputType","outputType","clientStreaming","serverStreaming","a|5K|1V2|1V3|s|1V4|1V5","o|1Qj|1D|14","o|1Qj|1QT|2S","o|1Qj|97|4M","o|1V6|1Qk|1S3|1V7|1V8|1Sw|1V9","o|18|1VA|","n|X","o|1Qj|97|1VC","o|1Rp|1VD|1Rf","o|1RX|1VE|1Rj|","NULL_VALUE","a|1VG","o|1VH|1R","o|1SA|1VI|ZZ","a|5K|s","o|1Qj|1QW|v","o|1VK|1Qk|1VL","o|18|1VM|","a|1Ra","o|1VO|1Rf","o|1RX|1VP|1Rj|","a|5K|1GI|s","o|1R1|13|1QS|v","o|1Qj|1QY|14","o|1VR|1Qk|1VS|1VT","o|18|1VU|","location","a|1VW","Location","o|1R1|13|1VY|q","o|1VX|1VZ","a|1VY","leadingComments","trailingComments","leadingDetachedComments","a|1Ua|1MD|1Vc|1Vd|1Ve","o|1R1|13|1z|v","o|1Qj|1D|2S","o|1R1|13|1D|4M","o|1Vf|1Ue|1Vg|1V7|1Vh|1Vi","o|18|1Vj|","o|1Vb|1Vk","o|En|1Va|1Vl|","o|F0|1Qk","o|18|1Vn|","a|Z","a|x2|M|n","o|1Vq|1D|kw|q","o|1Vp|1Vr","o|18|1Vs|","seconds","nanos","a|1Vu|1Vv","o|1Vw|1Um|1RJ","o|18|1Vx|","o|1Qj|G8|q","o|F0|1Vz","o|18|1W0|","uint64","o|1Qj|1W2|q","o|F0|1W3","o|18|1W4|","identifierValue","positiveIntValue","negativeIntValue","doubleValue","stringValue","aggregateValue","a|5K|1W6|1W7|1W8|1W9|1WA|1WB","NamePart","o|1R1|13|1WD|v","o|1Qj|1W2|2S","o|1Qj|mv|4J","o|1Qj|1Kt|4M","o|1Qj|67|4O","o|1WC|1WE|1V7|1WF|1WG|1WH|1WI|1Tt","a|1WD","namePart","isExtension","a|1WL|1WM","required","o|1R1|1WO|1D|q","o|1R1|1WO|97|v","o|1WN|1WP|1WQ","o|18|1WR|","o|1WK|1WS","o|En|1WJ|1WT|","nullValue","numberValue","boolValue","structValue","listValue","a|1WV|1WW|1WA|1WX|1WY|1WZ","o|f|1Wa","o|5I|1Wb","o|1Qj|1QU|q","o|1Qj|1Kt|v","o|1Qj|97|2S","o|1Qj|1Qb|4J","o|1Qj|1QQ|4M","o|1Wa|1Wd|1We|1V7|1Wf|1Wg|1Wh","o|1s|1Wc|1Wi|","o|1Qg|1Qn|1Qq|1Qt|1RN|1RQ|Za|1RV|1Rk|1Ro|1Rr|1Sd|1TD|1Ta|1Te|1UQ|1UT|1Uj|1Ul|1Uo|1Ur|1V1|1VB|1VF|1VJ|1VN|1VQ|1VV|1VF|1Vm|1Vo|1Vt|1Vy|1W1|1W5|1WU|1Wj","o|1|1Wk","o|1Q6|1Wl","o|1|1Wm","o|5|1Os|1Q4|1Wn","o|1|1Wo"],"1Wp"]`)),schema=Schema.fromJson(schemaJson,substitutions$1),STORAGE_VERSION=2,trace$1={begin:({id:e,parentId:t,data:r})=>({span:{command:"begin",id:e,parent:t,data:r}}),end:({id:e,status:t,data:r})=>({span:{command:"end",id:e,status:t??"ok",data:r}}),update:({id:e,data:t})=>({span:{command:"update",id:e,data:t}}),error:({id:e,error:t,data:r})=>({span:{command:"end",id:e,status:"error",data:{errorMessage:t.message,errorName:t.name,errorStack:t.stack,...r}}})},function(e){e[e.TRACE=5]="TRACE",e[e.DEBUG=10]="DEBUG",e[e.INFO=11]="INFO",e[e.WARN=12]="WARN",e[e.ERROR=13]="ERROR"}(LogLevel||(LogLevel={}));var QueryLogsRequest;(function(e){(function(t){t[t.INCLUSIVE=1]="INCLUSIVE",t[t.EXPLICIT=2]="EXPLICIT"})(e.MatchingOptions||(e.MatchingOptions={}))})(QueryLogsRequest||(QueryLogsRequest={})),function(e){e[e.ACTIVE=0]="ACTIVE",e[e.INACTIVE=1]="INACTIVE"}(SystemStatus||(SystemStatus={}));var GetDiagnosticsRequest;(function(e){(function(t){t[t.NONE=0]="NONE",t[t.TRUNCATE=1]="TRUNCATE",t[t.HUMANIZE=2]="HUMANIZE"})(e.KEY_OPTION||(e.KEY_OPTION={}))})(GetDiagnosticsRequest||(GetDiagnosticsRequest={}));var Platform;(function(e){(function(t){t[t.BROWSER=0]="BROWSER",t[t.SHARED_WORKER=1]="SHARED_WORKER",t[t.NODE=2]="NODE"})(e.PLATFORM_TYPE||(e.PLATFORM_TYPE={}))})(Platform||(Platform={})),function(e){e[e.CURRENT=0]="CURRENT",e[e.TRUSTED=1]="TRUSTED"}(DeviceKind||(DeviceKind={}));var Device;(function(e){(function(t){t[t.OFFLINE=0]="OFFLINE",t[t.ONLINE=1]="ONLINE",t[t.REMOVED=2]="REMOVED"})(e.PresenceState||(e.PresenceState={}))})(Device||(Device={}));var SpaceMember$1;(function(e){(function(t){t[t.OFFLINE=0]="OFFLINE",t[t.ONLINE=1]="ONLINE"})(e.PresenceState||(e.PresenceState={}))})(SpaceMember$1||(SpaceMember$1={})),function(e){e[e.INACTIVE=2]="INACTIVE",e[e.ACTIVE=6]="ACTIVE",e[e.CLOSED=1]="CLOSED",e[e.CONTROL_ONLY=7]="CONTROL_ONLY",e[e.INITIALIZING=4]="INITIALIZING",e[e.READY=3]="READY",e[e.ERROR=5]="ERROR"}(SpaceState||(SpaceState={}));var CreateEpochRequest;(function(e){(function(t){t[t.NONE=0]="NONE",t[t.INIT_AUTOMERGE=1]="INIT_AUTOMERGE",t[t.PRUNE_AUTOMERGE_ROOT_HISTORY=2]="PRUNE_AUTOMERGE_ROOT_HISTORY",t[t.FRAGMENT_AUTOMERGE_ROOT=3]="FRAGMENT_AUTOMERGE_ROOT"})(e.Migration||(e.Migration={}))})(CreateEpochRequest||(CreateEpochRequest={})),function(e){(function(t){t[t.INTERACTIVE=0]="INTERACTIVE",t[t.DELEGATED=1]="DELEGATED",t[t.MULTIUSE=2]="MULTIUSE"})(e.Type||(e.Type={})),function(t){t[t.DEVICE=0]="DEVICE",t[t.SPACE=1]="SPACE"}(e.Kind||(e.Kind={})),function(t){t[t.NONE=0]="NONE",t[t.SHARED_SECRET=1]="SHARED_SECRET",t[t.KNOWN_PUBLIC_KEY=2]="KNOWN_PUBLIC_KEY"}(e.AuthMethod||(e.AuthMethod={})),function(t){t[t.INIT=0]="INIT",t[t.CONNECTING=1]="CONNECTING",t[t.CONNECTED=2]="CONNECTED",t[t.READY_FOR_AUTHENTICATION=3]="READY_FOR_AUTHENTICATION",t[t.AUTHENTICATING=4]="AUTHENTICATING",t[t.SUCCESS=5]="SUCCESS",t[t.CANCELLED=6]="CANCELLED",t[t.TIMEOUT=7]="TIMEOUT",t[t.ERROR=8]="ERROR",t[t.EXPIRED=9]="EXPIRED"}(e.State||(e.State={}))}(Invitation||(Invitation={}));var QueryInvitationsResponse;(function(e){(function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED",t[t.SAVED=2]="SAVED",t[t.LOAD_COMPLETE=3]="LOAD_COMPLETE"})(e.Action||(e.Action={})),function(t){t[t.CREATED=0]="CREATED",t[t.ACCEPTED=1]="ACCEPTED"}(e.Type||(e.Type={}))})(QueryInvitationsResponse||(QueryInvitationsResponse={})),function(e){e[e.OFFLINE=0]="OFFLINE",e[e.ONLINE=1]="ONLINE"}(ConnectionState$2||(ConnectionState$2={}));var MessageTrace;(function(e){(function(t){t[t.INCOMING=0]="INCOMING",t[t.OUTGOING=1]="OUTGOING"})(e.Direction||(e.Direction={}))})(MessageTrace||(MessageTrace={}));var decodeRpcError=(e,t)=>decodeError(e,{appendStack:`
    at RPC ${t} 
`+new StackTrace().getStack(1)});function _ts_decorate$h(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$t="/home/runner/work/dxos/dxos/packages/core/mesh/rpc/src/rpc.ts",DEFAULT_TIMEOUT$1=3e3,BYE_SEND_TIMEOUT=2e3,CLOSE_TIMEOUT=3e3,PendingRpcRequest=class{constructor(e,t,r){this.resolve=e,this.reject=t,this.stream=r}},RpcMessage=schema.getCodecForType("dxos.rpc.RpcMessage"),RpcState;(function(e){e.INITIAL="INITIAL",e.OPENING="OPENING",e.OPENED="OPENED",e.CLOSING="CLOSING",e.CLOSED="CLOSED"})(RpcState||(RpcState={}));var RpcPeer=class{constructor(e){this._outgoingRequests=new Map,this._localStreams=new Map,this._remoteOpenTrigger=new Trigger,this._closingTrigger=new Trigger,this._byeTrigger=new Trigger,this._nextId=0,this._state="INITIAL",this._unsubscribeFromPort=void 0,this._clearOpenInterval=void 0,this._params={timeout:void 0,streamHandler:void 0,noHandshake:!1,...e}}async open(){var e;if(this._state==="INITIAL"){if(this._unsubscribeFromPort=this._params.port.subscribe(async t=>{try{await this._receive(t)}catch(r){log.catch(r,void 0,{F:__dxlog_file$t,L:153,S:this,C:(n,o)=>n(...o)})}}),this._state="OPENING",this._params.noHandshake){this._state="OPENED",this._remoteOpenTrigger.wake();return}log("sending open message",{state:this._state},{F:__dxlog_file$t,L:165,S:this,C:(t,r)=>t(...r)}),await this._sendMessage({open:!0}),this._state==="OPENING"&&(this._clearOpenInterval=exponentialBackoffInterval(()=>{this._sendMessage({open:!0}).catch(t=>log.warn(t,void 0,{F:__dxlog_file$t,L:174,S:this,C:(r,n)=>r(...n)}))},50),await Promise.race([this._remoteOpenTrigger.wait(),this._closingTrigger.wait()]),(e=this._clearOpenInterval)==null||e.call(this),this._state==="OPENED"&&(log("sending second open message",{state:this._state},{F:__dxlog_file$t,L:188,S:this,C:(t,r)=>t(...r)}),await this._sendMessage({openAck:!0})))}}async close({timeout:e=CLOSE_TIMEOUT}={}){if(this._state!=="CLOSED"){if(this._abortRequests(),this._state==="OPENED"&&!this._params.noHandshake){try{this._state="CLOSING",await this._sendMessage({bye:{}},BYE_SEND_TIMEOUT)}catch(t){log("error closing peer, sending bye",{err:t},{F:__dxlog_file$t,L:210,S:this,C:(r,n)=>r(...n)})}try{log("closing waiting on bye",void 0,{F:__dxlog_file$t,L:213,S:this,C:(t,r)=>t(...r)}),await this._byeTrigger.wait({timeout:e})}catch(t){log("error closing peer",{err:t},{F:__dxlog_file$t,L:216,S:this,C:(r,n)=>r(...n)});return}}this._disposeAndClose()}}async abort(){this._state!=="CLOSED"&&(this._abortRequests(),this._disposeAndClose())}_abortRequests(){var e;(e=this._clearOpenInterval)==null||e.call(this),this._closingTrigger.wake();for(const t of this._outgoingRequests.values())t.reject(new RpcClosedError);this._outgoingRequests.clear()}_disposeAndClose(){var e,t;(e=this._unsubscribeFromPort)==null||e.call(this),this._unsubscribeFromPort=void 0,(t=this._clearOpenInterval)==null||t.call(this),this._state="CLOSED"}async _receive(e){var r,n;const t=RpcMessage.decode(e,{preserveAny:!0});if(log("received message",{type:Object.keys(t)[0]},{F:__dxlog_file$t,L:260,S:this,C:(o,s)=>o(...s)}),t.request){if(this._state!=="OPENED"&&this._state!=="OPENING"){log("received request while closed",void 0,{F:__dxlog_file$t,L:264,S:this,C:(s,a)=>s(...a)}),await this._sendMessage({response:{id:t.request.id,error:encodeError(new RpcClosedError)}});return}const o=t.request;if(o.stream)log("stream request",{method:o.method},{F:__dxlog_file$t,L:276,S:this,C:(s,a)=>s(...a)}),this._callStreamHandler(o,s=>{var a;log("sending stream response",{method:o.method,response:(a=s.payload)==null?void 0:a.type_url,error:s.error,close:s.close},{F:__dxlog_file$t,L:278,S:this,C:(c,l)=>c(...l)}),this._sendMessage({response:s}).catch(c=>{log.warn("failed during close",c,{F:__dxlog_file$t,L:286,S:this,C:(l,h)=>l(...h)})})});else{log("request",{method:o.method},{F:__dxlog_file$t,L:290,S:this,C:(a,c)=>a(...c)});const s=await this._callHandler(o);log("sending response",{method:o.method,response:(r=s.payload)==null?void 0:r.type_url,error:s.error},{F:__dxlog_file$t,L:293,S:this,C:(a,c)=>a(...c)}),await this._sendMessage({response:s})}}else if(t.response){if(this._state!=="OPENED"){log("received response while closed",void 0,{F:__dxlog_file$t,L:302,S:this,C:(a,c)=>a(...c)});return}const o=t.response.id;if(invariant$1(typeof o=="number",void 0,{F:__dxlog_file$t,L:307,S:this,A:["typeof responseId === 'number'",""]}),!this._outgoingRequests.has(o)){log("received response with invalid id",{responseId:o},{F:__dxlog_file$t,L:309,S:this,C:(a,c)=>a(...c)});return}const s=this._outgoingRequests.get(o);s.stream||this._outgoingRequests.delete(o),log("response",{type_url:(n=t.response.payload)==null?void 0:n.type_url},{F:__dxlog_file$t,L:319,S:this,C:(a,c)=>a(...c)}),s.resolve(t.response)}else if(t.open){if(log("received open message",{state:this._state},{F:__dxlog_file$t,L:322,S:this,C:(o,s)=>o(...s)}),this._params.noHandshake)return;await this._sendMessage({openAck:!0})}else if(t.openAck){if(log("received openAck message",{state:this._state},{F:__dxlog_file$t,L:329,S:this,C:(o,s)=>o(...s)}),this._params.noHandshake)return;this._state="OPENED",this._remoteOpenTrigger.wake()}else if(t.streamClose){if(this._state!=="OPENED"){log("received stream close while closed",void 0,{F:__dxlog_file$t,L:338,S:this,C:(s,a)=>s(...a)});return}log("received stream close",{id:t.streamClose.id},{F:__dxlog_file$t,L:342,S:this,C:(s,a)=>s(...a)}),invariant$1(typeof t.streamClose.id=="number",void 0,{F:__dxlog_file$t,L:343,S:this,A:["typeof decoded.streamClose.id === 'number'",""]});const o=this._localStreams.get(t.streamClose.id);if(!o){log("no local stream",{id:t.streamClose.id},{F:__dxlog_file$t,L:346,S:this,C:(s,a)=>s(...a)});return}this._localStreams.delete(t.streamClose.id),await o.close()}else if(t.bye)this._byeTrigger.wake(),this._state!=="CLOSING"&&this._state!=="CLOSED"&&(log("replying to bye",void 0,{F:__dxlog_file$t,L:356,S:this,C:(o,s)=>o(...s)}),this._state="CLOSING",await this._sendMessage({bye:{}}),this._abortRequests(),this._disposeAndClose());else throw log.error("received malformed message",{msg:e},{F:__dxlog_file$t,L:364,S:this,C:(o,s)=>o(...s)}),new Error("Malformed message.")}async call(e,t,r){var o;log("calling",{method:e},{F:__dxlog_file$t,L:374,S:this,C:(s,a)=>s(...a)}),throwIfNotOpen(this._state);let n;try{const s=this._nextId++,a=new Promise((u,d)=>{this._outgoingRequests.set(s,new PendingRpcRequest(u,d,!1))}),c=this._sendMessage({request:{id:s,method:e,payload:t,stream:!1}}),l=(r==null?void 0:r.timeout)??this._params.timeout,h=l===0?a:asyncTimeout(a,l??DEFAULT_TIMEOUT$1);await Promise.race([c,h]),n=await h,invariant$1(n.id===s,void 0,{F:__dxlog_file$t,L:402,S:this,A:["response.id === id",""]})}catch(s){if(s instanceof RpcClosedError){const a=new RpcClosedError;throw a.stack+=`

 info: RPC client was closed at:
${(o=s.stack)==null?void 0:o.split(`
`).slice(1).join(`
`)}`,a}throw s}if(n.payload)return n.payload;throw n.error?decodeRpcError(n.error,e):new Error("Malformed response.")}callStream(e,t,r){throwIfNotOpen(this._state);const n=this._nextId++;return new Stream$2(({ready:o,next:s,close:a})=>{const c=u=>{if(u.streamReady)o();else if(u.close)a();else if(u.error)a(decodeRpcError(u.error,e));else if(u.payload)s(u.payload);else throw new Error("Malformed response.")},l=new StackTrace,h=u=>{u?(u.stack+=`

Error happened in the stream at:
${l.getStack()}`,a(u)):a()};return this._outgoingRequests.set(n,new PendingRpcRequest(c,h,!0)),this._sendMessage({request:{id:n,method:e,payload:t,stream:!0}}).catch(u=>{a(u)}),()=>{this._sendMessage({streamClose:{id:n}}).catch(u=>{log.catch(u,void 0,{F:__dxlog_file$t,L:475,S:this,C:(d,f)=>d(...f)})})}})}async _sendMessage(e,t){log("sending message",{type:Object.keys(e)[0]},{F:__dxlog_file$t,L:482,S:this,C:(r,n)=>r(...n)}),await this._params.port.send(RpcMessage.encode(e,{preserveAny:!0}),t)}async _callHandler(e){try{invariant$1(typeof e.id=="number",void 0,{F:__dxlog_file$t,L:488,S:this,A:["typeof req.id === 'number'",""]}),invariant$1(e.payload,void 0,{F:__dxlog_file$t,L:489,S:this,A:["req.payload",""]}),invariant$1(e.method,void 0,{F:__dxlog_file$t,L:490,S:this,A:["req.method",""]});const t=await this._params.callHandler(e.method,e.payload,this._params.handlerRpcOptions);return{id:e.id,payload:t}}catch(t){return{id:e.id,error:encodeError(t)}}}_callStreamHandler(e,t){try{invariant$1(this._params.streamHandler,"Requests with streaming responses are not supported.",{F:__dxlog_file$t,L:507,S:this,A:["this._params.streamHandler","'Requests with streaming responses are not supported.'"]}),invariant$1(typeof e.id=="number",void 0,{F:__dxlog_file$t,L:508,S:this,A:["typeof req.id === 'number'",""]}),invariant$1(e.payload,void 0,{F:__dxlog_file$t,L:509,S:this,A:["req.payload",""]}),invariant$1(e.method,void 0,{F:__dxlog_file$t,L:510,S:this,A:["req.method",""]});const r=this._params.streamHandler(e.method,e.payload,this._params.handlerRpcOptions);r.onReady(()=>{t({id:e.id,streamReady:!0})}),r.subscribe(n=>{t({id:e.id,payload:n})},n=>{t(n?{id:e.id,error:encodeError(n)}:{id:e.id,close:!0})}),this._localStreams.set(e.id,r)}catch(r){t({id:e.id,error:encodeError(r)})}}};_ts_decorate$h([synchronized],RpcPeer.prototype,"open",null);let throwIfNotOpen,__dxlog_file2$j,createServiceBundle,ProtoRpcPeer,parseMethodName;throwIfNotOpen=e=>{switch(e){case"OPENED":return;case"INITIAL":throw new RpcNotOpenError;case"CLOSED":throw new RpcClosedError}},__dxlog_file2$j="/home/runner/work/dxos/dxos/packages/core/mesh/rpc/src/service.ts",createServiceBundle=e=>e,ProtoRpcPeer=class{constructor(e,t){this.rpc=e,this._peer=t}async open(){await this._peer.open()}async close(){await this._peer.close()}async abort(){await this._peer.abort()}},createProtoRpcPeer=({requested:e,exposed:t,handlers:r,encodingOptions:n,...o})=>{const s={};if(t){invariant$1(r,void 0,{F:__dxlog_file2$j,L:93,S:void 0,A:["handlers",""]});for(const l of Object.keys(t)){const h=t[l].serviceProto.fullName.slice(1),u=r[l];s[h]=t[l].createServer(u,n)}}const a=new RpcPeer({...o,callHandler:(l,h,u)=>{const[d,f]=parseMethodName(l);if(!s[d])throw new Error(`Service not supported: ${d}`);return s[d].call(f,h,u)},streamHandler:(l,h,u)=>{const[d,f]=parseMethodName(l);if(!s[d])throw new Error(`Service not supported: ${d}`);return s[d].callStream(f,h,u)}}),c={};if(e)for(const l of Object.keys(e)){const h=e[l].serviceProto.fullName.slice(1);c[l]=e[l].createClient({call:(u,d,f)=>a.call(`${h}.${u}`,d,f),callStream:(u,d,f)=>a.callStream(`${h}.${u}`,d,f)},n)}return new ProtoRpcPeer(c,a)},parseMethodName=e=>{const t=e.lastIndexOf("."),r=e.slice(0,t),n=e.slice(t+1);if(r.length===0||n.length===0)throw new Error(`Invalid method: ${e}`);return[r,n]},createBundledRpcServer=({services:e,handlers:t,...r})=>{const n={};for(const o of Object.keys(e)){const s=e[o].serviceProto.fullName.slice(1);n[s]=e[o].createServer(t[o])}return new RpcPeer({...r,callHandler:(o,s)=>{const[a,c]=parseMethodName(o);if(!n[a])throw new Error(`Service not supported: ${a}`);return n[a].call(c,s)},streamHandler:(o,s)=>{const[a,c]=parseMethodName(o);if(!n[a])throw new Error(`Service not supported: ${a}`);return n[a].callStream(c,s)}})};const isFunction$3=e=>typeof e=="function",dual=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):r=>t(r,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(r,n){return arguments.length>=2?t(r,n):function(o){return t(o,r)}};case 3:return function(r,n,o){return arguments.length>=3?t(r,n,o):function(s){return t(s,r,n)}};case 4:return function(r,n,o,s){return arguments.length>=4?t(r,n,o,s):function(a){return t(a,r,n,o)}};case 5:return function(r,n,o,s,a){return arguments.length>=5?t(r,n,o,s,a):function(c){return t(c,r,n,o,s)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const r=arguments;return function(n){return t(n,...r)}}}},identity$1=e=>e,constant$1=e=>()=>e,constTrue=constant$1(!0),constFalse=constant$1(!1),constUndefined=constant$1(void 0);function pipe(e,t,r,n,o,s,a,c,l){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return r(t(e));case 4:return n(r(t(e)));case 5:return o(n(r(t(e))));case 6:return s(o(n(r(t(e)))));case 7:return a(s(o(n(r(t(e))))));case 8:return c(a(s(o(n(r(t(e)))))));case 9:return l(c(a(s(o(n(r(t(e))))))));default:{let h=arguments[0];for(let u=1;u<arguments.length;u++)h=arguments[u](h);return h}}}const make$s=e=>(t,r)=>t===r||e(t,r),isStrictEquivalent=(e,t)=>e===t,strict=()=>isStrictEquivalent,number$3=strict(),mapInput$1=dual(2,(e,t)=>make$s((r,n)=>e(t(r),t(n)))),Date$1=mapInput$1(number$3,e=>e.getTime()),array$1=e=>make$s((t,r)=>{if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1;return!0});let moduleVersion="3.4.1";const getCurrentVersion=()=>moduleVersion,globalStoreId=Symbol.for(`effect/GlobalValue/globalStoreId/${getCurrentVersion()}`);globalStoreId in globalThis||(globalThis[globalStoreId]=new Map);const globalStore=globalThis[globalStoreId],globalValue=(e,t)=>(globalStore.has(e)||globalStore.set(e,t()),globalStore.get(e)),isTruthy=e=>!!e,isString=e=>typeof e=="string",isNumber=e=>typeof e=="number",isBoolean=e=>typeof e=="boolean",isBigInt=e=>typeof e=="bigint",isSymbol$2=e=>typeof e=="symbol",isFunction$2=isFunction$3,isUndefined=e=>e===void 0,isNotUndefined=e=>e!==void 0,isNotNull=e=>e!==null,isNever=e=>!1,isRecordOrArray=e=>typeof e=="object"&&e!==null,isObject$3=e=>isRecordOrArray(e)||isFunction$2(e),hasProperty=dual(2,(e,t)=>isObject$3(e)&&t in e),isTagged=dual(2,(e,t)=>hasProperty(e,"_tag")&&e._tag===t),isNullable=e=>e==null,isNotNullable=e=>e!=null,isDate=e=>e instanceof Date,isIterable=e=>hasProperty(e,Symbol.iterator),isRecord=e=>isRecordOrArray(e)&&!Array.isArray(e),isPromiseLike=e=>hasProperty(e,"then")&&isFunction$2(e.then),getBugErrorMessage=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let SingleShotGen$1=class Gs{constructor(t){ie(this,"self");ie(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Gs(this.self)}};const defaultIncHi=335903614,defaultIncLo=4150755663,MUL_HI=1481765933,MUL_LO=1284865837,BIT_53=9007199254740992,BIT_27=134217728;class PCGRandom{constructor(t,r,n,o){ie(this,"_state");return isNullable(r)&&isNullable(t)?(r=Math.random()*4294967295>>>0,t=0):isNullable(r)&&(r=t,t=0),isNullable(o)&&isNullable(n)?(o=this._state?this._state[3]:defaultIncLo,n=this._state?this._state[2]:defaultIncHi):isNullable(o)&&(o=n,n=0),this._state=new Int32Array([0,0,n>>>0,((o||0)|1)>>>0]),this._next(),add64(this._state,this._state[0],this._state[1],t>>>0,r>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(t){this._state[0]=t[0],this._state[1]=t[1],this._state[2]=t[2],this._state[3]=t[3]|1}integer(t){if(!t)return this._next();if(t=t>>>0,!(t&t-1))return this._next()&t-1;let r=0;const n=(-t>>>0)%t>>>0;for(r=this._next();r<n;r=this._next());return r%t}number(){const t=(this._next()&67108863)*1,r=(this._next()&134217727)*1;return(t*BIT_27+r)/BIT_53}_next(){const t=this._state[0]>>>0,r=this._state[1]>>>0;mul64(this._state,t,r,MUL_HI,MUL_LO),add64(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let n=t>>>18,o=(r>>>18|t<<14)>>>0;n=(n^t)>>>0,o=(o^r)>>>0;const s=(o>>>27|n<<5)>>>0,a=t>>>27,c=(-a>>>0&31)>>>0;return(s>>>a|s<<c)>>>0}}function mul64(e,t,r,n,o){let s=(r>>>16)*(o&65535)>>>0,a=(r&65535)*(o>>>16)>>>0,c=(r&65535)*(o&65535)>>>0,l=(r>>>16)*(o>>>16)+((a>>>16)+(s>>>16))>>>0;a=a<<16>>>0,c=c+a>>>0,c>>>0<a>>>0&&(l=l+1>>>0),s=s<<16>>>0,c=c+s>>>0,c>>>0<s>>>0&&(l=l+1>>>0),l=l+Math.imul(r,n)>>>0,l=l+Math.imul(t,o)>>>0,e[0]=l,e[1]=c}function add64(e,t,r,n,o){let s=t+n>>>0;const a=r+o>>>0;a>>>0<r>>>0&&(s=s+1|0),e[0]=s,e[1]=a}const YieldWrapTypeId=Symbol.for("effect/Utils/YieldWrap");class YieldWrap{constructor(t){dt(this,Zn);$t(this,Zn,t)}[YieldWrapTypeId](){return Ae(this,Zn)}}Zn=new WeakMap;const structuralRegionState=globalValue("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),tracingFunction=e=>{const t={[e](r){return r()}};return function(r){return t[e](r)}},internalCall=tracingFunction("effect_internal_function"),randomHashCache=globalValue(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),symbol$1=Symbol.for("effect/Hash"),hash$1=e=>{if(structuralRegionState.enabled===!0)return 0;switch(typeof e){case"number":return number$2(e);case"bigint":return string(e.toString(10));case"boolean":return string(String(e));case"symbol":return string(String(e));case"string":return string(e);case"undefined":return string("undefined");case"function":case"object":return e===null?string("null"):e instanceof Date?hash$1(e.toISOString()):isHash(e)?e[symbol$1]():random(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},random=e=>(randomHashCache.has(e)||randomHashCache.set(e,number$2(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),randomHashCache.get(e)),combine$6=e=>t=>t*53^e,optimize=e=>e&3221225471|e>>>1&1073741824,isHash=e=>hasProperty(e,symbol$1),number$2=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return optimize(e)},string=e=>{let t=5381,r=e.length;for(;r;)t=t*33^e.charCodeAt(--r);return optimize(t)},structureKeys=(e,t)=>{let r=12289;for(let n=0;n<t.length;n++)r^=pipe(string(t[n]),combine$6(hash$1(e[t[n]])));return optimize(r)},structure=e=>structureKeys(e,Object.keys(e)),array=e=>{let t=6151;for(let r=0;r<e.length;r++)t=pipe(t,combine$6(hash$1(e[r])));return optimize(t)},cached=function(){if(arguments.length===1){const r=arguments[0];return function(n){return Object.defineProperty(r,symbol$1,{value(){return n},enumerable:!1}),n}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,symbol$1,{value(){return t},enumerable:!1}),t},symbol=Symbol.for("effect/Equal");function equals$3(){return arguments.length===1?e=>compareBoth(e,arguments[0]):compareBoth(arguments[0],arguments[1])}function compareBoth(e,t){if(e===t)return!0;const r=typeof e;if(r!==typeof t)return!1;if(r==="object"||r==="function"){if(e!==null&&t!==null){if(isEqual(e)&&isEqual(t))return hash$1(e)===hash$1(t)&&e[symbol](t)?!0:structuralRegionState.enabled&&structuralRegionState.tester?structuralRegionState.tester(e,t):!1;if(e instanceof Date&&t instanceof Date)return e.toISOString()===t.toISOString()}if(structuralRegionState.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((n,o)=>compareBoth(n,t[o]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(e)===Object.prototype){const n=Object.keys(e),o=Object.keys(t);if(n.length===o.length){for(const s of n)if(!(s in t&&compareBoth(e[s],t[s])))return structuralRegionState.tester?structuralRegionState.tester(e,t):!1;return!0}}return structuralRegionState.tester?structuralRegionState.tester(e,t):!1}}return structuralRegionState.enabled&&structuralRegionState.tester?structuralRegionState.tester(e,t):!1}const isEqual=e=>hasProperty(e,symbol),equivalence=()=>equals$3,NodeInspectSymbol=Symbol.for("nodejs.util.inspect.custom"),toJSON$1=e=>hasProperty(e,"toJSON")&&isFunction$2(e.toJSON)&&e.toJSON.length===0?e.toJSON():Array.isArray(e)?e.map(toJSON$1):e,format$3=e=>JSON.stringify(e,null,2),toStringUnknown=(e,t=2)=>{try{return typeof e=="object"?stringifyCircular(e,t):String(e)}catch{return String(e)}},stringifyCircular=(e,t)=>{let r=[];const n=JSON.stringify(e,(o,s)=>typeof s=="object"&&s!==null?r.includes(s)?void 0:r.push(s)&&s:s,t);return r=void 0,n},pipeArguments=(e,t)=>{switch(t.length){case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let r=e;for(let n=0,o=t.length;n<o;n++)r=t[n](r);return r}}},OP_ASYNC="Async",OP_COMMIT="Commit",OP_FAILURE="Failure",OP_ON_FAILURE="OnFailure",OP_ON_SUCCESS="OnSuccess",OP_ON_SUCCESS_AND_FAILURE="OnSuccessAndFailure",OP_SUCCESS="Success",OP_SYNC="Sync",OP_TAG="Tag",OP_UPDATE_RUNTIME_FLAGS="UpdateRuntimeFlags",OP_WHILE="While",OP_WITH_RUNTIME="WithRuntime",OP_YIELD="Yield",OP_REVERT_FLAGS="RevertFlags",EffectTypeId$2=Symbol.for("effect/Effect"),StreamTypeId=Symbol.for("effect/Stream"),SinkTypeId=Symbol.for("effect/Sink"),ChannelTypeId=Symbol.for("effect/Channel"),effectVariance={_R:e=>e,_E:e=>e,_A:e=>e,_V:getCurrentVersion()},sinkVariance={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},channelVariance={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},EffectPrototype={[EffectTypeId$2]:effectVariance,[StreamTypeId]:effectVariance,[SinkTypeId]:sinkVariance,[ChannelTypeId]:channelVariance,[symbol](e){return this===e},[symbol$1](){return cached(this,random(this))},[Symbol.iterator](){return new SingleShotGen$1(new YieldWrap(this))},pipe(){return pipeArguments(this,arguments)}},StructuralPrototype={[symbol$1](){return cached(this,structure(this))},[symbol](e){const t=Object.keys(this),r=Object.keys(e);if(t.length!==r.length)return!1;for(const n of t)if(!(n in e&&equals$3(this[n],e[n])))return!1;return!0}},CommitPrototype={...EffectPrototype,_op:OP_COMMIT},StructuralCommitPrototype={...CommitPrototype,...StructuralPrototype},TypeId$a=Symbol.for("effect/Option"),CommonProto$1={...EffectPrototype,[TypeId$a]:{_A:e=>e},[NodeInspectSymbol](){return this.toJSON()},toString(){return format$3(this.toJSON())}},SomeProto=Object.assign(Object.create(CommonProto$1),{_tag:"Some",_op:"Some",[symbol](e){return isOption$1(e)&&isSome$1(e)&&equals$3(this.value,e.value)},[symbol$1](){return cached(this,combine$6(hash$1(this._tag))(hash$1(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:toJSON$1(this.value)}}}),NoneHash=hash$1("None"),NoneProto=Object.assign(Object.create(CommonProto$1),{_tag:"None",_op:"None",[symbol](e){return isOption$1(e)&&isNone$1(e)},[symbol$1](){return NoneHash},toJSON(){return{_id:"Option",_tag:this._tag}}}),isOption$1=e=>hasProperty(e,TypeId$a),isNone$1=e=>e._tag==="None",isSome$1=e=>e._tag==="Some",none$5=Object.create(NoneProto),some$1=e=>{const t=Object.create(SomeProto);return t.value=e,t},TypeId$9=Symbol.for("effect/Either"),CommonProto={...EffectPrototype,[TypeId$9]:{_R:e=>e},[NodeInspectSymbol](){return this.toJSON()},toString(){return format$3(this.toJSON())}},RightProto=Object.assign(Object.create(CommonProto),{_tag:"Right",_op:"Right",[symbol](e){return isEither(e)&&isRight$1(e)&&equals$3(this.right,e.right)},[symbol$1](){return combine$6(hash$1(this._tag))(hash$1(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:toJSON$1(this.right)}}}),LeftProto=Object.assign(Object.create(CommonProto),{_tag:"Left",_op:"Left",[symbol](e){return isEither(e)&&isLeft$1(e)&&equals$3(this.left,e.left)},[symbol$1](){return combine$6(hash$1(this._tag))(hash$1(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:toJSON$1(this.left)}}}),isEither=e=>hasProperty(e,TypeId$9),isLeft$1=e=>e._tag==="Left",isRight$1=e=>e._tag==="Right",left$1=e=>{const t=Object.create(LeftProto);return t.left=e,t},right$1=e=>{const t=Object.create(RightProto);return t.right=e,t},fromOption$2=dual(2,(e,t)=>isNone$1(e)?left$1(t()):right$1(e.value)),right=right$1,left=left$1,fromOption$1=fromOption$2,isLeft=isLeft$1,isRight=isRight$1,match$4=dual(2,(e,{onLeft:t,onRight:r})=>isLeft(e)?t(e.left):r(e.right)),merge$4=match$4({onLeft:identity$1,onRight:identity$1}),getOrThrowWith$1=dual(2,(e,t)=>{if(isRight(e))return e.right;throw t(e.left)}),isNonEmptyArray$1=e=>e.length>0,make$r=e=>(t,r)=>t===r?0:e(t,r),number$1=make$r((e,t)=>e<t?-1:1),mapInput=dual(2,(e,t)=>make$r((r,n)=>e(t(r),t(n)))),greaterThan$2=e=>dual(2,(t,r)=>e(t,r)===1),none$4=()=>none$5,some=some$1,isOption=isOption$1,isNone=isNone$1,isSome=isSome$1,match$3=dual(2,(e,{onNone:t,onSome:r})=>isNone(e)?t():r(e.value)),getOrElse=dual(2,(e,t)=>isNone(e)?t():e.value),orElse$2=dual(2,(e,t)=>isNone(e)?t():e),orElseSome=dual(2,(e,t)=>isNone(e)?some(t()):e),fromNullable=e=>e==null?none$4():some(e),getOrUndefined=getOrElse(constUndefined),liftThrowable=e=>(...t)=>{try{return some(e(...t))}catch{return none$4()}},getOrThrowWith=dual(2,(e,t)=>{if(isSome(e))return e.value;throw t()}),getOrThrow=getOrThrowWith(()=>new Error("getOrThrow called on a None")),map$6=dual(2,(e,t)=>isNone(e)?none$4():some(t(e.value))),flatMap$4=dual(2,(e,t)=>isNone(e)?none$4():t(e.value)),filterMap$1=dual(2,(e,t)=>isNone(e)?none$4():t(e.value)),filter$1=dual(2,(e,t)=>filterMap$1(e,r=>t(r)?some$1(r):none$5)),getEquivalence$3=e=>make$s((t,r)=>isNone(t)?isNone(r):isNone(r)?!1:e(t.value,r.value)),containsWith$1=e=>dual(2,(t,r)=>isNone(t)?!1:e(t.value,r)),_equivalence$3=equivalence(),contains=containsWith$1(_equivalence$3),make$q=(...e)=>e,findFirst$1=dual(2,(e,t)=>{let r=0;for(const n of e){const o=t(n,r);if(isBoolean(o)){if(o)return some(n)}else if(isSome(o))return o;r++}return none$4()}),empty$l=()=>({}),isEmptyRecord=e=>keys$2(e).length===0,has$4=dual(2,(e,t)=>Object.prototype.hasOwnProperty.call(e,t)),filterMap=dual(2,(e,t)=>{const r=empty$l();for(const n of keys$2(e)){const o=t(e[n],n);isSome(o)&&(r[n]=o.value)}return r}),getSomes=filterMap(identity$1),keys$2=e=>Object.keys(e),allocate=e=>new Array(e),makeBy=(e,t)=>{const r=Math.max(1,Math.floor(e)),n=new Array(r);for(let o=0;o<r;o++)n[o]=t(o);return n},fromIterable$6=e=>Array.isArray(e)?e:Array.from(e),match$2=dual(2,(e,{onEmpty:t,onNonEmpty:r})=>isNonEmptyReadonlyArray(e)?r(e):t()),matchLeft=dual(2,(e,{onEmpty:t,onNonEmpty:r})=>isNonEmptyReadonlyArray(e)?r(headNonEmpty$1(e),tailNonEmpty$1(e)):t()),prepend$2=dual(2,(e,t)=>[t,...e]),append$1=dual(2,(e,t)=>[...e,t]),appendAll$2=dual(2,(e,t)=>fromIterable$6(e).concat(fromIterable$6(t))),isArray$3=Array.isArray,isEmptyArray=e=>e.length===0,isEmptyReadonlyArray=isEmptyArray,isNonEmptyArray=isNonEmptyArray$1,isNonEmptyReadonlyArray=isNonEmptyArray$1,isOutOfBound=(e,t)=>e<0||e>=t.length,clamp=(e,t)=>Math.floor(Math.min(Math.max(0,e),t.length)),get$9=dual(2,(e,t)=>{const r=Math.floor(t);return isOutOfBound(r,e)?none$4():some(e[r])}),unsafeGet$3=dual(2,(e,t)=>{const r=Math.floor(t);if(isOutOfBound(r,e))throw new Error(`Index ${r} out of bounds`);return e[r]}),head$4=get$9(0),headNonEmpty$1=unsafeGet$3(0),last=e=>isNonEmptyReadonlyArray(e)?some(lastNonEmpty(e)):none$4(),lastNonEmpty=e=>e[e.length-1],tailNonEmpty$1=e=>e.slice(1),spanIndex=(e,t)=>{let r=0;for(const n of e){if(!t(n,r))break;r++}return r},span$1=dual(2,(e,t)=>splitAt(e,spanIndex(e,t))),drop$1=dual(2,(e,t)=>{const r=fromIterable$6(e);return r.slice(clamp(t,r),r.length)}),findFirst=findFirst$1,reverse$2=e=>Array.from(e).reverse(),sort=dual(2,(e,t)=>{const r=Array.from(e);return r.sort(t),r}),zip$1=dual(2,(e,t)=>zipWith(e,t,make$q)),zipWith=dual(3,(e,t,r)=>{const n=fromIterable$6(e),o=fromIterable$6(t);if(isNonEmptyReadonlyArray(n)&&isNonEmptyReadonlyArray(o)){const s=[r(headNonEmpty$1(n),headNonEmpty$1(o))],a=Math.min(n.length,o.length);for(let c=1;c<a;c++)s[c]=r(n[c],o[c]);return s}return[]}),containsWith=e=>dual(2,(t,r)=>{for(const n of t)if(e(r,n))return!0;return!1}),_equivalence$2=equivalence(),splitAt=dual(2,(e,t)=>{const r=Array.from(e),n=Math.floor(t);return isNonEmptyReadonlyArray(r)?n>=1?splitNonEmptyAt(r,n):[[],r]:[r,[]]}),splitNonEmptyAt=dual(2,(e,t)=>{const r=Math.max(1,Math.floor(t));return r>=e.length?[copy$1(e),[]]:[prepend$2(e.slice(1,r),headNonEmpty$1(e)),e.slice(r)]}),copy$1=e=>e.slice(),unionWith=dual(3,(e,t,r)=>{const n=fromIterable$6(e),o=fromIterable$6(t);return isNonEmptyReadonlyArray(n)?isNonEmptyReadonlyArray(o)?dedupeWith(r)(appendAll$2(n,o)):n:o}),union$2=dual(2,(e,t)=>unionWith(e,t,_equivalence$2)),intersectionWith=e=>{const t=containsWith(e);return dual(2,(r,n)=>fromIterable$6(r).filter(o=>t(n,o)))},intersection=intersectionWith(_equivalence$2),empty$k=()=>[],of$2=e=>[e],map$5=dual(2,(e,t)=>e.map(t)),flatMap$3=dual(2,(e,t)=>{if(isEmptyReadonlyArray(e))return[];const r=[];for(let n=0;n<e.length;n++){const o=t(e[n],n);for(let s=0;s<o.length;s++)r.push(o[s])}return r}),flatten$3=flatMap$3(identity$1),reduce$7=dual(3,(e,t,r)=>fromIterable$6(e).reduce((n,o,s)=>r(n,o,s),t)),unfold=(e,t)=>{const r=[];let n=e,o;for(;isSome(o=t(n));){const[s,a]=o.value;r.push(s),n=a}return r},getEquivalence$2=array$1,dedupeWith=dual(2,(e,t)=>{const r=fromIterable$6(e);if(isNonEmptyReadonlyArray(r)){const n=[headNonEmpty$1(r)],o=tailNonEmpty$1(r);for(const s of o)n.every(a=>!t(s,a))&&n.push(s);return n}return[]}),dedupe=e=>dedupeWith(e,equivalence()),join$1=dual(2,(e,t)=>fromIterable$6(e).join(t)),Order$1=number$1,parse$2=e=>{if(e==="NaN")return some$1(NaN);if(e==="Infinity")return some$1(1/0);if(e==="-Infinity")return some$1(-1/0);if(e.trim()==="")return none$5;const t=Number(e);return Number.isNaN(t)?none$5:some$1(t)},escape=e=>e.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),getKeysForIndexSignature=(e,t)=>{switch(t._tag){case"StringKeyword":case"TemplateLiteral":return Object.keys(e);case"SymbolKeyword":return Object.getOwnPropertySymbols(e);case"Refinement":return getKeysForIndexSignature(e,t.from)}},ownKeys=e=>Object.keys(e).concat(Object.getOwnPropertySymbols(e)),memoizeThunk=e=>{let t=!1,r;return()=>(t||(r=e(),t=!0),r)},formatUnknown=e=>{if(isString(e))return JSON.stringify(e);if(isNumber(e)||e==null||isBoolean(e)||isSymbol$2(e)||isDate(e))return String(e);if(isBigInt(e))return String(e)+"n";if(!Array.isArray(e)&&hasProperty(e,"toString")&&isFunction$2(e.toString)&&e.toString!==Object.prototype.toString)return e.toString();try{return JSON.stringify(e),Array.isArray(e)?`[${e.map(formatUnknown).join(",")}]`:`{${ownKeys(e).map(t=>`${isString(t)?JSON.stringify(t):String(t)}:${formatUnknown(e[t])}`).join(",")}}`}catch{return String(e)}},formatPropertyKey$1=e=>typeof e=="string"?JSON.stringify(e):String(e),getDuplicatePropertySignatureErrorMessage=e=>`Duplicate property signature ${formatUnknown(e)}`,getErrorMessage=(e,t)=>`${e}: ${t}`,getErrorMessageWithPath=(e,t)=>{let r=e;return t.length>0&&(r+=` (path [${t.map(formatPropertyKey$1).join(", ")}])`),r},TypeAnnotationId=Symbol.for("@effect/schema/annotation/Type"),MessageAnnotationId=Symbol.for("@effect/schema/annotation/Message"),IdentifierAnnotationId=Symbol.for("@effect/schema/annotation/Identifier"),TitleAnnotationId=Symbol.for("@effect/schema/annotation/Title"),DescriptionAnnotationId=Symbol.for("@effect/schema/annotation/Description"),ExamplesAnnotationId=Symbol.for("@effect/schema/annotation/Examples"),DefaultAnnotationId=Symbol.for("@effect/schema/annotation/Default"),JSONSchemaAnnotationId=Symbol.for("@effect/schema/annotation/JSONSchema"),DocumentationAnnotationId=Symbol.for("@effect/schema/annotation/Documentation"),ConcurrencyAnnotationId=Symbol.for("@effect/schema/annotation/Concurrency"),BatchingAnnotationId=Symbol.for("@effect/schema/annotation/Batching"),ParseIssueTitleAnnotationId=Symbol.for("@effect/schema/annotation/ParseIssueTitle"),SurrogateAnnotationId=Symbol.for("@effect/schema/annotation/Surrogate"),getAnnotation=dual(2,(e,t)=>Object.prototype.hasOwnProperty.call(e.annotations,t)?some(e.annotations[t]):none$4()),getMessageAnnotation=getAnnotation(MessageAnnotationId),getTitleAnnotation=getAnnotation(TitleAnnotationId),getIdentifierAnnotation=getAnnotation(IdentifierAnnotationId),getDescriptionAnnotation=getAnnotation(DescriptionAnnotationId),getExamplesAnnotation=getAnnotation(ExamplesAnnotationId),getDefaultAnnotation=getAnnotation(DefaultAnnotationId),getJSONSchemaAnnotation=getAnnotation(JSONSchemaAnnotationId),getConcurrencyAnnotation=getAnnotation(ConcurrencyAnnotationId),getBatchingAnnotation=getAnnotation(BatchingAnnotationId),getParseIssueTitleAnnotation$1=getAnnotation(ParseIssueTitleAnnotationId),getSurrogateAnnotation=getAnnotation(SurrogateAnnotationId),JSONIdentifierAnnotationId=Symbol.for("@effect/schema/annotation/JSONIdentifier"),getJSONIdentifierAnnotation=getAnnotation(JSONIdentifierAnnotationId);let Declaration$1=class{constructor(e,t,r,n={}){ie(this,"typeParameters");ie(this,"decodeUnknown");ie(this,"encodeUnknown");ie(this,"annotations");ie(this,"_tag","Declaration");this.typeParameters=e,this.decodeUnknown=t,this.encodeUnknown=r,this.annotations=n}toString(e=!1){return getOrElse(getExpected(this,e),()=>"<declaration schema>")}toJSON(){return{_tag:this._tag,typeParameters:this.typeParameters.map(e=>e.toJSON()),annotations:toJSONAnnotations(this.annotations)}}};const createASTGuard=e=>t=>t._tag===e;let Literal$1=class{constructor(e,t={}){ie(this,"literal");ie(this,"annotations");ie(this,"_tag","Literal");this.literal=e,this.annotations=t}toString(e=!1){return getOrElse(getExpected(this,e),()=>formatUnknown(this.literal))}toJSON(){return{_tag:this._tag,literal:isBigInt(this.literal)?String(this.literal):this.literal,annotations:toJSONAnnotations(this.annotations)}}};const isLiteral=createASTGuard("Literal"),$null=new Literal$1(null,{[IdentifierAnnotationId]:"null"});class UniqueSymbol{constructor(t,r={}){ie(this,"symbol");ie(this,"annotations");ie(this,"_tag","UniqueSymbol");this.symbol=t,this.annotations=r}toString(t=!1){return getOrElse(getExpected(this,t),()=>formatUnknown(this.symbol))}toJSON(){return{_tag:this._tag,symbol:String(this.symbol),annotations:toJSONAnnotations(this.annotations)}}}class UndefinedKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","UndefinedKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const undefinedKeyword=new UndefinedKeyword({[TitleAnnotationId]:"undefined"}),isUndefinedKeyword=createASTGuard("UndefinedKeyword");class VoidKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","VoidKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const voidKeyword=new VoidKeyword({[TitleAnnotationId]:"void"});class NeverKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","NeverKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const neverKeyword=new NeverKeyword({[TitleAnnotationId]:"never"});class UnknownKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","UnknownKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const unknownKeyword=new UnknownKeyword({[TitleAnnotationId]:"unknown"});class AnyKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","AnyKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const anyKeyword=new AnyKeyword({[TitleAnnotationId]:"any"}),isAnyKeyword=createASTGuard("AnyKeyword");class StringKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","StringKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const stringKeyword=new StringKeyword({[TitleAnnotationId]:"string",[DescriptionAnnotationId]:"a string"}),isStringKeyword=createASTGuard("StringKeyword");class NumberKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","NumberKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const numberKeyword=new NumberKeyword({[TitleAnnotationId]:"number",[DescriptionAnnotationId]:"a number"}),isNumberKeyword=createASTGuard("NumberKeyword");class BooleanKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","BooleanKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const booleanKeyword=new BooleanKeyword({[TitleAnnotationId]:"boolean",[DescriptionAnnotationId]:"a boolean"});class BigIntKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","BigIntKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const bigIntKeyword=new BigIntKeyword({[TitleAnnotationId]:"bigint",[DescriptionAnnotationId]:"a bigint"});class SymbolKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","SymbolKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const symbolKeyword=new SymbolKeyword({[TitleAnnotationId]:"symbol",[DescriptionAnnotationId]:"a symbol"}),isSymbolKeyword=createASTGuard("SymbolKeyword");class ObjectKeyword{constructor(t={}){ie(this,"annotations");ie(this,"_tag","ObjectKeyword");this.annotations=t}toString(t=!1){return formatKeyword(this,t)}toJSON(){return{_tag:this._tag,annotations:toJSONAnnotations(this.annotations)}}}const objectKeyword=new ObjectKeyword({[IdentifierAnnotationId]:"object",[TitleAnnotationId]:"object",[DescriptionAnnotationId]:"an object in the TypeScript meaning, i.e. the `object` type"}),isObjectKeyword=createASTGuard("ObjectKeyword");let Enums$1=class{constructor(e,t={}){ie(this,"enums");ie(this,"annotations");ie(this,"_tag","Enums");this.enums=e,this.annotations=t}toString(e=!1){return getOrElse(getExpected(this,e),()=>`<enum ${this.enums.length} value(s): ${this.enums.map((t,r)=>JSON.stringify(r)).join(" | ")}>`)}toJSON(){return{_tag:this._tag,enums:this.enums,annotations:toJSONAnnotations(this.annotations)}}};class Element{constructor(t,r){ie(this,"type");ie(this,"isOptional");this.type=t,this.isOptional=r}toJSON(){return{type:this.type.toJSON(),isOptional:this.isOptional}}toString(){return String(this.type)+(this.isOptional?"?":"")}}let TupleType$1=class{constructor(e,t,r,n={}){ie(this,"elements");ie(this,"rest");ie(this,"isReadonly");ie(this,"annotations");ie(this,"_tag","TupleType");this.elements=e,this.rest=t,this.isReadonly=r,this.annotations=n;let o=!1,s=!1;for(const a of e)if(a.isOptional)o=!0;else if(o){s=!0;break}if(s||o&&t.length>1)throw new Error(getRequiredElementFollowinAnOptionalElementErrorMessage)}toString(e=!1){return getOrElse(getExpected(this,e),()=>formatTuple(this))}toJSON(){return{_tag:this._tag,elements:this.elements.map(e=>e.toJSON()),rest:this.rest.map(e=>e.toJSON()),isReadonly:this.isReadonly,annotations:toJSONAnnotations(this.annotations)}}};const formatTuple=e=>{const t=e.elements.map(String).join(", ");return matchLeft(e.rest,{onEmpty:()=>`readonly [${t}]`,onNonEmpty:(r,n)=>{const o=String(r),s=o.includes(" | ")?`(${o})`:o;if(n.length>0){const a=n.map(String).join(", ");return e.elements.length>0?`readonly [${t}, ...${s}[], ${a}]`:`readonly [...${s}[], ${a}]`}else return e.elements.length>0?`readonly [${t}, ...${s}[]]`:`ReadonlyArray<${o}>`}})},isTupleType=createASTGuard("TupleType");class PropertySignature{constructor(t,r,n,o,s={}){ie(this,"name");ie(this,"type");ie(this,"isOptional");ie(this,"isReadonly");ie(this,"annotations");this.name=t,this.type=r,this.isOptional=n,this.isReadonly=o,this.annotations=s}toJSON(){return{name:String(this.name),type:this.type.toJSON(),isOptional:this.isOptional,isReadonly:this.isReadonly,annotations:toJSONAnnotations(this.annotations)}}}const isParameter=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return!0;case"Refinement":return isParameter(e.from)}return!1};class IndexSignature{constructor(t,r,n){ie(this,"type");ie(this,"isReadonly");ie(this,"parameter");if(this.type=r,this.isReadonly=n,isParameter(t))this.parameter=t;else throw new Error(getIndexSignatureParameterErrorMessage)}toJSON(){return{parameter:this.parameter.toJSON(),type:this.type.toJSON(),isReadonly:this.isReadonly}}}let TypeLiteral$1=class{constructor(e,t,r={}){ie(this,"annotations");ie(this,"_tag","TypeLiteral");ie(this,"propertySignatures");ie(this,"indexSignatures");this.annotations=r;const n={};for(let s=0;s<e.length;s++){const a=e[s].name;if(Object.prototype.hasOwnProperty.call(n,a))throw new Error(getDuplicatePropertySignatureErrorMessage(a));n[a]=null}const o={string:!1,symbol:!1};for(let s=0;s<t.length;s++){const a=getParameterBase(t[s].parameter);if(isStringKeyword(a)){if(o.string)throw new Error(getDuplicateIndexSignatureErrorMessage("string"));o.string=!0}else if(isSymbolKeyword(a)){if(o.symbol)throw new Error(getDuplicateIndexSignatureErrorMessage("symbol"));o.symbol=!0}}this.propertySignatures=sortPropertySignatures(e),this.indexSignatures=sortIndexSignatures(t)}toString(e=!1){return getOrElse(getExpected(this,e),()=>formatTypeLiteral(this))}toJSON(){return{_tag:this._tag,propertySignatures:this.propertySignatures.map(e=>e.toJSON()),indexSignatures:this.indexSignatures.map(e=>e.toJSON()),annotations:toJSONAnnotations(this.annotations)}}};const formatTypeLiteral=e=>{const t=e.propertySignatures.map(r=>(r.isReadonly?"readonly ":"")+String(r.name)+(r.isOptional?"?":"")+": "+r.type).join("; ");if(e.indexSignatures.length>0){const r=e.indexSignatures.map(n=>(n.isReadonly?"readonly ":"")+`[x: ${getParameterBase(n.parameter)}]: ${n.type}`).join("; ");return e.propertySignatures.length>0?`{ ${t}; ${r} }`:`{ ${r} }`}else return e.propertySignatures.length>0?`{ ${t} }`:"{}"},isTypeLiteral=createASTGuard("TypeLiteral"),removeNevers=e=>e.filter(t=>t!==neverKeyword),sortCandidates=sort(mapInput(Order$1,e=>{switch(e._tag){case"AnyKeyword":return 0;case"UnknownKeyword":return 1;case"ObjectKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3}return 4})),literalMap={string:"StringKeyword",number:"NumberKeyword",boolean:"BooleanKeyword",bigint:"BigIntKeyword"},flatten$2=e=>flatMap$3(e,t=>isUnion(t)?flatten$2(t.types):[t]),unify=e=>{const t=sortCandidates(e),r=[],n={},o=[];for(const s of t)switch(s._tag){case"NeverKeyword":break;case"AnyKeyword":return[anyKeyword];case"UnknownKeyword":return[unknownKeyword];case"ObjectKeyword":case"UndefinedKeyword":case"VoidKeyword":case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":{n[s._tag]||(n[s._tag]=s,r.push(s));break}case"Literal":{const a=typeof s.literal;switch(a){case"string":case"number":case"bigint":case"boolean":{const c=literalMap[a];!n[c]&&!o.includes(s.literal)&&(o.push(s.literal),r.push(s));break}case"object":{o.includes(s.literal)||(o.push(s.literal),r.push(s));break}}break}case"UniqueSymbol":{!n.SymbolKeyword&&!o.includes(s.symbol)&&(o.push(s.symbol),r.push(s));break}case"TupleType":{n.ObjectKeyword||r.push(s);break}case"TypeLiteral":{s.propertySignatures.length===0&&s.indexSignatures.length===0?n["{}"]||(n["{}"]=s,r.push(s)):n.ObjectKeyword||r.push(s);break}default:r.push(s)}return r};let Union$2=(kr=class{constructor(t,r={}){ie(this,"types");ie(this,"annotations");ie(this,"_tag","Union");this.types=t,this.annotations=r}toString(t=!1){return getOrElse(getExpected(this,t),()=>this.types.map(String).join(" | "))}toJSON(){return{_tag:this._tag,types:this.types.map(t=>t.toJSON()),annotations:toJSONAnnotations(this.annotations)}}},ie(kr,"make",(t,r)=>{const n=[],o=new Set;for(let s=0;s<t.length;s++){const a=t[s];a===neverKeyword||o.has(a)||(o.add(a),n.push(a))}return kr.union(n,r)}),ie(kr,"members",(t,r)=>kr.union(removeNevers(t),r)),ie(kr,"unify",(t,r)=>kr.union(unify(flatten$2(t)),r)),ie(kr,"union",(t,r)=>isMembers(t)?new kr(t,r):t.length===1?t[0]:neverKeyword),kr);const mapMembers=(e,t)=>e.map(t),isMembers=e=>e.length>1,isUnion=createASTGuard("Union"),toJSONMemoMap=globalValue(Symbol.for("@effect/schema/AST/toJSONMemoMap"),()=>new WeakMap);class Suspend{constructor(t,r={}){ie(this,"f");ie(this,"annotations");ie(this,"_tag","Suspend");this.f=t,this.annotations=r,this.f=memoizeThunk(t)}toString(t=!1){return getExpected(this,t).pipe(orElse$2(()=>flatMap$4(liftThrowable(this.f)(),r=>getExpected(r,t))),getOrElse(()=>"<suspended schema>"))}toJSON(){const t=this.f();let r=toJSONMemoMap.get(t);return r||(toJSONMemoMap.set(t,{_tag:this._tag}),r={_tag:this._tag,ast:t.toJSON(),annotations:toJSONAnnotations(this.annotations)},toJSONMemoMap.set(t,r),r)}}const isSuspend=createASTGuard("Suspend");let Refinement$1=class{constructor(e,t,r={}){ie(this,"from");ie(this,"filter");ie(this,"annotations");ie(this,"_tag","Refinement");this.from=e,this.filter=t,this.annotations=r}toString(e=!1){return getOrElse(getExpected(this,e),()=>`{ ${this.from} | filter }`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),annotations:toJSONAnnotations(this.annotations)}}};const isRefinement=createASTGuard("Refinement"),defaultParseOption={};let Transformation$1=class{constructor(e,t,r,n={}){ie(this,"from");ie(this,"to");ie(this,"transformation");ie(this,"annotations");ie(this,"_tag","Transformation");this.from=e,this.to=t,this.transformation=r,this.annotations=n}toString(e=!1){return getOrElse(getExpected(this,e),()=>`(${String(this.from)} <-> ${String(this.to)})`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),to:this.to.toJSON(),annotations:toJSONAnnotations(this.annotations)}}};const isTransformation=createASTGuard("Transformation");class FinalTransformation{constructor(t,r){ie(this,"decode");ie(this,"encode");ie(this,"_tag","FinalTransformation");this.decode=t,this.encode=r}}const createTransformationGuard=e=>t=>t._tag===e;class ComposeTransformation{constructor(){ie(this,"_tag","ComposeTransformation")}}const composeTransformation=new ComposeTransformation;let PropertySignatureTransformation$1=class{constructor(e,t,r,n){ie(this,"from");ie(this,"to");ie(this,"decode");ie(this,"encode");this.from=e,this.to=t,this.decode=r,this.encode=n}};const isRenamingPropertySignatureTransformation=e=>e.decode===identity$1&&e.encode===identity$1;class TypeLiteralTransformation{constructor(t){ie(this,"propertySignatureTransformations");ie(this,"_tag","TypeLiteralTransformation");this.propertySignatureTransformations=t;const r={},n={};for(const o of t){const s=o.from;if(r[s])throw new Error(getDuplicatePropertySignatureTransformationErrorMessage(s));r[s]=!0;const a=o.to;if(n[a])throw new Error(getDuplicatePropertySignatureTransformationErrorMessage(a));n[a]=!0}}}const isTypeLiteralTransformation=createTransformationGuard("TypeLiteralTransformation"),annotations=(e,t)=>{const r=Object.getOwnPropertyDescriptors(e);return r.annotations.value={...e.annotations,...t},Object.create(Object.getPrototypeOf(e),r)},STRING_KEYWORD_PATTERN=".*",NUMBER_KEYWORD_PATTERN="[+-]?\\d*\\.?\\d+(?:[Ee][+-]?\\d+)?",getTemplateLiteralRegExp=e=>{let t=`^${escape(e.head)}`;for(const r of e.spans)isStringKeyword(r.type)?t+=STRING_KEYWORD_PATTERN:isNumberKeyword(r.type)&&(t+=NUMBER_KEYWORD_PATTERN),t+=escape(r.literal);return t+="$",new RegExp(t)},getPropertySignatures=e=>{switch(e._tag){case"Declaration":{const t=getSurrogateAnnotation(e);if(isSome(t))return getPropertySignatures(t.value);break}case"TypeLiteral":return e.propertySignatures.slice();case"Suspend":return getPropertySignatures(e.f())}return getPropertyKeys(e).map(t=>getPropertyKeyIndexedAccess(e,t))},getPropertyKeyIndexedAccess=(e,t)=>{switch(e._tag){case"Declaration":{const r=getSurrogateAnnotation(e);if(isSome(r))return getPropertyKeyIndexedAccess(r.value,t);break}case"TypeLiteral":{const r=findFirst(e.propertySignatures,n=>n.name===t);if(isSome(r))return r.value;if(isString(t))for(const n of e.indexSignatures){const o=getParameterBase(n.parameter);switch(o._tag){case"TemplateLiteral":{if(getTemplateLiteralRegExp(o).test(t))return new PropertySignature(t,n.type,!1,!0);break}case"StringKeyword":return new PropertySignature(t,n.type,!1,!0)}}else if(isSymbol$2(t))for(const n of e.indexSignatures){const o=getParameterBase(n.parameter);if(isSymbolKeyword(o))return new PropertySignature(t,n.type,!1,!0)}break}case"Union":return new PropertySignature(t,Union$2.make(e.types.map(r=>getPropertyKeyIndexedAccess(r,t).type)),!1,!0);case"Suspend":return getPropertyKeyIndexedAccess(e.f(),t)}return new PropertySignature(t,neverKeyword,!1,!0)},getPropertyKeys=e=>{switch(e._tag){case"Declaration":{const t=getSurrogateAnnotation(e);if(isSome(t))return getPropertyKeys(t.value);break}case"TypeLiteral":return e.propertySignatures.map(t=>t.name);case"Suspend":return getPropertyKeys(e.f());case"Union":return e.types.slice(1).reduce((t,r)=>intersection(t,getPropertyKeys(r)),getPropertyKeys(e.types[0]));case"Transformation":return getPropertyKeys(e.to)}return[]},record=(e,t)=>{const r=[],n=[],o=s=>{switch(s._tag){case"NeverKeyword":break;case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":case"Refinement":n.push(new IndexSignature(s,t,!0));break;case"Literal":if(isString(s.literal)||isNumber(s.literal))r.push(new PropertySignature(s.literal,t,!1,!0));else throw new Error(getErrorMessage("record",`unsupported literal (${formatUnknown(s.literal)})`));break;case"Enums":{for(const[a,c]of s.enums)r.push(new PropertySignature(c,t,!1,!0));break}case"UniqueSymbol":r.push(new PropertySignature(s.symbol,t,!1,!0));break;case"Union":s.types.forEach(o);break;default:throw new Error(getErrorMessage("record",`unsupported key schema (${s})`))}};return o(e),{propertySignatures:r,indexSignatures:n}},pick=(e,t)=>{if(isTransformation(e))switch(e.transformation._tag){case"ComposeTransformation":return new Transformation$1(pick(e.from,t),pick(e.to,t),composeTransformation);case"TypeLiteralTransformation":{const r=[],n=[];for(const o of t){const s=e.transformation.propertySignatureTransformations.find(a=>a.to===o);s?(r.push(s),n.push(s.from)):n.push(o)}return isNonEmptyReadonlyArray(r)?new Transformation$1(pick(e.from,n),pick(e.to,t),new TypeLiteralTransformation(r)):pick(e.from,n)}case"FinalTransformation":{const r=getSurrogateAnnotation(e);if(isSome(r))return pick(r.value,t);throw new Error(getErrorMessage("pick","cannot handle this kind of transformation"))}}return new TypeLiteral$1(t.map(r=>getPropertyKeyIndexedAccess(e,r)),[])},omit=(e,t)=>pick(e,getPropertyKeys(e).filter(r=>!t.includes(r))),orUndefined=e=>Union$2.make([e,undefinedKeyword]),partial$1=(e,t)=>{const r=(t==null?void 0:t.exact)===!0;switch(e._tag){case"TupleType":return new TupleType$1(e.elements.map(n=>new Element(r?n.type:orUndefined(n.type),!0)),match$2(e.rest,{onEmpty:()=>e.rest,onNonEmpty:n=>[Union$2.make([...n,undefinedKeyword])]}),e.isReadonly);case"TypeLiteral":return new TypeLiteral$1(e.propertySignatures.map(n=>new PropertySignature(n.name,r?n.type:orUndefined(n.type),!0,n.isReadonly,n.annotations)),e.indexSignatures.map(n=>new IndexSignature(n.parameter,orUndefined(n.type),n.isReadonly)));case"Union":return Union$2.make(e.types.map(n=>partial$1(n,t)));case"Suspend":return new Suspend(()=>partial$1(e.f(),t));case"Declaration":throw new Error(getErrorMessage("partial","cannot handle declarations"));case"Refinement":throw new Error(getErrorMessage("partial","cannot handle refinements"));case"Transformation":{if(isTypeLiteralTransformation(e.transformation)&&e.transformation.propertySignatureTransformations.every(isRenamingPropertySignatureTransformation))return new Transformation$1(partial$1(e.from,t),partial$1(e.to,t),e.transformation);throw new Error(getErrorMessage("partial","cannot handle transformations"))}}return e},mutable$1=e=>{switch(e._tag){case"TupleType":return e.isReadonly===!1?e:new TupleType$1(e.elements,e.rest,!1,e.annotations);case"TypeLiteral":{const t=changeMap(e.propertySignatures,n=>n.isReadonly===!1?n:new PropertySignature(n.name,n.type,n.isOptional,!1,n.annotations)),r=changeMap(e.indexSignatures,n=>n.isReadonly===!1?n:new IndexSignature(n.parameter,n.type,!1));return t===e.propertySignatures&&r===e.indexSignatures?e:new TypeLiteral$1(t,r,e.annotations)}case"Union":{const t=changeMap(e.types,mutable$1);return t===e.types?e:Union$2.make(t,e.annotations)}case"Suspend":return new Suspend(()=>mutable$1(e.f()),e.annotations);case"Refinement":{const t=mutable$1(e.from);return t===e.from?e:new Refinement$1(t,e.filter,e.annotations)}case"Transformation":{const t=mutable$1(e.from),r=mutable$1(e.to);return t===e.from&&r===e.to?e:new Transformation$1(t,r,e.transformation,e.annotations)}}return e},typeAST=e=>{switch(e._tag){case"Declaration":{const t=changeMap(e.typeParameters,typeAST);return t===e.typeParameters?e:new Declaration$1(t,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const t=changeMap(e.elements,n=>{const o=typeAST(n.type);return o===n.type?n:new Element(o,n.isOptional)}),r=changeMap(e.rest,typeAST);return t===e.elements&&r===e.rest?e:new TupleType$1(t,r,e.isReadonly,e.annotations)}case"TypeLiteral":{const t=changeMap(e.propertySignatures,n=>{const o=typeAST(n.type);return o===n.type?n:new PropertySignature(n.name,o,n.isOptional,n.isReadonly)}),r=changeMap(e.indexSignatures,n=>{const o=typeAST(n.type);return o===n.type?n:new IndexSignature(n.parameter,o,n.isReadonly)});return t===e.propertySignatures&&r===e.indexSignatures?e:new TypeLiteral$1(t,r,e.annotations)}case"Union":{const t=changeMap(e.types,typeAST);return t===e.types?e:Union$2.make(t,e.annotations)}case"Suspend":return new Suspend(()=>typeAST(e.f()),e.annotations);case"Refinement":{const t=typeAST(e.from);return t===e.from?e:new Refinement$1(t,e.filter,e.annotations)}case"Transformation":return typeAST(e.to)}return e},getJSONIdentifier=e=>orElse$2(getJSONIdentifierAnnotation(e),()=>getIdentifierAnnotation(e)),createJSONIdentifierAnnotation=e=>match$3(getJSONIdentifier(e),{onNone:()=>{},onSome:t=>({[JSONIdentifierAnnotationId]:t})});function changeMap(e,t){let r=!1;const n=allocate(e.length);for(let o=0;o<e.length;o++){const s=e[o],a=t(s);a!==s&&(r=!0),n[o]=a}return r?n:e}const encodedAST_=(e,t)=>{switch(e._tag){case"Declaration":{const r=changeMap(e.typeParameters,n=>encodedAST_(n));return r===e.typeParameters?e:new Declaration$1(r,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const r=changeMap(e.elements,o=>{const s=encodedAST_(o.type);return s===o.type?o:new Element(s,o.isOptional)}),n=changeMap(e.rest,o=>encodedAST_(o));return r===e.elements&&n===e.rest?e:new TupleType$1(r,n,e.isReadonly,createJSONIdentifierAnnotation(e))}case"TypeLiteral":{const r=changeMap(e.propertySignatures,o=>{const s=encodedAST_(o.type);return s===o.type?o:new PropertySignature(o.name,s,o.isOptional,o.isReadonly)}),n=changeMap(e.indexSignatures,o=>{const s=encodedAST_(o.type);return s===o.type?o:new IndexSignature(o.parameter,s,o.isReadonly)});return r===e.propertySignatures&&n===e.indexSignatures?e:new TypeLiteral$1(r,n,createJSONIdentifierAnnotation(e))}case"Union":{const r=changeMap(e.types,n=>encodedAST_(n));return r===e.types?e:Union$2.make(r,createJSONIdentifierAnnotation(e))}case"Suspend":return new Suspend(()=>encodedAST_(e.f()),createJSONIdentifierAnnotation(e));case"Refinement":return encodedAST_(e.from);case"Transformation":return encodedAST_(e.from)}return e},encodedAST=e=>encodedAST_(e),toJSONAnnotations=e=>{const t={};for(const r of Object.getOwnPropertySymbols(e))t[String(r)]=e[r];return t},getCardinality=e=>{switch(e._tag){case"NeverKeyword":return 0;case"Literal":case"UndefinedKeyword":case"VoidKeyword":case"UniqueSymbol":return 1;case"BooleanKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3;case"ObjectKeyword":return 5;case"UnknownKeyword":case"AnyKeyword":return 6;default:return 4}},sortPropertySignatures=sort(mapInput(Order$1,e=>getCardinality(e.type))),sortIndexSignatures=sort(mapInput(Order$1,e=>{switch(getParameterBase(e.parameter)._tag){case"StringKeyword":return 2;case"SymbolKeyword":return 3;case"TemplateLiteral":return 1}})),getParameterBase=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return e;case"Refinement":return getParameterBase(e.from)}},formatKeyword=(e,t=!1)=>getOrElse(getExpected(e,t),()=>e._tag),getExpected=(e,t)=>{if(t){const r=getDescriptionAnnotation(e).pipe(orElse$2(()=>getTitleAnnotation(e)));return match$3(getIdentifierAnnotation(e),{onNone:()=>r,onSome:n=>match$3(r,{onNone:()=>some(n),onSome:o=>some(`${n} (${o})`)})})}else return getIdentifierAnnotation(e).pipe(orElse$2(()=>getTitleAnnotation(e)),orElse$2(()=>getDescriptionAnnotation(e)))},getDuplicateIndexSignatureErrorMessage=e=>`Duplicate index signature for type \`${e}\``,getIndexSignatureParameterErrorMessage="An index signature parameter type must be `string`, `symbol`, a template literal type or a refinement of the previous types",getRequiredElementFollowinAnOptionalElementErrorMessage="A required element cannot follow an optional element. ts(1257)",getDuplicatePropertySignatureTransformationErrorMessage=e=>`Duplicate property signature transformation ${formatUnknown(e)}`,TypeId$8=Symbol.for("effect/BigDecimal"),BigDecimalProto={[TypeId$8]:TypeId$8,[symbol$1](){const e=normalize(this);return pipe(hash$1(e.value),combine$6(number$2(e.scale)),cached(this))},[symbol](e){return isBigDecimal(e)&&equals$2(this,e)},toString(){return`BigDecimal(${format$2(this)})`},toJSON(){return{_id:"BigDecimal",value:String(this.value),scale:this.scale}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}},isBigDecimal=e=>hasProperty(e,TypeId$8),make$p=(e,t)=>{const r=Object.create(BigDecimalProto);return r.value=e,r.scale=t,r},unsafeMakeNormalized=(e,t)=>{if(e!==bigint0$2&&e%bigint10===bigint0$2)throw new RangeError("Value must be normalized");const r=make$p(e,t);return r.normalized=r,r},bigint0$2=BigInt(0),bigint10=BigInt(10),zero$1=unsafeMakeNormalized(bigint0$2,0),normalize=e=>{if(e.normalized===void 0)if(e.value===bigint0$2)e.normalized=zero$1;else{const t=`${e.value}`;let r=0;for(let s=t.length-1;s>=0&&t[s]==="0";s--)r++;r===0&&(e.normalized=e);const n=BigInt(t.substring(0,t.length-r)),o=e.scale-r;e.normalized=unsafeMakeNormalized(n,o)}return e.normalized},scale=(e,t)=>t>e.scale?make$p(e.value*bigint10**BigInt(t-e.scale),t):t<e.scale?make$p(e.value/bigint10**BigInt(e.scale-t),t):e,Equivalence$1=make$s((e,t)=>e.scale>t.scale?scale(t,e.scale).value===e.value:e.scale<t.scale?scale(e,t.scale).value===t.value:e.value===t.value),equals$2=dual(2,(e,t)=>Equivalence$1(e,t)),fromNumber$1=e=>{const[t,r=""]=`${e}`.split(".");return make$p(BigInt(`${t}${r}`),r.length)},fromString$4=e=>{let t,r;const n=e.search(/\./);if(n!==-1){const o=e.slice(0,n),s=e.slice(n+1);t=`${o}${s}`,r=s.length}else t=e,r=0;return t===""?some(zero$1):/^(?:\+|-)?\d+$/.test(t)?some(make$p(BigInt(t),r)):none$4()},format$2=e=>{const t=e.value<bigint0$2,r=t?`${e.value}`.substring(1):`${e.value}`;let n,o;if(e.scale>=r.length)n="0",o="0".repeat(e.scale-r.length)+r;else{const a=r.length-e.scale;if(a>r.length){const c=a-r.length;n=`${r}${"0".repeat(c)}`,o=""}else o=r.slice(a),n=r.slice(0,a)}const s=o===""?n:`${n}.${o}`;return t?`-${s}`:s},unsafeToNumber=e=>Number(format$2(e)),toNumber=e=>e>BigInt(Number.MAX_SAFE_INTEGER)||e<BigInt(Number.MIN_SAFE_INTEGER)?none$4():some(Number(e)),fromString$3=e=>{try{return e.trim()===""?none$4():some(BigInt(e))}catch{return none$4()}},fromNumber=e=>{if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)return none$4();try{return some(BigInt(e))}catch{return none$4()}},not=e=>!e,TypeId$7=Symbol.for("effect/Chunk");function copy(e,t,r,n,o){for(let s=t;s<Math.min(e.length,t+o);s++)r[n+s-t]=e[s];return r}const emptyArray=[],getEquivalence$1=e=>make$s((t,r)=>t.length===r.length&&toReadonlyArray(t).every((n,o)=>e(n,unsafeGet$2(r,o)))),_equivalence$1=getEquivalence$1(equals$3),ChunkProto={[TypeId$7]:{_A:e=>e},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"Chunk",values:toReadonlyArray(this).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()},[symbol](e){return isChunk(e)&&_equivalence$1(this,e)},[symbol$1](){return cached(this,array(toReadonlyArray(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return emptyArray[Symbol.iterator]();default:return toReadonlyArray(this)[Symbol.iterator]()}},pipe(){return pipeArguments(this,arguments)}},makeChunk=e=>{const t=Object.create(ChunkProto);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=_empty$6,t.right=_empty$6;break}case"ISingleton":{t.length=1,t.depth=0,t.left=_empty$6,t.right=_empty$6;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=_empty$6,t.right=_empty$6;break}}return t},isChunk=e=>hasProperty(e,TypeId$7),_empty$6=makeChunk({_tag:"IEmpty"}),empty$j=()=>_empty$6,make$o=(...e)=>e.length===1?of$1(e[0]):unsafeFromNonEmptyArray(e),of$1=e=>makeChunk({_tag:"ISingleton",a:e}),fromIterable$5=e=>isChunk(e)?e:makeChunk({_tag:"IArray",array:fromIterable$6(e)}),copyToArray=(e,t,r)=>{switch(e.backing._tag){case"IArray":{copy(e.backing.array,0,t,r,e.length);break}case"IConcat":{copyToArray(e.left,t,r),copyToArray(e.right,t,r+e.left.length);break}case"ISingleton":{t[r]=e.backing.a;break}case"ISlice":{let n=0,o=r;for(;n<e.length;)t[o]=unsafeGet$2(e,n),n+=1,o+=1;break}}},toReadonlyArray_=e=>{switch(e.backing._tag){case"IEmpty":return emptyArray;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return copyToArray(e,t,0),e.backing={_tag:"IArray",array:t},e.left=_empty$6,e.right=_empty$6,e.depth=0,t}}},toReadonlyArray=toReadonlyArray_,reverseChunk=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return makeChunk({_tag:"IArray",array:reverse$2(e.backing.array)});case"IConcat":return makeChunk({_tag:"IConcat",left:reverse$1(e.backing.right),right:reverse$1(e.backing.left)});case"ISlice":return unsafeFromArray(reverse$2(toReadonlyArray(e)))}},reverse$1=reverseChunk,unsafeFromArray=e=>makeChunk({_tag:"IArray",array:e}),unsafeFromNonEmptyArray=e=>unsafeFromArray(e),unsafeGet$2=dual(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?unsafeGet$2(e.left,t):unsafeGet$2(e.right,t-e.left.length);case"ISlice":return unsafeGet$2(e.backing.chunk,t+e.backing.offset)}}),append=dual(2,(e,t)=>appendAll$1(e,of$1(t))),prepend$1=dual(2,(e,t)=>appendAll$1(of$1(t),e)),drop=dual(2,(e,t)=>{if(t<=0)return e;if(t>=e.length)return _empty$6;switch(e.backing._tag){case"ISlice":return makeChunk({_tag:"ISlice",chunk:e.backing.chunk,offset:e.backing.offset+t,length:e.backing.length-t});case"IConcat":return t>e.left.length?drop(e.right,t-e.left.length):makeChunk({_tag:"IConcat",left:drop(e.left,t),right:e.right});default:return makeChunk({_tag:"ISlice",chunk:e,offset:t,length:e.length-t})}}),appendAll$1=dual(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const r=t.depth-e.depth;if(Math.abs(r)<=1)return makeChunk({_tag:"IConcat",left:e,right:t});if(r<-1)if(e.left.depth>=e.right.depth){const n=appendAll$1(e.right,t);return makeChunk({_tag:"IConcat",left:e.left,right:n})}else{const n=appendAll$1(e.right.right,t);if(n.depth===e.depth-3){const o=makeChunk({_tag:"IConcat",left:e.right.left,right:n});return makeChunk({_tag:"IConcat",left:e.left,right:o})}else{const o=makeChunk({_tag:"IConcat",left:e.left,right:e.right.left});return makeChunk({_tag:"IConcat",left:o,right:n})}}else if(t.right.depth>=t.left.depth){const n=appendAll$1(e,t.left);return makeChunk({_tag:"IConcat",left:n,right:t.right})}else{const n=appendAll$1(e,t.left.left);if(n.depth===t.depth-3){const o=makeChunk({_tag:"IConcat",left:n,right:t.left.right});return makeChunk({_tag:"IConcat",left:o,right:t.right})}else{const o=makeChunk({_tag:"IConcat",left:t.left.right,right:t.right});return makeChunk({_tag:"IConcat",left:n,right:o})}}}),isEmpty$3=e=>e.length===0,isNonEmpty=e=>e.length>0,unsafeHead=e=>unsafeGet$2(e,0),headNonEmpty=unsafeHead,tailNonEmpty=e=>drop(e,1),SIZE=5,BUCKET_SIZE=Math.pow(2,SIZE),MASK=BUCKET_SIZE-1,MAX_INDEX_NODE=BUCKET_SIZE/2,MIN_ARRAY_NODE=BUCKET_SIZE/4;function popcount(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function hashFragment(e,t){return t>>>e&MASK}function toBitmap(e){return 1<<e}function fromBitmap(e,t){return popcount(e&t-1)}const make$n=(e,t)=>({value:e,previous:t});function arrayUpdate(e,t,r,n){let o=n;if(!e){const s=n.length;o=new Array(s);for(let a=0;a<s;++a)o[a]=n[a]}return o[t]=r,o}function arraySpliceOut(e,t,r){const n=r.length-1;let o=0,s=0,a=r;if(e)o=s=t;else for(a=new Array(n);o<t;)a[s++]=r[o++];for(++o;o<=n;)a[s++]=r[o++];return e&&(a.length=n),a}function arraySpliceIn(e,t,r,n){const o=n.length;if(e){let l=o;for(;l>=t;)n[l--]=n[l];return n[t]=r,n}let s=0,a=0;const c=new Array(o+1);for(;s<t;)c[a++]=n[s++];for(c[t]=r;s<o;)c[++a]=n[s++];return c}class EmptyNode{constructor(){ie(this,"_tag","EmptyNode")}modify(t,r,n,o,s,a){const c=n(none$4());return isNone(c)?new EmptyNode:(++a.value,new LeafNode(t,o,s,c))}}function isEmptyNode(e){return isTagged(e,"EmptyNode")}function isLeafNode(e){return isEmptyNode(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function canEditNode(e,t){return isEmptyNode(e)?!1:t===e.edit}class LeafNode{constructor(t,r,n,o){ie(this,"edit");ie(this,"hash");ie(this,"key");ie(this,"value");ie(this,"_tag","LeafNode");this.edit=t,this.hash=r,this.key=n,this.value=o}modify(t,r,n,o,s,a){if(equals$3(s,this.key)){const l=n(this.value);return l===this.value?this:isNone(l)?(--a.value,new EmptyNode):canEditNode(this,t)?(this.value=l,this):new LeafNode(t,o,s,l)}const c=n(none$4());return isNone(c)?this:(++a.value,mergeLeaves(t,r,this.hash,this,o,new LeafNode(t,o,s,c)))}}class CollisionNode{constructor(t,r,n){ie(this,"edit");ie(this,"hash");ie(this,"children");ie(this,"_tag","CollisionNode");this.edit=t,this.hash=r,this.children=n}modify(t,r,n,o,s,a){if(o===this.hash){const l=canEditNode(this,t),h=this.updateCollisionList(l,t,this.hash,this.children,n,s,a);return h===this.children?this:h.length>1?new CollisionNode(t,this.hash,h):h[0]}const c=n(none$4());return isNone(c)?this:(++a.value,mergeLeaves(t,r,this.hash,this,o,new LeafNode(t,o,s,c)))}updateCollisionList(t,r,n,o,s,a,c){const l=o.length;for(let u=0;u<l;++u){const d=o[u];if("key"in d&&equals$3(a,d.key)){const f=d.value,_=s(f);return _===f?o:isNone(_)?(--c.value,arraySpliceOut(t,u,o)):arrayUpdate(t,u,new LeafNode(r,n,a,_),o)}}const h=s(none$4());return isNone(h)?o:(++c.value,arrayUpdate(t,l,new LeafNode(r,n,a,h),o))}}class IndexedNode{constructor(t,r,n){ie(this,"edit");ie(this,"mask");ie(this,"children");ie(this,"_tag","IndexedNode");this.edit=t,this.mask=r,this.children=n}modify(t,r,n,o,s,a){const c=this.mask,l=this.children,h=hashFragment(r,o),u=toBitmap(h),d=fromBitmap(c,u),f=c&u,_=canEditNode(this,t);if(!f){const x=new EmptyNode().modify(t,r+SIZE,n,o,s,a);return x?l.length>=MAX_INDEX_NODE?expand$1(t,h,x,c,l):new IndexedNode(t,c|u,arraySpliceIn(_,d,x,l)):this}const p=l[d],y=p.modify(t,r+SIZE,n,o,s,a);if(p===y)return this;let w=c,E;if(isEmptyNode(y)){if(w&=~u,!w)return new EmptyNode;if(l.length<=2&&isLeafNode(l[d^1]))return l[d^1];E=arraySpliceOut(_,d,l)}else E=arrayUpdate(_,d,y,l);return _?(this.mask=w,this.children=E,this):new IndexedNode(t,w,E)}}class ArrayNode{constructor(t,r,n){ie(this,"edit");ie(this,"size");ie(this,"children");ie(this,"_tag","ArrayNode");this.edit=t,this.size=r,this.children=n}modify(t,r,n,o,s,a){let c=this.size;const l=this.children,h=hashFragment(r,o),u=l[h],d=(u||new EmptyNode).modify(t,r+SIZE,n,o,s,a);if(u===d)return this;const f=canEditNode(this,t);let _;if(isEmptyNode(u)&&!isEmptyNode(d))++c,_=arrayUpdate(f,h,d,l);else if(!isEmptyNode(u)&&isEmptyNode(d)){if(--c,c<=MIN_ARRAY_NODE)return pack$1(t,c,h,l);_=arrayUpdate(f,h,new EmptyNode,l)}else _=arrayUpdate(f,h,d,l);return f?(this.size=c,this.children=_,this):new ArrayNode(t,c,_)}}function pack$1(e,t,r,n){const o=new Array(t-1);let s=0,a=0;for(let c=0,l=n.length;c<l;++c)if(c!==r){const h=n[c];h&&!isEmptyNode(h)&&(o[s++]=h,a|=1<<c)}return new IndexedNode(e,a,o)}function expand$1(e,t,r,n,o){const s=[];let a=n,c=0;for(let l=0;a;++l)a&1&&(s[l]=o[c++]),a>>>=1;return s[t]=r,new ArrayNode(e,c+1,s)}function mergeLeavesInner(e,t,r,n,o,s){if(r===o)return new CollisionNode(e,r,[s,n]);const a=hashFragment(t,r),c=hashFragment(t,o);if(a===c)return l=>new IndexedNode(e,toBitmap(a)|toBitmap(c),[l]);{const l=a<c?[n,s]:[s,n];return new IndexedNode(e,toBitmap(a)|toBitmap(c),l)}}function mergeLeaves(e,t,r,n,o,s){let a,c=t;for(;;){const l=mergeLeavesInner(e,c,r,n,o,s);if(typeof l=="function")a=make$n(l,a),c=c+SIZE;else{let h=l;for(;a!=null;)h=a.value(h),a=a.previous;return h}}}const HashMapSymbolKey="effect/HashMap",HashMapTypeId=Symbol.for(HashMapSymbolKey),HashMapProto={[HashMapTypeId]:HashMapTypeId,[Symbol.iterator](){return new HashMapIterator(this,(e,t)=>[e,t])},[symbol$1](){let e=hash$1(HashMapSymbolKey);for(const t of this)e^=pipe(hash$1(t[0]),combine$6(hash$1(t[1])));return cached(this,e)},[symbol](e){if(isHashMap(e)){if(e._size!==this._size)return!1;for(const t of this){const r=pipe(e,getHash(t[0],hash$1(t[0])));if(isNone(r)||!equals$3(t[1],r.value))return!1}return!0}return!1},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}},makeImpl$1=(e,t,r,n)=>{const o=Object.create(HashMapProto);return o._editable=e,o._edit=t,o._root=r,o._size=n,o};class HashMapIterator{constructor(t,r){ie(this,"map");ie(this,"f");ie(this,"v");this.map=t,this.f=r,this.v=visitLazy(this.map._root,this.f,void 0)}next(){if(isNone(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=applyCont(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new HashMapIterator(this.map,this.f)}}const applyCont=e=>e?visitLazyChildren(e[0],e[1],e[2],e[3],e[4]):none$4(),visitLazy=(e,t,r=void 0)=>{switch(e._tag){case"LeafNode":return isSome(e.value)?some({value:t(e.key,e.value.value),cont:r}):applyCont(r);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const n=e.children;return visitLazyChildren(n.length,n,0,t,r)}default:return applyCont(r)}},visitLazyChildren=(e,t,r,n,o)=>{for(;r<e;){const s=t[r++];if(s&&!isEmptyNode(s))return visitLazy(s,n,[e,t,r,n,o])}return applyCont(o)},_empty$5=makeImpl$1(!1,0,new EmptyNode,0),empty$i=()=>_empty$5,fromIterable$4=e=>{const t=beginMutation$1(empty$i());for(const r of e)set$3(t,r[0],r[1]);return endMutation$1(t)},isHashMap=e=>hasProperty(e,HashMapTypeId),isEmpty$2=e=>e&&isEmptyNode(e._root),get$8=dual(2,(e,t)=>getHash(e,t,hash$1(t))),getHash=dual(3,(e,t,r)=>{let n=e._root,o=0;for(;;)switch(n._tag){case"LeafNode":return equals$3(t,n.key)?n.value:none$4();case"CollisionNode":{if(r===n.hash){const s=n.children;for(let a=0,c=s.length;a<c;++a){const l=s[a];if("key"in l&&equals$3(t,l.key))return l.value}}return none$4()}case"IndexedNode":{const s=hashFragment(o,r),a=toBitmap(s);if(n.mask&a){n=n.children[fromBitmap(n.mask,a)],o+=SIZE;break}return none$4()}case"ArrayNode":{if(n=n.children[hashFragment(o,r)],n){o+=SIZE;break}return none$4()}default:return none$4()}}),has$3=dual(2,(e,t)=>isSome(getHash(e,t,hash$1(t)))),set$3=dual(3,(e,t,r)=>modifyAt$1(e,t,()=>some(r))),setTree=dual(3,(e,t,r)=>e._editable?(e._root=t,e._size=r,e):t===e._root?e:makeImpl$1(e._editable,e._edit,t,r)),keys$1=e=>new HashMapIterator(e,t=>t),size$3=e=>e._size,beginMutation$1=e=>makeImpl$1(!0,e._edit+1,e._root,e._size),endMutation$1=e=>(e._editable=!1,e),modifyAt$1=dual(3,(e,t,r)=>modifyHash(e,t,hash$1(t),r)),modifyHash=dual(4,(e,t,r,n)=>{const o={value:e._size},s=e._root.modify(e._editable?e._edit:NaN,0,n,r,t,o);return pipe(e,setTree(s,o.value))}),remove$2=dual(2,(e,t)=>modifyAt$1(e,t,none$4)),map$4=dual(2,(e,t)=>reduce$6(e,empty$i(),(r,n,o)=>set$3(r,o,t(n,o)))),forEach$3=dual(2,(e,t)=>reduce$6(e,void 0,(r,n,o)=>t(n,o))),reduce$6=dual(3,(e,t,r)=>{const n=e._root;if(n._tag==="LeafNode")return isSome(n.value)?r(t,n.value.value,n.key):t;if(n._tag==="EmptyNode")return t;const o=[n.children];let s;for(;s=o.pop();)for(let a=0,c=s.length;a<c;){const l=s[a++];l&&!isEmptyNode(l)&&(l._tag==="LeafNode"?isSome(l.value)&&(t=r(t,l.value.value,l.key)):o.push(l.children))}return t}),HashSetSymbolKey="effect/HashSet",HashSetTypeId=Symbol.for(HashSetSymbolKey),HashSetProto={[HashSetTypeId]:HashSetTypeId,[Symbol.iterator](){return keys$1(this._keyMap)},[symbol$1](){return cached(this,combine$6(hash$1(this._keyMap))(hash$1(HashSetSymbolKey)))},[symbol](e){return isHashSet(e)?size$3(this._keyMap)===size$3(e._keyMap)&&equals$3(this._keyMap,e._keyMap):!1},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}},makeImpl=e=>{const t=Object.create(HashSetProto);return t._keyMap=e,t},isHashSet=e=>hasProperty(e,HashSetTypeId),_empty$4=makeImpl(empty$i()),empty$h=()=>_empty$4,fromIterable$3=e=>{const t=beginMutation(empty$h());for(const r of e)add$4(t,r);return endMutation(t)},make$m=(...e)=>{const t=beginMutation(empty$h());for(const r of e)add$4(t,r);return endMutation(t)},has$2=dual(2,(e,t)=>has$3(e._keyMap,t)),size$2=e=>size$3(e._keyMap),beginMutation=e=>makeImpl(beginMutation$1(e._keyMap)),endMutation=e=>(e._keyMap._editable=!1,e),mutate=dual(2,(e,t)=>{const r=beginMutation(e);return t(r),endMutation(r)}),add$4=dual(2,(e,t)=>e._keyMap._editable?(set$3(t,!0)(e._keyMap),e):makeImpl(set$3(t,!0)(e._keyMap))),remove$1=dual(2,(e,t)=>e._keyMap._editable?(remove$2(t)(e._keyMap),e):makeImpl(remove$2(t)(e._keyMap))),difference$1=dual(2,(e,t)=>mutate(e,r=>{for(const n of t)remove$1(r,n)})),union$1=dual(2,(e,t)=>mutate(empty$h(),r=>{forEach$2(e,n=>add$4(r,n));for(const n of t)add$4(r,n)})),forEach$2=dual(2,(e,t)=>forEach$3(e._keyMap,(r,n)=>t(n))),reduce$5=dual(3,(e,t,r)=>reduce$6(e._keyMap,t,(n,o,s)=>r(n,s))),empty$g=empty$h,fromIterable$2=fromIterable$3,make$l=make$m,has$1=has$2,size$1=size$2,add$3=add$4,remove=remove$1,difference=difference$1,union=union$1,reduce$4=reduce$5,OP_DIE="Die",OP_EMPTY$2="Empty",OP_FAIL$1="Fail",OP_INTERRUPT="Interrupt",OP_PARALLEL$1="Parallel",OP_SEQUENTIAL$1="Sequential",CauseSymbolKey="effect/Cause",CauseTypeId=Symbol.for(CauseSymbolKey),variance$4={_E:e=>e},proto$2={[CauseTypeId]:variance$4,[symbol$1](){return pipe(hash$1(CauseSymbolKey),combine$6(hash$1(flattenCause(this))),cached(this))},[symbol](e){return isCause(e)&&causeEquals(this,e)},pipe(){return pipeArguments(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:toJSON$1(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:toJSON$1(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:toJSON$1(this.left),right:toJSON$1(this.right)}}},toString(){return pretty(this)},[NodeInspectSymbol](){return this.toJSON()}},empty$f=(()=>{const e=Object.create(proto$2);return e._tag=OP_EMPTY$2,e})(),fail$2=e=>{const t=Object.create(proto$2);return t._tag=OP_FAIL$1,t.error=e,t},die$1=e=>{const t=Object.create(proto$2);return t._tag=OP_DIE,t.defect=e,t},interrupt=e=>{const t=Object.create(proto$2);return t._tag=OP_INTERRUPT,t.fiberId=e,t},parallel$3=(e,t)=>{const r=Object.create(proto$2);return r._tag=OP_PARALLEL$1,r.left=e,r.right=t,r},sequential$2=(e,t)=>{const r=Object.create(proto$2);return r._tag=OP_SEQUENTIAL$1,r.left=e,r.right=t,r},isCause=e=>hasProperty(e,CauseTypeId),isEmpty$1=e=>e._tag===OP_EMPTY$2?!0:reduce$3(e,!0,(t,r)=>{switch(r._tag){case OP_EMPTY$2:return some(t);case OP_DIE:case OP_FAIL$1:case OP_INTERRUPT:return some(!1);default:return none$4()}}),isInterrupted=e=>isSome(interruptOption(e)),isInterruptedOnly=e=>reduceWithContext(void 0,IsInterruptedOnlyCauseReducer)(e),failures=e=>reverse$1(reduce$3(e,empty$j(),(t,r)=>r._tag===OP_FAIL$1?some(pipe(t,prepend$1(r.error))):none$4())),defects=e=>reverse$1(reduce$3(e,empty$j(),(t,r)=>r._tag===OP_DIE?some(pipe(t,prepend$1(r.defect))):none$4())),interruptors=e=>reduce$3(e,empty$g(),(t,r)=>r._tag===OP_INTERRUPT?some(pipe(t,add$3(r.fiberId))):none$4()),failureOption=e=>find(e,t=>t._tag===OP_FAIL$1?some(t.error):none$4()),failureOrCause=e=>{const t=failureOption(e);switch(t._tag){case"None":return right(e);case"Some":return left(t.value)}},interruptOption=e=>find(e,t=>t._tag===OP_INTERRUPT?some(t.fiberId):none$4()),keepDefectsAndElectFailures=e=>match$1(e,{onEmpty:none$4(),onFail:t=>some(die$1(t)),onDie:t=>some(die$1(t)),onInterrupt:()=>none$4(),onSequential:(t,r)=>isSome(t)&&isSome(r)?some(sequential$2(t.value,r.value)):isSome(t)&&isNone(r)?some(t.value):isNone(t)&&isSome(r)?some(r.value):none$4(),onParallel:(t,r)=>isSome(t)&&isSome(r)?some(parallel$3(t.value,r.value)):isSome(t)&&isNone(r)?some(t.value):isNone(t)&&isSome(r)?some(r.value):none$4()}),stripFailures=e=>match$1(e,{onEmpty:empty$f,onFail:()=>empty$f,onDie:t=>die$1(t),onInterrupt:t=>interrupt(t),onSequential:sequential$2,onParallel:parallel$3}),electFailures=e=>match$1(e,{onEmpty:empty$f,onFail:t=>die$1(t),onDie:t=>die$1(t),onInterrupt:t=>interrupt(t),onSequential:(t,r)=>sequential$2(t,r),onParallel:(t,r)=>parallel$3(t,r)}),causeEquals=(e,t)=>{let r=of$1(e),n=of$1(t);for(;isNonEmpty(r)&&isNonEmpty(n);){const[o,s]=pipe(headNonEmpty(r),reduce$3([empty$g(),empty$j()],([l,h],u)=>{const[d,f]=evaluateCause(u);return some([pipe(l,union(d)),pipe(h,appendAll$1(f))])})),[a,c]=pipe(headNonEmpty(n),reduce$3([empty$g(),empty$j()],([l,h],u)=>{const[d,f]=evaluateCause(u);return some([pipe(l,union(d)),pipe(h,appendAll$1(f))])}));if(!equals$3(o,a))return!1;r=s,n=c}return!0},flattenCause=e=>flattenCauseLoop(of$1(e),empty$j()),flattenCauseLoop=(e,t)=>{for(;;){const[r,n]=pipe(e,reduce$7([empty$g(),empty$j()],([s,a],c)=>{const[l,h]=evaluateCause(c);return[pipe(s,union(l)),pipe(a,appendAll$1(h))]})),o=size$1(r)>0?pipe(t,prepend$1(r)):t;if(isEmpty$3(n))return reverse$1(o);e=n,t=o}throw new Error(getBugErrorMessage("Cause.flattenCauseLoop"))},find=dual(2,(e,t)=>{const r=[e];for(;r.length>0;){const n=r.pop(),o=t(n);switch(o._tag){case"None":{switch(n._tag){case OP_SEQUENTIAL$1:case OP_PARALLEL$1:{r.push(n.right),r.push(n.left);break}}break}case"Some":return o}}return none$4()}),evaluateCause=e=>{let t=e;const r=[];let n=empty$g(),o=empty$j();for(;t!==void 0;)switch(t._tag){case OP_EMPTY$2:{if(r.length===0)return[n,o];t=r.pop();break}case OP_FAIL$1:{if(n=add$3(n,make$o(t._tag,t.error)),r.length===0)return[n,o];t=r.pop();break}case OP_DIE:{if(n=add$3(n,make$o(t._tag,t.defect)),r.length===0)return[n,o];t=r.pop();break}case OP_INTERRUPT:{if(n=add$3(n,make$o(t._tag,t.fiberId)),r.length===0)return[n,o];t=r.pop();break}case OP_SEQUENTIAL$1:{switch(t.left._tag){case OP_EMPTY$2:{t=t.right;break}case OP_SEQUENTIAL$1:{t=sequential$2(t.left.left,sequential$2(t.left.right,t.right));break}case OP_PARALLEL$1:{t=parallel$3(sequential$2(t.left.left,t.right),sequential$2(t.left.right,t.right));break}default:{o=prepend$1(o,t.right),t=t.left;break}}break}case OP_PARALLEL$1:{r.push(t.right),t=t.left;break}}throw new Error(getBugErrorMessage("Cause.evaluateCauseLoop"))},IsInterruptedOnlyCauseReducer={emptyCase:constTrue,failCase:constFalse,dieCase:constFalse,interruptCase:constTrue,sequentialCase:(e,t,r)=>t&&r,parallelCase:(e,t,r)=>t&&r},OP_SEQUENTIAL_CASE="SequentialCase",OP_PARALLEL_CASE="ParallelCase",match$1=dual(2,(e,{onDie:t,onEmpty:r,onFail:n,onInterrupt:o,onParallel:s,onSequential:a})=>reduceWithContext(e,void 0,{emptyCase:()=>r,failCase:(c,l)=>n(l),dieCase:(c,l)=>t(l),interruptCase:(c,l)=>o(l),sequentialCase:(c,l,h)=>a(l,h),parallelCase:(c,l,h)=>s(l,h)})),reduce$3=dual(3,(e,t,r)=>{let n=t,o=e;const s=[];for(;o!==void 0;){const a=r(n,o);switch(n=isSome(a)?a.value:n,o._tag){case OP_SEQUENTIAL$1:{s.push(o.right),o=o.left;break}case OP_PARALLEL$1:{s.push(o.right),o=o.left;break}default:{o=void 0;break}}o===void 0&&s.length>0&&(o=s.pop())}return n}),reduceWithContext=dual(3,(e,t,r)=>{const n=[e],o=[];for(;n.length>0;){const a=n.pop();switch(a._tag){case OP_EMPTY$2:{o.push(right(r.emptyCase(t)));break}case OP_FAIL$1:{o.push(right(r.failCase(t,a.error)));break}case OP_DIE:{o.push(right(r.dieCase(t,a.defect)));break}case OP_INTERRUPT:{o.push(right(r.interruptCase(t,a.fiberId)));break}case OP_SEQUENTIAL$1:{n.push(a.right),n.push(a.left),o.push(left({_tag:OP_SEQUENTIAL_CASE}));break}case OP_PARALLEL$1:{n.push(a.right),n.push(a.left),o.push(left({_tag:OP_PARALLEL_CASE}));break}}}const s=[];for(;o.length>0;){const a=o.pop();switch(a._tag){case"Left":{switch(a.left._tag){case OP_SEQUENTIAL_CASE:{const c=s.pop(),l=s.pop(),h=r.sequentialCase(t,c,l);s.push(h);break}case OP_PARALLEL_CASE:{const c=s.pop(),l=s.pop(),h=r.parallelCase(t,c,l);s.push(h);break}}break}case"Right":{s.push(a.right);break}}}if(s.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return s.pop()}),pretty=e=>isInterruptedOnly(e)?"All fibers interrupted without errors.":prettyErrors(e).map(t=>t.stack).join(`
`);class PrettyError extends globalThis.Error{constructor(r){const n=Error.stackTraceLimit;Error.stackTraceLimit=0;super(prettyErrorMessage(r));ie(this,"span");this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=n,this.name=r instanceof Error?r.name:"Error",typeof r=="object"&&r!==null&&(spanSymbol$1 in r&&(this.span=r[spanSymbol$1]),Object.keys(r).forEach(o=>{o in this||(this[o]=r[o])})),this.stack=prettyErrorStack(`${this.name}: ${this.message}`,r instanceof Error&&r.stack?r.stack:"",this.span)}}const prettyErrorMessage=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(hasProperty(e,"toString")&&isFunction$2(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return JSON.stringify(e)},locationRegex=/\((.*)\)/,spanToTrace=globalValue("effect/Tracer/spanToTrace",()=>new WeakMap),prettyErrorStack=(e,t,r)=>{const n=[e],o=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let s=1;s<o.length&&!o[s].includes("Generator.next");s++){if(o[s].includes("effect_internal_function")){n.pop();break}n.push(o[s].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(r){let s=r,a=0;for(;s&&s._tag==="Span"&&a<10;){const c=spanToTrace.get(s);if(typeof c=="function"){const l=c(),h=l.match(locationRegex),u=h?h[1]:l.replace(/^at /,"");n.push(`    at ${s.name} (${u})`)}else n.push(`    at ${s.name}`);s=getOrUndefined(s.parent),a++}}return n.join(`
`)},spanSymbol$1=Symbol.for("effect/SpanAnnotation"),prettyErrors=e=>reduceWithContext(e,void 0,{emptyCase:()=>[],dieCase:(t,r)=>[new PrettyError(r)],failCase:(t,r)=>[new PrettyError(r)],interruptCase:()=>[],parallelCase:(t,r,n)=>[...r,...n],sequentialCase:(t,r,n)=>[...r,...n]}),TagTypeId=Symbol.for("effect/Context/Tag"),STMSymbolKey="effect/STM",STMTypeId=Symbol.for(STMSymbolKey),TagProto={...EffectPrototype,_tag:"Tag",_op:"Tag",[STMTypeId]:effectVariance,[TagTypeId]:{_Service:e=>e,_Identifier:e=>e},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[NodeInspectSymbol](){return this.toJSON()},of(e){return e},context(e){return make$k(this,e)}},makeGenericTag=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=t;const n=Object.create(TagProto);return Object.defineProperty(n,"stack",{get(){return r.stack}}),n.key=e,n},TypeId$6=Symbol.for("effect/Context"),ContextProto={[TypeId$6]:{_Services:e=>e},[symbol](e){if(isContext(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!equals$3(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[symbol$1](){return cached(this,number$2(this.unsafeMap.size))},pipe(){return pipeArguments(this,arguments)},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()}},makeContext=e=>{const t=Object.create(ContextProto);return t.unsafeMap=e,t},serviceNotFoundError=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const r=e.stack.split(`
`);if(r.length>2){const n=r[2].match(/at (.*)/);n&&(t.message=t.message+` (defined at ${n[1]})`)}}if(t.stack){const r=t.stack.split(`
`);r.splice(1,3),t.stack=r.join(`
`)}return t},isContext=e=>hasProperty(e,TypeId$6),_empty$3=makeContext(new Map),empty$e=()=>_empty$3,make$k=(e,t)=>makeContext(new Map([[e.key,t]])),add$2=dual(3,(e,t,r)=>{const n=new Map(e.unsafeMap);return n.set(t.key,r),makeContext(n)}),unsafeGet$1=dual(2,(e,t)=>{if(!e.unsafeMap.has(t.key))throw serviceNotFoundError(t);return e.unsafeMap.get(t.key)}),get$7=unsafeGet$1,getOption$1=dual(2,(e,t)=>e.unsafeMap.has(t.key)?some$1(e.unsafeMap.get(t.key)):none$5),merge$3=dual(2,(e,t)=>{const r=new Map(e.unsafeMap);for(const[n,o]of t.unsafeMap)r.set(n,o);return makeContext(r)}),GenericTag=makeGenericTag,empty$d=empty$e,make$j=make$k,add$1=add$2,get$6=get$7,unsafeGet=unsafeGet$1,getOption=getOption$1,merge$2=merge$3,TypeId$5=Symbol.for("effect/MutableRef"),MutableRefProto={[TypeId$5]:TypeId$5,toString(){return format$3(this.toJSON())},toJSON(){return{_id:"MutableRef",current:toJSON$1(this.current)}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}},make$i=e=>{const t=Object.create(MutableRefProto);return t.current=e,t},get$5=e=>e.current,set$2=dual(2,(e,t)=>(e.current=t,e)),FiberIdSymbolKey="effect/FiberId",FiberIdTypeId=Symbol.for(FiberIdSymbolKey),OP_NONE="None",OP_RUNTIME="Runtime",OP_COMPOSITE="Composite",emptyHash=string(`${FiberIdSymbolKey}-${OP_NONE}`);let None$2=class{constructor(){ie(this,Bi,FiberIdTypeId);ie(this,"_tag",OP_NONE);ie(this,"id",-1);ie(this,"startTimeMillis",-1)}[(Bi=FiberIdTypeId,symbol$1)](){return emptyHash}[symbol](e){return isFiberId$1(e)&&e._tag===OP_NONE}toString(){return format$3(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[NodeInspectSymbol](){return this.toJSON()}},Runtime$1=class{constructor(e,t){ie(this,"id");ie(this,"startTimeMillis");ie(this,Fi,FiberIdTypeId);ie(this,"_tag",OP_RUNTIME);this.id=e,this.startTimeMillis=t}[(Fi=FiberIdTypeId,symbol$1)](){return cached(this,string(`${FiberIdSymbolKey}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[symbol](e){return isFiberId$1(e)&&e._tag===OP_RUNTIME&&this.id===e.id&&this.startTimeMillis===e.startTimeMillis}toString(){return format$3(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[NodeInspectSymbol](){return this.toJSON()}};class Composite{constructor(t,r){ie(this,"left");ie(this,"right");ie(this,ji,FiberIdTypeId);ie(this,"_tag",OP_COMPOSITE);ie(this,"_hash");this.left=t,this.right=r}[(ji=FiberIdTypeId,symbol$1)](){return pipe(string(`${FiberIdSymbolKey}-${this._tag}`),combine$6(hash$1(this.left)),combine$6(hash$1(this.right)),cached(this))}[symbol](t){return isFiberId$1(t)&&t._tag===OP_COMPOSITE&&equals$3(this.left,t.left)&&equals$3(this.right,t.right)}toString(){return format$3(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,left:toJSON$1(this.left),right:toJSON$1(this.right)}}[NodeInspectSymbol](){return this.toJSON()}}const none$3=new None$2,runtime$1=(e,t)=>new Runtime$1(e,t),composite$1=(e,t)=>new Composite(e,t),isFiberId$1=e=>hasProperty(e,FiberIdTypeId),ids=e=>{switch(e._tag){case OP_NONE:return empty$g();case OP_RUNTIME:return make$l(e.id);case OP_COMPOSITE:return pipe(ids(e.left),union(ids(e.right)))}},_fiberCounter=globalValue(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>make$i(0)),threadName$1=e=>Array.from(ids(e)).map(t=>`#${t}`).join(","),unsafeMake$4=()=>{const e=get$5(_fiberCounter);return pipe(_fiberCounter,set$2(e+1)),new Runtime$1(e,Date.now())},none$2=none$3,runtime=runtime$1,composite=composite$1,isFiberId=isFiberId$1,threadName=threadName$1,unsafeMake$3=unsafeMake$4,empty$c=empty$i,fromIterable$1=fromIterable$4,isEmpty=isEmpty$2,get$4=get$8,set$1=set$3,keys=keys$1,size=size$3,modifyAt=modifyAt$1,map$3=map$4,reduce$2=reduce$6,TypeId$4=Symbol.for("effect/List"),toArray$1=e=>fromIterable$6(e),getEquivalence=e=>mapInput$1(getEquivalence$2(e),toArray$1),_equivalence=getEquivalence(equals$3),ConsProto={[TypeId$4]:TypeId$4,_tag:"Cons",toString(){return format$3(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:toArray$1(this).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()},[symbol](e){return isList(e)&&this._tag===e._tag&&_equivalence(this,e)},[symbol$1](){return cached(this,array(toArray$1(this)))},[Symbol.iterator](){let e=!1,t=this;return{next(){if(e)return this.return();if(t._tag==="Nil")return e=!0,this.return();const r=t.head;return t=t.tail,{done:e,value:r}},return(r){return e||(e=!0),{done:!0,value:r}}}},pipe(){return pipeArguments(this,arguments)}},makeCons=(e,t)=>{const r=Object.create(ConsProto);return r.head=e,r.tail=t,r},NilHash=string("Nil"),NilProto={[TypeId$4]:TypeId$4,_tag:"Nil",toString(){return format$3(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[NodeInspectSymbol](){return this.toJSON()},[symbol$1](){return NilHash},[symbol](e){return isList(e)&&this._tag===e._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return pipeArguments(this,arguments)}},_Nil=Object.create(NilProto),isList=e=>hasProperty(e,TypeId$4),isNil=e=>e._tag==="Nil",isCons=e=>e._tag==="Cons",nil=()=>_Nil,cons=(e,t)=>makeCons(e,t),empty$b=nil,of=e=>makeCons(e,_Nil),appendAll=dual(2,(e,t)=>prependAll(t,e)),prepend=dual(2,(e,t)=>cons(t,e)),prependAll=dual(2,(e,t)=>{if(isNil(e))return t;if(isNil(t))return e;{const r=makeCons(t.head,e);let n=r,o=t.tail;for(;!isNil(o);){const s=makeCons(o.head,e);n.tail=s,n=s,o=o.tail}return r}}),reduce$1=dual(3,(e,t,r)=>{let n=t,o=e;for(;!isNil(o);)n=r(n,o.head),o=o.tail;return n}),reverse=e=>{let t=empty$b(),r=e;for(;!isNil(r);)t=prepend(t,r.head),r=r.tail;return t},Structural=function(){function e(t){t&&Object.assign(this,t)}return e.prototype=StructuralPrototype,e}(),ContextPatchTypeId=Symbol.for("effect/DifferContextPatch");function variance$3(e){return e}const PatchProto$2={...Structural.prototype,[ContextPatchTypeId]:{_Value:variance$3,_Patch:variance$3}},EmptyProto$2=Object.assign(Object.create(PatchProto$2),{_tag:"Empty"}),_empty$2=Object.create(EmptyProto$2),empty$a=()=>_empty$2,AndThenProto$2=Object.assign(Object.create(PatchProto$2),{_tag:"AndThen"}),makeAndThen$2=(e,t)=>{const r=Object.create(AndThenProto$2);return r.first=e,r.second=t,r},AddServiceProto=Object.assign(Object.create(PatchProto$2),{_tag:"AddService"}),makeAddService=(e,t)=>{const r=Object.create(AddServiceProto);return r.key=e,r.service=t,r},RemoveServiceProto=Object.assign(Object.create(PatchProto$2),{_tag:"RemoveService"}),makeRemoveService=e=>{const t=Object.create(RemoveServiceProto);return t.key=e,t},UpdateServiceProto=Object.assign(Object.create(PatchProto$2),{_tag:"UpdateService"}),makeUpdateService=(e,t)=>{const r=Object.create(UpdateServiceProto);return r.key=e,r.update=t,r},diff$7=(e,t)=>{const r=new Map(e.unsafeMap);let n=empty$a();for(const[o,s]of t.unsafeMap.entries())if(r.has(o)){const a=r.get(o);r.delete(o),equals$3(a,s)||(n=combine$5(makeUpdateService(o,()=>s))(n))}else r.delete(o),n=combine$5(makeAddService(o,s))(n);for(const[o]of r.entries())n=combine$5(makeRemoveService(o))(n);return n},combine$5=dual(2,(e,t)=>makeAndThen$2(e,t)),patch$7=dual(2,(e,t)=>{if(e._tag==="Empty")return t;let r=!1,n=of$1(e);const o=new Map(t.unsafeMap);for(;isNonEmpty(n);){const a=headNonEmpty(n),c=tailNonEmpty(n);switch(a._tag){case"Empty":{n=c;break}case"AddService":{o.set(a.key,a.service),n=c;break}case"AndThen":{n=prepend$1(prepend$1(c,a.second),a.first);break}case"RemoveService":{o.delete(a.key),n=c;break}case"UpdateService":{o.set(a.key,a.update(o.get(a.key))),r=!0,n=c;break}}}if(!r)return makeContext(o);const s=new Map;for(const[a]of t.unsafeMap)o.has(a)&&(s.set(a,o.get(a)),o.delete(a));for(const[a,c]of o)s.set(a,c);return makeContext(s)}),HashSetPatchTypeId=Symbol.for("effect/DifferHashSetPatch");function variance$2(e){return e}const PatchProto$1={...Structural.prototype,[HashSetPatchTypeId]:{_Value:variance$2,_Key:variance$2,_Patch:variance$2}},EmptyProto$1=Object.assign(Object.create(PatchProto$1),{_tag:"Empty"}),_empty$1=Object.create(EmptyProto$1),empty$9=()=>_empty$1,AndThenProto$1=Object.assign(Object.create(PatchProto$1),{_tag:"AndThen"}),makeAndThen$1=(e,t)=>{const r=Object.create(AndThenProto$1);return r.first=e,r.second=t,r},AddProto=Object.assign(Object.create(PatchProto$1),{_tag:"Add"}),makeAdd=e=>{const t=Object.create(AddProto);return t.value=e,t},RemoveProto=Object.assign(Object.create(PatchProto$1),{_tag:"Remove"}),makeRemove=e=>{const t=Object.create(RemoveProto);return t.value=e,t},diff$6=(e,t)=>{const[r,n]=reduce$4([e,empty$9()],([o,s],a)=>has$1(a)(o)?[remove(a)(o),s]:[o,combine$4(makeAdd(a))(s)])(t);return reduce$4(n,(o,s)=>combine$4(makeRemove(s))(o))(r)},combine$4=dual(2,(e,t)=>makeAndThen$1(e,t)),patch$6=dual(2,(e,t)=>{if(e._tag==="Empty")return t;let r=t,n=of$1(e);for(;isNonEmpty(n);){const o=headNonEmpty(n),s=tailNonEmpty(n);switch(o._tag){case"Empty":{n=s;break}case"AndThen":{n=prepend$1(o.first)(prepend$1(o.second)(s));break}case"Add":{r=add$3(o.value)(r),n=s;break}case"Remove":r=remove(o.value)(r),n=s}}return r}),ReadonlyArrayPatchTypeId=Symbol.for("effect/DifferReadonlyArrayPatch");function variance$1(e){return e}const PatchProto={...Structural.prototype,[ReadonlyArrayPatchTypeId]:{_Value:variance$1,_Patch:variance$1}},EmptyProto=Object.assign(Object.create(PatchProto),{_tag:"Empty"}),_empty=Object.create(EmptyProto),empty$8=()=>_empty,AndThenProto=Object.assign(Object.create(PatchProto),{_tag:"AndThen"}),makeAndThen=(e,t)=>{const r=Object.create(AndThenProto);return r.first=e,r.second=t,r},AppendProto=Object.assign(Object.create(PatchProto),{_tag:"Append"}),makeAppend=e=>{const t=Object.create(AppendProto);return t.values=e,t},SliceProto=Object.assign(Object.create(PatchProto),{_tag:"Slice"}),makeSlice=(e,t)=>{const r=Object.create(SliceProto);return r.from=e,r.until=t,r},UpdateProto=Object.assign(Object.create(PatchProto),{_tag:"Update"}),makeUpdate=(e,t)=>{const r=Object.create(UpdateProto);return r.index=e,r.patch=t,r},diff$5=e=>{let t=0,r=empty$8();for(;t<e.oldValue.length&&t<e.newValue.length;){const n=e.oldValue[t],o=e.newValue[t],s=e.differ.diff(n,o);equals$3(s,e.differ.empty)||(r=combine$3(r,makeUpdate(t,s))),t=t+1}return t<e.oldValue.length&&(r=combine$3(r,makeSlice(0,t))),t<e.newValue.length&&(r=combine$3(r,makeAppend(drop$1(t)(e.newValue)))),r},combine$3=dual(2,(e,t)=>makeAndThen(e,t)),patch$5=dual(3,(e,t,r)=>{if(e._tag==="Empty")return t;let n=t.slice(),o=of$2(e);for(;isNonEmptyArray(o);){const s=headNonEmpty$1(o),a=tailNonEmpty$1(o);switch(s._tag){case"Empty":{o=a;break}case"AndThen":{a.unshift(s.first,s.second),o=a;break}case"Append":{for(const c of s.values)n.push(c);o=a;break}case"Slice":{n=n.slice(s.from,s.until),o=a;break}case"Update":{n[s.index]=r.patch(s.patch,n[s.index]),o=a;break}}}return n}),DifferTypeId=Symbol.for("effect/Differ"),DifferProto={[DifferTypeId]:{_P:identity$1,_V:identity$1}},make$h=e=>{const t=Object.create(DifferProto);return t.empty=e.empty,t.diff=e.diff,t.combine=e.combine,t.patch=e.patch,t},environment=()=>make$h({empty:empty$a(),combine:(e,t)=>combine$5(t)(e),diff:(e,t)=>diff$7(e,t),patch:(e,t)=>patch$7(t)(e)}),hashSet$2=()=>make$h({empty:empty$9(),combine:(e,t)=>combine$4(t)(e),diff:(e,t)=>diff$6(e,t),patch:(e,t)=>patch$6(t)(e)}),readonlyArray=e=>make$h({empty:empty$8(),combine:(t,r)=>combine$3(t,r),diff:(t,r)=>diff$5({oldValue:t,newValue:r,differ:e}),patch:(t,r)=>patch$5(t,r,e)}),update$1=()=>updateWith((e,t)=>t),updateWith=e=>make$h({empty:identity$1,combine:(t,r)=>t===identity$1?r:r===identity$1?t:n=>r(t(n)),diff:(t,r)=>equals$3(t,r)?identity$1:constant$1(r),patch:(t,r)=>e(r,t(r))}),BIT_MASK=255,BIT_SHIFT=8,active=e=>e&BIT_MASK,enabled=e=>e>>BIT_SHIFT&BIT_MASK,make$g=(e,t)=>(e&BIT_MASK)+((t&e&BIT_MASK)<<BIT_SHIFT),empty$7=make$g(0,0),enable$2=e=>make$g(e,e),disable$1=e=>make$g(e,0),exclude$1=dual(2,(e,t)=>make$g(active(e)&~t,enabled(e))),andThen=dual(2,(e,t)=>e|t),invert=e=>~e>>>0&BIT_MASK,None$1=0,Interruption=1,OpSupervision=2,RuntimeMetrics=4,WindDown=16,CooperativeYielding=32,cooperativeYielding=e=>isEnabled(e,CooperativeYielding),enable$1=dual(2,(e,t)=>e|t),interruptible$1=e=>interruption(e)&&!windDown(e),interruption=e=>isEnabled(e,Interruption),isEnabled=dual(2,(e,t)=>(e&t)!==0),make$f=(...e)=>e.reduce((t,r)=>t|r,0),none$1=make$f(None$1),runtimeMetrics=e=>isEnabled(e,RuntimeMetrics),windDown=e=>isEnabled(e,WindDown),diff$4=dual(2,(e,t)=>make$g(e^t,t)),patch$4=dual(2,(e,t)=>e&(invert(active(t))|enabled(t))|active(t)&enabled(t)),differ$1=make$h({empty:empty$7,diff:(e,t)=>diff$4(e,t),combine:(e,t)=>andThen(t)(e),patch:(e,t)=>patch$4(t,e)}),enable=enable$2,disable=disable$1,exclude=exclude$1,par=(e,t)=>({_tag:"Par",left:e,right:t}),seq=(e,t)=>({_tag:"Seq",left:e,right:t}),flatten$1=e=>{let t=of(e),r=empty$b();for(;;){const[n,o]=reduce$1(t,[parallelCollectionEmpty(),empty$b()],([s,a],c)=>{const[l,h]=step$1(c);return[parallelCollectionCombine(s,l),appendAll(a,h)]});if(r=merge$1(r,n),isNil(o))return reverse(r);t=o}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},step$1=e=>{let t=e,r=parallelCollectionEmpty(),n=empty$b(),o=empty$b();for(;;)switch(t._tag){case"Empty":{if(isNil(n))return[r,o];t=n.head,n=n.tail;break}case"Par":{n=cons(t.right,n),t=t.left;break}case"Seq":{const s=t.left,a=t.right;switch(s._tag){case"Empty":{t=a;break}case"Par":{const c=s.left,l=s.right;t=par(seq(c,a),seq(l,a));break}case"Seq":{const c=s.left,l=s.right;t=seq(c,seq(l,a));break}case"Single":{t=s,o=cons(a,o);break}}break}case"Single":{if(r=parallelCollectionAdd(r,t),isNil(n))return[r,o];t=n.head,n=n.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},merge$1=(e,t)=>{if(isNil(e))return of(parallelCollectionToSequentialCollection(t));if(parallelCollectionIsEmpty(t))return e;const r=sequentialCollectionKeys(e.head),n=parallelCollectionKeys(t);return r.length===1&&n.length===1&&equals$3(r[0],n[0])?cons(sequentialCollectionCombine(e.head,parallelCollectionToSequentialCollection(t)),e.tail):cons(parallelCollectionToSequentialCollection(t),e)},RequestBlockParallelTypeId=Symbol.for("effect/RequestBlock/RequestBlockParallel"),parallelVariance={_R:e=>e};Ui=RequestBlockParallelTypeId;class ParallelImpl{constructor(t){ie(this,"map");ie(this,Ui,parallelVariance);this.map=t}}const parallelCollectionEmpty=()=>new ParallelImpl(empty$c()),parallelCollectionAdd=(e,t)=>new ParallelImpl(modifyAt(e.map,t.dataSource,r=>orElseSome(map$6(r,append(t.blockedRequest)),()=>of$1(t.blockedRequest)))),parallelCollectionCombine=(e,t)=>new ParallelImpl(reduce$2(e.map,t.map,(r,n,o)=>set$1(r,o,match$3(get$4(r,o),{onNone:()=>n,onSome:s=>appendAll$1(n,s)})))),parallelCollectionIsEmpty=e=>isEmpty(e.map),parallelCollectionKeys=e=>Array.from(keys(e.map)),parallelCollectionToSequentialCollection=e=>sequentialCollectionMake(map$3(e.map,t=>of$1(t))),SequentialCollectionTypeId=Symbol.for("effect/RequestBlock/RequestBlockSequential"),sequentialVariance={_R:e=>e};Ki=SequentialCollectionTypeId;class SequentialImpl{constructor(t){ie(this,"map");ie(this,Ki,sequentialVariance);this.map=t}}const sequentialCollectionMake=e=>new SequentialImpl(e),sequentialCollectionCombine=(e,t)=>new SequentialImpl(reduce$2(t.map,e.map,(r,n,o)=>set$1(r,o,match$3(get$4(r,o),{onNone:()=>empty$j(),onSome:s=>appendAll$1(s,n)})))),sequentialCollectionKeys=e=>Array.from(keys(e.map)),sequentialCollectionToChunk=e=>Array.from(e.map),OP_STATE_PENDING="Pending",OP_STATE_DONE="Done",DeferredSymbolKey="effect/Deferred",DeferredTypeId=Symbol.for(DeferredSymbolKey),deferredVariance={_E:e=>e,_A:e=>e},pending=e=>({_tag:OP_STATE_PENDING,joiners:e}),done$2=e=>({_tag:OP_STATE_DONE,effect:e});class SingleShotGen{constructor(t){ie(this,"self");ie(this,"called",!1);this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new SingleShotGen(this.self)}}const TracerTypeId=Symbol.for("effect/Tracer"),make$e=e=>({[TracerTypeId]:TracerTypeId,...e}),tracerTag=GenericTag("effect/Tracer"),spanTag=GenericTag("effect/ParentSpan"),randomHexString=function(){const e="abcdef0123456789",t=e.length;return function(r){let n="";for(let o=0;o<r;o++)n+=e.charAt(Math.floor(Math.random()*t));return n}}();class NativeSpan{constructor(t,r,n,o,s,a){ie(this,"name");ie(this,"parent");ie(this,"context");ie(this,"links");ie(this,"startTime");ie(this,"kind");ie(this,"_tag","Span");ie(this,"spanId");ie(this,"traceId","native");ie(this,"sampled",!0);ie(this,"status");ie(this,"attributes");ie(this,"events",[]);this.name=t,this.parent=r,this.context=n,this.links=o,this.startTime=s,this.kind=a,this.status={_tag:"Started",startTime:s},this.attributes=new Map,this.traceId=r._tag==="Some"?r.value.traceId:randomHexString(32),this.spanId=randomHexString(16)}end(t,r){this.status={_tag:"Ended",endTime:t,exit:r,startTime:this.status.startTime}}attribute(t,r){this.attributes.set(t,r)}event(t,r,n){this.events.push([t,r,n??{}])}}const nativeTracer=make$e({span:(e,t,r,n,o,s)=>new NativeSpan(e,t,r,n,o,s),context:e=>e()}),EffectErrorSymbolKey="effect/EffectError",EffectErrorTypeId=Symbol.for(EffectErrorSymbolKey),isEffectError=e=>hasProperty(e,EffectErrorTypeId),blocked=(e,t)=>{const r=new EffectPrimitive("Blocked");return r.effect_instruction_i0=e,r.effect_instruction_i1=t,r},runRequestBlock=e=>{const t=new EffectPrimitive("RunBlocked");return t.effect_instruction_i0=e,t},EffectTypeId$1=Symbol.for("effect/Effect");class RevertFlags{constructor(t,r){ie(this,"patch");ie(this,"op");ie(this,"_op",OP_REVERT_FLAGS);this.patch=t,this.op=r}}class EffectPrimitive{constructor(t){ie(this,"_op");ie(this,"effect_instruction_i0");ie(this,"effect_instruction_i1");ie(this,"effect_instruction_i2");ie(this,"trace");ie(this,qi,effectVariance);this._op=t}[(qi=EffectTypeId$1,symbol)](t){return this===t}[symbol$1](){return cached(this,random(this))}pipe(){return pipeArguments(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:toJSON$1(this.effect_instruction_i0),effect_instruction_i1:toJSON$1(this.effect_instruction_i1),effect_instruction_i2:toJSON$1(this.effect_instruction_i2)}}toString(){return format$3(this.toJSON())}[NodeInspectSymbol](){return this.toJSON()}[Symbol.iterator](){return new SingleShotGen(new YieldWrap(this))}}class EffectPrimitiveFailure{constructor(t){ie(this,"_op");ie(this,"effect_instruction_i0");ie(this,"effect_instruction_i1");ie(this,"effect_instruction_i2");ie(this,"trace");ie(this,Hi,effectVariance);this._op=t,this._tag=t}[(Hi=EffectTypeId$1,symbol)](t){return exitIsExit(t)&&t._op==="Failure"&&equals$3(this.effect_instruction_i0,t.effect_instruction_i0)}[symbol$1](){return pipe(string(this._tag),combine$6(hash$1(this.effect_instruction_i0)),cached(this))}get cause(){return this.effect_instruction_i0}pipe(){return pipeArguments(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return format$3(this.toJSON())}[NodeInspectSymbol](){return this.toJSON()}[Symbol.iterator](){return new SingleShotGen(new YieldWrap(this))}}class EffectPrimitiveSuccess{constructor(t){ie(this,"_op");ie(this,"effect_instruction_i0");ie(this,"effect_instruction_i1");ie(this,"effect_instruction_i2");ie(this,"trace");ie(this,Qi,effectVariance);this._op=t,this._tag=t}[(Qi=EffectTypeId$1,symbol)](t){return exitIsExit(t)&&t._op==="Success"&&equals$3(this.effect_instruction_i0,t.effect_instruction_i0)}[symbol$1](){return pipe(string(this._tag),combine$6(hash$1(this.effect_instruction_i0)),cached(this))}get value(){return this.effect_instruction_i0}pipe(){return pipeArguments(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:toJSON$1(this.value)}}toString(){return format$3(this.toJSON())}[NodeInspectSymbol](){return this.toJSON()}[Symbol.iterator](){return new SingleShotGen(new YieldWrap(this))}}const isEffect$1=e=>hasProperty(e,EffectTypeId$1),withFiberRuntime=e=>{const t=new EffectPrimitive(OP_WITH_RUNTIME);return t.effect_instruction_i0=e,t},acquireUseRelease=dual(3,(e,t,r)=>uninterruptibleMask(n=>flatMap$2(e,o=>flatMap$2(exit(suspend$2(()=>n(t(o)))),s=>suspend$2(()=>r(o,s)).pipe(matchCauseEffect({onFailure:a=>{switch(s._tag){case OP_FAILURE:return failCause(parallel$3(s.effect_instruction_i0,a));case OP_SUCCESS:return failCause(a)}},onSuccess:()=>s})))))),as=dual(2,(e,t)=>flatMap$2(e,()=>succeed$2(t))),asVoid=e=>as(e,void 0),custom=function(){const e=new EffectPrimitive(OP_COMMIT);switch(arguments.length){case 2:{e.effect_instruction_i0=arguments[0],e.commit=arguments[1];break}case 3:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.commit=arguments[2];break}case 4:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.effect_instruction_i2=arguments[2],e.commit=arguments[3];break}default:throw new Error(getBugErrorMessage("you're not supposed to end up here"))}return e},unsafeAsync=(e,t=none$2)=>{const r=new EffectPrimitive(OP_ASYNC);let n;return r.effect_instruction_i0=o=>{n=e(o)},r.effect_instruction_i1=t,n!==void 0?onInterrupt(r,o=>n):r},async=(e,t=none$2)=>custom(e,function(){let r,n;function o(l){r?r(l):n===void 0&&(n=l)}const s=new EffectPrimitive(OP_ASYNC);s.effect_instruction_i0=l=>{r=l,n&&l(n)},s.effect_instruction_i1=t;let a,c;return this.effect_instruction_i0.length!==1?(c=new AbortController,a=internalCall(()=>this.effect_instruction_i0(o,c.signal))):a=internalCall(()=>this.effect_instruction_i0(o)),a||c?onInterrupt(s,l=>(c&&c.abort(),a??void_)):s}),catchAll$1=dual(2,(e,t)=>matchEffect$1(e,{onFailure:t,onSuccess:succeed$2})),spanSymbol=Symbol.for("effect/SpanAnnotation"),originalSymbol=Symbol.for("effect/OriginalAnnotation"),capture=(e,t)=>isSome(t)?new Proxy(e,{has(r,n){return n===spanSymbol||n===originalSymbol||n in r},get(r,n){return n===spanSymbol?t.value:n===originalSymbol?e:r[n]}}):e,die=e=>isObject$3(e)&&!(spanSymbol in e)?withFiberRuntime(t=>failCause(die$1(capture(e,currentSpanFromFiber(t))))):failCause(die$1(e)),dieMessage=e=>failCauseSync(()=>die$1(new RuntimeException(e))),either$1=e=>matchEffect$1(e,{onFailure:t=>succeed$2(left(t)),onSuccess:t=>succeed$2(right(t))}),exit=e=>matchCause(e,{onFailure:exitFailCause,onSuccess:exitSucceed}),fail$1=e=>isObject$3(e)&&!(spanSymbol in e)?withFiberRuntime(t=>failCause(fail$2(capture(e,currentSpanFromFiber(t))))):failCause(fail$2(e)),failSync=e=>flatMap$2(sync(e),fail$1),failCause=e=>{const t=new EffectPrimitiveFailure(OP_FAILURE);return t.effect_instruction_i0=e,t},failCauseSync=e=>flatMap$2(sync(e),failCause),fiberId=withFiberRuntime(e=>succeed$2(e.id())),fiberIdWith=e=>withFiberRuntime(t=>e(t.id())),flatMap$2=dual(2,(e,t)=>{const r=new EffectPrimitive(OP_ON_SUCCESS);return r.effect_instruction_i0=e,r.effect_instruction_i1=t,r}),step=e=>{const t=new EffectPrimitive("OnStep");return t.effect_instruction_i0=e,t},flatten=e=>flatMap$2(e,identity$1),matchCause=dual(2,(e,t)=>matchCauseEffect(e,{onFailure:r=>succeed$2(t.onFailure(r)),onSuccess:r=>succeed$2(t.onSuccess(r))})),matchCauseEffect=dual(2,(e,t)=>{const r=new EffectPrimitive(OP_ON_SUCCESS_AND_FAILURE);return r.effect_instruction_i0=e,r.effect_instruction_i1=t.onFailure,r.effect_instruction_i2=t.onSuccess,r}),matchEffect$1=dual(2,(e,t)=>matchCauseEffect(e,{onFailure:r=>{if(defects(r).length>0)return failCause(electFailures(r));const n=failures(r);return n.length>0?t.onFailure(unsafeHead(n)):failCause(r)},onSuccess:t.onSuccess})),forEachSequential=dual(2,(e,t)=>suspend$2(()=>{const r=fromIterable$6(e),n=allocate(r.length);let o=0;return as(whileLoop({while:()=>o<r.length,body:()=>t(r[o],o),step:s=>{n[o++]=s}}),n)})),forEachSequentialDiscard=dual(2,(e,t)=>suspend$2(()=>{const r=fromIterable$6(e);let n=0;return whileLoop({while:()=>n<r.length,body:()=>t(r[n],n),step:()=>{n++}})})),interruptible=e=>{const t=new EffectPrimitive(OP_UPDATE_RUNTIME_FLAGS);return t.effect_instruction_i0=enable(Interruption),t.effect_instruction_i1=()=>e,t},map$2=dual(2,(e,t)=>flatMap$2(e,r=>sync(()=>t(r)))),mapBoth=dual(2,(e,t)=>matchEffect$1(e,{onFailure:r=>failSync(()=>t.onFailure(r)),onSuccess:r=>sync(()=>t.onSuccess(r))})),mapError$2=dual(2,(e,t)=>matchCauseEffect(e,{onFailure:r=>{const n=failureOrCause(r);switch(n._tag){case"Left":return failSync(()=>t(n.left));case"Right":return failCause(n.right)}},onSuccess:succeed$2})),onExit=dual(2,(e,t)=>uninterruptibleMask(r=>matchCauseEffect(r(e),{onFailure:n=>{const o=exitFailCause(n);return matchCauseEffect(t(o),{onFailure:s=>exitFailCause(sequential$2(n,s)),onSuccess:()=>o})},onSuccess:n=>{const o=exitSucceed(n);return zipRight(t(o),o)}}))),onInterrupt=dual(2,(e,t)=>onExit(e,exitMatch({onFailure:r=>isInterruptedOnly(r)?asVoid(t(interruptors(r))):void_,onSuccess:()=>void_}))),orElse$1=dual(2,(e,t)=>attemptOrElse(e,t,succeed$2)),succeed$2=e=>{const t=new EffectPrimitiveSuccess(OP_SUCCESS);return t.effect_instruction_i0=e,t},suspend$2=e=>flatMap$2(sync(e),identity$1),sync=e=>{const t=new EffectPrimitive(OP_SYNC);return t.effect_instruction_i0=e,t},tap=dual(2,(e,t)=>flatMap$2(e,r=>{const n=typeof t=="function"?t(r):t;return isEffect$1(n)?as(n,r):isPromiseLike(n)?async(o=>{n.then(s=>o(succeed$2(r)),s=>o(fail$1(new UnknownException(s))))}):succeed$2(r)})),transplant=e=>withFiberRuntime(t=>{const r=t.getFiberRef(currentForkScopeOverride),n=pipe(r,getOrElse(()=>t.scope()));return e(fiberRefLocally(currentForkScopeOverride,some(n)))}),attemptOrElse=dual(3,(e,t,r)=>matchCauseEffect(e,{onFailure:n=>defects(n).length>0?failCause(getOrThrow(keepDefectsAndElectFailures(n))):t(),onSuccess:r})),uninterruptible=e=>{const t=new EffectPrimitive(OP_UPDATE_RUNTIME_FLAGS);return t.effect_instruction_i0=disable(Interruption),t.effect_instruction_i1=()=>e,t},uninterruptibleMask=e=>custom(e,function(){const t=new EffectPrimitive(OP_UPDATE_RUNTIME_FLAGS);return t.effect_instruction_i0=disable(Interruption),t.effect_instruction_i1=r=>interruption(r)?internalCall(()=>this.effect_instruction_i0(interruptible)):internalCall(()=>this.effect_instruction_i0(uninterruptible)),t}),void_=succeed$2(void 0),updateRuntimeFlags=e=>{const t=new EffectPrimitive(OP_UPDATE_RUNTIME_FLAGS);return t.effect_instruction_i0=e,t.effect_instruction_i1=void 0,t},whileLoop=e=>{const t=new EffectPrimitive(OP_WHILE);return t.effect_instruction_i0=e.while,t.effect_instruction_i1=e.body,t.effect_instruction_i2=e.step,t},yieldNow$1=e=>{const t=new EffectPrimitive(OP_YIELD);return typeof(e==null?void 0:e.priority)<"u"?withSchedulingPriority(t,e.priority):t},zip=dual(2,(e,t)=>flatMap$2(e,r=>map$2(t,n=>[r,n]))),zipLeft=dual(2,(e,t)=>flatMap$2(e,r=>as(t,r))),zipRight=dual(2,(e,t)=>flatMap$2(e,()=>t)),interruptFiber=e=>flatMap$2(fiberId,t=>pipe(e,interruptAsFiber(t))),interruptAsFiber=dual(2,(e,t)=>flatMap$2(e.interruptAsFork(t),()=>e.await)),logLevelAll={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return pipeArguments(this,arguments)}},logLevelFatal={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return pipeArguments(this,arguments)}},logLevelError={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return pipeArguments(this,arguments)}},logLevelWarning={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return pipeArguments(this,arguments)}},logLevelInfo={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return pipeArguments(this,arguments)}},logLevelDebug={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return pipeArguments(this,arguments)}},logLevelTrace={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return pipeArguments(this,arguments)}},logLevelNone={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return pipeArguments(this,arguments)}},FiberRefSymbolKey="effect/FiberRef",FiberRefTypeId=Symbol.for(FiberRefSymbolKey),fiberRefVariance={_A:e=>e},fiberRefGet=e=>fiberRefModify(e,t=>[t,t]),fiberRefGetWith=dual(2,(e,t)=>flatMap$2(fiberRefGet(e),t)),fiberRefSet=dual(2,(e,t)=>fiberRefModify(e,()=>[void 0,t])),fiberRefModify=dual(2,(e,t)=>withFiberRuntime(r=>{const[n,o]=t(r.getFiberRef(e));return r.setFiberRef(e,o),succeed$2(n)})),fiberRefLocally=dual(3,(e,t,r)=>acquireUseRelease(zipLeft(fiberRefGet(t),fiberRefSet(t,r)),()=>e,n=>fiberRefSet(t,n))),fiberRefUnsafeMake=(e,t)=>fiberRefUnsafeMakePatch(e,{differ:update$1(),fork:(t==null?void 0:t.fork)??identity$1,join:t==null?void 0:t.join}),fiberRefUnsafeMakeHashSet=e=>{const t=hashSet$2();return fiberRefUnsafeMakePatch(e,{differ:t,fork:t.empty})},fiberRefUnsafeMakeReadonlyArray=e=>{const t=readonlyArray(update$1());return fiberRefUnsafeMakePatch(e,{differ:t,fork:t.empty})},fiberRefUnsafeMakeContext=e=>{const t=environment();return fiberRefUnsafeMakePatch(e,{differ:t,fork:t.empty})},fiberRefUnsafeMakePatch=(e,t)=>({[FiberRefTypeId]:fiberRefVariance,initial:e,diff:(r,n)=>t.differ.diff(r,n),combine:(r,n)=>t.differ.combine(r,n),patch:r=>n=>t.differ.patch(r,n),fork:t.fork,join:t.join??((r,n)=>n),pipe(){return pipeArguments(this,arguments)}}),fiberRefUnsafeMakeRuntimeFlags=e=>fiberRefUnsafeMakePatch(e,{differ:differ$1,fork:differ$1.empty}),currentContext$1=globalValue(Symbol.for("effect/FiberRef/currentContext"),()=>fiberRefUnsafeMakeContext(empty$d())),currentSchedulingPriority=globalValue(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>fiberRefUnsafeMake(0)),currentMaxOpsBeforeYield=globalValue(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>fiberRefUnsafeMake(2048)),currentLogAnnotations=globalValue(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>fiberRefUnsafeMake(empty$c())),currentLogLevel=globalValue(Symbol.for("effect/FiberRef/currentLogLevel"),()=>fiberRefUnsafeMake(logLevelInfo)),currentLogSpan=globalValue(Symbol.for("effect/FiberRef/currentLogSpan"),()=>fiberRefUnsafeMake(empty$b())),withSchedulingPriority=dual(2,(e,t)=>fiberRefLocally(e,currentSchedulingPriority,t)),currentConcurrency=globalValue(Symbol.for("effect/FiberRef/currentConcurrency"),()=>fiberRefUnsafeMake("unbounded")),currentRequestBatching=globalValue(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>fiberRefUnsafeMake(!0)),currentUnhandledErrorLogLevel=globalValue(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>fiberRefUnsafeMake(some(logLevelDebug))),currentMetricLabels=globalValue(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>fiberRefUnsafeMakeReadonlyArray(empty$k())),currentForkScopeOverride=globalValue(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>fiberRefUnsafeMake(none$4(),{fork:()=>none$4(),join:(e,t)=>e})),currentInterruptedCause=globalValue(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>fiberRefUnsafeMake(empty$f,{fork:()=>empty$f,join:(e,t)=>e})),scopeAddFinalizer=(e,t)=>e.addFinalizer(()=>asVoid(t)),scopeClose=(e,t)=>e.close(t),scopeFork=(e,t)=>e.fork(t),YieldableError=function(){class e extends globalThis.Error{commit(){return fail$1(this)}toString(){return this.message?`${this.name}: ${this.message}`:this.name}toJSON(){return{...this}}[NodeInspectSymbol](){const r=this.stack;return r?`${this.toString()}
${r.split(`
`).slice(1).join(`
`)}`:this.toString()}}return Object.assign(e.prototype,StructuralCommitPrototype),e}(),makeException=(e,t)=>{class r extends YieldableError{constructor(){super(...arguments);ie(this,"_tag",t)}}return Object.assign(r.prototype,e),r.prototype.name=t,r},RuntimeExceptionTypeId=Symbol.for("effect/Cause/errors/RuntimeException"),RuntimeException=makeException({[RuntimeExceptionTypeId]:RuntimeExceptionTypeId},"RuntimeException"),InterruptedExceptionTypeId=Symbol.for("effect/Cause/errors/InterruptedException"),isInterruptedException=e=>hasProperty(e,InterruptedExceptionTypeId),NoSuchElementExceptionTypeId=Symbol.for("effect/Cause/errors/NoSuchElement"),NoSuchElementException=makeException({[NoSuchElementExceptionTypeId]:NoSuchElementExceptionTypeId},"NoSuchElementException"),UnknownExceptionTypeId=Symbol.for("effect/Cause/errors/UnknownException"),UnknownException=function(){class e extends YieldableError{constructor(n,o){super(o??(hasProperty(n,"message")&&isString(n.message)?n.message:void 0));ie(this,"error");ie(this,"_tag","UnknownException");this.error=n}}return Object.assign(e.prototype,{[UnknownExceptionTypeId]:UnknownExceptionTypeId,name:"UnknownException"}),e}(),exitIsExit=e=>isEffect$1(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),exitCollectAll=(e,t)=>exitCollectAllInternal(e,t!=null&&t.parallel?parallel$3:sequential$2),exitFail=e=>exitFailCause(fail$2(e)),exitFailCause=e=>{const t=new EffectPrimitiveFailure(OP_FAILURE);return t.effect_instruction_i0=e,t},exitInterrupt=e=>exitFailCause(interrupt(e)),exitMap=dual(2,(e,t)=>{switch(e._tag){case OP_FAILURE:return exitFailCause(e.effect_instruction_i0);case OP_SUCCESS:return exitSucceed(t(e.effect_instruction_i0))}}),exitMatch=dual(2,(e,{onFailure:t,onSuccess:r})=>{switch(e._tag){case OP_FAILURE:return t(e.effect_instruction_i0);case OP_SUCCESS:return r(e.effect_instruction_i0)}}),exitSucceed=e=>{const t=new EffectPrimitiveSuccess(OP_SUCCESS);return t.effect_instruction_i0=e,t},exitVoid=exitSucceed(void 0),exitZipWith=dual(3,(e,t,{onFailure:r,onSuccess:n})=>{switch(e._tag){case OP_FAILURE:switch(t._tag){case OP_SUCCESS:return exitFailCause(e.effect_instruction_i0);case OP_FAILURE:return exitFailCause(r(e.effect_instruction_i0,t.effect_instruction_i0))}case OP_SUCCESS:switch(t._tag){case OP_SUCCESS:return exitSucceed(n(e.effect_instruction_i0,t.effect_instruction_i0));case OP_FAILURE:return exitFailCause(t.effect_instruction_i0)}}}),exitCollectAllInternal=(e,t)=>{const r=fromIterable$5(e);return isNonEmpty(r)?pipe(tailNonEmpty(r),reduce$7(pipe(headNonEmpty(r),exitMap(of$1)),(n,o)=>pipe(n,exitZipWith(o,{onSuccess:(s,a)=>pipe(s,prepend$1(a)),onFailure:t}))),exitMap(reverse$1),exitMap(n=>toReadonlyArray(n)),some):none$4()},deferredUnsafeMake=e=>({[DeferredTypeId]:deferredVariance,state:make$i(pending([])),blockingOn:e,pipe(){return pipeArguments(this,arguments)}}),deferredAwait=e=>async(t=>{const r=get$5(e.state);switch(r._tag){case OP_STATE_DONE:return t(r.effect);case OP_STATE_PENDING:return r.joiners.push(t),deferredInterruptJoiner(e,t)}},e.blockingOn),deferredUnsafeDone=(e,t)=>{const r=get$5(e.state);if(r._tag===OP_STATE_PENDING){set$2(e.state,done$2(t));for(let n=0,o=r.joiners.length;n<o;n++)r.joiners[n](t)}},deferredInterruptJoiner=(e,t)=>sync(()=>{const r=get$5(e.state);if(r._tag===OP_STATE_PENDING){const n=r.joiners.indexOf(t);n>=0&&r.joiners.splice(n,1)}}),constContext=fiberRefGet(currentContext$1),context$1=()=>constContext,contextWithEffect=e=>flatMap$2(context$1(),e),provideContext=dual(2,(e,t)=>fiberRefLocally(currentContext$1,t)(e)),mapInputContext=dual(2,(e,t)=>contextWithEffect(r=>provideContext(e,t(r)))),currentSpanFromFiber=e=>{const t=e.getFiberRef(currentContext$1).unsafeMap.get(spanTag.key);return t!==void 0&&t._tag==="Span"?some(t):none$4()},OP_AND="And",OP_OR="Or",OP_INVALID_DATA="InvalidData",OP_MISSING_DATA="MissingData",OP_SOURCE_UNAVAILABLE="SourceUnavailable",OP_UNSUPPORTED="Unsupported",ConfigErrorSymbolKey="effect/ConfigError",ConfigErrorTypeId=Symbol.for(ConfigErrorSymbolKey),proto$1={_tag:"ConfigError",[ConfigErrorTypeId]:ConfigErrorTypeId},And=(e,t)=>{const r=Object.create(proto$1);return r._op=OP_AND,r.left=e,r.right=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),r},Or=(e,t)=>{const r=Object.create(proto$1);return r._op=OP_OR,r.left=e,r.right=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),r},InvalidData=(e,t,r={pathDelim:"."})=>{const n=Object.create(proto$1);return n._op=OP_INVALID_DATA,n.path=e,n.message=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`(Invalid data at ${pipe(this.path,join$1(r.pathDelim))}: "${this.message}")`}}),n},MissingData=(e,t,r={pathDelim:"."})=>{const n=Object.create(proto$1);return n._op=OP_MISSING_DATA,n.path=e,n.message=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`(Missing data at ${pipe(this.path,join$1(r.pathDelim))}: "${this.message}")`}}),n},SourceUnavailable=(e,t,r,n={pathDelim:"."})=>{const o=Object.create(proto$1);return o._op=OP_SOURCE_UNAVAILABLE,o.path=e,o.message=t,o.cause=r,Object.defineProperty(o,"toString",{enumerable:!1,value(){return`(Source unavailable at ${pipe(this.path,join$1(n.pathDelim))}: "${this.message}")`}}),o},Unsupported=(e,t,r={pathDelim:"."})=>{const n=Object.create(proto$1);return n._op=OP_UNSUPPORTED,n.path=e,n.message=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${pipe(this.path,join$1(r.pathDelim))}: "${this.message}")`}}),n},prefixed=dual(2,(e,t)=>{switch(e._op){case OP_AND:return And(prefixed(e.left,t),prefixed(e.right,t));case OP_OR:return Or(prefixed(e.left,t),prefixed(e.right,t));case OP_INVALID_DATA:return InvalidData([...t,...e.path],e.message);case OP_MISSING_DATA:return MissingData([...t,...e.path],e.message);case OP_SOURCE_UNAVAILABLE:return SourceUnavailable([...t,...e.path],e.message,e.cause);case OP_UNSUPPORTED:return Unsupported([...t,...e.path],e.message)}}),TypeId$3=Symbol.for("effect/Duration"),bigint0$1=BigInt(0),bigint24=BigInt(24),bigint60=BigInt(60),bigint1e3=BigInt(1e3),bigint1e6=BigInt(1e6),bigint1e9=BigInt(1e9),DURATION_REGEX=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,decode$3=e=>{if(isDuration(e))return e;if(isNumber(e))return millis(e);if(isBigInt(e))return nanos(e);if(Array.isArray(e)){if(e.length===2&&isNumber(e[0])&&isNumber(e[1]))return nanos(BigInt(e[0])*bigint1e9+BigInt(e[1]))}else if(isString(e)){DURATION_REGEX.lastIndex=0;const t=DURATION_REGEX.exec(e);if(t){const[r,n,o]=t,s=Number(n);switch(o){case"nano":case"nanos":return nanos(BigInt(n));case"micro":case"micros":return micros(BigInt(n));case"milli":case"millis":return millis(s);case"second":case"seconds":return seconds(s);case"minute":case"minutes":return minutes(s);case"hour":case"hours":return hours(s);case"day":case"days":return days(s);case"week":case"weeks":return weeks(s)}}}throw new Error("Invalid DurationInput")},zeroValue={_tag:"Millis",millis:0},infinityValue={_tag:"Infinity"},DurationProto={[TypeId$3]:TypeId$3,[symbol$1](){return cached(this,structure(this.value))},[symbol](e){return isDuration(e)&&equals$1(this,e)},toString(){return`Duration(${format$1(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:toHrTime(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}},make$d=e=>{const t=Object.create(DurationProto);return isNumber(e)?isNaN(e)||e<=0?t.value=zeroValue:Number.isFinite(e)?Number.isInteger(e)?t.value={_tag:"Millis",millis:e}:t.value={_tag:"Nanos",nanos:BigInt(Math.round(e*1e6))}:t.value=infinityValue:e<=bigint0$1?t.value=zeroValue:t.value={_tag:"Nanos",nanos:e},t},isDuration=e=>hasProperty(e,TypeId$3),zero=make$d(0),infinity=make$d(1/0),nanos=e=>make$d(e),micros=e=>make$d(e*bigint1e3),millis=e=>make$d(e),seconds=e=>make$d(e*1e3),minutes=e=>make$d(e*6e4),hours=e=>make$d(e*36e5),days=e=>make$d(e*864e5),weeks=e=>make$d(e*6048e5),toMillis=e=>{const t=decode$3(e);switch(t.value._tag){case"Infinity":return 1/0;case"Nanos":return Number(t.value.nanos)/1e6;case"Millis":return t.value.millis}},toNanos=e=>{const t=decode$3(e);switch(t.value._tag){case"Infinity":return none$4();case"Nanos":return some(t.value.nanos);case"Millis":return some(BigInt(Math.round(t.value.millis*1e6)))}},unsafeToNanos=e=>{const t=decode$3(e);switch(t.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return t.value.nanos;case"Millis":return BigInt(Math.round(t.value.millis*1e6))}},toHrTime=e=>{const t=decode$3(e);switch(t.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(t.value.nanos/bigint1e9),Number(t.value.nanos%bigint1e9)];case"Millis":return[Math.floor(t.value.millis/1e3),Math.round(t.value.millis%1e3*1e6)]}},matchWith=dual(3,(e,t,r)=>{const n=decode$3(e),o=decode$3(t);if(n.value._tag==="Infinity"||o.value._tag==="Infinity")return r.onMillis(toMillis(n),toMillis(o));if(n.value._tag==="Nanos"||o.value._tag==="Nanos"){const s=n.value._tag==="Nanos"?n.value.nanos:BigInt(Math.round(n.value.millis*1e6)),a=o.value._tag==="Nanos"?o.value.nanos:BigInt(Math.round(o.value.millis*1e6));return r.onNanos(s,a)}return r.onMillis(n.value.millis,o.value.millis)}),Equivalence=(e,t)=>matchWith(e,t,{onMillis:(r,n)=>r===n,onNanos:(r,n)=>r===n}),greaterThanOrEqualTo$1=dual(2,(e,t)=>matchWith(e,t,{onMillis:(r,n)=>r>=n,onNanos:(r,n)=>r>=n})),equals$1=dual(2,(e,t)=>Equivalence(decode$3(e),decode$3(t))),format$1=e=>{const t=decode$3(e),r=[];if(t.value._tag==="Infinity")return"Infinity";const n=unsafeToNanos(t);n%bigint1e6&&r.push(`${n%bigint1e6}ns`);const o=n/bigint1e6;o%bigint1e3!==bigint0$1&&r.push(`${o%bigint1e3}ms`);const s=o/bigint1e3;s%bigint60!==bigint0$1&&r.push(`${s%bigint60}s`);const a=s/bigint60;a%bigint60!==bigint0$1&&r.push(`${a%bigint60}m`);const c=a/bigint60;c%bigint24!==bigint0$1&&r.push(`${c%bigint24}h`);const l=c/bigint24;return l!==bigint0$1&&r.push(`${l}d`),r.reverse().join(" ")},ClockSymbolKey="effect/Clock",ClockTypeId=Symbol.for(ClockSymbolKey),clockTag=GenericTag("effect/Clock"),MAX_TIMER_MILLIS=2**31-1,globalClockScheduler={unsafeSchedule(e,t){const r=toMillis(t);if(r>MAX_TIMER_MILLIS)return constFalse;let n=!1;const o=setTimeout(()=>{n=!0,e()},r);return()=>(clearTimeout(o),!n)}},performanceNowNanos=function(){const e=BigInt(1e6);if(typeof performance>"u")return()=>BigInt(Date.now())*e;const t=BigInt(Date.now())*e-BigInt(Math.round(performance.now()*1e6));return()=>t+BigInt(Math.round(performance.now()*1e6))}(),processOrPerformanceNow=function(){const e=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!e)return performanceNowNanos;const t=performanceNowNanos()-e.bigint();return()=>t+e.bigint()}();zi=ClockTypeId;class ClockImpl{constructor(){ie(this,zi,ClockTypeId);ie(this,"currentTimeMillis",sync(()=>this.unsafeCurrentTimeMillis()));ie(this,"currentTimeNanos",sync(()=>this.unsafeCurrentTimeNanos()))}unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return processOrPerformanceNow()}scheduler(){return succeed$2(globalClockScheduler)}sleep(t){return async(r=>{const n=globalClockScheduler.unsafeSchedule(()=>r(void_),t);return asVoid(sync(n))})}}const make$c=()=>new ClockImpl,empty$6={_tag:"Empty"},patch$3=dual(2,(e,t)=>{let r=of(t),n=e;for(;isCons(r);){const o=r.head;switch(o._tag){case"Empty":{r=r.tail;break}case"AndThen":{r=cons(o.first,cons(o.second,r.tail));break}case"MapName":{n=map$5(n,o.f),r=r.tail;break}case"Nested":{n=prepend$2(n,o.name),r=r.tail;break}case"Unnested":{if(pipe(head$4(n),contains(o.name)))n=tailNonEmpty$1(n),r=r.tail;else return left(MissingData(n,`Expected ${o.name} to be in path in ConfigProvider#unnested`));break}}}return right(n)}),OP_CONSTANT="Constant",OP_FAIL="Fail",OP_FALLBACK="Fallback",OP_DESCRIBED="Described",OP_LAZY="Lazy",OP_MAP_OR_FAIL="MapOrFail",OP_NESTED="Nested",OP_PRIMITIVE="Primitive",OP_SEQUENCE="Sequence",OP_HASHMAP="HashMap",OP_ZIP_WITH="ZipWith";var define_process_env_default={};const concat=(e,t)=>[...e,...t],ConfigProviderSymbolKey="effect/ConfigProvider",ConfigProviderTypeId=Symbol.for(ConfigProviderSymbolKey),configProviderTag=GenericTag("effect/ConfigProvider"),FlatConfigProviderSymbolKey="effect/ConfigProviderFlat",FlatConfigProviderTypeId=Symbol.for(FlatConfigProviderSymbolKey),make$b=e=>({[ConfigProviderTypeId]:ConfigProviderTypeId,pipe(){return pipeArguments(this,arguments)},...e}),makeFlat=e=>({[FlatConfigProviderTypeId]:FlatConfigProviderTypeId,patch:e.patch,load:(t,r,n=!0)=>e.load(t,r,n),enumerateChildren:e.enumerateChildren}),fromFlat=e=>make$b({load:t=>flatMap$2(fromFlatLoop(e,empty$k(),t,!1),r=>match$3(head$4(r),{onNone:()=>fail$1(MissingData(empty$k(),`Expected a single value having structure: ${t}`)),onSome:succeed$2})),flattened:e}),fromEnv=e=>{const{pathDelim:t,seqDelim:r}=Object.assign({},{pathDelim:"_",seqDelim:","},e),n=a=>pipe(a,join$1(t)),o=a=>a.split(t),s=()=>typeof process<"u"&&"env"in process&&typeof define_process_env_default=="object"?define_process_env_default:{};return fromFlat(makeFlat({load:(a,c,l=!0)=>{const h=n(a),u=s(),d=h in u?some(u[h]):none$4();return pipe(d,mapError$2(()=>MissingData(a,`Expected ${h} to exist in the process context`)),flatMap$2(f=>parsePrimitive(f,a,c,r,l)))},enumerateChildren:a=>sync(()=>{const c=s(),l=Object.keys(c).map(h=>o(h.toUpperCase())).filter(h=>{for(let u=0;u<a.length;u++){const d=pipe(a,unsafeGet$3(u)),f=h[u];if(f===void 0||d!==f)return!1}return!0}).flatMap(h=>h.slice(a.length,a.length+1));return fromIterable$2(l)}),patch:empty$6}))},extend$1=(e,t,r,n)=>{const o=unfold(r.length,l=>l>=n.length?none$4():some([e(l),l+1])),s=unfold(n.length,l=>l>=r.length?none$4():some([t(l),l+1])),a=concat(r,o),c=concat(n,s);return[a,c]},appendConfigPath=(e,t)=>{let r=t;if(r._tag==="Nested"){const n=e.slice();for(;r._tag==="Nested";)n.push(r.name),r=r.config;return n}return e},fromFlatLoop=(e,t,r,n)=>{const o=r;switch(o._tag){case OP_CONSTANT:return succeed$2(of$2(o.value));case OP_DESCRIBED:return suspend$2(()=>fromFlatLoop(e,t,o.config,n));case OP_FAIL:return fail$1(MissingData(t,o.message));case OP_FALLBACK:return pipe(suspend$2(()=>fromFlatLoop(e,t,o.first,n)),catchAll$1(s=>o.condition(s)?pipe(fromFlatLoop(e,t,o.second,n),catchAll$1(a=>fail$1(Or(s,a)))):fail$1(s)));case OP_LAZY:return suspend$2(()=>fromFlatLoop(e,t,o.config(),n));case OP_MAP_OR_FAIL:return suspend$2(()=>pipe(fromFlatLoop(e,t,o.original,n),flatMap$2(forEachSequential(s=>pipe(o.mapOrFail(s),mapError$2(prefixed(appendConfigPath(t,o.original))))))));case OP_NESTED:return suspend$2(()=>fromFlatLoop(e,concat(t,of$2(o.name)),o.config,n));case OP_PRIMITIVE:return pipe(patch$3(t,e.patch),flatMap$2(s=>pipe(e.load(s,o,n),flatMap$2(a=>{if(a.length===0){const c=pipe(last(s),getOrElse(()=>"<n/a>"));return fail$1(MissingData([],`Expected ${o.description} with name ${c}`))}return succeed$2(a)}))));case OP_SEQUENCE:return pipe(patch$3(t,e.patch),flatMap$2(s=>pipe(e.enumerateChildren(s),flatMap$2(indicesFrom),flatMap$2(a=>a.length===0?suspend$2(()=>map$2(fromFlatLoop(e,s,o.config,!0),of$2)):pipe(forEachSequential(a,c=>fromFlatLoop(e,append$1(t,`[${c}]`),o.config,!0)),map$2(c=>{const l=flatten$3(c);return l.length===0?of$2(empty$k()):of$2(l)}))))));case OP_HASHMAP:return suspend$2(()=>pipe(patch$3(t,e.patch),flatMap$2(s=>pipe(e.enumerateChildren(s),flatMap$2(a=>pipe(a,forEachSequential(c=>fromFlatLoop(e,concat(s,of$2(c)),o.valueConfig,n)),map$2(c=>c.length===0?of$2(empty$c()):pipe(transpose(c),map$5(l=>fromIterable$1(zip$1(fromIterable$6(a),l)))))))))));case OP_ZIP_WITH:return suspend$2(()=>pipe(fromFlatLoop(e,t,o.left,n),either$1,flatMap$2(s=>pipe(fromFlatLoop(e,t,o.right,n),either$1,flatMap$2(a=>{if(isLeft(s)&&isLeft(a))return fail$1(And(s.left,a.left));if(isLeft(s)&&isRight(a))return fail$1(s.left);if(isRight(s)&&isLeft(a))return fail$1(a.left);if(isRight(s)&&isRight(a)){const c=pipe(t,join$1(".")),l=fromFlatLoopFail(t,c),[h,u]=extend$1(l,l,pipe(s.right,map$5(right)),pipe(a.right,map$5(right)));return pipe(h,zip$1(u),forEachSequential(([d,f])=>pipe(zip(d,f),map$2(([_,p])=>o.zip(_,p)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},fromFlatLoopFail=(e,t)=>r=>left(MissingData(e,`The element at index ${r} in a sequence at path "${t}" was missing`)),splitPathString=(e,t)=>e.split(new RegExp(`\\s*${escape(t)}\\s*`)),parsePrimitive=(e,t,r,n,o)=>o?pipe(splitPathString(e,n),forEachSequential(s=>r.parse(s.trim())),mapError$2(prefixed(t))):pipe(r.parse(e),mapBoth({onFailure:prefixed(t),onSuccess:of$2})),transpose=e=>Object.keys(e[0]).map(t=>e.map(r=>r[t])),indicesFrom=e=>pipe(forEachSequential(e,parseQuotedIndex),mapBoth({onFailure:()=>empty$k(),onSuccess:sort(Order$1)}),either$1,map$2(merge$4)),QUOTED_INDEX_REGEX=/^(\[(\d+)\])$/,parseQuotedIndex=e=>{const t=e.match(QUOTED_INDEX_REGEX);if(t!==null){const r=t[2];return pipe(r!==void 0&&r.length>0?some(r):none$4(),flatMap$4(parseInteger))}return none$4()},parseInteger=e=>{const t=Number.parseInt(e);return Number.isNaN(t)?none$4():some(t)},TypeId$2=Symbol.for("effect/Console"),consoleTag=GenericTag("effect/Console"),defaultConsole={[TypeId$2]:TypeId$2,assert(e,...t){return sync(()=>{console.assert(e,...t)})},clear:sync(()=>{console.clear()}),count(e){return sync(()=>{console.count(e)})},countReset(e){return sync(()=>{console.countReset(e)})},debug(...e){return sync(()=>{console.debug(...e)})},dir(e,t){return sync(()=>{console.dir(e,t)})},dirxml(...e){return sync(()=>{console.dirxml(...e)})},error(...e){return sync(()=>{console.error(...e)})},group(e){return e!=null&&e.collapsed?sync(()=>console.groupCollapsed(e==null?void 0:e.label)):sync(()=>console.group(e==null?void 0:e.label))},groupEnd:sync(()=>{console.groupEnd()}),info(...e){return sync(()=>{console.info(...e)})},log(...e){return sync(()=>{console.log(...e)})},table(e,t){return sync(()=>{console.table(e,t)})},time(e){return sync(()=>console.time(e))},timeEnd(e){return sync(()=>console.timeEnd(e))},timeLog(e,...t){return sync(()=>{console.timeLog(e,...t)})},trace(...e){return sync(()=>{console.trace(...e)})},warn(...e){return sync(()=>{console.warn(...e)})},unsafe:console},RandomSymbolKey="effect/Random",RandomTypeId=Symbol.for(RandomSymbolKey),randomTag=GenericTag("effect/Random");Yi=RandomTypeId;class RandomImpl{constructor(t){ie(this,"seed");ie(this,Yi,RandomTypeId);ie(this,"PRNG");this.seed=t,this.PRNG=new PCGRandom(t)}get next(){return sync(()=>this.PRNG.number())}get nextBoolean(){return map$2(this.next,t=>t>.5)}get nextInt(){return sync(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(t,r){return map$2(this.next,n=>(r-t)*n+t)}nextIntBetween(t,r){return sync(()=>this.PRNG.integer(r-t)+t)}shuffle(t){return shuffleWith(t,r=>this.nextIntBetween(0,r))}}const shuffleWith=(e,t)=>suspend$2(()=>pipe(sync(()=>Array.from(e)),flatMap$2(r=>{const n=[];for(let o=r.length;o>=2;o=o-1)n.push(o);return pipe(n,forEachSequentialDiscard(o=>pipe(t(o),map$2(s=>swap(r,o-1,s)))),as(fromIterable$5(r)))}))),swap=(e,t,r)=>{const n=e[t];return e[t]=e[r],e[r]=n,e},make$a=e=>new RandomImpl(e),liveServices=pipe(empty$d(),add$1(clockTag,make$c()),add$1(consoleTag,defaultConsole),add$1(randomTag,make$a(Math.random()*4294967296>>>0)),add$1(configProviderTag,fromEnv()),add$1(tracerTag,nativeTracer)),currentServices=globalValue(Symbol.for("effect/DefaultServices/currentServices"),()=>fiberRefUnsafeMakeContext(liveServices)),RedactedSymbolKey="effect/Redacted",redactedRegistry=globalValue("effect/Redacted/redactedRegistry",()=>new WeakMap),RedactedTypeId=Symbol.for(RedactedSymbolKey),proto={[RedactedTypeId]:{_A:e=>e},pipe(){return pipeArguments(this,arguments)},toString(){return"<redacted>"},toJSON(){return"<redacted>"},[symbol$1](){return pipe(hash$1(RedactedSymbolKey),combine$6(hash$1(redactedRegistry.get(this))),cached(this))},[symbol](e){return isRedacted(e)&&equals$3(redactedRegistry.get(this),redactedRegistry.get(e))}},isRedacted=e=>hasProperty(e,RedactedTypeId),SecretSymbolKey="effect/Secret",SecretTypeId=Symbol.for(SecretSymbolKey),isSecret$1=e=>hasProperty(e,SecretTypeId),make$9=e=>{const t=Object.create({...proto,[SecretTypeId]:SecretTypeId});return Object.defineProperty(t,"toString",{enumerable:!1,value(){return"Secret(<redacted>)"}}),Object.defineProperty(t,"toJSON",{enumerable:!1,value(){return"<redacted>"}}),Object.defineProperty(t,"raw",{enumerable:!1,value:e}),redactedRegistry.set(t,e.map(r=>String.fromCharCode(r)).join("")),t},fromString$2=e=>make$9(e.split("").map(t=>t.charCodeAt(0))),value$1=e=>e.raw.map(t=>String.fromCharCode(t)).join(""),Error$2=function(){return class extends YieldableError{constructor(e){super(),e&&Object.assign(this,e)}}}(),TaggedError=e=>{class t extends Error$2{constructor(){super(...arguments);ie(this,"_tag",e)}}return t.prototype.name=e,t},EffectTypeId=EffectTypeId$2,OP_SEQUENTIAL="Sequential",OP_PARALLEL="Parallel",OP_PARALLEL_N="ParallelN",sequential$1={_tag:OP_SEQUENTIAL},parallel$2={_tag:OP_PARALLEL},parallelN$1=e=>({_tag:OP_PARALLEL_N,parallelism:e}),sequential=sequential$1,parallel$1=parallel$2,parallelN=parallelN$1;function unsafeMake$2(e){return new FiberRefsImpl(e)}function empty$5(){return unsafeMake$2(new Map)}const FiberRefsSym=Symbol.for("effect/FiberRefs");Gi=FiberRefsSym;class FiberRefsImpl{constructor(t){ie(this,"locals");ie(this,Gi,FiberRefsSym);this.locals=t}pipe(){return pipeArguments(this,arguments)}}const findAncestor=(e,t,r,n=!1)=>{const o=e;let s=t,a=r,c=n,l;for(;l===void 0;)if(isNonEmptyReadonlyArray(s)&&isNonEmptyReadonlyArray(a)){const h=headNonEmpty$1(s)[0],u=tailNonEmpty$1(s),d=headNonEmpty$1(a)[0],f=headNonEmpty$1(a)[1],_=tailNonEmpty$1(a);h.startTimeMillis<d.startTimeMillis?(a=_,c=!0):h.startTimeMillis>d.startTimeMillis?s=u:h.id<d.id?(a=_,c=!0):h.id>d.id?s=u:l=[f,c]}else l=[o.initial,!0];return l},joinAs=dual(3,(e,t,r)=>{const n=new Map(e.locals);return r.locals.forEach((o,s)=>{const a=o[0][1];if(!o[0][0][symbol](t)){if(!n.has(s)){if(equals$3(a,s.initial))return;n.set(s,[[t,s.join(s.initial,a)]]);return}const c=n.get(s),[l,h]=findAncestor(s,c,o);if(h){const u=s.diff(l,a),d=c[0][1],f=s.join(d,s.patch(u)(d));if(!equals$3(d,f)){let _;const p=c[0][0];p[symbol](t)?_=[[p,f],...c.slice(1)]:_=[[t,f],...c],n.set(s,_)}}}}),new FiberRefsImpl(n)}),forkAs=dual(2,(e,t)=>{const r=new Map;return unsafeForkAs(e,r,t),new FiberRefsImpl(r)}),unsafeForkAs=(e,t,r)=>{e.locals.forEach((n,o)=>{const s=n[0][1],a=o.patch(o.fork)(s);equals$3(s,a)?t.set(o,n):t.set(o,[[r,a],...n])})},delete_=dual(2,(e,t)=>{const r=new Map(e.locals);return r.delete(t),new FiberRefsImpl(r)}),get$3=dual(2,(e,t)=>e.locals.has(t)?some(headNonEmpty$1(e.locals.get(t))[1]):none$4()),getOrDefault$1=dual(2,(e,t)=>pipe(get$3(e,t),getOrElse(()=>t.initial))),updateAs=dual(2,(e,{fiberId:t,fiberRef:r,value:n})=>{if(e.locals.size===0)return new FiberRefsImpl(new Map([[r,[[t,n]]]]));const o=new Map(e.locals);return unsafeUpdateAs(o,t,r,n),new FiberRefsImpl(o)}),unsafeUpdateAs=(e,t,r,n)=>{const o=e.get(r)??[];let s;if(isNonEmptyReadonlyArray(o)){const[a,c]=headNonEmpty$1(o);if(a[symbol](t)){if(equals$3(c,n))return;s=[[t,n],...o.slice(1)]}else s=[[t,n],...o]}else s=[[t,n]];e.set(r,s)},updateManyAs$1=dual(2,(e,{entries:t,forkAs:r})=>{if(e.locals.size===0)return new FiberRefsImpl(new Map(t));const n=new Map(e.locals);return r!==void 0&&unsafeForkAs(e,n,r),t.forEach(([o,s])=>{s.length===1?unsafeUpdateAs(n,s[0][0],o,s[0][1]):s.forEach(([a,c])=>{unsafeUpdateAs(n,a,o,c)})}),new FiberRefsImpl(n)}),getOrDefault=getOrDefault$1,updateManyAs=updateManyAs$1,empty$4=empty$5,OP_EMPTY$1="Empty",OP_ADD="Add",OP_REMOVE="Remove",OP_UPDATE="Update",OP_AND_THEN$1="AndThen",empty$3={_tag:OP_EMPTY$1},diff$3=(e,t)=>{const r=new Map(e.locals);let n=empty$3;for(const[o,s]of t.locals.entries()){const a=headNonEmpty$1(s)[1],c=r.get(o);if(c!==void 0){const l=headNonEmpty$1(c)[1];equals$3(l,a)||(n=combine$2({_tag:OP_UPDATE,fiberRef:o,patch:o.diff(l,a)})(n))}else n=combine$2({_tag:OP_ADD,fiberRef:o,value:a})(n);r.delete(o)}for(const[o]of r.entries())n=combine$2({_tag:OP_REMOVE,fiberRef:o})(n);return n},combine$2=dual(2,(e,t)=>({_tag:OP_AND_THEN$1,first:e,second:t})),patch$2=dual(3,(e,t,r)=>{let n=r,o=of$2(e);for(;isNonEmptyReadonlyArray(o);){const s=headNonEmpty$1(o),a=tailNonEmpty$1(o);switch(s._tag){case OP_EMPTY$1:{o=a;break}case OP_ADD:{n=updateAs(n,{fiberId:t,fiberRef:s.fiberRef,value:s.value}),o=a;break}case OP_REMOVE:{n=delete_(n,s.fiberRef),o=a;break}case OP_UPDATE:{const c=getOrDefault$1(n,s.fiberRef);n=updateAs(n,{fiberId:t,fiberRef:s.fiberRef,value:s.fiberRef.patch(s.patch)(c)}),o=a;break}case OP_AND_THEN$1:{o=prepend$2(s.first)(prepend$2(s.second)(a));break}}}return n}),diff$2=diff$3,patch$1=patch$2,FiberStatusSymbolKey="effect/FiberStatus",FiberStatusTypeId=Symbol.for(FiberStatusSymbolKey),OP_DONE="Done",OP_RUNNING="Running",OP_SUSPENDED="Suspended",DoneHash=string(`${FiberStatusSymbolKey}-${OP_DONE}`);class Done{constructor(){ie(this,Vi,FiberStatusTypeId);ie(this,"_tag",OP_DONE)}[(Vi=FiberStatusTypeId,symbol$1)](){return DoneHash}[symbol](t){return isFiberStatus(t)&&t._tag===OP_DONE}}class Running{constructor(t){ie(this,"runtimeFlags");ie(this,Wi,FiberStatusTypeId);ie(this,"_tag",OP_RUNNING);this.runtimeFlags=t}[(Wi=FiberStatusTypeId,symbol$1)](){return pipe(hash$1(FiberStatusSymbolKey),combine$6(hash$1(this._tag)),combine$6(hash$1(this.runtimeFlags)),cached(this))}[symbol](t){return isFiberStatus(t)&&t._tag===OP_RUNNING&&this.runtimeFlags===t.runtimeFlags}}class Suspended{constructor(t,r){ie(this,"runtimeFlags");ie(this,"blockingOn");ie(this,Ji,FiberStatusTypeId);ie(this,"_tag",OP_SUSPENDED);this.runtimeFlags=t,this.blockingOn=r}[(Ji=FiberStatusTypeId,symbol$1)](){return pipe(hash$1(FiberStatusSymbolKey),combine$6(hash$1(this._tag)),combine$6(hash$1(this.runtimeFlags)),combine$6(hash$1(this.blockingOn)),cached(this))}[symbol](t){return isFiberStatus(t)&&t._tag===OP_SUSPENDED&&this.runtimeFlags===t.runtimeFlags&&equals$3(this.blockingOn,t.blockingOn)}}const done$1=new Done,running$1=e=>new Running(e),suspended$1=(e,t)=>new Suspended(e,t),isFiberStatus=e=>hasProperty(e,FiberStatusTypeId),isDone$1=e=>e._tag===OP_DONE,done=done$1,running=running$1,suspended=suspended$1,isDone=isDone$1,All=logLevelAll,Fatal=logLevelFatal,Error$1=logLevelError,Warning=logLevelWarning,Info=logLevelInfo,Debug=logLevelDebug,Trace=logLevelTrace,None=logLevelNone,Order=pipe(Order$1,mapInput(e=>e.ordinal)),greaterThan$1=greaterThan$2(Order),fromLiteral=e=>{switch(e){case"All":return All;case"Debug":return Debug;case"Error":return Error$1;case"Fatal":return Fatal;case"Info":return Info;case"Trace":return Trace;case"None":return None;case"Warning":return Warning}},runSymbol=Symbol.for("effect/Micro/runSymbol"),EnvTypeId=Symbol.for("effect/Micro/Env"),EnvRefTypeId=Symbol.for("effect/Micro/EnvRef"),EnvProto={[EnvTypeId]:{_R:identity$1},pipe(){return pipeArguments(this,arguments)}},envMake=e=>{const t=Object.create(EnvProto);return t.refs=e,t},envUnsafeMakeEmpty=()=>{const e=new AbortController,t=Object.create(null);return t[currentAbortController.key]=e,t[currentAbortSignal.key]=e.signal,envMake(t)},envGet=dual(2,(e,t)=>t.key in e.refs?e.refs[t.key]:t.initial),envSet=dual(3,(e,t,r)=>{const n=Object.assign(Object.create(null),e.refs);return n[t.key]=r,envMake(n)}),EnvRefProto={[EnvRefTypeId]:EnvRefTypeId},envRefMake=(e,t)=>globalValue(e,()=>{const r=Object.create(EnvRefProto);return r.key=e,r.initial=t(),r}),currentAbortController=envRefMake("effect/Micro/currentAbortController",()=>new AbortController),currentAbortSignal=envRefMake("effect/Micro/currentAbortSignal",()=>currentAbortController.initial.signal),currentContext=envRefMake("effect/Micro/currentContext",()=>empty$d());class PriorityBuckets{constructor(){ie(this,"buckets",[])}scheduleTask(t,r){let n,o;for(o=0;o<this.buckets.length&&this.buckets[o][0]<=r;o++)n=this.buckets[o];if(n)n[1].push(t);else{const s=[];for(let a=0;a<o;a++)s.push(this.buckets[a]);s.push([r,[t]]);for(let a=o;a<this.buckets.length;a++)s.push(this.buckets[a]);this.buckets=s}}}class MixedScheduler{constructor(t){ie(this,"maxNextTickBeforeTimer");ie(this,"running",!1);ie(this,"tasks",new PriorityBuckets);this.maxNextTickBeforeTimer=t}starveInternal(t){const r=this.tasks.buckets;this.tasks.buckets=[];for(const[n,o]of r)for(let s=0;s<o.length;s++)o[s]();this.tasks.buckets.length===0?this.running=!1:this.starve(t)}starve(t=0){t>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(t+1))}shouldYield(t){return t.currentOpCount>t.getFiberRef(currentMaxOpsBeforeYield)?t.getFiberRef(currentSchedulingPriority):!1}scheduleTask(t,r){this.tasks.scheduleTask(t,r),this.running||(this.running=!0,this.starve())}}const defaultScheduler=globalValue(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new MixedScheduler(2048));class SyncScheduler{constructor(){ie(this,"tasks",new PriorityBuckets);ie(this,"deferred",!1)}scheduleTask(t,r){this.deferred?defaultScheduler.scheduleTask(t,r):this.tasks.scheduleTask(t,r)}shouldYield(t){return t.currentOpCount>t.getFiberRef(currentMaxOpsBeforeYield)?t.getFiberRef(currentSchedulingPriority):!1}flush(){for(;this.tasks.buckets.length>0;){const t=this.tasks.buckets;this.tasks.buckets=[];for(const[r,n]of t)for(let o=0;o<n.length;o++)n[o]()}this.deferred=!0}}const currentScheduler=globalValue(Symbol.for("effect/FiberRef/currentScheduler"),()=>fiberRefUnsafeMake(defaultScheduler)),currentRequestMap=globalValue(Symbol.for("effect/FiberRef/currentRequestMap"),()=>fiberRefUnsafeMake(new Map)),match=(e,t,r,n)=>{switch(e){case void 0:return t();case"unbounded":return r();case"inherit":return fiberRefGetWith(currentConcurrency,o=>o==="unbounded"?r():o>1?n(o):t());default:return e>1?n(e):t()}},render$1=e=>t=>`${t.label.replace(/[\s="]/g,"_")}=${e-t.startTime}ms`,render=render$1,MetricLabelSymbolKey="effect/MetricLabel",MetricLabelTypeId=Symbol.for(MetricLabelSymbolKey);class MetricLabelImpl{constructor(t,r){ie(this,"key");ie(this,"value");ie(this,Xi,MetricLabelTypeId);ie(this,"_hash");this.key=t,this.value=r,this._hash=string(MetricLabelSymbolKey+this.key+this.value)}[(Xi=MetricLabelTypeId,symbol$1)](){return this._hash}[symbol](t){return isMetricLabel(t)&&this.key===t.key&&this.value===t.value}pipe(){return pipeArguments(this,arguments)}}const make$8=(e,t)=>new MetricLabelImpl(e,t),isMetricLabel=e=>hasProperty(e,MetricLabelTypeId),OP_INTERRUPT_SIGNAL="InterruptSignal",OP_STATEFUL="Stateful",OP_RESUME="Resume",OP_YIELD_NOW="YieldNow",interruptSignal=e=>({_tag:OP_INTERRUPT_SIGNAL,cause:e}),stateful=e=>({_tag:OP_STATEFUL,onFiber:e}),resume=e=>({_tag:OP_RESUME,effect:e}),yieldNow=()=>({_tag:OP_YIELD_NOW}),FiberScopeSymbolKey="effect/FiberScope",FiberScopeTypeId=Symbol.for(FiberScopeSymbolKey);Zi=FiberScopeTypeId;class Global{constructor(){ie(this,Zi,FiberScopeTypeId);ie(this,"fiberId",none$2);ie(this,"roots",new Set)}add(t,r){this.roots.add(r),r.addObserver(()=>{this.roots.delete(r)})}}es=FiberScopeTypeId;class Local{constructor(t,r){ie(this,"fiberId");ie(this,"parent");ie(this,es,FiberScopeTypeId);this.fiberId=t,this.parent=r}add(t,r){this.parent.tell(stateful(n=>{n.addChild(r),r.addObserver(()=>{n.removeChild(r)})}))}}const unsafeMake$1=e=>new Local(e.id(),e),globalScope=globalValue(Symbol.for("effect/FiberScope/Global"),()=>new Global),FiberSymbolKey="effect/Fiber",FiberTypeId=Symbol.for(FiberSymbolKey),fiberVariance={_E:e=>e,_A:e=>e},RuntimeFiberSymbolKey="effect/Fiber",RuntimeFiberTypeId=Symbol.for(RuntimeFiberSymbolKey),join=e=>zipLeft(flatten(e.await),e.inheritAll),currentFiberURI="effect/FiberCurrent",LoggerSymbolKey="effect/Logger",LoggerTypeId=Symbol.for(LoggerSymbolKey),loggerVariance={_Message:e=>e,_Output:e=>e},makeLogger=e=>({[LoggerTypeId]:loggerVariance,log:e,pipe(){return pipeArguments(this,arguments)}}),stringLogger=makeLogger(({annotations:e,cause:t,date:r,fiberId:n,logLevel:o,message:s,spans:a})=>{const c=r.getTime();let l=[`timestamp=${r.toISOString()}`,`level=${o.label}`,`fiber=${threadName$1(n)}`].join(" ");if(Array.isArray(s))for(let h=0;h<s.length;h++){const u=toStringUnknown(s[h]);u.length>0&&(l=l+" message=",l=appendQuoted(u,l))}else{const h=toStringUnknown(s);h.length>0&&(l=l+" message=",l=appendQuoted(h,l))}if(t!=null&&t._tag!=="Empty"&&(l=l+" cause=",l=appendQuoted(pretty(t),l)),isCons(a)){l=l+" ";let h=!0;for(const u of a)h?h=!1:l=l+" ",l=l+pipe(u,render(c))}if(pipe(e,size)>0){l=l+" ";let h=!0;for(const[u,d]of e)h?h=!1:l=l+" ",l=l+filterKeyName(u),l=l+"=",l=appendQuoted(toStringUnknown(d),l)}return l}),escapeDoubleQuotes=e=>`"${e.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,textOnly=/^[^\s"=]+$/,appendQuoted=(e,t)=>t+(e.match(textOnly)?e:escapeDoubleQuotes(e)),filterKeyName=e=>e.replace(/[\s="]/g,"_"),MetricBoundariesSymbolKey="effect/MetricBoundaries",MetricBoundariesTypeId=Symbol.for(MetricBoundariesSymbolKey);class MetricBoundariesImpl{constructor(t){ie(this,"values");ie(this,ts,MetricBoundariesTypeId);ie(this,"_hash");this.values=t,this._hash=pipe(string(MetricBoundariesSymbolKey),combine$6(array(this.values)))}[(ts=MetricBoundariesTypeId,symbol$1)](){return this._hash}[symbol](t){return isMetricBoundaries(t)&&equals$3(this.values,t.values)}pipe(){return pipeArguments(this,arguments)}}const isMetricBoundaries=e=>hasProperty(e,MetricBoundariesTypeId),fromIterable=e=>{const t=pipe(e,appendAll$2(of$1(Number.POSITIVE_INFINITY)),dedupe);return new MetricBoundariesImpl(t)},exponential=e=>pipe(makeBy(e.count-1,t=>e.start*Math.pow(e.factor,t)),unsafeFromArray,fromIterable),MetricKeyTypeSymbolKey="effect/MetricKeyType",MetricKeyTypeTypeId=Symbol.for(MetricKeyTypeSymbolKey),CounterKeyTypeSymbolKey="effect/MetricKeyType/Counter",CounterKeyTypeTypeId=Symbol.for(CounterKeyTypeSymbolKey),FrequencyKeyTypeSymbolKey="effect/MetricKeyType/Frequency",FrequencyKeyTypeTypeId=Symbol.for(FrequencyKeyTypeSymbolKey),GaugeKeyTypeSymbolKey="effect/MetricKeyType/Gauge",GaugeKeyTypeTypeId=Symbol.for(GaugeKeyTypeSymbolKey),HistogramKeyTypeSymbolKey="effect/MetricKeyType/Histogram",HistogramKeyTypeTypeId=Symbol.for(HistogramKeyTypeSymbolKey),SummaryKeyTypeSymbolKey="effect/MetricKeyType/Summary",SummaryKeyTypeTypeId=Symbol.for(SummaryKeyTypeSymbolKey),metricKeyTypeVariance={_In:e=>e,_Out:e=>e};class CounterKeyType{constructor(t,r){ie(this,"incremental");ie(this,"bigint");ie(this,ns,metricKeyTypeVariance);ie(this,rs,CounterKeyTypeTypeId);ie(this,"_hash");this.incremental=t,this.bigint=r,this._hash=string(CounterKeyTypeSymbolKey)}[(ns=MetricKeyTypeTypeId,rs=CounterKeyTypeTypeId,symbol$1)](){return this._hash}[symbol](t){return isCounterKey(t)}pipe(){return pipeArguments(this,arguments)}}class HistogramKeyType{constructor(t){ie(this,"boundaries");ie(this,ss,metricKeyTypeVariance);ie(this,is,HistogramKeyTypeTypeId);ie(this,"_hash");this.boundaries=t,this._hash=pipe(string(HistogramKeyTypeSymbolKey),combine$6(hash$1(this.boundaries)))}[(ss=MetricKeyTypeTypeId,is=HistogramKeyTypeTypeId,symbol$1)](){return this._hash}[symbol](t){return isHistogramKey(t)&&equals$3(this.boundaries,t.boundaries)}pipe(){return pipeArguments(this,arguments)}}const counter$4=e=>new CounterKeyType((e==null?void 0:e.incremental)??!1,(e==null?void 0:e.bigint)??!1),histogram$4=e=>new HistogramKeyType(e),isCounterKey=e=>hasProperty(e,CounterKeyTypeTypeId),isFrequencyKey=e=>hasProperty(e,FrequencyKeyTypeTypeId),isGaugeKey=e=>hasProperty(e,GaugeKeyTypeTypeId),isHistogramKey=e=>hasProperty(e,HistogramKeyTypeTypeId),isSummaryKey=e=>hasProperty(e,SummaryKeyTypeTypeId),MetricKeySymbolKey="effect/MetricKey",MetricKeyTypeId=Symbol.for(MetricKeySymbolKey),metricKeyVariance={_Type:e=>e},arrayEquivilence=getEquivalence$2(equals$3);class MetricKeyImpl{constructor(t,r,n,o=[]){ie(this,"name");ie(this,"keyType");ie(this,"description");ie(this,"tags");ie(this,cs,metricKeyVariance);ie(this,"_hash");this.name=t,this.keyType=r,this.description=n,this.tags=o,this._hash=pipe(string(this.name+this.description),combine$6(hash$1(this.keyType)),combine$6(array(this.tags)))}[(cs=MetricKeyTypeId,symbol$1)](){return this._hash}[symbol](t){return isMetricKey(t)&&this.name===t.name&&equals$3(this.keyType,t.keyType)&&equals$3(this.description,t.description)&&arrayEquivilence(this.tags,t.tags)}pipe(){return pipeArguments(this,arguments)}}const isMetricKey=e=>hasProperty(e,MetricKeyTypeId),counter$3=(e,t)=>new MetricKeyImpl(e,counter$4(t),fromNullable(t==null?void 0:t.description)),histogram$3=(e,t,r)=>new MetricKeyImpl(e,histogram$4(t),fromNullable(r)),taggedWithLabels$1=dual(2,(e,t)=>t.length===0?e:new MetricKeyImpl(e.name,e.keyType,e.description,union$2(e.tags,t))),TypeId$1=Symbol.for("effect/MutableHashMap"),MutableHashMapProto={[TypeId$1]:TypeId$1,[Symbol.iterator](){return new MutableHashMapIterator(this)},toString(){return format$3(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(toJSON$1)}},[NodeInspectSymbol](){return this.toJSON()},pipe(){return pipeArguments(this,arguments)}};class MutableHashMapIterator{constructor(t){ie(this,"self");ie(this,"referentialIterator");ie(this,"bucketIterator");this.self=t,this.referentialIterator=t.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const t=this.referentialIterator.next();return t.done?(this.bucketIterator=new BucketIterator(this.self.buckets.values()),this.next()):t}[Symbol.iterator](){return new MutableHashMapIterator(this.self)}}class BucketIterator{constructor(t){ie(this,"backing");ie(this,"currentBucket");this.backing=t}next(){if(this.currentBucket===void 0){const r=this.backing.next();if(r.done)return r;this.currentBucket=r.value[Symbol.iterator]()}const t=this.currentBucket.next();return t.done?(this.currentBucket=void 0,this.next()):t}}const empty$2=()=>{const e=Object.create(MutableHashMapProto);return e.referential=new Map,e.buckets=new Map,e.bucketsSize=0,e},get$2=dual(2,(e,t)=>{if(isEqual(t)===!1)return e.referential.has(t)?some(e.referential.get(t)):none$4();const r=t[symbol$1](),n=e.buckets.get(r);return n===void 0?none$4():getFromBucket(e,n,t)}),getFromBucket=(e,t,r,n=!1)=>{for(let o=0,s=t.length;o<s;o++)if(r[symbol](t[o][0])){const a=t[o][1];return n&&(t.splice(o,1),e.bucketsSize--),some(a)}return none$4()},has=dual(2,(e,t)=>isSome(get$2(e,t))),set=dual(3,(e,t,r)=>{if(isEqual(t)===!1)return e.referential.set(t,r),e;const n=t[symbol$1](),o=e.buckets.get(n);return o===void 0?(e.buckets.set(n,[[t,r]]),e.bucketsSize++,e):(removeFromBucket(e,o,t),o.push([t,r]),e.bucketsSize++,e)}),removeFromBucket=(e,t,r)=>{for(let n=0,o=t.length;n<o;n++)if(r[symbol](t[n][0])){t.splice(n,1),e.bucketsSize--;return}},MetricStateSymbolKey="effect/MetricState",MetricStateTypeId=Symbol.for(MetricStateSymbolKey),CounterStateSymbolKey="effect/MetricState/Counter",CounterStateTypeId=Symbol.for(CounterStateSymbolKey),FrequencyStateSymbolKey="effect/MetricState/Frequency",FrequencyStateTypeId=Symbol.for(FrequencyStateSymbolKey),GaugeStateSymbolKey="effect/MetricState/Gauge",GaugeStateTypeId=Symbol.for(GaugeStateSymbolKey),HistogramStateSymbolKey="effect/MetricState/Histogram",HistogramStateTypeId=Symbol.for(HistogramStateSymbolKey),SummaryStateSymbolKey="effect/MetricState/Summary",SummaryStateTypeId=Symbol.for(SummaryStateSymbolKey),metricStateVariance={_A:e=>e};class CounterState{constructor(t){ie(this,"count");ie(this,hs,metricStateVariance);ie(this,ls,CounterStateTypeId);this.count=t}[(hs=MetricStateTypeId,ls=CounterStateTypeId,symbol$1)](){return pipe(hash$1(CounterStateSymbolKey),combine$6(hash$1(this.count)),cached(this))}[symbol](t){return isCounterState(t)&&this.count===t.count}pipe(){return pipeArguments(this,arguments)}}const arrayEquals=getEquivalence$2(equals$3);class FrequencyState{constructor(t){ie(this,"occurrences");ie(this,ds,metricStateVariance);ie(this,us,FrequencyStateTypeId);ie(this,"_hash");this.occurrences=t}[(ds=MetricStateTypeId,us=FrequencyStateTypeId,symbol$1)](){return pipe(string(FrequencyStateSymbolKey),combine$6(array(fromIterable$6(this.occurrences.entries()))),cached(this))}[symbol](t){return isFrequencyState(t)&&arrayEquals(fromIterable$6(this.occurrences.entries()),fromIterable$6(t.occurrences.entries()))}pipe(){return pipeArguments(this,arguments)}}class GaugeState{constructor(t){ie(this,"value");ie(this,_s,metricStateVariance);ie(this,ps,GaugeStateTypeId);this.value=t}[(_s=MetricStateTypeId,ps=GaugeStateTypeId,symbol$1)](){return pipe(hash$1(GaugeStateSymbolKey),combine$6(hash$1(this.value)),cached(this))}[symbol](t){return isGaugeState(t)&&this.value===t.value}pipe(){return pipeArguments(this,arguments)}}class HistogramState{constructor(t,r,n,o,s){ie(this,"buckets");ie(this,"count");ie(this,"min");ie(this,"max");ie(this,"sum");ie(this,ys,metricStateVariance);ie(this,gs,HistogramStateTypeId);this.buckets=t,this.count=r,this.min=n,this.max=o,this.sum=s}[(ys=MetricStateTypeId,gs=HistogramStateTypeId,symbol$1)](){return pipe(hash$1(HistogramStateSymbolKey),combine$6(hash$1(this.buckets)),combine$6(hash$1(this.count)),combine$6(hash$1(this.min)),combine$6(hash$1(this.max)),combine$6(hash$1(this.sum)),cached(this))}[symbol](t){return isHistogramState(t)&&equals$3(this.buckets,t.buckets)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return pipeArguments(this,arguments)}}class SummaryState{constructor(t,r,n,o,s,a){ie(this,"error");ie(this,"quantiles");ie(this,"count");ie(this,"min");ie(this,"max");ie(this,"sum");ie(this,Ss,metricStateVariance);ie(this,bs,SummaryStateTypeId);this.error=t,this.quantiles=r,this.count=n,this.min=o,this.max=s,this.sum=a}[(Ss=MetricStateTypeId,bs=SummaryStateTypeId,symbol$1)](){return pipe(hash$1(SummaryStateSymbolKey),combine$6(hash$1(this.error)),combine$6(hash$1(this.quantiles)),combine$6(hash$1(this.count)),combine$6(hash$1(this.min)),combine$6(hash$1(this.max)),combine$6(hash$1(this.sum)),cached(this))}[symbol](t){return isSummaryState(t)&&this.error===t.error&&equals$3(this.quantiles,t.quantiles)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return pipeArguments(this,arguments)}}const counter$2=e=>new CounterState(e),frequency$1=e=>new FrequencyState(e),gauge$1=e=>new GaugeState(e),histogram$2=e=>new HistogramState(e.buckets,e.count,e.min,e.max,e.sum),summary$1=e=>new SummaryState(e.error,e.quantiles,e.count,e.min,e.max,e.sum),isCounterState=e=>hasProperty(e,CounterStateTypeId),isFrequencyState=e=>hasProperty(e,FrequencyStateTypeId),isGaugeState=e=>hasProperty(e,GaugeStateTypeId),isHistogramState=e=>hasProperty(e,HistogramStateTypeId),isSummaryState=e=>hasProperty(e,SummaryStateTypeId),MetricHookSymbolKey="effect/MetricHook",MetricHookTypeId=Symbol.for(MetricHookSymbolKey),metricHookVariance={_In:e=>e,_Out:e=>e},make$7=e=>({[MetricHookTypeId]:metricHookVariance,pipe(){return pipeArguments(this,arguments)},...e}),bigint0=BigInt(0),counter$1=e=>{let t=e.keyType.bigint?bigint0:0;const r=e.keyType.incremental?e.keyType.bigint?n=>n>=bigint0:n=>n>=0:n=>!0;return make$7({get:()=>counter$2(t),update:n=>{r(n)&&(t=t+n)}})},frequency=e=>{const t=new Map;for(const r of e.keyType.preregisteredWords)t.set(r,0);return make$7({get:()=>frequency$1(t),update:r=>{const n=t.get(r)??0;t.set(r,n+1)}})},gauge=(e,t)=>{let r=t;return make$7({get:()=>gauge$1(r),update:n=>{r=n}})},histogram$1=e=>{const t=e.keyType.boundaries.values,r=t.length,n=new Uint32Array(r+1),o=new Float32Array(r);let s=0,a=0,c=Number.MAX_VALUE,l=Number.MIN_VALUE;pipe(t,sort(Order$1),map$5((d,f)=>{o[f]=d}));const h=d=>{let f=0,_=r;for(;f!==_;){const p=Math.floor(f+(_-f)/2),y=o[p];d<=y?_=p:f=p,_===f+1&&(d<=o[f]?_=f:f=_)}n[f]=n[f]+1,s=s+1,a=a+d,d<c&&(c=d),d>l&&(l=d)},u=()=>{const d=allocate(r);let f=0;for(let _=0;_<r;_++){const p=o[_],y=n[_];f=f+y,d[_]=[p,f]}return d};return make$7({get:()=>histogram$2({buckets:u(),count:s,min:c,max:l,sum:a}),update:h})},summary=e=>{const{error:t,maxAge:r,maxSize:n,quantiles:o}=e.keyType,s=pipe(o,sort(Order$1)),a=allocate(n);let c=0,l=0,h=0,u=Number.MAX_VALUE,d=Number.MIN_VALUE;const f=p=>{const y=[];let w=0;for(;w!==n-1;){const E=a[w];if(E!=null){const[x,B]=E,P=millis(p-x);greaterThanOrEqualTo$1(P,zero)&&P<=r&&y.push(B)}w=w+1}return calculateQuantiles(t,s,sort(y,Order$1))},_=(p,y)=>{if(n>0){c=c+1;const w=c%n;a[w]=[y,p]}l=l+1,h=h+p,p<u&&(u=p),p>d&&(d=p)};return make$7({get:()=>summary$1({error:t,quantiles:f(Date.now()),count:l,min:u,max:d,sum:h}),update:([p,y])=>_(p,y)})},calculateQuantiles=(e,t,r)=>{const n=r.length;if(!isNonEmptyReadonlyArray(t))return empty$k();const o=t[0],s=t.slice(1),a=resolveQuantile(e,n,none$4(),0,o,r),c=of$2(a);return s.forEach(l=>{c.push(resolveQuantile(e,n,a.value,a.consumed,l,a.rest))}),map$5(c,l=>[l.quantile,l.value])},resolveQuantile=(e,t,r,n,o,s)=>{let a=e,c=t,l=r,h=n,u=o,d=s,f=e,_=t,p=r,y=n,w=o,E=s;for(;;){if(!isNonEmptyReadonlyArray(d))return{quantile:u,value:none$4(),consumed:h,rest:[]};if(u===1)return{quantile:u,value:some(lastNonEmpty(d)),consumed:h+d.length,rest:[]};const x=span$1(d,G=>G<=d[0]),B=u*c,P=a/2*B,U=h+x[0].length,F=Math.abs(U-B);if(U<B-P){f=a,_=c,p=head$4(d),y=U,w=u,E=x[1],a=f,c=_,l=p,h=y,u=w,d=E;continue}if(U>B+P)return{quantile:u,value:l,consumed:h,rest:d};switch(l._tag){case"None":{f=a,_=c,p=head$4(d),y=U,w=u,E=x[1],a=f,c=_,l=p,h=y,u=w,d=E;continue}case"Some":{const G=Math.abs(B-l.value);if(F<G){f=a,_=c,p=head$4(d),y=U,w=u,E=x[1],a=f,c=_,l=p,h=y,u=w,d=E;continue}return{quantile:u,value:some(l.value),consumed:h,rest:d}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},MetricPairSymbolKey="effect/MetricPair",MetricPairTypeId=Symbol.for(MetricPairSymbolKey),metricPairVariance={_Type:e=>e},unsafeMake=(e,t)=>({[MetricPairTypeId]:metricPairVariance,metricKey:e,metricState:t,pipe(){return pipeArguments(this,arguments)}}),MetricRegistrySymbolKey="effect/MetricRegistry",MetricRegistryTypeId=Symbol.for(MetricRegistrySymbolKey);vs=MetricRegistryTypeId;class MetricRegistryImpl{constructor(){ie(this,vs,MetricRegistryTypeId);ie(this,"map",empty$2())}snapshot(){const t=[];for(const[r,n]of this.map)t.push(unsafeMake(r,n.get()));return t}get(t){const r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){if(isCounterKey(t.keyType))return this.getCounter(t);if(isGaugeKey(t.keyType))return this.getGauge(t);if(isFrequencyKey(t.keyType))return this.getFrequency(t);if(isHistogramKey(t.keyType))return this.getHistogram(t);if(isSummaryKey(t.keyType))return this.getSummary(t);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return r}getCounter(t){let r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){const n=counter$1(t);pipe(this.map,has(t))||pipe(this.map,set(t,n)),r=n}return r}getFrequency(t){let r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){const n=frequency(t);pipe(this.map,has(t))||pipe(this.map,set(t,n)),r=n}return r}getGauge(t){let r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){const n=gauge(t,t.keyType.bigint?BigInt(0):0);pipe(this.map,has(t))||pipe(this.map,set(t,n)),r=n}return r}getHistogram(t){let r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){const n=histogram$1(t);pipe(this.map,has(t))||pipe(this.map,set(t,n)),r=n}return r}getSummary(t){let r=pipe(this.map,get$2(t),getOrUndefined);if(r==null){const n=summary(t);pipe(this.map,has(t))||pipe(this.map,set(t,n)),r=n}return r}}const make$6=()=>new MetricRegistryImpl,MetricSymbolKey="effect/Metric",MetricTypeId=Symbol.for(MetricSymbolKey),metricVariance={_Type:e=>e,_In:e=>e,_Out:e=>e},globalMetricRegistry=globalValue(Symbol.for("effect/Metric/globalMetricRegistry"),()=>make$6()),make$5=function(e,t,r){const n=Object.assign(o=>tap(o,s=>update(n,s)),{[MetricTypeId]:metricVariance,keyType:e,unsafeUpdate:t,unsafeValue:r,register(){return this.unsafeValue([]),this},pipe(){return pipeArguments(this,arguments)}});return n},counter=(e,t)=>fromMetricKey(counter$3(e,t)),fromMetricKey=e=>{let t;const r=new WeakMap,n=o=>{if(o.length===0)return t!==void 0||(t=globalMetricRegistry.get(e)),t;let s=r.get(o);return s!==void 0||(s=globalMetricRegistry.get(taggedWithLabels$1(e,o)),r.set(o,s)),s};return make$5(e.keyType,(o,s)=>n(s).update(o),o=>n(o).get())},histogram=(e,t,r)=>fromMetricKey(histogram$3(e,t,r)),tagged=dual(3,(e,t,r)=>taggedWithLabels(e,[make$8(t,r)])),taggedWithLabels=dual(2,(e,t)=>make$5(e.keyType,(r,n)=>e.unsafeUpdate(r,union$2(t,n)),r=>e.unsafeValue(union$2(t,r)))),update=dual(2,(e,t)=>fiberRefGetWith(currentMetricLabels,r=>sync(()=>e.unsafeUpdate(t,r)))),RequestSymbolKey="effect/Request",RequestTypeId=Symbol.for(RequestSymbolKey),requestVariance={_E:e=>e,_A:e=>e};({...StructuralPrototype,[RequestTypeId]:0});const complete=dual(2,(e,t)=>fiberRefGetWith(currentRequestMap,r=>sync(()=>{if(r.has(e)){const n=r.get(e);n.state.completed||(n.state.completed=!0,deferredUnsafeDone(n.result,t))}}))),SupervisorSymbolKey="effect/Supervisor",SupervisorTypeId=Symbol.for(SupervisorSymbolKey),supervisorVariance={_T:e=>e};As=SupervisorTypeId;const vi=class vi{constructor(t,r){ie(this,"underlying");ie(this,"value0");ie(this,As,supervisorVariance);this.underlying=t,this.value0=r}get value(){return this.value0}onStart(t,r,n,o){this.underlying.onStart(t,r,n,o)}onEnd(t,r){this.underlying.onEnd(t,r)}onEffect(t,r){this.underlying.onEffect(t,r)}onSuspend(t){this.underlying.onSuspend(t)}onResume(t){this.underlying.onResume(t)}map(t){return new vi(this,pipe(this.value,map$2(t)))}zip(t){return new Zip(this,t)}};let ProxySupervisor=vi;Es=SupervisorTypeId;const Ai=class Ai{constructor(t,r){ie(this,"left");ie(this,"right");ie(this,"_tag","Zip");ie(this,Es,supervisorVariance);this.left=t,this.right=r}get value(){return zip(this.left.value,this.right.value)}onStart(t,r,n,o){this.left.onStart(t,r,n,o),this.right.onStart(t,r,n,o)}onEnd(t,r){this.left.onEnd(t,r),this.right.onEnd(t,r)}onEffect(t,r){this.left.onEffect(t,r),this.right.onEffect(t,r)}onSuspend(t){this.left.onSuspend(t),this.right.onSuspend(t)}onResume(t){this.left.onResume(t),this.right.onResume(t)}map(t){return new ProxySupervisor(this,pipe(this.value,map$2(t)))}zip(t){return new Ai(this,t)}};let Zip=Ai;const isZip=e=>hasProperty(e,SupervisorTypeId)&&isTagged(e,"Zip");Is=SupervisorTypeId;class Const{constructor(t){ie(this,"effect");ie(this,Is,supervisorVariance);this.effect=t}get value(){return this.effect}onStart(t,r,n,o){}onEnd(t,r){}onEffect(t,r){}onSuspend(t){}onResume(t){}map(t){return new ProxySupervisor(this,pipe(this.value,map$2(t)))}zip(t){return new Zip(this,t)}onRun(t,r){return t()}}const fromEffect=e=>new Const(e),none=globalValue("effect/Supervisor/none",()=>fromEffect(void_)),make$4=make$h,OP_EMPTY="Empty",OP_ADD_SUPERVISOR="AddSupervisor",OP_REMOVE_SUPERVISOR="RemoveSupervisor",OP_AND_THEN="AndThen",empty$1={_tag:OP_EMPTY},combine$1=(e,t)=>({_tag:OP_AND_THEN,first:e,second:t}),patch=(e,t)=>patchLoop(t,of$1(e)),patchLoop=(e,t)=>{let r=e,n=t;for(;isNonEmpty(n);){const o=headNonEmpty(n);switch(o._tag){case OP_EMPTY:{n=tailNonEmpty(n);break}case OP_ADD_SUPERVISOR:{r=r.zip(o.supervisor),n=tailNonEmpty(n);break}case OP_REMOVE_SUPERVISOR:{r=removeSupervisor(r,o.supervisor),n=tailNonEmpty(n);break}case OP_AND_THEN:{n=prepend$1(o.first)(prepend$1(o.second)(tailNonEmpty(n)));break}}}return r},removeSupervisor=(e,t)=>equals$3(e,t)?none:isZip(e)?removeSupervisor(e.left,t).zip(removeSupervisor(e.right,t)):e,toSet=e=>equals$3(e,none)?empty$g():isZip(e)?pipe(toSet(e.left),union(toSet(e.right))):make$l(e),diff$1=(e,t)=>{if(equals$3(e,t))return empty$1;const r=toSet(e),n=toSet(t),o=pipe(n,difference(r),reduce$4(empty$1,(a,c)=>combine$1(a,{_tag:OP_ADD_SUPERVISOR,supervisor:c}))),s=pipe(r,difference(n),reduce$4(empty$1,(a,c)=>combine$1(a,{_tag:OP_REMOVE_SUPERVISOR,supervisor:c})));return combine$1(o,s)},differ=make$4({empty:empty$1,patch,combine:combine$1,diff:diff$1}),fiberStarted=counter("effect_fiber_started",{incremental:!0}),fiberActive=counter("effect_fiber_active"),fiberSuccesses=counter("effect_fiber_successes",{incremental:!0}),fiberFailures=counter("effect_fiber_failures",{incremental:!0}),fiberLifetimes=tagged(histogram("effect_fiber_lifetimes",exponential({start:.5,factor:2,count:35})),"time_unit","milliseconds"),EvaluationSignalContinue="Continue",EvaluationSignalDone="Done",EvaluationSignalYieldNow="Yield",runtimeFiberVariance={_E:e=>e,_A:e=>e},absurd=e=>{throw new Error(`BUG: FiberRuntime - ${toStringUnknown(e)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},YieldedOp=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),yieldedOpChannel=globalValue("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),contOpSuccess={[OP_ON_SUCCESS]:(e,t,r)=>internalCall(()=>t.effect_instruction_i1(r)),OnStep:(e,t,r)=>exitSucceed(exitSucceed(r)),[OP_ON_SUCCESS_AND_FAILURE]:(e,t,r)=>internalCall(()=>t.effect_instruction_i2(r)),[OP_REVERT_FLAGS]:(e,t,r)=>(e.patchRuntimeFlags(e._runtimeFlags,t.patch),interruptible$1(e._runtimeFlags)&&e.isInterrupted()?exitFailCause(e.getInterruptedCause()):exitSucceed(r)),[OP_WHILE]:(e,t,r)=>(internalCall(()=>t.effect_instruction_i2(r)),internalCall(()=>t.effect_instruction_i0())?(e.pushStack(t),internalCall(()=>t.effect_instruction_i1())):void_)},drainQueueWhileRunningTable={[OP_INTERRUPT_SIGNAL]:(e,t,r,n)=>(e.processNewInterruptSignal(n.cause),interruptible$1(t)?exitFailCause(n.cause):r),[OP_RESUME]:(e,t,r,n)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[OP_STATEFUL]:(e,t,r,n)=>(n.onFiber(e,running(t)),r),[OP_YIELD_NOW]:(e,t,r,n)=>flatMap$2(yieldNow$1(),()=>r)},runBlockedRequests=e=>forEachSequentialDiscard(flatten$1(e),t=>forEachConcurrentDiscard(sequentialCollectionToChunk(t),([r,n])=>{const o=new Map,s=[];for(const c of n){s.push(toReadonlyArray(c));for(const l of c)o.set(l.request,l)}const a=s.flat();return fiberRefLocally(invokeWithInterrupt(r.runAll(s),a,()=>a.forEach(c=>{c.listeners.interrupted=!0})),currentRequestMap,o)},!1,!1));class FiberRuntime{constructor(t,r,n){ie(this,xs,fiberVariance);ie(this,Cs,runtimeFiberVariance);ie(this,"_fiberRefs");ie(this,"_fiberId");ie(this,"_runtimeFlags");ie(this,"_queue",new Array);ie(this,"_children",null);ie(this,"_observers",new Array);ie(this,"_running",!1);ie(this,"_stack",[]);ie(this,"_asyncInterruptor",null);ie(this,"_asyncBlockingOn",null);ie(this,"_exitValue",null);ie(this,"_steps",[]);ie(this,"_supervisor");ie(this,"_scheduler");ie(this,"_tracer");ie(this,"currentOpCount",0);ie(this,"isYielding",!1);ie(this,"run",()=>{this.drainQueueOnCurrentThread()});if(this._runtimeFlags=n,this._fiberId=t,this._fiberRefs=r,this._supervisor=this.getFiberRef(currentSupervisor),this._scheduler=this.getFiberRef(currentScheduler),runtimeMetrics(n)){const o=this.getFiberRef(currentMetricLabels);fiberStarted.unsafeUpdate(1,o),fiberActive.unsafeUpdate(1,o)}this._tracer=get$6(this.getFiberRef(currentServices),tracerTag)}pipe(){return pipeArguments(this,arguments)}id(){return this._fiberId}resume(t){this.tell(resume(t))}get status(){return this.ask((t,r)=>r)}get runtimeFlags(){return this.ask((t,r)=>isDone(r)?t._runtimeFlags:r.runtimeFlags)}scope(){return unsafeMake$1(this)}get children(){return this.ask(t=>Array.from(t.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(currentInterruptedCause)}fiberRefs(){return this.ask(t=>t.getFiberRefs())}ask(t){return suspend$2(()=>{const r=deferredUnsafeMake(this._fiberId);return this.tell(stateful((n,o)=>{deferredUnsafeDone(r,sync(()=>t(n,o)))})),deferredAwait(r)})}tell(t){this._queue.push(t),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return async(t=>{const r=n=>t(succeed$2(n));return this.tell(stateful((n,o)=>{n._exitValue!==null?r(this._exitValue):n.addObserver(r)})),sync(()=>this.tell(stateful((n,o)=>{n.removeObserver(r)})))},this.id())}get inheritAll(){return withFiberRuntime((t,r)=>{const n=t.id(),o=t.getFiberRefs(),s=r.runtimeFlags,a=this.getFiberRefs(),c=joinAs(o,n,a);t.setFiberRefs(c);const l=t.getFiberRef(currentRuntimeFlags),h=pipe(diff$4(s,l),exclude(Interruption),exclude(WindDown));return updateRuntimeFlags(h)})}get poll(){return sync(()=>fromNullable(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(t){return sync(()=>this.tell(interruptSignal(interrupt(t))))}unsafeInterruptAsFork(t){this.tell(interruptSignal(interrupt(t)))}addObserver(t){this._exitValue!==null?t(this._exitValue):this._observers.push(t)}removeObserver(t){this._observers=this._observers.filter(r=>r!==t)}getFiberRefs(){return this.setFiberRef(currentRuntimeFlags,this._runtimeFlags),this._fiberRefs}unsafeDeleteFiberRef(t){this._fiberRefs=delete_(this._fiberRefs,t)}getFiberRef(t){return this._fiberRefs.locals.has(t)?this._fiberRefs.locals.get(t)[0][1]:t.initial}setFiberRef(t,r){this._fiberRefs=updateAs(this._fiberRefs,{fiberId:this._fiberId,fiberRef:t,value:r}),this.refreshRefCache()}refreshRefCache(){this._tracer=get$6(this.getFiberRef(currentServices),tracerTag),this._supervisor=this.getFiberRef(currentSupervisor),this._scheduler=this.getFiberRef(currentScheduler)}setFiberRefs(t){this._fiberRefs=t,this.refreshRefCache()}addChild(t){this.getChildren().add(t)}removeChild(t){this.getChildren().delete(t)}drainQueueOnCurrentThread(){let t=!0;for(;t;){let r=EvaluationSignalContinue;const n=globalThis[currentFiberURI];globalThis[currentFiberURI]=this;try{for(;r===EvaluationSignalContinue;)r=this._queue.length===0?EvaluationSignalDone:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[currentFiberURI]=n}this._queue.length>0&&!this._running?(this._running=!0,r===EvaluationSignalYieldNow?(this.drainQueueLaterOnExecutor(),t=!1):t=!0):t=!1}}drainQueueLaterOnExecutor(){this._scheduler.scheduleTask(this.run,this.getFiberRef(currentSchedulingPriority))}drainQueueWhileRunning(t,r){let n=r;for(;this._queue.length>0;){const o=this._queue.splice(0,1)[0];n=drainQueueWhileRunningTable[o._tag](this,t,n,o)}return n}isInterrupted(){return!isEmpty$1(this.getFiberRef(currentInterruptedCause))}addInterruptedCause(t){const r=this.getFiberRef(currentInterruptedCause);this.setFiberRef(currentInterruptedCause,sequential$2(r,t))}processNewInterruptSignal(t){this.addInterruptedCause(t),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let t=!1;for(const r of this._children)r.tell(interruptSignal(interrupt(this.id()))),t=!0;return t}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const t=this._children.values();this._children=null;let r=!1;return whileLoop({while:()=>!r,body:()=>{const n=t.next();return n.done?sync(()=>{r=!0}):asVoid(n.value.await)},step:()=>{}})}return null}reportExitValue(t){if(runtimeMetrics(this._runtimeFlags)){const r=this.getFiberRef(currentMetricLabels),n=this.id().startTimeMillis,o=Date.now();switch(fiberLifetimes.unsafeUpdate(o-n,r),fiberActive.unsafeUpdate(-1,r),t._tag){case OP_SUCCESS:{fiberSuccesses.unsafeUpdate(1,r);break}case OP_FAILURE:{fiberFailures.unsafeUpdate(1,r);break}}}if(t._tag==="Failure"){const r=this.getFiberRef(currentUnhandledErrorLogLevel);!isInterruptedOnly(t.cause)&&r._tag==="Some"&&this.log("Fiber terminated with an unhandled error",t.cause,r)}}setExitValue(t){this._exitValue=t,this.reportExitValue(t);for(let r=this._observers.length-1;r>=0;r--)this._observers[r](t)}getLoggers(){return this.getFiberRef(currentLoggers)}log(t,r,n){const o=isSome(n)?n.value:this.getFiberRef(currentLogLevel),s=this.getFiberRef(currentMinimumLogLevel);if(greaterThan$1(s,o))return;const a=this.getFiberRef(currentLogSpan),c=this.getFiberRef(currentLogAnnotations),l=this.getLoggers(),h=this.getFiberRefs();if(size$1(l)>0){const u=get$6(this.getFiberRef(currentServices),clockTag),d=new Date(u.unsafeCurrentTimeMillis());for(const f of l)f.log({fiberId:this.id(),logLevel:o,message:t,cause:r,context:h,spans:a,annotations:c,date:d})}}evaluateMessageWhileSuspended(t){switch(t._tag){case OP_YIELD_NOW:return EvaluationSignalYieldNow;case OP_INTERRUPT_SIGNAL:return this.processNewInterruptSignal(t.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(exitFailCause(t.cause)),this._asyncInterruptor=null),EvaluationSignalContinue;case OP_RESUME:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(t.effect),EvaluationSignalContinue;case OP_STATEFUL:return t.onFiber(this,this._exitValue!==null?done:suspended(this._runtimeFlags,this._asyncBlockingOn)),EvaluationSignalContinue;default:return absurd(t)}}evaluateEffect(t){this._supervisor.onResume(this);try{let r=interruptible$1(this._runtimeFlags)&&this.isInterrupted()?exitFailCause(this.getInterruptedCause()):t;for(;r!==null;){const n=r,o=this.runLoop(n);if(o===YieldedOp){const s=yieldedOpChannel.currentOp;yieldedOpChannel.currentOp=null,s._op===OP_YIELD?cooperativeYielding(this._runtimeFlags)?(this.tell(yieldNow()),this.tell(resume(exitVoid)),r=null):r=exitVoid:s._op===OP_ASYNC&&(r=null)}else{this._runtimeFlags=pipe(this._runtimeFlags,enable$1(WindDown));const s=this.interruptAllChildren();s!==null?r=flatMap$2(s,()=>o):(this._queue.length===0?this.setExitValue(o):this.tell(resume(o)),r=null)}}}finally{this._supervisor.onSuspend(this)}}start(t){if(this._running)this.tell(resume(t));else{this._running=!0;const r=globalThis[currentFiberURI];globalThis[currentFiberURI]=this;try{this.evaluateEffect(t)}finally{this._running=!1,globalThis[currentFiberURI]=r,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(t){this.tell(resume(t))}patchRuntimeFlags(t,r){const n=patch$4(t,r);return globalThis[currentFiberURI]=this,this._runtimeFlags=n,n}initiateAsync(t,r){let n=!1;const o=s=>{n||(n=!0,this.tell(resume(s)))};interruptible$1(t)&&(this._asyncInterruptor=o);try{r(o)}catch(s){o(failCause(die$1(s)))}}pushStack(t){this._stack.push(t),t._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this._runtimeFlags})}popStack(){const t=this._stack.pop();if(t)return t._op==="OnStep"&&this._steps.pop(),t}getNextSuccessCont(){let t=this.popStack();for(;t;){if(t._op!==OP_ON_FAILURE)return t;t=this.popStack()}}getNextFailCont(){let t=this.popStack();for(;t;){if(t._op!==OP_ON_SUCCESS&&t._op!==OP_WHILE)return t;t=this.popStack()}}[(xs=FiberTypeId,Cs=RuntimeFiberTypeId,OP_TAG)](t){return map$2(fiberRefGet(currentContext$1),r=>unsafeGet(r,t))}Left(t){return fail$1(t.left)}None(t){return fail$1(new NoSuchElementException)}Right(t){return exitSucceed(t.right)}Some(t){return exitSucceed(t.value)}Micro(t){return unsafeAsync(r=>{const n=envUnsafeMakeEmpty().pipe(envSet(currentContext,this.getFiberRef(currentContext$1)));let o=r;return t[runSymbol](n,s=>{if(s._tag==="Right")return o(exitSucceed(s.right));switch(s.left._tag){case"Aborted":return o(exitFailCause(interrupt(none$2)));case"Expected":return o(fail$1(s.left.error));case"Unexpected":return o(die(s.left.defect))}}),async(s=>{o=a=>{s(void_)},envGet(n,currentAbortController).abort()})})}[OP_SYNC](t){const r=internalCall(()=>t.effect_instruction_i0()),n=this.getNextSuccessCont();return n!==void 0?(n._op in contOpSuccess||absurd(n),contOpSuccess[n._op](this,n,r)):(yieldedOpChannel.currentOp=exitSucceed(r),YieldedOp)}[OP_SUCCESS](t){const r=t,n=this.getNextSuccessCont();return n!==void 0?(n._op in contOpSuccess||absurd(n),contOpSuccess[n._op](this,n,r.effect_instruction_i0)):(yieldedOpChannel.currentOp=r,YieldedOp)}[OP_FAILURE](t){const r=t.effect_instruction_i0,n=this.getNextFailCont();if(n!==void 0)switch(n._op){case OP_ON_FAILURE:case OP_ON_SUCCESS_AND_FAILURE:return interruptible$1(this._runtimeFlags)&&this.isInterrupted()?exitFailCause(stripFailures(r)):internalCall(()=>n.effect_instruction_i1(r));case"OnStep":return interruptible$1(this._runtimeFlags)&&this.isInterrupted()?exitFailCause(stripFailures(r)):exitSucceed(exitFailCause(r));case OP_REVERT_FLAGS:return this.patchRuntimeFlags(this._runtimeFlags,n.patch),interruptible$1(this._runtimeFlags)&&this.isInterrupted()?exitFailCause(sequential$2(r,this.getInterruptedCause())):exitFailCause(r);default:absurd(n)}else return yieldedOpChannel.currentOp=exitFailCause(r),YieldedOp}[OP_WITH_RUNTIME](t){return internalCall(()=>t.effect_instruction_i0(this,running(this._runtimeFlags)))}Blocked(t){const r=this.getFiberRefs(),n=this._runtimeFlags;if(this._steps.length>0){const o=[],s=this._steps[this._steps.length-1];let a=this.popStack();for(;a&&a._op!=="OnStep";)o.push(a),a=this.popStack();this.setFiberRefs(s.refs),this._runtimeFlags=s.flags;const c=diff$2(s.refs,r),l=diff$4(s.flags,n);return exitSucceed(blocked(t.effect_instruction_i0,withFiberRuntime(h=>{for(;o.length>0;)h.pushStack(o.pop());return h.setFiberRefs(patch$1(h.id(),h.getFiberRefs())(c)),h._runtimeFlags=patch$4(l)(h._runtimeFlags),t.effect_instruction_i1})))}return uninterruptibleMask(o=>flatMap$2(forkDaemon(runRequestBlock(t.effect_instruction_i0)),()=>o(t.effect_instruction_i1)))}RunBlocked(t){return runBlockedRequests(t.effect_instruction_i0)}[OP_UPDATE_RUNTIME_FLAGS](t){const r=t.effect_instruction_i0,n=this._runtimeFlags,o=patch$4(n,r);if(interruptible$1(o)&&this.isInterrupted())return exitFailCause(this.getInterruptedCause());if(this.patchRuntimeFlags(this._runtimeFlags,r),t.effect_instruction_i1){const s=diff$4(o,n);return this.pushStack(new RevertFlags(s,t)),internalCall(()=>t.effect_instruction_i1(n))}else return exitVoid}[OP_ON_SUCCESS](t){return this.pushStack(t),t.effect_instruction_i0}OnStep(t){return this.pushStack(t),t.effect_instruction_i0}[OP_ON_FAILURE](t){return this.pushStack(t),t.effect_instruction_i0}[OP_ON_SUCCESS_AND_FAILURE](t){return this.pushStack(t),t.effect_instruction_i0}[OP_ASYNC](t){return this._asyncBlockingOn=t.effect_instruction_i1,this.initiateAsync(this._runtimeFlags,t.effect_instruction_i0),yieldedOpChannel.currentOp=t,YieldedOp}[OP_YIELD](t){return this.isYielding=!1,yieldedOpChannel.currentOp=t,YieldedOp}[OP_WHILE](t){const r=t.effect_instruction_i0,n=t.effect_instruction_i1;return r()?(this.pushStack(t),n()):exitVoid}[OP_COMMIT](t){return internalCall(()=>t.commit())}runLoop(t){let r=t;for(this.currentOpCount=0;;){if(this._runtimeFlags&OpSupervision&&this._supervisor.onEffect(this,r),this._queue.length>0&&(r=this.drainQueueWhileRunning(this._runtimeFlags,r)),!this.isYielding){this.currentOpCount+=1;const n=this._scheduler.shouldYield(this);if(n!==!1){this.isYielding=!0,this.currentOpCount=0;const o=r;r=flatMap$2(yieldNow$1({priority:n}),()=>o)}}try{if((!("_op"in r)||!(r._op in this))&&absurd(r),r=this._tracer.context(()=>getCurrentVersion()!==r[EffectTypeId]._V?dieMessage(`Cannot execute an Effect versioned ${r[EffectTypeId]._V} with a Runtime of version ${getCurrentVersion()}`):this[r._op](r),this),r===YieldedOp){const n=yieldedOpChannel.currentOp;return n._op===OP_YIELD||n._op===OP_ASYNC?YieldedOp:(yieldedOpChannel.currentOp=null,n._op===OP_SUCCESS||n._op===OP_FAILURE?n:exitFailCause(die$1(n)))}}catch(n){isEffectError(n)?r=exitFailCause(n.cause):isInterruptedException(n)?r=exitFailCause(sequential$2(die$1(n),interrupt(none$2))):r=die(n)}}}}const currentMinimumLogLevel=globalValue("effect/FiberRef/currentMinimumLogLevel",()=>fiberRefUnsafeMake(fromLiteral("Info"))),loggerWithConsoleLog=e=>makeLogger(t=>{const r=getOrDefault(t.context,currentServices);get$6(r,consoleTag).unsafe.log(e.log(t))}),defaultLogger=globalValue(Symbol.for("effect/Logger/defaultLogger"),()=>loggerWithConsoleLog(stringLogger)),tracerLogger=globalValue(Symbol.for("effect/Logger/tracerLogger"),()=>makeLogger(({annotations:e,cause:t,context:r,fiberId:n,logLevel:o,message:s})=>{const a=flatMap$4(get$3(r,currentContext$1),getOption(spanTag)),c=map$6(get$3(r,currentServices),h=>get$6(h,clockTag));if(a._tag==="None"||a.value._tag==="ExternalSpan"||c._tag==="None")return;const l=Object.fromEntries(map$3(e,toStringUnknown));l["effect.fiberId"]=threadName(n),l["effect.logLevel"]=o.label,t!==null&&t._tag!=="Empty"&&(l["effect.cause"]=pretty(t)),a.value.event(String(s),c.value.unsafeCurrentTimeNanos(),l)})),currentLoggers=globalValue(Symbol.for("effect/FiberRef/currentLoggers"),()=>fiberRefUnsafeMakeHashSet(make$l(defaultLogger,tracerLogger))),forEach$1=dual(e=>isIterable(e[0]),(e,t,r)=>withFiberRuntime(n=>{const o=(r==null?void 0:r.batching)===!0||(r==null?void 0:r.batching)==="inherit"&&n.getFiberRef(currentRequestBatching);return r!=null&&r.discard?match(r.concurrency,()=>finalizersMask(sequential)(s=>o?forEachConcurrentDiscard(e,(a,c)=>s(t(a,c)),!0,!1,1):forEachSequentialDiscard(e,(a,c)=>s(t(a,c)))),()=>finalizersMask(parallel$1)(s=>forEachConcurrentDiscard(e,(a,c)=>s(t(a,c)),o,!1)),s=>finalizersMask(parallelN(s))(a=>forEachConcurrentDiscard(e,(c,l)=>a(t(c,l)),o,!1,s))):match(r==null?void 0:r.concurrency,()=>finalizersMask(sequential)(s=>o?forEachParN(e,1,(a,c)=>s(t(a,c)),!0):forEachSequential(e,(a,c)=>s(t(a,c)))),()=>finalizersMask(parallel$1)(s=>forEachParUnbounded(e,(a,c)=>s(t(a,c)),o)),s=>finalizersMask(parallelN(s))(a=>forEachParN(e,s,(c,l)=>a(t(c,l)),o)))})),forEachParUnbounded=(e,t,r)=>suspend$2(()=>{const n=fromIterable$6(e),o=new Array(n.length);return zipRight(forEachConcurrentDiscard(n,(s,a)=>flatMap$2(t(s,a),c=>sync(()=>o[a]=c)),r,!1),succeed$2(o))}),forEachConcurrentDiscard=(e,t,r,n,o)=>uninterruptibleMask(s=>transplant(a=>withFiberRuntime(c=>{let l=Array.from(e).reverse(),h=l.length;if(h===0)return void_;let u=0,d=!1;const f=o?Math.min(l.length,o):l.length,_=new Set,p=new Array,y=()=>_.forEach(H=>{H._scheduler.scheduleTask(()=>{H.unsafeInterruptAsFork(c.id())},0)}),w=new Array,E=new Array,x=new Array,B=()=>{const H=p.filter(({exit:te})=>te._tag==="Failure").sort((te,J)=>te.index<J.index?-1:te.index===J.index?0:1).map(({exit:te})=>te);return H.length===0&&H.push(exitVoid),H},P=(H,te=!1)=>{const J=uninterruptible(a(H)),le=unsafeForkUnstarted(J,c,c._runtimeFlags,globalScope);return c._scheduler.scheduleTask(()=>{te&&le.unsafeInterruptAsFork(c.id()),le.resume(J)},0),le},U=()=>{n||(h-=l.length,l=[]),d=!0,y()},F=r?step:exit,G=P(async(H=>{const te=(le,z)=>{le._op==="Blocked"?x.push(le):(p.push({index:z,exit:le}),le._op==="Failure"&&!d&&U())},J=()=>{if(l.length>0){const le=l.pop();let z=u++;const q=()=>{const ee=l.pop();return z=u++,flatMap$2(yieldNow$1(),()=>flatMap$2(F(s(t(ee,z))),he))},he=ee=>l.length>0&&(te(ee,z),l.length>0)?q():succeed$2(ee),V=flatMap$2(F(s(t(le,z))),he),_e=P(V);w.push(_e),_.add(_e),d&&_e._scheduler.scheduleTask(()=>{_e.unsafeInterruptAsFork(c.id())},0),_e.addObserver(ee=>{let W;if(ee._op==="Failure"?W=ee:W=ee.effect_instruction_i0,E.push(_e),_.delete(_e),te(W,z),p.length===h)H(succeed$2(getOrElse(exitCollectAll(B(),{parallel:!0}),()=>exitVoid)));else if(x.length+p.length===h){const re=x.map(ne=>ne.effect_instruction_i0).reduce(par);H(succeed$2(blocked(re,forEachConcurrentDiscard([getOrElse(exitCollectAll(B(),{parallel:!0}),()=>exitVoid),...x.map(ne=>ne.effect_instruction_i1)],ne=>ne,r,!0,o))))}else J()})}};for(let le=0;le<f;le++)J()}));return asVoid(onExit(flatten(s(join(G))),exitMatch({onFailure:()=>{U();const H=x.length+1,te=Math.min(typeof o=="number"?o:x.length,x.length),J=Array.from(x);return async(le=>{const z=[];let q=0,he=0;const V=(ee,W)=>re=>{z[ee]=re,q++,q===H&&le(getOrThrow(exitCollectAll(z,{parallel:!0}))),J.length>0&&W&&_e()},_e=()=>{P(J.pop(),!0).addObserver(V(he,!0)),he++};G.addObserver(V(he,!1)),he++;for(let ee=0;ee<te;ee++)_e()})},onSuccess:()=>forEachSequential(E,H=>H.inheritAll)})))}))),forEachParN=(e,t,r,n)=>suspend$2(()=>{const o=fromIterable$6(e),s=new Array(o.length);return zipRight(forEachConcurrentDiscard(o,(a,c)=>map$2(r(a,c),l=>s[c]=l),n,!1,t),succeed$2(s))}),forkDaemon=e=>forkWithScopeOverride(e,globalScope),unsafeFork$1=(e,t,r,n=null)=>{const o=unsafeMakeChildFiber(e,t,r,n);return o.resume(e),o},unsafeForkUnstarted=(e,t,r,n=null)=>unsafeMakeChildFiber(e,t,r,n),unsafeMakeChildFiber=(e,t,r,n=null)=>{const o=unsafeMake$3(),s=t.getFiberRefs(),a=forkAs(s,o),c=new FiberRuntime(o,a,r),l=getOrDefault$1(a,currentContext$1),h=c._supervisor;return h.onStart(l,e,some(t),c),c.addObserver(u=>h.onEnd(u,c)),(n!==null?n:pipe(t.getFiberRef(currentForkScopeOverride),getOrElse(()=>t.scope()))).add(r,c),c},forkWithScopeOverride=(e,t)=>withFiberRuntime((r,n)=>succeed$2(unsafeFork$1(e,r,n.runtimeFlags,t))),parallelFinalizers=e=>contextWithEffect(t=>match$3(getOption(t,scopeTag),{onNone:()=>e,onSome:r=>{switch(r.strategy._tag){case"Parallel":return e;case"Sequential":case"ParallelN":return flatMap$2(scopeFork(r,parallel$1),n=>scopeExtend(e,n))}}})),parallelNFinalizers=e=>t=>contextWithEffect(r=>match$3(getOption(r,scopeTag),{onNone:()=>t,onSome:n=>n.strategy._tag==="ParallelN"&&n.strategy.parallelism===e?t:flatMap$2(scopeFork(n,parallelN(e)),o=>scopeExtend(t,o))})),finalizersMask=e=>t=>contextWithEffect(r=>match$3(getOption(r,scopeTag),{onNone:()=>t(identity$1),onSome:n=>{const o=e._tag==="Parallel"?parallelFinalizers:e._tag==="Sequential"?sequentialFinalizers:parallelNFinalizers(e.parallelism);switch(n.strategy._tag){case"Parallel":return o(t(parallelFinalizers));case"Sequential":return o(t(sequentialFinalizers));case"ParallelN":return o(t(parallelNFinalizers(n.strategy.parallelism)))}}})),sequentialFinalizers=e=>contextWithEffect(t=>match$3(getOption(t,scopeTag),{onNone:()=>e,onSome:r=>{switch(r.strategy._tag){case"Sequential":return e;case"Parallel":case"ParallelN":return flatMap$2(scopeFork(r,sequential),n=>scopeExtend(e,n))}}})),scopeTag=GenericTag("effect/Scope"),scopeExtend=dual(2,(e,t)=>mapInputContext(e,merge$2(make$j(scopeTag,t)))),fiberRefUnsafeMakeSupervisor=e=>fiberRefUnsafeMakePatch(e,{differ,fork:empty$1}),currentRuntimeFlags=fiberRefUnsafeMakeRuntimeFlags(none$1),currentSupervisor=fiberRefUnsafeMakeSupervisor(none),invokeWithInterrupt=(e,t,r)=>fiberIdWith(n=>flatMap$2(flatMap$2(forkDaemon(interruptible(e)),o=>async(s=>{const a=t.map(h=>h.listeners.count),c=()=>{a.every(h=>h===0)&&t.every(h=>h.result.state.current._tag==="Pending"?!0:!!(h.result.state.current._tag==="Done"&&exitIsExit(h.result.state.current.effect)&&h.result.state.current.effect._tag==="Failure"&&isInterrupted(h.result.state.current.effect.cause)))&&(l.forEach(h=>h()),r==null||r(),s(interruptFiber(o)))};o.addObserver(h=>{l.forEach(u=>u()),s(h)});const l=t.map((h,u)=>{const d=f=>{a[u]=f,c()};return h.listeners.addObserver(d),()=>h.listeners.removeObserver(d)});return c(),sync(()=>{l.forEach(h=>h())})})),()=>suspend$2(()=>{const o=t.flatMap(s=>s.state.completed?[]:[s]);return forEachSequentialDiscard(o,s=>complete(s.request,exitInterrupt(n)))}))),close=scopeClose,fork=scopeFork,unsafeFork=e=>(t,r)=>{const n=unsafeMake$3(),o=[[currentContext$1,[[n,e.context]]]];r!=null&&r.scheduler&&o.push([currentScheduler,[[n,r.scheduler]]]);let s=updateManyAs(e.fiberRefs,{entries:o,forkAs:n});r!=null&&r.updateRefs&&(s=r.updateRefs(s,n));const a=new FiberRuntime(n,s,e.runtimeFlags);let c=t;r!=null&&r.scope&&(c=flatMap$2(fork(r.scope,sequential$1),h=>zipRight(scopeAddFinalizer(h,fiberIdWith(u=>equals$3(u,a.id())?void_:interruptAsFiber(a,u))),onExit(t,u=>close(h,u)))));const l=a._supervisor;return l!==none&&(l.onStart(e.context,c,none$4(),a),a.addObserver(h=>l.onEnd(h,a))),globalScope.add(e.runtimeFlags,a),(r==null?void 0:r.immediate)===!1?a.resume(c):a.start(c),a},unsafeRunSync=e=>t=>{const r=unsafeRunSyncExit(e)(t);if(r._tag==="Failure")throw fiberFailure(r.effect_instruction_i0);return r.effect_instruction_i0};class AsyncFiberExceptionImpl extends Error{constructor(r){super(`Fiber #${r.id().id} cannot be resolved synchronously. This is caused by using runSync on an effect that performs async work`);ie(this,"fiber");ie(this,"_tag","AsyncFiberException");this.fiber=r,this.name=this._tag,this.stack=this.message}}const asyncFiberException=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const r=new AsyncFiberExceptionImpl(e);return Error.stackTraceLimit=t,r},FiberFailureId=Symbol.for("effect/Runtime/FiberFailure"),FiberFailureCauseId=Symbol.for("effect/Runtime/FiberFailure/Cause");class FiberFailureImpl extends Error{constructor(r){super();ie(this,Ts);ie(this,$s);this[FiberFailureId]=FiberFailureId,this[FiberFailureCauseId]=r;const n=prettyErrors(r);if(n.length>0){const o=n[0];this.name=o.name,this.message=o.message,this.stack=o.stack}this.name=`(FiberFailure) ${this.name}`,(this.message===void 0||this.message.length===0)&&(this.message="An error has occurred")}toJSON(){return{_id:"FiberFailure",cause:this[FiberFailureCauseId].toJSON()}}toString(){return"(FiberFailure) "+(this.stack??this.message)}[(Ts=FiberFailureId,$s=FiberFailureCauseId,NodeInspectSymbol)](){return this.toString()}}const fiberFailure=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const r=new FiberFailureImpl(e);return Error.stackTraceLimit=t,r},fastPath=e=>{const t=e;switch(t._op){case"Failure":case"Success":return t;case"Left":return exitFail(t.left);case"Right":return exitSucceed(t.right);case"Some":return exitSucceed(t.value);case"None":return exitFail(NoSuchElementException())}},unsafeRunSyncExit=e=>t=>{const r=fastPath(t);if(r)return r;const n=new SyncScheduler,o=unsafeFork(e)(t,{scheduler:n});n.flush();const s=o.unsafePoll();if(s)return s;throw asyncFiberException(o)};class RuntimeImpl{constructor(t,r,n){ie(this,"context");ie(this,"runtimeFlags");ie(this,"fiberRefs");this.context=t,this.runtimeFlags=r,this.fiberRefs=n}pipe(){return pipeArguments(this,arguments)}}const make$3=e=>new RuntimeImpl(e.context,e.runtimeFlags,e.fiberRefs),defaultRuntimeFlags=make$f(Interruption,CooperativeYielding,RuntimeMetrics),defaultRuntime=make$3({context:empty$d(),runtimeFlags:defaultRuntimeFlags,fiberRefs:empty$4()}),unsafeRunSyncEffect=unsafeRunSync(defaultRuntime),isEffect=isEffect$1,forEach=forEach$1,succeed$1=succeed$2,suspend$1=suspend$2,_void=void_,catchAll=catchAll$1,map$1=map$2,mapError$1=mapError$2,either=either$1,flatMap$1=flatMap$2,matchEffect=matchEffect$1,orElse=orElse$1,runSync=unsafeRunSyncEffect,isSecret=isSecret$1,fromString$1=fromString$2,value=value$1,GreaterThanTypeId$1=Symbol.for("@effect/schema/TypeId/GreaterThan"),GreaterThanOrEqualToTypeId$1=Symbol.for("@effect/schema/TypeId/GreaterThanOrEqualTo"),LessThanTypeId$1=Symbol.for("@effect/schema/TypeId/LessThan"),LessThanOrEqualToTypeId$1=Symbol.for("@effect/schema/TypeId/LessThanOrEqualTo"),IntTypeId$1=Symbol.for("@effect/schema/TypeId/Int"),MinLengthTypeId$1=Symbol.for("@effect/schema/TypeId/MinLength"),LengthTypeId$1=Symbol.for("@effect/schema/TypeId/Length"),ArbitraryHookId=Symbol.for("@effect/schema/ArbitraryHookId"),make$2=(e,t=[])=>({value:e,forest:t}),formatIssue=e=>map$1(go$2(e),t=>drawTree(t)),formatIssueSync=e=>runSync(formatIssue(e)),drawTree=e=>e.value+draw(`
`,e.forest),draw=(e,t)=>{let r="";const n=t.length;let o;for(let s=0;s<n;s++){o=t[s];const a=s===n-1;r+=e+(a?"\u2514":"\u251C")+"\u2500 "+o.value,r+=draw(e+(n>1&&!a?"\u2502  ":"   "),o.forest)}return r},formatTransformationKind=e=>{switch(e){case"Encoded":return"Encoded side transformation failure";case"Transformation":return"Transformation process failure";case"Type":return"Type side transformation failure"}},formatRefinementKind=e=>{switch(e){case"From":return"From side refinement failure";case"Predicate":return"Predicate refinement failure"}},getInnerMessage=e=>{switch(e._tag){case"Refinement":{if(e.kind==="From")return getMessage(e.error);break}case"Transformation":return getMessage(e.error)}return none$4()},getCurrentMessage=e=>getMessageAnnotation(e.ast).pipe(flatMap$1(t=>{const r=t(e);return isString(r)?succeed$1({message:r,override:!1}):isEffect(r)?map$1(r,n=>({message:n,override:!1})):isString(r.message)?succeed$1({message:r.message,override:r.override}):map$1(r.message,n=>({message:n,override:r.override}))})),getMessage=e=>{const t=getCurrentMessage(e);return getInnerMessage(e).pipe(flatMap$1(r=>map$1(t,n=>n.override?n.message:r)),catchAll(()=>flatMap$1(t,r=>!r.override&&(e._tag==="Refinement"&&e.kind!=="Predicate"||e._tag==="Transformation"&&e.kind!=="Transformation")?none$4():succeed$1(r.message))))},getParseIssueTitleAnnotation=e=>filterMap$1(getParseIssueTitleAnnotation$1(e.ast),t=>fromNullable(t(e))),formatTypeMessage=e=>getMessage(e).pipe(orElse(()=>getParseIssueTitleAnnotation(e)),orElse(()=>e.message),catchAll(()=>succeed$1(`Expected ${e.ast.toString(!0)}, actual ${formatUnknown(e.actual)}`))),getParseIssueTitle=e=>getOrElse(getParseIssueTitleAnnotation(e),()=>String(e.ast)),formatForbiddenMessage=e=>getOrElse(e.message,()=>"is forbidden"),getTree=(e,t)=>matchEffect(getMessage(e),{onFailure:t,onSuccess:r=>succeed$1(make$2(r))}),go$2=e=>{switch(e._tag){case"Type":return map$1(formatTypeMessage(e),make$2);case"Forbidden":return succeed$1(make$2(getParseIssueTitle(e),[make$2(formatForbiddenMessage(e))]));case"Unexpected":return succeed$1(make$2(`is unexpected, expected ${e.ast.toString(!0)}`));case"Missing":return succeed$1(make$2("is missing"));case"Union":return getTree(e,()=>map$1(forEach(e.errors,t=>{switch(t._tag){case"Member":return map$1(go$2(t.error),r=>make$2("Union member",[r]));default:return go$2(t)}}),t=>make$2(getParseIssueTitle(e),t)));case"TupleType":return getTree(e,()=>map$1(forEach(e.errors,t=>map$1(go$2(t.error),r=>make$2(`[${formatPropertyKey$1(t.index)}]`,[r]))),t=>make$2(getParseIssueTitle(e),t)));case"TypeLiteral":return getTree(e,()=>map$1(forEach(e.errors,t=>map$1(go$2(t.error),r=>make$2(`[${formatPropertyKey$1(t.key)}]`,[r]))),t=>make$2(getParseIssueTitle(e),t)));case"Transformation":return getTree(e,()=>map$1(go$2(e.error),t=>make$2(getParseIssueTitle(e),[make$2(formatTransformationKind(e.kind),[t])])));case"Refinement":return getTree(e,()=>map$1(go$2(e.error),t=>make$2(getParseIssueTitle(e),[make$2(formatRefinementKind(e.kind),[t])])));case"Declaration":return getTree(e,()=>{const t=e.error;return t._tag==="Type"&&t.ast===e.ast?go$2(t):map$1(go$2(t),r=>make$2(getParseIssueTitle(e),[r]))})}};class Declaration{constructor(t,r,n){ie(this,"ast");ie(this,"actual");ie(this,"error");ie(this,"_tag","Declaration");this.ast=t,this.actual=r,this.error=n}}class Refinement{constructor(t,r,n,o){ie(this,"ast");ie(this,"actual");ie(this,"kind");ie(this,"error");ie(this,"_tag","Refinement");this.ast=t,this.actual=r,this.kind=n,this.error=o}}class TupleType{constructor(t,r,n,o=[]){ie(this,"ast");ie(this,"actual");ie(this,"errors");ie(this,"output");ie(this,"_tag","TupleType");this.ast=t,this.actual=r,this.errors=n,this.output=o}}class Index{constructor(t,r){ie(this,"index");ie(this,"error");ie(this,"_tag","Index");this.index=t,this.error=r}}class TypeLiteral{constructor(t,r,n,o={}){ie(this,"ast");ie(this,"actual");ie(this,"errors");ie(this,"output");ie(this,"_tag","TypeLiteral");this.ast=t,this.actual=r,this.errors=n,this.output=o}}class Key{constructor(t,r){ie(this,"key");ie(this,"error");ie(this,"_tag","Key");this.key=t,this.error=r}}class Unexpected{constructor(t){ie(this,"ast");ie(this,"_tag","Unexpected");this.ast=t}}class Transformation{constructor(t,r,n,o){ie(this,"ast");ie(this,"actual");ie(this,"kind");ie(this,"error");ie(this,"_tag","Transformation");this.ast=t,this.actual=r,this.kind=n,this.error=o}}class Type{constructor(t,r,n){ie(this,"ast");ie(this,"actual");ie(this,"_tag","Type");ie(this,"message");this.ast=t,this.actual=r,this.message=fromNullable(n)}}class Forbidden{constructor(t,r,n){ie(this,"ast");ie(this,"actual");ie(this,"_tag","Forbidden");ie(this,"message");this.ast=t,this.actual=r,this.message=fromNullable(n)}}class Missing{constructor(){ie(this,"_tag","Missing")}}const missing=new Missing;class Member{constructor(t,r){ie(this,"ast");ie(this,"error");ie(this,"_tag","Member");this.ast=t,this.error=r}}let Union$1=class{constructor(e,t,r){ie(this,"ast");ie(this,"actual");ie(this,"errors");ie(this,"_tag","Union");this.ast=e,this.actual=t,this.errors=r}};class ParseError extends TaggedError("ParseError"){get message(){return this.toString()}toString(){return formatIssueSync(this.error)}toJSON(){return{_id:"ParseError",message:this.toString()}}[NodeInspectSymbol](){return this.toJSON()}}const succeed=right,fail=left,fromOption=fromOption$1,flatMap=dual(2,(e,t)=>{const r=e;return r._tag==="Left"?r:r._tag==="Right"?t(r.right):flatMap$1(e,t)}),map=dual(2,(e,t)=>{const r=e;return r._tag==="Left"?r:r._tag==="Right"?right(t(r.right)):map$1(e,t)}),mapError=dual(2,(e,t)=>{const r=e;return r._tag==="Left"?left(t(r.left)):r._tag==="Right"?r:mapError$1(e,t)}),eitherOrUndefined=e=>{const t=e;if(t._tag==="Left"||t._tag==="Right")return t},mergeParseOptions=(e,t)=>{if(t===void 0||isNumber(t))return e;if(e===void 0)return t;const r={};return r.errors=t.errors??e.errors,r.onExcessProperty=t.onExcessProperty??e.onExcessProperty,r},getEither=(e,t,r)=>{const n=goMemo(e,t);return(o,s)=>n(o,mergeParseOptions(r,s))},getSync=(e,t,r)=>{const n=getEither(e,t,r);return(o,s)=>getOrThrowWith$1(n(o,s),a=>new Error(formatIssueSync(a),{cause:a}))},getEffect=(e,t,r)=>{const n=goMemo(e,t);return(o,s)=>n(o,{...mergeParseOptions(r,s),isEffectAllowed:!0})},decodeUnknown=(e,t)=>getEffect(e.ast,!0,t),encodeUnknown=(e,t)=>getEffect(e.ast,!1,t),validateSync=(e,t)=>getSync(typeAST(e.ast),!0,t),asserts=(e,t)=>{const r=goMemo(typeAST(e.ast),!0);return(n,o)=>{const s=r(n,{exact:!0,...mergeParseOptions(t,o)});if(isLeft(s))throw new Error(formatIssueSync(s.left),{cause:s.left})}},decodeMemoMap=globalValue(Symbol.for("@effect/schema/Parser/decodeMemoMap"),()=>new WeakMap),encodeMemoMap=globalValue(Symbol.for("@effect/schema/Parser/encodeMemoMap"),()=>new WeakMap),goMemo=(e,t)=>{const r=t?decodeMemoMap:encodeMemoMap,n=r.get(e);if(n)return n;const o=go$1(e,t);return r.set(e,o),o},getConcurrency=e=>getOrUndefined(getConcurrencyAnnotation(e)),getBatching=e=>getOrUndefined(getBatchingAnnotation(e)),go$1=(e,t)=>{switch(e._tag){case"Refinement":if(t){const r=goMemo(e.from,!0);return(n,o)=>handleForbidden(flatMap(mapError(r(n,o),s=>new Refinement(e,n,"From",s)),s=>match$3(e.filter(s,o??defaultParseOption,e),{onNone:()=>right(s),onSome:a=>left(new Refinement(e,n,"Predicate",a))})),e,n,o)}else{const r=goMemo(typeAST(e),!0),n=goMemo(dropRightRefinement(e.from),!1);return(o,s)=>handleForbidden(flatMap(r(o,s),a=>n(a,s)),e,o,s)}case"Transformation":{const r=getFinalTransformation(e.transformation,t),n=t?goMemo(e.from,!0):goMemo(e.to,!1),o=t?goMemo(e.to,!0):goMemo(e.from,!1);return(s,a)=>handleForbidden(flatMap(mapError(n(s,a),c=>new Transformation(e,s,t?"Encoded":"Type",c)),c=>flatMap(mapError(r(c,a??defaultParseOption,e),l=>new Transformation(e,s,"Transformation",l)),l=>mapError(o(l,a),h=>new Transformation(e,s,t?"Type":"Encoded",h)))),e,s,a)}case"Declaration":{const r=t?e.decodeUnknown(...e.typeParameters):e.encodeUnknown(...e.typeParameters);return(n,o)=>handleForbidden(mapError(r(n,o??defaultParseOption,e),s=>new Declaration(e,n,s)),e,n,o)}case"Literal":return fromRefinement(e,r=>r===e.literal);case"UniqueSymbol":return fromRefinement(e,r=>r===e.symbol);case"UndefinedKeyword":return fromRefinement(e,isUndefined);case"VoidKeyword":return fromRefinement(e,isUndefined);case"NeverKeyword":return fromRefinement(e,isNever);case"UnknownKeyword":case"AnyKeyword":return right;case"StringKeyword":return fromRefinement(e,isString);case"NumberKeyword":return fromRefinement(e,isNumber);case"BooleanKeyword":return fromRefinement(e,isBoolean);case"BigIntKeyword":return fromRefinement(e,isBigInt);case"SymbolKeyword":return fromRefinement(e,isSymbol$2);case"ObjectKeyword":return fromRefinement(e,isObject$3);case"Enums":return fromRefinement(e,r=>e.enums.some(([n,o])=>o===r));case"TemplateLiteral":{const r=getTemplateLiteralRegExp(e);return fromRefinement(e,n=>isString(n)&&r.test(n))}case"TupleType":{const r=e.elements.map(l=>goMemo(l.type,t)),n=e.rest.map(l=>goMemo(l,t));let o=e.elements.filter(l=>!l.isOptional).length;e.rest.length>0&&(o+=e.rest.length-1);const s=Union$2.make(e.elements.map((l,h)=>new Literal$1(h))),a=getConcurrency(e),c=getBatching(e);return(l,h)=>{if(!isArray$3(l))return left(new Type(e,l));const u=(h==null?void 0:h.errors)==="all",d=[];let f=0;const _=l.length;for(let x=_;x<=o-1;x++){const B=new Index(x,missing);if(u){d.push([f++,B]);continue}else return left(new TupleType(e,l,[B]))}if(e.rest.length===0)for(let x=e.elements.length;x<=_-1;x++){const B=new Index(x,new Unexpected(s));if(u){d.push([f++,B]);continue}else return left(new TupleType(e,l,[B]))}const p=[];let y=0,w;for(;y<r.length;y++)if(_<y+1){if(e.elements[y].isOptional)continue}else{const x=r[y],B=x(l[y],h),P=eitherOrUndefined(B);if(P){if(isLeft(P)){const U=new Index(y,P.left);if(u){d.push([f++,U]);continue}else return left(new TupleType(e,l,[U],sortByIndex(p)))}p.push([f++,P.right])}else{const U=f++,F=y;w||(w=[]),w.push(({es:G,output:H})=>flatMap$1(either(B),te=>{if(isLeft(te)){const J=new Index(F,te.left);return u?(G.push([U,J]),_void):left(new TupleType(e,l,[J],sortByIndex(H)))}return H.push([U,te.right]),_void}))}}if(isNonEmptyReadonlyArray(n)){const[x,...B]=n;for(;y<_-B.length;y++){const P=x(l[y],h),U=eitherOrUndefined(P);if(U)if(isLeft(U)){const F=new Index(y,U.left);if(u){d.push([f++,F]);continue}else return left(new TupleType(e,l,[F],sortByIndex(p)))}else p.push([f++,U.right]);else{const F=f++,G=y;w||(w=[]),w.push(({es:H,output:te})=>flatMap$1(either(P),J=>{if(isLeft(J)){const le=new Index(G,J.left);return u?(H.push([F,le]),_void):left(new TupleType(e,l,[le],sortByIndex(te)))}else return te.push([F,J.right]),_void}))}}for(let P=0;P<B.length;P++)if(y+=P,!(_<y+1)){const U=B[P](l[y],h),F=eitherOrUndefined(U);if(F){if(isLeft(F)){const G=new Index(y,F.left);if(u){d.push([f++,G]);continue}else return left(new TupleType(e,l,[G],sortByIndex(p)))}p.push([f++,F.right])}else{const G=f++,H=y;w||(w=[]),w.push(({es:te,output:J})=>flatMap$1(either(U),le=>{if(isLeft(le)){const z=new Index(H,le.left);return u?(te.push([G,z]),_void):left(new TupleType(e,l,[z],sortByIndex(J)))}return J.push([G,le.right]),_void}))}}}const E=({es:x,output:B})=>isNonEmptyArray(x)?left(new TupleType(e,l,sortByIndex(x),sortByIndex(B))):right(sortByIndex(B));if(w&&w.length>0){const x=w;return suspend$1(()=>{const B={es:copy$1(d),output:copy$1(p)};return flatMap$1(forEach(x,P=>P(B),{concurrency:a,batching:c,discard:!0}),()=>E(B))})}return E({output:p,es:d})}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return fromRefinement(e,isNotNullable);const r=[],n={},o=[];for(const u of e.propertySignatures)r.push([goMemo(u.type,t),u]),n[u.name]=null,o.push(u.name);const s=e.indexSignatures.map(u=>[goMemo(u.parameter,t),goMemo(u.type,t),u.parameter]),a=Union$2.make(e.indexSignatures.map(u=>u.parameter).concat(o.map(u=>isSymbol$2(u)?new UniqueSymbol(u):new Literal$1(u)))),c=goMemo(a,t),l=getConcurrency(e),h=getBatching(e);return(u,d)=>{if(!isRecord(u))return left(new Type(e,u));const f=(d==null?void 0:d.errors)==="all",_=[];let p=0;const y=(d==null?void 0:d.onExcessProperty)==="error",w=(d==null?void 0:d.onExcessProperty)==="preserve",E={};let x;if(y||w){x=ownKeys(u);for(const F of x){const G=eitherOrUndefined(c(F,d));if(isLeft(G))if(y){const H=new Key(F,new Unexpected(a));if(f){_.push([p++,H]);continue}else return left(new TypeLiteral(e,u,[H],E))}else E[F]=u[F]}}let B;const P=(d==null?void 0:d.exact)===!0;for(let F=0;F<r.length;F++){const G=r[F][1],H=G.name,te=Object.prototype.hasOwnProperty.call(u,H);if(!te){if(G.isOptional)continue;if(P){const q=new Key(H,missing);if(f){_.push([p++,q]);continue}else return left(new TypeLiteral(e,u,[q],E))}}const J=r[F][0],le=J(u[H],d),z=eitherOrUndefined(le);if(z){if(isLeft(z)){const q=new Key(H,te?z.left:missing);if(f){_.push([p++,q]);continue}else return left(new TypeLiteral(e,u,[q],E))}E[H]=z.right}else{const q=p++,he=H;B||(B=[]),B.push(({es:V,output:_e})=>flatMap$1(either(le),ee=>{if(isLeft(ee)){const W=new Key(he,te?ee.left:missing);return f?(V.push([q,W]),_void):left(new TypeLiteral(e,u,[W],_e))}return _e[he]=ee.right,_void}))}}for(let F=0;F<s.length;F++){const G=s[F],H=G[0],te=G[1],J=getKeysForIndexSignature(u,G[2]);for(const le of J){const z=eitherOrUndefined(H(le,d));if(z&&isRight(z)){const q=te(u[le],d),he=eitherOrUndefined(q);if(he)if(isLeft(he)){const V=new Key(le,he.left);if(f){_.push([p++,V]);continue}else return left(new TypeLiteral(e,u,[V],E))}else Object.prototype.hasOwnProperty.call(n,le)||(E[le]=he.right);else{const V=p++,_e=le;B||(B=[]),B.push(({es:ee,output:W})=>flatMap$1(either(q),re=>{if(isLeft(re)){const ne=new Key(_e,re.left);return f?(ee.push([V,ne]),_void):left(new TypeLiteral(e,u,[ne],W))}else return Object.prototype.hasOwnProperty.call(n,le)||(W[le]=re.right),_void}))}}}}const U=({es:F,output:G})=>{if(isNonEmptyArray(F))return left(new TypeLiteral(e,u,sortByIndex(F),G));if((d==null?void 0:d.propertyOrder)==="original"){const H=x||ownKeys(u);for(const J of o)H.indexOf(J)===-1&&H.push(J);const te={};for(const J of H)Object.prototype.hasOwnProperty.call(G,J)&&(te[J]=G[J]);return right(te)}return right(G)};if(B&&B.length>0){const F=B;return suspend$1(()=>{const G={es:copy$1(_),output:Object.assign({},E)};return flatMap$1(forEach(F,H=>H(G),{concurrency:l,batching:h,discard:!0}),()=>U(G))})}return U({es:_,output:E})}}case"Union":{const r=getSearchTree(e.types,t),n=ownKeys(r.keys),o=n.length,s=new Map;for(let l=0;l<e.types.length;l++)s.set(e.types[l],goMemo(e.types[l],t));const a=getConcurrency(e)??1,c=getBatching(e);return(l,h)=>{const u=[];let d=0,f=[];if(o>0)if(isRecord(l))for(let y=0;y<o;y++){const w=n[y],E=r.keys[w].buckets;if(Object.prototype.hasOwnProperty.call(l,w)){const x=String(l[w]);if(Object.prototype.hasOwnProperty.call(E,x))f=f.concat(E[x]);else{const B=Union$2.make(r.keys[w].literals);u.push([d++,new TypeLiteral(new TypeLiteral$1([new PropertySignature(w,B,!1,!0)],[]),l,[new Key(w,new Type(B,l[w]))])])}}else{const x=Union$2.make(r.keys[w].literals);u.push([d++,new TypeLiteral(new TypeLiteral$1([new PropertySignature(w,x,!1,!0)],[]),l,[new Key(w,missing)])])}}else u.push([d++,new Type(e,l)]);r.otherwise.length>0&&(f=f.concat(r.otherwise));let _;for(let y=0;y<f.length;y++){const w=f[y],E=s.get(w)(l,h),x=!_||_.length===0?eitherOrUndefined(E):void 0;if(x){if(isRight(x))return right(x.right);u.push([d++,new Member(w,x.left)])}else{const B=d++;_||(_=[]),_.push(P=>suspend$1(()=>"finalResult"in P?_void:flatMap$1(either(E),U=>(isRight(U)?P.finalResult=right(U.right):P.es.push([B,new Member(w,U.left)]),_void))))}}const p=y=>isNonEmptyArray(y)?y.length===1&&y[0][1]._tag==="Type"?left(y[0][1]):left(new Union$1(e,l,sortByIndex(y))):left(new Type(neverKeyword,l));if(_&&_.length>0){const y=_;return suspend$1(()=>{const w={es:copy$1(u)};return flatMap$1(forEach(y,E=>E(w),{concurrency:a,batching:c,discard:!0}),()=>"finalResult"in w?w.finalResult:p(w.es))})}return p(u)}}case"Suspend":{const r=memoizeThunk(()=>goMemo(annotations(e.f(),e.annotations),t));return(n,o)=>r()(n,o)}}},fromRefinement=(e,t)=>r=>t(r)?right(r):left(new Type(e,r)),getLiterals=(e,t)=>{switch(e._tag){case"Declaration":{const r=getSurrogateAnnotation(e);if(isSome(r))return getLiterals(r.value,t);break}case"TypeLiteral":{const r=[];for(let n=0;n<e.propertySignatures.length;n++){const o=e.propertySignatures[n],s=t?encodedAST(o.type):typeAST(o.type);isLiteral(s)&&!o.isOptional&&r.push([o.name,s])}return r}case"Refinement":return getLiterals(e.from,t);case"Suspend":return getLiterals(e.f(),t);case"Transformation":return getLiterals(t?e.from:e.to,t)}return[]},getSearchTree=(e,t)=>{const r={},n=[];for(let o=0;o<e.length;o++){const s=e[o],a=getLiterals(s,t);if(a.length>0)for(let c=0;c<a.length;c++){const[l,h]=a[c],u=String(h.literal);r[l]=r[l]||{buckets:{},literals:[]};const d=r[l].buckets;if(Object.prototype.hasOwnProperty.call(d,u)){if(c<a.length-1)continue;d[u].push(s),r[l].literals.push(h)}else{d[u]=[s],r[l].literals.push(h);break}}else n.push(s)}return{keys:r,otherwise:n}},dropRightRefinement=e=>isRefinement(e)?dropRightRefinement(e.from):e,handleForbidden=(e,t,r,n)=>{const o=eitherOrUndefined(e);if(o)return o;if((n==null?void 0:n.isEffectAllowed)===!0)return e;try{return runSync(either(e))}catch{return left(new Forbidden(t,r,"cannot be be resolved synchronously, this is caused by using runSync on an effect that performs async work"))}};function sortByIndex(e){return e.sort(([t],[r])=>t>r?1:t<r?-1:0).map(([t,r])=>r)}const getFinalTransformation=(e,t)=>{switch(e._tag){case"FinalTransformation":return t?e.decode:e.encode;case"ComposeTransformation":return right;case"TypeLiteralTransformation":return r=>{let n=right(r);for(const o of e.propertySignatureTransformations){const[s,a]=t?[o.from,o.to]:[o.to,o.from],c=t?o.decode:o.encode;n=map(n,l=>{const h=c(Object.prototype.hasOwnProperty.call(l,s)?some(l[s]):none$4());return delete l[s],isSome(h)&&(l[a]=h.value),l})}return n}}},EquivalenceHookId=Symbol.for("@effect/schema/EquivalenceHookId"),PrettyHookId=Symbol.for("@effect/schema/PrettyHookId"),TypeId=Symbol.for("@effect/schema/Schema"),make$1=e=>{var t,r,n;return r=TypeId,t=TypeId,n=class{constructor(){ie(this,r,variance)}static annotations(o){return make$1(mergeSchemaAnnotations(this.ast,o))}static pipe(){return pipeArguments(this,arguments)}static toString(){return String(e)}},ie(n,"Type"),ie(n,"Encoded"),ie(n,t,variance),ie(n,"ast",e),n},variance={_A:e=>e,_I:e=>e,_R:e=>e},toASTAnnotations=e=>{if(!e)return{};const t={},r=Object.getOwnPropertySymbols(e);for(const o of r)t[o]=e[o];if(e.typeId!==void 0){const o=e.typeId;typeof o=="object"?(t[TypeAnnotationId]=o.id,t[o.id]=o.annotation):t[TypeAnnotationId]=o}const n=(o,s)=>{e[o]!==void 0&&(t[s]=e[o])};return n("message",MessageAnnotationId),n("identifier",IdentifierAnnotationId),n("title",TitleAnnotationId),n("description",DescriptionAnnotationId),n("examples",ExamplesAnnotationId),n("default",DefaultAnnotationId),n("documentation",DocumentationAnnotationId),n("jsonSchema",JSONSchemaAnnotationId),n("arbitrary",ArbitraryHookId),n("pretty",PrettyHookId),n("equivalence",EquivalenceHookId),n("concurrency",ConcurrencyAnnotationId),n("batching",BatchingAnnotationId),n("parseIssueTitle",ParseIssueTitleAnnotationId),t},mergeSchemaAnnotations=(e,t)=>annotations(e,toASTAnnotations(t)),format=e=>String(e.ast),typeSchema=e=>make$1(typeAST(e.ast)),isSchema=e=>hasProperty(e,TypeId)&&isObject$3(e[TypeId]),getDefaultLiteralAST=e=>isMembers(e)?Union$2.make(mapMembers(e,t=>new Literal$1(t))):new Literal$1(e[0]),makeLiteralClass=(e,t=getDefaultLiteralAST(e))=>{var r;return r=class extends make$1(t){static annotations(n){return makeLiteralClass(this.literals,mergeSchemaAnnotations(this.ast,n))}},ie(r,"literals",[...e]),r};function Literal(...e){return isNonEmptyReadonlyArray(e)?makeLiteralClass(e):Never}const getDefaultEnumsAST=e=>new Enums$1(Object.keys(e).filter(t=>typeof e[e[t]]!="number").map(t=>[t,e[t]])),makeEnumsClass=(e,t=getDefaultEnumsAST(e))=>{var r;return r=class extends make$1(t){static annotations(n){return makeEnumsClass(this.enums,mergeSchemaAnnotations(this.ast,n))}},ie(r,"enums",{...e}),r},Enums=e=>makeEnumsClass(e),declareConstructor=(e,t,r)=>make$1(new Declaration$1(e.map(n=>n.ast),(...n)=>t.decode(...n.map(make$1)),(...n)=>t.encode(...n.map(make$1)),toASTAnnotations(r))),declarePrimitive=(e,t)=>{const r=()=>(o,s,a)=>e(o)?succeed(o):fail(new Type(a,o)),n=r;return make$1(new Declaration$1([],r,n,toASTAnnotations(t)))},declare=function(){if(Array.isArray(arguments[0])){const r=arguments[0],n=arguments[1],o=arguments[2];return declareConstructor(r,n,o)}const e=arguments[0],t=arguments[1];return declarePrimitive(e,t)},InstanceOfTypeId=Symbol.for("@effect/schema/TypeId/InstanceOf"),instanceOf=(e,t)=>declare(r=>r instanceof e,{title:e.name,description:`an instance of ${e.name}`,pretty:()=>String,typeId:{id:InstanceOfTypeId,annotation:{constructor:e}},...t}),eo=class eo extends make$1(undefinedKeyword){};ie(eo,"annotations",yt(eo,eo,"annotations"));let Undefined=eo;const to=class to extends make$1(voidKeyword){};ie(to,"annotations",yt(to,to,"annotations"));let Void=to;const ro=class ro extends make$1($null){};ie(ro,"annotations",yt(ro,ro,"annotations"));let Null=ro;const no=class no extends make$1(neverKeyword){};ie(no,"annotations",yt(no,no,"annotations"));let Never=no;const oo=class oo extends make$1(unknownKeyword){};ie(oo,"annotations",yt(oo,oo,"annotations"));let Unknown=oo;const io=class io extends make$1(anyKeyword){};ie(io,"annotations",yt(io,io,"annotations"));let Any=io;const so=class so extends make$1(bigIntKeyword){};ie(so,"annotations",yt(so,so,"annotations"));let BigIntFromSelf=so;const ao=class ao extends make$1(symbolKeyword){};ie(ao,"annotations",yt(ao,ao,"annotations"));let SymbolFromSelf=ao;const co=class co extends make$1(stringKeyword){};ie(co,"annotations",yt(co,co,"annotations"));let String$=co;const lo=class lo extends make$1(numberKeyword){};ie(lo,"annotations",yt(lo,lo,"annotations"));let Number$=lo;const ho=class ho extends make$1(booleanKeyword){};ie(ho,"annotations",yt(ho,ho,"annotations"));let Boolean$=ho;const uo=class uo extends make$1(objectKeyword){};ie(uo,"annotations",yt(uo,uo,"annotations"));let Object$=uo;const getDefaultUnionAST=e=>Union$2.members(e.map(t=>t.ast)),makeUnionClass=(e,t=getDefaultUnionAST(e))=>{var r;return r=class extends make$1(t){static annotations(n){return makeUnionClass(this.members,mergeSchemaAnnotations(this.ast,n))}},ie(r,"members",[...e]),r};function Union(...e){return isMembers(e)?makeUnionClass(e):isNonEmptyReadonlyArray(e)?e[0]:Never}const NullOr=e=>Union(e,Null),UndefinedOr=e=>Union(e,Undefined),NullishOr=e=>Union(e,Null,Undefined),getDefaultTupleTypeAST=(e,t)=>new TupleType$1(e.map(r=>isSchema(r)?new Element(r.ast,!1):new Element(r.optionalElement.ast,!0)),t.map(r=>r.ast),!0),makeTupleTypeClass=(e,t,r=getDefaultTupleTypeAST(e,t))=>{var n;return n=class extends make$1(r){static annotations(o){return makeTupleTypeClass(this.elements,this.rest,mergeSchemaAnnotations(this.ast,o))}},ie(n,"elements",[...e]),ie(n,"rest",[...t]),n};function Tuple(...e){return Array.isArray(e[0])?makeTupleTypeClass(e[0],e.slice(1)):makeTupleTypeClass(e,[])}const makeArrayClass=(e,t)=>{var r;return r=class extends makeTupleTypeClass([],[e],t){static annotations(n){return makeArrayClass(this.value,mergeSchemaAnnotations(this.ast,n))}},ie(r,"value",e),r},Array$=e=>makeArrayClass(e),formatToken=e=>e?'"?:"':'":"';class PropertySignatureDeclaration{constructor(t,r,n,o,s){ie(this,"type");ie(this,"isOptional");ie(this,"isReadonly");ie(this,"annotations");ie(this,"defaultValue");ie(this,"_tag","PropertySignatureDeclaration");this.type=t,this.isOptional=r,this.isReadonly=n,this.annotations=o,this.defaultValue=s}toString(){const t=formatToken(this.isOptional),r=String(this.type);return`PropertySignature<${t}, ${r}, never, ${t}, ${r}>`}}class FromPropertySignature{constructor(t,r,n,o,s){ie(this,"type");ie(this,"isOptional");ie(this,"isReadonly");ie(this,"annotations");ie(this,"fromKey");this.type=t,this.isOptional=r,this.isReadonly=n,this.annotations=o,this.fromKey=s}}class ToPropertySignature{constructor(t,r,n,o,s){ie(this,"type");ie(this,"isOptional");ie(this,"isReadonly");ie(this,"annotations");ie(this,"defaultValue");this.type=t,this.isOptional=r,this.isReadonly=n,this.annotations=o,this.defaultValue=s}}const formatPropertyKey=e=>e===void 0?"never":isString(e)?JSON.stringify(e):String(e);class PropertySignatureTransformation{constructor(t,r,n,o){ie(this,"from");ie(this,"to");ie(this,"decode");ie(this,"encode");ie(this,"_tag","PropertySignatureTransformation");this.from=t,this.to=r,this.decode=n,this.encode=o}toString(){return`PropertySignature<${formatToken(this.to.isOptional)}, ${this.to.type}, ${formatPropertyKey(this.from.fromKey)}, ${formatToken(this.from.isOptional)}, ${this.from.type}>`}}const PropertySignatureTypeId=Symbol.for("@effect/schema/PropertySignature"),mergeSignatureAnnotations=(e,t)=>{switch(e._tag){case"PropertySignatureDeclaration":return new PropertySignatureDeclaration(e.type,e.isOptional,e.isReadonly,{...e.annotations,...t},e.defaultValue);case"PropertySignatureTransformation":return new PropertySignatureTransformation(new FromPropertySignature(e.from.type,e.from.isOptional,e.from.isReadonly,e.from.annotations),new ToPropertySignature(e.to.type,e.to.isOptional,e.to.isReadonly,{...e.to.annotations,...t},e.to.defaultValue),e.decode,e.encode)}};Os=TypeId,ks=PropertySignatureTypeId;const wi=class wi{constructor(t){ie(this,"ast");ie(this,Os);ie(this,ks,null);ie(this,"_TypeToken");ie(this,"_Key");ie(this,"_EncodedToken");ie(this,"_HasDefault");this.ast=t}pipe(){return pipeArguments(this,arguments)}annotations(t){return new wi(mergeSignatureAnnotations(this.ast,toASTAnnotations(t)))}toString(){return String(this.ast)}};let PropertySignatureImpl=wi;const makePropertySignature=e=>new PropertySignatureImpl(e);class PropertySignatureWithFromImpl extends PropertySignatureImpl{constructor(r,n){super(r);ie(this,"from");this.from=n}annotations(r){return new PropertySignatureWithFromImpl(mergeSignatureAnnotations(this.ast,toASTAnnotations(r)),this.from)}}const withConstructorDefault=dual(2,(e,t)=>{const r=e.ast;switch(r._tag){case"PropertySignatureDeclaration":return makePropertySignature(new PropertySignatureDeclaration(r.type,r.isOptional,r.isReadonly,r.annotations,t));case"PropertySignatureTransformation":return makePropertySignature(new PropertySignatureTransformation(r.from,new ToPropertySignature(r.to.type,r.to.isOptional,r.to.isReadonly,r.to.annotations,t),r.decode,r.encode))}}),optionalToRequired=(e,t,r)=>makePropertySignature(new PropertySignatureTransformation(new FromPropertySignature(e.ast,!0,!0,{},void 0),new ToPropertySignature(t.ast,!1,!0,{},void 0),n=>some(r.decode(n)),flatMap$4(r.encode))),optionalToOptional=(e,t,r)=>makePropertySignature(new PropertySignatureTransformation(new FromPropertySignature(e.ast,!0,!0,{},void 0),new ToPropertySignature(t.ast,!0,!0,{},void 0),r.decode,r.encode)),optionalPropertySignatureAST=(e,t)=>{const r=t==null?void 0:t.exact,n=t==null?void 0:t.default,o=t==null?void 0:t.nullable,s=(t==null?void 0:t.as)=="Option",a=t!=null&&t.onNoneEncoding?orElse$2(t.onNoneEncoding):identity$1;return r?n?o?withConstructorDefault(optionalToRequired(NullOr(e),typeSchema(e),{decode:match$3({onNone:n,onSome:c=>c===null?n():c}),encode:some}),n).ast:withConstructorDefault(optionalToRequired(e,typeSchema(e),{decode:match$3({onNone:n,onSome:identity$1}),encode:some}),n).ast:s?o?optionalToRequired(NullOr(e),OptionFromSelf(typeSchema(e)),{decode:filter$1(isNotNull),encode:a}).ast:optionalToRequired(e,OptionFromSelf(typeSchema(e)),{decode:identity$1,encode:identity$1}).ast:o?optionalToOptional(NullOr(e),typeSchema(e),{decode:filter$1(isNotNull),encode:identity$1}).ast:new PropertySignatureDeclaration(e.ast,!0,!0,{},void 0):n?o?withConstructorDefault(optionalToRequired(NullishOr(e),typeSchema(e),{decode:match$3({onNone:n,onSome:c=>c??n()}),encode:some}),n).ast:withConstructorDefault(optionalToRequired(UndefinedOr(e),typeSchema(e),{decode:match$3({onNone:n,onSome:c=>c===void 0?n():c}),encode:some}),n).ast:s?o?optionalToRequired(NullishOr(e),OptionFromSelf(typeSchema(e)),{decode:filter$1(c=>c!=null),encode:a}).ast:optionalToRequired(UndefinedOr(e),OptionFromSelf(typeSchema(e)),{decode:filter$1(isNotUndefined),encode:a}).ast:o?optionalToOptional(NullishOr(e),UndefinedOr(typeSchema(e)),{decode:filter$1(isNotNull),encode:identity$1}).ast:new PropertySignatureDeclaration(UndefinedOr(e).ast,!0,!0,{},void 0)},optional=dual(e=>isSchema(e[0]),(e,t)=>new PropertySignatureWithFromImpl(optionalPropertySignatureAST(e,t),e)),isPropertySignature=e=>hasProperty(e,PropertySignatureTypeId),getDefaultTypeLiteralAST=(e,t)=>{const r=ownKeys(e),n=[];if(r.length>0){const s=[],a=[],c=[];for(let l=0;l<r.length;l++){const h=r[l],u=e[h];if(isPropertySignature(u)){const d=u.ast;switch(d._tag){case"PropertySignatureDeclaration":{const f=d.type,_=d.isOptional,p=d.annotations;s.push(new PropertySignature(h,f,_,!0)),a.push(new PropertySignature(h,typeAST(f),_,!0,p)),n.push(new PropertySignature(h,f,_,!0,p));break}case"PropertySignatureTransformation":{const f=d.from.fromKey??h;s.push(new PropertySignature(f,d.from.type,d.from.isOptional,!0,d.from.annotations)),a.push(new PropertySignature(h,d.to.type,d.to.isOptional,!0,d.to.annotations)),c.push(new PropertySignatureTransformation$1(f,h,d.decode,d.encode));break}}}else s.push(new PropertySignature(h,u.ast,!1,!0)),a.push(new PropertySignature(h,typeAST(u.ast),!1,!0)),n.push(new PropertySignature(h,u.ast,!1,!0))}if(isNonEmptyReadonlyArray(c)){const l=[],h=[];for(const u of t){const{indexSignatures:d,propertySignatures:f}=record(u.key.ast,u.value.ast);f.forEach(_=>{s.push(_),a.push(new PropertySignature(_.name,typeAST(_.type),_.isOptional,_.isReadonly,_.annotations))}),d.forEach(_=>{l.push(_),h.push(new IndexSignature(_.parameter,typeAST(_.type),_.isReadonly))})}return new Transformation$1(new TypeLiteral$1(s,l,{[TitleAnnotationId]:"Struct (Encoded side)"}),new TypeLiteral$1(a,h,{[TitleAnnotationId]:"Struct (Type side)"}),new TypeLiteralTransformation(c))}}const o=[];for(const s of t){const{indexSignatures:a,propertySignatures:c}=record(s.key.ast,s.value.ast);c.forEach(l=>n.push(l)),a.forEach(l=>o.push(l))}return new TypeLiteral$1(n,o)},lazilyMergeDefaults=(e,t)=>{const r=ownKeys(e);for(const n of r){const o=e[n];if(t[n]===void 0&&isPropertySignature(o)){const s=o.ast,a=s._tag==="PropertySignatureDeclaration"?s.defaultValue:s.to.defaultValue;a!==void 0&&(t[n]=a())}}return t},makeTypeLiteralClass=(e,t,r=getDefaultTypeLiteralAST(e,t))=>{var n;return n=class extends make$1(r){static annotations(s){return makeTypeLiteralClass(this.fields,this.records,mergeSchemaAnnotations(this.ast,s))}},ie(n,"fields",{...e}),ie(n,"records",[...t]),ie(n,"make",(s,a)=>{const c=lazilyMergeDefaults(e,{...s});return getDisableValidationMakeOption(a)?c:validateSync(n)(c)}),n};function Struct(e,...t){return makeTypeLiteralClass(e,t)}const makeRecordClass=(e,t,r)=>{var n;return n=class extends makeTypeLiteralClass({},[{key:e,value:t}],r){static annotations(o){return makeRecordClass(e,t,mergeSchemaAnnotations(this.ast,o))}},ie(n,"key",e),ie(n,"value",t),n},Record=(e,t)=>makeRecordClass(e,t),partial=dual(e=>isSchema(e[0]),(e,t)=>make$1(partial$1(e.ast,t))),mutable=e=>make$1(mutable$1(e.ast)),getExtendErrorMessage=(e,t,r)=>{const n=`unsupported schema or overlapping types, cannot extend ${e} with ${t}`;return getErrorMessageWithPath(getErrorMessage("extend",n),r)},intersectTypeLiterals=(e,t,r)=>{if(isTypeLiteral(e)&&isTypeLiteral(t)){const n=[...e.propertySignatures];for(const o of t.propertySignatures){const s=o.name,a=n.findIndex(c=>c.name===s);if(a===-1)n.push(o);else{const{isOptional:c,type:l}=n[a];n[a]=new PropertySignature(s,extendAST(l,o.type,r.concat(s)),c,!0)}}return new TypeLiteral$1(n,e.indexSignatures.concat(t.indexSignatures))}throw new Error(getExtendErrorMessage(e,t,r))},addRefinementToMembers=(e,t)=>t.map(r=>new Refinement$1(r,e.filter,match$3(getMessageAnnotation(e),{onNone:()=>{},onSome:n=>({[MessageAnnotationId]:n})}))),extendAST=(e,t,r)=>Union$2.make(intersectUnionMembers([e],[t],r)),getTypes=e=>isUnion(e)?e.types:[e],intersectUnionMembers=(e,t,r)=>flatMap$3(e,n=>flatMap$3(t,o=>{switch(n._tag){case"Union":return intersectUnionMembers(n.types,getTypes(o),r);case"Suspend":return[new Suspend(()=>extendAST(n.f(),o,r))];case"Refinement":return addRefinementToMembers(n,intersectUnionMembers(getTypes(n.from),getTypes(o),r));case"TypeLiteral":{switch(o._tag){case"Union":return intersectUnionMembers([n],o.types,r);case"Suspend":return[new Suspend(()=>extendAST(n,o.f(),r))];case"Refinement":return addRefinementToMembers(o,intersectUnionMembers([n],getTypes(o.from),r));case"TypeLiteral":return[intersectTypeLiterals(n,o,r)];case"Transformation":{if(isTypeLiteralTransformation(o.transformation))return[new Transformation$1(intersectTypeLiterals(n,o.from,r),intersectTypeLiterals(typeAST(n),o.to,r),new TypeLiteralTransformation(o.transformation.propertySignatureTransformations))];break}}break}case"Transformation":{if(isTypeLiteralTransformation(n.transformation))switch(o._tag){case"TypeLiteral":return[new Transformation$1(intersectTypeLiterals(n.from,o,r),intersectTypeLiterals(n.to,typeAST(o),r),new TypeLiteralTransformation(n.transformation.propertySignatureTransformations))];case"Transformation":if(isTypeLiteralTransformation(o.transformation))return[new Transformation$1(intersectTypeLiterals(n.from,o.from,r),intersectTypeLiterals(n.to,o.to,r),new TypeLiteralTransformation(n.transformation.propertySignatureTransformations.concat(o.transformation.propertySignatureTransformations)))];break}break}}throw new Error(getExtendErrorMessage(n,o,r))})),extend=dual(2,(e,t)=>make$1(extendAST(e.ast,t.ast,[]))),suspend=e=>make$1(new Suspend(()=>e().ast)),makeRefineClass=(e,t,r)=>{var n;return n=class extends make$1(r){static annotations(s){return makeRefineClass(this.from,this.filter,mergeSchemaAnnotations(this.ast,s))}},ie(n,"from",e),ie(n,"filter",t),ie(n,"make",(s,a)=>getDisableValidationMakeOption(a)?s:validateSync(n)(s)),n};function filter(e,t){return r=>{function n(s,a,c){const l=e(s,a,c);return isBoolean(l)?l?none$4():some(new Type(c,s)):isString(l)?some(new Type(c,s,l)):l===void 0?none$4():some(l)}const o=new Refinement$1(r.ast,n,toASTAnnotations(t));return makeRefineClass(r,n,o)}}const makeTransformationClass=(e,t,r)=>{var n;return n=class extends make$1(r){static annotations(o){return makeTransformationClass(this.from,this.to,mergeSchemaAnnotations(this.ast,o))}},ie(n,"from",e),ie(n,"to",t),n},transformOrFail=dual(e=>isSchema(e[0])&&isSchema(e[1]),(e,t,r)=>makeTransformationClass(e,t,new Transformation$1(e.ast,t.ast,new FinalTransformation(r.decode,r.encode)))),transform=dual(e=>isSchema(e[0])&&isSchema(e[1]),(e,t,r)=>transformOrFail(e,t,{decode:n=>succeed(r.decode(n)),encode:n=>succeed(r.encode(n))})),identifier=e=>t=>t.annotations({[IdentifierAnnotationId]:e}),TrimmedTypeId=Symbol.for("@effect/schema/TypeId/Trimmed"),trimmed=e=>t=>t.pipe(filter(r=>r===r.trim(),{typeId:TrimmedTypeId,description:"a string with no leading or trailing whitespace",jsonSchema:{pattern:"^\\S[\\s\\S]*\\S$|^\\S$|^$"},...e})),MinLengthTypeId=MinLengthTypeId$1,minLength=(e,t)=>r=>r.pipe(filter(n=>n.length>=e,{typeId:MinLengthTypeId,description:`a string at least ${e} character(s) long`,jsonSchema:{minLength:e},...t})),PatternTypeId=Symbol.for("@effect/schema/TypeId/Pattern"),pattern=(e,t)=>r=>{const n=e.source;return r.pipe(filter(o=>(e.lastIndex=0,e.test(o)),{typeId:{id:PatternTypeId,annotation:{regex:e}},description:`a string matching the pattern ${n}`,jsonSchema:{pattern:n},arbitrary:()=>o=>o.stringMatching(e),...t}))},LowercasedTypeId=Symbol.for("@effect/schema/TypeId/Lowercased"),lowercased=e=>t=>t.pipe(filter(r=>r===r.toLowerCase(),{typeId:LowercasedTypeId,description:"a lowercase string",...e})),fo=class fo extends String$.pipe(lowercased({identifier:"Lowercased",title:"Lowercased"})){};ie(fo,"annotations",yt(fo,fo,"annotations"));let Lowercased=fo;const UppercasedTypeId=Symbol.for("@effect/schema/TypeId/Uppercased"),uppercased=e=>t=>t.pipe(filter(r=>r===r.toUpperCase(),{typeId:UppercasedTypeId,description:"an uppercase string",...e})),po=class po extends String$.pipe(uppercased({identifier:"Uppercased",title:"Uppercased"})){};ie(po,"annotations",yt(po,po,"annotations"));let Uppercased=po;const LengthTypeId=LengthTypeId$1,length$1=(e,t)=>r=>{const n=isObject$3(e)?Math.max(0,Math.floor(e.min)):Math.max(0,Math.floor(e)),o=isObject$3(e)?Math.max(n,Math.floor(e.max)):n;return n!==o?r.pipe(filter(s=>s.length>=n&&s.length<=o,{typeId:LengthTypeId,description:`a string at least ${n} character(s) and at most ${o} character(s) long`,jsonSchema:{minLength:n,maxLength:o},...t})):r.pipe(filter(s=>s.length===n,{typeId:LengthTypeId,description:n===1?"a single character":`a string ${n} character(s) long`,jsonSchema:{minLength:n,maxLength:n},...t}))},_o=class _o extends String$.pipe(length$1(1,{identifier:"Char"})){};ie(_o,"annotations",yt(_o,_o,"annotations"));let Char=_o;const nonEmpty=e=>minLength(1,{description:"a non empty string",...e}),yo=class yo extends transform(String$,Lowercased,{decode:t=>t.toLowerCase(),encode:identity$1}).annotations({identifier:"Lowercase"}){};ie(yo,"annotations",yt(yo,yo,"annotations"));let Lowercase=yo;const mo=class mo extends transform(String$,Uppercased,{decode:t=>t.toUpperCase(),encode:identity$1}).annotations({identifier:"Uppercase"}){};ie(mo,"annotations",yt(mo,mo,"annotations"));let Uppercase=mo;const bo=class bo extends String$.pipe(trimmed({identifier:"Trimmed",title:"Trimmed"})){};ie(bo,"annotations",yt(bo,bo,"annotations"));let Trimmed=bo;const So=class So extends transform(String$,Trimmed,{decode:t=>t.trim(),encode:identity$1}).annotations({identifier:"Trim"}){};ie(So,"annotations",yt(So,So,"annotations"));let Trim=So;const vo=class vo extends String$.pipe(nonEmpty({identifier:"NonEmpty",title:"NonEmpty"})){};ie(vo,"annotations",yt(vo,vo,"annotations"));let NonEmpty=vo;const UUIDTypeId=Symbol.for("@effect/schema/TypeId/UUID"),uuidRegexp=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/i,Ao=class Ao extends String$.pipe(pattern(uuidRegexp,{typeId:UUIDTypeId,identifier:"UUID",title:"UUID",description:"a Universally Unique Identifier",arbitrary:()=>t=>t.uuid()})){};ie(Ao,"annotations",yt(Ao,Ao,"annotations"));let UUID=Ao;const ULIDTypeId=Symbol.for("@effect/schema/TypeId/ULID"),ulidRegexp=/^[0-7][0-9A-HJKMNP-TV-Z]{25}$/i,wo=class wo extends String$.pipe(pattern(ulidRegexp,{typeId:ULIDTypeId,identifier:"ULID",title:"ULID",description:"a Universally Unique Lexicographically Sortable Identifier",arbitrary:()=>t=>t.ulid()})){};ie(wo,"annotations",yt(wo,wo,"annotations"));let ULID=wo;const FiniteTypeId=Symbol.for("@effect/schema/TypeId/Finite"),finite=e=>t=>t.pipe(filter(r=>Number.isFinite(r),{typeId:FiniteTypeId,description:"a finite number",...e})),GreaterThanTypeId=GreaterThanTypeId$1,greaterThan=(e,t)=>r=>r.pipe(filter(n=>n>e,{typeId:GreaterThanTypeId,description:"a positive number",jsonSchema:{exclusiveMinimum:e},...t})),GreaterThanOrEqualToTypeId=GreaterThanOrEqualToTypeId$1,greaterThanOrEqualTo=(e,t)=>r=>r.pipe(filter(n=>n>=e,{typeId:GreaterThanOrEqualToTypeId,description:"a non-negative number",jsonSchema:{minimum:e},...t})),IntTypeId=IntTypeId$1,int=e=>t=>t.pipe(filter(r=>Number.isSafeInteger(r),{typeId:IntTypeId,title:"integer",description:"an integer",jsonSchema:{type:"integer"},...e})),LessThanTypeId=LessThanTypeId$1,lessThan=(e,t)=>r=>r.pipe(filter(n=>n<e,{typeId:LessThanTypeId,description:"a negative number",jsonSchema:{exclusiveMaximum:e},...t})),LessThanOrEqualToTypeId=LessThanOrEqualToTypeId$1,lessThanOrEqualTo=(e,t)=>r=>r.pipe(filter(n=>n<=e,{typeId:LessThanOrEqualToTypeId,description:"a non-positive number",jsonSchema:{maximum:e},...t})),NonNaNTypeId=Symbol.for("@effect/schema/TypeId/NonNaN"),nonNaN=e=>t=>t.pipe(filter(r=>!Number.isNaN(r),{typeId:NonNaNTypeId,description:"a number excluding NaN",...e})),positive=e=>greaterThan(0,e),negative=e=>lessThan(0,e),nonPositive=e=>lessThanOrEqualTo(0,e),nonNegative=e=>greaterThanOrEqualTo(0,e),parseNumber=e=>transformOrFail(e,Number$,{strict:!1,decode:(t,r,n)=>fromOption(parse$2(t),()=>new Type(n,t)),encode:t=>succeed(String(t))}),Eo=class Eo extends parseNumber(String$).annotations({identifier:"NumberFromString"}){};ie(Eo,"annotations",yt(Eo,Eo,"annotations"));let NumberFromString=Eo;const Io=class Io extends Number$.pipe(finite({identifier:"Finite",title:"Finite"})){};ie(Io,"annotations",yt(Io,Io,"annotations"));let Finite=Io,Int$1=(Sn=class extends Number$.pipe(int({identifier:"Int",title:"Int"})){},ie(Sn,"annotations",yt(Sn,Sn,"annotations")),Sn);const Co=class Co extends Number$.pipe(nonNaN({identifier:"NonNaN",title:"NonNaN"})){};ie(Co,"annotations",yt(Co,Co,"annotations"));let NonNaN=Co;const xo=class xo extends Number$.pipe(positive({identifier:"Positive",title:"Positive"})){};ie(xo,"annotations",yt(xo,xo,"annotations"));let Positive=xo;const $o=class $o extends Number$.pipe(negative({identifier:"Negative",title:"Negative"})){};ie($o,"annotations",yt($o,$o,"annotations"));let Negative=$o;const To=class To extends Number$.pipe(nonPositive({identifier:"NonPositive",title:"NonPositive"})){};ie(To,"annotations",yt(To,To,"annotations"));let NonPositive=To;const ko=class ko extends Number$.pipe(nonNegative({identifier:"NonNegative",title:"NonNegative"})){};ie(ko,"annotations",yt(ko,ko,"annotations"));let NonNegative=ko;const JsonNumberTypeId=Symbol.for("@effect/schema/TypeId/JsonNumber"),Oo=class Oo extends Number$.pipe(filter(t=>!Number.isNaN(t)&&Number.isFinite(t),{typeId:JsonNumberTypeId,identifier:"JsonNumber",title:"JSON-compatible number",description:"a JSON-compatible number, excluding NaN, +Infinity, and -Infinity",jsonSchema:{type:"number"}})){};ie(Oo,"annotations",yt(Oo,Oo,"annotations"));let JsonNumber=Oo;const Ro=class Ro extends transform(Boolean$,Boolean$,{decode:not,encode:not}){};ie(Ro,"annotations",yt(Ro,Ro,"annotations"));let Not=Ro;const Lo=class Lo extends transform(String$,SymbolFromSelf,{strict:!1,decode:t=>Symbol.for(t),encode:t=>t.description}).annotations({identifier:"symbol"}){};ie(Lo,"annotations",yt(Lo,Lo,"annotations"));let Symbol$=Lo;const Mo=class Mo extends transformOrFail(String$,BigIntFromSelf,{decode:(t,r,n)=>fromOption(fromString$3(t),()=>new Type(n,t)),encode:t=>succeed(String(t))}).annotations({identifier:"bigint"}){};ie(Mo,"annotations",yt(Mo,Mo,"annotations"));let BigInt$=Mo;const No=class No extends transformOrFail(Number$,BigIntFromSelf,{decode:(t,r,n)=>fromOption(fromNumber(t),()=>new Type(n,t)),encode:(t,r,n)=>fromOption(toNumber(t),()=>new Type(n,t))}).annotations({identifier:"BigintFromNumber"}){};ie(No,"annotations",yt(No,No,"annotations"));let BigIntFromNumber=No;const Do=class Do extends declare(isSecret,{identifier:"SecretFromSelf",pretty:()=>t=>String(t),arbitrary:()=>t=>t.string().map(r=>fromString$1(r))}){};ie(Do,"annotations",yt(Do,Do,"annotations"));let SecretFromSelf=Do;const Po=class Po extends transform(String$,SecretFromSelf,{strict:!1,decode:t=>fromString$1(t),encode:t=>value(t)}).annotations({identifier:"Secret"}){};ie(Po,"annotations",yt(Po,Po,"annotations"));let Secret=Po;const Bo=class Bo extends declare(isDuration,{identifier:"DurationFromSelf",pretty:()=>String,arbitrary:()=>t=>t.oneof(t.constant(infinity),t.bigUint().map(r=>nanos(r)),t.bigUint().map(r=>micros(r)),t.maxSafeNat().map(r=>millis(r)),t.maxSafeNat().map(r=>seconds(r)),t.maxSafeNat().map(r=>minutes(r)),t.maxSafeNat().map(r=>hours(r)),t.maxSafeNat().map(r=>days(r)),t.maxSafeNat().map(r=>weeks(r))),equivalence:()=>Equivalence}){};ie(Bo,"annotations",yt(Bo,Bo,"annotations"));let DurationFromSelf=Bo;const Fo=class Fo extends transformOrFail(BigIntFromSelf,DurationFromSelf,{decode:t=>succeed(nanos(t)),encode:(t,r,n)=>match$3(toNanos(t),{onNone:()=>fail(new Type(n,t)),onSome:o=>succeed(o)})}).annotations({identifier:"DurationFromNanos"}){};ie(Fo,"annotations",yt(Fo,Fo,"annotations"));let DurationFromNanos=Fo;const jo=class jo extends transform(Number$,DurationFromSelf,{decode:t=>millis(t),encode:t=>toMillis(t)}).annotations({identifier:"DurationFromMillis"}){};ie(jo,"annotations",yt(jo,jo,"annotations"));let DurationFromMillis=jo;const hrTime=Tuple(NonNegative.pipe(finite({[TitleAnnotationId]:"seconds",[DescriptionAnnotationId]:"seconds"})),NonNegative.pipe(finite({[TitleAnnotationId]:"nanos",[DescriptionAnnotationId]:"nanos"}))),Uo=class Uo extends transform(hrTime,DurationFromSelf,{decode:([t,r])=>nanos(BigInt(t)*BigInt(1e9)+BigInt(r)),encode:t=>toHrTime(t)}).annotations({identifier:"Duration"}){};ie(Uo,"annotations",yt(Uo,Uo,"annotations"));let Duration=Uo;const ValidDateTypeId=Symbol.for("@effect/schema/TypeId/ValidDate"),validDate=e=>t=>t.pipe(filter(r=>!Number.isNaN(r.getTime()),{typeId:ValidDateTypeId,description:"a valid Date",...e})),Ko=class Ko extends declare(isDate,{identifier:"DateFromSelf",description:"a potentially invalid Date instance",pretty:()=>t=>`new Date(${JSON.stringify(t)})`,arbitrary:()=>t=>t.date({noInvalidDate:!1}),equivalence:()=>Date$1}){};ie(Ko,"annotations",yt(Ko,Ko,"annotations"));let DateFromSelf=Ko;const qo=class qo extends DateFromSelf.pipe(validDate({identifier:"ValidDateFromSelf",description:"a valid Date instance"})){};ie(qo,"annotations",yt(qo,qo,"annotations"));let ValidDateFromSelf=qo;const Ho=class Ho extends transform(String$,DateFromSelf,{decode:t=>new Date(t),encode:t=>t.toISOString()}).annotations({identifier:"DateFromString"}){};ie(Ho,"annotations",yt(Ho,Ho,"annotations"));let DateFromString=Ho;const Qo=class Qo extends DateFromString.pipe(validDate({identifier:"Date"})){};ie(Qo,"annotations",yt(Qo,Qo,"annotations"));let Date$=Qo;const zo=class zo extends transform(Number$,DateFromSelf,{decode:t=>new Date(t),encode:t=>t.getTime()}).annotations({identifier:"DateFromNumber"}){};ie(zo,"annotations",yt(zo,zo,"annotations"));let DateFromNumber=zo;const optionDecode=e=>e._tag==="None"?none$4():some(e.value),optionArbitrary=e=>t=>t.oneof(t.record({_tag:t.constant("None")}),t.record({_tag:t.constant("Some"),value:e(t)})).map(optionDecode),optionPretty=e=>match$3({onNone:()=>"none()",onSome:t=>`some(${e(t)})`}),optionParse=e=>(t,r,n)=>isOption(t)?isNone(t)?succeed(none$4()):map(e(t.value,r),some):fail(new Type(n,t)),OptionFromSelf=e=>declare([e],{decode:t=>optionParse(decodeUnknown(t)),encode:t=>optionParse(encodeUnknown(t))},{description:`Option<${format(e)}>`,pretty:optionPretty,arbitrary:optionArbitrary,equivalence:getEquivalence$3}),bigDecimalPretty=()=>e=>`BigDecimal(${format$2(normalize(e))})`,bigDecimalArbitrary=()=>e=>e.tuple(e.bigInt(),e.integer()).map(([t,r])=>make$p(t,r)),Yo=class Yo extends declare(isBigDecimal,{identifier:"BigDecimalFromSelf",pretty:bigDecimalPretty,arbitrary:bigDecimalArbitrary,equivalence:()=>Equivalence$1}){};ie(Yo,"annotations",yt(Yo,Yo,"annotations"));let BigDecimalFromSelf=Yo;const Go=class Go extends transformOrFail(String$,BigDecimalFromSelf,{decode:(t,r,n)=>fromString$4(t).pipe(match$3({onNone:()=>fail(new Type(n,t)),onSome:o=>succeed(normalize(o))})),encode:t=>succeed(format$2(normalize(t)))}).annotations({identifier:"BigDecimal"}){};ie(Go,"annotations",yt(Go,Go,"annotations"));let BigDecimal=Go;const Vo=class Vo extends transformOrFail(Number$,BigDecimalFromSelf,{decode:t=>succeed(fromNumber$1(t)),encode:t=>succeed(unsafeToNumber(t))}).annotations({identifier:"BigDecimalFromNumber"}){};ie(Vo,"annotations",yt(Vo,Vo,"annotations"));let BigDecimalFromNumber=Vo;const getDisableValidationMakeOption=e=>isBoolean(e)?e:(e==null?void 0:e.disableValidation)??!1,FiberIdNoneEncoded=Struct({_tag:Literal("None")}).annotations({identifier:"FiberIdNoneEncoded"}),FiberIdRuntimeEncoded=Struct({_tag:Literal("Runtime"),id:Int$1.annotations({title:"id",description:"id"}),startTimeMillis:Int$1.annotations({title:"startTimeMillis",description:"startTimeMillis"})}).annotations({identifier:"FiberIdRuntimeEncoded"}),FiberIdCompositeEncoded=Struct({_tag:Literal("Composite"),left:suspend(()=>FiberIdEncoded),right:suspend(()=>FiberIdEncoded)}).annotations({identifier:"FiberIdCompositeEncoded"}),FiberIdEncoded=Union(FiberIdNoneEncoded,FiberIdRuntimeEncoded,FiberIdCompositeEncoded).annotations({identifier:"FiberIdEncoded"}),fiberIdArbitrary=e=>e.letrec(t=>({None:e.record({_tag:e.constant("None")}),Runtime:e.record({_tag:e.constant("Runtime"),id:e.integer(),startTimeMillis:e.integer()}),Composite:e.record({_tag:e.constant("Composite"),left:t("FiberId"),right:t("FiberId")}),FiberId:e.oneof(t("None"),t("Runtime"),t("Composite"))})).FiberId.map(fiberIdDecode),fiberIdPretty=e=>{switch(e._tag){case"None":return"FiberId.none";case"Runtime":return`FiberId.runtime(${e.id}, ${e.startTimeMillis})`;case"Composite":return`FiberId.composite(${fiberIdPretty(e.right)}, ${fiberIdPretty(e.left)})`}},Wo=class Wo extends declare(isFiberId,{identifier:"FiberIdFromSelf",pretty:()=>fiberIdPretty,arbitrary:()=>fiberIdArbitrary}){};ie(Wo,"annotations",yt(Wo,Wo,"annotations"));let FiberIdFromSelf=Wo;const fiberIdDecode=e=>{switch(e._tag){case"None":return none$2;case"Runtime":return runtime(e.id,e.startTimeMillis);case"Composite":return composite(fiberIdDecode(e.left),fiberIdDecode(e.right))}},fiberIdEncode=e=>{switch(e._tag){case"None":return{_tag:"None"};case"Runtime":return{_tag:"Runtime",id:e.id,startTimeMillis:e.startTimeMillis};case"Composite":return{_tag:"Composite",left:fiberIdEncode(e.left),right:fiberIdEncode(e.right)}}},Jo=class Jo extends transform(FiberIdEncoded,FiberIdFromSelf,{decode:fiberIdDecode,encode:fiberIdEncode}).annotations({identifier:"FiberId"}){};ie(Jo,"annotations",yt(Jo,Jo,"annotations"));let FiberId=Jo;const Xo=class Xo extends transform(Unknown,Boolean$,{decode:isTruthy,encode:identity$1}).annotations({identifier:"BooleanFromUnknown"}){};ie(Xo,"annotations",yt(Xo,Xo,"annotations"));let BooleanFromUnknown=Xo;var runtimeList=[],registerSignalRuntime=e=>{runtimeList.push(e)},CompositeSignal=class{constructor(e,t=void 0){this._signals=e,this.debugInfo=t}notifyRead(){for(const e of this._signals)e.notifyRead()}notifyWrite(){for(const e of this._signals)e.notifyWrite()}},CompositeRuntime=class{batch(e){const t=r=>r>=runtimeList.length?e():runtimeList[r].batch(()=>t(r+1));return t(0)}createSignal(e){return new CompositeSignal(runtimeList.map(t=>t.createSignal(e)),e)}untracked(e){const t=r=>r>=runtimeList.length?e():runtimeList[r].untracked(()=>t(r+1));return t(0)}},compositeRuntime=new CompositeRuntime,Reference=class Ti{static fromValue(t){return new Ti(t.itemId,t.protocol,t.host)}static fromLegacyTypename(t){return new Ti(t,"protobuf","dxos.org")}constructor(t,r,n){this.itemId=t,this.protocol=r,this.host=n}encode(){return{itemId:this.itemId,host:this.host,protocol:this.protocol}}},REFERENCE_TYPE_TAG="dxos.echo.model.document.Reference",encodeReference=e=>({"@type":REFERENCE_TYPE_TAG,itemId:e.itemId??null,protocol:e.protocol??null,host:e.host??null}),decodeReference=e=>new Reference(e.itemId,e.protocol??void 0,e.host??void 0),isEncodedReferenceObject=e=>typeof e=="object"&&e!==null&&e["@type"]===REFERENCE_TYPE_TAG,__dxlog_file$s="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/ast/schema-validator.ts",symbolSchema=Symbol.for("@dxos/schema"),SchemaValidator=class{static validateSchema(e){const t=r=>r.forEach(n=>this.validateSchema(make$1(n)));if(isUnion(e.ast)){const r=e.ast.types.filter(n=>isTypeLiteral(n));r.length>1&&getTypeDiscriminators(r),t(r)}else if(isTupleType(e.ast)){const r=e.ast.elements.map(n=>n.type).concat(e.ast.rest);t(r)}else isTypeLiteral(e.ast)&&t(getPropertySignatures(e.ast).map(r=>r.type))}static hasTypeAnnotation(e,t,r){try{let n=this.getPropertySchema(e,[t]);return isTupleType(n.ast)&&(n=this.getPropertySchema(e,[t,"0"])),n.ast.annotations[r]!=null}catch{return!1}}static getPropertySchema(e,t,r=()=>null){let n=e;for(let o=0;o<t.length;o++){const s=t[o],a=unwrapArray(n.ast);if(a!=null)n=getArrayElementSchema(a,s);else{const c=getPropertyType(n.ast,s.toString(),l=>r([...t.slice(0,o),l]));invariant$1(c,`unknown property: ${String(s)}, path: ${t}`,{F:__dxlog_file$s,L:63,S:this,A:["propertyType","`unknown property: ${String(propertyName)}, path: ${propertyPath}`"]}),n=make$1(c).annotations(c.annotations)}}return n}static getTargetPropertySchema(e,t){const r=e[symbolSchema];invariant$1(r,"target has no schema",{F:__dxlog_file$s,L:72,S:this,A:["schema","'target has no schema'"]});const n=unwrapArray(r.ast);if(n!=null)return getArrayElementSchema(n,t);const o=getPropertyType(r.ast,t.toString(),s=>e[s]);return invariant$1(o,`invalid property: ${t.toString()}`,{F:__dxlog_file$s,L:79,S:this,A:["propertyType","`invalid property: ${prop.toString()}`"]}),make$1(o)}},getArrayElementSchema=(e,t)=>{const r=typeof t=="string"?parseInt(t,10):Number.NaN;if(Number.isNaN(r))return invariant$1(t==="length",`invalid array property: ${String(t)}`,{F:__dxlog_file$s,L:92,S:void 0,A:["property === 'length'","`invalid array property: ${String(property)}`"]}),Number$;if(r<e.elements.length){const o=e.elements[r].type;return make$1(o).annotations(o.annotations)}const n=e.rest;return make$1(n[0]).annotations(n[0].annotations)},flattenUnion=e=>isUnion(e)?e.types.flatMap(flattenUnion):[e],getProperties=(e,t)=>{const r=flattenUnion(e).filter(a=>isTypeLiteral(a));if(r.length===0)return[];if(r.length===1)return getPropertySignatures(r[0]);const n=getTypeDiscriminators(r),o=t(String(n[0].name)),s=n.findIndex(a=>o===a.type.literal);return invariant$1(s!==-1,"discriminator field not set on target",{F:__dxlog_file$s,L:123,S:void 0,A:["typeIndex !== -1","'discriminator field not set on target'"]}),getPropertySignatures(r[s])},getPropertyType=(e,t,r)=>{if(unwrapAst(e,s=>isAnyKeyword(s)||isObjectKeyword(s))!=null)return e;const n=unwrapAst(e,s=>isTypeLiteral(s)||isUnion(s)&&s.types.some(a=>isTypeLiteral(a)));if(n==null)return null;const o=getProperties(n,r).find(s=>s.name===t);return o!=null?unwrapAst(o.type):isTypeLiteral(n)&&n.indexSignatures.length>0?unwrapAst(n.indexSignatures[0].type):null},getTypeDiscriminators=e=>{const t=e.flatMap(getPropertySignatures).filter(s=>isLiteral(s.type)),r=t[0].name,n=t.every(s=>s.name===r&&!s.isOptional),o=t.length===e.length;return invariant$1(n&&o,"type ambiguity: every type in a union must have a single unique-literal field",{F:__dxlog_file$s,L:162,S:void 0,A:["isDiscriminatedUnion","'type ambiguity: every type in a union must have a single unique-literal field'"]}),t},unwrapAst=(e,t)=>{let r=e;for(;r!=null;){if(t!=null&&t(r))return r;if(isUnion(r)){const n=r.types.find(o=>t!=null&&t(o)||isSuspend(o));if(n!=null){r=n;continue}}if(isSuspend(r))r=r.f();else return t==null?r:null}return null},unwrapArray=e=>unwrapAst(e,isTupleType),checkIdNotPresentOnSchema=e=>{if(invariant$1(isTypeLiteral(e.ast),void 0,{F:__dxlog_file$s,L:202,S:void 0,A:["isTypeLiteral(schema.ast)",""]}),getPropertySignatures(e.ast).find(t=>t.name==="id")!=null)throw new Error('"id" property name is reserved')},schemaVariance={_A:e=>e,_I:e=>e,_R:e=>e},IndexAnnotation=Symbol.for("@dxos/schema/annotation/Index");getAnnotation(IndexAnnotation);var EchoObjectAnnotationId=Symbol.for("@dxos/echo-schema/annotation/NamedSchema"),getEchoObjectAnnotation=e=>pipe(getAnnotation(EchoObjectAnnotationId)(e.ast),getOrElse(()=>{})),echoObject=(e,t)=>r=>{if(!isTypeLiteral(r.ast))throw new Error("echoObject can only be applied to S.Struct instances.");checkIdNotPresentOnSchema(r);const n=extend(mutable(r),Struct({id:String$}));return make$1(annotations(n.ast,{[EchoObjectAnnotationId]:{typename:e,version:t}}))},ReferenceAnnotation=Symbol.for("@dxos/schema/annotation/Reference"),EchoObjectFieldMetaAnnotationId=Symbol.for("@dxos/echo-schema/annotation/FieldMeta"),ReactiveArray=(qn=class extends Array{static get[Symbol.species](){return Array}},(()=>{const t=["push","pop","shift","unshift","splice","sort","reverse"];for(const r of t)Object.defineProperty(qn.prototype,r,{enumerable:!1,value:function(...n){let o;return compositeRuntime.batch(()=>{o=Array.prototype[r].apply(this,n)}),o}})})(),qn),__dxlog_file2$i="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/proxy/proxy.ts",symbolIsProxy=Symbol("isProxy"),isValidProxyTarget=e=>e==null||e[symbolIsProxy]?!1:e instanceof ReactiveArray?!0:typeof e=="object"&&Object.getPrototypeOf(e)===Object.prototype,createReactiveProxy=(e,t)=>{const r=t._proxyMap.get(e);if(r)return r;const n=new ProxyHandlerSlot;n.handler=t,n.target=e;const o=new Proxy(e,n);return t.init(e),t._proxyMap.set(e,o),o},ProxyHandlerSlot=(Hn=class{constructor(){this.handler=void 0,this.target=void 0}get(t,r,n){return r===symbolIsProxy?this:!this.handler||!this.handler.get?Reflect.get(t,r,n):this.handler.get(t,r,n)}},(()=>{const t=["apply","construct","defineProperty","deleteProperty","get","getOwnPropertyDescriptor","getPrototypeOf","has","isExtensible","ownKeys","preventExtensions","set","setPrototypeOf"];for(const r of t)r!=="get"&&Object.defineProperty(Hn.prototype,r,{enumerable:!1,value:function(...n){return!this.handler||!this.handler[r]?Reflect[r](...n):this.handler[r].apply(this.handler,n)}})})(),Hn),isReactiveObject=e=>!!(e!=null&&e[symbolIsProxy]),getProxyHandlerSlot=e=>{const t=e[symbolIsProxy];return invariant$1(t instanceof ProxyHandlerSlot,void 0,{F:__dxlog_file2$i,L:106,S:void 0,A:["value instanceof ProxyHandlerSlot",""]}),t},__dxlog_file3$g="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/getter.ts",getSchema=e=>{var t;if(e!=null&&isReactiveObject(e))return(t=getProxyHandlerSlot(e).handler)==null?void 0:t.getSchema(e)},getTypeReference=e=>{if(!e)return;const t=getEchoObjectAnnotation(e);if(t!=null)return t.storedSchemaId?new Reference(t.storedSchemaId):Reference.fromLegacyTypename(t.typename)},getMeta=e=>{var r;const t=(r=getProxyHandlerSlot(e).handler)==null?void 0:r.getMeta(e);return invariant$1(t,void 0,{F:__dxlog_file3$g,L:47,S:void 0,A:["meta",""]}),t},requireTypeReference=e=>{const t=getTypeReference(e);if(t==null)throw new Error('Schema must have a valid annotation: MyTypeSchema.pipe(R.echoObject("MyType", "1.0.0"))');return t},TypedObject=e=>(t,r)=>{var a;var n;const o=mutable(r!=null&&r.partial?partial(Struct(t)):Struct(t)),s=extend(o,Struct({id:String$})).annotations({[EchoObjectAnnotationId]:{typename:e.typename,version:e.version}});return a=class{static[Symbol.hasInstance](l){var h;return l!=null&&((h=getTypeReference(getSchema(l)))==null?void 0:h.itemId)===e.typename}constructor(){throw new Error("use create(MyClass, fields) to instantiate an object")}},n=TypeId,a.typename=e.typename,a.ast=s.ast,a[n]=schemaVariance,a.annotations=s.annotations.bind(s),a.pipe=s.pipe.bind(s),a};const make=e=>{const t={},r=go(e.ast,t,!0,[]),n={$schema,...r};for(const o in t)t[o].$ref===get$ref(o)&&delete t[o];return isEmptyRecord(t)||(n.$defs=t),n},anyJsonSchema={$id:"/schemas/any"},unknownJsonSchema={$id:"/schemas/unknown"},objectJsonSchema={$id:"/schemas/object",oneOf:[{type:"object"},{type:"array"}]},empty=()=>({$id:"/schemas/{}",oneOf:[{type:"object"},{type:"array"}]}),$schema="http://json-schema.org/draft-07/schema#",getJsonSchemaAnnotations=e=>getSomes({description:getDescriptionAnnotation(e),title:getTitleAnnotation(e),examples:getExamplesAnnotation(e),default:getDefaultAnnotation(e)}),pruneUndefinedKeyword=e=>{const t=e.type;return e.isOptional&&isUnion(t)&&isNone(getJSONSchemaAnnotation(t))?Union$2.make(t.types.filter(r=>!isUndefinedKeyword(r)),t.annotations):t},getMissingAnnotationErrorMessage=(e,t)=>getErrorMessageWithPath(`cannot build a JSON Schema for ${e} without a JSON Schema annotation`,t),getUnsupportedIndexSignatureParameterErrorMessage=(e,t)=>getErrorMessageWithPath(`unsupported index signature parameter (${e})`,t),DEFINITION_PREFIX="#/$defs/",get$ref=e=>`${DEFINITION_PREFIX}${e}`,hasTransformation=e=>{switch(e.from._tag){case"Transformation":return!0;case"Refinement":return hasTransformation(e.from);case"Suspend":{const t=e.from.f();if(isRefinement(t))return hasTransformation(t)}break}return!1},go=(e,t,r,n)=>{const o=getJSONSchemaAnnotation(e);if(isSome(o)){const a=o.value;if(isRefinement(e)&&!hasTransformation(e))try{return{...go(e.from,t,!0,n),...getJsonSchemaAnnotations(e),...a}}catch{return{...getJsonSchemaAnnotations(e),...a}}return a}const s=getSurrogateAnnotation(e);if(isSome(s))return go(s.value,t,r,n);if(r&&!isTransformation(e)){const a=getJSONIdentifier(e);if(isSome(a)){const c=a.value,l={$ref:get$ref(c)};return has$4(t,c)||(t[c]=l,t[c]=go(e,t,!1,n)),l}}switch(e._tag){case"Declaration":throw new Error(getMissingAnnotationErrorMessage("a declaration",n));case"Literal":{const a=e.literal;if(a===null)return{const:null,...getJsonSchemaAnnotations(e)};if(isString(a))return{const:a,...getJsonSchemaAnnotations(e)};if(isNumber(a))return{const:a,...getJsonSchemaAnnotations(e)};if(isBoolean(a))return{const:a,...getJsonSchemaAnnotations(e)};throw new Error(getMissingAnnotationErrorMessage("a bigint literal",n))}case"UniqueSymbol":throw new Error(getMissingAnnotationErrorMessage("a unique symbol",n));case"UndefinedKeyword":throw new Error(getMissingAnnotationErrorMessage("`undefined`",n));case"VoidKeyword":throw new Error(getMissingAnnotationErrorMessage("`void`",n));case"NeverKeyword":throw new Error(getMissingAnnotationErrorMessage("`never`",n));case"UnknownKeyword":return{...unknownJsonSchema,...getJsonSchemaAnnotations(e)};case"AnyKeyword":return{...anyJsonSchema,...getJsonSchemaAnnotations(e)};case"ObjectKeyword":return{...objectJsonSchema,...getJsonSchemaAnnotations(e)};case"StringKeyword":return{type:"string",...getJsonSchemaAnnotations(e)};case"NumberKeyword":return{type:"number",...getJsonSchemaAnnotations(e)};case"BooleanKeyword":return{type:"boolean",...getJsonSchemaAnnotations(e)};case"BigIntKeyword":throw new Error(getMissingAnnotationErrorMessage("`bigint`",n));case"SymbolKeyword":throw new Error(getMissingAnnotationErrorMessage("`symbol`",n));case"TupleType":{const a=e.elements.length,c=e.elements.map((u,d)=>go(u.type,t,!0,n.concat(d))),l=e.rest.map(u=>go(u,t,!0,n)),h={type:"array"};if(a>0&&(h.minItems=a-e.elements.filter(u=>u.isOptional).length,h.items=c),l.length>0){const u=l[0];if(a>0?h.additionalItems=u:h.items=u,l.length>1)throw new Error(getErrorMessageWithPath("Generating a JSON Schema for post-rest elements is not currently supported. You're welcome to contribute by submitting a Pull Request.",n))}else a>0?h.additionalItems=!1:h.maxItems=0;return{...h,...getJsonSchemaAnnotations(e)}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return{...empty(),...getJsonSchemaAnnotations(e)};let a,c;for(const u of e.indexSignatures){const d=u.parameter;switch(d._tag){case"StringKeyword":{a=go(u.type,t,!0,n);break}case"TemplateLiteral":{c={[getTemplateLiteralRegExp(d).source]:go(u.type,t,!0,n)};break}case"Refinement":{const f=getJSONSchemaAnnotation(d);if(isSome(f)&&"pattern"in f.value&&isString(f.value.pattern)){c={[f.value.pattern]:go(u.type,t,!0,n)};break}throw new Error(getUnsupportedIndexSignatureParameterErrorMessage(d,n))}case"SymbolKeyword":throw new Error(getUnsupportedIndexSignatureParameterErrorMessage(d,n))}}const l=e.propertySignatures.map(u=>({...go(pruneUndefinedKeyword(u),t,!0,n.concat(u.name)),...getJsonSchemaAnnotations(u)})),h={type:"object",required:[],properties:{},additionalProperties:!1};for(let u=0;u<l.length;u++){const d=e.propertySignatures[u].name;if(isString(d))h.properties[d]=l[u],e.propertySignatures[u].isOptional||h.required.push(d);else throw new Error(getErrorMessageWithPath(`cannot encode ${String(d)} key to JSON Schema`,n))}return a!==void 0&&(h.additionalProperties=a),c!==void 0&&(h.patternProperties=c),{...h,...getJsonSchemaAnnotations(e)}}case"Union":{const a=[],c=[];for(const l of e.types){const h=go(l,t,!0,n);"const"in h?Object.keys(h).length>1?c.push(h):a.push(h.const):c.push(h)}return c.length===0?a.length===1?{const:a[0],...getJsonSchemaAnnotations(e)}:{enum:a,...getJsonSchemaAnnotations(e)}:(a.length===1?c.push({const:a[0]}):a.length>1&&c.push({enum:a}),{anyOf:c,...getJsonSchemaAnnotations(e)})}case"Enums":return{$comment:"/schemas/enums",oneOf:e.enums.map(a=>({title:a[0],const:a[1]})),...getJsonSchemaAnnotations(e)};case"Refinement":throw new Error(getErrorMessageWithPath("cannot build a JSON Schema for a refinement without a JSON Schema annotation",n));case"TemplateLiteral":return{type:"string",description:"a template literal",pattern:getTemplateLiteralRegExp(e).source,...getJsonSchemaAnnotations(e)};case"Suspend":{const a=orElse$2(getJSONIdentifier(e),()=>getJSONIdentifier(e.f()));if(isNone(a))throw new Error(getErrorMessageWithPath("Generating a JSON Schema for suspended schemas requires an identifier annotation",n));return go(e.f(),t,!0,n)}case"Transformation":return go(e.from,t,!0,n)}};var StoredEchoSchema=class extends TypedObject({typename:"dxos.echo.StoredSchema",version:"0.1.0"})({typename:String$,version:String$,jsonSchema:Any}){},__dxlog_file$r="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/json/json-schema.ts",ECHO_REFINEMENT_KEY="$echo",annotationToRefinementKey={[EchoObjectAnnotationId]:"type",[ReferenceAnnotation]:"reference",[EchoObjectFieldMetaAnnotationId]:"fieldMeta"},PropType;(function(e){e[e.NONE=0]="NONE",e[e.STRING=1]="STRING",e[e.NUMBER=2]="NUMBER",e[e.BOOLEAN=3]="BOOLEAN",e[e.DATE=4]="DATE",e[e.REF=5]="REF",e[e.RECORD=6]="RECORD",e[e.ENUM=7]="ENUM"})(PropType||(PropType={}));let effectToJsonSchema,jsonToEffectTypeSchema,jsonToEffectSchema,__dxlog_file2$h,DynamicObjectSchemaBase,DynamicEchoSchema,unwrapOptionality,unwrapProxy,data,TYPE_PROPERTIES,_ForeignKeySchema,ForeignKeySchema,ObjectMetaSchema,defineHiddenProperty,__dxlog_file3$f,symbolSignal,symbolPropertySignal,TypedReactiveHandler,toJSON,setSchemaProperties,prepareTypedTarget,makeArraysReactive,__dxlog_file4$a,symbolSignal2,symbolPropertySignal2,UntypedReactiveHandler,toJSON2,EXPANDO_TYPENAME,_Expando,Expando,__dxlog_file5$7,_create,_generateId,setId,symbolMeta,initMeta,getTargetMeta,DEFAULT_CLIENT_CHANNEL,HOME,DX_DATA,base62,codec$1,InvitationEncoder,AUTHENTICATION_CODE_LENGTH,INVITATION_TIMEOUT,CancellableInvitation,AuthenticatingInvitation,iframeServiceBundle,workerServiceBundle,STATUS_TIMEOUT,RESOURCE_LOCK_TIMEOUT,LOAD_CONTROL_FEEDS_TIMEOUT,_Properties,queueMicrotask_1$1,fixedSize;effectToJsonSchema=e=>{const t=n=>{let o=n;isTypeLiteral(n)?o={...n,propertySignatures:n.propertySignatures.map(a=>({...a,type:t(a.type)}))}:isUnion(n)?o={...n,types:n.types.map(t)}:isTupleType(n)&&(o={...n,elements:n.elements.map(a=>({...a,type:t(a.type)})),rest:n.rest.map(a=>t(a))});const s={};for(const a of[EchoObjectAnnotationId,ReferenceAnnotation,EchoObjectFieldMetaAnnotationId])n.annotations[a]!=null&&(s[annotationToRefinementKey[a]]=n.annotations[a]);return Object.keys(s).length===0?o:new Refinement$1(o,()=>null,{[JSONSchemaAnnotationId]:{[ECHO_REFINEMENT_KEY]:s}})},r=make$1(t(e.ast));return make(r)},jsonToEffectTypeSchema=(e,t)=>{invariant$1("type"in e&&e.type==="object",`not an object: ${e}`,{F:__dxlog_file$r,L:131,S:void 0,A:["'type' in root && root.type === 'object'","`not an object: ${root}`"]}),invariant$1(e.patternProperties==null,"template literals are not supported",{F:__dxlog_file$r,L:132,S:void 0,A:["root.patternProperties == null","'template literals are not supported'"]});const r=e[ECHO_REFINEMENT_KEY],n={},o=Object.entries(e.properties??{});let s;for(const[h,u]of o)r!=null&&r.type&&h==="id"?s=jsonToEffectSchema(u,t):n[h]=e.required.includes(h)?jsonToEffectSchema(u,t):optional(jsonToEffectSchema(u,t));let a;if(typeof e.additionalProperties!="object")a=Struct(n);else{const h=jsonToEffectSchema(e.additionalProperties,t);o.length>0?a=Struct(n,{key:String$,value:h}):a=Record(String$,h)}if(r==null)return a;invariant$1(s,"no id in echo type",{F:__dxlog_file$r,L:164,S:void 0,A:["immutableIdField","'no id in echo type'"]});const c=extend(mutable(a),Struct({id:s})),l={};for(const h of[EchoObjectAnnotationId,ReferenceAnnotation,EchoObjectFieldMetaAnnotationId])r[annotationToRefinementKey[h]]&&(l[h]=r[annotationToRefinementKey[h]]);return c.annotations(l)},jsonToEffectSchema=(e,t)=>{const r=e.$defs?{...t,...e.$defs}:t??{};if("type"in e&&e.type==="object")return jsonToEffectTypeSchema(e,r);let n;if("$id"in e)switch(e.$id){case"/schemas/any":n=Any;break;case"/schemas/unknown":n=Unknown;break;case"/schemas/{}":case"/schemas/object":n=Object$;break}else if("const"in e)n=Literal(e.const);else if("enum"in e)n=Union(...e.enum.map(s=>Literal(s)));else if("anyOf"in e)n=Union(...e.anyOf.map(s=>jsonToEffectSchema(s,r)));else if("$comment"in e&&e.$comment==="/schemas/enums")n=Enums(Object.fromEntries(e.oneOf.map(({title:s,const:a})=>[s,a])));else if("type"in e)switch(e.type){case"string":n=String$;break;case"number":n=Number$;break;case"integer":n=Number$.pipe(int());break;case"boolean":n=Boolean$;break;case"array":Array.isArray(e.items)?n=Tuple(...e.items.map(s=>jsonToEffectSchema(s,r))):(invariant$1(e.items,void 0,{F:__dxlog_file$r,L:222,S:void 0,A:["root.items",""]}),n=Array$(jsonToEffectSchema(e.items,r)));break}else if("$ref"in e){const s=e.$ref.split("/"),a=r[s[s.length-1]];invariant$1(a,`missing definition for ${e.$ref}`,{F:__dxlog_file$r,L:230,S:void 0,A:["jsonSchema","`missing definition for ${root.$ref}`"]}),n=jsonToEffectSchema(a,r).pipe(identifier(s[s.length-1]))}else n=Unknown;const o=e[ECHO_REFINEMENT_KEY];return o!=null&&o.fieldMeta?n.annotations({[EchoObjectFieldMetaAnnotationId]:o.fieldMeta}):n},__dxlog_file2$h="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/dynamic/dynamic-schema.ts",DynamicObjectSchemaBase=()=>{var t;var e;return t=class{static get ast(){return this._schema.ast}static get annotations(){const n=this._schema;return n.annotations.bind(n)}static get pipe(){const n=this._schema;return n.pipe.bind(n)}static get _schema(){return Union(StoredEchoSchema,instanceOf(DynamicEchoSchema)).annotations(StoredEchoSchema.ast.annotations)}},e=TypeId,t[e]=schemaVariance,t},DynamicEchoSchema=class extends DynamicObjectSchemaBase(){constructor(e){super(),this.serializedSchema=e,this._isDirty=!0}get id(){return this.serializedSchema.id}get Type(){return this.serializedSchema}get Encoded(){return this.serializedSchema}get ast(){return this._getSchema().ast}get annotations(){const e=this._getSchema();return e.annotations.bind(e)}get pipe(){const e=this._getSchema();return e.pipe.bind(e)}get[TypeId](){return schemaVariance}get schema(){return this._getSchema()}get typename(){return this.serializedSchema.typename}invalidate(){this._isDirty=!0}addColumns(e){const t=this._getSchema(),r=partial(Struct(e)),n=extend(t,r).annotations(t.ast.annotations);this.serializedSchema.jsonSchema=effectToJsonSchema(n)}updateColumns(e){const t=this._getSchema().ast;invariant$1(isTypeLiteral(t),void 0,{F:__dxlog_file2$h,L:110,S:this,A:["AST.isTypeLiteral(oldAst)",""]});const r=partial(Struct(e)).ast.propertySignatures,n=[...t.propertySignatures];for(const a of r){const c=n.findIndex(l=>l.name===a.name);c!==-1?n.splice(c,1,a):n.push(a)}const o={...t,propertySignatures:n},s=make$1(o);this.serializedSchema.jsonSchema=effectToJsonSchema(s)}removeColumns(e){const t=this._getSchema(),r=make$1(omit(t.ast,e)).annotations(t.ast.annotations);this.serializedSchema.jsonSchema=effectToJsonSchema(r)}getProperties(){const e=this._getSchema().ast;return invariant$1(isTypeLiteral(e),void 0,{F:__dxlog_file2$h,L:136,S:this,A:["AST.isTypeLiteral(ast)",""]}),[...e.propertySignatures].filter(t=>t.name!=="id").map(unwrapOptionality)}updatePropertyName({before:e,after:t}){const r=this._getSchema().ast;invariant$1(isTypeLiteral(r),void 0,{F:__dxlog_file2$h,L:143,S:this,A:["AST.isTypeLiteral(oldAST)",""]});const n={...r,propertySignatures:r.propertySignatures.map(s=>s.name===e?{...s,name:t}:s)},o=make$1(n);this.serializedSchema.jsonSchema=effectToJsonSchema(o)}_getSchema(){return(this._isDirty||this._schema==null)&&(this._schema=jsonToEffectSchema(unwrapProxy(this.serializedSchema.jsonSchema)),this._isDirty=!1),this._schema}},unwrapOptionality=e=>isUnion(e.type)?{...e,type:e.type.types.find(t=>!isUndefinedKeyword(t))}:e,unwrapProxy=e=>{if(typeof e!="object")return e;if(Array.isArray(e))return e.map(unwrapProxy);const t={};for(const r in e)t[r]=unwrapProxy(e[r]);return t},data=Symbol.for("dxos.echo.data"),TYPE_PROPERTIES="dxos.sdk.client.Properties",_ForeignKeySchema=Struct({source:String$,id:String$}),ForeignKeySchema=_ForeignKeySchema,ObjectMetaSchema=Struct({keys:mutable(Array$(ForeignKeySchema))}),defineHiddenProperty=(e,t,r)=>{Object.defineProperty(e,t,{enumerable:!1,configurable:!0,value:r})},__dxlog_file3$f="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/handler/typed-handler.ts",symbolSignal=Symbol("signal"),symbolPropertySignal=Symbol("property-signal"),TypedReactiveHandler=(kn=class{constructor(){this._proxyMap=new WeakMap}init(t){invariant$1(typeof t=="object"&&t!==null,void 0,{F:__dxlog_file3$f,L:52,S:this,A:["typeof target === 'object' && target !== null",""]}),invariant$1(symbolSchema in t,"Schema is not defined for the target",{F:__dxlog_file3$f,L:53,S:this,A:["symbolSchema in target","'Schema is not defined for the target'"]}),symbolSignal in t||(defineHiddenProperty(t,symbolSignal,compositeRuntime.createSignal()),defineHiddenProperty(t,symbolPropertySignal,compositeRuntime.createSignal()));for(const r of Object.getOwnPropertyNames(t))Object.getOwnPropertyDescriptor(t,r).get;export_inspect.custom&&defineHiddenProperty(t,export_inspect.custom,this._inspect.bind(t))}get(t,r,n){var s;if(r===data)return t[symbolSignal].notifyRead(),toJSON(t);if((s=Object.getOwnPropertyDescriptor(t,r))!=null&&s.get)return t[symbolPropertySignal].notifyRead(),Reflect.get(t,r,n);t[symbolSignal].notifyRead(),t[symbolPropertySignal].notifyRead();const o=Reflect.get(t,r,n);return isValidProxyTarget(o)?createReactiveProxy(o,this):o}set(t,r,n,o){Array.isArray(n)&&(n=ReactiveArray.from(n));let s=!1;return compositeRuntime.batch(()=>{const a=this._validateValue(t,r,n);s=Reflect.set(t,r,a,o),t[symbolSignal].notifyWrite()}),s}defineProperty(t,r,n){const o=this._validateValue(t,r,n.value),s=Reflect.defineProperty(t,r,{...n,value:o});return t[symbolPropertySignal].notifyWrite(),s}isDeleted(){return!1}getSchema(t){return t[symbolSchema]}getTypeReference(t){return getTypeReference(t[symbolSchema])}getMeta(t){return getTargetMeta(t)}_validateValue(t,r,n){const o=SchemaValidator.getTargetPropertySchema(t,r);return asserts(o)(n),Array.isArray(n)&&(n=new ReactiveArray(...n)),isValidProxyTarget(n)&&setSchemaProperties(n,o),n}_inspect(t,r,n){return`Typed ${n(this,{...r,compact:!0,showHidden:!1,customInspect:!1})}`}},kn.instance=new kn,kn),toJSON=e=>({"@type":"TypedReactiveObject",...e}),setSchemaProperties=(e,t)=>{defineHiddenProperty(e,symbolSchema,t);for(const r in e)if(isValidProxyTarget(e[r])){const n=SchemaValidator.getTargetPropertySchema(e,r);n!=null&&setSchemaProperties(e[r],n)}},prepareTypedTarget=(e,t)=>{if(!isTypeLiteral(t.ast))throw new Error("schema has to describe an object type");SchemaValidator.validateSchema(t),asserts(t)(e),makeArraysReactive(e),setSchemaProperties(e,t)},makeArraysReactive=e=>{for(const t in e)e[symbolIsProxy]||(Array.isArray(e[t])&&(e[t]=ReactiveArray.from(e[t])),typeof e[t]=="object"&&makeArraysReactive(e[t]))},__dxlog_file4$a="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/handler/untyped-handler.ts",symbolSignal2=Symbol("signal"),symbolPropertySignal2=Symbol("property-signal"),UntypedReactiveHandler=(On=class{constructor(){this._proxyMap=new WeakMap}init(t){invariant$1(typeof t=="object"&&t!==null,void 0,{F:__dxlog_file4$a,L:42,S:this,A:["typeof target === 'object' && target !== null",""]}),symbolSignal2 in t||(defineHiddenProperty(t,symbolSignal2,compositeRuntime.createSignal()),defineHiddenProperty(t,symbolPropertySignal2,compositeRuntime.createSignal()));for(const r of Object.getOwnPropertyNames(t))Object.getOwnPropertyDescriptor(t,r).get||Array.isArray(t[r])&&!(t[r]instanceof ReactiveArray)&&(t[r]=ReactiveArray.from(t[r]))}get(t,r,n){var s;if((s=Object.getOwnPropertyDescriptor(t,r))!=null&&s.get)return t[symbolPropertySignal2].notifyRead(),Reflect.get(t,r,n);if(t[symbolSignal2].notifyRead(),t[symbolPropertySignal2].notifyRead(),r===data)return toJSON2(t);const o=Reflect.get(t,r);return isValidProxyTarget(o)?createReactiveProxy(o,this):o}set(t,r,n,o){Array.isArray(n)&&(n=ReactiveArray.from(n));const s=Reflect.set(t,r,n);return t[symbolSignal2].notifyWrite(),s}defineProperty(t,r,n){const o=Reflect.defineProperty(t,r,n);return t[symbolPropertySignal2].notifyWrite(),o}isDeleted(){return!1}getSchema(){}getTypeReference(){}getMeta(t){return getTargetMeta(t)}},On.instance=new On,On),toJSON2=e=>({"@type":"ReactiveObject",...e}),EXPANDO_TYPENAME="Expando",_Expando=Struct({},{key:String$,value:Any}).pipe(echoObject(EXPANDO_TYPENAME,"0.1.0")),Expando=_Expando,__dxlog_file5$7="/home/runner/work/dxos/dxos/packages/core/echo/echo-schema/src/handler/object.ts",create$2=(e,t,r)=>t&&e!==Expando?_create({...t},r,e):t&&e===Expando?_create({...t},r,void 0,{expando:!0}):_create(e,r),_create=(e,t,r,n)=>{if(!isValidProxyTarget(e))throw new Error("Value cannot be made into a reactive object.");return r?((n!=null&&n.expando||getEchoObjectAnnotation(r))&&setId(e),initMeta(e,t),prepareTypedTarget(e,r),createReactiveProxy(e,TypedReactiveHandler.instance)):(n!=null&&n.expando&&setId(e),initMeta(e,t),createReactiveProxy(e,UntypedReactiveHandler.instance))},_generateId=()=>PublicKey.random().toHex(),setId=e=>{invariant$1(!("id"in e),"Object already has an `id` field, which is reserved.",{F:__dxlog_file5$7,L:72,S:void 0,A:["!('id' in (obj as any))","'Object already has an `id` field, which is reserved.'"]}),e.id=_generateId()},symbolMeta=Symbol.for("@dxos/meta"),initMeta=(e,t={keys:[]})=>{prepareTypedTarget(t,ObjectMetaSchema),defineHiddenProperty(e,symbolMeta,createReactiveProxy(t,TypedReactiveHandler.instance))},getTargetMeta=e=>{const t=e[symbolMeta];return invariant$1(t,"Metadata not found.",{F:__dxlog_file5$7,L:92,S:void 0,A:["metadata","'Metadata not found.'"]}),t},DEFAULT_INTERNAL_CHANNEL="dxos:vault",DEFAULT_CLIENT_CHANNEL="dxos:app",DEFAULT_SHELL_CHANNEL="dxos:shell",DEFAULT_VAULT_ORIGIN="https://halo.dxos.org",DEFAULT_VAULT_URL=DEFAULT_VAULT_ORIGIN+"/vault.html",HOME=typeof process<"u"?((Rs=process==null?void 0:process.env)==null?void 0:Rs.HOME)??"":"",getProfilePath=(e,t,r=void 0)=>`${e}/profile/${t}`+(r?`/${r}`:""),DX_DATA=`${HOME}/.local/share/dx`,DX_RUNTIME="/tmp/dx/run",defaultKey="__DEFAULT__",base62=base$3("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),codec$1=schema.getCodecForType("dxos.client.services.Invitation"),InvitationEncoder=class{static decode(e){const t=codec$1.decode(base62.decode(e));return t.type===Invitation.Type.MULTIUSE&&(t.type=Invitation.Type.INTERACTIVE,t.multiUse=!0),t}static encode(e){return base62.encode(codec$1.encode({invitationId:e.invitationId,type:e.type,kind:e.kind,authMethod:e.authMethod,swarmKey:e.swarmKey,state:e.state,timeout:e.timeout,guestKeypair:e.guestKeypair,...e.spaceKey?{spaceKey:e.spaceKey}:{},...e.target?{target:e.target}:{}}))}},AUTHENTICATION_CODE_LENGTH=6,INVITATION_TIMEOUT=18e4,CancellableInvitation=class extends MulticastObservable{constructor({subscriber:e,initialInvitation:t,onCancel:r}){super(e,t),this._onCancel=r}cancel(){return this._onCancel()}get expired(){const e=this.get();return e.created&&e.lifetime&&e.lifetime!==0&&e.created.getTime()+e.lifetime*1e3<Date.now()}get expiry(){const e=this.get();return e.created&&e.lifetime&&e.lifetime!==0?new Date(e.created.getTime()+e.lifetime*1e3):void 0}},AuthenticatingInvitation=class extends CancellableInvitation{constructor({subscriber:e,initialInvitation:t,onCancel:r,onAuthenticate:n}){super({subscriber:e,initialInvitation:t,onCancel:r}),this._onAuthenticate=n}async authenticate(e){return this._onAuthenticate(e)}},clientServiceBundle=createServiceBundle({SystemService:schema.getService("dxos.client.services.SystemService"),NetworkService:schema.getService("dxos.client.services.NetworkService"),LoggingService:schema.getService("dxos.client.services.LoggingService"),IdentityService:schema.getService("dxos.client.services.IdentityService"),QueryService:schema.getService("dxos.echo.query.QueryService"),InvitationsService:schema.getService("dxos.client.services.InvitationsService"),DevicesService:schema.getService("dxos.client.services.DevicesService"),SpacesService:schema.getService("dxos.client.services.SpacesService"),DataService:schema.getService("dxos.echo.service.DataService"),FunctionRegistryService:schema.getService("dxos.agent.functions.FunctionRegistryService"),DevtoolsHost:schema.getService("dxos.devtools.host.DevtoolsHost"),TracingService:schema.getService("dxos.tracing.TracingService")}),iframeServiceBundle={BridgeService:schema.getService("dxos.mesh.bridge.BridgeService")},workerServiceBundle={WorkerService:schema.getService("dxos.iframe.WorkerService")},appServiceBundle={AppService:schema.getService("dxos.iframe.AppService")},shellServiceBundle={ShellService:schema.getService("dxos.iframe.ShellService")},PROXY_CONNECTION_TIMEOUT=3e4,AUTH_TIMEOUT=3e4,STATUS_TIMEOUT=1e4,RESOURCE_LOCK_TIMEOUT=3e3,CREATE_SPACE_TIMEOUT=5e3,LOAD_CONTROL_FEEDS_TIMEOUT=3e3,_Properties=Struct({name:optional(String$)},{key:String$,value:Any}).pipe(echoObject("dxos.sdk.client.Properties","0.1.0")),Properties=_Properties,queueMicrotask_1$1=typeof queueMicrotask=="function"?queueMicrotask:e=>Promise.resolve().then(e),fixedSize=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}};const FixedFIFO=fixedSize;var fastFifo=class{constructor(e){this.hwm=e||16,this.head=new FixedFIFO(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(e){if(this.length++,!this.head.push(e)){const t=this.head;this.head=t.next=new FixedFIFO(2*this.head.buffer.length),this.head.push(e)}}shift(){this.length!==0&&this.length--;const e=this.tail.shift();if(e===void 0&&this.tail.next){const t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}peek(){const e=this.tail.peek();return e===void 0&&this.tail.next?this.tail.next.peek():e}isEmpty(){return this.length===0}},browser$3={exports:{}};function byteLength$4(e){return e.length}function toString$9(e){const t=e.byteLength;let r="";for(let n=0;n<t;n++)r+=String.fromCharCode(e[n]);return r}function write$4(e,t,r=0,n=byteLength$4(t)){const o=Math.min(n,e.byteLength-r);for(let s=0;s<o;s++)e[r+s]=t.charCodeAt(s);return o}var ascii={byteLength:byteLength$4,toString:toString$9,write:write$4};const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",codes=new Uint8Array(256);for(let e=0;e<alphabet.length;e++)codes[alphabet.charCodeAt(e)]=e;codes[45]=62,codes[95]=63;function byteLength$3(e){let t=e.length;return e.charCodeAt(t-1)===61&&t--,t>1&&e.charCodeAt(t-1)===61&&t--,t*3>>>2}function toString$8(e){const t=e.byteLength;let r="";for(let n=0;n<t;n+=3)r+=alphabet[e[n]>>2]+alphabet[(e[n]&3)<<4|e[n+1]>>4]+alphabet[(e[n+1]&15)<<2|e[n+2]>>6]+alphabet[e[n+2]&63];return t%3===2?r=r.substring(0,r.length-1)+"=":t%3===1&&(r=r.substring(0,r.length-2)+"=="),r}function write$3(e,t,r=0,n=byteLength$3(t)){const o=Math.min(n,e.byteLength-r);for(let s=0,a=0;a<o;s+=4){const c=codes[t.charCodeAt(s)],l=codes[t.charCodeAt(s+1)],h=codes[t.charCodeAt(s+2)],u=codes[t.charCodeAt(s+3)];e[a++]=c<<2|l>>4,e[a++]=(l&15)<<4|h>>2,e[a++]=(h&3)<<6|u&63}return o}var base64={byteLength:byteLength$3,toString:toString$8,write:write$3};function byteLength$2(e){return e.length>>>1}function toString$7(e){const t=e.byteLength;e=new DataView(e.buffer,e.byteOffset,t);let r="",n=0;for(let o=t-t%4;n<o;n+=4)r+=e.getUint32(n).toString(16).padStart(8,"0");for(;n<t;n++)r+=e.getUint8(n).toString(16).padStart(2,"0");return r}function write$2(e,t,r=0,n=byteLength$2(t)){const o=Math.min(n,e.byteLength-r);for(let s=0;s<o;s++){const a=hexValue(t.charCodeAt(s*2)),c=hexValue(t.charCodeAt(s*2+1));if(a===void 0||c===void 0)return e.subarray(0,s);e[r+s]=a<<4|c}return o}var hex={byteLength:byteLength$2,toString:toString$7,write:write$2};function hexValue(e){if(e>=48&&e<=57)return e-48;if(e>=65&&e<=70)return e-65+10;if(e>=97&&e<=102)return e-97+10}function byteLength$1(e){let t=0;for(let r=0,n=e.length;r<n;r++){const o=e.charCodeAt(r);if(o>=55296&&o<=56319&&r+1<n){const s=e.charCodeAt(r+1);if(s>=56320&&s<=57343){t+=4,r++;continue}}o<=127?t+=1:o<=2047?t+=2:t+=3}return t}let toString$6;if(typeof TextDecoder<"u"){const e=new TextDecoder;toString$6=function(t){return e.decode(t)}}else toString$6=function(e){const t=e.byteLength;let r="",n=0;for(;n<t;){let o=e[n];if(o<=127){r+=String.fromCharCode(o),n++;continue}let s=0,a=0;if(o<=223?(s=1,a=o&31):o<=239?(s=2,a=o&15):o<=244&&(s=3,a=o&7),t-n-s>0){let c=0;for(;c<s;)o=e[n+c+1],a=a<<6|o&63,c+=1}else a=65533,s=t-n;r+=String.fromCodePoint(a),n+=s+1}return r};let write$1;if(typeof TextEncoder<"u"){const e=new TextEncoder;write$1=function(t,r,n=0,o=byteLength$1(r)){const s=Math.min(o,t.byteLength-n);return e.encodeInto(r,t.subarray(n,n+s)),s}}else write$1=function(e,t,r=0,n=byteLength$1(t)){const o=Math.min(n,e.byteLength-r);e=e.subarray(r,r+o);let s=0,a=0;for(;s<t.length;){const c=t.codePointAt(s);if(c<=127){e[a++]=c,s++;continue}let l=0,h=0;for(c<=2047?(l=6,h=192):c<=65535?(l=12,h=224):c<=2097151&&(l=18,h=240),e[a++]=h|c>>l,l-=6;l>=0;)e[a++]=128|c>>l&63,l-=6;s+=c>=65536?2:1}return o};var utf8={byteLength:byteLength$1,toString:toString$6,write:write$1};function byteLength(e){return e.length*2}function toString$5(e){const t=e.byteLength;let r="";for(let n=0;n<t-1;n+=2)r+=String.fromCharCode(e[n]+e[n+1]*256);return r}function write(e,t,r=0,n=byteLength(t)){const o=Math.min(n,e.byteLength-r);let s=o;for(let a=0;a<t.length&&!((s-=2)<0);++a){const c=t.charCodeAt(a),l=c>>8,h=c%256;e[r+a*2]=h,e[r+a*2+1]=l}return o}var utf16le={byteLength,toString:toString$5,write};(function(e,t){const r=ascii,n=base64,o=hex,s=utf8,a=utf16le,c=new Uint8Array(Uint16Array.of(255).buffer)[0]===255;function l(C){switch(C){case"ascii":return r;case"base64":return n;case"hex":return o;case"utf8":case"utf-8":case void 0:return s;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a;default:throw new Error(`Unknown encoding: ${C}`)}}function h(C){return C instanceof Uint8Array}function u(C){try{return l(C),!0}catch{return!1}}function d(C,$,j){const O=new Uint8Array(C);return $!==void 0&&t.fill(O,$,0,O.byteLength,j),O}function f(C){return new Uint8Array(C)}function _(C){return new Uint8Array(C)}function p(C,$){return l($).byteLength(C)}function y(C,$){if(C===$)return 0;const j=Math.min(C.byteLength,$.byteLength);C=new DataView(C.buffer,C.byteOffset,C.byteLength),$=new DataView($.buffer,$.byteOffset,$.byteLength);let O=0;for(let k=j-j%4;O<k;O+=4){const ue=C.getUint32(O,c),pe=$.getUint32(O,c);if(ue!==pe)break}for(;O<j;O++){const k=C.getUint8(O),ue=$.getUint8(O);if(k<ue)return-1;if(k>ue)return 1}return C.byteLength>$.byteLength?1:C.byteLength<$.byteLength?-1:0}function w(C,$){$===void 0&&($=C.reduce((k,ue)=>k+ue.byteLength,0));const j=new Uint8Array($);let O=0;for(const k of C){if(O+k.byteLength>j.byteLength){const ue=k.subarray(0,j.byteLength-O);return j.set(ue,O),j}j.set(k,O),O+=k.byteLength}return j}function E(C,$,j=0,O=0,k=C.byteLength){if(k>0&&k<O||k===O||C.byteLength===0||$.byteLength===0)return 0;if(j<0)throw new RangeError("targetStart is out of range");if(O<0||O>=C.byteLength)throw new RangeError("sourceStart is out of range");if(k<0)throw new RangeError("sourceEnd is out of range");j>=$.byteLength&&(j=$.byteLength),k>C.byteLength&&(k=C.byteLength),$.byteLength-j<k-O&&(k=$.length-j+O);const ue=k-O;return C===$?$.copyWithin(j,O,k):$.set(C.subarray(O,k),j),ue}function x(C,$){if(C===$)return!0;if(C.byteLength!==$.byteLength)return!1;const j=C.byteLength;C=new DataView(C.buffer,C.byteOffset,C.byteLength),$=new DataView($.buffer,$.byteOffset,$.byteLength);let O=0;for(let k=j-j%4;O<k;O+=4)if(C.getUint32(O,c)!==$.getUint32(O,c))return!1;for(;O<j;O++)if(C.getUint8(O)!==$.getUint8(O))return!1;return!0}function B(C,$,j,O,k){if(typeof $=="string"?typeof j=="string"?(k=j,j=0,O=C.byteLength):typeof O=="string"&&(k=O,O=C.byteLength):typeof $=="number"?$=$&255:typeof $=="boolean"&&($=+$),j<0||C.byteLength<j||C.byteLength<O)throw new RangeError("Out of range index");if(j===void 0&&(j=0),O===void 0&&(O=C.byteLength),O<=j)return C;if($||($=0),typeof $=="number")for(let ue=j;ue<O;++ue)C[ue]=$;else{$=h($)?$:P($,k);const ue=$.byteLength;for(let pe=0;pe<O-j;++pe)C[pe+j]=$[pe%ue]}return C}function P(C,$,j){return typeof C=="string"?U(C,$):Array.isArray(C)?F(C):ArrayBuffer.isView(C)?G(C):H(C,$,j)}function U(C,$){const j=l($),O=new Uint8Array(j.byteLength(C));return j.write(O,C,0,O.byteLength),O}function F(C){const $=new Uint8Array(C.length);return $.set(C),$}function G(C){const $=new Uint8Array(C.byteLength);return $.set(C),$}function H(C,$,j){return new Uint8Array(C,$,j)}function te(C,$,j,O){return le(C,$,j,O)!==-1}function J(C,$,j,O,k){if(C.byteLength===0)return-1;if(typeof j=="string"?(O=j,j=0):j===void 0?j=k?0:C.length-1:j<0&&(j+=C.byteLength),j>=C.byteLength){if(k)return-1;j=C.byteLength-1}else if(j<0)if(k)j=0;else return-1;if(typeof $=="string")$=P($,O);else if(typeof $=="number")return $=$&255,k?C.indexOf($,j):C.lastIndexOf($,j);if($.byteLength===0)return-1;if(k){let ue=-1;for(let pe=j;pe<C.byteLength;pe++)if(C[pe]===$[ue===-1?0:pe-ue]){if(ue===-1&&(ue=pe),pe-ue+1===$.byteLength)return ue}else ue!==-1&&(pe-=pe-ue),ue=-1}else{j+$.byteLength>C.byteLength&&(j=C.byteLength-$.byteLength);for(let ue=j;ue>=0;ue--){let pe=!0;for(let Oe=0;Oe<$.byteLength;Oe++)if(C[ue+Oe]!==$[Oe]){pe=!1;break}if(pe)return ue}}return-1}function le(C,$,j,O){return J(C,$,j,O,!0)}function z(C,$,j,O){return J(C,$,j,O,!1)}function q(C,$,j){const O=C[$];C[$]=C[j],C[j]=O}function he(C){const $=C.byteLength;if($%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let j=0;j<$;j+=2)q(C,j,j+1);return C}function V(C){const $=C.byteLength;if($%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let j=0;j<$;j+=4)q(C,j,j+3),q(C,j+1,j+2);return C}function _e(C){const $=C.byteLength;if($%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let j=0;j<$;j+=8)q(C,j,j+7),q(C,j+1,j+6),q(C,j+2,j+5),q(C,j+3,j+4);return C}function ee(C){return C}function W(C,$,j=0,O=C.byteLength){const k=C.byteLength;return j>=k||O<=j?"":(j<0&&(j=0),O>k&&(O=k),(j!==0||O<k)&&(C=C.subarray(j,O)),l($).toString(C))}function re(C,$,j,O,k){return j===void 0?k="utf8":O===void 0&&typeof j=="string"?(k=j,j=void 0):k===void 0&&typeof O=="string"&&(k=O,O=void 0),l(k).write(C,$,j,O)}function ne(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setFloat64(j,$,!0),j+8}function ge(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setFloat32(j,$,!0),j+4}function de(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setUint32(j,$,!0),j+4}function ye(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setInt32(j,$,!0),j+4}function Ce(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getFloat64($,!0)}function ke(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getFloat32($,!0)}function ae(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getUint32($,!0)}function Q(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getInt32($,!0)}e.exports=t={isBuffer:h,isEncoding:u,alloc:d,allocUnsafe:f,allocUnsafeSlow:_,byteLength:p,compare:y,concat:w,copy:E,equals:x,fill:B,from:P,includes:te,indexOf:le,lastIndexOf:z,swap16:he,swap32:V,swap64:_e,toBuffer:ee,toString:W,write:re,writeDoubleLE:ne,writeFloatLE:ge,writeUInt32LE:de,writeInt32LE:ye,readDoubleLE:Ce,readFloatLE:ke,readUInt32LE:ae,readInt32LE:Q}})(browser$3,browser$3.exports);var browserExports$2=browser$3.exports;const b4a$8=browserExports$2;var passThroughDecoder=class{constructor(e){this.encoding=e}decode(e){return b4a$8.toString(e,this.encoding)}flush(){return""}};const b4a$7=browserExports$2;var utf8Decoder=class{constructor(){this.codePoint=0,this.bytesSeen=0,this.bytesNeeded=0,this.lowerBoundary=128,this.upperBoundary=191}decode(e){if(this.bytesNeeded===0){let r=!0;for(let n=Math.max(0,e.byteLength-4),o=e.byteLength;n<o&&r;n++)r=e[n]<=127;if(r)return b4a$7.toString(e,"utf8")}let t="";for(let r=0,n=e.byteLength;r<n;r++){const o=e[r];if(this.bytesNeeded===0){o<=127?t+=String.fromCharCode(o):o>=194&&o<=223?(this.bytesNeeded=1,this.codePoint=o&31):o>=224&&o<=239?(o===224?this.lowerBoundary=160:o===237&&(this.upperBoundary=159),this.bytesNeeded=2,this.codePoint=o&15):o>=240&&o<=244?(o===240&&(this.lowerBoundary=144),o===244&&(this.upperBoundary=143),this.bytesNeeded=3,this.codePoint=o&7):t+="\uFFFD";continue}if(o<this.lowerBoundary||o>this.upperBoundary){this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,t+="\uFFFD";continue}this.lowerBoundary=128,this.upperBoundary=191,this.codePoint=this.codePoint<<6|o&63,this.bytesSeen++,this.bytesSeen===this.bytesNeeded&&(t+=String.fromCodePoint(this.codePoint),this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0)}return t}flush(){const e=this.bytesNeeded>0?"\uFFFD":"";return this.codePoint=0,this.bytesNeeded=0,this.bytesSeen=0,this.lowerBoundary=128,this.upperBoundary=191,e}};const PassThroughDecoder=passThroughDecoder,UTF8Decoder=utf8Decoder;var textDecoder$1=class{constructor(e="utf8"){switch(this.encoding=normalizeEncoding(e),this.encoding){case"utf8":this.decoder=new UTF8Decoder;break;case"utf16le":case"base64":throw new Error("Unsupported encoding: "+this.encoding);default:this.decoder=new PassThroughDecoder(this.encoding)}}push(e){return typeof e=="string"?e:this.decoder.decode(e)}write(e){return this.push(e)}end(e){let t="";return e&&(t=this.push(e)),t+=this.decoder.flush(),t}};function normalizeEncoding(e){switch(e=e.toLowerCase(),e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:throw new Error("Unknown encoding: "+e)}}const{EventEmitter:EventEmitter$1}=eventsExports,STREAM_DESTROYED=new Error("Stream was destroyed"),PREMATURE_CLOSE=new Error("Premature close"),queueTick$1=queueMicrotask_1$1,FIFO=fastFifo,TextDecoder$1=textDecoder$1,MAX=(1<<29)-1,OPENING=1,PREDESTROYING=2,DESTROYING=4,DESTROYED=8,NOT_OPENING=MAX^OPENING,NOT_PREDESTROYING=MAX^PREDESTROYING,READ_ACTIVE=16,READ_UPDATING=32,READ_PRIMARY=64,READ_QUEUED=128,READ_RESUMED=256,READ_PIPE_DRAINED=512,READ_ENDING=1024,READ_EMIT_DATA=2048,READ_EMIT_READABLE=4096,READ_EMITTED_READABLE=8192,READ_DONE=16384,READ_NEXT_TICK=32768,READ_NEEDS_PUSH=65536,READ_READ_AHEAD=131072,READ_FLOWING=READ_RESUMED|READ_PIPE_DRAINED,READ_ACTIVE_AND_NEEDS_PUSH=READ_ACTIVE|READ_NEEDS_PUSH,READ_PRIMARY_AND_ACTIVE=READ_PRIMARY|READ_ACTIVE,READ_EMIT_READABLE_AND_QUEUED=READ_EMIT_READABLE|READ_QUEUED,READ_RESUMED_READ_AHEAD=READ_RESUMED|READ_READ_AHEAD,READ_NOT_ACTIVE=MAX^READ_ACTIVE,READ_NON_PRIMARY=MAX^READ_PRIMARY,READ_NON_PRIMARY_AND_PUSHED=MAX^(READ_PRIMARY|READ_NEEDS_PUSH),READ_PUSHED=MAX^READ_NEEDS_PUSH,READ_PAUSED=MAX^READ_RESUMED,READ_NOT_QUEUED=MAX^(READ_QUEUED|READ_EMITTED_READABLE),READ_NOT_ENDING=MAX^READ_ENDING,READ_PIPE_NOT_DRAINED=MAX^READ_FLOWING,READ_NOT_NEXT_TICK=MAX^READ_NEXT_TICK,READ_NOT_UPDATING=MAX^READ_UPDATING,READ_NO_READ_AHEAD=MAX^READ_READ_AHEAD,READ_PAUSED_NO_READ_AHEAD=MAX^READ_RESUMED_READ_AHEAD,WRITE_ACTIVE=1<<18,WRITE_UPDATING=2<<18,WRITE_PRIMARY=4<<18,WRITE_QUEUED=8<<18,WRITE_UNDRAINED=16<<18,WRITE_DONE=32<<18,WRITE_EMIT_DRAIN=64<<18,WRITE_NEXT_TICK=128<<18,WRITE_WRITING=256<<18,WRITE_FINISHING=512<<18,WRITE_CORKED=1024<<18,WRITE_NOT_ACTIVE=MAX^(WRITE_ACTIVE|WRITE_WRITING),WRITE_NON_PRIMARY=MAX^WRITE_PRIMARY,WRITE_NOT_FINISHING=MAX^WRITE_FINISHING,WRITE_DRAINED=MAX^WRITE_UNDRAINED,WRITE_NOT_QUEUED=MAX^WRITE_QUEUED,WRITE_NOT_NEXT_TICK=MAX^WRITE_NEXT_TICK,WRITE_NOT_UPDATING=MAX^WRITE_UPDATING,WRITE_NOT_CORKED=MAX^WRITE_CORKED,ACTIVE=READ_ACTIVE|WRITE_ACTIVE,NOT_ACTIVE=MAX^ACTIVE,DONE=READ_DONE|WRITE_DONE,DESTROY_STATUS=DESTROYING|DESTROYED|PREDESTROYING,OPEN_STATUS=DESTROY_STATUS|OPENING,AUTO_DESTROY=DESTROY_STATUS|DONE,NON_PRIMARY=WRITE_NON_PRIMARY&READ_NON_PRIMARY,ACTIVE_OR_TICKING=WRITE_NEXT_TICK|READ_NEXT_TICK,TICKING=ACTIVE_OR_TICKING&NOT_ACTIVE,IS_OPENING=OPEN_STATUS|TICKING,READ_PRIMARY_STATUS=OPEN_STATUS|READ_ENDING|READ_DONE,READ_STATUS=OPEN_STATUS|READ_DONE|READ_QUEUED,READ_ENDING_STATUS=OPEN_STATUS|READ_ENDING|READ_QUEUED,READ_READABLE_STATUS=OPEN_STATUS|READ_EMIT_READABLE|READ_QUEUED|READ_EMITTED_READABLE,SHOULD_NOT_READ=OPEN_STATUS|READ_ACTIVE|READ_ENDING|READ_DONE|READ_NEEDS_PUSH|READ_READ_AHEAD,READ_BACKPRESSURE_STATUS=DESTROY_STATUS|READ_ENDING|READ_DONE,READ_UPDATE_SYNC_STATUS=READ_UPDATING|OPEN_STATUS|READ_NEXT_TICK|READ_PRIMARY,WRITE_PRIMARY_STATUS=OPEN_STATUS|WRITE_FINISHING|WRITE_DONE,WRITE_QUEUED_AND_UNDRAINED=WRITE_QUEUED|WRITE_UNDRAINED,WRITE_QUEUED_AND_ACTIVE=WRITE_QUEUED|WRITE_ACTIVE,WRITE_DRAIN_STATUS=WRITE_QUEUED|WRITE_UNDRAINED|OPEN_STATUS|WRITE_ACTIVE,WRITE_STATUS=OPEN_STATUS|WRITE_ACTIVE|WRITE_QUEUED|WRITE_CORKED,WRITE_PRIMARY_AND_ACTIVE=WRITE_PRIMARY|WRITE_ACTIVE,WRITE_ACTIVE_AND_WRITING=WRITE_ACTIVE|WRITE_WRITING,WRITE_FINISHING_STATUS=OPEN_STATUS|WRITE_FINISHING|WRITE_QUEUED_AND_ACTIVE|WRITE_DONE,WRITE_BACKPRESSURE_STATUS=WRITE_UNDRAINED|DESTROY_STATUS|WRITE_FINISHING|WRITE_DONE,WRITE_UPDATE_SYNC_STATUS=WRITE_UPDATING|OPEN_STATUS|WRITE_NEXT_TICK|WRITE_PRIMARY,asyncIterator=Symbol.asyncIterator||Symbol("asyncIterator");class WritableState{constructor(t,{highWaterMark:r=16384,map:n=null,mapWritable:o,byteLength:s,byteLengthWritable:a}={}){this.stream=t,this.queue=new FIFO,this.highWaterMark=r,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=a||s||defaultByteLength,this.map=o||n,this.afterWrite=afterWrite.bind(this),this.afterUpdateNextTick=updateWriteNT.bind(this)}get ended(){return(this.stream._duplexState&WRITE_DONE)!==0}push(t){return this.map!==null&&(t=this.map(t)),this.buffered+=this.byteLength(t),this.queue.push(t),this.buffered<this.highWaterMark?(this.stream._duplexState|=WRITE_QUEUED,!0):(this.stream._duplexState|=WRITE_QUEUED_AND_UNDRAINED,!1)}shift(){const t=this.queue.shift();return this.buffered-=this.byteLength(t),this.buffered===0&&(this.stream._duplexState&=WRITE_NOT_QUEUED),t}end(t){typeof t=="function"?this.stream.once("finish",t):t!=null&&this.push(t),this.stream._duplexState=(this.stream._duplexState|WRITE_FINISHING)&WRITE_NON_PRIMARY}autoBatch(t,r){const n=[],o=this.stream;for(n.push(t);(o._duplexState&WRITE_STATUS)===WRITE_QUEUED_AND_ACTIVE;)n.push(o._writableState.shift());if(o._duplexState&OPEN_STATUS)return r(null);o._writev(n,r)}update(){const t=this.stream;t._duplexState|=WRITE_UPDATING;do{for(;(t._duplexState&WRITE_STATUS)===WRITE_QUEUED;){const r=this.shift();t._duplexState|=WRITE_ACTIVE_AND_WRITING,t._write(r,this.afterWrite)}t._duplexState&WRITE_PRIMARY_AND_ACTIVE||this.updateNonPrimary()}while(this.continueUpdate()===!0);t._duplexState&=WRITE_NOT_UPDATING}updateNonPrimary(){const t=this.stream;if((t._duplexState&WRITE_FINISHING_STATUS)===WRITE_FINISHING){t._duplexState=(t._duplexState|WRITE_ACTIVE)&WRITE_NOT_FINISHING,t._final(afterFinal.bind(this));return}if((t._duplexState&DESTROY_STATUS)===DESTROYING){t._duplexState&ACTIVE_OR_TICKING||(t._duplexState|=ACTIVE,t._destroy(afterDestroy.bind(this)));return}(t._duplexState&IS_OPENING)===OPENING&&(t._duplexState=(t._duplexState|ACTIVE)&NOT_OPENING,t._open(afterOpen.bind(this)))}continueUpdate(){return this.stream._duplexState&WRITE_NEXT_TICK?(this.stream._duplexState&=WRITE_NOT_NEXT_TICK,!0):!1}updateCallback(){(this.stream._duplexState&WRITE_UPDATE_SYNC_STATUS)===WRITE_PRIMARY?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&WRITE_NEXT_TICK||(this.stream._duplexState|=WRITE_NEXT_TICK,this.stream._duplexState&WRITE_UPDATING||queueTick$1(this.afterUpdateNextTick))}}class ReadableState{constructor(t,{highWaterMark:r=16384,map:n=null,mapReadable:o,byteLength:s,byteLengthReadable:a}={}){this.stream=t,this.queue=new FIFO,this.highWaterMark=r===0?1:r,this.buffered=0,this.readAhead=r>0,this.error=null,this.pipeline=null,this.byteLength=a||s||defaultByteLength,this.map=o||n,this.pipeTo=null,this.afterRead=afterRead.bind(this),this.afterUpdateNextTick=updateReadNT.bind(this)}get ended(){return(this.stream._duplexState&READ_DONE)!==0}pipe(t,r){if(this.pipeTo!==null)throw new Error("Can only pipe to one destination");if(typeof r!="function"&&(r=null),this.stream._duplexState|=READ_PIPE_DRAINED,this.pipeTo=t,this.pipeline=new Pipeline$1(this.stream,t,r),r&&this.stream.on("error",noop$6),isStreamx(t))t._writableState.pipeline=this.pipeline,r&&t.on("error",noop$6),t.on("finish",this.pipeline.finished.bind(this.pipeline));else{const n=this.pipeline.done.bind(this.pipeline,t),o=this.pipeline.done.bind(this.pipeline,t,null);t.on("error",n),t.on("close",o),t.on("finish",this.pipeline.finished.bind(this.pipeline))}t.on("drain",afterDrain.bind(this)),this.stream.emit("piping",t),t.emit("pipe",this.stream)}push(t){const r=this.stream;return t===null?(this.highWaterMark=0,r._duplexState=(r._duplexState|READ_ENDING)&READ_NON_PRIMARY_AND_PUSHED,!1):this.map!==null&&(t=this.map(t),t===null)?this.buffered<this.highWaterMark:(this.buffered+=this.byteLength(t),this.queue.push(t),r._duplexState=(r._duplexState|READ_QUEUED)&READ_PUSHED,this.buffered<this.highWaterMark)}shift(){const t=this.queue.shift();return this.buffered-=this.byteLength(t),this.buffered===0&&(this.stream._duplexState&=READ_NOT_QUEUED),t}unshift(t){const r=[this.map!==null?this.map(t):t];for(;this.buffered>0;)r.push(this.shift());for(let n=0;n<r.length-1;n++){const o=r[n];this.buffered+=this.byteLength(o),this.queue.push(o)}this.push(r[r.length-1])}read(){const t=this.stream;if((t._duplexState&READ_STATUS)===READ_QUEUED){const r=this.shift();return this.pipeTo!==null&&this.pipeTo.write(r)===!1&&(t._duplexState&=READ_PIPE_NOT_DRAINED),t._duplexState&READ_EMIT_DATA&&t.emit("data",r),r}return this.readAhead===!1&&(t._duplexState|=READ_READ_AHEAD,this.updateNextTick()),null}drain(){const t=this.stream;for(;(t._duplexState&READ_STATUS)===READ_QUEUED&&t._duplexState&READ_FLOWING;){const r=this.shift();this.pipeTo!==null&&this.pipeTo.write(r)===!1&&(t._duplexState&=READ_PIPE_NOT_DRAINED),t._duplexState&READ_EMIT_DATA&&t.emit("data",r)}}update(){const t=this.stream;t._duplexState|=READ_UPDATING;do{for(this.drain();this.buffered<this.highWaterMark&&(t._duplexState&SHOULD_NOT_READ)===READ_READ_AHEAD;)t._duplexState|=READ_ACTIVE_AND_NEEDS_PUSH,t._read(this.afterRead),this.drain();(t._duplexState&READ_READABLE_STATUS)===READ_EMIT_READABLE_AND_QUEUED&&(t._duplexState|=READ_EMITTED_READABLE,t.emit("readable")),t._duplexState&READ_PRIMARY_AND_ACTIVE||this.updateNonPrimary()}while(this.continueUpdate()===!0);t._duplexState&=READ_NOT_UPDATING}updateNonPrimary(){const t=this.stream;if((t._duplexState&READ_ENDING_STATUS)===READ_ENDING&&(t._duplexState=(t._duplexState|READ_DONE)&READ_NOT_ENDING,t.emit("end"),(t._duplexState&AUTO_DESTROY)===DONE&&(t._duplexState|=DESTROYING),this.pipeTo!==null&&this.pipeTo.end()),(t._duplexState&DESTROY_STATUS)===DESTROYING){t._duplexState&ACTIVE_OR_TICKING||(t._duplexState|=ACTIVE,t._destroy(afterDestroy.bind(this)));return}(t._duplexState&IS_OPENING)===OPENING&&(t._duplexState=(t._duplexState|ACTIVE)&NOT_OPENING,t._open(afterOpen.bind(this)))}continueUpdate(){return this.stream._duplexState&READ_NEXT_TICK?(this.stream._duplexState&=READ_NOT_NEXT_TICK,!0):!1}updateCallback(){(this.stream._duplexState&READ_UPDATE_SYNC_STATUS)===READ_PRIMARY?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&READ_NEXT_TICK||(this.stream._duplexState|=READ_NEXT_TICK,this.stream._duplexState&READ_UPDATING||queueTick$1(this.afterUpdateNextTick))}}class TransformState{constructor(t){this.data=null,this.afterTransform=afterTransform.bind(t),this.afterFinal=null}}let Pipeline$1=class{constructor(e,t,r){this.from=e,this.to=t,this.afterPipe=r,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(e,t){if(t&&(this.error=t),e===this.to&&(this.to=null,this.from!==null)){(!(this.from._duplexState&READ_DONE)||!this.pipeToFinished)&&this.from.destroy(this.error||new Error("Writable stream closed prematurely"));return}if(e===this.from&&(this.from=null,this.to!==null)){e._duplexState&READ_DONE||this.to.destroy(this.error||new Error("Readable stream closed before ending"));return}this.afterPipe!==null&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null}};function afterDrain(){this.stream._duplexState|=READ_PIPE_DRAINED,this.updateCallback()}function afterFinal(e){const t=this.stream;e&&t.destroy(e),t._duplexState&DESTROY_STATUS||(t._duplexState|=WRITE_DONE,t.emit("finish")),(t._duplexState&AUTO_DESTROY)===DONE&&(t._duplexState|=DESTROYING),t._duplexState&=WRITE_NOT_ACTIVE,t._duplexState&WRITE_UPDATING?this.updateNextTick():this.update()}function afterDestroy(e){const t=this.stream;!e&&this.error!==STREAM_DESTROYED&&(e=this.error),e&&t.emit("error",e),t._duplexState|=DESTROYED,t.emit("close");const r=t._readableState,n=t._writableState;if(r!==null&&r.pipeline!==null&&r.pipeline.done(t,e),n!==null){for(;n.drains!==null&&n.drains.length>0;)n.drains.shift().resolve(!1);n.pipeline!==null&&n.pipeline.done(t,e)}}function afterWrite(e){const t=this.stream;e&&t.destroy(e),t._duplexState&=WRITE_NOT_ACTIVE,this.drains!==null&&tickDrains(this.drains),(t._duplexState&WRITE_DRAIN_STATUS)===WRITE_UNDRAINED&&(t._duplexState&=WRITE_DRAINED,(t._duplexState&WRITE_EMIT_DRAIN)===WRITE_EMIT_DRAIN&&t.emit("drain")),this.updateCallback()}function afterRead(e){e&&this.stream.destroy(e),this.stream._duplexState&=READ_NOT_ACTIVE,this.readAhead===!1&&!(this.stream._duplexState&READ_RESUMED)&&(this.stream._duplexState&=READ_NO_READ_AHEAD),this.updateCallback()}function updateReadNT(){this.stream._duplexState&READ_UPDATING||(this.stream._duplexState&=READ_NOT_NEXT_TICK,this.update())}function updateWriteNT(){this.stream._duplexState&WRITE_UPDATING||(this.stream._duplexState&=WRITE_NOT_NEXT_TICK,this.update())}function tickDrains(e){for(let t=0;t<e.length;t++)--e[t].writes===0&&(e.shift().resolve(!0),t--)}function afterOpen(e){const t=this.stream;e&&t.destroy(e),t._duplexState&DESTROYING||(t._duplexState&READ_PRIMARY_STATUS||(t._duplexState|=READ_PRIMARY),t._duplexState&WRITE_PRIMARY_STATUS||(t._duplexState|=WRITE_PRIMARY),t.emit("open")),t._duplexState&=NOT_ACTIVE,t._writableState!==null&&t._writableState.updateCallback(),t._readableState!==null&&t._readableState.updateCallback()}function afterTransform(e,t){t!=null&&this.push(t),this._writableState.afterWrite(e)}function newListener(e){this._readableState!==null&&(e==="data"&&(this._duplexState|=READ_EMIT_DATA|READ_RESUMED_READ_AHEAD,this._readableState.updateNextTick()),e==="readable"&&(this._duplexState|=READ_EMIT_READABLE,this._readableState.updateNextTick())),this._writableState!==null&&e==="drain"&&(this._duplexState|=WRITE_EMIT_DRAIN,this._writableState.updateNextTick())}let Stream$1=class extends EventEmitter$1{constructor(e){super(),this._duplexState=0,this._readableState=null,this._writableState=null,e&&(e.open&&(this._open=e.open),e.destroy&&(this._destroy=e.destroy),e.predestroy&&(this._predestroy=e.predestroy),e.signal&&e.signal.addEventListener("abort",abort.bind(this))),this.on("newListener",newListener)}_open(e){e(null)}_destroy(e){e(null)}_predestroy(){}get readable(){return this._readableState!==null?!0:void 0}get writable(){return this._writableState!==null?!0:void 0}get destroyed(){return(this._duplexState&DESTROYED)!==0}get destroying(){return(this._duplexState&DESTROY_STATUS)!==0}destroy(e){this._duplexState&DESTROY_STATUS||(e||(e=STREAM_DESTROYED),this._duplexState=(this._duplexState|DESTROYING)&NON_PRIMARY,this._readableState!==null&&(this._readableState.highWaterMark=0,this._readableState.error=e),this._writableState!==null&&(this._writableState.highWaterMark=0,this._writableState.error=e),this._duplexState|=PREDESTROYING,this._predestroy(),this._duplexState&=NOT_PREDESTROYING,this._readableState!==null&&this._readableState.updateNextTick(),this._writableState!==null&&this._writableState.updateNextTick())}};class Readable extends Stream$1{constructor(t){super(t),this._duplexState|=OPENING|WRITE_DONE|READ_READ_AHEAD,this._readableState=new ReadableState(this,t),t&&(this._readableState.readAhead===!1&&(this._duplexState&=READ_NO_READ_AHEAD),t.read&&(this._read=t.read),t.eagerOpen&&this._readableState.updateNextTick(),t.encoding&&this.setEncoding(t.encoding))}setEncoding(t){const r=new TextDecoder$1(t),n=this._readableState.map||echo;return this._readableState.map=o,this;function o(s){const a=r.push(s);return a===""?null:n(a)}}_read(t){t(null)}pipe(t,r){return this._readableState.updateNextTick(),this._readableState.pipe(t,r),t}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(t){return this._readableState.updateNextTick(),this._readableState.push(t)}unshift(t){return this._readableState.updateNextTick(),this._readableState.unshift(t)}resume(){return this._duplexState|=READ_RESUMED_READ_AHEAD,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=this._readableState.readAhead===!1?READ_PAUSED_NO_READ_AHEAD:READ_PAUSED,this}static _fromAsyncIterator(t,r){let n;const o=new Readable({...r,read(a){t.next().then(s).then(a.bind(null,null)).catch(a)},predestroy(){n=t.return()},destroy(a){if(!n)return a(null);n.then(a.bind(null,null)).catch(a)}});return o;function s(a){a.done?o.push(null):o.push(a.value)}}static from(t,r){if(isReadStreamx(t))return t;if(t[asyncIterator])return this._fromAsyncIterator(t[asyncIterator](),r);Array.isArray(t)||(t=t===void 0?[]:[t]);let n=0;return new Readable({...r,read(o){this.push(n===t.length?null:t[n++]),o(null)}})}static isBackpressured(t){return(t._duplexState&READ_BACKPRESSURE_STATUS)!==0||t._readableState.buffered>=t._readableState.highWaterMark}static isPaused(t){return(t._duplexState&READ_RESUMED)===0}[asyncIterator](){const t=this;let r=null,n=null,o=null;return this.on("error",h=>{r=h}),this.on("readable",s),this.on("close",a),{[asyncIterator](){return this},next(){return new Promise(function(h,u){n=h,o=u;const d=t.read();d!==null?c(d):t._duplexState&DESTROYED&&c(null)})},return(){return l(null)},throw(h){return l(h)}};function s(){n!==null&&c(t.read())}function a(){n!==null&&c(null)}function c(h){o!==null&&(r?o(r):h===null&&!(t._duplexState&READ_DONE)?o(STREAM_DESTROYED):n({value:h,done:h===null}),o=n=null)}function l(h){return t.destroy(h),new Promise((u,d)=>{if(t._duplexState&DESTROYED)return u({value:void 0,done:!0});t.once("close",function(){h?d(h):u({value:void 0,done:!0})})})}}}class Writable extends Stream$1{constructor(t){super(t),this._duplexState|=OPENING|READ_DONE,this._writableState=new WritableState(this,t),t&&(t.writev&&(this._writev=t.writev),t.write&&(this._write=t.write),t.final&&(this._final=t.final),t.eagerOpen&&this._writableState.updateNextTick())}cork(){this._duplexState|=WRITE_CORKED}uncork(){this._duplexState&=WRITE_NOT_CORKED,this._writableState.updateNextTick()}_writev(t,r){r(null)}_write(t,r){this._writableState.autoBatch(t,r)}_final(t){t(null)}static isBackpressured(t){return(t._duplexState&WRITE_BACKPRESSURE_STATUS)!==0}static drained(t){if(t.destroyed)return Promise.resolve(!1);const r=t._writableState,n=(isWritev(t)?Math.min(1,r.queue.length):r.queue.length)+(t._duplexState&WRITE_WRITING?1:0);return n===0?Promise.resolve(!0):(r.drains===null&&(r.drains=[]),new Promise(o=>{r.drains.push({writes:n,resolve:o})}))}write(t){return this._writableState.updateNextTick(),this._writableState.push(t)}end(t){return this._writableState.updateNextTick(),this._writableState.end(t),this}}class Duplex extends Readable{constructor(t){super(t),this._duplexState=OPENING|this._duplexState&READ_READ_AHEAD,this._writableState=new WritableState(this,t),t&&(t.writev&&(this._writev=t.writev),t.write&&(this._write=t.write),t.final&&(this._final=t.final))}cork(){this._duplexState|=WRITE_CORKED}uncork(){this._duplexState&=WRITE_NOT_CORKED,this._writableState.updateNextTick()}_writev(t,r){r(null)}_write(t,r){this._writableState.autoBatch(t,r)}_final(t){t(null)}write(t){return this._writableState.updateNextTick(),this._writableState.push(t)}end(t){return this._writableState.updateNextTick(),this._writableState.end(t),this}}class Transform extends Duplex{constructor(t){super(t),this._transformState=new TransformState(this),t&&(t.transform&&(this._transform=t.transform),t.flush&&(this._flush=t.flush))}_write(t,r){this._readableState.buffered>=this._readableState.highWaterMark?this._transformState.data=t:this._transform(t,this._transformState.afterTransform)}_read(t){if(this._transformState.data!==null){const r=this._transformState.data;this._transformState.data=null,t(null),this._transform(r,this._transformState.afterTransform)}else t(null)}destroy(t){super.destroy(t),this._transformState.data!==null&&(this._transformState.data=null,this._transformState.afterTransform())}_transform(t,r){r(null,t)}_flush(t){t(null)}_final(t){this._transformState.afterFinal=t,this._flush(transformAfterFlush.bind(this))}}class PassThrough extends Transform{}function transformAfterFlush(e,t){const r=this._transformState.afterFinal;if(e)return r(e);t!=null&&this.push(t),this.push(null),r(null)}function pipelinePromise(...e){return new Promise((t,r)=>pipeline(...e,n=>{if(n)return r(n);t()}))}function pipeline(e,...t){const r=Array.isArray(e)?[...e,...t]:[e,...t],n=r.length&&typeof r[r.length-1]=="function"?r.pop():null;if(r.length<2)throw new Error("Pipeline requires at least 2 streams");let o=r[0],s=null,a=null;for(let h=1;h<r.length;h++)s=r[h],isStreamx(o)?o.pipe(s,l):(c(o,!0,h>1,l),o.pipe(s)),o=s;if(n){let h=!1;const u=isStreamx(s)||!!(s._writableState&&s._writableState.autoDestroy);s.on("error",d=>{a===null&&(a=d)}),s.on("finish",()=>{h=!0,u||n(a)}),u&&s.on("close",()=>n(a||(h?null:PREMATURE_CLOSE)))}return s;function c(h,u,d,f){h.on("error",f),h.on("close",_);function _(){if(h._readableState&&!h._readableState.ended||d&&h._writableState&&!h._writableState.ended)return f(PREMATURE_CLOSE)}}function l(h){if(!(!h||a)){a=h;for(const u of r)u.destroy(h)}}}function echo(e){return e}function isStream(e){return!!e._readableState||!!e._writableState}function isStreamx(e){return typeof e._duplexState=="number"&&isStream(e)}function getStreamError(e){const t=e._readableState&&e._readableState.error||e._writableState&&e._writableState.error;return t===STREAM_DESTROYED?null:t}function isReadStreamx(e){return isStreamx(e)&&e.readable}function isTypedArray(e){return typeof e=="object"&&e!==null&&typeof e.byteLength=="number"}function defaultByteLength(e){return isTypedArray(e)?e.byteLength:1024}function noop$6(){}function abort(){this.destroy(new Error("Stream aborted."))}function isWritev(e){return e._writev!==Writable.prototype._writev&&e._writev!==Duplex.prototype._writev}var streamx={pipeline,pipelinePromise,isStream,isStreamx,getStreamError,Stream:Stream$1,Writable,Readable,Duplex,Transform,PassThrough};const index$3=getDefaultExportFromCjs(streamx),import$streamx=_mergeNamespaces({__proto__:null,default:index$3},[streamx]);var hypercoreCrypto={},sodiumJavascript={exports:{}};function commonjsRequire(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var randombytes$3={exports:{}},nanoassert=assert$l;class AssertionError extends Error{}AssertionError.prototype.name="AssertionError";function assert$l(e,t){if(!e){var r=new AssertionError(t);throw Error.captureStackTrace&&Error.captureStackTrace(r,assert$l),r}}(function(e){var t=nanoassert,r=function(){var n=65536,o=globalThis.crypto||globalThis.msCrypto;function s(l,h){for(let u=0;u<h;u+=n)o.getRandomValues(new Uint8Array(l.buffer,u+l.byteOffset,Math.min(h-u,n)))}function a(l,h){new Uint8Array(l.buffer,l.byteOffset,h).set(o.randomBytes(h))}function c(){throw new Error("No secure random number generator available")}return o&&o.getRandomValues?s:commonjsRequire!=null&&(o=commonjsRequire("crypto"),o&&o.randomBytes)?a:c}();Object.defineProperty(e.exports,"randombytes",{value:r}),e.exports.randombytes_buf=function(n){t(n,"out must be given"),r(n,n.byteLength)}})(randombytes$3);var randombytesExports=randombytes$3.exports;function sodium_malloc(e){return new Uint8Array(e)}function sodium_free(e){sodium_memzero(e),loadSink().port1.postMessage(e.buffer,[e.buffer])}function sodium_memzero(e){e.fill(0)}var sink;function loadSink(){if(sink)return sink;var e=globalThis.MessageChannel;return e==null&&({MessageChannel:e}=commonjsRequire("worker_threads")),sink=new e,sink}var memory$4={sodium_malloc,sodium_free,sodium_memzero},crypto_verify={exports:{}};(function(e){e.exports={crypto_verify_16:r,crypto_verify_32:n,crypto_verify_64:o};function t(s,a,c,l,h){var u=0;for(let d=0;d<h;d++)u|=s[a+d]^c[l+d];return(1&u-1>>>8)-1}Object.defineProperty(e.exports,"vn",{value:t});function r(s,a,c,l){return t(s,a,c,l,16)===0}function n(s,a,c,l){return t(s,a,c,l,32)===0}function o(s,a,c,l){return t(s,a,c,l,64)===0}})(crypto_verify);var crypto_verifyExports=crypto_verify.exports;const assert$k=nanoassert,{vn}=crypto_verifyExports;function sodium_increment$1(e){const t=e.byteLength;for(var r=1,n=0;n<t;n++)r+=e[n],e[n]=r,r>>=8}function sodium_memcmp$1(e,t){return assert$k(e.byteLength===t.byteLength,"buffers must be the same size"),vn(e,0,t,0,e.byteLength)===0}function sodium_is_zero$1(e){var t=0;for(let r=0;r<e.length;r++)t|=e[r];return t===0}var helpers$2={sodium_increment:sodium_increment$1,sodium_memcmp:sodium_memcmp$1,sodium_is_zero:sodium_is_zero$1},sha512Universal={exports:{}};const assert$j=nanoassert,b4a$6=browserExports$2;var sha512$2=Sha512$2;const BLOCKSIZE$3=128;var K$1=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Sha512$2(){return this instanceof Sha512$2?(this.hh=new Int32Array(8),this.hl=new Int32Array(8),this.buffer=new Uint8Array(128),this.finalised=!1,this.bytesRead=0,this.pos=0,this.hh[0]=1779033703,this.hh[1]=3144134277,this.hh[2]=1013904242,this.hh[3]=2773480762,this.hh[4]=1359893119,this.hh[5]=2600822924,this.hh[6]=528734635,this.hh[7]=1541459225,this.hl[0]=4089235720,this.hl[1]=2227873595,this.hl[2]=4271175723,this.hl[3]=1595750129,this.hl[4]=2917565137,this.hl[5]=725511199,this.hl[6]=4215389547,this.hl[7]=327033209,this):new Sha512$2}Sha512$2.prototype.update=function(e,t){assert$j(this.finalised===!1,"Hash instance finalised");var[r,n]=formatInput$3(e,t);this.bytesRead+=n;const o=n+this.pos&-128;this.buffer.set(r.subarray(0,BLOCKSIZE$3-this.pos),this.pos);const s=this.pos;return n-=BLOCKSIZE$3-this.pos,n>=0&&(compress$1(this.hh,this.hl,this.buffer,128),this.pos=0),n>127&&(compress$1(this.hh,this.hl,r.subarray(BLOCKSIZE$3-s,o-s),o-BLOCKSIZE$3),n%=128),this.buffer.set(r.subarray(r.byteLength-n)),this.pos=this.bytesRead&127,this.buffer.fill(0,this.pos),this},Sha512$2.prototype.digest=function(e,t=0){if(assert$j(this.finalised===!1,"Hash instance finalised"),this.finalised=!0,this.buffer.fill(0,this.pos),this.buffer[this.pos]=128,this.pos>111&&(compress$1(this.hh,this.hl,this.buffer,128),this.buffer.fill(0),this.pos=0),ts64(this.buffer,120,this.bytesRead/536870912|0,this.bytesRead<<3),compress$1(this.hh,this.hl,this.buffer,128),e instanceof Uint8Array&&e.byteLength>63){for(let n=0;n<8;n++)ts64(e,8*n+t,this.hh[n],this.hl[n]);return e}const r=new Uint8Array(64);for(let n=0;n<8;n++)ts64(r,8*n,this.hh[n],this.hl[n]);return typeof e=="string"?b4a$6.toString(r,e):r};function ts64(e,t,r,n){e[t]=r>>24&255,e[t+1]=r>>16&255,e[t+2]=r>>8&255,e[t+3]=r&255,e[t+4]=n>>24&255,e[t+5]=n>>16&255,e[t+6]=n>>8&255,e[t+7]=n&255}function formatInput$3(e,t){var r=b4a$6.from(e,t);return[r,r.byteLength]}function compress$1(e,t,r,n){for(var o=new Int32Array(16),s=new Int32Array(16),a,c,l,h,u,d,f,_,p,y,w,E,x,B,P,U,F,G,H,te,J,le,z,q,he,V,_e=e[0],ee=e[1],W=e[2],re=e[3],ne=e[4],ge=e[5],de=e[6],ye=e[7],Ce=t[0],ke=t[1],ae=t[2],Q=t[3],C=t[4],$=t[5],j=t[6],O=t[7],k=0;n>=128;){for(H=0;H<16;H++)te=8*H+k,o[H]=r[te+0]<<24|r[te+1]<<16|r[te+2]<<8|r[te+3],s[H]=r[te+4]<<24|r[te+5]<<16|r[te+6]<<8|r[te+7];for(H=0;H<80;H++)if(a=_e,c=ee,l=W,h=re,u=ne,d=ge,f=de,_=ye,p=Ce,y=ke,w=ae,E=Q,x=C,B=$,P=j,U=O,J=ye,le=O,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=(ne>>>14|C<<18)^(ne>>>18|C<<14)^(C>>>9|ne<<23),le=(C>>>14|ne<<18)^(C>>>18|ne<<14)^(ne>>>9|C<<23),z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,J=ne&ge^~ne&de,le=C&$^~C&j,z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,J=K$1[H*2],le=K$1[H*2+1],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,J=o[H%16],le=s[H%16],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,F=he&65535|V<<16,G=z&65535|q<<16,J=F,le=G,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=(_e>>>28|Ce<<4)^(Ce>>>2|_e<<30)^(Ce>>>7|_e<<25),le=(Ce>>>28|_e<<4)^(_e>>>2|Ce<<30)^(_e>>>7|Ce<<25),z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,J=_e&ee^_e&W^ee&W,le=Ce&ke^Ce&ae^ke&ae,z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,_=he&65535|V<<16,U=z&65535|q<<16,J=h,le=E,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=F,le=G,z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,h=he&65535|V<<16,E=z&65535|q<<16,ee=a,W=c,re=l,ne=h,ge=u,de=d,ye=f,_e=_,ke=p,ae=y,Q=w,C=E,$=x,j=B,O=P,Ce=U,H%16===15)for(te=0;te<16;te++)J=o[te],le=s[te],z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=o[(te+9)%16],le=s[(te+9)%16],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,F=o[(te+1)%16],G=s[(te+1)%16],J=(F>>>1|G<<31)^(F>>>8|G<<24)^F>>>7,le=(G>>>1|F<<31)^(G>>>8|F<<24)^(G>>>7|F<<25),z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,F=o[(te+14)%16],G=s[(te+14)%16],J=(F>>>19|G<<13)^(G>>>29|F<<3)^F>>>6,le=(G>>>19|F<<13)^(F>>>29|G<<3)^(G>>>6|F<<26),z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,o[te]=he&65535|V<<16,s[te]=z&65535|q<<16;J=_e,le=Ce,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[0],le=t[0],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[0]=_e=he&65535|V<<16,t[0]=Ce=z&65535|q<<16,J=ee,le=ke,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[1],le=t[1],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[1]=ee=he&65535|V<<16,t[1]=ke=z&65535|q<<16,J=W,le=ae,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[2],le=t[2],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[2]=W=he&65535|V<<16,t[2]=ae=z&65535|q<<16,J=re,le=Q,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[3],le=t[3],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[3]=re=he&65535|V<<16,t[3]=Q=z&65535|q<<16,J=ne,le=C,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[4],le=t[4],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[4]=ne=he&65535|V<<16,t[4]=C=z&65535|q<<16,J=ge,le=$,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[5],le=t[5],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[5]=ge=he&65535|V<<16,t[5]=$=z&65535|q<<16,J=de,le=j,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[6],le=t[6],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[6]=de=he&65535|V<<16,t[6]=j=z&65535|q<<16,J=ye,le=O,z=le&65535,q=le>>>16,he=J&65535,V=J>>>16,J=e[7],le=t[7],z+=le&65535,q+=le>>>16,he+=J&65535,V+=J>>>16,q+=z>>>16,he+=q>>>16,V+=he>>>16,e[7]=ye=he&65535|V<<16,t[7]=O=z&65535|q<<16,k+=128,n-=128}}function HMAC$3(e){if(!(this instanceof HMAC$3))return new HMAC$3(e);this.pad=b4a$6.alloc(128),this.inner=Sha512$2(),this.outer=Sha512$2();const t=b4a$6.alloc(64);e.byteLength>128&&(Sha512$2().update(e).digest(t),e=t),this.pad.fill(54);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.inner.update(this.pad),this.pad.fill(92);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.outer.update(this.pad),this.pad.fill(0),t.fill(0)}HMAC$3.prototype.update=function(e,t){return this.inner.update(e,t),this},HMAC$3.prototype.digest=function(e,t=0){return this.outer.update(this.inner.digest()),this.outer.digest(e,t)},Sha512$2.HMAC=HMAC$3;var sha512Wasm={exports:{}},sha512$1,hasRequiredSha512;function requireSha512(){if(hasRequiredSha512)return sha512$1;hasRequiredSha512=1;var e=(s,a)=>function(){return a||(0,s[Object.keys(s)[0]])((a={exports:{}}).exports,a),a.exports},t=(()=>{for(var s=new Uint8Array(128),a=0;a<64;a++)s[a<26?a+65:a<52?a+71:a<62?a-4:a*4-205]=a;return c=>{for(var l=c.length,h=new Uint8Array((l-(c[l-1]=="=")-(c[l-2]=="="))*3/4|0),u=0,d=0;u<l;){var f=s[c.charCodeAt(u++)],_=s[c.charCodeAt(u++)],p=s[c.charCodeAt(u++)],y=s[c.charCodeAt(u++)];h[d++]=f<<2|_>>4,h[d++]=_<<4|p>>2,h[d++]=p<<6|y}return h}})(),r=e({"wasm-binary:./sha512.wat"(s,a){a.exports=t("AGFzbQEAAAABNAVgAX4BfmAIfn5+fn5+fn4AYAR+fn5+AX5gEX9+fn5+fn5+fn5+fn5+fn5+AGAEf39/fwADBgUAAQIDBAUDAQABBikIfgFCAAt+AUIAC34BQgALfgFCAAt+AUIAC34BQgALfgFCAAt+AUIACwcTAgZtZW1vcnkCAAZzaGE1MTIABAqZHgVCACAAQoCA/P+PgECDQhCJIABC//+DgPD/P4NCEIqEIQAgAEL/gfyH8J/A/wCDQgiJIABCgP6D+I/gv4B/g0IIioQLvAMBBn4jBCMFgyMEQn+FIwaDhSEKIwAjAYMjACMCg4UjASMCg4UhCyMAQhyKIwBCIoqFIwBCJ4qFIQwjBEIOiiMEQhKKhSMEQimKhSENIwcgCnwgDXwgAHwgBHwhCCAMIAt8IQkjAyAIfCQHIAggCXwkAyMHIwSDIwdCf4UjBYOFIQojAyMAgyMDIwGDhSMAIwGDhSELIwNCHIojA0IiioUjA0InioUhDCMHQg6KIwdCEoqFIwdCKYqFIQ0jBiAKfCANfCABfCAFfCEIIAwgC3whCSMCIAh8JAYgCCAJfCQCIwYjB4MjBkJ/hSMEg4UhCiMCIwODIwIjAIOFIwMjAIOFIQsjAkIciiMCQiKKhSMCQieKhSEMIwZCDoojBkISioUjBkIpioUhDSMFIAp8IA18IAJ8IAZ8IQggDCALfCEJIwEgCHwkBSAIIAl8JAEjBSMGgyMFQn+FIweDhSEKIwEjAoMjASMDg4UjAyMCg4UhCyMBQhyKIwFCIoqFIwFCJ4qFIQwjBUIOiiMFQhKKhSMFQimKhSENIwQgCnwgDXwgA3wgB3whCCAMIAt8IQkjACAIfCQEIAggCXwkAAsrACAAQhOKIABCPYqFIABCBoiFIAF8IAJCAYogAkIIioUgAkIHiIUgA3x8C6QRACAAKQPQAUIAUQRAIABCiJLznf/M+YTqADcDACAAQrvOqqbY0Ouzu383AwggAEKr8NP0r+68tzw3AxAgAELx7fT4paf9p6V/NwMYIABC0YWa7/rPlIfRADcDICAAQp/Y+dnCkdqCm383AyggAELr+obav7X2wR83AzAgAEL5wvibkaOz8NsANwM4IABCATcD0AELIAApAwAkACAAKQMIJAEgACkDECQCIAApAxgkAyAAKQMgJAQgACkDKCQFIAApAzAkBiAAKQM4JAcgARAAIQEgAhAAIQIgAxAAIQMgBBAAIQQgBRAAIQUgBhAAIQYgBxAAIQcgCBAAIQggCRAAIQkgChAAIQogCxAAIQsgDBAAIQwgDRAAIQ0gDhAAIQ4gDxAAIQ8gEBAAIRAgASACIAMgBEKi3KK5jfOLxcIAQs3LvZ+SktGb8QBCr/a04v75vuC1f0K8t6eM2PT22mkQASAFIAYgByAIQrjqopq/y7CrOUKZoJewm77E+NkAQpuf5fjK1OCfkn9CmIK2093al46rfxABIAkgCiALIAxCwoSMmIrT6oNYQr7fwauU4NbBEkKM5ZL35LfhmCRC4un+r724n4bVABABIA0gDiAPIBBC75Luk8+ul9/yAEKxrdrY47+s74B/QrWknK7y1IHum39ClM2k+8yu/M1BEAEgDyAKIAIgARACIQEgECALIAMgAhACIQIgASAMIAQgAxACIQMgAiANIAUgBBACIQQgAyAOIAYgBRACIQUgBCAPIAcgBhACIQYgBSAQIAggBxACIQcgBiABIAkgCBACIQggByACIAogCRACIQkgCCADIAsgChACIQogCSAEIAwgCxACIQsgCiAFIA0gDBACIQwgCyAGIA4gDRACIQ0gDCAHIA8gDhACIQ4gDSAIIBAgDxACIQ8gDiAJIAEgEBACIRAgASACIAMgBELSlcX3mbjazWRC48u8wuPwkd9vQrWrs9zouOfgD0LluLK9x7mohiQQASAFIAYgByAIQvWErMn1jcv0LUKDyZv1ppWhusoAQtT3h+rLu6rY3ABCtafFmKib4vz2ABABIAkgCiALIAxCq7+b866qlJ+Yf0KQ5NDt0s3xmKh/Qr/C7MeJ+cmBsH9C5J289/v436y/fxABIA0gDiAPIBBCwp+i7bP+gvBGQqXOqpj5qOTTVULvhI6AnuqY5QZC8Ny50PCsypQUEAEgDyAKIAIgARACIQEgECALIAMgAhACIQIgASAMIAQgAxACIQMgAiANIAUgBBACIQQgAyAOIAYgBRACIQUgBCAPIAcgBhACIQYgBSAQIAggBxACIQcgBiABIAkgCBACIQggByACIAogCRACIQkgCCADIAsgChACIQogCSAEIAwgCxACIQsgCiAFIA0gDBACIQwgCyAGIA4gDRACIQ0gDCAHIA8gDhACIQ4gDSAIIBAgDxACIQ8gDiAJIAEgEBACIRAgASACIAMgBEL838i21NDC2ydCppKb4YWnyI0uQu3VkNbFv5uWzQBC3+fW7Lmig5zTABABIAUgBiAHIAhC3se93cjqnIXlAEKo5d7js9eCtfYAQubdtr/kpbLhgX9Cu+qIpNGQi7mSfxABIAkgCiALIAxC5IbE55SU+t+if0KB4Ijiu8mZjah/QpGv4oeN7uKlQkKw/NKysLSUtkcQASANIA4gDyAQQpikvbedg7rJUUKQ0parxcTBzFZCqsDEu9WwjYd0Qrij75WDjqi1EBABIA8gCiACIAEQAiEBIBAgCyADIAIQAiECIAEgDCAEIAMQAiEDIAIgDSAFIAQQAiEEIAMgDiAGIAUQAiEFIAQgDyAHIAYQAiEGIAUgECAIIAcQAiEHIAYgASAJIAgQAiEIIAcgAiAKIAkQAiEJIAggAyALIAoQAiEKIAkgBCAMIAsQAiELIAogBSANIAwQAiEMIAsgBiAOIA0QAiENIAwgByAPIA4QAiEOIA0gCCAQIA8QAiEPIA4gCSABIBAQAiEQIAEgAiADIARCyKHLxuuisNIZQtPWhoqFgdubHkKZ17v8zemdpCdCqJHtjN6Wr9g0EAEgBSAGIAcgCELjtKWuvJaDjjlCy5WGmq7JquzOAELzxo+798myztsAQqPxyrW9/puX6AAQASAJIAogCyAMQvzlvu/l3eDH9ABC4N7cmPTt2NL4AELy1sKPyoKe5IR/QuzzkNOBwcDjjH8QASANIA4gDyAQQqi8jJui/7/fkH9C6fuK9L2dm6ikf0KV8pmW+/7o/L5/QqumyZuunt64RhABIA8gCiACIAEQAiEBIBAgCyADIAIQAiECIAEgDCAEIAMQAiEDIAIgDSAFIAQQAiEEIAMgDiAGIAUQAiEFIAQgDyAHIAYQAiEGIAUgECAIIAcQAiEHIAYgASAJIAgQAiEIIAcgAiAKIAkQAiEJIAggAyALIAoQAiEKIAkgBCAMIAsQAiELIAogBSANIAwQAiEMIAsgBiAOIA0QAiENIAwgByAPIA4QAiEOIA0gCCAQIA8QAiEPIA4gCSABIBAQAiEQIAEgAiADIARCnMOZ0e7Zz5NKQoeEg47ymK7DUUKe1oPv7Lqf7WpC+KK78/7v0751EAEgBSAGIAcgCEK6392Qp/WZ+AZCprGiltq437EKQq6b5PfLgOafEUKbjvGY0ebCuBsQASAJIAogCyAMQoT7kZjS/t3tKEKTyZyGtO+q5TJCvP2mrqHBr888QsyawODJ+NmOwwAQASANIA4gDyAQQraF+dnsl/XizABCqvyV48+zyr/ZAELs9dvWs/Xb5d8AQpewndLEsYai7AAQASAAIAApAwAjAHw3AwAgACAAKQMIIwF8NwMIIAAgACkDECMCfDcDECAAIAApAxgjA3w3AxggACAAKQMgIwR8NwMgIAAgACkDKCMFfDcDKCAAIAApAzAjBnw3AzAgACAAKQM4Iwd8NwM4C8MIARV+IAApA0AhBCAAKQNIIQUgBEL/AIMgAq18IQggBCEGIAQgAq18IQQgACAENwNAIAQgBlQEQCAFQgF8IQUgACAFNwNICwJAIAApA1AhCSAAKQNYIQogACkDYCELIAApA2ghDCAAKQNwIQ0gACkDeCEOIAApA4ABIQ8gACkDiAEhECAAKQOQASERIAApA5gBIRIgACkDoAEhEyAAKQOoASEUIAApA7ABIRUgACkDuAEhFiAAKQPAASEXIAApA8gBIRggCEKAAX0iCEIAUw0AIAAgCSAKIAsgDCANIA4gDyAQIBEgEiATIBQgFSAWIBcgGBADA0AgASkDACEJIAEpAwghCiABKQMQIQsgASkDGCEMIAEpAyAhDSABKQMoIQ4gASkDMCEPIAEpAzghECABKQNAIREgASkDSCESIAEpA1AhEyABKQNYIRQgASkDYCEVIAEpA2ghFiABKQNwIRcgASkDeCEYIAFBgAFqIQEgCEKAAX0iCEIAUwRAIAAgCTcDUCAAIAo3A1ggACALNwNgIAAgDDcDaCAAIA03A3AgACAONwN4IAAgDzcDgAEgACAQNwOIASAAIBE3A5ABIAAgEjcDmAEgACATNwOgASAAIBQ3A6gBIAAgFTcDsAEgACAWNwO4ASAAIBc3A8ABIAAgGDcDyAEMAgsgACAJIAogCyAMIA0gDiAPIBAgESASIBMgFCAVIBYgFyAYEAMMAAsLIANBAUYEQCAEQv8AgyEIQoABIAhCB4NCA4aGIQcCQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAgCKdBA3YODwMEBQYHCAkKCwwNDg8QAQILCyAHIBeEIRdCACEHCyAHIBiEIRhCACEHIAAgCSAKIAsgDCANIA4gDyAQIBEgEiATIBQgFSAWIBcgGBADIAAgBDcDQEIAIQlCACEKQgAhC0IAIQxCACENQgAhDkIAIQ9CACEQQgAhEUIAIRJCACETQgAhFEIAIRVCACEWQgAhF0IAIRgLIAcgCYQhCUIAIQcLIAcgCoQhCkIAIQcLIAcgC4QhC0IAIQcLIAcgDIQhDEIAIQcLIAcgDYQhDUIAIQcLIAcgDoQhDkIAIQcLIAcgD4QhD0IAIQcLIAcgEIQhEEIAIQcLIAcgEYQhEUIAIQcLIAcgEoQhEkIAIQcLIAcgE4QhE0IAIQcLIAcgFIQhFEIAIQcLIAcgFYQhFUIAIQcLIAcgFoQhFkIAIQcLIARCPYggBUIDiHwQACEXIARCCH4QACEYIAAgCSAKIAsgDCANIA4gDyAQIBEgEiATIBQgFSAWIBcgGBADIAAgACkDABAANwMAIAAgACkDCBAANwMIIAAgACkDEBAANwMQIAAgACkDGBAANwMYIAAgACkDIBAANwMgIAAgACkDKBAANwMoIAAgACkDMBAANwMwIAAgACkDOBAANwM4Cws=")}}),n=r(),o=new WebAssembly.Module(n);return sha512$1=s=>new WebAssembly.Instance(o,s).exports,sha512$1}const assert$i=nanoassert,b4a$5=browserExports$2,wasm$8=typeof WebAssembly<"u"&&requireSha512()({imports:{debug:{log(...e){console.log(...e.map(t=>(t>>>0).toString(16).padStart(8,"0")))},log_tee(e){return console.log((e>>>0).toString(16).padStart(8,"0")),e}}}});let head$3=0;const freeList$2=[];sha512Wasm.exports=Sha512$1;const SHA512_BYTES=sha512Wasm.exports.SHA512_BYTES=64,INPUT_OFFSET$1=80,STATEBYTES$1=216,BLOCKSIZE$2=128;function Sha512$1(){if(!(this instanceof Sha512$1))return new Sha512$1;if(!wasm$8)throw new Error("WASM not loaded. Wait for Sha512.ready(cb)");freeList$2.length||(freeList$2.push(head$3),head$3+=STATEBYTES$1),this.finalized=!1,this.digestLength=SHA512_BYTES,this.pointer=freeList$2.pop(),this.pos=0,this.wasm=wasm$8,this._memory=new Uint8Array(wasm$8.memory.buffer),this._memory.fill(0,this.pointer,this.pointer+STATEBYTES$1),this.pointer+this.digestLength>this._memory.length&&this._realloc(this.pointer+STATEBYTES$1)}Sha512$1.prototype._realloc=function(e){wasm$8.memory.grow(Math.max(0,Math.ceil(Math.abs(e-this._memory.length)/65536))),this._memory=new Uint8Array(wasm$8.memory.buffer)},Sha512$1.prototype.update=function(e,t){assert$i(this.finalized===!1,"Hash instance finalized"),head$3%8!==0&&(head$3+=8-head$3%8),assert$i(head$3%8===0,"input should be aligned for int64");const[r,n]=formatInput$2(e,t);return assert$i(r instanceof Uint8Array,"input must be Uint8Array or Buffer"),head$3+e.length>this._memory.length&&this._realloc(head$3+e.length),this._memory.fill(0,head$3,head$3+roundUp$1(n,BLOCKSIZE$2)-BLOCKSIZE$2),this._memory.set(r.subarray(0,BLOCKSIZE$2-this.pos),this.pointer+INPUT_OFFSET$1+this.pos),this._memory.set(r.subarray(BLOCKSIZE$2-this.pos),head$3),this.pos=this.pos+n&127,wasm$8.sha512(this.pointer,head$3,n,0),this},Sha512$1.prototype.digest=function(e,t=0){assert$i(this.finalized===!1,"Hash instance finalized"),this.finalized=!0,freeList$2.push(this.pointer);const r=this.pointer+INPUT_OFFSET$1+this.pos;this._memory.fill(0,r,this.pointer+INPUT_OFFSET$1+BLOCKSIZE$2),wasm$8.sha512(this.pointer,head$3,0,1);const n=this._memory.subarray(this.pointer,this.pointer+this.digestLength);if(!e)return n;if(typeof e=="string")return b4a$5.toString(n,e);assert$i(e instanceof Uint8Array,"output must be Uint8Array or Buffer"),assert$i(e.byteLength>=this.digestLength+t,"output must have at least 'SHA512_BYTES' bytes remaining");for(let o=0;o<this.digestLength;o++)e[o+t]=n[o];return e},Sha512$1.WASM=wasm$8,Sha512$1.WASM_SUPPORTED=typeof WebAssembly<"u",Sha512$1.ready=function(e){return e||(e=noop$5),wasm$8?(e(),Promise.resolve()):e(new Error("WebAssembly not supported"))},Sha512$1.prototype.ready=Sha512$1.ready;function HMAC$2(e){if(!(this instanceof HMAC$2))return new HMAC$2(e);this.pad=b4a$5.alloc(128),this.inner=Sha512$1(),this.outer=Sha512$1();const t=b4a$5.alloc(64);e.byteLength>128&&(Sha512$1().update(e).digest(t),e=t),this.pad.fill(54);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.inner.update(this.pad),this.pad.fill(92);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.outer.update(this.pad),this.pad.fill(0),t.fill(0)}HMAC$2.prototype.update=function(e,t){return this.inner.update(e,t),this},HMAC$2.prototype.digest=function(e,t=0){return this.outer.update(this.inner.digest()),this.outer.digest(e,t)},Sha512$1.HMAC=HMAC$2;function noop$5(){}function formatInput$2(e,t){var r=b4a$5.from(e,t);return[r,r.byteLength]}function roundUp$1(e,t){return e+t-1&-t}var sha512WasmExports=sha512Wasm.exports;const js$1=sha512$2,wasm$7=sha512WasmExports;var Proto$2=js$1;sha512Universal.exports=function(){return new Proto$2},sha512Universal.exports.ready=function(e){wasm$7.ready(function(){e()})},sha512Universal.exports.WASM_SUPPORTED=wasm$7.SUPPORTED,sha512Universal.exports.WASM_LOADED=!1,sha512Universal.exports.SHA512_BYTES=64,wasm$7.ready(function(e){e||(sha512Universal.exports.WASM_LOADED=!0,sha512Universal.exports=Proto$2=wasm$7)});var sha512UniversalExports=sha512Universal.exports;const{crypto_verify_32:crypto_verify_32$1}=crypto_verifyExports,Sha512=sha512UniversalExports,assert$h=nanoassert,crypto_auth_BYTES=32,crypto_auth_KEYBYTES=32;function crypto_auth(e,t,r){assert$h(e.byteLength===crypto_auth_BYTES,"out should be 'crypto_auth_BYTES' in length"),assert$h(r.byteLength===crypto_auth_KEYBYTES,"key should be 'crypto_auth_KEYBYTES' in length");const n=new Uint8Array(64),o=Sha512.HMAC(r);o.update(t),o.digest(n),e.set(n.subarray(0,32))}function crypto_auth_verify(e,t,r){assert$h(e.byteLength===crypto_auth_BYTES,"h should be 'crypto_auth_BYTES' in length"),assert$h(r.byteLength===crypto_auth_KEYBYTES,"key should be 'crypto_auth_KEYBYTES' in length");const n=Sha512.HMAC(r).update(t).digest();return crypto_verify_32$1(e,0,n,0)}var crypto_auth_1={crypto_auth_BYTES,crypto_auth_KEYBYTES,crypto_auth,crypto_auth_verify};const sha512=sha512UniversalExports,assert$g=nanoassert;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");const crypto_hash_sha512_BYTES$1=64,crypto_hash_BYTES=crypto_hash_sha512_BYTES$1;function crypto_hash_sha512$1(e,t,r){return assert$g(e.byteLength===crypto_hash_sha512_BYTES$1,"out must be 'crypto_hash_sha512_BYTES' bytes long"),sha512().update(t.subarray(0,r)).digest(e),0}function crypto_hash$1(e,t,r){return crypto_hash_sha512$1(e,t,r)}var crypto_hash_1={crypto_hash:crypto_hash$1,crypto_hash_sha512:crypto_hash_sha512$1,crypto_hash_sha512_BYTES:crypto_hash_sha512_BYTES$1,crypto_hash_BYTES};if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");var gf$2=function(e){var t,r=new Float64Array(16);if(e)for(t=0;t<e.length;t++)r[t]=e[t];return r},_9$1=new Uint8Array(32);_9$1[0]=9;var gf0$1=gf$2(),gf1$1=gf$2([1]),_121665$1=gf$2([56129,1]),D$1=gf$2([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),D2$1=gf$2([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),X$1=gf$2([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),Y$1=gf$2([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),I$1=gf$2([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function A$2(e,t,r){for(var n=0;n<16;n++)e[n]=t[n]+r[n]}function Z$2(e,t,r){for(var n=0;n<16;n++)e[n]=t[n]-r[n]}function M$2(e,t,r){var n,o,s=0,a=0,c=0,l=0,h=0,u=0,d=0,f=0,_=0,p=0,y=0,w=0,E=0,x=0,B=0,P=0,U=0,F=0,G=0,H=0,te=0,J=0,le=0,z=0,q=0,he=0,V=0,_e=0,ee=0,W=0,re=0,ne=r[0],ge=r[1],de=r[2],ye=r[3],Ce=r[4],ke=r[5],ae=r[6],Q=r[7],C=r[8],$=r[9],j=r[10],O=r[11],k=r[12],ue=r[13],pe=r[14],Oe=r[15];n=t[0],s+=n*ne,a+=n*ge,c+=n*de,l+=n*ye,h+=n*Ce,u+=n*ke,d+=n*ae,f+=n*Q,_+=n*C,p+=n*$,y+=n*j,w+=n*O,E+=n*k,x+=n*ue,B+=n*pe,P+=n*Oe,n=t[1],a+=n*ne,c+=n*ge,l+=n*de,h+=n*ye,u+=n*Ce,d+=n*ke,f+=n*ae,_+=n*Q,p+=n*C,y+=n*$,w+=n*j,E+=n*O,x+=n*k,B+=n*ue,P+=n*pe,U+=n*Oe,n=t[2],c+=n*ne,l+=n*ge,h+=n*de,u+=n*ye,d+=n*Ce,f+=n*ke,_+=n*ae,p+=n*Q,y+=n*C,w+=n*$,E+=n*j,x+=n*O,B+=n*k,P+=n*ue,U+=n*pe,F+=n*Oe,n=t[3],l+=n*ne,h+=n*ge,u+=n*de,d+=n*ye,f+=n*Ce,_+=n*ke,p+=n*ae,y+=n*Q,w+=n*C,E+=n*$,x+=n*j,B+=n*O,P+=n*k,U+=n*ue,F+=n*pe,G+=n*Oe,n=t[4],h+=n*ne,u+=n*ge,d+=n*de,f+=n*ye,_+=n*Ce,p+=n*ke,y+=n*ae,w+=n*Q,E+=n*C,x+=n*$,B+=n*j,P+=n*O,U+=n*k,F+=n*ue,G+=n*pe,H+=n*Oe,n=t[5],u+=n*ne,d+=n*ge,f+=n*de,_+=n*ye,p+=n*Ce,y+=n*ke,w+=n*ae,E+=n*Q,x+=n*C,B+=n*$,P+=n*j,U+=n*O,F+=n*k,G+=n*ue,H+=n*pe,te+=n*Oe,n=t[6],d+=n*ne,f+=n*ge,_+=n*de,p+=n*ye,y+=n*Ce,w+=n*ke,E+=n*ae,x+=n*Q,B+=n*C,P+=n*$,U+=n*j,F+=n*O,G+=n*k,H+=n*ue,te+=n*pe,J+=n*Oe,n=t[7],f+=n*ne,_+=n*ge,p+=n*de,y+=n*ye,w+=n*Ce,E+=n*ke,x+=n*ae,B+=n*Q,P+=n*C,U+=n*$,F+=n*j,G+=n*O,H+=n*k,te+=n*ue,J+=n*pe,le+=n*Oe,n=t[8],_+=n*ne,p+=n*ge,y+=n*de,w+=n*ye,E+=n*Ce,x+=n*ke,B+=n*ae,P+=n*Q,U+=n*C,F+=n*$,G+=n*j,H+=n*O,te+=n*k,J+=n*ue,le+=n*pe,z+=n*Oe,n=t[9],p+=n*ne,y+=n*ge,w+=n*de,E+=n*ye,x+=n*Ce,B+=n*ke,P+=n*ae,U+=n*Q,F+=n*C,G+=n*$,H+=n*j,te+=n*O,J+=n*k,le+=n*ue,z+=n*pe,q+=n*Oe,n=t[10],y+=n*ne,w+=n*ge,E+=n*de,x+=n*ye,B+=n*Ce,P+=n*ke,U+=n*ae,F+=n*Q,G+=n*C,H+=n*$,te+=n*j,J+=n*O,le+=n*k,z+=n*ue,q+=n*pe,he+=n*Oe,n=t[11],w+=n*ne,E+=n*ge,x+=n*de,B+=n*ye,P+=n*Ce,U+=n*ke,F+=n*ae,G+=n*Q,H+=n*C,te+=n*$,J+=n*j,le+=n*O,z+=n*k,q+=n*ue,he+=n*pe,V+=n*Oe,n=t[12],E+=n*ne,x+=n*ge,B+=n*de,P+=n*ye,U+=n*Ce,F+=n*ke,G+=n*ae,H+=n*Q,te+=n*C,J+=n*$,le+=n*j,z+=n*O,q+=n*k,he+=n*ue,V+=n*pe,_e+=n*Oe,n=t[13],x+=n*ne,B+=n*ge,P+=n*de,U+=n*ye,F+=n*Ce,G+=n*ke,H+=n*ae,te+=n*Q,J+=n*C,le+=n*$,z+=n*j,q+=n*O,he+=n*k,V+=n*ue,_e+=n*pe,ee+=n*Oe,n=t[14],B+=n*ne,P+=n*ge,U+=n*de,F+=n*ye,G+=n*Ce,H+=n*ke,te+=n*ae,J+=n*Q,le+=n*C,z+=n*$,q+=n*j,he+=n*O,V+=n*k,_e+=n*ue,ee+=n*pe,W+=n*Oe,n=t[15],P+=n*ne,U+=n*ge,F+=n*de,G+=n*ye,H+=n*Ce,te+=n*ke,J+=n*ae,le+=n*Q,z+=n*C,q+=n*$,he+=n*j,V+=n*O,_e+=n*k,ee+=n*ue,W+=n*pe,re+=n*Oe,s+=38*U,a+=38*F,c+=38*G,l+=38*H,h+=38*te,u+=38*J,d+=38*le,f+=38*z,_+=38*q,p+=38*he,y+=38*V,w+=38*_e,E+=38*ee,x+=38*W,B+=38*re,o=1,n=s+o+65535,o=Math.floor(n/65536),s=n-o*65536,n=a+o+65535,o=Math.floor(n/65536),a=n-o*65536,n=c+o+65535,o=Math.floor(n/65536),c=n-o*65536,n=l+o+65535,o=Math.floor(n/65536),l=n-o*65536,n=h+o+65535,o=Math.floor(n/65536),h=n-o*65536,n=u+o+65535,o=Math.floor(n/65536),u=n-o*65536,n=d+o+65535,o=Math.floor(n/65536),d=n-o*65536,n=f+o+65535,o=Math.floor(n/65536),f=n-o*65536,n=_+o+65535,o=Math.floor(n/65536),_=n-o*65536,n=p+o+65535,o=Math.floor(n/65536),p=n-o*65536,n=y+o+65535,o=Math.floor(n/65536),y=n-o*65536,n=w+o+65535,o=Math.floor(n/65536),w=n-o*65536,n=E+o+65535,o=Math.floor(n/65536),E=n-o*65536,n=x+o+65535,o=Math.floor(n/65536),x=n-o*65536,n=B+o+65535,o=Math.floor(n/65536),B=n-o*65536,n=P+o+65535,o=Math.floor(n/65536),P=n-o*65536,s+=o-1+37*(o-1),o=1,n=s+o+65535,o=Math.floor(n/65536),s=n-o*65536,n=a+o+65535,o=Math.floor(n/65536),a=n-o*65536,n=c+o+65535,o=Math.floor(n/65536),c=n-o*65536,n=l+o+65535,o=Math.floor(n/65536),l=n-o*65536,n=h+o+65535,o=Math.floor(n/65536),h=n-o*65536,n=u+o+65535,o=Math.floor(n/65536),u=n-o*65536,n=d+o+65535,o=Math.floor(n/65536),d=n-o*65536,n=f+o+65535,o=Math.floor(n/65536),f=n-o*65536,n=_+o+65535,o=Math.floor(n/65536),_=n-o*65536,n=p+o+65535,o=Math.floor(n/65536),p=n-o*65536,n=y+o+65535,o=Math.floor(n/65536),y=n-o*65536,n=w+o+65535,o=Math.floor(n/65536),w=n-o*65536,n=E+o+65535,o=Math.floor(n/65536),E=n-o*65536,n=x+o+65535,o=Math.floor(n/65536),x=n-o*65536,n=B+o+65535,o=Math.floor(n/65536),B=n-o*65536,n=P+o+65535,o=Math.floor(n/65536),P=n-o*65536,s+=o-1+37*(o-1),e[0]=s,e[1]=a,e[2]=c,e[3]=l,e[4]=h,e[5]=u,e[6]=d,e[7]=f,e[8]=_,e[9]=p,e[10]=y,e[11]=w,e[12]=E,e[13]=x,e[14]=B,e[15]=P}function S$2(e,t){M$2(e,t,t)}function sel25519$2(e,t,r){for(var n,o=~(r-1),s=0;s<16;s++)n=o&(e[s]^t[s]),e[s]^=n,t[s]^=n}function pack25519$2(e,t){var r,n,o,s=gf$2(),a=gf$2();for(r=0;r<16;r++)a[r]=t[r];for(car25519(a),car25519(a),car25519(a),n=0;n<2;n++){for(s[0]=a[0]-65517,r=1;r<15;r++)s[r]=a[r]-65535-(s[r-1]>>16&1),s[r-1]&=65535;s[15]=a[15]-32767-(s[14]>>16&1),o=s[15]>>16&1,s[14]&=65535,sel25519$2(a,s,1-o)}for(r=0;r<16;r++)e[2*r]=a[r]&255,e[2*r+1]=a[r]>>8}function unpack25519$2(e,t){var r;for(r=0;r<16;r++)e[r]=t[2*r]+(t[2*r+1]<<8);e[15]&=32767}function inv25519$2(e,t){var r=gf$2(),n;for(n=0;n<16;n++)r[n]=t[n];for(n=253;n>=0;n--)S$2(r,r),n!==2&&n!==4&&M$2(r,r,t);for(n=0;n<16;n++)e[n]=r[n]}function car25519(e){var t,r,n=1;for(t=0;t<16;t++)r=e[t]+n+65535,n=Math.floor(r/65536),e[t]=r-n*65536;e[0]+=n-1+37*(n-1)}var ed25519={gf:gf$2,A:A$2,Z:Z$2,M:M$2,S:S$2,sel25519:sel25519$2,pack25519:pack25519$2,unpack25519:unpack25519$2,inv25519:inv25519$2,gf0:gf0$1,gf1:gf1$1,_9:_9$1,_121665:_121665$1,D:D$1,D2:D2$1,X:X$1,Y:Y$1,I:I$1};const{_9,_121665,gf:gf$1,inv25519:inv25519$1,pack25519:pack25519$1,unpack25519:unpack25519$1,sel25519:sel25519$1,A:A$1,M:M$1,Z:Z$1,S:S$1}=ed25519,crypto_scalarmult_BYTES$1=32,crypto_scalarmult_SCALARBYTES=32;var crypto_scalarmult_1={crypto_scalarmult:crypto_scalarmult$3,crypto_scalarmult_base:crypto_scalarmult_base$2,crypto_scalarmult_BYTES:crypto_scalarmult_BYTES$1,crypto_scalarmult_SCALARBYTES};function crypto_scalarmult$3(e,t,r){check$2(e,crypto_scalarmult_BYTES$1),check$2(t,crypto_scalarmult_SCALARBYTES),check$2(r,crypto_scalarmult_BYTES$1);var n=new Uint8Array(32),o=new Float64Array(80),s,a,c=gf$1(),l=gf$1(),h=gf$1(),u=gf$1(),d=gf$1(),f=gf$1();for(a=0;a<31;a++)n[a]=t[a];for(n[31]=t[31]&127|64,n[0]&=248,unpack25519$1(o,r),a=0;a<16;a++)l[a]=o[a],u[a]=c[a]=h[a]=0;for(c[0]=u[0]=1,a=254;a>=0;--a)s=n[a>>>3]>>>(a&7)&1,sel25519$1(c,l,s),sel25519$1(h,u,s),A$1(d,c,h),Z$1(c,c,h),A$1(h,l,u),Z$1(l,l,u),S$1(u,d),S$1(f,c),M$1(c,h,c),M$1(h,l,d),A$1(d,c,h),Z$1(c,c,h),S$1(l,c),Z$1(h,u,f),M$1(c,h,_121665),A$1(c,c,u),M$1(h,h,c),M$1(c,u,f),M$1(u,l,o),S$1(l,d),sel25519$1(c,l,s),sel25519$1(h,u,s);for(a=0;a<16;a++)o[a+16]=c[a],o[a+32]=h[a],o[a+48]=l[a],o[a+64]=u[a];var _=o.subarray(32),p=o.subarray(16);return inv25519$1(_,_),M$1(p,p,_),pack25519$1(e,p),0}function crypto_scalarmult_base$2(e,t){return crypto_scalarmult$3(e,t,_9)}function check$2(e,t){if(!e||e.length<t)throw new Error("Argument must be a buffer"+(" of length "+t))}var crypto_generichash$3={exports:{}},blake2b$1={exports:{}},blake2bWasm={exports:{}},blake2b,hasRequiredBlake2b;function requireBlake2b(){if(hasRequiredBlake2b)return blake2b;hasRequiredBlake2b=1;var e=(s,a)=>function(){return a||(0,s[Object.keys(s)[0]])((a={exports:{}}).exports,a),a.exports},t=(()=>{for(var s=new Uint8Array(128),a=0;a<64;a++)s[a<26?a+65:a<52?a+71:a<62?a-4:a*4-205]=a;return c=>{for(var l=c.length,h=new Uint8Array((l-(c[l-1]=="=")-(c[l-2]=="="))*3/4|0),u=0,d=0;u<l;){var f=s[c.charCodeAt(u++)],_=s[c.charCodeAt(u++)],p=s[c.charCodeAt(u++)],y=s[c.charCodeAt(u++)];h[d++]=f<<2|_>>4,h[d++]=_<<4|p>>2,h[d++]=p<<6|y}return h}})(),r=e({"wasm-binary:./blake2b.wat"(s,a){a.exports=t("AGFzbQEAAAABEANgAn9/AGADf39/AGABfwADBQQAAQICBQUBAQroBwdNBQZtZW1vcnkCAAxibGFrZTJiX2luaXQAAA5ibGFrZTJiX3VwZGF0ZQABDWJsYWtlMmJfZmluYWwAAhBibGFrZTJiX2NvbXByZXNzAAMKvz8EwAIAIABCADcDACAAQgA3AwggAEIANwMQIABCADcDGCAAQgA3AyAgAEIANwMoIABCADcDMCAAQgA3AzggAEIANwNAIABCADcDSCAAQgA3A1AgAEIANwNYIABCADcDYCAAQgA3A2ggAEIANwNwIABCADcDeCAAQoiS853/zPmE6gBBACkDAIU3A4ABIABCu86qptjQ67O7f0EIKQMAhTcDiAEgAEKr8NP0r+68tzxBECkDAIU3A5ABIABC8e30+KWn/aelf0EYKQMAhTcDmAEgAELRhZrv+s+Uh9EAQSApAwCFNwOgASAAQp/Y+dnCkdqCm39BKCkDAIU3A6gBIABC6/qG2r+19sEfQTApAwCFNwOwASAAQvnC+JuRo7Pw2wBBOCkDAIU3A7gBIABCADcDwAEgAEIANwPIASAAQgA3A9ABC20BA38gAEHAAWohAyAAQcgBaiEEIAQpAwCnIQUCQANAIAEgAkYNASAFQYABRgRAIAMgAykDACAFrXw3AwBBACEFIAAQAwsgACAFaiABLQAAOgAAIAVBAWohBSABQQFqIQEMAAsLIAQgBa03AwALYQEDfyAAQcABaiEBIABByAFqIQIgASABKQMAIAIpAwB8NwMAIABCfzcD0AEgAikDAKchAwJAA0AgA0GAAUYNASAAIANqQQA6AAAgA0EBaiEDDAALCyACIAOtNwMAIAAQAwuqOwIgfgl/IABBgAFqISEgAEGIAWohIiAAQZABaiEjIABBmAFqISQgAEGgAWohJSAAQagBaiEmIABBsAFqIScgAEG4AWohKCAhKQMAIQEgIikDACECICMpAwAhAyAkKQMAIQQgJSkDACEFICYpAwAhBiAnKQMAIQcgKCkDACEIQoiS853/zPmE6gAhCUK7zqqm2NDrs7t/IQpCq/DT9K/uvLc8IQtC8e30+KWn/aelfyEMQtGFmu/6z5SH0QAhDUKf2PnZwpHagpt/IQ5C6/qG2r+19sEfIQ9C+cL4m5Gjs/DbACEQIAApAwAhESAAKQMIIRIgACkDECETIAApAxghFCAAKQMgIRUgACkDKCEWIAApAzAhFyAAKQM4IRggACkDQCEZIAApA0ghGiAAKQNQIRsgACkDWCEcIAApA2AhHSAAKQNoIR4gACkDcCEfIAApA3ghICANIAApA8ABhSENIA8gACkD0AGFIQ8gASAFIBF8fCEBIA0gAYVCIIohDSAJIA18IQkgBSAJhUIYiiEFIAEgBSASfHwhASANIAGFQhCKIQ0gCSANfCEJIAUgCYVCP4ohBSACIAYgE3x8IQIgDiAChUIgiiEOIAogDnwhCiAGIAqFQhiKIQYgAiAGIBR8fCECIA4gAoVCEIohDiAKIA58IQogBiAKhUI/iiEGIAMgByAVfHwhAyAPIAOFQiCKIQ8gCyAPfCELIAcgC4VCGIohByADIAcgFnx8IQMgDyADhUIQiiEPIAsgD3whCyAHIAuFQj+KIQcgBCAIIBd8fCEEIBAgBIVCIIohECAMIBB8IQwgCCAMhUIYiiEIIAQgCCAYfHwhBCAQIASFQhCKIRAgDCAQfCEMIAggDIVCP4ohCCABIAYgGXx8IQEgECABhUIgiiEQIAsgEHwhCyAGIAuFQhiKIQYgASAGIBp8fCEBIBAgAYVCEIohECALIBB8IQsgBiALhUI/iiEGIAIgByAbfHwhAiANIAKFQiCKIQ0gDCANfCEMIAcgDIVCGIohByACIAcgHHx8IQIgDSAChUIQiiENIAwgDXwhDCAHIAyFQj+KIQcgAyAIIB18fCEDIA4gA4VCIIohDiAJIA58IQkgCCAJhUIYiiEIIAMgCCAefHwhAyAOIAOFQhCKIQ4gCSAOfCEJIAggCYVCP4ohCCAEIAUgH3x8IQQgDyAEhUIgiiEPIAogD3whCiAFIAqFQhiKIQUgBCAFICB8fCEEIA8gBIVCEIohDyAKIA98IQogBSAKhUI/iiEFIAEgBSAffHwhASANIAGFQiCKIQ0gCSANfCEJIAUgCYVCGIohBSABIAUgG3x8IQEgDSABhUIQiiENIAkgDXwhCSAFIAmFQj+KIQUgAiAGIBV8fCECIA4gAoVCIIohDiAKIA58IQogBiAKhUIYiiEGIAIgBiAZfHwhAiAOIAKFQhCKIQ4gCiAOfCEKIAYgCoVCP4ohBiADIAcgGnx8IQMgDyADhUIgiiEPIAsgD3whCyAHIAuFQhiKIQcgAyAHICB8fCEDIA8gA4VCEIohDyALIA98IQsgByALhUI/iiEHIAQgCCAefHwhBCAQIASFQiCKIRAgDCAQfCEMIAggDIVCGIohCCAEIAggF3x8IQQgECAEhUIQiiEQIAwgEHwhDCAIIAyFQj+KIQggASAGIBJ8fCEBIBAgAYVCIIohECALIBB8IQsgBiALhUIYiiEGIAEgBiAdfHwhASAQIAGFQhCKIRAgCyAQfCELIAYgC4VCP4ohBiACIAcgEXx8IQIgDSAChUIgiiENIAwgDXwhDCAHIAyFQhiKIQcgAiAHIBN8fCECIA0gAoVCEIohDSAMIA18IQwgByAMhUI/iiEHIAMgCCAcfHwhAyAOIAOFQiCKIQ4gCSAOfCEJIAggCYVCGIohCCADIAggGHx8IQMgDiADhUIQiiEOIAkgDnwhCSAIIAmFQj+KIQggBCAFIBZ8fCEEIA8gBIVCIIohDyAKIA98IQogBSAKhUIYiiEFIAQgBSAUfHwhBCAPIASFQhCKIQ8gCiAPfCEKIAUgCoVCP4ohBSABIAUgHHx8IQEgDSABhUIgiiENIAkgDXwhCSAFIAmFQhiKIQUgASAFIBl8fCEBIA0gAYVCEIohDSAJIA18IQkgBSAJhUI/iiEFIAIgBiAdfHwhAiAOIAKFQiCKIQ4gCiAOfCEKIAYgCoVCGIohBiACIAYgEXx8IQIgDiAChUIQiiEOIAogDnwhCiAGIAqFQj+KIQYgAyAHIBZ8fCEDIA8gA4VCIIohDyALIA98IQsgByALhUIYiiEHIAMgByATfHwhAyAPIAOFQhCKIQ8gCyAPfCELIAcgC4VCP4ohByAEIAggIHx8IQQgECAEhUIgiiEQIAwgEHwhDCAIIAyFQhiKIQggBCAIIB58fCEEIBAgBIVCEIohECAMIBB8IQwgCCAMhUI/iiEIIAEgBiAbfHwhASAQIAGFQiCKIRAgCyAQfCELIAYgC4VCGIohBiABIAYgH3x8IQEgECABhUIQiiEQIAsgEHwhCyAGIAuFQj+KIQYgAiAHIBR8fCECIA0gAoVCIIohDSAMIA18IQwgByAMhUIYiiEHIAIgByAXfHwhAiANIAKFQhCKIQ0gDCANfCEMIAcgDIVCP4ohByADIAggGHx8IQMgDiADhUIgiiEOIAkgDnwhCSAIIAmFQhiKIQggAyAIIBJ8fCEDIA4gA4VCEIohDiAJIA58IQkgCCAJhUI/iiEIIAQgBSAafHwhBCAPIASFQiCKIQ8gCiAPfCEKIAUgCoVCGIohBSAEIAUgFXx8IQQgDyAEhUIQiiEPIAogD3whCiAFIAqFQj+KIQUgASAFIBh8fCEBIA0gAYVCIIohDSAJIA18IQkgBSAJhUIYiiEFIAEgBSAafHwhASANIAGFQhCKIQ0gCSANfCEJIAUgCYVCP4ohBSACIAYgFHx8IQIgDiAChUIgiiEOIAogDnwhCiAGIAqFQhiKIQYgAiAGIBJ8fCECIA4gAoVCEIohDiAKIA58IQogBiAKhUI/iiEGIAMgByAefHwhAyAPIAOFQiCKIQ8gCyAPfCELIAcgC4VCGIohByADIAcgHXx8IQMgDyADhUIQiiEPIAsgD3whCyAHIAuFQj+KIQcgBCAIIBx8fCEEIBAgBIVCIIohECAMIBB8IQwgCCAMhUIYiiEIIAQgCCAffHwhBCAQIASFQhCKIRAgDCAQfCEMIAggDIVCP4ohCCABIAYgE3x8IQEgECABhUIgiiEQIAsgEHwhCyAGIAuFQhiKIQYgASAGIBd8fCEBIBAgAYVCEIohECALIBB8IQsgBiALhUI/iiEGIAIgByAWfHwhAiANIAKFQiCKIQ0gDCANfCEMIAcgDIVCGIohByACIAcgG3x8IQIgDSAChUIQiiENIAwgDXwhDCAHIAyFQj+KIQcgAyAIIBV8fCEDIA4gA4VCIIohDiAJIA58IQkgCCAJhUIYiiEIIAMgCCARfHwhAyAOIAOFQhCKIQ4gCSAOfCEJIAggCYVCP4ohCCAEIAUgIHx8IQQgDyAEhUIgiiEPIAogD3whCiAFIAqFQhiKIQUgBCAFIBl8fCEEIA8gBIVCEIohDyAKIA98IQogBSAKhUI/iiEFIAEgBSAafHwhASANIAGFQiCKIQ0gCSANfCEJIAUgCYVCGIohBSABIAUgEXx8IQEgDSABhUIQiiENIAkgDXwhCSAFIAmFQj+KIQUgAiAGIBZ8fCECIA4gAoVCIIohDiAKIA58IQogBiAKhUIYiiEGIAIgBiAYfHwhAiAOIAKFQhCKIQ4gCiAOfCEKIAYgCoVCP4ohBiADIAcgE3x8IQMgDyADhUIgiiEPIAsgD3whCyAHIAuFQhiKIQcgAyAHIBV8fCEDIA8gA4VCEIohDyALIA98IQsgByALhUI/iiEHIAQgCCAbfHwhBCAQIASFQiCKIRAgDCAQfCEMIAggDIVCGIohCCAEIAggIHx8IQQgECAEhUIQiiEQIAwgEHwhDCAIIAyFQj+KIQggASAGIB98fCEBIBAgAYVCIIohECALIBB8IQsgBiALhUIYiiEGIAEgBiASfHwhASAQIAGFQhCKIRAgCyAQfCELIAYgC4VCP4ohBiACIAcgHHx8IQIgDSAChUIgiiENIAwgDXwhDCAHIAyFQhiKIQcgAiAHIB18fCECIA0gAoVCEIohDSAMIA18IQwgByAMhUI/iiEHIAMgCCAXfHwhAyAOIAOFQiCKIQ4gCSAOfCEJIAggCYVCGIohCCADIAggGXx8IQMgDiADhUIQiiEOIAkgDnwhCSAIIAmFQj+KIQggBCAFIBR8fCEEIA8gBIVCIIohDyAKIA98IQogBSAKhUIYiiEFIAQgBSAefHwhBCAPIASFQhCKIQ8gCiAPfCEKIAUgCoVCP4ohBSABIAUgE3x8IQEgDSABhUIgiiENIAkgDXwhCSAFIAmFQhiKIQUgASAFIB18fCEBIA0gAYVCEIohDSAJIA18IQkgBSAJhUI/iiEFIAIgBiAXfHwhAiAOIAKFQiCKIQ4gCiAOfCEKIAYgCoVCGIohBiACIAYgG3x8IQIgDiAChUIQiiEOIAogDnwhCiAGIAqFQj+KIQYgAyAHIBF8fCEDIA8gA4VCIIohDyALIA98IQsgByALhUIYiiEHIAMgByAcfHwhAyAPIAOFQhCKIQ8gCyAPfCELIAcgC4VCP4ohByAEIAggGXx8IQQgECAEhUIgiiEQIAwgEHwhDCAIIAyFQhiKIQggBCAIIBR8fCEEIBAgBIVCEIohECAMIBB8IQwgCCAMhUI/iiEIIAEgBiAVfHwhASAQIAGFQiCKIRAgCyAQfCELIAYgC4VCGIohBiABIAYgHnx8IQEgECABhUIQiiEQIAsgEHwhCyAGIAuFQj+KIQYgAiAHIBh8fCECIA0gAoVCIIohDSAMIA18IQwgByAMhUIYiiEHIAIgByAWfHwhAiANIAKFQhCKIQ0gDCANfCEMIAcgDIVCP4ohByADIAggIHx8IQMgDiADhUIgiiEOIAkgDnwhCSAIIAmFQhiKIQggAyAIIB98fCEDIA4gA4VCEIohDiAJIA58IQkgCCAJhUI/iiEIIAQgBSASfHwhBCAPIASFQiCKIQ8gCiAPfCEKIAUgCoVCGIohBSAEIAUgGnx8IQQgDyAEhUIQiiEPIAogD3whCiAFIAqFQj+KIQUgASAFIB18fCEBIA0gAYVCIIohDSAJIA18IQkgBSAJhUIYiiEFIAEgBSAWfHwhASANIAGFQhCKIQ0gCSANfCEJIAUgCYVCP4ohBSACIAYgEnx8IQIgDiAChUIgiiEOIAogDnwhCiAGIAqFQhiKIQYgAiAGICB8fCECIA4gAoVCEIohDiAKIA58IQogBiAKhUI/iiEGIAMgByAffHwhAyAPIAOFQiCKIQ8gCyAPfCELIAcgC4VCGIohByADIAcgHnx8IQMgDyADhUIQiiEPIAsgD3whCyAHIAuFQj+KIQcgBCAIIBV8fCEEIBAgBIVCIIohECAMIBB8IQwgCCAMhUIYiiEIIAQgCCAbfHwhBCAQIASFQhCKIRAgDCAQfCEMIAggDIVCP4ohCCABIAYgEXx8IQEgECABhUIgiiEQIAsgEHwhCyAGIAuFQhiKIQYgASAGIBh8fCEBIBAgAYVCEIohECALIBB8IQsgBiALhUI/iiEGIAIgByAXfHwhAiANIAKFQiCKIQ0gDCANfCEMIAcgDIVCGIohByACIAcgFHx8IQIgDSAChUIQiiENIAwgDXwhDCAHIAyFQj+KIQcgAyAIIBp8fCEDIA4gA4VCIIohDiAJIA58IQkgCCAJhUIYiiEIIAMgCCATfHwhAyAOIAOFQhCKIQ4gCSAOfCEJIAggCYVCP4ohCCAEIAUgGXx8IQQgDyAEhUIgiiEPIAogD3whCiAFIAqFQhiKIQUgBCAFIBx8fCEEIA8gBIVCEIohDyAKIA98IQogBSAKhUI/iiEFIAEgBSAefHwhASANIAGFQiCKIQ0gCSANfCEJIAUgCYVCGIohBSABIAUgHHx8IQEgDSABhUIQiiENIAkgDXwhCSAFIAmFQj+KIQUgAiAGIBh8fCECIA4gAoVCIIohDiAKIA58IQogBiAKhUIYiiEGIAIgBiAffHwhAiAOIAKFQhCKIQ4gCiAOfCEKIAYgCoVCP4ohBiADIAcgHXx8IQMgDyADhUIgiiEPIAsgD3whCyAHIAuFQhiKIQcgAyAHIBJ8fCEDIA8gA4VCEIohDyALIA98IQsgByALhUI/iiEHIAQgCCAUfHwhBCAQIASFQiCKIRAgDCAQfCEMIAggDIVCGIohCCAEIAggGnx8IQQgECAEhUIQiiEQIAwgEHwhDCAIIAyFQj+KIQggASAGIBZ8fCEBIBAgAYVCIIohECALIBB8IQsgBiALhUIYiiEGIAEgBiARfHwhASAQIAGFQhCKIRAgCyAQfCELIAYgC4VCP4ohBiACIAcgIHx8IQIgDSAChUIgiiENIAwgDXwhDCAHIAyFQhiKIQcgAiAHIBV8fCECIA0gAoVCEIohDSAMIA18IQwgByAMhUI/iiEHIAMgCCAZfHwhAyAOIAOFQiCKIQ4gCSAOfCEJIAggCYVCGIohCCADIAggF3x8IQMgDiADhUIQiiEOIAkgDnwhCSAIIAmFQj+KIQggBCAFIBN8fCEEIA8gBIVCIIohDyAKIA98IQogBSAKhUIYiiEFIAQgBSAbfHwhBCAPIASFQhCKIQ8gCiAPfCEKIAUgCoVCP4ohBSABIAUgF3x8IQEgDSABhUIgiiENIAkgDXwhCSAFIAmFQhiKIQUgASAFICB8fCEBIA0gAYVCEIohDSAJIA18IQkgBSAJhUI/iiEFIAIgBiAffHwhAiAOIAKFQiCKIQ4gCiAOfCEKIAYgCoVCGIohBiACIAYgGnx8IQIgDiAChUIQiiEOIAogDnwhCiAGIAqFQj+KIQYgAyAHIBx8fCEDIA8gA4VCIIohDyALIA98IQsgByALhUIYiiEHIAMgByAUfHwhAyAPIAOFQhCKIQ8gCyAPfCELIAcgC4VCP4ohByAEIAggEXx8IQQgECAEhUIgiiEQIAwgEHwhDCAIIAyFQhiKIQggBCAIIBl8fCEEIBAgBIVCEIohECAMIBB8IQwgCCAMhUI/iiEIIAEgBiAdfHwhASAQIAGFQiCKIRAgCyAQfCELIAYgC4VCGIohBiABIAYgE3x8IQEgECABhUIQiiEQIAsgEHwhCyAGIAuFQj+KIQYgAiAHIB58fCECIA0gAoVCIIohDSAMIA18IQwgByAMhUIYiiEHIAIgByAYfHwhAiANIAKFQhCKIQ0gDCANfCEMIAcgDIVCP4ohByADIAggEnx8IQMgDiADhUIgiiEOIAkgDnwhCSAIIAmFQhiKIQggAyAIIBV8fCEDIA4gA4VCEIohDiAJIA58IQkgCCAJhUI/iiEIIAQgBSAbfHwhBCAPIASFQiCKIQ8gCiAPfCEKIAUgCoVCGIohBSAEIAUgFnx8IQQgDyAEhUIQiiEPIAogD3whCiAFIAqFQj+KIQUgASAFIBt8fCEBIA0gAYVCIIohDSAJIA18IQkgBSAJhUIYiiEFIAEgBSATfHwhASANIAGFQhCKIQ0gCSANfCEJIAUgCYVCP4ohBSACIAYgGXx8IQIgDiAChUIgiiEOIAogDnwhCiAGIAqFQhiKIQYgAiAGIBV8fCECIA4gAoVCEIohDiAKIA58IQogBiAKhUI/iiEGIAMgByAYfHwhAyAPIAOFQiCKIQ8gCyAPfCELIAcgC4VCGIohByADIAcgF3x8IQMgDyADhUIQiiEPIAsgD3whCyAHIAuFQj+KIQcgBCAIIBJ8fCEEIBAgBIVCIIohECAMIBB8IQwgCCAMhUIYiiEIIAQgCCAWfHwhBCAQIASFQhCKIRAgDCAQfCEMIAggDIVCP4ohCCABIAYgIHx8IQEgECABhUIgiiEQIAsgEHwhCyAGIAuFQhiKIQYgASAGIBx8fCEBIBAgAYVCEIohECALIBB8IQsgBiALhUI/iiEGIAIgByAafHwhAiANIAKFQiCKIQ0gDCANfCEMIAcgDIVCGIohByACIAcgH3x8IQIgDSAChUIQiiENIAwgDXwhDCAHIAyFQj+KIQcgAyAIIBR8fCEDIA4gA4VCIIohDiAJIA58IQkgCCAJhUIYiiEIIAMgCCAdfHwhAyAOIAOFQhCKIQ4gCSAOfCEJIAggCYVCP4ohCCAEIAUgHnx8IQQgDyAEhUIgiiEPIAogD3whCiAFIAqFQhiKIQUgBCAFIBF8fCEEIA8gBIVCEIohDyAKIA98IQogBSAKhUI/iiEFIAEgBSARfHwhASANIAGFQiCKIQ0gCSANfCEJIAUgCYVCGIohBSABIAUgEnx8IQEgDSABhUIQiiENIAkgDXwhCSAFIAmFQj+KIQUgAiAGIBN8fCECIA4gAoVCIIohDiAKIA58IQogBiAKhUIYiiEGIAIgBiAUfHwhAiAOIAKFQhCKIQ4gCiAOfCEKIAYgCoVCP4ohBiADIAcgFXx8IQMgDyADhUIgiiEPIAsgD3whCyAHIAuFQhiKIQcgAyAHIBZ8fCEDIA8gA4VCEIohDyALIA98IQsgByALhUI/iiEHIAQgCCAXfHwhBCAQIASFQiCKIRAgDCAQfCEMIAggDIVCGIohCCAEIAggGHx8IQQgECAEhUIQiiEQIAwgEHwhDCAIIAyFQj+KIQggASAGIBl8fCEBIBAgAYVCIIohECALIBB8IQsgBiALhUIYiiEGIAEgBiAafHwhASAQIAGFQhCKIRAgCyAQfCELIAYgC4VCP4ohBiACIAcgG3x8IQIgDSAChUIgiiENIAwgDXwhDCAHIAyFQhiKIQcgAiAHIBx8fCECIA0gAoVCEIohDSAMIA18IQwgByAMhUI/iiEHIAMgCCAdfHwhAyAOIAOFQiCKIQ4gCSAOfCEJIAggCYVCGIohCCADIAggHnx8IQMgDiADhUIQiiEOIAkgDnwhCSAIIAmFQj+KIQggBCAFIB98fCEEIA8gBIVCIIohDyAKIA98IQogBSAKhUIYiiEFIAQgBSAgfHwhBCAPIASFQhCKIQ8gCiAPfCEKIAUgCoVCP4ohBSABIAUgH3x8IQEgDSABhUIgiiENIAkgDXwhCSAFIAmFQhiKIQUgASAFIBt8fCEBIA0gAYVCEIohDSAJIA18IQkgBSAJhUI/iiEFIAIgBiAVfHwhAiAOIAKFQiCKIQ4gCiAOfCEKIAYgCoVCGIohBiACIAYgGXx8IQIgDiAChUIQiiEOIAogDnwhCiAGIAqFQj+KIQYgAyAHIBp8fCEDIA8gA4VCIIohDyALIA98IQsgByALhUIYiiEHIAMgByAgfHwhAyAPIAOFQhCKIQ8gCyAPfCELIAcgC4VCP4ohByAEIAggHnx8IQQgECAEhUIgiiEQIAwgEHwhDCAIIAyFQhiKIQggBCAIIBd8fCEEIBAgBIVCEIohECAMIBB8IQwgCCAMhUI/iiEIIAEgBiASfHwhASAQIAGFQiCKIRAgCyAQfCELIAYgC4VCGIohBiABIAYgHXx8IQEgECABhUIQiiEQIAsgEHwhCyAGIAuFQj+KIQYgAiAHIBF8fCECIA0gAoVCIIohDSAMIA18IQwgByAMhUIYiiEHIAIgByATfHwhAiANIAKFQhCKIQ0gDCANfCEMIAcgDIVCP4ohByADIAggHHx8IQMgDiADhUIgiiEOIAkgDnwhCSAIIAmFQhiKIQggAyAIIBh8fCEDIA4gA4VCEIohDiAJIA58IQkgCCAJhUI/iiEIIAQgBSAWfHwhBCAPIASFQiCKIQ8gCiAPfCEKIAUgCoVCGIohBSAEIAUgFHx8IQQgDyAEhUIQiiEPIAogD3whCiAFIAqFQj+KIQUgISAhKQMAIAEgCYWFNwMAICIgIikDACACIAqFhTcDACAjICMpAwAgAyALhYU3AwAgJCAkKQMAIAQgDIWFNwMAICUgJSkDACAFIA2FhTcDACAmICYpAwAgBiAOhYU3AwAgJyAnKQMAIAcgD4WFNwMAICggKCkDACAIIBCFhTcDAAs=")}}),n=r(),o=WebAssembly.compile(n);return blake2b=async s=>(await WebAssembly.instantiate(await o,s)).exports,blake2b}var assert$f=nanoassert,b4a$4=browserExports$2,wasm$6=null,wasmPromise=typeof WebAssembly<"u"&&requireBlake2b()().then(e=>{wasm$6=e}),head$2=64,freeList$1=[];blake2bWasm.exports=Blake2b$1;var BYTES_MIN$1=blake2bWasm.exports.BYTES_MIN=16,BYTES_MAX$1=blake2bWasm.exports.BYTES_MAX=64;blake2bWasm.exports.BYTES=32;var KEYBYTES_MIN$1=blake2bWasm.exports.KEYBYTES_MIN=16,KEYBYTES_MAX$1=blake2bWasm.exports.KEYBYTES_MAX=64;blake2bWasm.exports.KEYBYTES=32;var SALTBYTES$1=blake2bWasm.exports.SALTBYTES=16,PERSONALBYTES$1=blake2bWasm.exports.PERSONALBYTES=16;function Blake2b$1(e,t,r,n,o){if(!(this instanceof Blake2b$1))return new Blake2b$1(e,t,r,n,o);if(!wasm$6)throw new Error("WASM not loaded. Wait for Blake2b.ready(cb)");e||(e=32),o!==!0&&(assert$f(e>=BYTES_MIN$1,"digestLength must be at least "+BYTES_MIN$1+", was given "+e),assert$f(e<=BYTES_MAX$1,"digestLength must be at most "+BYTES_MAX$1+", was given "+e),t!=null&&(assert$f(t instanceof Uint8Array,"key must be Uint8Array or Buffer"),assert$f(t.length>=KEYBYTES_MIN$1,"key must be at least "+KEYBYTES_MIN$1+", was given "+t.length),assert$f(t.length<=KEYBYTES_MAX$1,"key must be at least "+KEYBYTES_MAX$1+", was given "+t.length)),r!=null&&(assert$f(r instanceof Uint8Array,"salt must be Uint8Array or Buffer"),assert$f(r.length===SALTBYTES$1,"salt must be exactly "+SALTBYTES$1+", was given "+r.length)),n!=null&&(assert$f(n instanceof Uint8Array,"personal must be Uint8Array or Buffer"),assert$f(n.length===PERSONALBYTES$1,"personal must be exactly "+PERSONALBYTES$1+", was given "+n.length))),freeList$1.length||(freeList$1.push(head$2),head$2+=216),this.digestLength=e,this.finalized=!1,this.pointer=freeList$1.pop(),this._memory=new Uint8Array(wasm$6.memory.buffer),this._memory.fill(0,0,64),this._memory[0]=this.digestLength,this._memory[1]=t?t.length:0,this._memory[2]=1,this._memory[3]=1,r&&this._memory.set(r,32),n&&this._memory.set(n,48),this.pointer+216>this._memory.length&&this._realloc(this.pointer+216),wasm$6.blake2b_init(this.pointer,this.digestLength),t&&(this.update(t),this._memory.fill(0,head$2,head$2+t.length),this._memory[this.pointer+200]=128)}Blake2b$1.prototype._realloc=function(e){wasm$6.memory.grow(Math.max(0,Math.ceil(Math.abs(e-this._memory.length)/65536))),this._memory=new Uint8Array(wasm$6.memory.buffer)},Blake2b$1.prototype.update=function(e){return assert$f(this.finalized===!1,"Hash instance finalized"),assert$f(e instanceof Uint8Array,"input must be Uint8Array or Buffer"),head$2+e.length>this._memory.length&&this._realloc(head$2+e.length),this._memory.set(e,head$2),wasm$6.blake2b_update(this.pointer,head$2,head$2+e.length),this},Blake2b$1.prototype.digest=function(e){if(assert$f(this.finalized===!1,"Hash instance finalized"),this.finalized=!0,freeList$1.push(this.pointer),wasm$6.blake2b_final(this.pointer),!e||e==="binary")return this._memory.slice(this.pointer+128,this.pointer+128+this.digestLength);if(typeof e=="string")return b4a$4.toString(this._memory,e,this.pointer+128,this.pointer+128+this.digestLength);assert$f(e instanceof Uint8Array&&e.length>=this.digestLength,"input must be Uint8Array or Buffer");for(var t=0;t<this.digestLength;t++)e[t]=this._memory[this.pointer+128+t];return e},Blake2b$1.prototype.final=Blake2b$1.prototype.digest,Blake2b$1.WASM=wasm$6,Blake2b$1.SUPPORTED=typeof WebAssembly<"u",Blake2b$1.ready=function(e){return e||(e=noop$4),wasmPromise?wasmPromise.then(()=>e(),e):e(new Error("WebAssembly not supported"))},Blake2b$1.prototype.ready=Blake2b$1.ready,Blake2b$1.prototype.getPartialHash=function(){return this._memory.slice(this.pointer,this.pointer+216)},Blake2b$1.prototype.setPartialHash=function(e){this._memory.set(e,this.pointer)};function noop$4(){}var blake2bWasmExports=blake2bWasm.exports,assert$e=nanoassert,b2wasm=blake2bWasmExports;function ADD64AA(e,t,r){var n=e[t]+e[r],o=e[t+1]+e[r+1];n>=4294967296&&o++,e[t]=n,e[t+1]=o}function ADD64AC(e,t,r,n){var o=e[t]+r;r<0&&(o+=4294967296);var s=e[t+1]+n;o>=4294967296&&s++,e[t]=o,e[t+1]=s}function B2B_GET32(e,t){return e[t]^e[t+1]<<8^e[t+2]<<16^e[t+3]<<24}function B2B_G(e,t,r,n,o,s){var a=m[o],c=m[o+1],l=m[s],h=m[s+1];ADD64AA(v,e,t),ADD64AC(v,e,a,c);var u=v[n]^v[e],d=v[n+1]^v[e+1];v[n]=d,v[n+1]=u,ADD64AA(v,r,n),u=v[t]^v[r],d=v[t+1]^v[r+1],v[t]=u>>>24^d<<8,v[t+1]=d>>>24^u<<8,ADD64AA(v,e,t),ADD64AC(v,e,l,h),u=v[n]^v[e],d=v[n+1]^v[e+1],v[n]=u>>>16^d<<16,v[n+1]=d>>>16^u<<16,ADD64AA(v,r,n),u=v[t]^v[r],d=v[t+1]^v[r+1],v[t]=d>>>31^u<<1,v[t+1]=u>>>31^d<<1}var BLAKE2B_IV32=new Uint32Array([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),SIGMA8=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3],SIGMA82=new Uint8Array(SIGMA8.map(function(e){return e*2})),v=new Uint32Array(32),m=new Uint32Array(32);function blake2bCompress(e,t){var r=0;for(r=0;r<16;r++)v[r]=e.h[r],v[r+16]=BLAKE2B_IV32[r];for(v[24]=v[24]^e.t,v[25]=v[25]^e.t/4294967296,t&&(v[28]=~v[28],v[29]=~v[29]),r=0;r<32;r++)m[r]=B2B_GET32(e.b,4*r);for(r=0;r<12;r++)B2B_G(0,8,16,24,SIGMA82[r*16+0],SIGMA82[r*16+1]),B2B_G(2,10,18,26,SIGMA82[r*16+2],SIGMA82[r*16+3]),B2B_G(4,12,20,28,SIGMA82[r*16+4],SIGMA82[r*16+5]),B2B_G(6,14,22,30,SIGMA82[r*16+6],SIGMA82[r*16+7]),B2B_G(0,10,20,30,SIGMA82[r*16+8],SIGMA82[r*16+9]),B2B_G(2,12,22,24,SIGMA82[r*16+10],SIGMA82[r*16+11]),B2B_G(4,14,16,26,SIGMA82[r*16+12],SIGMA82[r*16+13]),B2B_G(6,8,18,28,SIGMA82[r*16+14],SIGMA82[r*16+15]);for(r=0;r<16;r++)e.h[r]=e.h[r]^v[r]^v[r+16]}var parameter_block=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function Blake2b(e,t,r,n){parameter_block.fill(0),this.b=new Uint8Array(128),this.h=new Uint32Array(16),this.t=0,this.c=0,this.outlen=e,parameter_block[0]=e,t&&(parameter_block[1]=t.length),parameter_block[2]=1,parameter_block[3]=1,r&&parameter_block.set(r,32),n&&parameter_block.set(n,48);for(var o=0;o<16;o++)this.h[o]=BLAKE2B_IV32[o]^B2B_GET32(parameter_block,o*4);t&&(blake2bUpdate(this,t),this.c=128)}Blake2b.prototype.update=function(e){return assert$e(e instanceof Uint8Array,"input must be Uint8Array or Buffer"),blake2bUpdate(this,e),this},Blake2b.prototype.digest=function(e){var t=!e||e==="binary"||e==="hex"?new Uint8Array(this.outlen):e;return assert$e(t instanceof Uint8Array,'out must be "binary", "hex", Uint8Array, or Buffer'),assert$e(t.length>=this.outlen,"out must have at least outlen bytes of space"),blake2bFinal(this,t),e==="hex"?hexSlice(t):t},Blake2b.prototype.final=Blake2b.prototype.digest,Blake2b.ready=function(e){b2wasm.ready(function(){e()})};function blake2bUpdate(e,t){for(var r=0;r<t.length;r++)e.c===128&&(e.t+=e.c,blake2bCompress(e,!1),e.c=0),e.b[e.c++]=t[r]}function blake2bFinal(e,t){for(e.t+=e.c;e.c<128;)e.b[e.c++]=0;blake2bCompress(e,!0);for(var r=0;r<e.outlen;r++)t[r]=e.h[r>>2]>>8*(r&3);return t}function hexSlice(e){for(var t="",r=0;r<e.length;r++)t+=toHex(e[r]);return t}function toHex(e){return e<16?"0"+e.toString(16):e.toString(16)}var Proto$1=Blake2b;blake2b$1.exports=function e(t,r,n,o,s){return s!==!0&&(assert$e(t>=BYTES_MIN,"outlen must be at least "+BYTES_MIN+", was given "+t),assert$e(t<=BYTES_MAX,"outlen must be at most "+BYTES_MAX+", was given "+t),r!=null&&(assert$e(r instanceof Uint8Array,"key must be Uint8Array or Buffer"),assert$e(r.length>=KEYBYTES_MIN,"key must be at least "+KEYBYTES_MIN+", was given "+r.length),assert$e(r.length<=KEYBYTES_MAX,"key must be at most "+KEYBYTES_MAX+", was given "+r.length)),n!=null&&(assert$e(n instanceof Uint8Array,"salt must be Uint8Array or Buffer"),assert$e(n.length===SALTBYTES,"salt must be exactly "+SALTBYTES+", was given "+n.length)),o!=null&&(assert$e(o instanceof Uint8Array,"personal must be Uint8Array or Buffer"),assert$e(o.length===PERSONALBYTES,"personal must be exactly "+PERSONALBYTES+", was given "+o.length))),new Proto$1(t,r,n,o)},blake2b$1.exports.ready=function(e){b2wasm.ready(function(){e()})},blake2b$1.exports.WASM_SUPPORTED=b2wasm.SUPPORTED,blake2b$1.exports.WASM_LOADED=!1;var BYTES_MIN=blake2b$1.exports.BYTES_MIN=16,BYTES_MAX=blake2b$1.exports.BYTES_MAX=64;blake2b$1.exports.BYTES=32;var KEYBYTES_MIN=blake2b$1.exports.KEYBYTES_MIN=16,KEYBYTES_MAX=blake2b$1.exports.KEYBYTES_MAX=64;blake2b$1.exports.KEYBYTES=32;var SALTBYTES=blake2b$1.exports.SALTBYTES=16,PERSONALBYTES=blake2b$1.exports.PERSONALBYTES=16;b2wasm.ready(function(e){e||(blake2b$1.exports.WASM_LOADED=!0,blake2b$1.exports=b2wasm)});var blake2bExports=blake2b$1.exports;(function(e){var t=blake2bExports;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");e.exports.crypto_generichash_PRIMITIVE="blake2b",e.exports.crypto_generichash_BYTES_MIN=t.BYTES_MIN,e.exports.crypto_generichash_BYTES_MAX=t.BYTES_MAX,e.exports.crypto_generichash_BYTES=t.BYTES,e.exports.crypto_generichash_KEYBYTES_MIN=t.KEYBYTES_MIN,e.exports.crypto_generichash_KEYBYTES_MAX=t.KEYBYTES_MAX,e.exports.crypto_generichash_KEYBYTES=t.KEYBYTES,e.exports.crypto_generichash_WASM_SUPPORTED=t.WASM_SUPPORTED,e.exports.crypto_generichash_WASM_LOADED=!1,e.exports.crypto_generichash=function(r,n,o){t(r.length,o).update(n).final(r)},e.exports.crypto_generichash_ready=t.ready,e.exports.crypto_generichash_batch=function(r,n,o){for(var s=t(r.length,o),a=0;a<n.length;a++)s.update(n[a]);s.final(r)},e.exports.crypto_generichash_instance=function(r,n){return n==null&&(n=e.exports.crypto_generichash_BYTES),t(n,r)},t.ready(function(r){e.exports.crypto_generichash_WASM_LOADED=t.WASM_LOADED})})(crypto_generichash$3);var crypto_generichashExports=crypto_generichash$3.exports,crypto_stream$1={},xsalsa20$2,hasRequiredXsalsa20;function requireXsalsa20(){if(hasRequiredXsalsa20)return xsalsa20$2;hasRequiredXsalsa20=1;var e=(s,a)=>function(){return a||(0,s[Object.keys(s)[0]])((a={exports:{}}).exports,a),a.exports},t=(()=>{for(var s=new Uint8Array(128),a=0;a<64;a++)s[a<26?a+65:a<52?a+71:a<62?a-4:a*4-205]=a;return c=>{for(var l=c.length,h=new Uint8Array((l-(c[l-1]=="=")-(c[l-2]=="="))*3/4|0),u=0,d=0;u<l;){var f=s[c.charCodeAt(u++)],_=s[c.charCodeAt(u++)],p=s[c.charCodeAt(u++)],y=s[c.charCodeAt(u++)];h[d++]=f<<2|_>>4,h[d++]=_<<4|p>>2,h[d++]=p<<6|y}return h}})(),r=e({"wasm-binary:./xsalsa20.wat"(s,a){a.exports=t("AGFzbQEAAAABGgNgBn9/f39/fwBgBn9/f39+fwF+YAN/f38AAwcGAAEBAgICBQUBAQroBwcoAwZtZW1vcnkCAAx4c2Fsc2EyMF94b3IAAAxjb3JlX3NhbHNhMjAABArqEQYYACAAIAEgAiADIAQgACkDACAFEAE3AwALPQBB8AAgAyAFEAMgACABIAIgA0EQaiAEQfAAEAJB8ABCADcDAEH4AEIANwMAQYABQgA3AwBBiAFCADcDAAuHBQEBfyACQQBGBEBCAA8LQdAAIAUpAwA3AwBB2AAgBUEIaikDADcDAEHgACAFQRBqKQMANwMAQegAIAVBGGopAwA3AwBBACADKQMANwMAQQggBDcDAAJAA0AgAkHAAEkNAUEQQQBB0AAQBSAAIAEpAwBBECkDAIU3AwAgAEEIaiABQQhqKQMAQRgpAwCFNwMAIABBEGogAUEQaikDAEEgKQMAhTcDACAAQRhqIAFBGGopAwBBKCkDAIU3AwAgAEEgaiABQSBqKQMAQTApAwCFNwMAIABBKGogAUEoaikDAEE4KQMAhTcDACAAQTBqIAFBMGopAwBBwAApAwCFNwMAIABBOGogAUE4aikDAEHIACkDAIU3AwBBCEEIKQMAQgF8NwMAIABBwABqIQAgAUHAAGohASACQcAAayECDAALC0EIKQMAIQQgAkEASwRAQRBBAEHQABAFAkACQAJAAkACQAJAAkACQCACQQhuDgcHBgUEAwIBAAsgAEE4aiABQThqKQMAQcgAKQMAhTcDAAsgAEEwaiABQTBqKQMAQcAAKQMAhTcDAAsgAEEoaiABQShqKQMAQTgpAwCFNwMACyAAQSBqIAFBIGopAwBBMCkDAIU3AwALIABBGGogAUEYaikDAEEoKQMAhTcDAAsgAEEQaiABQRBqKQMAQSApAwCFNwMACyAAQQhqIAFBCGopAwBBGCkDAIU3AwALIAAgASkDAEEQKQMAhTcDAAtBEEIANwMAQRhCADcDAEEgQgA3AwBBKEIANwMAQTBCADcDAEE4QgA3AwBBwABCADcDAEHIAEIANwMAQdAAQgA3AwBB2ABCADcDAEHgAEIANwMAQegAQgA3AwAgBA8LnQUBEX9B5fDBiwYhA0HuyIGZAyEIQbLaiMsHIQ1B9MqB2QYhEiACKAIAIQQgAkEEaigCACEFIAJBCGooAgAhBiACQQxqKAIAIQcgAkEQaigCACEOIAJBFGooAgAhDyACQRhqKAIAIRAgAkEcaigCACERIAEoAgAhCSABQQRqKAIAIQogAUEIaigCACELIAFBDGooAgAhDEEUIRMCQANAIBNBAEYNASAHIAMgD2pBB3dzIQcgCyAHIANqQQl3cyELIA8gCyAHakENd3MhDyADIA8gC2pBEndzIQMgDCAIIARqQQd3cyEMIBAgDCAIakEJd3MhECAEIBAgDGpBDXdzIQQgCCAEIBBqQRJ3cyEIIBEgDSAJakEHd3MhESAFIBEgDWpBCXdzIQUgCSAFIBFqQQ13cyEJIA0gCSAFakESd3MhDSAGIBIgDmpBB3dzIQYgCiAGIBJqQQl3cyEKIA4gCiAGakENd3MhDiASIA4gCmpBEndzIRIgBCADIAZqQQd3cyEEIAUgBCADakEJd3MhBSAGIAUgBGpBDXdzIQYgAyAGIAVqQRJ3cyEDIAkgCCAHakEHd3MhCSAKIAkgCGpBCXdzIQogByAKIAlqQQ13cyEHIAggByAKakESd3MhCCAOIA0gDGpBB3dzIQ4gCyAOIA1qQQl3cyELIAwgCyAOakENd3MhDCANIAwgC2pBEndzIQ0gDyASIBFqQQd3cyEPIBAgDyASakEJd3MhECARIBAgD2pBDXdzIREgEiARIBBqQRJ3cyESIBNBAmshEwwACwsgACADNgIAIABBBGogCDYCACAAQQhqIA02AgAgAEEMaiASNgIAIABBEGogCTYCACAAQRRqIAo2AgAgAEEYaiALNgIAIABBHGogDDYCAAsKACAAIAEgAhAFC90GASF/QeXwwYsGIQNB7siBmQMhCEGy2ojLByENQfTKgdkGIRIgAigCACEEIAJBBGooAgAhBSACQQhqKAIAIQYgAkEMaigCACEHIAJBEGooAgAhDiACQRRqKAIAIQ8gAkEYaigCACEQIAJBHGooAgAhESABKAIAIQkgAUEEaigCACEKIAFBCGooAgAhCyABQQxqKAIAIQwgAyETIAQhFCAFIRUgBiEWIAchFyAIIRggCSEZIAohGiALIRsgDCEcIA0hHSAOIR4gDyEfIBAhICARISEgEiEiQRQhIwJAA0AgI0EARg0BIAcgAyAPakEHd3MhByALIAcgA2pBCXdzIQsgDyALIAdqQQ13cyEPIAMgDyALakESd3MhAyAMIAggBGpBB3dzIQwgECAMIAhqQQl3cyEQIAQgECAMakENd3MhBCAIIAQgEGpBEndzIQggESANIAlqQQd3cyERIAUgESANakEJd3MhBSAJIAUgEWpBDXdzIQkgDSAJIAVqQRJ3cyENIAYgEiAOakEHd3MhBiAKIAYgEmpBCXdzIQogDiAKIAZqQQ13cyEOIBIgDiAKakESd3MhEiAEIAMgBmpBB3dzIQQgBSAEIANqQQl3cyEFIAYgBSAEakENd3MhBiADIAYgBWpBEndzIQMgCSAIIAdqQQd3cyEJIAogCSAIakEJd3MhCiAHIAogCWpBDXdzIQcgCCAHIApqQRJ3cyEIIA4gDSAMakEHd3MhDiALIA4gDWpBCXdzIQsgDCALIA5qQQ13cyEMIA0gDCALakESd3MhDSAPIBIgEWpBB3dzIQ8gECAPIBJqQQl3cyEQIBEgECAPakENd3MhESASIBEgEGpBEndzIRIgI0ECayEjDAALCyAAIAMgE2o2AgAgAEEEaiAEIBRqNgIAIABBCGogBSAVajYCACAAQQxqIAYgFmo2AgAgAEEQaiAHIBdqNgIAIABBFGogCCAYajYCACAAQRhqIAkgGWo2AgAgAEEcaiAKIBpqNgIAIABBIGogCyAbajYCACAAQSRqIAwgHGo2AgAgAEEoaiANIB1qNgIAIABBLGogDiAeajYCACAAQTBqIA8gH2o2AgAgAEE0aiAQICBqNgIAIABBOGogESAhajYCACAAQTxqIBIgImo2AgAL")}}),n=r(),o=new WebAssembly.Module(n);return xsalsa20$2=s=>new WebAssembly.Instance(o,s).exports,xsalsa20$2}var xsalsa20$1=typeof WebAssembly<"u"&&requireXsalsa20()(),SIGMA=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]),head$1=144,top=head$1,free$1=[],xsalsa20_1=XSalsa20;XSalsa20.NONCEBYTES=24,XSalsa20.KEYBYTES=32,XSalsa20.core_hsalsa20=core_hsalsa20,XSalsa20.SIGMA=SIGMA;function XSalsa20(e,t){if(!(this instanceof XSalsa20))return new XSalsa20(e,t);if(!e||e.length<24)throw new Error("nonce must be at least 24 bytes");if(!t||t.length<32)throw new Error("key must be at least 32 bytes");this._xor=xsalsa20$1?new WASM(e,t):new Fallback(e,t)}XSalsa20.prototype.update=function(e,t){if(!e)throw new Error("input must be Uint8Array or Buffer");return t||(t=new Uint8Array(e.length)),e.length&&this._xor.update(e,t),t},XSalsa20.prototype.final=XSalsa20.prototype.finalize=function(){this._xor.finalize(),this._xor=null};function WASM(e,t){free$1.length||(free$1.push(head$1),head$1+=64),this._pointer=free$1.pop(),this._nonce=this._pointer+8,this._key=this._nonce+24,this._overflow=0,this._memory=new Uint8Array(xsalsa20$1.memory.buffer),this._memory.fill(0,this._pointer,this._pointer+8),this._memory.set(e,this._nonce),this._memory.set(t,this._key)}WASM.prototype.realloc=function(e){xsalsa20$1.memory.grow(Math.ceil(Math.abs(e-this._memory.length)/65536)),this._memory=new Uint8Array(xsalsa20$1.memory.buffer)},WASM.prototype.update=function(e,t){var r=this._overflow+e.length,n=head$1+this._overflow;top=head$1+r,top>=this._memory.length&&this.realloc(top),this._memory.set(e,n),xsalsa20$1.xsalsa20_xor(this._pointer,head$1,head$1,r,this._nonce,this._key),t.set(this._memory.subarray(n,head$1+r)),this._overflow=r&63},WASM.prototype.finalize=function(){this._memory.fill(0,this._pointer,this._key+32),top>head$1&&(this._memory.fill(0,head$1,top),top=0),free$1.push(this._pointer)};function Fallback(e,t){this._s=new Uint8Array(32),this._z=new Uint8Array(16),this._overflow=0,core_hsalsa20(this._s,e,t,SIGMA);for(var r=0;r<8;r++)this._z[r]=e[r+16]}Fallback.prototype.update=function(e,t){for(var r=new Uint8Array(64),n=0,o=this._overflow,s=e.length+this._overflow,a=this._z,c=-this._overflow,l=-this._overflow;s>=64;){for(core_salsa20(r,a,this._s,SIGMA);o<64;o++)t[l+o]=e[c+o]^r[o];for(n=1,o=8;o<16;o++)n+=a[o]&255|0,a[o]=n&255,n>>>=8;s-=64,l+=64,c+=64,o=0}if(s>0)for(core_salsa20(r,a,this._s,SIGMA);o<s;o++)t[l+o]=e[c+o]^r[o];this._overflow=s&63},Fallback.prototype.finalize=function(){this._s.fill(0),this._z.fill(0)};function core_salsa20(e,t,r,n){for(var o=n[0]&255|(n[1]&255)<<8|(n[2]&255)<<16|(n[3]&255)<<24,s=r[0]&255|(r[1]&255)<<8|(r[2]&255)<<16|(r[3]&255)<<24,a=r[4]&255|(r[5]&255)<<8|(r[6]&255)<<16|(r[7]&255)<<24,c=r[8]&255|(r[9]&255)<<8|(r[10]&255)<<16|(r[11]&255)<<24,l=r[12]&255|(r[13]&255)<<8|(r[14]&255)<<16|(r[15]&255)<<24,h=n[4]&255|(n[5]&255)<<8|(n[6]&255)<<16|(n[7]&255)<<24,u=t[0]&255|(t[1]&255)<<8|(t[2]&255)<<16|(t[3]&255)<<24,d=t[4]&255|(t[5]&255)<<8|(t[6]&255)<<16|(t[7]&255)<<24,f=t[8]&255|(t[9]&255)<<8|(t[10]&255)<<16|(t[11]&255)<<24,_=t[12]&255|(t[13]&255)<<8|(t[14]&255)<<16|(t[15]&255)<<24,p=n[8]&255|(n[9]&255)<<8|(n[10]&255)<<16|(n[11]&255)<<24,y=r[16]&255|(r[17]&255)<<8|(r[18]&255)<<16|(r[19]&255)<<24,w=r[20]&255|(r[21]&255)<<8|(r[22]&255)<<16|(r[23]&255)<<24,E=r[24]&255|(r[25]&255)<<8|(r[26]&255)<<16|(r[27]&255)<<24,x=r[28]&255|(r[29]&255)<<8|(r[30]&255)<<16|(r[31]&255)<<24,B=n[12]&255|(n[13]&255)<<8|(n[14]&255)<<16|(n[15]&255)<<24,P=o,U=s,F=a,G=c,H=l,te=h,J=u,le=d,z=f,q=_,he=p,V=y,_e=w,ee=E,W=x,re=B,ne,ge=0;ge<20;ge+=2)ne=P+_e|0,H^=ne<<7|ne>>>25,ne=H+P|0,z^=ne<<9|ne>>>23,ne=z+H|0,_e^=ne<<13|ne>>>19,ne=_e+z|0,P^=ne<<18|ne>>>14,ne=te+U|0,q^=ne<<7|ne>>>25,ne=q+te|0,ee^=ne<<9|ne>>>23,ne=ee+q|0,U^=ne<<13|ne>>>19,ne=U+ee|0,te^=ne<<18|ne>>>14,ne=he+J|0,W^=ne<<7|ne>>>25,ne=W+he|0,F^=ne<<9|ne>>>23,ne=F+W|0,J^=ne<<13|ne>>>19,ne=J+F|0,he^=ne<<18|ne>>>14,ne=re+V|0,G^=ne<<7|ne>>>25,ne=G+re|0,le^=ne<<9|ne>>>23,ne=le+G|0,V^=ne<<13|ne>>>19,ne=V+le|0,re^=ne<<18|ne>>>14,ne=P+G|0,U^=ne<<7|ne>>>25,ne=U+P|0,F^=ne<<9|ne>>>23,ne=F+U|0,G^=ne<<13|ne>>>19,ne=G+F|0,P^=ne<<18|ne>>>14,ne=te+H|0,J^=ne<<7|ne>>>25,ne=J+te|0,le^=ne<<9|ne>>>23,ne=le+J|0,H^=ne<<13|ne>>>19,ne=H+le|0,te^=ne<<18|ne>>>14,ne=he+q|0,V^=ne<<7|ne>>>25,ne=V+he|0,z^=ne<<9|ne>>>23,ne=z+V|0,q^=ne<<13|ne>>>19,ne=q+z|0,he^=ne<<18|ne>>>14,ne=re+W|0,_e^=ne<<7|ne>>>25,ne=_e+re|0,ee^=ne<<9|ne>>>23,ne=ee+_e|0,W^=ne<<13|ne>>>19,ne=W+ee|0,re^=ne<<18|ne>>>14;P=P+o|0,U=U+s|0,F=F+a|0,G=G+c|0,H=H+l|0,te=te+h|0,J=J+u|0,le=le+d|0,z=z+f|0,q=q+_|0,he=he+p|0,V=V+y|0,_e=_e+w|0,ee=ee+E|0,W=W+x|0,re=re+B|0,e[0]=P>>>0&255,e[1]=P>>>8&255,e[2]=P>>>16&255,e[3]=P>>>24&255,e[4]=U>>>0&255,e[5]=U>>>8&255,e[6]=U>>>16&255,e[7]=U>>>24&255,e[8]=F>>>0&255,e[9]=F>>>8&255,e[10]=F>>>16&255,e[11]=F>>>24&255,e[12]=G>>>0&255,e[13]=G>>>8&255,e[14]=G>>>16&255,e[15]=G>>>24&255,e[16]=H>>>0&255,e[17]=H>>>8&255,e[18]=H>>>16&255,e[19]=H>>>24&255,e[20]=te>>>0&255,e[21]=te>>>8&255,e[22]=te>>>16&255,e[23]=te>>>24&255,e[24]=J>>>0&255,e[25]=J>>>8&255,e[26]=J>>>16&255,e[27]=J>>>24&255,e[28]=le>>>0&255,e[29]=le>>>8&255,e[30]=le>>>16&255,e[31]=le>>>24&255,e[32]=z>>>0&255,e[33]=z>>>8&255,e[34]=z>>>16&255,e[35]=z>>>24&255,e[36]=q>>>0&255,e[37]=q>>>8&255,e[38]=q>>>16&255,e[39]=q>>>24&255,e[40]=he>>>0&255,e[41]=he>>>8&255,e[42]=he>>>16&255,e[43]=he>>>24&255,e[44]=V>>>0&255,e[45]=V>>>8&255,e[46]=V>>>16&255,e[47]=V>>>24&255,e[48]=_e>>>0&255,e[49]=_e>>>8&255,e[50]=_e>>>16&255,e[51]=_e>>>24&255,e[52]=ee>>>0&255,e[53]=ee>>>8&255,e[54]=ee>>>16&255,e[55]=ee>>>24&255,e[56]=W>>>0&255,e[57]=W>>>8&255,e[58]=W>>>16&255,e[59]=W>>>24&255,e[60]=re>>>0&255,e[61]=re>>>8&255,e[62]=re>>>16&255,e[63]=re>>>24&255}function core_hsalsa20(e,t,r,n){for(var o=n[0]&255|(n[1]&255)<<8|(n[2]&255)<<16|(n[3]&255)<<24,s=r[0]&255|(r[1]&255)<<8|(r[2]&255)<<16|(r[3]&255)<<24,a=r[4]&255|(r[5]&255)<<8|(r[6]&255)<<16|(r[7]&255)<<24,c=r[8]&255|(r[9]&255)<<8|(r[10]&255)<<16|(r[11]&255)<<24,l=r[12]&255|(r[13]&255)<<8|(r[14]&255)<<16|(r[15]&255)<<24,h=n[4]&255|(n[5]&255)<<8|(n[6]&255)<<16|(n[7]&255)<<24,u=t[0]&255|(t[1]&255)<<8|(t[2]&255)<<16|(t[3]&255)<<24,d=t[4]&255|(t[5]&255)<<8|(t[6]&255)<<16|(t[7]&255)<<24,f=t[8]&255|(t[9]&255)<<8|(t[10]&255)<<16|(t[11]&255)<<24,_=t[12]&255|(t[13]&255)<<8|(t[14]&255)<<16|(t[15]&255)<<24,p=n[8]&255|(n[9]&255)<<8|(n[10]&255)<<16|(n[11]&255)<<24,y=r[16]&255|(r[17]&255)<<8|(r[18]&255)<<16|(r[19]&255)<<24,w=r[20]&255|(r[21]&255)<<8|(r[22]&255)<<16|(r[23]&255)<<24,E=r[24]&255|(r[25]&255)<<8|(r[26]&255)<<16|(r[27]&255)<<24,x=r[28]&255|(r[29]&255)<<8|(r[30]&255)<<16|(r[31]&255)<<24,B=n[12]&255|(n[13]&255)<<8|(n[14]&255)<<16|(n[15]&255)<<24,P=o,U=s,F=a,G=c,H=l,te=h,J=u,le=d,z=f,q=_,he=p,V=y,_e=w,ee=E,W=x,re=B,ne,ge=0;ge<20;ge+=2)ne=P+_e|0,H^=ne<<7|ne>>>25,ne=H+P|0,z^=ne<<9|ne>>>23,ne=z+H|0,_e^=ne<<13|ne>>>19,ne=_e+z|0,P^=ne<<18|ne>>>14,ne=te+U|0,q^=ne<<7|ne>>>25,ne=q+te|0,ee^=ne<<9|ne>>>23,ne=ee+q|0,U^=ne<<13|ne>>>19,ne=U+ee|0,te^=ne<<18|ne>>>14,ne=he+J|0,W^=ne<<7|ne>>>25,ne=W+he|0,F^=ne<<9|ne>>>23,ne=F+W|0,J^=ne<<13|ne>>>19,ne=J+F|0,he^=ne<<18|ne>>>14,ne=re+V|0,G^=ne<<7|ne>>>25,ne=G+re|0,le^=ne<<9|ne>>>23,ne=le+G|0,V^=ne<<13|ne>>>19,ne=V+le|0,re^=ne<<18|ne>>>14,ne=P+G|0,U^=ne<<7|ne>>>25,ne=U+P|0,F^=ne<<9|ne>>>23,ne=F+U|0,G^=ne<<13|ne>>>19,ne=G+F|0,P^=ne<<18|ne>>>14,ne=te+H|0,J^=ne<<7|ne>>>25,ne=J+te|0,le^=ne<<9|ne>>>23,ne=le+J|0,H^=ne<<13|ne>>>19,ne=H+le|0,te^=ne<<18|ne>>>14,ne=he+q|0,V^=ne<<7|ne>>>25,ne=V+he|0,z^=ne<<9|ne>>>23,ne=z+V|0,q^=ne<<13|ne>>>19,ne=q+z|0,he^=ne<<18|ne>>>14,ne=re+W|0,_e^=ne<<7|ne>>>25,ne=_e+re|0,ee^=ne<<9|ne>>>23,ne=ee+_e|0,W^=ne<<13|ne>>>19,ne=W+ee|0,re^=ne<<18|ne>>>14;e[0]=P>>>0&255,e[1]=P>>>8&255,e[2]=P>>>16&255,e[3]=P>>>24&255,e[4]=te>>>0&255,e[5]=te>>>8&255,e[6]=te>>>16&255,e[7]=te>>>24&255,e[8]=he>>>0&255,e[9]=he>>>8&255,e[10]=he>>>16&255,e[11]=he>>>24&255,e[12]=re>>>0&255,e[13]=re>>>8&255,e[14]=re>>>16&255,e[15]=re>>>24&255,e[16]=J>>>0&255,e[17]=J>>>8&255,e[18]=J>>>16&255,e[19]=J>>>24&255,e[20]=le>>>0&255,e[21]=le>>>8&255,e[22]=le>>>16&255,e[23]=le>>>24&255,e[24]=z>>>0&255,e[25]=z>>>8&255,e[26]=z>>>16&255,e[27]=z>>>24&255,e[28]=q>>>0&255,e[29]=q>>>8&255,e[30]=q>>>16&255,e[31]=q>>>24&255}if(function(e){const t=xsalsa20_1;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");e.crypto_stream_KEYBYTES=32,e.crypto_stream_NONCEBYTES=24,e.crypto_stream_PRIMITIVE="xsalsa20",e.crypto_stream_xsalsa20_MESSAGEBYTES_MAX=Number.MAX_SAFE_INTEGER,e.crypto_stream=function(n,o,s){n.fill(0),e.crypto_stream_xor(n,n,o,s)},e.crypto_stream_xor=function(n,o,s,a){const c=t(s,a);c.update(o,n),c.final()},e.crypto_stream_xor_instance=function(n,o){return new r(n,o)};function r(n,o){this._instance=t(n,o)}r.prototype.update=function(n,o){this._instance.update(o,n)},r.prototype.final=function(){this._instance.finalize(),this._instance=null}}(crypto_stream$1),new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");var poly1305=function(e){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var t,r,n,o,s,a,c,l;t=e[0]&255|(e[1]&255)<<8,this.r[0]=t&8191,r=e[2]&255|(e[3]&255)<<8,this.r[1]=(t>>>13|r<<3)&8191,n=e[4]&255|(e[5]&255)<<8,this.r[2]=(r>>>10|n<<6)&7939,o=e[6]&255|(e[7]&255)<<8,this.r[3]=(n>>>7|o<<9)&8191,s=e[8]&255|(e[9]&255)<<8,this.r[4]=(o>>>4|s<<12)&255,this.r[5]=s>>>1&8190,a=e[10]&255|(e[11]&255)<<8,this.r[6]=(s>>>14|a<<2)&8191,c=e[12]&255|(e[13]&255)<<8,this.r[7]=(a>>>11|c<<5)&8065,l=e[14]&255|(e[15]&255)<<8,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127,this.pad[0]=e[16]&255|(e[17]&255)<<8,this.pad[1]=e[18]&255|(e[19]&255)<<8,this.pad[2]=e[20]&255|(e[21]&255)<<8,this.pad[3]=e[22]&255|(e[23]&255)<<8,this.pad[4]=e[24]&255|(e[25]&255)<<8,this.pad[5]=e[26]&255|(e[27]&255)<<8,this.pad[6]=e[28]&255|(e[29]&255)<<8,this.pad[7]=e[30]&255|(e[31]&255)<<8};poly1305.prototype.blocks=function(e,t,r){for(var n=this.fin?0:2048,o,s,a,c,l,h,u,d,f,_,p,y,w,E,x,B,P,U,F,G=this.h[0],H=this.h[1],te=this.h[2],J=this.h[3],le=this.h[4],z=this.h[5],q=this.h[6],he=this.h[7],V=this.h[8],_e=this.h[9],ee=this.r[0],W=this.r[1],re=this.r[2],ne=this.r[3],ge=this.r[4],de=this.r[5],ye=this.r[6],Ce=this.r[7],ke=this.r[8],ae=this.r[9];r>=16;)o=e[t+0]&255|(e[t+1]&255)<<8,G+=o&8191,s=e[t+2]&255|(e[t+3]&255)<<8,H+=(o>>>13|s<<3)&8191,a=e[t+4]&255|(e[t+5]&255)<<8,te+=(s>>>10|a<<6)&8191,c=e[t+6]&255|(e[t+7]&255)<<8,J+=(a>>>7|c<<9)&8191,l=e[t+8]&255|(e[t+9]&255)<<8,le+=(c>>>4|l<<12)&8191,z+=l>>>1&8191,h=e[t+10]&255|(e[t+11]&255)<<8,q+=(l>>>14|h<<2)&8191,u=e[t+12]&255|(e[t+13]&255)<<8,he+=(h>>>11|u<<5)&8191,d=e[t+14]&255|(e[t+15]&255)<<8,V+=(u>>>8|d<<8)&8191,_e+=d>>>5|n,f=0,_=f,_+=G*ee,_+=H*(5*ae),_+=te*(5*ke),_+=J*(5*Ce),_+=le*(5*ye),f=_>>>13,_&=8191,_+=z*(5*de),_+=q*(5*ge),_+=he*(5*ne),_+=V*(5*re),_+=_e*(5*W),f+=_>>>13,_&=8191,p=f,p+=G*W,p+=H*ee,p+=te*(5*ae),p+=J*(5*ke),p+=le*(5*Ce),f=p>>>13,p&=8191,p+=z*(5*ye),p+=q*(5*de),p+=he*(5*ge),p+=V*(5*ne),p+=_e*(5*re),f+=p>>>13,p&=8191,y=f,y+=G*re,y+=H*W,y+=te*ee,y+=J*(5*ae),y+=le*(5*ke),f=y>>>13,y&=8191,y+=z*(5*Ce),y+=q*(5*ye),y+=he*(5*de),y+=V*(5*ge),y+=_e*(5*ne),f+=y>>>13,y&=8191,w=f,w+=G*ne,w+=H*re,w+=te*W,w+=J*ee,w+=le*(5*ae),f=w>>>13,w&=8191,w+=z*(5*ke),w+=q*(5*Ce),w+=he*(5*ye),w+=V*(5*de),w+=_e*(5*ge),f+=w>>>13,w&=8191,E=f,E+=G*ge,E+=H*ne,E+=te*re,E+=J*W,E+=le*ee,f=E>>>13,E&=8191,E+=z*(5*ae),E+=q*(5*ke),E+=he*(5*Ce),E+=V*(5*ye),E+=_e*(5*de),f+=E>>>13,E&=8191,x=f,x+=G*de,x+=H*ge,x+=te*ne,x+=J*re,x+=le*W,f=x>>>13,x&=8191,x+=z*ee,x+=q*(5*ae),x+=he*(5*ke),x+=V*(5*Ce),x+=_e*(5*ye),f+=x>>>13,x&=8191,B=f,B+=G*ye,B+=H*de,B+=te*ge,B+=J*ne,B+=le*re,f=B>>>13,B&=8191,B+=z*W,B+=q*ee,B+=he*(5*ae),B+=V*(5*ke),B+=_e*(5*Ce),f+=B>>>13,B&=8191,P=f,P+=G*Ce,P+=H*ye,P+=te*de,P+=J*ge,P+=le*ne,f=P>>>13,P&=8191,P+=z*re,P+=q*W,P+=he*ee,P+=V*(5*ae),P+=_e*(5*ke),f+=P>>>13,P&=8191,U=f,U+=G*ke,U+=H*Ce,U+=te*ye,U+=J*de,U+=le*ge,f=U>>>13,U&=8191,U+=z*ne,U+=q*re,U+=he*W,U+=V*ee,U+=_e*(5*ae),f+=U>>>13,U&=8191,F=f,F+=G*ae,F+=H*ke,F+=te*Ce,F+=J*ye,F+=le*de,f=F>>>13,F&=8191,F+=z*ge,F+=q*ne,F+=he*re,F+=V*W,F+=_e*ee,f+=F>>>13,F&=8191,f=(f<<2)+f|0,f=f+_|0,_=f&8191,f=f>>>13,p+=f,G=_,H=p,te=y,J=w,le=E,z=x,q=B,he=P,V=U,_e=F,t+=16,r-=16;this.h[0]=G,this.h[1]=H,this.h[2]=te,this.h[3]=J,this.h[4]=le,this.h[5]=z,this.h[6]=q,this.h[7]=he,this.h[8]=V,this.h[9]=_e},poly1305.prototype.finish=function(e,t){var r=new Uint16Array(10),n,o,s,a;if(this.leftover){for(a=this.leftover,this.buffer[a++]=1;a<16;a++)this.buffer[a]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(n=this.h[1]>>>13,this.h[1]&=8191,a=2;a<10;a++)this.h[a]+=n,n=this.h[a]>>>13,this.h[a]&=8191;for(this.h[0]+=n*5,n=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=n,n=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=n,r[0]=this.h[0]+5,n=r[0]>>>13,r[0]&=8191,a=1;a<10;a++)r[a]=this.h[a]+n,n=r[a]>>>13,r[a]&=8191;for(r[9]-=8192,o=(n^1)-1,a=0;a<10;a++)r[a]&=o;for(o=~o,a=0;a<10;a++)this.h[a]=this.h[a]&o|r[a];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,s=this.h[0]+this.pad[0],this.h[0]=s&65535,a=1;a<8;a++)s=(this.h[a]+this.pad[a]|0)+(s>>>16)|0,this.h[a]=s&65535;e[t+0]=this.h[0]>>>0&255,e[t+1]=this.h[0]>>>8&255,e[t+2]=this.h[1]>>>0&255,e[t+3]=this.h[1]>>>8&255,e[t+4]=this.h[2]>>>0&255,e[t+5]=this.h[2]>>>8&255,e[t+6]=this.h[3]>>>0&255,e[t+7]=this.h[3]>>>8&255,e[t+8]=this.h[4]>>>0&255,e[t+9]=this.h[4]>>>8&255,e[t+10]=this.h[5]>>>0&255,e[t+11]=this.h[5]>>>8&255,e[t+12]=this.h[6]>>>0&255,e[t+13]=this.h[6]>>>8&255,e[t+14]=this.h[7]>>>0&255,e[t+15]=this.h[7]>>>8&255},poly1305.prototype.update=function(e,t,r){var n,o;if(this.leftover){for(o=16-this.leftover,o>r&&(o=r),n=0;n<o;n++)this.buffer[this.leftover+n]=e[t+n];if(r-=o,t+=o,this.leftover+=o,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(r>=16&&(o=r-r%16,this.blocks(e,t,o),t+=o,r-=o),r){for(n=0;n<r;n++)this.buffer[this.leftover+n]=e[t+n];this.leftover+=r}};var poly1305_1=poly1305;const assert$d=nanoassert,Poly1305$2=poly1305_1,{crypto_verify_16:crypto_verify_16$1}=crypto_verifyExports,crypto_onetimeauth_BYTES$1=16,crypto_onetimeauth_KEYBYTES$1=32,crypto_onetimeauth_PRIMITIVE="poly1305";var crypto_onetimeauth_1={crypto_onetimeauth:crypto_onetimeauth$1,crypto_onetimeauth_verify:crypto_onetimeauth_verify$1,crypto_onetimeauth_BYTES:crypto_onetimeauth_BYTES$1,crypto_onetimeauth_KEYBYTES:crypto_onetimeauth_KEYBYTES$1,crypto_onetimeauth_PRIMITIVE};function crypto_onetimeauth$1(e,t,r){assert$d(e.byteLength===crypto_onetimeauth_BYTES$1,"mac must be 'crypto_onetimeauth_BYTES' bytes"),assert$d(t.byteLength!=null,"msg must be buffer"),assert$d(r.byteLength===crypto_onetimeauth_KEYBYTES$1,"key must be 'crypto_onetimeauth_KEYBYTES' bytes");var n=new Poly1305$2(r);n.update(t,0,t.byteLength),n.finish(e,0)}function crypto_onetimeauth_verify$1(e,t,r){assert$d(e.byteLength===crypto_onetimeauth_BYTES$1,"mac must be 'crypto_onetimeauth_BYTES' bytes"),assert$d(t.byteLength!=null,"msg must be buffer"),assert$d(r.byteLength===crypto_onetimeauth_KEYBYTES$1,"key must be 'crypto_onetimeauth_KEYBYTES' bytes");var n=new Uint8Array(16);return crypto_onetimeauth$1(n,t,r),crypto_verify_16$1(e,0,n,0)}const assert$c=nanoassert,{crypto_stream,crypto_stream_xor}=crypto_stream$1,{crypto_onetimeauth,crypto_onetimeauth_verify,crypto_onetimeauth_BYTES,crypto_onetimeauth_KEYBYTES}=crypto_onetimeauth_1,crypto_secretbox_KEYBYTES=32,crypto_secretbox_NONCEBYTES=24,crypto_secretbox_ZEROBYTES=32,crypto_secretbox_BOXZEROBYTES=16,crypto_secretbox_MACBYTES=16;var crypto_secretbox_1={crypto_secretbox,crypto_secretbox_open,crypto_secretbox_detached:crypto_secretbox_detached$1,crypto_secretbox_open_detached:crypto_secretbox_open_detached$1,crypto_secretbox_easy:crypto_secretbox_easy$1,crypto_secretbox_open_easy:crypto_secretbox_open_easy$1,crypto_secretbox_KEYBYTES,crypto_secretbox_NONCEBYTES,crypto_secretbox_ZEROBYTES,crypto_secretbox_BOXZEROBYTES,crypto_secretbox_MACBYTES};function crypto_secretbox(e,t,r,n){assert$c(e.byteLength===t.byteLength,"c must be 'm.byteLength' bytes");const o=t.byteLength;assert$c(o>=crypto_secretbox_ZEROBYTES,"mlen must be at least 'crypto_secretbox_ZEROBYTES'"),assert$c(r.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes"),crypto_stream_xor(e,t,r,n),crypto_onetimeauth(e.subarray(crypto_secretbox_BOXZEROBYTES,crypto_secretbox_BOXZEROBYTES+crypto_onetimeauth_BYTES),e.subarray(crypto_secretbox_BOXZEROBYTES+crypto_onetimeauth_BYTES,e.byteLength),e.subarray(0,crypto_onetimeauth_KEYBYTES)),e.fill(0,0,crypto_secretbox_BOXZEROBYTES)}function crypto_secretbox_open(e,t,r,n){assert$c(t.byteLength===e.byteLength,"c must be 'm.byteLength' bytes");const o=e.byteLength;assert$c(o>=crypto_secretbox_ZEROBYTES,"mlen must be at least 'crypto_secretbox_ZEROBYTES'"),assert$c(r.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes");const s=new Uint8Array(crypto_onetimeauth_KEYBYTES);return crypto_stream(s,r,n),crypto_onetimeauth_verify(t.subarray(crypto_secretbox_BOXZEROBYTES,crypto_secretbox_BOXZEROBYTES+crypto_onetimeauth_BYTES),t.subarray(crypto_secretbox_BOXZEROBYTES+crypto_onetimeauth_BYTES,t.byteLength),s)===!1?!1:(crypto_stream_xor(e,t,r,n),e.fill(0,0,32),!0)}function crypto_secretbox_detached$1(e,t,r,n,o){assert$c(e.byteLength===r.byteLength,"o must be 'msg.byteLength' bytes"),assert$c(t.byteLength===crypto_secretbox_MACBYTES,"mac must be 'crypto_secretbox_MACBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(o.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes");const s=new Uint8Array(r.byteLength+t.byteLength);return crypto_secretbox_easy$1(s,r,n,o),t.set(s.subarray(0,t.byteLength)),e.set(s.subarray(t.byteLength)),!0}function crypto_secretbox_open_detached$1(e,t,r,n,o){assert$c(t.byteLength===e.byteLength,"o must be 'msg.byteLength' bytes"),assert$c(r.byteLength===crypto_secretbox_MACBYTES,"mac must be 'crypto_secretbox_MACBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(o.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes");const s=new Uint8Array(t.byteLength+r.byteLength);return s.set(r),s.set(t,r.byteLength),crypto_secretbox_open_easy$1(e,s,n,o)}function crypto_secretbox_easy$1(e,t,r,n){assert$c(e.byteLength===t.byteLength+crypto_secretbox_MACBYTES,"o must be 'msg.byteLength + crypto_secretbox_MACBYTES' bytes"),assert$c(r.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes");const o=new Uint8Array(crypto_secretbox_ZEROBYTES+t.byteLength),s=new Uint8Array(o.byteLength);o.set(t,crypto_secretbox_ZEROBYTES),crypto_secretbox(s,o,r,n),e.set(s.subarray(crypto_secretbox_BOXZEROBYTES))}function crypto_secretbox_open_easy$1(e,t,r,n){assert$c(t.byteLength===e.byteLength+crypto_secretbox_MACBYTES,"box must be 'msg.byteLength + crypto_secretbox_MACBYTES' bytes"),assert$c(r.byteLength===crypto_secretbox_NONCEBYTES,"n must be 'crypto_secretbox_NONCEBYTES' bytes"),assert$c(n.byteLength===crypto_secretbox_KEYBYTES,"k must be 'crypto_secretbox_KEYBYTES' bytes");const o=new Uint8Array(crypto_secretbox_BOXZEROBYTES+t.byteLength),s=new Uint8Array(o.byteLength);return o.set(t,crypto_secretbox_BOXZEROBYTES),crypto_secretbox_open(s,o,r,n)===!1?!1:(e.set(s.subarray(crypto_secretbox_ZEROBYTES)),!0)}const{crypto_hash_sha512}=crypto_hash_1,{crypto_scalarmult:crypto_scalarmult$2,crypto_scalarmult_base:crypto_scalarmult_base$1}=crypto_scalarmult_1,{randombytes:randombytes$2}=randombytesExports,{crypto_generichash_batch}=crypto_generichashExports,{crypto_stream_xsalsa20_MESSAGEBYTES_MAX}=crypto_stream$1,{crypto_secretbox_open_easy,crypto_secretbox_easy,crypto_secretbox_detached,crypto_secretbox_open_detached}=crypto_secretbox_1,xsalsa20=xsalsa20_1,assert$b=nanoassert,crypto_box_PUBLICKEYBYTES=32,crypto_box_SECRETKEYBYTES=32,crypto_box_NONCEBYTES=24,crypto_box_ZEROBYTES=32,crypto_box_BOXZEROBYTES=16,crypto_box_SEALBYTES=48,crypto_box_SEEDBYTES=32,crypto_box_BEFORENMBYTES=32,crypto_box_MACBYTES=16,crypto_box_curve25519xsalsa20poly1305_MACBYTES=16,crypto_box_MESSAGEBYTES_MAX=crypto_stream_xsalsa20_MESSAGEBYTES_MAX-crypto_box_curve25519xsalsa20poly1305_MACBYTES;var crypto_box={crypto_box_easy,crypto_box_open_easy,crypto_box_keypair,crypto_box_seed_keypair,crypto_box_seal,crypto_box_seal_open,crypto_box_PUBLICKEYBYTES,crypto_box_SECRETKEYBYTES,crypto_box_NONCEBYTES,crypto_box_ZEROBYTES,crypto_box_BOXZEROBYTES,crypto_box_SEALBYTES,crypto_box_SEEDBYTES,crypto_box_BEFORENMBYTES,crypto_box_MACBYTES};function crypto_box_keypair(e,t){return check$1(e,crypto_box_PUBLICKEYBYTES),check$1(t,crypto_box_SECRETKEYBYTES),randombytes$2(t,32),crypto_scalarmult_base$1(e,t)}function crypto_box_seed_keypair(e,t,r){assert$b(e.byteLength===crypto_box_PUBLICKEYBYTES,"pk should be 'crypto_box_PUBLICKEYBYTES' bytes"),assert$b(t.byteLength===crypto_box_SECRETKEYBYTES,"sk should be 'crypto_box_SECRETKEYBYTES' bytes"),assert$b(t.byteLength===crypto_box_SEEDBYTES,"sk should be 'crypto_box_SEEDBYTES' bytes");const n=new Uint8Array(64);return crypto_hash_sha512(n,r,32),t.set(n.subarray(0,32)),n.fill(0),crypto_scalarmult_base$1(e,t)}function crypto_box_seal(e,t,r){check$1(e,crypto_box_SEALBYTES+t.length),check$1(r,crypto_box_PUBLICKEYBYTES);var n=e.subarray(0,crypto_box_PUBLICKEYBYTES),o=new Uint8Array(crypto_box_SECRETKEYBYTES);crypto_box_keypair(n,o);var s=new Uint8Array(crypto_box_NONCEBYTES);crypto_generichash_batch(s,[n,r]);var a=new Uint8Array(crypto_box_PUBLICKEYBYTES);crypto_scalarmult$2(a,o,r);var c=new Uint8Array(crypto_box_BEFORENMBYTES),l=new Uint8Array(16);xsalsa20.core_hsalsa20(c,l,a,xsalsa20.SIGMA),crypto_secretbox_easy(e.subarray(n.length),t,s,c),cleanup(o)}function crypto_box_seal_open(e,t,r,n){check$1(t,crypto_box_SEALBYTES),check$1(e,t.length-crypto_box_SEALBYTES),check$1(r,crypto_box_PUBLICKEYBYTES),check$1(n,crypto_box_SECRETKEYBYTES);var o=t.subarray(0,crypto_box_PUBLICKEYBYTES),s=new Uint8Array(crypto_box_NONCEBYTES);crypto_generichash_batch(s,[o,r]);var a=new Uint8Array(crypto_box_PUBLICKEYBYTES);crypto_scalarmult$2(a,n,o);var c=new Uint8Array(crypto_box_BEFORENMBYTES),l=new Uint8Array(16);return xsalsa20.core_hsalsa20(c,l,a,xsalsa20.SIGMA),crypto_secretbox_open_easy(e,t.subarray(o.length),s,c)}function crypto_box_beforenm(e,t,r){const n=new Uint8Array(16),o=new Uint8Array(32);return assert$b(crypto_scalarmult$2(o,r,t)===0),xsalsa20.core_hsalsa20(e,n,o,xsalsa20.SIGMA),!0}function crypto_box_detached_afternm(e,t,r,n,o){return crypto_secretbox_detached(e,t,r,n,o)}function crypto_box_detached(e,t,r,n,o,s){check$1(t,crypto_box_MACBYTES),check$1(n,crypto_box_NONCEBYTES),check$1(o,crypto_box_PUBLICKEYBYTES),check$1(s,crypto_box_SECRETKEYBYTES);const a=new Uint8Array(crypto_box_BEFORENMBYTES);assert$b(crypto_box_beforenm(a,o,s));const c=crypto_box_detached_afternm(e,t,r,n,a);return cleanup(a),c}function crypto_box_easy(e,t,r,n,o){return assert$b(e.length>=t.length+crypto_box_MACBYTES,"c should be at least 'm.length + crypto_box_MACBYTES' bytes"),assert$b(t.length<=crypto_box_MESSAGEBYTES_MAX,"m should be at most 'crypto_box_MESSAGEBYTES_MAX' bytes"),crypto_box_detached(e.subarray(crypto_box_MACBYTES,t.length+crypto_box_MACBYTES),e.subarray(0,crypto_box_MACBYTES),t,r,n,o)}function crypto_box_open_detached_afternm(e,t,r,n,o){return crypto_secretbox_open_detached(e,t,r,n,o)}function crypto_box_open_detached(e,t,r,n,o,s){const a=new Uint8Array(crypto_box_BEFORENMBYTES);assert$b(crypto_box_beforenm(a,o,s));const c=crypto_box_open_detached_afternm(e,t,r,n,a);return cleanup(a),c}function crypto_box_open_easy(e,t,r,n,o){return assert$b(t.length>=e.length+crypto_box_MACBYTES,"c should be at least 'm.length + crypto_box_MACBYTES' bytes"),crypto_box_open_detached(e,t.subarray(crypto_box_MACBYTES,e.length+crypto_box_MACBYTES),t.subarray(0,crypto_box_MACBYTES),r,n,o)}function check$1(e,t){if(!e||t&&e.length<t)throw new Error("Argument must be a buffer"+(t?" of length "+t:""))}function cleanup(e){for(let t=0;t<e.length;t++)e[t]=0}var sha256Universal={exports:{}},sha256$5={exports:{}};const assert$a=nanoassert,b4a$3=browserExports$2;sha256$5.exports=Sha256$1;const SHA256_BYTES$1=sha256$5.exports.SHA256_BYTES=32,BLOCKSIZE$1=64,K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function expand(e,t,r,n){var o=((e>>>17|e<<15)^(e>>>19|e<<13)^e>>>10)+t,s=((r>>>7|r<<25)^(r>>>18|r<<14)^r>>>3)+n;return o+s<<0}function compress(e,t){var r,n,o,s,a,c,[l,h,u,d,f,_,p,y]=e;const w=new Uint32Array(64);for(let x=0;x<16;x++)w[x]=bswap(t[x]);for(let x=16;x<64;x++)w[x]=expand(w[x-2],w[x-7],w[x-15],w[x-16]);for(let x=0;x<64;x+=4)E(x);e[0]=e[0]+l,e[1]=e[1]+h,e[2]=e[2]+u,e[3]=e[3]+d,e[4]=e[4]+f,e[5]=e[5]+_,e[6]=e[6]+p,e[7]=e[7]+y;function E(x){r=f&_^~f&p,n=l&h^l&u^h&u,o=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),s=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),a=y+r+s+w[x]+K[x],c=o+n,y=d+a,d=a+c,r=y&f^~y&_,n=d&l^d&h^l&h,o=(d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),s=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7),a=p+r+s+w[x+1]+K[x+1],c=o+n,p=u+a,u=a+c,r=p&y^~p&f,n=u&d^u&l^d&l,o=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),s=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),a=_+r+s+w[x+2]+K[x+2],c=o+n,_=h+a,h=a+c,r=_&p^~_&y,n=h&u^h&d^u&d,o=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),s=(_>>>6|_<<26)^(_>>>11|_<<21)^(_>>>25|_<<7),a=f+r+s+w[x+3]+K[x+3],c=o+n,f=l+a,l=a+c}}function Sha256$1(){return this instanceof Sha256$1?(this.buffer=new ArrayBuffer(64),this.bytesRead=0,this.pos=0,this.digestLength=SHA256_BYTES$1,this.finalised=!1,this.load=new Uint8Array(this.buffer),this.words=new Uint32Array(this.buffer),this.state=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this):new Sha256$1}Sha256$1.prototype.update=function(e,t){assert$a(this.finalised===!1,"Hash instance finalised");var[r,n]=formatInput$1(e,t),o=0;for(this.bytesRead+=n;n>0&&(this.load.set(r.subarray(o,o+BLOCKSIZE$1-this.pos),this.pos),o+=BLOCKSIZE$1-this.pos,n-=BLOCKSIZE$1-this.pos,!(n<0));)this.pos=0,compress(this.state,this.words);return this.pos=this.bytesRead&63,this.load.fill(0,this.pos),this},Sha256$1.prototype.digest=function(e,t=0){assert$a(this.finalised===!1,"Hash instance finalised"),this.finalised=!0,this.load.fill(0,this.pos),this.load[this.pos]=128,this.pos>55&&(compress(this.state,this.words),this.words.fill(0),this.pos=0);const r=new DataView(this.buffer);r.setUint32(56,this.bytesRead/536870912),r.setUint32(60,this.bytesRead<<3),compress(this.state,this.words);const n=new Uint8Array(this.state.map(bswap).buffer);if(!e)return new Uint8Array(n);if(typeof e=="string")return b4a$3.toString(n,e);assert$a(e instanceof Uint8Array,"input must be Uint8Array or Buffer"),assert$a(e.byteLength>=this.digestLength+t,"input not large enough for digest");for(let o=0;o<this.digestLength;o++)e[o+t]=n[o];return e};function HMAC$1(e){if(!(this instanceof HMAC$1))return new HMAC$1(e);this.pad=b4a$3.alloc(64),this.inner=Sha256$1(),this.outer=Sha256$1();const t=b4a$3.alloc(32);e.byteLength>64&&(Sha256$1().update(e).digest(t),e=t),this.pad.fill(54);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.inner.update(this.pad),this.pad.fill(92);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.outer.update(this.pad),this.pad.fill(0),t.fill(0)}HMAC$1.prototype.update=function(e,t){return this.inner.update(e,t),this},HMAC$1.prototype.digest=function(e,t=0){return this.outer.update(this.inner.digest()),this.outer.digest(e,t)},Sha256$1.HMAC=HMAC$1;function formatInput$1(e,t){var r=b4a$3.from(e,t);return[r,r.byteLength]}function bswap(e){var t=(e&16711935)>>>8|(e&16711935)<<24,r=(e&4278255360)<<8|(e&4278255360)>>>24;return t|r}var sha256Exports$1=sha256$5.exports,sha256Wasm={exports:{}},sha256$4,hasRequiredSha256;function requireSha256(){if(hasRequiredSha256)return sha256$4;hasRequiredSha256=1;var e=(s,a)=>function(){return a||(0,s[Object.keys(s)[0]])((a={exports:{}}).exports,a),a.exports},t=(()=>{for(var s=new Uint8Array(128),a=0;a<64;a++)s[a<26?a+65:a<52?a+71:a<62?a-4:a*4-205]=a;return c=>{for(var l=c.length,h=new Uint8Array((l-(c[l-1]=="=")-(c[l-2]=="="))*3/4|0),u=0,d=0;u<l;){var f=s[c.charCodeAt(u++)],_=s[c.charCodeAt(u++)],p=s[c.charCodeAt(u++)],y=s[c.charCodeAt(u++)];h[d++]=f<<2|_>>4,h[d++]=_<<4|p>>2,h[d++]=p<<6|y}return h}})(),r=e({"wasm-binary:./sha256.wat"(s,a){a.exports=t("AGFzbQEAAAABNAVgAX8Bf2AIf39/f39/f38AYAR/f39/AX9gEX9/f39/f39/f39/f39/f39/AGAEf39/fwADBgUAAQIDBAUDAQABBikIfwFBAAt/AUEAC38BQQALfwFBAAt/AUEAC38BQQALfwFBAAt/AUEACwcTAgZtZW1vcnkCAAZzaGEyNTYABAreFwUZACAAQf+B/AdxQQh4IABBgP6DeHFBCHdyC7wDAQZ/IwQjBXEjBEF/cyMGcXMhCiMAIwFxIwAjAnFzIwEjAnFzIQsjAEECeCMAQQ14cyMAQRZ4cyEMIwRBBngjBEELeHMjBEEZeHMhDSMHIApqIA1qIABqIARqIQggDCALaiEJIwMgCGokByAIIAlqJAMjByMEcSMHQX9zIwVxcyEKIwMjAHEjAyMBcXMjACMBcXMhCyMDQQJ4IwNBDXhzIwNBFnhzIQwjB0EGeCMHQQt4cyMHQRl4cyENIwYgCmogDWogAWogBWohCCAMIAtqIQkjAiAIaiQGIAggCWokAiMGIwdxIwZBf3MjBHFzIQojAiMDcSMCIwBxcyMDIwBxcyELIwJBAngjAkENeHMjAkEWeHMhDCMGQQZ4IwZBC3hzIwZBGXhzIQ0jBSAKaiANaiACaiAGaiEIIAwgC2ohCSMBIAhqJAUgCCAJaiQBIwUjBnEjBUF/cyMHcXMhCiMBIwJxIwEjA3FzIwIjA3FzIQsjAUECeCMBQQ14cyMBQRZ4cyEMIwVBBngjBUELeHMjBUEZeHMhDSMEIApqIA1qIANqIAdqIQggDCALaiEJIwAgCGokBCAIIAlqJAALKwAgAEEReCAAQRN4cyAAQQp2cyABaiACQQd4IAJBEnhzIAJBA3ZzIANqagvLCwEwfyAAKAJoRQRAIABB58yn0AY2AgAgAEGF3Z7bezYCBCAAQfLmu+MDNgIIIABBuuq/qno2AgwgAEH/pLmIBTYCECAAQYzRldh5NgIUIABBq7OP/AE2AhggAEGZmoPfBTYCHCAAQQE2AmgLIAAoAgAkACAAKAIEJAEgACgCCCQCIAAoAgwkAyAAKAIQJAQgACgCFCQFIAAoAhgkBiAAKAIcJAcgARAAIQEgAhAAIQIgAxAAIQMgBBAAIQQgBRAAIQUgBhAAIQYgBxAAIQcgCBAAIQggCRAAIQkgChAAIQogCxAAIQsgDBAAIQwgDRAAIQ0gDhAAIQ4gDxAAIQ8gEBAAIRAgASACIAMgBEGY36iUBEGRid2JB0HP94Oue0Glt9fNfhABIAUgBiAHIAhB24TbygNB8aPEzwVBpIX+kXlB1b3x2HoQASAJIAogCyAMQZjVnsB9QYG2jZQBQb6LxqECQcP7sagFEAEgDSAOIA8gEEH0uvmVB0H+4/qGeEGnjfDeeUH04u+MfBABIA8gCiACIAEQAiEBIBAgCyADIAIQAiECIAEgDCAEIAMQAiEDIAIgDSAFIAQQAiEEIAMgDiAGIAUQAiEFIAQgDyAHIAYQAiEGIAUgECAIIAcQAiEHIAYgASAJIAgQAiEIIAcgAiAKIAkQAiEJIAggAyALIAoQAiEKIAkgBCAMIAsQAiELIAogBSANIAwQAiEMIAsgBiAOIA0QAiENIAwgByAPIA4QAiEOIA0gCCAQIA8QAiEPIA4gCSABIBAQAiEQIAEgAiADIARBwdPtpH5Bho/5/X5BxruG/gBBzMOyoAIQASAFIAYgByAIQe/YpO8CQaqJ0tMEQdzTwuUFQdqR5rcHEAEgCSAKIAsgDEHSovnBeUHtjMfBekHIz4yAe0HH/+X6exABIA0gDiAPIBBB85eAt3xBx6KerX1B0capNkHn0qShARABIA8gCiACIAEQAiEBIBAgCyADIAIQAiECIAEgDCAEIAMQAiEDIAIgDSAFIAQQAiEEIAMgDiAGIAUQAiEFIAQgDyAHIAYQAiEGIAUgECAIIAcQAiEHIAYgASAJIAgQAiEIIAcgAiAKIAkQAiEJIAggAyALIAoQAiEKIAkgBCAMIAsQAiELIAogBSANIAwQAiEMIAsgBiAOIA0QAiENIAwgByAPIA4QAiEOIA0gCCAQIA8QAiEPIA4gCSABIBAQAiEQIAEgAiADIARBhZXcvQJBuMLs8AJB/Nux6QRBk5rgmQUQASAFIAYgByAIQdTmqagGQbuVqLMHQa6Si454QYXZyJN5EAEgCSAKIAsgDEGh0f+VekHLzOnAekHwlq6SfEGjo7G7fBABIA0gDiAPIBBBmdDLjH1BpIzktH1Bheu4oH9B8MCqgwEQASAPIAogAiABEAIhASAQIAsgAyACEAIhAiABIAwgBCADEAIhAyACIA0gBSAEEAIhBCADIA4gBiAFEAIhBSAEIA8gByAGEAIhBiAFIBAgCCAHEAIhByAGIAEgCSAIEAIhCCAHIAIgCiAJEAIhCSAIIAMgCyAKEAIhCiAJIAQgDCALEAIhCyAKIAUgDSAMEAIhDCALIAYgDiANEAIhDSAMIAcgDyAOEAIhDiANIAggECAPEAIhDyAOIAkgASAQEAIhECABIAIgAyAEQZaCk80BQYjY3fEBQczuoboCQbX5wqUDEAEgBSAGIAcgCEGzmfDIA0HK1OL2BEHPlPPcBUHz37nBBhABIAkgCiALIAxB7oW+pAdB78aVxQdBlPChpnhBiISc5ngQASANIA4gDyAQQfr/+4V5QevZwaJ6QffH5vd7QfLxxbN8EAEgACAAKAIAIwBqNgIAIAAgACgCBCMBajYCBCAAIAAoAggjAmo2AgggACAAKAIMIwNqNgIMIAAgACgCECMEajYCECAAIAAoAhQjBWo2AhQgACAAKAIYIwZqNgIYIAAgACgCHCMHajYCHAuKCAIBfhJ/IAApAyAhBCAEp0E/cSACaiEGIAQgAq18IQQgACAENwMgAkAgACgCKCEHIAAoAiwhCCAAKAIwIQkgACgCNCEKIAAoAjghCyAAKAI8IQwgACgCQCENIAAoAkQhDiAAKAJIIQ8gACgCTCEQIAAoAlAhESAAKAJUIRIgACgCWCETIAAoAlwhFCAAKAJgIRUgACgCZCEWIAZBwABrIgZBAEgNACAAIAcgCCAJIAogCyAMIA0gDiAPIBAgESASIBMgFCAVIBYQAwNAIAEoAgAhByABKAIEIQggASgCCCEJIAEoAgwhCiABKAIQIQsgASgCFCEMIAEoAhghDSABKAIcIQ4gASgCICEPIAEoAiQhECABKAIoIREgASgCLCESIAEoAjAhEyABKAI0IRQgASgCOCEVIAEoAjwhFiABQcAAaiEBIAZBwABrIgZBAEgEQCAAIAc2AiggACAINgIsIAAgCTYCMCAAIAo2AjQgACALNgI4IAAgDDYCPCAAIA02AkAgACAONgJEIAAgDzYCSCAAIBA2AkwgACARNgJQIAAgEjYCVCAAIBM2AlggACAUNgJcIAAgFTYCYCAAIBY2AmQMAgsgACAHIAggCSAKIAsgDCANIA4gDyAQIBEgEiATIBQgFSAWEAMMAAsLIANBAUYEQCAEp0E/cSEGQYABIAZBA3FBA3R0IQUCQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAgBkECdg4PAwQFBgcICQoLDA0ODxABAgsLIAUgFXIhFUEAIQULIAUgFnIhFkEAIQUgACAHIAggCSAKIAsgDCANIA4gDyAQIBEgEiATIBQgFSAWEAMgACAENwMgQQAhB0EAIQhBACEJQQAhCkEAIQtBACEMQQAhDUEAIQ5BACEPQQAhEEEAIRFBACESQQAhE0EAIRRBACEVQQAhFgsgBSAHciEHQQAhBQsgBSAIciEIQQAhBQsgBSAJciEJQQAhBQsgBSAKciEKQQAhBQsgBSALciELQQAhBQsgBSAMciEMQQAhBQsgBSANciENQQAhBQsgBSAOciEOQQAhBQsgBSAPciEPQQAhBQsgBSAQciEQQQAhBQsgBSARciERQQAhBQsgBSASciESQQAhBQsgBSATciETQQAhBQsgBSAUciEUQQAhBQsgBEIdiKcQACEVIARCA4anEAAhFiAAIAcgCCAJIAogCyAMIA0gDiAPIBAgESASIBMgFCAVIBYQAyAAIAAoAgAQADYCACAAIAAoAgQQADYCBCAAIAAoAggQADYCCCAAIAAoAgwQADYCDCAAIAAoAhAQADYCECAAIAAoAhQQADYCFCAAIAAoAhgQADYCGCAAIAAoAhwQADYCHAsL")}}),n=r(),o=new WebAssembly.Module(n);return sha256$4=s=>new WebAssembly.Instance(o,s).exports,sha256$4}const assert$9=nanoassert,b4a$2=browserExports$2,wasm$5=typeof WebAssembly<"u"&&requireSha256()({imports:{debug:{log(...e){console.log(...e.map(t=>(t>>>0).toString(16).padStart(8,"0")))},log_tee(e){return console.log((e>>>0).toString(16).padStart(8,"0")),e}}}});let head=0;const freeList=[];sha256Wasm.exports=Sha256;const SHA256_BYTES=sha256Wasm.exports.SHA256_BYTES=32,INPUT_OFFSET=40,STATEBYTES=108,BLOCKSIZE=64;function Sha256(){if(!(this instanceof Sha256))return new Sha256;if(!wasm$5)throw new Error("WASM not loaded. Wait for Sha256.ready(cb)");freeList.length||(freeList.push(head),head+=STATEBYTES),this.finalized=!1,this.digestLength=SHA256_BYTES,this.pointer=freeList.pop(),this.pos=0,this._memory=new Uint8Array(wasm$5.memory.buffer),this._memory.fill(0,this.pointer,this.pointer+STATEBYTES),this.pointer+this.digestLength>this._memory.length&&this._realloc(this.pointer+STATEBYTES)}Sha256.prototype._realloc=function(e){wasm$5.memory.grow(Math.max(0,Math.ceil(Math.abs(e-this._memory.length)/65536))),this._memory=new Uint8Array(wasm$5.memory.buffer)},Sha256.prototype.update=function(e,t){assert$9(this.finalized===!1,"Hash instance finalized"),head%4!==0&&(head+=4-head%4),assert$9(head%4===0,"input shoud be aligned for int32");const[r,n]=formatInput(e,t);return assert$9(r instanceof Uint8Array,"input must be Uint8Array or Buffer"),head+n>this._memory.length&&this._realloc(head+e.length),this._memory.fill(0,head,head+roundUp(n,BLOCKSIZE)-BLOCKSIZE),this._memory.set(r.subarray(0,BLOCKSIZE-this.pos),this.pointer+INPUT_OFFSET+this.pos),this._memory.set(r.subarray(BLOCKSIZE-this.pos),head),this.pos=this.pos+n&63,wasm$5.sha256(this.pointer,head,n,0),this},Sha256.prototype.digest=function(e,t=0){assert$9(this.finalized===!1,"Hash instance finalized"),this.finalized=!0,freeList.push(this.pointer);const r=this.pointer+INPUT_OFFSET+this.pos;this._memory.fill(0,r,this.pointer+INPUT_OFFSET+BLOCKSIZE),wasm$5.sha256(this.pointer,head,0,1);const n=this._memory.subarray(this.pointer,this.pointer+this.digestLength);if(!e)return n;if(typeof e=="string")return b4a$2.toString(n,e);assert$9(e instanceof Uint8Array,"output must be Uint8Array or Buffer"),assert$9(e.byteLength>=this.digestLength+t,"output must have at least 'SHA256_BYTES' bytes remaining");for(let o=0;o<this.digestLength;o++)e[o+t]=n[o];return e},Sha256.WASM=wasm$5,Sha256.WASM_SUPPORTED=typeof WebAssembly<"u",Sha256.ready=function(e){return e||(e=noop$3),wasm$5?(e(),Promise.resolve()):e(new Error("WebAssembly not supported"))},Sha256.prototype.ready=Sha256.ready;function HMAC(e){if(!(this instanceof HMAC))return new HMAC(e);this.pad=b4a$2.alloc(64),this.inner=Sha256(),this.outer=Sha256();const t=b4a$2.alloc(32);e.byteLength>64&&(Sha256().update(e).digest(t),e=t),this.pad.fill(54);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.inner.update(this.pad),this.pad.fill(92);for(let r=0;r<e.byteLength;r++)this.pad[r]^=e[r];this.outer.update(this.pad),this.pad.fill(0),t.fill(0)}HMAC.prototype.update=function(e,t){return this.inner.update(e,t),this},HMAC.prototype.digest=function(e,t=0){return this.outer.update(this.inner.digest()),this.outer.digest(e,t)},Sha256.HMAC=HMAC;function noop$3(){}function formatInput(e,t){var r=b4a$2.from(e,t);return[r,r.byteLength]}function roundUp(e,t){return e+t-1&-t}var sha256WasmExports=sha256Wasm.exports;const js=sha256Exports$1,wasm$4=sha256WasmExports;var Proto=js;sha256Universal.exports=function(){return new Proto},sha256Universal.exports.ready=function(e){wasm$4.ready(function(){e()})},sha256Universal.exports.WASM_SUPPORTED=wasm$4.WASM_SUPPORTED,sha256Universal.exports.WASM_LOADED=!1,sha256Universal.exports.SHA256_BYTES=32,wasm$4.ready(function(e){e||(sha256Universal.exports.WASM_LOADED=!0,sha256Universal.exports=Proto=wasm$4)});var sha256UniversalExports=sha256Universal.exports;const sha256$3=sha256UniversalExports,assert$8=nanoassert;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");const crypto_hash_sha256_BYTES=32;function crypto_hash_sha256(e,t,r){return assert$8(e.byteLength===crypto_hash_sha256_BYTES,"out must be 'crypto_hash_sha256_BYTES' bytes long"),sha256$3().update(t.subarray(0,r)).digest(e),0}var crypto_hash_sha256_1={crypto_hash_sha256,crypto_hash_sha256_BYTES},crypto_kdf={exports:{}};(function(e){const t=nanoassert,r=randombytesExports.randombytes_buf,n=blake2bExports;e.exports.crypto_kdf_PRIMITIVE="blake2b",e.exports.crypto_kdf_BYTES_MIN=16,e.exports.crypto_kdf_BYTES_MAX=64,e.exports.crypto_kdf_CONTEXTBYTES=8,e.exports.crypto_kdf_KEYBYTES=32;function o(s,a){var c=1,l=0;for(s[0]=a&255;++l<8&&(c*=256);)s[l]=a/c&255}e.exports.crypto_kdf_derive_from_key=function(s,a,c,l){t(s.length>=e.exports.crypto_kdf_BYTES_MIN,"subkey must be at least crypto_kdf_BYTES_MIN"),t(a>=0&&a<=9007199254740991,"subkey_id must be safe integer"),t(c.length>=e.exports.crypto_kdf_CONTEXTBYTES,"context must be at least crypto_kdf_CONTEXTBYTES");var h=new Uint8Array(n.PERSONALBYTES),u=new Uint8Array(n.SALTBYTES);h.set(c,0,e.exports.crypto_kdf_CONTEXTBYTES),o(u,a);var d=Math.min(s.length,e.exports.crypto_kdf_BYTES_MAX);n(d,l.subarray(0,e.exports.crypto_kdf_KEYBYTES),u,h,!0).final(s)},e.exports.crypto_kdf_keygen=function(s){t(s.length>=e.exports.crypto_kdf_KEYBYTES,"out.length must be crypto_kdf_KEYBYTES"),r(s.subarray(0,e.exports.crypto_kdf_KEYBYTES))}})(crypto_kdf);var crypto_kdfExports=crypto_kdf.exports;const{crypto_scalarmult_base}=crypto_scalarmult_1,{crypto_generichash:crypto_generichash$2}=crypto_generichashExports,{randombytes_buf:randombytes_buf$1}=randombytesExports,assert$7=nanoassert,crypto_kx_SEEDBYTES=32,crypto_kx_PUBLICKEYBYTES=32,crypto_kx_SECRETKEYBYTES=32;function crypto_kx_keypair(e,t){return assert$7(e.byteLength===crypto_kx_PUBLICKEYBYTES,"pk must be 'crypto_kx_PUBLICKEYBYTES' bytes"),assert$7(t.byteLength===crypto_kx_SECRETKEYBYTES,"sk must be 'crypto_kx_SECRETKEYBYTES' bytes"),randombytes_buf$1(t,crypto_kx_SECRETKEYBYTES),crypto_scalarmult_base(e,t)}function crypto_kx_seed_keypair(e,t,r){return assert$7(e.byteLength===crypto_kx_PUBLICKEYBYTES,"pk must be 'crypto_kx_PUBLICKEYBYTES' bytes"),assert$7(t.byteLength===crypto_kx_SECRETKEYBYTES,"sk must be 'crypto_kx_SECRETKEYBYTES' bytes"),assert$7(r.byteLength===crypto_kx_SEEDBYTES,"seed must be 'crypto_kx_SEEDBYTES' bytes"),crypto_generichash$2(t,r),crypto_scalarmult_base(e,t)}var crypto_kx$2={crypto_kx_keypair,crypto_kx_seed_keypair,crypto_kx_SEEDBYTES,crypto_kx_SECRETKEYBYTES,crypto_kx_PUBLICKEYBYTES},crypto_stream_chacha20={};const assert$6=nanoassert;var chacha20Universal=Chacha20;const constant=[1634760805,857760878,2036477234,1797285236];function Chacha20(e,t,r){assert$6(t.byteLength===32),assert$6(e.byteLength===8||e.byteLength===12);const n=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),o=new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4);r||(r=0),assert$6(r<Number.MAX_SAFE_INTEGER),this.finalized=!1,this.pos=0,this.state=new Uint32Array(16);for(let s=0;s<4;s++)this.state[s]=constant[s];for(let s=0;s<8;s++)this.state[4+s]=o[s];return this.state[12]=r&4294967295,n.byteLength===8?(this.state[13]=(r&&0xffffffff00000000)>>32,this.state[14]=n[0],this.state[15]=n[1]):(this.state[13]=n[0],this.state[14]=n[1],this.state[15]=n[2]),this}Chacha20.prototype.update=function(e,t){assert$6(!this.finalized,"cipher finalized."),assert$6(e.byteLength>=t.byteLength,"output cannot be shorter than input.");let r=t.length,n=this.pos%64;this.pos+=r;let o=0,s=chacha20Block(this.state);for(;n>0&&r>0;)e[o]=t[o++]^s[n],n=n+1&63,n||this.state[12]++,r--;for(;r>0;){if(s=chacha20Block(this.state),r<64){for(let a=0;a<r;a++)e[o]=t[o++]^s[n++],n&=63;return}for(;n<64;)e[o]=t[o++]^s[n++];this.state[12]++,n=0,r-=64}},Chacha20.prototype.final=function(){this.state.fill(0),this.pos=0,this.finalized=!0};function chacha20Block(e){const t=new Uint32Array(16);for(let r=16;r--;)t[r]=e[r];for(let r=0;r<20;r+=2)QR(t,0,4,8,12),QR(t,1,5,9,13),QR(t,2,6,10,14),QR(t,3,7,11,15),QR(t,0,5,10,15),QR(t,1,6,11,12),QR(t,2,7,8,13),QR(t,3,4,9,14);for(let r=0;r<16;r++)t[r]+=e[r];return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}function rotl(e,t){return e<<t|e>>>32-t}function QR(e,t,r,n,o){e[t]+=e[r],e[o]^=e[t],e[o]=rotl(e[o],16),e[n]+=e[o],e[r]^=e[n],e[r]=rotl(e[r],12),e[t]+=e[r],e[o]^=e[t],e[o]=rotl(e[o],8),e[n]+=e[o],e[r]^=e[n],e[r]=rotl(e[r],7)}(function(e){const t=nanoassert,r=chacha20Universal;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");e.crypto_stream_chacha20_KEYBYTES=32,e.crypto_stream_chacha20_NONCEBYTES=8,e.crypto_stream_chacha20_MESSAGEBYTES_MAX=Number.MAX_SAFE_INTEGER,e.crypto_stream_chacha20_ietf_KEYBYTES=32,e.crypto_stream_chacha20_ietf_NONCEBYTES=12,e.crypto_stream_chacha20_ietf_MESSAGEBYTES_MAX=4294967296,e.crypto_stream_chacha20=function(n,o,s){n.fill(0),e.crypto_stream_chacha20_xor(n,n,o,s)},e.crypto_stream_chacha20_xor=function(n,o,s,a){t(s.byteLength===e.crypto_stream_chacha20_NONCEBYTES,"n should be crypto_stream_chacha20_NONCEBYTES"),t(a.byteLength===e.crypto_stream_chacha20_KEYBYTES,"k should be crypto_stream_chacha20_KEYBYTES");const c=new r(s,a);c.update(n,o),c.final()},e.crypto_stream_chacha20_xor_ic=function(n,o,s,a,c){t(s.byteLength===e.crypto_stream_chacha20_NONCEBYTES,"n should be crypto_stream_chacha20_NONCEBYTES"),t(c.byteLength===e.crypto_stream_chacha20_KEYBYTES,"k should be crypto_stream_chacha20_KEYBYTES");const l=new r(s,c,a);l.update(n,o),l.final()},e.crypto_stream_chacha20_xor_instance=function(n,o){return t(n.byteLength===e.crypto_stream_chacha20_NONCEBYTES,"n should be crypto_stream_chacha20_NONCEBYTES"),t(o.byteLength===e.crypto_stream_chacha20_KEYBYTES,"k should be crypto_stream_chacha20_KEYBYTES"),new r(n,o)},e.crypto_stream_chacha20_ietf=function(n,o,s){n.fill(0),e.crypto_stream_chacha20_ietf_xor(n,n,o,s)},e.crypto_stream_chacha20_ietf_xor=function(n,o,s,a){t(s.byteLength===e.crypto_stream_chacha20_ietf_NONCEBYTES,"n should be crypto_stream_chacha20_ietf_NONCEBYTES"),t(a.byteLength===e.crypto_stream_chacha20_ietf_KEYBYTES,"k should be crypto_stream_chacha20_ietf_KEYBYTES");const c=new r(s,a);c.update(n,o),c.final()},e.crypto_stream_chacha20_ietf_xor_ic=function(n,o,s,a,c){t(s.byteLength===e.crypto_stream_chacha20_ietf_NONCEBYTES,"n should be crypto_stream_chacha20_ietf_NONCEBYTES"),t(c.byteLength===e.crypto_stream_chacha20_ietf_KEYBYTES,"k should be crypto_stream_chacha20_ietf_KEYBYTES");const l=new r(s,c,a);l.update(n,o),l.final()},e.crypto_stream_chacha20_ietf_xor_instance=function(n,o){return t(n.byteLength===e.crypto_stream_chacha20_ietf_NONCEBYTES,"n should be crypto_stream_chacha20_ietf_NONCEBYTES"),t(o.byteLength===e.crypto_stream_chacha20_ietf_KEYBYTES,"k should be crypto_stream_chacha20_ietf_KEYBYTES"),new r(n,o)}})(crypto_stream_chacha20);const{crypto_stream_chacha20_ietf:crypto_stream_chacha20_ietf$1,crypto_stream_chacha20_ietf_xor_ic:crypto_stream_chacha20_ietf_xor_ic$1}=crypto_stream_chacha20,{crypto_verify_16}=crypto_verifyExports,Poly1305$1=poly1305_1,assert$5=nanoassert,crypto_aead_chacha20poly1305_ietf_KEYBYTES=32,crypto_aead_chacha20poly1305_ietf_NSECBYTES=0,crypto_aead_chacha20poly1305_ietf_NPUBBYTES=12,crypto_aead_chacha20poly1305_ietf_ABYTES=16,crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1=Number.MAX_SAFE_INTEGER,_pad0$1=new Uint8Array(16);function crypto_aead_chacha20poly1305_ietf_encrypt(e,t,r,n,o,s){if(r===null)return crypto_aead_chacha20poly1305_ietf_encrypt(e,t,new Uint8Array(0),n,o,s);assert$5(e.byteLength===t.byteLength+crypto_aead_chacha20poly1305_ietf_ABYTES,"ciphertext should be 'crypto_aead_chacha20poly1305_ietf_ABYTES' longer than message"),assert$5(o.byteLength===crypto_aead_chacha20poly1305_ietf_NPUBBYTES,"npub should be 'crypto_aead_chacha20poly1305_ietf_NPUBBYTES' long"),assert$5(s.byteLength===crypto_aead_chacha20poly1305_ietf_KEYBYTES,"k should be 'crypto_aead_chacha20poly1305_ietf_KEYBYTES' long"),assert$5(t.byteLength<=crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1,"message is too large");const a=crypto_aead_chacha20poly1305_ietf_encrypt_detached(e.subarray(0,t.byteLength),e.subarray(t.byteLength),t,r,n,o,s);return t.byteLength+a}function crypto_aead_chacha20poly1305_ietf_encrypt_detached(e,t,r,n,o,s,a){if(n===null)return crypto_aead_chacha20poly1305_ietf_encrypt_detached(e,t,r,new Uint8Array(0),o,s,a);assert$5(e.byteLength===r.byteLength,"ciphertext should be same length than message"),assert$5(s.byteLength===crypto_aead_chacha20poly1305_ietf_NPUBBYTES,"npub should be 'crypto_aead_chacha20poly1305_ietf_NPUBBYTES' long"),assert$5(a.byteLength===crypto_aead_chacha20poly1305_ietf_KEYBYTES,"k should be 'crypto_aead_chacha20poly1305_ietf_KEYBYTES' long"),assert$5(r.byteLength<=crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1,"message is too large"),assert$5(t.byteLength<=crypto_aead_chacha20poly1305_ietf_ABYTES,"mac should be 'crypto_aead_chacha20poly1305_ietf_ABYTES' long");const c=new Uint8Array(64);var l=new Uint8Array(8);crypto_stream_chacha20_ietf$1(c,s,a);const h=new Poly1305$1(c);return c.fill(0),h.update(n,0,n.byteLength),h.update(_pad0$1,0,16-n.byteLength&15),crypto_stream_chacha20_ietf_xor_ic$1(e,r,s,1,a),h.update(e,0,r.byteLength),h.update(_pad0$1,0,16-r.byteLength&15),write64LE(l,0,n.byteLength),h.update(l,0,l.byteLength),write64LE(l,0,r.byteLength),h.update(l,0,l.byteLength),h.finish(t,0),l.fill(0),crypto_aead_chacha20poly1305_ietf_ABYTES}function crypto_aead_chacha20poly1305_ietf_decrypt(e,t,r,n,o,s){if(n===null)return crypto_aead_chacha20poly1305_ietf_decrypt(e,t,r,new Uint8Array(0),o,s);if(assert$5(e.byteLength===r.byteLength-crypto_aead_chacha20poly1305_ietf_ABYTES,"message should be 'crypto_aead_chacha20poly1305_ietf_ABYTES' shorter than ciphertext"),assert$5(o.byteLength===crypto_aead_chacha20poly1305_ietf_NPUBBYTES,"npub should be 'crypto_aead_chacha20poly1305_ietf_NPUBBYTES' long"),assert$5(s.byteLength===crypto_aead_chacha20poly1305_ietf_KEYBYTES,"k should be 'crypto_aead_chacha20poly1305_ietf_KEYBYTES' long"),assert$5(e.byteLength<=crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1,"message is too large"),r.byteLength<crypto_aead_chacha20poly1305_ietf_ABYTES)throw new Error("could not verify data");return crypto_aead_chacha20poly1305_ietf_decrypt_detached(e,t,r.subarray(0,r.byteLength-crypto_aead_chacha20poly1305_ietf_ABYTES),r.subarray(r.byteLength-crypto_aead_chacha20poly1305_ietf_ABYTES),n,o,s),r.byteLength-crypto_aead_chacha20poly1305_ietf_ABYTES}function crypto_aead_chacha20poly1305_ietf_decrypt_detached(e,t,r,n,o,s,a){if(o===null)return crypto_aead_chacha20poly1305_ietf_decrypt_detached(e,t,r,n,new Uint8Array(0),s,a);assert$5(r.byteLength===e.byteLength,"message should be same length than ciphertext"),assert$5(s.byteLength===crypto_aead_chacha20poly1305_ietf_NPUBBYTES,"npub should be 'crypto_aead_chacha20poly1305_ietf_NPUBBYTES' long"),assert$5(a.byteLength===crypto_aead_chacha20poly1305_ietf_KEYBYTES,"k should be 'crypto_aead_chacha20poly1305_ietf_KEYBYTES' long"),assert$5(e.byteLength<=crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1,"message is too large"),assert$5(n.byteLength<=crypto_aead_chacha20poly1305_ietf_ABYTES,"mac should be 'crypto_aead_chacha20poly1305_ietf_ABYTES' long");const c=new Uint8Array(64),l=new Uint8Array(8),h=new Uint8Array(crypto_aead_chacha20poly1305_ietf_ABYTES);crypto_stream_chacha20_ietf$1(c,s,a);const u=new Poly1305$1(c);c.fill(0),u.update(o,0,o.byteLength),u.update(_pad0$1,0,16-o.byteLength&15);const d=r.byteLength;u.update(r,0,d),u.update(_pad0$1,0,16-d&15),write64LE(l,0,o.byteLength),u.update(l,0,l.byteLength),write64LE(l,0,d),u.update(l,0,l.byteLength),u.finish(h,0),assert$5(h.byteLength===16);const f=crypto_verify_16(h,0,n,0);if(h.fill(0),l.fill(0),!f)throw e.fill(0),new Error("could not verify data");crypto_stream_chacha20_ietf_xor_ic$1(e,r,s,1,a)}function write64LE(e,t,r){e.fill(0,0,8);const n=new DataView(e.buffer,e.byteOffset,e.byteLength);n.setUint32(t,r&4294967295,!0),n.setUint32(t+4,r/4294967296&4294967295,!0)}var crypto_aead$2={crypto_aead_chacha20poly1305_ietf_encrypt,crypto_aead_chacha20poly1305_ietf_encrypt_detached,crypto_aead_chacha20poly1305_ietf_decrypt,crypto_aead_chacha20poly1305_ietf_decrypt_detached,crypto_aead_chacha20poly1305_ietf_ABYTES,crypto_aead_chacha20poly1305_ietf_KEYBYTES,crypto_aead_chacha20poly1305_ietf_NPUBBYTES,crypto_aead_chacha20poly1305_ietf_NSECBYTES,crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX:crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX$1};const assert$4=nanoassert;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");const crypto_core_hchacha20_OUTPUTBYTES=32,crypto_core_hchacha20_INPUTBYTES$1=16,crypto_core_hchacha20_KEYBYTES=32,crypto_core_hchacha20_CONSTBYTES=16;function ROTL32(e,t){return e&=4294967295,t&=4294967295,e<<t|e>>>32-t}function LOAD32_LE(e,t){assert$4(e instanceof Uint8Array,"src not byte array");let r=e[t];return r|=e[t+1]<<8,r|=e[t+2]<<16,r|=e[t+3]<<24,r}function STORE32_LE(e,t,r){assert$4(e instanceof Uint8Array,"dest not byte array");var n=1,o=0;for(e[r]=t&255;++o<4&&(n*=256);)e[r+o]=t/n&255}function QUARTERROUND(e,t,r,n,o){e[t]+=e[r],e[o]=ROTL32(e[o]^e[t],16),e[n]+=e[o],e[r]=ROTL32(e[r]^e[n],12),e[t]+=e[r],e[o]=ROTL32(e[o]^e[t],8),e[n]+=e[o],e[r]=ROTL32(e[r]^e[n],7)}function crypto_core_hchacha20$1(e,t,r,n){assert$4(e instanceof Uint8Array&&e.length===32,"out is not an array of 32 bytes"),assert$4(r instanceof Uint8Array&&r.length===32,"k is not an array of 32 bytes"),assert$4(n===null||n instanceof Uint8Array&&n.length===16,"c is not null or an array of 16 bytes");let o=0;const s=new Uint32Array(16);for(n?(s[0]=LOAD32_LE(n,0),s[1]=LOAD32_LE(n,4),s[2]=LOAD32_LE(n,8),s[3]=LOAD32_LE(n,12)):(s[0]=1634760805,s[1]=857760878,s[2]=2036477234,s[3]=1797285236),s[4]=LOAD32_LE(r,0),s[5]=LOAD32_LE(r,4),s[6]=LOAD32_LE(r,8),s[7]=LOAD32_LE(r,12),s[8]=LOAD32_LE(r,16),s[9]=LOAD32_LE(r,20),s[10]=LOAD32_LE(r,24),s[11]=LOAD32_LE(r,28),s[12]=LOAD32_LE(t,0),s[13]=LOAD32_LE(t,4),s[14]=LOAD32_LE(t,8),s[15]=LOAD32_LE(t,12),o=0;o<10;o++)QUARTERROUND(s,0,4,8,12),QUARTERROUND(s,1,5,9,13),QUARTERROUND(s,2,6,10,14),QUARTERROUND(s,3,7,11,15),QUARTERROUND(s,0,5,10,15),QUARTERROUND(s,1,6,11,12),QUARTERROUND(s,2,7,8,13),QUARTERROUND(s,3,4,9,14);return STORE32_LE(e,s[0],0),STORE32_LE(e,s[1],4),STORE32_LE(e,s[2],8),STORE32_LE(e,s[3],12),STORE32_LE(e,s[12],16),STORE32_LE(e,s[13],20),STORE32_LE(e,s[14],24),STORE32_LE(e,s[15],28),0}function crypto_core_hchacha20_outputbytes(){return crypto_core_hchacha20_OUTPUTBYTES}function crypto_core_hchacha20_inputbytes(){return crypto_core_hchacha20_INPUTBYTES$1}function crypto_core_hchacha20_keybytes(){return crypto_core_hchacha20_KEYBYTES}function crypto_core_hchacha20_constbytes(){return crypto_core_hchacha20_CONSTBYTES}var hchacha20={crypto_core_hchacha20_INPUTBYTES:crypto_core_hchacha20_INPUTBYTES$1,LOAD32_LE,STORE32_LE,QUARTERROUND,crypto_core_hchacha20:crypto_core_hchacha20$1,crypto_core_hchacha20_outputbytes,crypto_core_hchacha20_inputbytes,crypto_core_hchacha20_keybytes,crypto_core_hchacha20_constbytes};const assert$3=nanoassert,{randombytes_buf}=randombytesExports,{crypto_stream_chacha20_ietf,crypto_stream_chacha20_ietf_xor,crypto_stream_chacha20_ietf_xor_ic,crypto_stream_chacha20_ietf_KEYBYTES}=crypto_stream_chacha20,{crypto_core_hchacha20,crypto_core_hchacha20_INPUTBYTES}=hchacha20,Poly1305=poly1305_1,{sodium_increment,sodium_is_zero,sodium_memcmp}=helpers$2,crypto_onetimeauth_poly1305_BYTES=16,crypto_secretstream_xchacha20poly1305_COUNTERBYTES=4,crypto_secretstream_xchacha20poly1305_INONCEBYTES=8,crypto_aead_xchacha20poly1305_ietf_KEYBYTES=32,crypto_secretstream_xchacha20poly1305_KEYBYTES=crypto_aead_xchacha20poly1305_ietf_KEYBYTES,crypto_aead_xchacha20poly1305_ietf_NPUBBYTES=24,crypto_secretstream_xchacha20poly1305_HEADERBYTES=crypto_aead_xchacha20poly1305_ietf_NPUBBYTES,crypto_aead_xchacha20poly1305_ietf_ABYTES=16,crypto_secretstream_xchacha20poly1305_ABYTES=1+crypto_aead_xchacha20poly1305_ietf_ABYTES,crypto_secretstream_xchacha20poly1305_MESSAGEBYTES_MAX=Number.MAX_SAFE_INTEGER,crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX=Number.MAX_SAFE_INTEGER,crypto_secretstream_xchacha20poly1305_TAGBYTES=1,crypto_secretstream_xchacha20poly1305_TAG_MESSAGE=new Uint8Array([0]),crypto_secretstream_xchacha20poly1305_TAG_PUSH=new Uint8Array([1]),crypto_secretstream_xchacha20poly1305_TAG_REKEY=new Uint8Array([2]),crypto_secretstream_xchacha20poly1305_TAG_FINAL=new Uint8Array([crypto_secretstream_xchacha20poly1305_TAG_PUSH|crypto_secretstream_xchacha20poly1305_TAG_REKEY]),crypto_secretstream_xchacha20poly1305_STATEBYTES=crypto_secretstream_xchacha20poly1305_KEYBYTES+crypto_secretstream_xchacha20poly1305_INONCEBYTES+crypto_secretstream_xchacha20poly1305_COUNTERBYTES+8,KEY_OFFSET=0,NONCE_OFFSET=crypto_secretstream_xchacha20poly1305_KEYBYTES,PAD_OFFSET=NONCE_OFFSET+crypto_secretstream_xchacha20poly1305_INONCEBYTES+crypto_secretstream_xchacha20poly1305_COUNTERBYTES,_pad0=new Uint8Array(16);function STORE64_LE(e,t){let r=1,n=0;for(e[0]=t&255;++n<8&&(r*=256);)e[n]=t/r&255}function crypto_secretstream_xchacha20poly1305_counter_reset(e){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long");const t=e.subarray(NONCE_OFFSET,PAD_OFFSET);for(let r=0;r<crypto_secretstream_xchacha20poly1305_COUNTERBYTES;r++)t[r]=0;t[0]=1}function crypto_secretstream_xchacha20poly1305_keygen(e){assert$3(e.length===crypto_secretstream_xchacha20poly1305_KEYBYTES),randombytes_buf(e)}function crypto_secretstream_xchacha20poly1305_init_push(e,t,r){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long"),assert$3(t instanceof Uint8Array&&t.length===crypto_secretstream_xchacha20poly1305_HEADERBYTES,"out not byte array of length crypto_secretstream_xchacha20poly1305_HEADERBYTES"),assert$3(r instanceof Uint8Array&&r.length===crypto_secretstream_xchacha20poly1305_KEYBYTES,"key not byte array of length crypto_secretstream_xchacha20poly1305_KEYBYTES");const n=e.subarray(KEY_OFFSET,NONCE_OFFSET),o=e.subarray(NONCE_OFFSET,PAD_OFFSET),s=e.subarray(PAD_OFFSET);randombytes_buf(t,crypto_secretstream_xchacha20poly1305_HEADERBYTES),crypto_core_hchacha20(n,t,r,null),crypto_secretstream_xchacha20poly1305_counter_reset(e);for(let a=0;a<crypto_secretstream_xchacha20poly1305_INONCEBYTES;a++)o[a+crypto_secretstream_xchacha20poly1305_COUNTERBYTES]=t[a+crypto_core_hchacha20_INPUTBYTES];s.fill(0)}function crypto_secretstream_xchacha20poly1305_init_pull(e,t,r){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long"),assert$3(t instanceof Uint8Array&&t.length===crypto_secretstream_xchacha20poly1305_HEADERBYTES,"_in not byte array of length crypto_secretstream_xchacha20poly1305_HEADERBYTES"),assert$3(r instanceof Uint8Array&&r.length===crypto_secretstream_xchacha20poly1305_KEYBYTES,"key not byte array of length crypto_secretstream_xchacha20poly1305_KEYBYTES");const n=e.subarray(KEY_OFFSET,NONCE_OFFSET),o=e.subarray(NONCE_OFFSET,PAD_OFFSET),s=e.subarray(PAD_OFFSET);crypto_core_hchacha20(n,t,r,null),crypto_secretstream_xchacha20poly1305_counter_reset(e);for(let a=0;a<crypto_secretstream_xchacha20poly1305_INONCEBYTES;a++)o[a+crypto_secretstream_xchacha20poly1305_COUNTERBYTES]=t[a+crypto_core_hchacha20_INPUTBYTES];s.fill(0)}function crypto_secretstream_xchacha20poly1305_rekey(e){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long");const t=e.subarray(KEY_OFFSET,NONCE_OFFSET),r=e.subarray(NONCE_OFFSET,PAD_OFFSET),n=new Uint8Array(crypto_stream_chacha20_ietf_KEYBYTES+crypto_secretstream_xchacha20poly1305_INONCEBYTES);let o;for(o=0;o<crypto_stream_chacha20_ietf_KEYBYTES;o++)n[o]=t[o];for(o=0;o<crypto_secretstream_xchacha20poly1305_INONCEBYTES;o++)n[crypto_stream_chacha20_ietf_KEYBYTES+o]=r[crypto_secretstream_xchacha20poly1305_COUNTERBYTES+o];for(crypto_stream_chacha20_ietf_xor(n,n,r,t),o=0;o<crypto_stream_chacha20_ietf_KEYBYTES;o++)t[o]=n[o];for(o=0;o<crypto_secretstream_xchacha20poly1305_INONCEBYTES;o++)r[crypto_secretstream_xchacha20poly1305_COUNTERBYTES+o]=n[crypto_stream_chacha20_ietf_KEYBYTES+o];crypto_secretstream_xchacha20poly1305_counter_reset(e)}function crypto_secretstream_xchacha20poly1305_push(e,t,r,n,o){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long"),n||(n=new Uint8Array(0));const s=e.subarray(KEY_OFFSET,NONCE_OFFSET),a=e.subarray(NONCE_OFFSET,PAD_OFFSET),c=new Uint8Array(64),l=new Uint8Array(8);assert$3(crypto_secretstream_xchacha20poly1305_MESSAGEBYTES_MAX<=crypto_aead_chacha20poly1305_ietf_MESSAGEBYTES_MAX),crypto_stream_chacha20_ietf(c,a,s);const h=new Poly1305(c);c.fill(0),h.update(n,0,n.byteLength),h.update(_pad0,0,16-n.byteLength&15),c[0]=o[0],crypto_stream_chacha20_ietf_xor_ic(c,c,a,1,s),h.update(c,0,c.byteLength),t[0]=c[0];const u=t.subarray(1,t.byteLength);crypto_stream_chacha20_ietf_xor_ic(u,r,a,2,s),h.update(u,0,r.byteLength),h.update(_pad0,0,16-c.byteLength+r.byteLength&15),STORE64_LE(l,n.byteLength),h.update(l,0,l.byteLength),STORE64_LE(l,c.byteLength+r.byteLength),h.update(l,0,l.byteLength);const d=t.subarray(1+r.byteLength,t.byteLength);return h.finish(d,0),assert$3(crypto_onetimeauth_poly1305_BYTES>=crypto_secretstream_xchacha20poly1305_INONCEBYTES),xor_buf(a.subarray(crypto_secretstream_xchacha20poly1305_COUNTERBYTES,a.length),d,crypto_secretstream_xchacha20poly1305_INONCEBYTES),sodium_increment(a),(o[0]&crypto_secretstream_xchacha20poly1305_TAG_REKEY||sodium_is_zero(a.subarray(0,crypto_secretstream_xchacha20poly1305_COUNTERBYTES)))&&crypto_secretstream_xchacha20poly1305_rekey(e),crypto_secretstream_xchacha20poly1305_ABYTES+r.byteLength}function crypto_secretstream_xchacha20poly1305_pull(e,t,r,n,o){assert$3(e.byteLength===crypto_secretstream_xchacha20poly1305_STATEBYTES,"state is should be crypto_secretstream_xchacha20poly1305_STATEBYTES long"),o||(o=new Uint8Array(0));const s=e.subarray(KEY_OFFSET,NONCE_OFFSET),a=e.subarray(NONCE_OFFSET,PAD_OFFSET),c=new Uint8Array(64),l=new Uint8Array(8),h=new Uint8Array(crypto_onetimeauth_poly1305_BYTES);assert$3(n.byteLength>=crypto_secretstream_xchacha20poly1305_ABYTES,"ciphertext is too short.");const u=n.byteLength-crypto_secretstream_xchacha20poly1305_ABYTES;crypto_stream_chacha20_ietf(c,a,s);const d=new Poly1305(c);c.fill(0),d.update(o,0,o.byteLength),d.update(_pad0,0,16-o.byteLength&15),c.fill(0),c[0]=n[0],crypto_stream_chacha20_ietf_xor_ic(c,c,a,1,s),r[0]=c[0],c[0]=n[0],d.update(c,0,c.byteLength);const f=n.subarray(1,n.length);d.update(f,0,u),d.update(_pad0,0,16-c.byteLength+u&15),STORE64_LE(l,o.byteLength),d.update(l,0,l.byteLength),STORE64_LE(l,c.byteLength+t.byteLength),d.update(l,0,l.byteLength),d.finish(h,0);const _=n.subarray(1+u,n.length);if(!sodium_memcmp(h,_))throw h.fill(0),new Error("MAC could not be verified.");return crypto_stream_chacha20_ietf_xor_ic(t,f.subarray(0,t.length),a,2,s),xor_buf(a.subarray(crypto_secretstream_xchacha20poly1305_COUNTERBYTES,a.length),h,crypto_secretstream_xchacha20poly1305_INONCEBYTES),sodium_increment(a),(r&crypto_secretstream_xchacha20poly1305_TAG_REKEY||sodium_is_zero(a.subarray(0,crypto_secretstream_xchacha20poly1305_COUNTERBYTES)))&&crypto_secretstream_xchacha20poly1305_rekey(e),u}function xor_buf(e,t,r){for(let n=0;n<r;n++)e[n]^=t[n]}var crypto_secretstream={crypto_secretstream_xchacha20poly1305_keygen,crypto_secretstream_xchacha20poly1305_init_push,crypto_secretstream_xchacha20poly1305_init_pull,crypto_secretstream_xchacha20poly1305_rekey,crypto_secretstream_xchacha20poly1305_push,crypto_secretstream_xchacha20poly1305_pull,crypto_secretstream_xchacha20poly1305_STATEBYTES,crypto_secretstream_xchacha20poly1305_ABYTES,crypto_secretstream_xchacha20poly1305_HEADERBYTES,crypto_secretstream_xchacha20poly1305_KEYBYTES,crypto_secretstream_xchacha20poly1305_MESSAGEBYTES_MAX,crypto_secretstream_xchacha20poly1305_TAGBYTES,crypto_secretstream_xchacha20poly1305_TAG_MESSAGE,crypto_secretstream_xchacha20poly1305_TAG_PUSH,crypto_secretstream_xchacha20poly1305_TAG_REKEY,crypto_secretstream_xchacha20poly1305_TAG_FINAL},crypto_shorthash={},siphash24$1,hasRequiredSiphash24;function requireSiphash24(){if(hasRequiredSiphash24)return siphash24$1;hasRequiredSiphash24=1;var e=(s,a)=>function(){return a||(0,s[Object.keys(s)[0]])((a={exports:{}}).exports,a),a.exports},t=(()=>{for(var s=new Uint8Array(128),a=0;a<64;a++)s[a<26?a+65:a<52?a+71:a<62?a-4:a*4-205]=a;return c=>{for(var l=c.length,h=new Uint8Array((l-(c[l-1]=="=")-(c[l-2]=="="))*3/4|0),u=0,d=0;u<l;){var f=s[c.charCodeAt(u++)],_=s[c.charCodeAt(u++)],p=s[c.charCodeAt(u++)],y=s[c.charCodeAt(u++)];h[d++]=f<<2|_>>4,h[d++]=_<<4|p>>2,h[d++]=p<<6|y}return h}})(),r=e({"wasm-binary:./siphash24.wat"(s,a){a.exports=t("AGFzbQEAAAABBgFgAn9/AAMCAQAFBQEBCpBOBxQCBm1lbW9yeQIAB3NpcGhhc2gAAArdCAHaCAIIfgJ/QvXKzYPXrNu38wAhAkLt3pHzlszct+QAIQNC4eSV89bs2bzsACEEQvPK0cunjNmy9AAhBUEIKQMAIQdBECkDACEIIAGtQjiGIQYgAUEHcSELIAAgAWogC2shCiAFIAiFIQUgBCAHhSEEIAMgCIUhAyACIAeFIQICQANAIAAgCkYNASAAKQMAIQkgBSAJhSEFIAIgA3whAiADQg2JIQMgAyAChSEDIAJCIIkhAiAEIAV8IQQgBUIQiSEFIAUgBIUhBSACIAV8IQIgBUIViSEFIAUgAoUhBSAEIAN8IQQgA0IRiSEDIAMgBIUhAyAEQiCJIQQgAiADfCECIANCDYkhAyADIAKFIQMgAkIgiSECIAQgBXwhBCAFQhCJIQUgBSAEhSEFIAIgBXwhAiAFQhWJIQUgBSAChSEFIAQgA3whBCADQhGJIQMgAyAEhSEDIARCIIkhBCACIAmFIQIgAEEIaiEADAALCwJAAkACQAJAAkACQAJAAkAgCw4HBwYFBAMCAQALIAYgADEABkIwhoQhBgsgBiAAMQAFQiiGhCEGCyAGIAAxAARCIIaEIQYLIAYgADEAA0IYhoQhBgsgBiAAMQACQhCGhCEGCyAGIAAxAAFCCIaEIQYLIAYgADEAAIQhBgsgBSAGhSEFIAIgA3whAiADQg2JIQMgAyAChSEDIAJCIIkhAiAEIAV8IQQgBUIQiSEFIAUgBIUhBSACIAV8IQIgBUIViSEFIAUgAoUhBSAEIAN8IQQgA0IRiSEDIAMgBIUhAyAEQiCJIQQgAiADfCECIANCDYkhAyADIAKFIQMgAkIgiSECIAQgBXwhBCAFQhCJIQUgBSAEhSEFIAIgBXwhAiAFQhWJIQUgBSAChSEFIAQgA3whBCADQhGJIQMgAyAEhSEDIARCIIkhBCACIAaFIQIgBEL/AYUhBCACIAN8IQIgA0INiSEDIAMgAoUhAyACQiCJIQIgBCAFfCEEIAVCEIkhBSAFIASFIQUgAiAFfCECIAVCFYkhBSAFIAKFIQUgBCADfCEEIANCEYkhAyADIASFIQMgBEIgiSEEIAIgA3whAiADQg2JIQMgAyAChSEDIAJCIIkhAiAEIAV8IQQgBUIQiSEFIAUgBIUhBSACIAV8IQIgBUIViSEFIAUgAoUhBSAEIAN8IQQgA0IRiSEDIAMgBIUhAyAEQiCJIQQgAiADfCECIANCDYkhAyADIAKFIQMgAkIgiSECIAQgBXwhBCAFQhCJIQUgBSAEhSEFIAIgBXwhAiAFQhWJIQUgBSAChSEFIAQgA3whBCADQhGJIQMgAyAEhSEDIARCIIkhBCACIAN8IQIgA0INiSEDIAMgAoUhAyACQiCJIQIgBCAFfCEEIAVCEIkhBSAFIASFIQUgAiAFfCECIAVCFYkhBSAFIAKFIQUgBCADfCEEIANCEYkhAyADIASFIQMgBEIgiSEEQQAgAiADIAQgBYWFhTcDAAs=")}}),n=r(),o=new WebAssembly.Module(n);return siphash24$1=s=>new WebAssembly.Instance(o,s).exports,siphash24$1}var fallback_1=fallback$1;function _add(e,t){var r=e.l+t.l,n={h:e.h+t.h+(r/2>>>31)>>>0,l:r>>>0};e.h=n.h,e.l=n.l}function _xor(e,t){e.h^=t.h,e.h>>>=0,e.l^=t.l,e.l>>>=0}function _rotl(e,t){var r={h:e.h<<t|e.l>>>32-t,l:e.l<<t|e.h>>>32-t};e.h=r.h,e.l=r.l}function _rotl32(e){var t=e.l;e.l=e.h,e.h=t}function _compress(e,t,r,n){_add(e,t),_add(r,n),_rotl(t,13),_rotl(n,16),_xor(t,e),_xor(n,r),_rotl32(e),_add(r,t),_add(e,n),_rotl(t,17),_rotl(n,21),_xor(t,r),_xor(n,e),_rotl32(r)}function _get_int(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}function fallback$1(e,t,r){var n={h:_get_int(r,4),l:_get_int(r,0)},o={h:_get_int(r,12),l:_get_int(r,8)},s={h:n.h,l:n.l},a=n,c={h:o.h,l:o.l},l=o,h,u=0,d=t.length,f=d-7,_=new Uint8Array(new ArrayBuffer(8));for(_xor(s,{h:1936682341,l:1886610805}),_xor(c,{h:1685025377,l:1852075885}),_xor(a,{h:1819895653,l:1852142177}),_xor(l,{h:1952801890,l:2037671283});u<f;)h={h:_get_int(t,u+4),l:_get_int(t,u)},_xor(l,h),_compress(s,c,a,l),_compress(s,c,a,l),_xor(s,h),u+=8;_[7]=d;for(var p=0;u<d;)_[p++]=t[u++];for(;p<7;)_[p++]=0;h={h:_[7]<<24|_[6]<<16|_[5]<<8|_[4],l:_[3]<<24|_[2]<<16|_[1]<<8|_[0]},_xor(l,h),_compress(s,c,a,l),_compress(s,c,a,l),_xor(s,h),_xor(a,{h:0,l:255}),_compress(s,c,a,l),_compress(s,c,a,l),_compress(s,c,a,l),_compress(s,c,a,l);var y=s;_xor(y,c),_xor(y,a),_xor(y,l),e[0]=y.l&255,e[1]=y.l>>8&255,e[2]=y.l>>16&255,e[3]=y.l>>24&255,e[4]=y.h&255,e[5]=y.h>>8&255,e[6]=y.h>>16&255,e[7]=y.h>>24&255}var assert$2=nanoassert,wasm$3=typeof WebAssembly<"u"&&requireSiphash24()(),fallback=fallback_1,siphash24_1=siphash24,BYTES=siphash24.BYTES=8,KEYBYTES=siphash24.KEYBYTES=16;siphash24.WASM_SUPPORTED=!!wasm$3,siphash24.WASM_LOADED=!!wasm$3;var memory$3=new Uint8Array(wasm$3?wasm$3.memory.buffer:0);function siphash24(e,t,r,n){return r||(r=new Uint8Array(8)),n!==!0&&(assert$2(r.length>=BYTES,"output must be at least "+BYTES),assert$2(t.length>=KEYBYTES,"key must be at least "+KEYBYTES)),wasm$3?(e.length+24>memory$3.length&&realloc(e.length+24),memory$3.set(t,8),memory$3.set(e,24),wasm$3.siphash(24,e.length),r.set(memory$3.subarray(0,8))):fallback(r,e,t),r}function realloc(e){wasm$3.memory.grow(Math.max(0,Math.ceil(Math.abs(e-memory$3.length)/65536))),memory$3=new Uint8Array(wasm$3.memory.buffer)}var siphash=siphash24_1;if(new Uint16Array([1])[0]!==1)throw new Error("Big endian architecture is not supported.");crypto_shorthash.crypto_shorthash_PRIMITIVE="siphash24",crypto_shorthash.crypto_shorthash_BYTES=siphash.BYTES,crypto_shorthash.crypto_shorthash_KEYBYTES=siphash.KEYBYTES,crypto_shorthash.crypto_shorthash_WASM_SUPPORTED=siphash.WASM_SUPPORTED,crypto_shorthash.crypto_shorthash_WASM_LOADED=siphash.WASM_LOADED,crypto_shorthash.crypto_shorthash=shorthash;function shorthash(e,t,r,n){siphash(t,r,e,n)}const{crypto_verify_32}=crypto_verifyExports,{crypto_hash}=crypto_hash_1,{gf,gf0,gf1,D,D2,X,Y,I,A,Z,M,S,sel25519,pack25519,inv25519,unpack25519}=ed25519,{randombytes:randombytes$1}=randombytesExports,{crypto_scalarmult_BYTES}=crypto_scalarmult_1,{crypto_hash_sha512_BYTES}=crypto_hash_1,assert$1=nanoassert,crypto_sign_ed25519_PUBLICKEYBYTES=32,crypto_sign_ed25519_SECRETKEYBYTES=64,crypto_sign_ed25519_SEEDBYTES=32,crypto_sign_ed25519_BYTES=64,crypto_sign_BYTES=crypto_sign_ed25519_BYTES,crypto_sign_PUBLICKEYBYTES=crypto_sign_ed25519_PUBLICKEYBYTES,crypto_sign_SECRETKEYBYTES=crypto_sign_ed25519_SECRETKEYBYTES,crypto_sign_SEEDBYTES=crypto_sign_ed25519_SEEDBYTES;var crypto_sign_1={crypto_sign_keypair,crypto_sign_seed_keypair,crypto_sign,crypto_sign_detached,crypto_sign_open,crypto_sign_verify_detached,crypto_sign_BYTES,crypto_sign_PUBLICKEYBYTES,crypto_sign_SECRETKEYBYTES,crypto_sign_SEEDBYTES,crypto_sign_ed25519_PUBLICKEYBYTES,crypto_sign_ed25519_SECRETKEYBYTES,crypto_sign_ed25519_SEEDBYTES,crypto_sign_ed25519_BYTES,crypto_sign_ed25519_pk_to_curve25519,crypto_sign_ed25519_sk_to_curve25519,crypto_sign_ed25519_sk_to_pk,unpackneg,pack};function set25519(e,t){for(let r=0;r<16;r++)e[r]=t[r]|0}function pow2523(e,t){var r=gf(),n;for(n=0;n<16;n++)r[n]=t[n];for(n=250;n>=0;n--)S(r,r),n!==1&&M(r,r,t);for(n=0;n<16;n++)e[n]=r[n]}function add(e,t){var r=gf(),n=gf(),o=gf(),s=gf(),a=gf(),c=gf(),l=gf(),h=gf(),u=gf();Z(r,e[1],e[0]),Z(u,t[1],t[0]),M(r,r,u),A(n,e[0],e[1]),A(u,t[0],t[1]),M(n,n,u),M(o,e[3],t[3]),M(o,o,D2),M(s,e[2],t[2]),A(s,s,s),Z(a,n,r),Z(c,s,o),A(l,s,o),A(h,n,r),M(e[0],a,c),M(e[1],h,l),M(e[2],l,c),M(e[3],a,h)}function cswap(e,t,r){var n;for(n=0;n<4;n++)sel25519(e[n],t[n],r)}function pack(e,t){var r=gf(),n=gf(),o=gf();inv25519(o,t[2]),M(r,t[0],o),M(n,t[1],o),pack25519(e,n),e[31]^=par25519(r)<<7}function scalarmult(e,t,r){var n=[gf(t[0]),gf(t[1]),gf(t[2]),gf(t[3])],o,s;for(set25519(e[0],gf0),set25519(e[1],gf1),set25519(e[2],gf1),set25519(e[3],gf0),s=255;s>=0;--s)o=r[s/8|0]>>(s&7)&1,cswap(e,n,o),add(n,e),add(e,e),cswap(e,n,o)}function scalarbase(e,t){var r=[gf(),gf(),gf(),gf()];set25519(r[0],X),set25519(r[1],Y),set25519(r[2],gf1),M(r[3],X,Y),scalarmult(e,r,t)}function crypto_sign_keypair(e,t,r){check(e,crypto_sign_PUBLICKEYBYTES),check(t,crypto_sign_SECRETKEYBYTES);var n=new Uint8Array(64),o=[gf(),gf(),gf(),gf()],s;for(r||randombytes$1(t,32),crypto_hash(n,t,32),n[0]&=248,n[31]&=127,n[31]|=64,scalarbase(o,n),pack(e,o),s=0;s<32;s++)t[s+32]=e[s]}function crypto_sign_seed_keypair(e,t,r){return check(r,crypto_sign_SEEDBYTES),t.set(r),crypto_sign_keypair(e,t,!0)}var L=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function modL(e,t){var r,n,o,s;for(n=63;n>=32;--n){for(r=0,o=n-32,s=n-12;o<s;++o)t[o]+=r-16*t[n]*L[o-(n-32)],r=t[o]+128>>8,t[o]-=r*256;t[o]+=r,t[n]=0}for(r=0,o=0;o<32;o++)t[o]+=r-(t[31]>>4)*L[o],r=t[o]>>8,t[o]&=255;for(o=0;o<32;o++)t[o]-=r*L[o];for(n=0;n<32;n++)t[n+1]+=t[n]>>8,e[n]=t[n]&255}function reduce(e){var t=new Float64Array(64);for(let r=0;r<64;r++)t[r]=e[r];for(let r=0;r<64;r++)e[r]=0;modL(e,t)}function crypto_sign(e,t,r){check(e,crypto_sign_BYTES+t.length),check(t,0),check(r,crypto_sign_SECRETKEYBYTES);var n=t.length,o=new Uint8Array(64),s=new Uint8Array(64),a=new Uint8Array(64),c,l,h=new Float64Array(64),u=[gf(),gf(),gf(),gf()];crypto_hash(o,r,32),o[0]&=248,o[31]&=127,o[31]|=64;var d=n+64;for(c=0;c<n;c++)e[64+c]=t[c];for(c=0;c<32;c++)e[32+c]=o[32+c];for(crypto_hash(a,e.subarray(32),n+32),reduce(a),scalarbase(u,a),pack(e,u),c=32;c<64;c++)e[c]=r[c];for(crypto_hash(s,e,n+64),reduce(s),c=0;c<64;c++)h[c]=0;for(c=0;c<32;c++)h[c]=a[c];for(c=0;c<32;c++)for(l=0;l<32;l++)h[c+l]+=s[c]*o[l];return modL(e.subarray(32),h),d}function crypto_sign_detached(e,t,r){var n=new Uint8Array(t.length+crypto_sign_BYTES);crypto_sign(n,t,r);for(let o=0;o<crypto_sign_BYTES;o++)e[o]=n[o]}function unpackneg(e,t){var r=gf(),n=gf(),o=gf(),s=gf(),a=gf(),c=gf(),l=gf();return set25519(e[2],gf1),unpack25519(e[1],t),S(o,e[1]),M(s,o,D),Z(o,o,e[2]),A(s,e[2],s),S(a,s),S(c,a),M(l,c,a),M(r,l,o),M(r,r,s),pow2523(r,r),M(r,r,o),M(r,r,s),M(r,r,s),M(e[0],r,s),S(n,e[0]),M(n,n,s),neq25519(n,o)||M(e[0],e[0],I),S(n,e[0]),M(n,n,s),neq25519(n,o)?(par25519(e[0])===t[31]>>7&&Z(e[0],gf(),e[0]),M(e[3],e[0],e[1]),!0):!1}function crypto_sign_open(e,t,r){check(e,t.length-crypto_sign_BYTES),check(t,crypto_sign_BYTES),check(r,crypto_sign_PUBLICKEYBYTES);var n=t.length,o=new Uint8Array(t.length),s,a=new Uint8Array(32),c=new Uint8Array(64),l=[gf(),gf(),gf(),gf()],h=[gf(),gf(),gf(),gf()];if(n<64||!unpackneg(h,r))return!1;for(s=0;s<n;s++)o[s]=t[s];for(s=0;s<32;s++)o[s+32]=r[s];if(crypto_hash(c,o,n),reduce(c),scalarmult(l,h,c),scalarbase(h,t.subarray(32)),add(l,h),pack(a,l),n-=64,!crypto_verify_32(t,0,a,0)){for(s=0;s<n;s++)o[s]=0;return!1}for(s=0;s<n;s++)e[s]=t[s+64];return!0}function crypto_sign_verify_detached(e,t,r){check(e,crypto_sign_BYTES);var n=new Uint8Array(t.length+crypto_sign_BYTES),o=0;for(o=0;o<crypto_sign_BYTES;o++)n[o]=e[o];for(o=0;o<t.length;o++)n[o+crypto_sign_BYTES]=t[o];return crypto_sign_open(t,n,r)}function par25519(e){var t=new Uint8Array(32);return pack25519(t,e),t[0]&1}function neq25519(e,t){var r=new Uint8Array(32),n=new Uint8Array(32);return pack25519(r,e),pack25519(n,t),crypto_verify_32(r,0,n,0)}function ed25519_mul_l(e,t){scalarmult(e,t,L)}function ed25519_is_on_main_subgroup(e){var t=[gf(),gf(),gf(),gf()];ed25519_mul_l(t,e);var r=0;for(let n=0;n<16;n++)r|=t[0][n]&65535;return r===0}function crypto_sign_ed25519_pk_to_curve25519(e,t){check(e,crypto_sign_PUBLICKEYBYTES),check(t,crypto_sign_ed25519_PUBLICKEYBYTES);var r=[gf(),gf(),gf(),gf()],n=gf([1]),o=gf([1]);assert$1(isSmallOrder(t)&&unpackneg(r,t)&&ed25519_is_on_main_subgroup(r),"Cannot convert key: bad point");for(let s=0;s<r.length;s++)pack25519(e,r[s]);return Z(o,o,r[1]),A(n,n,r[1]),inv25519(o,o),M(n,n,o),pack25519(e,n),0}function isSmallOrder(e){Uint8Array.from([]);var t=[Uint8Array.from([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Uint8Array.from([1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Uint8Array.from([38,232,149,143,194,178,39,176,69,195,244,137,242,239,152,240,213,223,172,5,211,198,51,57,177,56,2,136,109,83,252,5]),Uint8Array.from([199,23,106,112,61,77,216,79,186,60,11,118,13,16,103,15,42,32,83,250,44,57,204,198,78,199,253,119,146,172,3,122]),Uint8Array.from([236,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127]),Uint8Array.from([237,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127]),Uint8Array.from([238,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,127])],r=new Uint8Array(7),n;check(t,7);for(let s=0;s<t.length;s++)for(n=0;n<31;n++)r[s]|=e[n]^t[s][n];for(let s=0;s<t.length;s++)r[s]|=e[n]&127^t[s][n];var o=0;for(let s=0;s<t.length;s++)o|=r[s]-1;return(o>>8&1)===0}function crypto_sign_ed25519_sk_to_pk(e,t){return check(e,crypto_sign_ed25519_PUBLICKEYBYTES),e.set(t.subarray(crypto_sign_ed25519_SEEDBYTES)),e}function crypto_sign_ed25519_sk_to_curve25519(e,t){assert$1(e&&e.byteLength===crypto_scalarmult_BYTES,"curveSk must be 'crypto_sign_SECRETKEYBYTES' long"),assert$1(t&&t.byteLength===crypto_sign_ed25519_SECRETKEYBYTES,"edSk must be 'crypto_sign_ed25519_SECRETKEYBYTES' long");var r=new Uint8Array(crypto_hash_sha512_BYTES);return crypto_hash(r,t,32),r[0]&=248,r[31]&=127,r[31]|=64,e.set(r.subarray(0,crypto_scalarmult_BYTES)),r.fill(0),e}function check(e,t,r="Argument"){if(!e||t&&e.length<t)throw new Error(r+" must be a buffer"+(t?" of length "+t:""))}(function(e){t(randombytesExports),t(memory$4),t(helpers$2),t(crypto_verifyExports),t(crypto_auth_1),t(crypto_box),t(crypto_generichashExports),t(crypto_hash_1),t(crypto_hash_sha256_1),t(crypto_kdfExports),t(crypto_kx$2),t(crypto_aead$2),t(crypto_onetimeauth_1),t(crypto_scalarmult_1),t(crypto_secretbox_1),t(crypto_secretstream),t(crypto_shorthash),t(crypto_sign_1),t(crypto_stream$1),t(crypto_stream_chacha20);function t(r){Object.keys(r).forEach(function(n){e.exports[n]=r[n]})}})(sodiumJavascript);var sodiumJavascriptExports=sodiumJavascript.exports,sodiumUniversal=sodiumJavascriptExports;const import$sodium_universal=getDefaultExportFromCjs(sodiumUniversal);var uint64be={};(function(e){const t=Math.pow(2,32);e.encodingLength=function(){return 8},e.encode=function(r,n,o){n||(n=Buffer.allocUnsafe(8)),o||(o=0);const s=Math.floor(r/t),a=r-s*t;return n.writeUInt32BE(s,o),n.writeUInt32BE(a,o+4),n},e.decode=function(r,n){n||(n=0);const o=r.readUInt32BE(n),s=r.readUInt32BE(n+4);return o*t+s},e.encode.bytes=8,e.decode.bytes=8})(uint64be),function(e){const t=sodiumUniversal,r=uint64be,n=Buffer.from([0]),o=Buffer.from([1]),s=Buffer.from([2]),a=Buffer.from([3]),c=Buffer.from("hypercore"),l=Buffer.from("hypercore capability");e.writerCapability=function(u,d,f){if(!f)return null;const _=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(_,[a,l,f.tx.slice(0,32),u],f.rx.slice(0,32)),e.sign(_,d)},e.verifyRemoteWriterCapability=function(u,d,f){if(!f)return null;const _=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(_,[a,l,f.rx.slice(0,32),u],f.tx.slice(0,32)),e.verify(_,d,u)},e.capability=function(u,d){if(!d)return null;const f=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[l,d.tx.slice(0,32),u],d.rx.slice(0,32)),f},e.remoteCapability=function(u,d){if(!d)return null;const f=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[l,d.rx.slice(0,32),u],d.tx.slice(0,32)),f},e.keyPair=function(u){const d=Buffer.allocUnsafe(t.crypto_sign_PUBLICKEYBYTES),f=Buffer.allocUnsafe(t.crypto_sign_SECRETKEYBYTES);return u?t.crypto_sign_seed_keypair(d,f,u):t.crypto_sign_keypair(d,f),{publicKey:d,secretKey:f}},e.validateKeyPair=function(u){const d=Buffer.allocUnsafe(t.crypto_sign_PUBLICKEYBYTES);return t.crypto_sign_ed25519_sk_to_pk(d,u.secretKey),d.equals(u.publicKey)},e.sign=function(u,d){const f=Buffer.allocUnsafe(t.crypto_sign_BYTES);return t.crypto_sign_detached(f,u,d),f},e.verify=function(u,d,f){return t.crypto_sign_verify_detached(d,u,f)},e.data=function(u){const d=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(d,[n,h(u.length),u]),d},e.leaf=function(u){return e.data(u.data)},e.parent=function(u,d){if(u.index>d.index){const _=u;u=d,d=_}const f=Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[o,h(u.size+d.size),u.hash,d.hash]),f},e.tree=function(u,d){const f=new Array(3*u.length+1);var _=0;f[_++]=s;for(var p=0;p<u.length;p++){const y=u[p];f[_++]=y.hash,f[_++]=h(y.index),f[_++]=h(y.size)}return d||(d=Buffer.allocUnsafe(32)),t.crypto_generichash_batch(d,f),d},e.signable=function(u,d){const f=Buffer.allocUnsafe(40);return Buffer.isBuffer(u)?u.copy(f):e.tree(u,f.slice(0,32)),r.encode(d,f.slice(32)),f},e.randomBytes=function(u){const d=Buffer.allocUnsafe(u);return t.randombytes_buf(d),d},e.discoveryKey=function(u){const d=Buffer.allocUnsafe(32);return t.crypto_generichash(d,c,u),d},t.sodium_free?e.free=function(u){u.secure&&t.sodium_free(u)}:e.free=function(){};function h(u){return r.encode(u,Buffer.allocUnsafe(8))}}(hypercoreCrypto);const crypto2=getDefaultExportFromCjs(hypercoreCrypto);var __dxlog_file$q="/home/runner/work/dxos/dxos/packages/common/crypto/src/keys.ts",SIGNATURE_LENGTH=64,createKeyPair=e=>crypto2.keyPair(),discoveryKey=e=>crypto2.discoveryKey(PublicKey.from(e).asBuffer().slice(1)),randomBytes$1=(e=32)=>crypto2.randomBytes(e),sign=(e,t)=>(invariant$1(export_Buffer.isBuffer(e),void 0,{F:__dxlog_file$q,L:52,S:void 0,A:["Buffer.isBuffer(message)",""]}),invariant$1(export_Buffer.isBuffer(t)&&t.length===SECRET_KEY_LENGTH,void 0,{F:__dxlog_file$q,L:53,S:void 0,A:["Buffer.isBuffer(secretKey) && secretKey.length === SECRET_KEY_LENGTH",""]}),crypto2.sign(e,t)),verify=(e,t,r)=>(invariant$1(export_Buffer.isBuffer(e),void 0,{F:__dxlog_file$q,L:66,S:void 0,A:["Buffer.isBuffer(message)",""]}),invariant$1(export_Buffer.isBuffer(t)&&t.length===SIGNATURE_LENGTH,void 0,{F:__dxlog_file$q,L:67,S:void 0,A:["Buffer.isBuffer(signature) && signature.length === SIGNATURE_LENGTH",""]}),invariant$1(export_Buffer.isBuffer(r)&&r.length===PUBLIC_KEY_LENGTH,void 0,{F:__dxlog_file$q,L:68,S:void 0,A:["Buffer.isBuffer(publicKey) && publicKey.length === PUBLIC_KEY_LENGTH",""]}),crypto2.verify(e,t,r)),subtleCrypto=crypto.subtle,verifySignature=async(e,t,r)=>{let n;try{n=await subtleCrypto.importKey("raw",e.asUint8Array(),{name:"ECDSA",namedCurve:"P-256"},!0,["verify"])}catch{return!1}return subtleCrypto.verify({name:"ECDSA",hash:"SHA-256"},n,r,t)},memory$1=sodiumJavascriptExports;const memory$2=getDefaultExportFromCjs(memory$1),import$sodium_universal_memory=_mergeNamespaces({__proto__:null,default:memory$2},[memory$1]);var crypto_aead=sodiumJavascriptExports;const crypto_aead$1=getDefaultExportFromCjs(crypto_aead),import$sodium_universal_crypto_aead=_mergeNamespaces({__proto__:null,default:crypto_aead$1},[crypto_aead]);var helpers=sodiumJavascriptExports;const helpers$1=getDefaultExportFromCjs(helpers),import$sodium_universal_helpers=_mergeNamespaces({__proto__:null,default:helpers$1},[helpers]);var crypto_generichash=sodiumJavascriptExports;const crypto_generichash$1=getDefaultExportFromCjs(crypto_generichash),import$sodium_universal_crypto_generichash=_mergeNamespaces({__proto__:null,default:crypto_generichash$1},[crypto_generichash]);var crypto_kx=sodiumJavascriptExports;const crypto_kx$1=getDefaultExportFromCjs(crypto_kx),import$sodium_universal_crypto_kx=_mergeNamespaces({__proto__:null,default:crypto_kx$1},[crypto_kx]);var crypto_scalarmult=sodiumJavascriptExports;const crypto_scalarmult$1=getDefaultExportFromCjs(crypto_scalarmult),import$sodium_universal_crypto_scalarmult=_mergeNamespaces({__proto__:null,default:crypto_scalarmult$1},[crypto_scalarmult]);var events=eventsExports,inherits$1=inherits_browserExports,queueTick=queueMicrotask_1$1,NOT_READABLE=defaultImpl(new Error("Not readable")),NOT_WRITABLE=defaultImpl(new Error("Not writable")),NOT_DELETABLE=defaultImpl(new Error("Not deletable")),NOT_STATABLE=defaultImpl(new Error("Not statable")),NO_OPEN_READABLE=defaultImpl(new Error("No readonly open")),READ_OP=0,WRITE_OP=1,DEL_OP=2,STAT_OP=3,OPEN_OP=4,CLOSE_OP=5,DESTROY_OP=6,randomAccessStorage=RandomAccess$1;function RandomAccess$1(e){if(!(this instanceof RandomAccess$1))return new RandomAccess$1(e);events.EventEmitter.call(this),this._queued=[],this._pending=0,this._needsOpen=!0,this.opened=!1,this.closed=!1,this.destroyed=!1,e&&(e.openReadonly&&(this._openReadonly=e.openReadonly),e.open&&(this._open=e.open),e.read&&(this._read=e.read),e.write&&(this._write=e.write),e.del&&(this._del=e.del),e.stat&&(this._stat=e.stat),e.close&&(this._close=e.close),e.destroy&&(this._destroy=e.destroy)),this.preferReadonly=this._openReadonly!==NO_OPEN_READABLE,this.readable=this._read!==NOT_READABLE,this.writable=this._write!==NOT_WRITABLE,this.deletable=this._del!==NOT_DELETABLE,this.statable=this._stat!==NOT_STATABLE}inherits$1(RandomAccess$1,events.EventEmitter),RandomAccess$1.prototype.read=function(e,t,r){this.run(new Request(this,READ_OP,e,t,null,r))},RandomAccess$1.prototype._read=NOT_READABLE,RandomAccess$1.prototype.write=function(e,t,r){r||(r=noop$2),openWritable(this),this.run(new Request(this,WRITE_OP,e,t.length,t,r))},RandomAccess$1.prototype._write=NOT_WRITABLE,RandomAccess$1.prototype.del=function(e,t,r){r||(r=noop$2),openWritable(this),this.run(new Request(this,DEL_OP,e,t,null,r))},RandomAccess$1.prototype._del=NOT_DELETABLE,RandomAccess$1.prototype.stat=function(e){this.run(new Request(this,STAT_OP,0,0,null,e))},RandomAccess$1.prototype._stat=NOT_STATABLE,RandomAccess$1.prototype.open=function(e){if(e||(e=noop$2),this.opened&&!this._needsOpen)return queueTick(()=>e(null));queueAndRun(this,new Request(this,OPEN_OP,0,0,null,e))},RandomAccess$1.prototype._open=defaultImpl(null),RandomAccess$1.prototype._openReadonly=NO_OPEN_READABLE,RandomAccess$1.prototype.close=function(e){if(e||(e=noop$2),this.closed)return queueTick(()=>e(null));queueAndRun(this,new Request(this,CLOSE_OP,0,0,null,e))},RandomAccess$1.prototype._close=defaultImpl(null),RandomAccess$1.prototype.destroy=function(e){e||(e=noop$2),this.closed||this.close(noop$2),queueAndRun(this,new Request(this,DESTROY_OP,0,0,null,e))},RandomAccess$1.prototype._destroy=defaultImpl(null),RandomAccess$1.prototype.run=function(e){this._needsOpen&&this.open(noop$2),this._queued.length?this._queued.push(e):e._run()};function noop$2(){}function Request(e,t,r,n,o,s){this.type=t,this.offset=r,this.data=o,this.size=n,this.storage=e,this._sync=!1,this._callback=s,this._openError=null}Request.prototype._maybeOpenError=function(e){if(this.type===OPEN_OP)for(var t=this.storage._queued,r=0;r<t.length;r++)t[r]._openError=e},Request.prototype._unqueue=function(e){var t=this.storage,r=t._queued;if(e)this._maybeOpenError(e);else switch(this.type){case OPEN_OP:t.opened||(t.opened=!0,t.emit("open"));break;case CLOSE_OP:t.closed||(t.closed=!0,t.emit("close"));break;case DESTROY_OP:t.destroyed||(t.destroyed=!0,t.emit("destroy"));break}r.length&&r[0]===this&&r.shift(),--t._pending||drainQueue(t)},Request.prototype.callback=function(e,t){if(this._sync)return nextTick$2(this,e,t);this._unqueue(e),this._callback(e,t)},Request.prototype._openAndNotClosed=function(){var e=this.storage;return e.opened&&!e.closed?!0:(e.opened?e.closed&&nextTick$2(this,new Error("Closed")):nextTick$2(this,this._openError||new Error("Not opened")),!1)},Request.prototype._open=function(){var e=this.storage;if(e.opened&&!e._needsOpen)return nextTick$2(this,null);if(e.closed)return nextTick$2(this,new Error("Closed"));e._needsOpen=!1,e.preferReadonly?e._openReadonly(this):e._open(this)},Request.prototype._run=function(){var e=this.storage;switch(e._pending++,this._sync=!0,this.type){case READ_OP:this._openAndNotClosed()&&e._read(this);break;case WRITE_OP:this._openAndNotClosed()&&e._write(this);break;case DEL_OP:this._openAndNotClosed()&&e._del(this);break;case STAT_OP:this._openAndNotClosed()&&e._stat(this);break;case OPEN_OP:this._open();break;case CLOSE_OP:e.closed||!e.opened?nextTick$2(this,null):e._close(this);break;case DESTROY_OP:e.destroyed?nextTick$2(this,null):e._destroy(this);break}this._sync=!1};function queueAndRun(e,t){e._queued.push(t),e._pending||t._run()}function drainQueue(e){for(var t=e._queued;t.length>0;){var r=t[0].type>3;if((!r||!e._pending)&&t[0]._run(),r)return;t.shift()}}function openWritable(e){e.preferReadonly&&(e._needsOpen=!0,e.preferReadonly=!1)}function defaultImpl(e){return t;function t(r){nextTick$2(r,e)}}function nextTick$2(e,t,r){queueTick(()=>e.callback(t,r))}const import$random_access_storage=getDefaultExportFromCjs(randomAccessStorage);var ensureCallable=function(e){if(typeof e!="function")throw new TypeError(e+" is not a function");return e},byObserver=function(e){var t=document.createTextNode(""),r,n,o=0;return new e(function(){var s;if(r)n&&(r=n.concat(r));else{if(!n)return;r=n}if(n=r,r=null,typeof n=="function"){s=n,n=null,s();return}for(t.data=o=++o%2;n;)s=n.shift(),n.length||(n=null),s()}).observe(t,{characterData:!0}),function(s){if(ensureCallable(s),r){typeof r=="function"?r=[r,s]:r.push(s);return}r=s,t.data=o=++o%2}},nextTick$1=function(){if(typeof process=="object"&&process&&typeof process.nextTick=="function")return process.nextTick;if(typeof queueMicrotask=="function")return function(e){queueMicrotask(ensureCallable(e))};if(typeof document=="object"&&document){if(typeof MutationObserver=="function")return byObserver(MutationObserver);if(typeof WebKitMutationObserver=="function")return byObserver(WebKitMutationObserver)}return typeof setImmediate=="function"?function(e){setImmediate(ensureCallable(e))}:typeof setTimeout=="function"||typeof setTimeout=="object"?function(e){setTimeout(ensureCallable(e),0)}:null}();const import$next_tick=getDefaultExportFromCjs(nextTick$1);var once$1={exports:{}},wrappy_1=wrappy$1;function wrappy$1(e,t){if(e&&t)return wrappy$1(e)(t);if(typeof e!="function")throw new TypeError("need wrapper function");return Object.keys(e).forEach(function(n){r[n]=e[n]}),r;function r(){for(var n=new Array(arguments.length),o=0;o<n.length;o++)n[o]=arguments[o];var s=e.apply(this,n),a=n[n.length-1];return typeof s=="function"&&s!==a&&Object.keys(a).forEach(function(c){s[c]=a[c]}),s}}var wrappy=wrappy_1;once$1.exports=wrappy(once),once$1.exports.strict=wrappy(onceStrict),once.proto=once(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return once(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return onceStrict(this)},configurable:!0})});function once(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function onceStrict(e){var t=function(){if(t.called)throw new Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},r=e.name||"Function wrapped with `once`";return t.onceError=r+" shouldn't be called more than once",t.called=!1,t}var onceExports=once$1.exports;const import$once=getDefaultExportFromCjs(onceExports);var toString$4=Object.prototype.toString,isModern=typeof Buffer.alloc=="function"&&typeof Buffer.allocUnsafe=="function"&&typeof Buffer.from=="function";function isArrayBuffer(e){return toString$4.call(e).slice(8,-1)==="ArrayBuffer"}function fromArrayBuffer(e,t,r){t>>>=0;var n=e.byteLength-t;if(n<0)throw new RangeError("'offset' is out of bounds");if(r===void 0)r=n;else if(r>>>=0,r>n)throw new RangeError("'length' is out of bounds");return isModern?Buffer.from(e.slice(t,t+r)):new Buffer(new Uint8Array(e.slice(t,t+r)))}function fromString(e,t){if((typeof t!="string"||t==="")&&(t="utf8"),!Buffer.isEncoding(t))throw new TypeError('"encoding" must be a valid string encoding');return isModern?Buffer.from(e,t):new Buffer(e,t)}function bufferFrom(e,t,r){if(typeof e=="number")throw new TypeError('"value" argument must not be a number');return isArrayBuffer(e)?fromArrayBuffer(e,t,r):typeof e=="string"?fromString(e,t):isModern?Buffer.from(e):new Buffer(e)}var bufferFrom_1=bufferFrom;const import$buffer_from=getDefaultExportFromCjs(bufferFrom_1);var hasFullSupport=function(){try{if(!Buffer.isEncoding("latin1"))return!1;var e=Buffer.alloc?Buffer.alloc(4):new Buffer(4);return e.fill("ab","ucs2"),e.toString("hex")==="61006200"}catch{return!1}}();function isSingleByte(e){return e.length===1&&e.charCodeAt(0)<256}function fillWithNumber(e,t,r,n){if(r<0||n>e.length)throw new RangeError("Out of range index");return r=r>>>0,n=n===void 0?e.length:n>>>0,n>r&&e.fill(t,r,n),e}function fillWithBuffer(e,t,r,n){if(r<0||n>e.length)throw new RangeError("Out of range index");if(n<=r)return e;r=r>>>0,n=n===void 0?e.length:n>>>0;for(var o=r,s=t.length;o<=n-s;)t.copy(e,o),o+=s;return o!==n&&t.copy(e,o,0,n-o),e}function fill(e,t,r,n,o){if(hasFullSupport)return e.fill(t,r,n,o);if(typeof t=="number")return fillWithNumber(e,t,r,n);if(typeof t=="string"){if(typeof r=="string"?(o=r,r=0,n=e.length):typeof n=="string"&&(o=n,n=e.length),o!==void 0&&typeof o!="string")throw new TypeError("encoding must be a string");if(o==="latin1"&&(o="binary"),typeof o=="string"&&!Buffer.isEncoding(o))throw new TypeError("Unknown encoding: "+o);if(t==="")return fillWithNumber(e,0,r,n);if(isSingleByte(t))return fillWithNumber(e,t.charCodeAt(0),r,n);t=new Buffer(t,o)}return Buffer.isBuffer(t)?fillWithBuffer(e,t,r,n):fillWithNumber(e,0,r,n)}var bufferFill$1=fill;function allocUnsafe$1(e){if(typeof e!="number")throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative');return Buffer.allocUnsafe?Buffer.allocUnsafe(e):new Buffer(e)}var bufferAllocUnsafe=allocUnsafe$1,bufferFill=bufferFill$1,allocUnsafe=bufferAllocUnsafe,bufferAlloc=function e(t,r,n){if(typeof t!="number")throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative');if(Buffer.alloc)return Buffer.alloc(t,r,n);var o=allocUnsafe(t);return t===0?o:r===void 0?bufferFill(o,0):(typeof n!="string"&&(n=void 0),bufferFill(o,r,n))};const import$buffer_alloc=getDefaultExportFromCjs(bufferAlloc),processFn=(e,t,r,n)=>function(...o){const s=t.promiseModule;return new s((a,c)=>{t.multiArgs?o.push((...l)=>{t.errorFirst?l[0]?c(l):(l.shift(),a(l)):a(l)}):t.errorFirst?o.push((l,h)=>{l?c(l):a(h)}):o.push(a),Reflect.apply(e,this===r?n:this,o)})},filterCache=new WeakMap;var pify=(e,t)=>{t={exclude:[/.+(?:Sync|Stream)$/],errorFirst:!0,promiseModule:Promise,...t};const r=typeof e;if(!(e!==null&&(r==="object"||r==="function")))throw new TypeError(`Expected \`input\` to be a \`Function\` or \`Object\`, got \`${e===null?"null":r}\``);const n=(a,c)=>{let l=filterCache.get(a);if(l||(l={},filterCache.set(a,l)),c in l)return l[c];const h=_=>typeof _=="string"||typeof c=="symbol"?c===_:_.test(c),u=Reflect.getOwnPropertyDescriptor(a,c),d=u===void 0||u.writable||u.configurable,f=(t.include?t.include.some(h):!t.exclude.some(h))&&d;return l[c]=f,f},o=new WeakMap,s=new Proxy(e,{apply(a,c,l){const h=o.get(a);if(h)return Reflect.apply(h,c,l);const u=t.excludeMain?a:processFn(a,t,s,a);return o.set(a,u),Reflect.apply(u,c,l)},get(a,c){const l=a[c];if(!n(a,c)||l===Function.prototype[c])return l;const h=o.get(l);if(h)return h;if(typeof l=="function"){const u=processFn(l,t,s,a);return o.set(l,u),u}return l}});return s};const pify$1=getDefaultExportFromCjs(pify),b4a$1=browserExports$2;var isOptions$1=function e(t){return typeof t=="object"&&t&&!b4a$1.isBuffer(t)};const RandomAccess=randomAccessStorage,isOptions=isOptions$1,inherits=inherits_browserExports,b4a=browserExports$2,DEFAULT_PAGE_SIZE=1024*1024;var randomAccessMemory=RAM;function RAM(e){if(!(this instanceof RAM))return new RAM(e);typeof e=="number"&&(e={length:e}),e||(e={}),RandomAccess.call(this),b4a.isBuffer(e)&&(e={length:e.length,buffer:e}),isOptions(e)||(e={}),this.length=e.length||0,this.pageSize=e.length||e.pageSize||DEFAULT_PAGE_SIZE,this.buffers=[],e.buffer&&this.buffers.push(e.buffer)}inherits(RAM,RandomAccess),RAM.prototype._stat=function(e){e.callback(null,{size:this.length})},RAM.prototype._write=function(e){var t=Math.floor(e.offset/this.pageSize),r=e.offset-t*this.pageSize,n=0;const o=e.offset+e.size;for(o>this.length&&(this.length=o);n<e.size;){const s=this._page(t++,!0),a=this.pageSize-r,c=a<e.size-n?n+a:e.size;b4a.copy(e.data,s,r,n,c),n=c,r=0}e.callback(null,null)},RAM.prototype._read=function(e){var t=Math.floor(e.offset/this.pageSize),r=e.offset-t*this.pageSize,n=0;if(e.offset+e.size>this.length)return e.callback(new Error("Could not satisfy length"),null);const o=b4a.alloc(e.size);for(;n<e.size;){const s=this._page(t++,!1),a=this.pageSize-r,c=e.size-n,l=a<c?a:c;s&&b4a.copy(s,o,n,r,r+l),n+=l,r=0}e.callback(null,o)},RAM.prototype._del=function(e){var t=Math.floor(e.offset/this.pageSize),r=e.offset-t*this.pageSize,n=0;if(r&&e.offset+e.size>=this.length){var o=this.buffers[t];o&&o.fill(0,r)}for(e.offset+e.size>this.length&&(e.size=Math.max(0,this.length-e.offset));n<e.size;)r===0&&e.size-n>=this.pageSize&&(this.buffers[t]=void 0),r=0,t+=1,n+=this.pageSize-r;e.offset+e.size>=this.length&&(this.length=e.offset),e.callback(null,null)},RAM.prototype._destroy=function(e){this._buffers=[],this.length=0,e.callback(null,null)},RAM.prototype._page=function(e,t){var r=this.buffers[e];return r||!t||(r=this.buffers[e]=b4a.alloc(this.pageSize)),r},RAM.prototype.toBuffer=function(){const e=b4a.alloc(this.length);for(var t=0;t<this.buffers.length;t++)this.buffers[t]&&b4a.copy(this.buffers[t],e,t*this.pageSize);return e},RAM.prototype.clone=function(){const e=new RAM;return e.length=this.length,e.pageSize=this.pageSize,e.buffers=this.buffers.map(t=>Buffer.from(t)),e};const ram=getDefaultExportFromCjs(randomAccessMemory);let symbolTracingContext,getTracingContext,TRACE_SPAN_ATTRIBUTE,createId,__dxlog_file$p,DIAGNOSTICS_TIMEOUT,TraceDiagnosticImpl,DiagnosticsManager,DEFAULT_CHANNEL_NAME,DISCOVER_TIME,DiagnosticsChannel,RemoteMetrics,RemoteTracing,TraceSender,__dxlog_file2$g,ResourceEntry,MAX_RESOURCE_RECORDS,MAX_SPAN_RECORDS,MAX_LOG_RECORDS,REFRESH_INTERVAL,MAX_INFO_OBJECT_DEPTH,TraceProcessor,TracingSpan,serializeError,sanitizeValue,areEqualShallow,sanitizeClassName,isSetLike,isMapLike,resource,info,mark$1,span,metricsCounter,addLink,diagnostic,BaseCounter,MAX_BUCKETS,TimeSeriesCounter,MAX_BUCKETS2,TimeUsageCounter,MapCounter;symbolTracingContext=Symbol("dxos.tracing.context"),getTracingContext=e=>e[symbolTracingContext]??(e[symbolTracingContext]={infoProperties:{},metricsProperties:{}}),TRACE_SPAN_ATTRIBUTE="dxos.trace-span",createId=()=>Math.random().toString(36).slice(2),__dxlog_file$p="/home/runner/work/dxos/dxos/packages/common/tracing/src/diagnostic.ts",DIAGNOSTICS_TIMEOUT=1e4,TraceDiagnosticImpl=class{constructor(e,t,r,n){this.id=e,this.fetch=t,this.name=r,this._onUnregister=n}unregister(){this._onUnregister()}},DiagnosticsManager=class{constructor(){this.instanceId=createId(),this.registry=new Map,this._instanceTag=null}setInstanceTag(e){this._instanceTag=e}registerDiagnostic(e){const t=new TraceDiagnosticImpl(e.id,e.fetch,e.name??e.id,()=>{this.registry.get(e.id)===t&&this.registry.delete(e.id)});return this.registry.set(e.id,t),t}list(){return Array.from(this.registry.values()).map(e=>({id:e.id,instanceId:this.instanceId,instanceTag:this._instanceTag,name:e.name}))}async fetch(e){invariant$1(e.instanceId===this.instanceId,"Invalid instance id",{F:__dxlog_file$p,L:76,S:this,A:["request.instanceId === this.instanceId","'Invalid instance id'"]});const{id:t}=e,r=this.registry.get(t);invariant$1(r,"Diagnostic not found",{F:__dxlog_file$p,L:79,S:this,A:["diagnostic","'Diagnostic not found'"]});try{const n=await asyncTimeout(r.fetch(),DIAGNOSTICS_TIMEOUT);return{id:t,instanceId:this.instanceId,data:n}}catch(n){return{id:t,instanceId:this.instanceId,data:null,error:n.stack}}}},DEFAULT_CHANNEL_NAME="dxos-diagnostics",DISCOVER_TIME=500,DiagnosticsChannel=class{constructor(e=DEFAULT_CHANNEL_NAME){this._channelName=e,this._ctx=new Context,this._serveChannel=new BroadcastChannel(e),this._clientChannel=new BroadcastChannel(e)}destroy(){this._ctx.dispose(),this._serveChannel.close(),this._clientChannel.close()}unref(){typeof this._serveChannel.unref=="function"&&(this._serveChannel.unref(),this._clientChannel.unref())}serve(e){const t=async r=>{switch(r.data.type){case"DIAGNOSTICS_DISCOVER":{const n=e.list();this._serveChannel.postMessage({type:"DIAGNOSTICS_ANNOUNCE",diagnostics:n});break}case"DIAGNOSTICS_FETCH":{const{requestId:n,request:o}=r.data;if(o.instanceId!==e.instanceId)break;const s=await e.fetch(o);this._serveChannel.postMessage({type:"DIAGNOSTICS_RESPONSE",requestId:n,data:s});break}}};this._serveChannel.addEventListener("message",t),this._ctx.onDispose(()=>this._serveChannel.removeEventListener("message",t))}async discover(){const e=[],t=r=>{const n=r.data;switch(n.type){case"DIAGNOSTICS_ANNOUNCE":e.push(...n.diagnostics);break}};try{this._clientChannel.addEventListener("message",t),this._clientChannel.postMessage({type:"DIAGNOSTICS_DISCOVER"}),await sleep(DISCOVER_TIME);const r=[];for(const n of e)r.some(o=>o.id===n.id&&o.instanceId===n.instanceId)||r.push(n);return e}finally{this._clientChannel.removeEventListener("message",t)}}async fetch(e){const t=createId(),r=new Trigger,n=o=>{const s=o.data;s.type==="DIAGNOSTICS_RESPONSE"&&s.requestId===t&&r.wake(s.data)};try{return this._clientChannel.addEventListener("message",n),this._clientChannel.postMessage({type:"DIAGNOSTICS_FETCH",requestId:t,request:e}),await r.wait({timeout:DIAGNOSTICS_TIMEOUT})}finally{this._clientChannel.removeEventListener("message",n)}}},RemoteMetrics=class{constructor(){this._metrics=new Set}async registerProcessor(e){this._metrics.add(e)}increment(e,t,r){return Array.from(this._metrics.values()).map(n=>n.increment(e,t,r))}distribution(e,t,r){return Array.from(this._metrics.values()).map(n=>n.distribution(e,t,r))}set(e,t,r){return Array.from(this._metrics.values()).map(n=>n.set(e,t,r))}gauge(e,t,r){return Array.from(this._metrics.values()).map(n=>n.gauge(e,t,r))}},RemoteTracing=class{constructor(){this._spanMap=new Map}async registerProcessor(e){this._tracing=e}flushSpan(e){if(this._tracing)if(e.endTs){const t=this._spanMap.get(e);t&&(t.end(),this._spanMap.delete(e))}else{const t=this._tracing.startSpan({name:e.methodName,op:e.op??"function",attributes:e.attributes});this._spanMap.set(e,t)}}},TraceSender=class{constructor(e){this._traceProcessor=e}streamTrace(e){return new Stream$2(({ctx:t,next:r})=>{const n=(s,a,c)=>{const l={resourceAdded:[],resourceRemoved:[],spanAdded:[],logAdded:[]};if(s)for(const h of s){const u=this._traceProcessor.resources.get(h);u?l.resourceAdded.push({resource:u.data}):l.resourceRemoved.push({id:h})}else for(const h of this._traceProcessor.resources.values())l.resourceAdded.push({resource:h.data});if(a)for(const h of a){const u=this._traceProcessor.spans.get(h);u&&l.spanAdded.push({span:u})}else for(const h of this._traceProcessor.spans.values())l.spanAdded.push({span:h});if(c)for(const h of c)l.logAdded.push({log:h});else for(const h of this._traceProcessor.logs)l.logAdded.push({log:h});(l.resourceAdded.length>0||l.resourceRemoved.length>0||l.spanAdded.length>0)&&r(l)},o={flush:()=>{n(o.dirtyResources,o.dirtySpans,o.newLogs),o.dirtyResources.clear(),o.dirtySpans.clear(),o.newLogs.length=0},dirtyResources:new Set,dirtySpans:new Set,newLogs:[]};this._traceProcessor.subscriptions.add(o),t.onDispose(()=>{this._traceProcessor.subscriptions.delete(o)}),n(null,null,null)})}},__dxlog_file2$g="/home/runner/work/dxos/dxos/packages/common/tracing/src/trace-processor.ts",ResourceEntry=class{constructor(e,t,r){this.data=e,this.instance=t,this.annotation=r,this.sanitizedClassName=sanitizeClassName(e.className)}getMetric(e){var t;return(t=this.data.metrics)==null?void 0:t.find(r=>r.name===e)}},MAX_RESOURCE_RECORDS=2e3,MAX_SPAN_RECORDS=1e3,MAX_LOG_RECORDS=1e3,REFRESH_INTERVAL=1e3,MAX_INFO_OBJECT_DEPTH=8,TraceProcessor=class{constructor(){this.diagnostics=new DiagnosticsManager,this.diagnosticsChannel=new DiagnosticsChannel,this.remoteMetrics=new RemoteMetrics,this.remoteTracing=new RemoteTracing,this.subscriptions=new Set,this.resources=new Map,this.resourceInstanceIndex=new WeakMap,this.resourceIdList=[],this.spans=new Map,this.spanIdList=[],this.logs=[],this._instanceTag=null,this._logProcessor=(t,r)=>{var n,o,s;switch(r.level){case LogLevel$1.ERROR:case LogLevel$1.WARN:case LogLevel$1.TRACE:{const a=(n=r.meta)==null?void 0:n.S,c=this.resourceInstanceIndex.get(a);if(!c)return;const l=getContextFromEntry(r)??{};for(const u of Object.keys(l))l[u]=sanitizeValue(l[u],0,this);const h={level:r.level,message:r.message,context:l,timestamp:new Date,meta:{file:((o=r.meta)==null?void 0:o.F)??"",line:((s=r.meta)==null?void 0:s.L)??0,resourceId:c.data.id}};this._pushLog(h);break}}},log.addProcessor(this._logProcessor.bind(this),void 0,{F:__dxlog_file2$g,L:100,S:this,C:(t,r)=>t(...r)});const e=setInterval(this.refresh.bind(this),REFRESH_INTERVAL);unrefTimeout(e),this.diagnosticsChannel.serve(this.diagnostics),this.diagnosticsChannel.unref()}setInstanceTag(e){this._instanceTag=e,this.diagnostics.setInstanceTag(e)}createTraceResource(e){const t=this.resources.size,r=getTracingContext(Object.getPrototypeOf(e.instance));for(const o of Object.keys(r.metricsProperties))e.instance[o]._assign(e.instance,o);const n=new ResourceEntry({id:t,className:e.constructor.name,instanceId:getPrototypeSpecificInstanceId(e.instance),info:this.getResourceInfo(e.instance),links:[],metrics:this.getResourceMetrics(e.instance)},new WeakRef(e.instance),e.annotation);this.resources.set(t,n),this.resourceInstanceIndex.set(e.instance,n),this.resourceIdList.push(t),this.resourceIdList.length>MAX_RESOURCE_RECORDS&&this._clearResources(),this._markResourceDirty(t)}createTraceSender(){return new TraceSender(this)}traceSpan(e){const t=new TracingSpan(this,e);return this._flushSpan(t),t}addLink(e,t,r){}getDiagnostics(){return this.refresh(),{resources:Object.fromEntries(Array.from(this.resources.entries()).map(([e,t])=>[`${t.sanitizedClassName}#${t.data.instanceId}`,t.data])),spans:Array.from(this.spans.values()),logs:this.logs.filter(e=>e.level>=LogLevel$1.INFO)}}getResourceInfo(e){const t={},r=getTracingContext(Object.getPrototypeOf(e));for(const[n,{options:o}]of Object.entries(r.infoProperties))try{const s=typeof e[n]=="function"?e[n]():e[n];o.enum?t[n]=o.enum[s]:t[n]=sanitizeValue(s,o.depth===void 0?1:o.depth??MAX_INFO_OBJECT_DEPTH,this)}catch(s){t[n]=s.message}return t}getResourceMetrics(e){const t=[],r=getTracingContext(Object.getPrototypeOf(e));for(const[n,o]of Object.entries(r.metricsProperties))t.push(e[n].getData());return t}getResourceId(e){const t=this.resourceInstanceIndex.get(e);return t?t.data.id:null}findResourcesByClassName(e){return[...this.resources.values()].filter(t=>t.data.className===e||t.sanitizedClassName===e)}findResourcesByAnnotation(e){return[...this.resources.values()].filter(t=>t.annotation===e)}refresh(){var e,t;for(const r of this.resources.values()){const n=r.instance.deref();if(!n)continue;const o=getTracingContext(Object.getPrototypeOf(n)),s=performance.now();for(const h of Object.keys(o.metricsProperties))(t=(e=n[h])._tick)==null||t.call(e,s);let a=!1;const c=r.data.info;r.data.info=this.getResourceInfo(n),a||(a=!areEqualShallow(c,r.data.info));const l=r.data.metrics;r.data.metrics=this.getResourceMetrics(n),a||(a=!areEqualShallow(l,r.data.metrics)),this._markResourceDirty(r.data.id)}for(const r of this.subscriptions)r.flush()}_flushSpan(e){const t=e.serialize();this.spans.set(t.id,t),this.spanIdList.push(t.id),this.spanIdList.length>MAX_SPAN_RECORDS&&this._clearSpans(),this._markSpanDirty(t.id),this.remoteTracing.flushSpan(e)}_markResourceDirty(e){for(const t of this.subscriptions)t.dirtyResources.add(e)}_markSpanDirty(e){for(const t of this.subscriptions)t.dirtySpans.add(e)}_clearResources(){for(;this.resourceIdList.length>MAX_RESOURCE_RECORDS;){const e=this.resourceIdList.shift();this.resources.delete(e)}}_clearSpans(){for(;this.spanIdList.length>MAX_SPAN_RECORDS;){const e=this.spanIdList.shift();this.spans.delete(e)}}_pushLog(e){this.logs.push(e),this.logs.length>MAX_LOG_RECORDS&&this.logs.shift();for(const t of this.subscriptions)t.newLogs.push(e)}},TracingSpan=(Rn=class{constructor(t,r){if(this._traceProcessor=t,this.parentId=null,this.resourceId=null,this.endTs=null,this.error=null,this._ctx=null,this.id=Rn.nextId++,this.methodName=r.methodName,this.resourceId=t.getResourceId(r.instance),this.startTs=performance.now(),this._showInBrowserTimeline=r.showInBrowserTimeline,this.op=r.op,this.attributes=r.attributes??{},r.parentCtx){this._ctx=r.parentCtx.derive({attributes:{[TRACE_SPAN_ATTRIBUTE]:this.id}});const n=r.parentCtx.getAttribute(TRACE_SPAN_ATTRIBUTE);typeof n=="number"&&(this.parentId=n)}}get ctx(){return this._ctx}markSuccess(){this.endTs=performance.now(),this._traceProcessor._flushSpan(this),this._showInBrowserTimeline&&this._markInBrowserTimeline()}markError(t){this.endTs=performance.now(),this.error=serializeError(t),this._traceProcessor._flushSpan(this),this._showInBrowserTimeline&&this._markInBrowserTimeline()}serialize(){var t;return{id:this.id,resourceId:this.resourceId??void 0,methodName:this.methodName,parentId:this.parentId??void 0,startTs:this.startTs.toFixed(3),endTs:((t=this.endTs)==null?void 0:t.toFixed(3))??void 0,error:this.error??void 0}}_markInBrowserTimeline(){const t=this._traceProcessor.resources.get(this.resourceId),r=t?`${t.sanitizedClassName}#${t.data.instanceId}.${this.methodName}`:this.methodName;performance.measure(r,{start:this.startTs,end:this.endTs})}},Rn.nextId=0,Rn),serializeError=e=>e instanceof Error?{name:e.name,message:e.message}:{message:String(e)},TRACE_PROCESSOR=globalThis.TRACE_PROCESSOR??(globalThis.TRACE_PROCESSOR=new TraceProcessor),sanitizeValue=(e,t,r)=>{switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":case"function":if(e===null)return e;{const n=r.resourceInstanceIndex.get(e);if(n)return`${n.sanitizedClassName}#${n.data.instanceId}`}if(typeof e.toJSON=="function")return sanitizeValue(e.toJSON(),t,r);if(t>0){if(isSetLike(e))return Object.fromEntries(Array.from(e.entries()).map(n=>sanitizeValue(n,t-1,r)));if(isMapLike(e))return Object.fromEntries(Array.from(e.entries()).map(([n,o])=>[n,sanitizeValue(o,t-1,r)]));if(Array.isArray(e))return e.map(n=>sanitizeValue(n,t-1,r));if(typeof e=="object"){const n={};for(const o of Object.keys(e))n[o]=sanitizeValue(e[o],t-1,r);return n}}return typeof e.truncate=="function"?e.truncate():e.toString()}},areEqualShallow=(e,t)=>{for(const r in e)if(!(r in t)||e[r]!==t[r])return!1;for(const r in t)if(!(r in e)||e[r]!==t[r])return!1;return!0},sanitizeClassName=e=>{const t=/[^_](\d+)$/,r=e.match(t);return r?e.slice(0,-r[1].length):e},isSetLike=e=>e instanceof Set||typeof e=="object"&&e!==null&&Object.getPrototypeOf(e).constructor.name==="ComplexSet",isMapLike=e=>e instanceof Map||typeof e=="object"&&e!==null&&Object.getPrototypeOf(e).constructor.name==="ComplexMap",resource=e=>t=>{const r=class extends t{constructor(...n){super(...n),TRACE_PROCESSOR.createTraceResource({constructor:t,annotation:e==null?void 0:e.annotation,instance:this})}};return Object.defineProperty(r,"name",{value:t.name}),r},info=(e={})=>(t,r,n)=>{getTracingContext(t).infoProperties[r]={options:e}},mark$1=e=>{performance.mark(e)},span=({showInBrowserTimeline:e=!1,op:t,attributes:r}={})=>(n,o,s)=>{const a=s.value;s.value=async function(...c){const l=c[0]instanceof Context?c[0]:null,h=TRACE_PROCESSOR.traceSpan({parentCtx:l,methodName:o,instance:this,showInBrowserTimeline:e,op:t,attributes:r}),u=h.ctx?[h.ctx,...c.slice(1)]:c;try{return await a.apply(this,u)}catch(d){throw h.markError(d),d}finally{h.markSuccess()}}},metricsCounter=()=>(e,t,r)=>{getTracingContext(e).metricsProperties[t]={}},addLink=(e,t,r={})=>{TRACE_PROCESSOR.addLink(e,t,r)},diagnostic=e=>TRACE_PROCESSOR.diagnostics.registerDiagnostic(e),trace={addLink,diagnostic,info,mark:mark$1,metricsCounter,resource,span,metrics:TRACE_PROCESSOR.remoteMetrics},BaseCounter=class{_assign(e,t){this._instance=e,this.name=t}_tick(e){}},MAX_BUCKETS=60,TimeSeriesCounter=class extends BaseCounter{constructor({units:e}={}){super(),this._currentValue=0,this._totalValue=0,this._buckets=[],this.units=e}inc(e=1){this._currentValue+=e,this._totalValue+=e}_tick(e){this._buckets.push(this._currentValue),this._buckets.length>MAX_BUCKETS&&this._buckets.shift(),this._currentValue=0}getData(){return{name:this.name,timeSeries:{tracks:[{name:this.name,units:this.units,points:this._buckets.map((e,t)=>({value:e})),total:this._totalValue}]}}}},MAX_BUCKETS2=60,TimeUsageCounter=class extends BaseCounter{constructor(){super(...arguments),this._currentValue=0,this._totalValue=0,this._buckets=[],this._lastTickTime=performance.now()}record(e){this._currentValue+=e,this._totalValue+=e}beginRecording(){const e=performance.now();return{end:()=>{const t=performance.now();this.record(t-e)}}}_tick(e){const t=e-this._lastTickTime;this._lastTickTime=e;const r=this._currentValue/t*100;this._buckets.push(r),this._buckets.length>MAX_BUCKETS2&&this._buckets.shift(),this._currentValue=0}getData(){return{name:this.name,timeSeries:{tracks:[{name:this.name,units:"%",points:this._buckets.map((e,t)=>({value:e})),total:this._totalValue}]}}}},MapCounter=class extends BaseCounter{constructor({units:e}={}){super(),this.values=new Map,this.units=e}inc(e,t=1){const r=this.values.get(e)??0;this.values.set(e,r+t)}getData(){return{name:this.name,multiCounter:{records:Array.from(this.values.entries()).map(([e,t])=>({key:e,value:t})),units:this.units}}}},trace.diagnostic({id:"process-info",name:"Process Info",fetch:async()=>{var e,t,r,n;return{platform:(e=globalThis.process)==null?void 0:e.platform,arch:(t=globalThis.process)==null?void 0:t.arch,versions:(r=globalThis.process)==null?void 0:r.versions,href:(n=globalThis.location)==null?void 0:n.href}}});var __create$1=Object.create,__defProp$2=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__getOwnPropNames$1=Object.getOwnPropertyNames,__getProtoOf$1=Object.getPrototypeOf,__hasOwnProp$1=Object.prototype.hasOwnProperty,__esm$1=(e,t)=>function(){return e&&(t=(0,e[__getOwnPropNames$1(e)[0]])(e=0)),t},__commonJS$1=(e,t)=>function(){return t||(0,e[__getOwnPropNames$1(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps$1=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of __getOwnPropNames$1(t))!__hasOwnProp$1.call(e,o)&&o!==r&&__defProp$2(e,o,{get:()=>t[o],enumerable:!(n=__getOwnPropDesc$1(t,o))||n.enumerable});return e},__toESM$1=(e,t,r)=>(r=e!=null?__create$1(__getProtoOf$1(e)):{},__copyProps$1(!e||!e.__esModule?__defProp$2(r,"default",{value:e,enumerable:!0}):r,e)),init_inject_globals$1=__esm$1({"inject-globals:@inject-globals"(){}}),require_blocks=__commonJS$1({"node_modules/.pnpm/random-access-idb@1.2.2_patch_hash=mqfhtwnltd5kq5s4kb4gk7k2k4/node_modules/random-access-idb/lib/blocks.js"(e,t){init_inject_globals$1(),t.exports=function(r,n,o){for(var s=[],a=Math.floor(n/r)*r;a<o;a+=r)s.push({block:Math.floor(a/r),start:Math.max(a,n)%r,end:Math.min(a+r,o)%r||r});return s}}}),require_random_access_idb=__commonJS$1({"node_modules/.pnpm/random-access-idb@1.2.2_patch_hash=mqfhtwnltd5kq5s4kb4gk7k2k4/node_modules/random-access-idb/index.js"(e,t){init_inject_globals$1();var r=import$random_access_storage,n=import$inherits,o=import$next_tick,s=import$once,a=require_blocks(),c=import$buffer_from,l=import$buffer_alloc,h="\0",u=typeof window<"u"?window:typeof self<"u"?self:{};t.exports=function(_,p){p||(p={});var y=p.idb||(typeof u<"u"?u.indexedDB||u.mozIndexedDB||u.webkitIndexedDB||u.msIndexedDB:null);if(!y)throw new Error("indexedDB not present and not given");var w=null,E=[];if(typeof y.open=="function"){var x=y.open(_);x.addEventListener("upgradeneeded",function(){w=x.result,w.createObjectStore("data")}),x.addEventListener("success",function(){w=x.result,E.forEach(function(P){P(w)}),E=null})}else w=y;function B(P){w?o(function(){P(w)}):E.push(P)}return{create:function(P,U){return typeof P=="object"&&(U=P,P=U.name),U||(U={}),U.name=P,new d(Object.assign({db:B},p,U))},getdb:B}};function d(_){if(!(this instanceof d))return new d(_);r.call(this),_||(_={}),typeof _=="string"&&(_={name:_}),this.size=_.size||4096,this.name=_.name,this.length=_.length||0,this._getdb=_.db}n(d,r),d.prototype._blocks=function(_,p){return a(this.size,_,p)},d.prototype._read=function(_){var p=this,y=[];p._store("readonly",function(w,E){if((p.length||0)<_.offset+_.size)return _.callback(new Error("Could not satisfy length"));if(w)return _.callback(w);for(var x=p._blocks(_.offset,_.offset+_.size),B=x.length+1,P=x.length>0?x[0].block:0,U=0;U<x.length;U++)(function(F){var G=p.name+h+F.block;f(E.get(G),function(H,te){if(H)return _.callback(H);y[F.block-P]=te.target.result?c(te.target.result.subarray(F.start,F.end)):l(F.end-F.start),--B===0&&_.callback(null,export_Buffer.concat(y))})})(x[U]);--B===0&&_.callback(null,export_Buffer.concat(y))})},d.prototype._write=function(_){var p=this;p._store("readwrite",function(w,E){if(w)return _.callback(w);for(var x=p._blocks(_.offset,_.offset+_.data.length),B=1,P={},U=0;U<x.length;U++)(function(F,G){if(F.end-F.start!==p.size){B++;var H=p.name+h+F.block;f(E.get(H),function(te,J){if(te)return _.callback(te);P[G]=c(J.target.result||l(p.size)),--B===0&&y(E,x,P)})}})(x[U],U);--B===0&&y(E,x,P)});function y(w,E,x){for(var B,P=0,U=0;P<E.length;P++){var F=E[P],G=F.end-F.start;G===p.size?B=c(_.data.slice(U,U+G)):(B=x[P],_.data.copy(B,F.start,U,U+G)),w.put(B,p.name+h+F.block),U+=G}var H=Math.max(p.length||0,_.offset+_.data.length);w.put(H,p.name+h+"length"),w.transaction.addEventListener("complete",function(){p.length=H,_.callback(null)}),w.transaction.addEventListener("error",function(te){_.callback(te)})}},d.prototype._store=function(_,p){p=s(p);var y=this;y._getdb(function(w){var E=w.transaction(["data"],_),x=E.objectStore("data");E.addEventListener("error",p),p(null,x)})},d.prototype._open=function(_){var p=this;this._getdb(function(y){p._store("readonly",function(w,E){f(E.get(p.name+h+"length"),function(x,B){p.length=B.target.result||0,_.callback(null)})})})},d.prototype._close=function(_){this._getdb(function(p){_.callback()})},d.prototype._stat=function(_){var p=this;o(function(){_.callback(null,{size:p.length})})};function f(_,p){_.addEventListener("success",function(y){p(null,y)}),_.addEventListener("error",p)}}});init_inject_globals$1(),init_inject_globals$1(),init_inject_globals$1(),init_inject_globals$1(),init_inject_globals$1();var stringDiff=(e,t)=>e.split(t).join(""),getFullPath=(e,t)=>export_join(e,stringDiff(t,e)),Directory=class Vs{constructor({type:t,path:r,list:n,getOrCreateFile:o,remove:s,onFlush:a}){this.type=t,this.path=r,this._list=n,this._getOrCreateFile=o,this._remove=s,this._onFlush=a}toString(){return`Directory(${JSON.stringify({type:this.type,path:this.path})})`}createDirectory(t){return new Vs({type:this.type,path:getFullPath(this.path,t),list:this._list,getOrCreateFile:this._getOrCreateFile,remove:this._remove})}list(){return this._list(this.path)}getOrCreateFile(t,r){return this._getOrCreateFile(this.path,t,r)}async flush(){var t;await((t=this._onFlush)==null?void 0:t.call(this))}async delete(){await this._remove()}};init_inject_globals$1();var __dxlog_file$o="/home/runner/work/dxos/dxos/packages/common/random-access-storage/src/common/file.ts",MAX_STORAGE_OPERATION_TIME=50,pifyFields=(e,t,r)=>{for(const n of r)if(e[n]){const o=pify$1(e[n].bind(e));e[n]=async(...s)=>{const a=performance.now(),c=await o(...s),l=performance.now()-a;return l>MAX_STORAGE_OPERATION_TIME&&log.info("Slow storage operation",{type:t,operation:n,elapsed:l},{F:__dxlog_file$o,L:62,S:void 0,C:(h,u)=>h(...u)}),c}}return e},wrapFile=(e,t)=>{const r=pifyFields(e,t,["write","read","del","stat","close","destroy","truncate"]);return Object.assign(r,{type:t,native:e})},__dxlog_file2$f="/home/runner/work/dxos/dxos/packages/common/random-access-storage/src/common/abstract-storage.ts",AbstractStorage=class{constructor(e){this.path=e,this._files=new Map}[export_inspect.custom](){return inspectObject(this)}toJSON(){return{type:this.type,path:this.path}}get size(){return this._files.size}createDirectory(e=""){return new Directory({type:this.type,path:getFullPath(this.path,e),list:this._list.bind(this),getOrCreateFile:(...t)=>this.getOrCreateFile(...t),remove:()=>this._remove(e)})}async reset(){try{log.info("Erasing all data...",void 0,{F:__dxlog_file2$f,L:60,S:this,C:(e,t)=>e(...t)}),await this._closeFilesInPath(""),await this._remove(""),await this._destroy(),log("Erased...",void 0,{F:__dxlog_file2$f,L:64,S:this,C:(e,t)=>e(...t)})}catch(e){log.catch(e,void 0,{F:__dxlog_file2$f,L:66,S:this,C:(t,r)=>t(...r)})}}async _list(e){return Array.from((await this._getFiles(e)).keys()).map(t=>{let r=t.replace(e,"");return r.startsWith("/")&&(r=r.substring(1)),r})}getOrCreateFile(e,t,r){const n=export_join(e,t);let o,s=this._getFileIfExists(n);if(s){if(!s.closed)return s;o=this._openFile(s.native)}return o||(o=this._createFile(e,t,r)),s=wrapFile(o,this.type),this._files.set(n,s),s}_destroy(){}_openFile(e){}_getFileIfExists(e){if(this._files.has(e)){const t=this._files.get(e);if(t&&!t.destroyed)return t}}async _getFiles(e){const t=getFullPath(this.path,e);return new Map([...this._files.entries()].filter(([r,n])=>r.includes(t)&&n.destroyed!==!0))}async _closeFilesInPath(e){await Promise.all(Array.from((await this._getFiles(e)).values()).map(t=>t.close().catch(r=>log.catch(r,void 0,{F:__dxlog_file2$f,L:134,S:this,C:(n,o)=>n(...o)}))))}async close(){await this._closeFilesInPath("")}async _remove(e){await Promise.all(Array.from(await this._getFiles(e)).map(([t,r])=>r.destroy().then(()=>this._files.delete(t)).catch(n=>log.error(n.message,void 0,{F:__dxlog_file2$f,L:149,S:this,C:(o,s)=>o(...s)}))))}};init_inject_globals$1(),init_inject_globals$1();var StorageType;(function(e){e.RAM="ram",e.IDB="idb",e.CHROME="chrome",e.FIREFOX="firefox",e.NODE="node",e.WEBFS="webfs"})(StorageType||(StorageType={}));var MemoryStorage=class extends AbstractStorage{constructor(){super(...arguments),this.type=StorageType.RAM}_createFile(e,t){return this._patchFile(ram())}_openFile(e){const t=e.clone();return t.closed=!1,this._patchFile(t)}_patchFile(e){const t=e.read.bind(e);return e.read=(r,n,o)=>t(r,n,(s,a)=>s?o(s):o(s,arrayToBuffer(a))),e}async getDiskInfo(){let e=0;for(const t of this._files.values()){const r=t.length;e+=Number.isNaN(r)?0:r}return{used:e}}};init_inject_globals$1(),init_inject_globals$1();var import_random_access_idb=__toESM$1(require_random_access_idb()),__dxlog_file3$e="/home/runner/work/dxos/dxos/packages/common/random-access-storage/src/browser/idb-storage.ts",DELIM="\0",IDbStorage=class extends AbstractStorage{constructor(e){super(e),this.type=StorageType.IDB,this._store="data",this._initialized=!1,this._fileStorage=this._createFileStorage(e)}_createFileStorage(e){const t=(0,import_random_access_idb.default)(e);let r;return this._db=new Promise(n=>{r=n}),t.getdb(r),t.create}async close(){await this._closeFilesInPath("")}async reset(){await this._closeFilesInPath(""),await this._remove("")}async _destroy(){throw new Error("Unreachable")}_createFile(e,t){const r=this._fileStorage(getFullPath(e,t));return r.destroy=n=>{this._db.then(o=>{const s=getFullPath(e,t),a=`${s}\uFFFF`,c=IDBKeyRange.bound(s,a),l=o.transaction(this._store,"readwrite");l.objectStore(this._store).delete(c),l.oncomplete=()=>{r.destroyed=!0,r.unlinked=!0,r.closed=!0,n(null)},l.onerror=()=>n(l.error)})},r.deletable=!0,r}async _loadFiles(e){const t=await this._db;invariant$1(t,"Database is not initialized.",{F:__dxlog_file3$e,L:85,S:this,A:["db","'Database is not initialized.'"]});const r=e,n=`${e}\uFFFF`,o=IDBKeyRange.bound(r,n),s=t.transaction(this._store),a=s.objectStore(this._store).openCursor(o);return new Promise((c,l)=>{s.onerror=()=>{l(a.error)},a.onsuccess=h=>{const u=h.target.result;if(u){const d=String(u.key).split(DELIM)[0];if(d&&!this._files.has(getFullPath(this.path,d))){const f=this._createFile(e,d);this._files.set(getFullPath(this.path,d),wrapFile(f,this.type))}u.continue()}else c()}})}async _getFiles(e){return this._initialized||(await this._loadFiles(this.path),this._initialized=!0),super._getFiles(e)}};init_inject_globals$1();function _ts_decorate$g(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file4$9="/home/runner/work/dxos/dxos/packages/common/random-access-storage/src/browser/web-fs.ts",WebFS=class{constructor(e){this.path=e,this._files=new Map,this.type=StorageType.WEBFS}get size(){return this._files.size}_getFiles(e){const t=this._getFullFilename(this.path,e);return new Map([...this._files.entries()].filter(([r,n])=>r.includes(t)&&!n.destroyed))}async _list(e){const t=this._getFullFilename(e),r=await this._initialize(),n=[];for await(const o of r.keys())o.startsWith(t+"_")&&!o.endsWith(".crswap")&&n.push(o.slice(t.length+1));return n}async _initialize(){return this._root?this._root:(this._root=await navigator.storage.getDirectory(),invariant$1(this._root,"Root is undefined",{F:__dxlog_file4$9,L:73,S:this,A:["this._root","'Root is undefined'"]}),this._root)}createDirectory(e=""){return new Directory({type:this.type,path:getFullPath(this.path,e),list:t=>this._list(t),getOrCreateFile:(...t)=>this.getOrCreateFile(...t),remove:()=>this._delete(e),onFlush:async()=>{await Promise.all(Array.from(this._getFiles(e)).map(([t,r])=>r.flush()))}})}getOrCreateFile(e,t,r){const n=this._getFullFilename(e,t),o=this._files.get(n);if(o)return o;const s=this._createFile(n);return this._files.set(n,s),s}_createFile(e){return new WebFile({fileName:e,file:this._initialize().then(t=>t.getFileHandle(e,{create:!0})),destroy:async()=>(this._files.delete(e),(await this._initialize()).removeEntry(e))})}async _delete(e){await Promise.all(Array.from(this._getFiles(e)).map(async([t,r])=>{await r.destroy().catch(n=>log.warn(n,void 0,{F:__dxlog_file4$9,L:116,S:this,C:(o,s)=>o(...s)})),this._files.delete(t)}))}async reset(){await this._initialize();for await(const e of await this._root.keys())await this._root.removeEntry(e,{recursive:!0}).catch(t=>log.warn("failed to remove an entry",{filename:e,err:t},{F:__dxlog_file4$9,L:126,S:this,C:(r,n)=>r(...n)})),this._files.delete(e);this._root=void 0}async close(){await Promise.all(Array.from(this._files.values()).map(e=>e.close().catch(t=>log.warn("failed to close a file",{file:e.fileName,e:t},{F:__dxlog_file4$9,L:136,S:this,C:(r,n)=>r(...n)}))))}_getFullFilename(e,t){return t?getFullPath(e,t).replace(/\//g,"_"):e.replace(/\//g,"_")}async getDiskInfo(){let e=0;const t=async r=>{const n=[];for await(const o of r.values())n.push((async()=>{switch(o.kind){case"file":e+=await o.getFile().then(s=>s.size);break;case"directory":await t(o);break}})());await Promise.all(n)};return await t(this._root),{used:e}}};_ts_decorate$g([synchronized],WebFS.prototype,"_initialize",null);var WebFile=class extends export_EventEmitter{constructor({fileName:e,file:t,destroy:r}){var n;super(),this._buffer=null,this._loadBufferPromise=null,this._flushScheduled=!1,this._flushPromise=Promise.resolve(),this._flushSequence=0,this._flushes=new TimeSeriesCounter,this._operations=new TimeSeriesCounter,this._reads=new TimeSeriesCounter,this._readBytes=new TimeSeriesCounter,this._writes=new TimeSeriesCounter,this._writeBytes=new TimeSeriesCounter,this.type=StorageType.WEBFS,this.opened=!0,this.suspended=!1,this.closed=!1,this.unlinked=!1,this.writing=!1,this.readable=!0,this.writable=!0,this.deletable=!0,this.truncatable=!0,this.statable=!0,this.destroyed=!1,this.directory="",this.filename="",this.native={write:export_callbackify(this.write.bind(this)),read:export_callbackify(this.read.bind(this)),del:export_callbackify(this.del.bind(this)),stat:export_callbackify(this.stat.bind(this)),destroy:export_callbackify(this.destroy.bind(this)),truncate:export_callbackify((n=this.truncate)==null?void 0:n.bind(this))},this.fileName=e,this._fileHandle=t,this._destroy=r,this._loadBufferGuarded()}get _bufferSize(){var e;return(e=this._buffer)==null?void 0:e.length}async _loadBuffer(){const e=await(await this._fileHandle).getFile();this._buffer=new Uint8Array(await e.arrayBuffer())}async _loadBufferGuarded(){await(this._loadBufferPromise??(this._loadBufferPromise=this._loadBuffer()))}async _flushCache(e){if(this.destroyed||e<this._flushSequence)return;this._flushSequence=e+1,this._flushes.inc(),await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:300,S:this,A:["this._buffer",""]});const t=await(await this._fileHandle).createWritable({keepExistingData:!0});await t.write({type:"write",data:this._buffer,position:0}),await t.close()}_flushLater(){if(this._flushScheduled)return;const e=this._flushSequence;setTimeout(async()=>{await this._flushPromise,this._flushScheduled=!1,this._flushPromise=this._flushCache(e).catch(t=>log.warn(t,void 0,{F:__dxlog_file4$9,L:318,S:this,C:(r,n)=>r(...n)}))}),this._flushScheduled=!0}async _flushNow(){await this._flushPromise,this._flushPromise=this._flushCache(this._flushSequence).catch(e=>log.warn(e,void 0,{F:__dxlog_file4$9,L:326,S:this,C:(t,r)=>t(...r)})),await this._flushPromise}async read(e,t){if(this.assertNotDestroyed("Read"),this._operations.inc(),this._reads.inc(),this._readBytes.inc(t),this._buffer||(await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:339,S:this,A:["this._buffer",""]})),e+t>this._buffer.length)throw new Error("Read out of bounds");return export_Buffer.from(this._buffer.slice(e,e+t))}async write(e,t){if(this.assertNotDestroyed("Write"),this._operations.inc(),this._writes.inc(),this._writeBytes.inc(t.length),this._buffer||(await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:359,S:this,A:["this._buffer",""]})),e+t.length<=this._buffer.length)this._buffer.set(t,e);else{const r=new Uint8Array(e+t.length);r.set(this._buffer),r.set(t,e),this._buffer=r}this._flushLater()}async del(e,t){if(this.assertNotDestroyed("Del"),this._operations.inc(),e<0||t<=0)return;this._buffer||(await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:386,S:this,A:["this._buffer",""]}));let r=0;e+t<this._buffer.length&&(r=this._buffer.length-(e+t),this._buffer.set(this._buffer.slice(e+t,e+t+r),e)),this._buffer=this._buffer.slice(0,e+r),this._flushLater()}async stat(){return this.assertNotDestroyed("Truncate"),this._operations.inc(),this._buffer||(await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:408,S:this,A:["this._buffer",""]})),{size:this._buffer.length}}async truncate(e){this.assertNotDestroyed("Truncate"),this._operations.inc(),this._buffer||(await this._loadBufferGuarded(),invariant$1(this._buffer,void 0,{F:__dxlog_file4$9,L:423,S:this,A:["this._buffer",""]})),this._buffer=this._buffer.slice(0,e),this._flushLater()}async flush(){this.assertNotDestroyed("Flush"),await this._flushNow()}async close(){await this._flushNow()}async destroy(){if(!this.destroyed)return await this._flushNow(),this.destroyed=!0,await this._destroy()}assertNotDestroyed(e){if(this.destroyed)throw new Error(`${e} on a destroyed or closed file`)}};_ts_decorate$g([trace.info()],WebFile.prototype,"fileName",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_flushes",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_operations",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_reads",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_readBytes",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_writes",void 0),_ts_decorate$g([trace.metricsCounter()],WebFile.prototype,"_writeBytes",void 0),_ts_decorate$g([trace.info()],WebFile.prototype,"_bufferSize",null),_ts_decorate$g([synchronized],WebFile.prototype,"destroy",null);var createStorage=({type:e,root:t=""}={})=>{if(e===void 0)return new IDbStorage(t);switch(e){case StorageType.RAM:return new MemoryStorage(t);case StorageType.IDB:case StorageType.CHROME:case StorageType.FIREFOX:return new IDbStorage(t);case StorageType.WEBFS:return new WebFS(t);default:throw new Error(`Invalid type: ${e}`)}},__create=Object.create,__defProp$1=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__esm=(e,t)=>function(){return e&&(t=(0,e[__getOwnPropNames(e)[0]])(e=0)),t},__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of __getOwnPropNames(t))!__hasOwnProp.call(e,o)&&o!==r&&__defProp$1(e,o,{get:()=>t[o],enumerable:!(n=__getOwnPropDesc(t,o))||n.enumerable});return e},__toESM=(e,t,r)=>(r=e!=null?__create(__getProtoOf(e)):{},__copyProps(!e||!e.__esModule?__defProp$1(r,"default",{value:e,enumerable:!0}):r,e)),init_inject_globals=__esm({"inject-globals:@inject-globals"(){}}),require_last_one_wins=__commonJS({"node_modules/.pnpm/last-one-wins@1.0.4/node_modules/last-one-wins/index.js"(e,t){init_inject_globals(),t.exports=function(n){var o=null,s=null,a=null,c=null;return function(u,d){c=u,l(d||r)};function l(u){if(s){o||(o=[]),o.push(u);return}var d=c;c=null,s=u,n(d,h)}function h(u){var d=s,f=a;if(a=null,s=null,o&&(a=o,o=null,l(r)),f)for(var _=0;_<f.length;_++)f[_](u);d(u)}};function r(n){}}}),require_unordered_array_remove=__commonJS({"node_modules/.pnpm/unordered-array-remove@1.0.2/node_modules/unordered-array-remove/index.js"(e,t){init_inject_globals(),t.exports=r;function r(n,o){if(!(o>=n.length||o<0)){var s=n.pop();if(o<n.length){var a=n[o];return n[o]=s,a}return s}}}}),require_unordered_set=__commonJS({"node_modules/.pnpm/unordered-set@2.0.1/node_modules/unordered-set/index.js"(e){init_inject_globals(),e.add=t,e.has=r,e.remove=n,e.swap=o;function t(s,a){return r(s,a)||(a._index=s.length,s.push(a)),a}function r(s,a){return a._index<s.length&&s[a._index]===a}function n(s,a){if(!r(s,a))return null;var c=s.pop();return c!==a&&(s[a._index]=c,c._index=a._index),a}function o(s,a,c){if(!(!r(s,a)||!r(s,c))){var l=a._index;a._index=c._index,s[a._index]=a,c._index=l,s[c._index]=c}}}}),require_flat_tree=__commonJS({"node_modules/.pnpm/flat-tree@1.9.0/node_modules/flat-tree/index.js"(e){init_inject_globals(),e.fullRoots=function(o,s){if(o&1)throw new Error("You can only look up roots for depth(0) blocks");s||(s=[]),o/=2;for(var a=0,c=1;;){if(!o)return s;for(;c*2<=o;)c*=2;s.push(a+c-1),a=a+2*c,o-=c,c=1}},e.depth=function(o){var s=0;for(o+=1;!(o&1);)s++,o=r(o);return s},e.sibling=function(o,s){s||(s=e.depth(o));var a=e.offset(o,s);return e.index(s,a&1?a-1:a+1)},e.parent=function(o,s){s||(s=e.depth(o));var a=e.offset(o,s);return e.index(s+1,r(a))},e.leftChild=function(o,s){return o&1?(s||(s=e.depth(o)),e.index(s-1,e.offset(o,s)*2)):-1},e.rightChild=function(o,s){return o&1?(s||(s=e.depth(o)),e.index(s-1,1+e.offset(o,s)*2)):-1},e.children=function(o,s){if(!(o&1))return null;s||(s=e.depth(o));var a=e.offset(o,s)*2;return[e.index(s-1,a),e.index(s-1,a+1)]},e.leftSpan=function(o,s){return o&1?(s||(s=e.depth(o)),e.offset(o,s)*t(s+1)):o},e.rightSpan=function(o,s){return o&1?(s||(s=e.depth(o)),(e.offset(o,s)+1)*t(s+1)-2):o},e.count=function(o,s){return o&1?(s||(s=e.depth(o)),t(s+1)-1):1},e.countLeaves=function(o){return(e.count(o)+1)/2},e.spans=function(o,s){if(!(o&1))return[o,o];s||(s=e.depth(o));var a=e.offset(o,s),c=t(s+1);return[a*c,(a+1)*c-2]},e.index=function(o,s){return(1+2*s)*t(o)-1},e.offset=function(o,s){return o&1?(s||(s=e.depth(o)),((o+1)/t(s)-1)/2):o/2},e.iterator=function(o){var s=new n;return s.seek(o||0),s};function t(o){return o<31?1<<o:(1<<30)*(1<<o-30)}function r(o){return(o-(o&1))/2}function n(){this.index=0,this.offset=0,this.factor=0}n.prototype.seek=function(o){this.index=o,this.index&1?(this.offset=e.offset(o),this.factor=t(e.depth(o)+1)):(this.offset=o/2,this.factor=2)},n.prototype.isLeft=function(){return(this.offset&1)===0},n.prototype.isRight=function(){return(this.offset&1)===1},n.prototype.contains=function(o){return o>this.index?o<this.index+this.factor/2:o<this.index?o>this.index-this.factor/2:!0},n.prototype.prev=function(){return this.offset?(this.offset--,this.index-=this.factor,this.index):this.index},n.prototype.next=function(){return this.offset++,this.index+=this.factor,this.index},n.prototype.count=function(){return this.index&1?this.factor-1:1},n.prototype.countLeaves=function(){return(this.count()+1)/2},n.prototype.sibling=function(){return this.isLeft()?this.next():this.prev()},n.prototype.parent=function(){return this.offset&1?(this.index-=this.factor/2,this.offset=(this.offset-1)/2):(this.index+=this.factor/2,this.offset/=2),this.factor*=2,this.index},n.prototype.leftSpan=function(){return this.index=this.index-this.factor/2+1,this.offset=this.index/2,this.factor=2,this.index},n.prototype.rightSpan=function(){return this.index=this.index+this.factor/2-1,this.offset=this.index/2,this.factor=2,this.index},n.prototype.leftChild=function(){return this.factor===2?this.index:(this.factor/=2,this.index-=this.factor/2,this.offset*=2,this.index)},n.prototype.rightChild=function(){return this.factor===2?this.index:(this.factor/=2,this.index+=this.factor/2,this.offset=2*this.offset+1,this.index)},n.prototype.nextTree=function(){return this.index=this.index+this.factor/2+1,this.offset=this.index/2,this.factor=2,this.index},n.prototype.prevTree=function(){return this.offset?(this.index=this.index-this.factor/2-1,this.offset=this.index/2,this.factor=2):(this.index=0,this.factor=2),this.index},n.prototype.fullRoot=function(o){if(o<=this.index||(this.index&1)>0)return!1;for(;o>this.index+this.factor+this.factor/2;)this.index+=this.factor/2,this.factor*=2,this.offset/=2;return!0}}}),require_generator=__commonJS({"node_modules/.pnpm/merkle-tree-stream@4.0.0/node_modules/merkle-tree-stream/generator.js"(e,t){init_inject_globals();var r=require_flat_tree();t.exports=class{constructor(n,o){if(!n||!n.leaf||!n.parent)throw new Error("opts.leaf and opts.parent required");this.roots=o||n.roots||[],this.blocks=this.roots.length?1+r.rightSpan(this.roots[this.roots.length-1].index)/2:0;for(var s=0;s<this.roots.length;s++){var a=this.roots[s];a&&!a.parent&&(a.parent=r.parent(a.index))}this._leaf=n.leaf,this._parent=n.parent}next(n,o){export_Buffer.isBuffer(n)||(n=export_Buffer.from(n)),o||(o=[]);var s=2*this.blocks++,a={index:s,parent:r.parent(s),hash:null,size:n.length,data:n};for(a.hash=this._leaf(a,this.roots),this.roots.push(a),o.push(a);this.roots.length>1;){var c=this.roots[this.roots.length-2],l=this.roots[this.roots.length-1];if(c.parent!==l.parent)break;this.roots.pop(),this.roots[this.roots.length-1]=a={index:c.parent,parent:r.parent(c.parent),hash:this._parent(c,l),size:c.size+l.size,data:null},o.push(a)}return o}}}}),require_codecs=__commonJS({"node_modules/.pnpm/codecs@2.2.0/node_modules/codecs/index.js"(e,t){init_inject_globals(),t.exports=r,r.ascii=o("ascii"),r.utf8=o("utf-8"),r.hex=o("hex"),r.base64=o("base64"),r.ucs2=o("ucs2"),r.utf16le=o("utf16le"),r.ndjson=n(!0),r.json=n(!1),r.binary={name:"binary",encode:function(s){return typeof s=="string"?export_Buffer.from(s,"utf-8"):export_Buffer.isBuffer(s)?s:export_Buffer.from(s.buffer,s.byteOffset,s.byteLength)},decode:function(s){return export_Buffer.isBuffer(s)?s:export_Buffer.from(s.buffer,s.byteOffset,s.byteLength)}};function r(s,a){if(typeof s=="object"&&s&&s.encode&&s.decode)return s;switch(s){case"ndjson":return r.ndjson;case"json":return r.json;case"ascii":return r.ascii;case"utf-8":case"utf8":return r.utf8;case"hex":return r.hex;case"base64":return r.base64;case"ucs-2":case"ucs2":return r.ucs2;case"utf16-le":case"utf16le":return r.utf16le}return a!==void 0?a:r.binary}function n(s){return{name:s?"ndjson":"json",encode:s?c:a,decode:function(l){return JSON.parse(l.toString())}};function a(l){return export_Buffer.from(JSON.stringify(l))}function c(l){return export_Buffer.from(JSON.stringify(l)+`
`)}}function o(s){return{name:s,encode:function(a){return typeof a!="string"&&(a=a.toString()),export_Buffer.from(a,s)},decode:function(a){return a.toString(s)}}}}}),require_atomic_batcher=__commonJS({"node_modules/.pnpm/atomic-batcher@1.0.2/node_modules/atomic-batcher/index.js"(e,t){init_inject_globals(),t.exports=r;function r(a){var c=!1,l=null,h=null,u=null;return f;function d(_){u&&s(u,_),c=!1,u=h;var p=l;if(l=null,h=null,!p||!p.length){if(!u||!u.length){u=null;return}p||(p=[])}c=!0,a(p,d)}function f(_,p){c?(l||(l=[],h=[]),n(l,_),p&&h.push(p)):(p&&(u=[p]),c=!0,a(Array.isArray(_)?_:[_],d))}}function n(a,c){Array.isArray(c)?o(a,c):a.push(c)}function o(a,c){for(var l=0;l<c.length;l++)a.push(c[l])}function s(a,c){for(var l=0;l<a.length;l++)a[l](c)}}}),require_inherits_browser=__commonJS({"node_modules/.pnpm/inherits@2.0.4/node_modules/inherits/inherits_browser.js"(e,t){init_inject_globals(),typeof Object.create=="function"?t.exports=function(r,n){n&&(r.super_=n,r.prototype=Object.create(n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(r,n){if(n){r.super_=n;var o=function(){};o.prototype=n.prototype,r.prototype=new o,r.prototype.constructor=r}}}}),require_encode=__commonJS({"node_modules/.pnpm/varint@4.0.1/node_modules/varint/encode.js"(e,t){init_inject_globals(),t.exports=a;var r=128,n=127,o=~n,s=Math.pow(2,31);function a(c,l,h){l=l||[],h=h||0;for(var u=h;c>=s;)l[h++]=c&255|r,c/=128;for(;c&o;)l[h++]=c&255|r,c>>>=7;return l[h]=c|0,a.bytes=h-u+1,l}}}),require_decode=__commonJS({"node_modules/.pnpm/varint@4.0.1/node_modules/varint/decode.js"(e,t){init_inject_globals(),t.exports=o;var r=128,n=127;function o(s,l){var c=0,l=l||0,h=0,u=l,d,f=s.length;do{if(u>=f){o.bytes=0,o.bytesRead=0;return}d=s[u++],c+=h<28?(d&n)<<h:(d&n)*Math.pow(2,h),h+=7}while(d>=r);return o.bytes=u-l,c}}}),require_length=__commonJS({"node_modules/.pnpm/varint@4.0.1/node_modules/varint/length.js"(e,t){init_inject_globals();var r=Math.pow(2,7),n=Math.pow(2,14),o=Math.pow(2,21),s=Math.pow(2,28),a=Math.pow(2,35),c=Math.pow(2,42),l=Math.pow(2,49),h=Math.pow(2,56),u=Math.pow(2,63);t.exports=function(d){return d<r?1:d<n?2:d<o?3:d<s?4:d<a?5:d<c?6:d<l?7:d<h?8:d<u?9:10}}}),require_varint=__commonJS({"node_modules/.pnpm/varint@4.0.1/node_modules/varint/index.js"(e,t){init_inject_globals(),t.exports={encode:require_encode(),decode:require_decode(),encodingLength:require_length()}}}),require_buffer_alloc_unsafe=__commonJS({"node_modules/.pnpm/buffer-alloc-unsafe@1.1.0/node_modules/buffer-alloc-unsafe/index.js"(e,t){init_inject_globals();function r(n){if(typeof n!="number")throw new TypeError('"size" argument must be a number');if(n<0)throw new RangeError('"size" argument must not be negative');return export_Buffer.allocUnsafe?export_Buffer.allocUnsafe(n):new export_Buffer(n)}t.exports=r}}),require_bitfield_rle=__commonJS({"node_modules/.pnpm/bitfield-rle@2.2.1/node_modules/bitfield-rle/index.js"(e,t){init_inject_globals();var r=require_varint(),n=require_buffer_alloc_unsafe();t.exports=o(1);function o(s){var a={};return a.align=o,a.encode=l,a.encode.bytes=0,a.encodingLength=h,a.decode=u,a.decode.bytes=0,a.decodingLength=d,a;function c(w,E,x){this.inputOffset=0,this.inputLength=w.length,this.input=w,this.outputOffset=x,this.output=E}function l(w,E,x){x||(x=0),E||(E=n(h(w)));var B=new c(w,E,x);return f(B),l.bytes=B.outputOffset-x,E}function h(w){var E=new c(w,null,0);return f(E),E.outputOffset}function u(w,E){E||(E=0);for(var x=n(d(w,E)),B=0;E<w.length;){var P=r.decode(w,E),U=P&1,F=U?(P-(P&3))/4:P/2;E+=r.decode.bytes,U?x.fill(P&2?255:0,B,B+F):(w.copy(x,B,E,E+F),E+=F),B+=F}return x.fill(0,B),u.bytes=w.length-E,x}function d(w,E){E||(E=0);for(var x=0;E<w.length;){var B=r.decode(w,E);E+=r.decode.bytes;var P=B&1,U=P?(B-(B&3))/4:B/2;x+=U,P||(E+=U)}if(E>w.length)throw new Error("Invalid RLE bitfield");return x&s-1?x+(s-(x&s-1)):x}function f(w){for(var E=0,x=0,B=w.input;w.inputLength>0&&!B[w.inputLength-1];)w.inputLength--;for(var P=0;P<w.inputLength;P++){if(B[P]===x){E++;continue}E&&y(w,P,E,x),B[P]===0||B[P]===255?(x=B[P],E=1):E=0}E&&y(w,w.inputLength,E,x),p(w)}function _(w,E){var x=E-w.inputOffset;r.encode(2*x,w.output,w.outputOffset),w.outputOffset+=r.encode.bytes,w.input.copy(w.output,w.outputOffset,w.inputOffset,E),w.outputOffset+=x}function p(w){var E=w.inputLength-w.inputOffset;E&&(w.output?_(w,w.inputLength):w.outputOffset+=E+r.encodingLength(2*E),w.inputOffset=w.inputLength)}function y(w,E,x,B){var P=E-x-w.inputOffset,U=P?r.encodingLength(2*P)+P:0,F=4*x+(B?2:0)+1,G=U+r.encodingLength(F),H=r.encodingLength(2*(E-w.inputOffset))+E-w.inputOffset;if(!(G>=H)){if(!w.output){w.outputOffset+=G,w.inputOffset=E;return}P&&_(w,E-x),r.encode(F,w.output,w.outputOffset),w.outputOffset+=r.encode.bytes,w.inputOffset=E}}}}}),require_memory_pager=__commonJS({"node_modules/.pnpm/memory-pager@1.5.0/node_modules/memory-pager/index.js"(e,t){init_inject_globals(),t.exports=r;function r(h,u){if(!(this instanceof r))return new r(h,u);this.length=0,this.updates=[],this.path=new Uint16Array(4),this.pages=new Array(32768),this.maxPages=this.pages.length,this.level=0,this.pageSize=h||1024,this.deduplicate=u?u.deduplicate:null,this.zeros=this.deduplicate?s(this.deduplicate.length):null}r.prototype.updated=function(h){for(;this.deduplicate&&h.buffer[h.deduplicate]===this.deduplicate[h.deduplicate];)if(h.deduplicate++,h.deduplicate===this.deduplicate.length){h.deduplicate=0,h.buffer.equals&&h.buffer.equals(this.deduplicate)&&(h.buffer=this.deduplicate);break}h.updated||!this.updates||(h.updated=!0,this.updates.push(h))},r.prototype.lastUpdate=function(){if(!this.updates||!this.updates.length)return null;var h=this.updates.pop();return h.updated=!1,h},r.prototype._array=function(h,u){if(h>=this.maxPages){if(u)return;n(this,h)}l(h,this.path);for(var d=this.pages,f=this.level;f>0;f--){var _=this.path[f],p=d[_];if(!p){if(u)return;p=d[_]=new Array(32768)}d=p}return d},r.prototype.get=function(h,u){var d=this._array(h,u),f=this.path[0],_=d&&d[f];return!_&&!u&&(_=d[f]=new c(h,s(this.pageSize)),h>=this.length&&(this.length=h+1)),_&&_.buffer===this.deduplicate&&this.deduplicate&&!u&&(_.buffer=a(_.buffer),_.deduplicate=0),_},r.prototype.set=function(h,u){var d=this._array(h,!1),f=this.path[0];if(h>=this.length&&(this.length=h+1),!u||this.zeros&&u.equals&&u.equals(this.zeros)){d[f]=void 0;return}this.deduplicate&&u.equals&&u.equals(this.deduplicate)&&(u=this.deduplicate);var _=d[f],p=o(u,this.pageSize);_?_.buffer=p:d[f]=new c(h,p)},r.prototype.toBuffer=function(){for(var h=new Array(this.length),u=s(this.pageSize),d=0;d<h.length;)for(var f=this._array(d,!0),_=0;_<32768&&d<h.length;_++)h[d++]=f&&f[_]?f[_].buffer:u;return export_Buffer.concat(h)};function n(h,u){for(;h.maxPages<u;){var d=h.pages;h.pages=new Array(32768),h.pages[0]=d,h.level++,h.maxPages*=32768}}function o(h,u){if(h.length===u)return h;if(h.length>u)return h.slice(0,u);var d=s(u);return h.copy(d),d}function s(h){if(export_Buffer.alloc)return export_Buffer.alloc(h);var u=new export_Buffer(h);return u.fill(0),u}function a(h){var u=export_Buffer.allocUnsafe?export_Buffer.allocUnsafe(h.length):new export_Buffer(h.length);return h.copy(u),u}function c(h,u){this.offset=h*u.length,this.buffer=u,this.updated=!1,this.deduplicate=0}function l(h,u){h=(h-(u[0]=h&32767))/32768,h=(h-(u[1]=h&32767))/32768,u[3]=(h-(u[2]=h&32767))/32768&32767}}}),require_sparse_bitfield=__commonJS({"node_modules/.pnpm/sparse-bitfield@3.0.3/node_modules/sparse-bitfield/index.js"(e,t){init_inject_globals();var r=require_memory_pager();t.exports=n;function n(a){if(!(this instanceof n))return new n(a);if(a||(a={}),export_Buffer.isBuffer(a)&&(a={buffer:a}),this.pageOffset=a.pageOffset||0,this.pageSize=a.pageSize||1024,this.pages=a.pages||r(this.pageSize),this.byteLength=this.pages.length*this.pageSize,this.length=8*this.byteLength,!s(this.pageSize))throw new Error("The page size should be a power of two");if(this._trackUpdates=!!a.trackUpdates,this._pageMask=this.pageSize-1,a.buffer){for(var c=0;c<a.buffer.length;c+=this.pageSize)this.pages.set(c/this.pageSize,a.buffer.slice(c,c+this.pageSize));this.byteLength=a.buffer.length,this.length=8*this.byteLength}}n.prototype.get=function(a){var c=a&7,l=(a-c)/8;return!!(this.getByte(l)&128>>c)},n.prototype.getByte=function(a){var c=a&this._pageMask,l=(a-c)/this.pageSize,h=this.pages.get(l,!0);return h?h.buffer[c+this.pageOffset]:0},n.prototype.set=function(a,c){var l=a&7,h=(a-l)/8,u=this.getByte(h);return this.setByte(h,c?u|128>>l:u&(255^128>>l))},n.prototype.toBuffer=function(){for(var a=o(this.pages.length*this.pageSize),c=0;c<this.pages.length;c++){var l=this.pages.get(c,!0),h=c*this.pageSize;l&&l.buffer.copy(a,h,this.pageOffset,this.pageOffset+this.pageSize)}return a},n.prototype.setByte=function(a,c){var l=a&this._pageMask,h=(a-l)/this.pageSize,u=this.pages.get(h,!1);return l+=this.pageOffset,u.buffer[l]===c?!1:(u.buffer[l]=c,a>=this.byteLength&&(this.byteLength=a+1,this.length=this.byteLength*8),this._trackUpdates&&this.pages.updated(u),!0)};function o(a){if(export_Buffer.alloc)return export_Buffer.alloc(a);var c=new export_Buffer(a);return c.fill(0),c}function s(a){return!(a&a-1)}}}),require_bitfield=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/bitfield.js"(e,t){init_inject_globals();var r=require_flat_tree(),n=require_bitfield_rle(),o=require_memory_pager(),s=require_sparse_bitfield(),a=[63,207,243,252],c=[0,192,240,252],l=[128,192,224,240,248,252,254,255],h=[127,191,223,239,247,251,253,254],u=new Array(256),d=new Array(256),f=new Array(256),_=new Array(256),p=new Array(256);for(x=0;x<256;x++)y=(x&240)>>4,w=x&15,E=[0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4],u[x]=(y===15?3:y===0?0:1)<<2|(w===15?3:w===0?0:1),d[x]=u[x]<<4,f[x]=x===255?-1:8-Math.ceil(Math.log(256-x)/Math.log(2)),_[x]=x===255?-1:Math.floor(f[x]/2),p[x]=E[x>>4]+E[x&15];var y,w,E,x;t.exports=B;function B(te,J){if(!(this instanceof B))return new B(te,J);te||(te=3584);var le=export_Buffer.allocUnsafe(te);if(le.fill(255),this.indexSize=te-2048-1024,this.pages=o(te,{deduplicate:le}),J)for(var z=0;z<J.length;z++)this.pages.set(z,J[z]);this.data=s({pageSize:1024,pageOffset:0,pages:this.pages,trackUpdates:!0}),this.tree=s({pageSize:2048,pageOffset:1024,pages:this.pages,trackUpdates:!0}),this.index=s({pageSize:this.indexSize,pageOffset:3072,pages:this.pages,trackUpdates:!0}),this.length=this.data.length,this._iterator=r.iterator(0)}B.prototype.set=function(te,J){var le=te&7;te=(te-le)/8;var z=J?this.data.getByte(te)|128>>le:this.data.getByte(te)&h[le];return this.data.setByte(te,z)?(this.length=this.data.length,this._setIndex(te,z),!0):!1},B.prototype.get=function(te){return this.data.get(te)},B.prototype.total=function(te,J){if((!te||te<0)&&(te=0),J||(J=this.data.length),J<te)return 0;J>this.data.length&&this._expand(J);var le=te&7,z=J&7,q=(te-le)/8,he=(J-z)/8,V=255-(le?l[le-1]:0),_e=z?l[z-1]:0,ee=this.data.getByte(q);if(q===he)return p[ee&V&_e];for(var W=p[ee&V],re=q+1;re<he;re++)W+=p[this.data.getByte(re)];return W+=p[this.data.getByte(he)&_e],W},B.prototype.compress=function(te,J){if(!te&&!J)return n.encode(this.data.toBuffer());te+J>this.length&&(J=Math.max(1,this.length-te));for(var le=export_Buffer.alloc(Math.ceil(J/8)),z=te/this.data.pageSize/8,q=z+J/this.data.pageSize/8,he=z*this.data.pageSize;z<q;z++){var V=this.data.pages.get(z,!0);!V||!V.buffer||V.buffer.copy(le,z*this.data.pageSize-he,this.data.pageOffset,this.data.pageOffset+this.data.pageSize)}return n.encode(le)},B.prototype._setIndex=function(te,J){var le=te&3;te=(te-le)/4;var z=this.index,q=this._iterator,he=2*te,V=z.getByte(he)&a[le]|H(J)>>2*le,_e=z.length,ee=this.pages.length*this.indexSize;for(q.seek(he);q.index<ee&&z.setByte(q.index,V);)q.isLeft()?V=d[V]|u[z.getByte(q.sibling())]:V=u[V]|d[z.getByte(q.sibling())],q.parent();return _e!==z.length&&this._expand(_e),q.index!==he},B.prototype._expand=function(te){for(var J=r.fullRoots(2*te),le=this.index,z=this._iterator,q=0,he=0;he<J.length;he++){z.seek(J[he]),q=le.getByte(z.index);do z.isLeft()?q=d[q]|u[le.getByte(z.sibling())]:q=u[q]|d[le.getByte(z.sibling())];while(P(le,z.parent(),q))}};function P(te,J,le){return 8*J>=te.length?!1:te.setByte(J,le)}B.prototype.iterator=function(te,J){var le=new U(this);return le.range(te||0,J||this.length),le.seek(0),le};function U(te){this.start=0,this.end=0,this._indexEnd=0,this._pos=0,this._byte=0,this._bitfield=te}U.prototype.range=function(te,J){return this.start=te,this.end=J,this._indexEnd=2*Math.ceil(J/32),this.end>this._bitfield.length&&this._bitfield._expand(this.end),this},U.prototype.seek=function(te){if(te+=this.start,te<this.start&&(te=this.start),te>=this.end)return this._pos=-1,this;var J=te&7;return this._pos=(te-J)/8,this._byte=this._bitfield.data.getByte(this._pos)|(J?l[J-1]:0),this},U.prototype.random=function(){var te=this.seek(Math.floor(Math.random()*(this.end-this.start))).next();return te===-1?this.seek(0).next():te},U.prototype.next=function(){if(this._pos===-1)return-1;for(var te=this._bitfield.data,J=f[this._byte];J===-1;)if(this._byte=te.getByte(++this._pos),J=f[this._byte],J===-1){if(this._pos=this._skipAhead(this._pos),this._pos===-1)return-1;this._byte=te.getByte(this._pos),J=f[this._byte]}this._byte|=l[J];var le=8*this._pos+J;return le<this.end?le:-1},U.prototype.peek=function(){if(this._pos===-1)return-1;var te=f[this._byte],J=8*this._pos+te;return J<this.end?J:-1},U.prototype._skipAhead=function(te){var J=this._bitfield.index,le=this._indexEnd,z=this._bitfield._iterator,q=te&3;z.seek(2*((te-q)/4));for(var he=J.getByte(z.index)|c[q];_[he]===-1;){if(z.isLeft()?z.next():(z.next(),z.parent()),F(z)>=le){for(;F(z)>=le&&G(z);)z.leftChild();if(F(z)>=le)return-1}he=J.getByte(z.index)}for(;z.factor>2;)_[he]<2?z.leftChild():z.rightChild(),he=J.getByte(z.index);var V=_[he];V===-1&&(V=4);var _e=z.index*2+V;return _e<=te?te+1:_e};function F(te){return te.index+te.factor/2-1}function G(te){return te.index&1}function H(te){switch(te){case 255:return 192;case 0:return 0;default:return 64}}}}),require_tree_index=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/tree-index.js"(e,t){init_inject_globals();var r=require_flat_tree(),n=require_sparse_bitfield();t.exports=o;function o(c){if(!(this instanceof o))return new o(c);this.bitfield=c||n()}o.prototype.proof=function(c,l){l||(l={});var h=[],u=l.tree||new o,d=l.digest||0;if(!this.get(c))return null;if(l.hash&&h.push(c),d===1)return{nodes:h,verifiedBy:0};var f=null,_=c,p=c,y=d&1;for(d=s(d);d;){if(d===1&&y){this.get(p)&&u.set(p),r.sibling(p)<p&&(p=r.sibling(p)),f=r.fullRoots(r.rightSpan(p)+2);for(var w=0;w<f.length;w++)this.get(f[w])&&u.set(f[w]);break}_=r.sibling(p),d&1&&this.get(_)&&u.set(_),p=r.parent(p),d=s(d)}for(p=c;!u.get(p);){if(_=r.sibling(p),this.get(_))u.get(_)||h.push(_);else{var E=this.verifiedBy(p);return a(E,h,p,u),{nodes:h,verifiedBy:E}}p=r.parent(p)}return{nodes:h,verifiedBy:0}},o.prototype.digest=function(c){if(this.get(c))return 1;for(var l=0,h=r.sibling(c),u=Math.max(h+2,this.bitfield.length),d=2,f=r.depth(c),_=r.parent(h,f++);r.rightSpan(h)<u||r.leftSpan(_)>0;){if(this.get(h)&&(l+=d),this.get(_))return l+=2*d,l&1||(l+=1),l+1===4*d?1:l;h=r.sibling(_),_=r.parent(h,f++),d*=2}return l},o.prototype.blocks=function(){for(var c=0,l=0,h=this.bitfield.length;r.rightSpan(l)<h;)l=r.parent(l),this.get(l)&&(c=l);return(this.get(c)?this.verifiedBy(c):0)/2},o.prototype.roots=function(){return r.fullRoots(2*this.blocks())},o.prototype.verifiedBy=function(c,l){var h=this.get(c);if(!h)return 0;for(var u=r.depth(c),d=c,f=r.parent(d,u++);this.get(f)&&this.get(r.sibling(d));)d=f,f=r.parent(d,u++);for(u--;u;){for(d=r.leftChild(r.index(u,r.offset(d,u)+1),u),u--;!this.get(d)&&u;)d=r.leftChild(d,u--);l&&this.get(d)&&l.push(d)}return this.get(d)?d+2:d},o.prototype.get=function(c){return this.bitfield.get(c)},o.prototype.truncate=function(c){const l=2*this.blocks(),h=r.fullRoots(c);for(let u=c;u<l;u++)this.bitfield.set(u,!1);for(const u of h){let d=r.parent(u);for(;d<c;)this.bitfield.set(d,!1),d=r.parent(d)}},o.prototype.set=function(c){if(!this.bitfield.set(c,!0))return!1;for(;this.bitfield.get(r.sibling(c))&&(c=r.parent(c),!!this.bitfield.set(c,!0)););return!0};function s(c){return(c-(c&1))/2}function a(c,l,h,u){for(var d=r.fullRoots(c),f=0;f<d.length;f++)d[f]!==h&&!u.get(d[f])&&l.push(d[f])}}}),require_buffer_fill=__commonJS({"node_modules/.pnpm/buffer-fill@1.0.0/node_modules/buffer-fill/index.js"(e,t){init_inject_globals();var r=function(){try{if(!export_Buffer.isEncoding("latin1"))return!1;var c=export_Buffer.alloc?export_Buffer.alloc(4):new export_Buffer(4);return c.fill("ab","ucs2"),c.toString("hex")==="61006200"}catch{return!1}}();function n(c){return c.length===1&&c.charCodeAt(0)<256}function o(c,l,h,u){if(h<0||u>c.length)throw new RangeError("Out of range index");return h=h>>>0,u=u===void 0?c.length:u>>>0,u>h&&c.fill(l,h,u),c}function s(c,l,h,u){if(h<0||u>c.length)throw new RangeError("Out of range index");if(u<=h)return c;h=h>>>0,u=u===void 0?c.length:u>>>0;for(var d=h,f=l.length;d<=u-f;)l.copy(c,d),d+=f;return d!==u&&l.copy(c,d,0,u-d),c}function a(c,l,h,u,d){if(r)return c.fill(l,h,u,d);if(typeof l=="number")return o(c,l,h,u);if(typeof l=="string"){if(typeof h=="string"?(d=h,h=0,u=c.length):typeof u=="string"&&(d=u,u=c.length),d!==void 0&&typeof d!="string")throw new TypeError("encoding must be a string");if(d==="latin1"&&(d="binary"),typeof d=="string"&&!export_Buffer.isEncoding(d))throw new TypeError("Unknown encoding: "+d);if(l==="")return o(c,0,h,u);if(n(l))return o(c,l.charCodeAt(0),h,u);l=new export_Buffer(l,d)}return export_Buffer.isBuffer(l)?s(c,l,h,u):o(c,0,h,u)}t.exports=a}}),require_buffer_alloc=__commonJS({"node_modules/.pnpm/buffer-alloc@1.2.0/node_modules/buffer-alloc/index.js"(e,t){init_inject_globals();var r=require_buffer_fill(),n=require_buffer_alloc_unsafe();t.exports=function(o,s,a){if(typeof o!="number")throw new TypeError('"size" argument must be a number');if(o<0)throw new RangeError('"size" argument must not be negative');if(export_Buffer.alloc)return export_Buffer.alloc(o,s,a);var c=n(o);return o===0?c:s===void 0?r(c,0):(typeof a!="string"&&(a=void 0),r(c,s,a))}}}),require_uint64be=__commonJS({"node_modules/.pnpm/uint64be@2.0.2/node_modules/uint64be/index.js"(e){init_inject_globals();var t=require_buffer_alloc(),r=Math.pow(2,32);e.encodingLength=function(){return 8},e.encode=function(n,o,s){o||(o=t(8)),s||(s=0);var a=Math.floor(n/r),c=n-a*r;return o.writeUInt32BE(a,s),o.writeUInt32BE(c,s+4),o},e.decode=function(n,o){o||(o=0);var s=n.readUInt32BE(o),a=n.readUInt32BE(o+4);return s*r+a},e.encode.bytes=8,e.decode.bytes=8}}),require_hypercore_cache=__commonJS({"node_modules/.pnpm/hypercore-cache@1.0.2/node_modules/hypercore-cache/index.js"(e,t){init_inject_globals();var r=1024*1024*16,n=class{constructor(s,a){this.name=a,this.parent=s}get _info(){return this.parent._info}set(s,a){return this.parent._set(this.name,s,a)}del(s){return this.parent._del(this.name,s)}get(s){return this.parent._get(this.name,s)}};t.exports=class{constructor(s={}){this.maxByteSize=s.maxByteSize||r,this.onEvict=s.onEvict,this.estimateSize=s.estimateSize||o,this._nextNamespace=0,this.defaultCache=new n(this,this._nextNamespace++),this._stale=null,this._fresh=new Map,this._freshByteSize=0,this._staleByteSize=0}get _info(){return{freshByteSize:this._freshByteSize,staleByteSize:this._staleByteSize,staleEntries:this._stale?this._stale.size:0,freshEntries:this._fresh.size,byteSize:this.byteSize}}_prefix(s,a){return s+":"+a}_gc(){this.onEvict&&this._staleByteSize>0&&this.onEvict(this._stale),this._stale=this._fresh,this._fresh=new Map,this._staleByteSize=this._freshByteSize,this._freshByteSize=0}_get(s,a,c){return c||(c=this._prefix(s,a)),this._fresh.get(c)||this._stale&&this._stale.get(c)}_set(s,a,c){const l=this.estimateSize(c),h=this._prefix(s,a);this._freshByteSize+l>this.maxByteSize&&this._gc(),this._fresh.set(h,c),this._freshByteSize+=l}_del(s,a){const c=this._prefix(s,a);let l=this._stale&&this._stale.get(c);l&&(this._stale.delete(c),this._staleByteSize-=this.estimateSize(l)),l=this._fresh.get(c),l&&(this._fresh.delete(c),this._freshByteSize-=this.estimateSize(l))}get byteSize(){return this._freshByteSize+this._staleByteSize}namespace(){return new n(this,this._nextNamespace++)}set(s,a){return this.defaultCache.set(s,a)}del(s){return this.defaultCache.del(s)}get(s){return this.defaultCache.get(s)}};function o(){return 1024}}}),require_cache=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/cache.js"(e,t){init_inject_globals();var r=require_hypercore_cache(),n=65536*40;function o(s){if(s.cache===!1)return{};const a=s.cache||{};if(a.tree===void 0||typeof a.tree=="number"){const c=a.tree||s.storageCacheSize;a.tree=new r({maxByteSize:c!==void 0?c:n,estimateSize:()=>40})}return a.data===void 0||typeof a.data=="number"&&(a.data=new r({maxByteSize:a.data,estimateSize:c=>c.length})),a}t.exports=o}}),require_storage=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/storage.js"(e,t){init_inject_globals();var r=require_uint64be(),n=require_flat_tree(),o=require_cache();t.exports=a;var s=[];function a(E,x){if(!(this instanceof a))return new a(E,x);const B=o(x);this.treeCache=B.tree||null,this.dataCache=B.data||null,this.key=null,this.secretKey=null,this.tree=null,this.data=null,this.bitfield=null,this.signatures=null,this.create=E}a.prototype.putData=function(E,x,B,P){P||(P=c);var U=this;if(!x.length)return P(null);this.dataOffset(E,B,function(F,G,H){if(F)return P(F);if(H!==x.length)return P(new Error("Unexpected data size"));U.data.write(G,x,P)})},a.prototype.getData=function(E,x){var B=this,P=this.dataCache&&this.dataCache.get(E);if(P)return process$1.nextTick(x,null,P);this.dataOffset(E,s,function(U,F,G){if(U)return x(U);B.data.read(F,G,(H,te)=>H?x(H):(B.dataCache&&B.dataCache.set(E,te),x(null,te)))})},a.prototype.nextSignature=function(E,x){var B=this;this._getSignature(E,function(P,U){if(P)return x(P);if(f(U))return B.nextSignature(E+1,x);x(null,{index:E,signature:U})})},a.prototype.getSignature=function(E,x){this._getSignature(E,function(B,P){if(B)return x(B);if(f(P))return x(new Error("No signature found"));x(null,P)})},a.prototype._getSignature=function(E,x){this.signatures.read(32+64*E,64,x)},a.prototype.putSignature=function(E,x,B){this.signatures.write(32+64*E,x,B)},a.prototype.deleteSignatures=function(E,x,B){this.signatures.del(32+64*E,(x-E)*64,B)},a.prototype.dataOffset=function(E,x,B){var P=n.fullRoots(2*E),U=this,F=0,G=P.length,H=null,te=2*E;if(!G){G=1,q(null,null);return}for(var J=0;J<P.length;J++){var le=d(x,P[J]);le?q(null,le):this.getNode(P[J],q)}function z(he,V){if(he)return B(he);B(null,F,V.size)}function q(he,V){if(he&&(H=he),V&&(F+=V.size),!--G){if(H)return B(H);var _e=d(x,te);_e?z(null,_e):U.getNode(te,z)}}},a.prototype.getDataBatch=function(E,x,B){var P=new Array(x),U=new Array(x),F=this;this.dataOffset(E,s,function(G,H,te){if(G)return B(G);if(E++,x--,x<=0)return J(null,null);F.tree.read(32+80*E,80*x-40,J);function J(z,q){if(z)return B(z);var he=U[0]=te;if(q)for(var V=1;V<U.length;V++)U[V]=r.decode(q,32+(V-1)*80),he+=U[V];F.data.read(H,he,le)}function le(z,q){if(z)return B(z);for(var he=0,V=0;V<P.length;V++)P[V]=q.slice(he,he+=U[V]);B(null,P)}})},a.prototype.getNode=function(E,x){if(this.treeCache){var B=this.treeCache.get(E);if(B)return x(null,B)}var P=this;this.tree.read(32+40*E,40,function(U,F){if(U)return x(U);var G=F.slice(0,32),H=r.decode(F,32);if(!H&&f(G))return x(new Error("No node found"));var te=new u(E,P.treeCache?l(G,40):G,H);P.treeCache&&P.treeCache.set(E,te),x(null,te)})},a.prototype.putNodeBatch=function(E,x,B){B||(B=c);for(var P=export_Buffer.alloc(x.length*40),U=0;U<x.length;U++){var F=U*40,G=x[U];G&&(G.hash.copy(P,F),r.encode(G.size,P,32+F))}this.tree.write(32+40*E,P,B)},a.prototype.putNode=function(E,x,B){B||(B=c);var P=export_Buffer.allocUnsafe(40);x.hash.copy(P,0),r.encode(x.size,P,32),this.tree.write(32+40*E,P,B)},a.prototype.putBitfield=function(E,x,B){this.bitfield.write(32+E,x,B)},a.prototype.close=function(E){E||(E=c);var x=6,B=null;_(this.bitfield,P),_(this.tree,P),_(this.data,P),_(this.key,P),_(this.secretKey,P),_(this.signatures,P);function P(U){U&&(B=U),!--x&&E(B)}},a.prototype.destroy=function(E){E||(E=c);var x=6,B=null;p(this.bitfield,P),p(this.tree,P),p(this.data,P),p(this.key,P),p(this.secretKey,P),p(this.signatures,P);function P(U){U&&(B=U),!--x&&E(B)}},a.prototype.openKey=function(E,x){if(typeof E=="function")return this.openKey({},E);this.key||(this.key=this.create("key",E)),this.key.read(0,32,x)},a.prototype.open=function(E,x){if(typeof E=="function")return this.open({},E);var B=this,P=null,U=5;this.key||(this.key=this.create("key",E)),this.secretKey||(this.secretKey=this.create("secret_key",E)),this.tree||(this.tree=this.create("tree",E)),this.data||(this.data=this.create("data",E)),this.bitfield||(this.bitfield=this.create("bitfield",E)),this.signatures||(this.signatures=this.create("signatures",E));var F={bitfield:[],bitfieldPageSize:3584,secretKey:null,key:null};this.bitfield.read(0,32,function(H,te){if(H&&H.code==="ELOCKED")return x(H);te&&(F.bitfieldPageSize=te.readUInt16BE(5)),B.bitfield.write(0,h(0,F.bitfieldPageSize,null),function(J){if(J)return x(J);w(B.bitfield,32,F.bitfieldPageSize,function(le,z){z&&(F.bitfield=z),G(le)})})}),this.signatures.write(0,h(1,64,"Ed25519"),G),this.tree.write(0,h(2,40,"BLAKE2b"),G),this.secretKey.read(0,64,function(H,te){te&&(F.secretKey=te),G(null)}),this.key.read(0,32,function(H,te){te&&(F.key=te),G(null)});function G(H){H&&(P=H),!--U&&(P?x(P):x(null,F))}},a.Node=u;function c(){}function l(E,x){if(E.buffer.byteLength<=x)return E;const B=export_Buffer.alloc(E.byteLength);return E.copy(B),B}function h(E,x,B){var P=export_Buffer.alloc(32);return P[0]=5,P[1]=2,P[2]=87,P[3]=E,P[4]=0,P.writeUInt16BE(x,5),B&&(P[7]=B.length,P.write(B,8)),P}function u(E,x,B){this.index=E,this.hash=x,this.size=B}function d(E,x){for(var B=0;B<E.length;B++)if(E[B].index===x)return E[B];return null}function f(E){for(var x=0;x<E.length;x++)if(E[x])return!1;return!0}function _(E,x){E.close?E.close(x):x()}function p(E,x){E.destroy?E.destroy(x):x()}function y(E,x,B,P){E.stat(function(U,F){if(U)return P(null,[]);var G=[];H(null,null);function H(te,J){if(te)return P(te);if(J){x+=J.length;for(var le=0;le<J.length;le+=B)G.push(J.slice(le,le+B))}var z=Math.min(F.size-x,32*B);if(!z)return P(null,G);E.read(x,z,H)}})}function w(E,x,B,P){if(E.statable===!0)return y(E,x,B,P);var U=[];E.read(x,B,F);function F(G,H){if(G)return P(null,U);U.push(H),E.read(x+U.length*B,B,F)}}}}),require_uint64be2=__commonJS({"node_modules/.pnpm/uint64be@3.0.0/node_modules/uint64be/index.js"(e){init_inject_globals();var t=Math.pow(2,32);e.encodingLength=function(){return 8},e.encode=function(r,n,o){n||(n=export_Buffer.allocUnsafe(8)),o||(o=0);const s=Math.floor(r/t),a=r-s*t;return n.writeUInt32BE(s,o),n.writeUInt32BE(a,o+4),n},e.decode=function(r,n){n||(n=0);const o=r.readUInt32BE(n),s=r.readUInt32BE(n+4);return o*t+s},e.encode.bytes=8,e.decode.bytes=8}}),require_hypercore_crypto=__commonJS({"node_modules/.pnpm/hypercore-crypto@2.3.2/node_modules/hypercore-crypto/index.js"(e){init_inject_globals();var t=import$sodium_universal,r=require_uint64be2(),n=export_Buffer.from([0]),o=export_Buffer.from([1]),s=export_Buffer.from([2]),a=export_Buffer.from([3]),c=export_Buffer.from("hypercore"),l=export_Buffer.from("hypercore capability");e.writerCapability=function(u,d,f){if(!f)return null;const _=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(_,[a,l,f.tx.slice(0,32),u],f.rx.slice(0,32)),e.sign(_,d)},e.verifyRemoteWriterCapability=function(u,d,f){if(!f)return null;const _=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(_,[a,l,f.rx.slice(0,32),u],f.tx.slice(0,32)),e.verify(_,d,u)},e.capability=function(u,d){if(!d)return null;const f=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[l,d.tx.slice(0,32),u],d.rx.slice(0,32)),f},e.remoteCapability=function(u,d){if(!d)return null;const f=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[l,d.rx.slice(0,32),u],d.tx.slice(0,32)),f},e.keyPair=function(u){const d=export_Buffer.allocUnsafe(t.crypto_sign_PUBLICKEYBYTES),f=export_Buffer.allocUnsafe(t.crypto_sign_SECRETKEYBYTES);return u?t.crypto_sign_seed_keypair(d,f,u):t.crypto_sign_keypair(d,f),{publicKey:d,secretKey:f}},e.validateKeyPair=function(u){const d=export_Buffer.allocUnsafe(t.crypto_sign_PUBLICKEYBYTES);return t.crypto_sign_ed25519_sk_to_pk(d,u.secretKey),d.equals(u.publicKey)},e.sign=function(u,d){const f=export_Buffer.allocUnsafe(t.crypto_sign_BYTES);return t.crypto_sign_detached(f,u,d),f},e.verify=function(u,d,f){return t.crypto_sign_verify_detached(d,u,f)},e.data=function(u){const d=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(d,[n,h(u.length),u]),d},e.leaf=function(u){return e.data(u.data)},e.parent=function(u,d){if(u.index>d.index){const _=u;u=d,d=_}const f=export_Buffer.allocUnsafe(32);return t.crypto_generichash_batch(f,[o,h(u.size+d.size),u.hash,d.hash]),f},e.tree=function(u,d){const f=new Array(3*u.length+1);var _=0;f[_++]=s;for(var p=0;p<u.length;p++){const y=u[p];f[_++]=y.hash,f[_++]=h(y.index),f[_++]=h(y.size)}return d||(d=export_Buffer.allocUnsafe(32)),t.crypto_generichash_batch(d,f),d},e.signable=function(u,d){const f=export_Buffer.allocUnsafe(40);return export_Buffer.isBuffer(u)?u.copy(f):e.tree(u,f.slice(0,32)),r.encode(d,f.slice(32)),f},e.randomBytes=function(u){const d=export_Buffer.allocUnsafe(u);return t.randombytes_buf(d),d},e.discoveryKey=function(u){const d=export_Buffer.allocUnsafe(32);return t.crypto_generichash(d,c,u),d},t.sodium_free?e.free=function(u){u.secure&&t.sodium_free(u)}:e.free=function(){};function h(u){return r.encode(u,export_Buffer.allocUnsafe(8))}}}),require_browser=__commonJS({"node_modules/.pnpm/inspect-custom-symbol@1.1.1/node_modules/inspect-custom-symbol/browser.js"(e,t){init_inject_globals(),t.exports=Symbol.for("nodejs.util.inspect.custom")}}),require_pretty_hash=__commonJS({"node_modules/.pnpm/pretty-hash@1.0.1/node_modules/pretty-hash/index.js"(e,t){init_inject_globals(),t.exports=function(r){return export_Buffer.isBuffer(r)&&(r=r.toString("hex")),typeof r=="string"&&r.length>8?r.slice(0,6)+".."+r.slice(-2):r}}}),require_nanoguard=__commonJS({"node_modules/.pnpm/nanoguard@1.3.0/node_modules/nanoguard/index.js"(e,t){init_inject_globals(),t.exports=class{constructor(){this._tick=0,this._fns=[],this._dep=null}get waiting(){return this._tick>0}depend(n){if(this._dep!==null)throw new Error("Can only depend on one other guard currently");this._dep=n}wait(){this._tick++}continue(n,o,s){this._tick===1?process$1.nextTick(r,this):this._tick--,n&&n(o,s)}waitAndContinue(){let n=!1;return this.wait(),()=>n?!1:(n=!0,this.continue(),!0)}continueSync(n,o,s){if(!--this._tick){for(;this._fns!==null&&this._fns.length;)this._ready(this._fns.pop());n&&n(o,s)}}destroy(){const n=this._fns;if(!n)for(this._fns=null;n.length;)n.pop()()}ready(n){this._fns===null||this._tick===0?this._ready(n):this._fns.push(n)}_ready(n){this._dep===null?n():this._dep.ready(n)}};function r(n){n.continueSync()}}}),require_safe_buffer_equals=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/safe-buffer-equals.js"(e,t){init_inject_globals(),t.exports=function(r,n){return r?n?export_Buffer.compare(r,n)===0:!r:!n}}}),require_nanoassert=__commonJS({"node_modules/.pnpm/nanoassert@2.0.0/node_modules/nanoassert/index.js"(e,t){init_inject_globals(),t.exports=n;var r=class extends Error{};r.prototype.name="AssertionError";function n(o,s){if(!o){var a=new r(s);throw Error.captureStackTrace&&Error.captureStackTrace(a,n),a}}}}),require_clone=__commonJS({"node_modules/.pnpm/clone@2.1.2/node_modules/clone/clone.js"(e,t){init_inject_globals();var r=function(){function n(_,p){return p!=null&&_ instanceof p}var o;try{o=Map}catch{o=function(){}}var s;try{s=Set}catch{s=function(){}}var a;try{a=Promise}catch{a=function(){}}function c(_,p,y,w,E){typeof p=="object"&&(y=p.depth,w=p.prototype,E=p.includeNonEnumerable,p=p.circular);var x=[],B=[],P=typeof export_Buffer<"u";typeof p>"u"&&(p=!0),typeof y>"u"&&(y=1/0);function U(F,G){if(F===null)return null;if(G===0)return F;var H,te;if(typeof F!="object")return F;if(n(F,o))H=new o;else if(n(F,s))H=new s;else if(n(F,a))H=new a(function(W,re){F.then(function(ne){W(U(ne,G-1))},function(ne){re(U(ne,G-1))})});else if(c.__isArray(F))H=[];else if(c.__isRegExp(F))H=new RegExp(F.source,f(F)),F.lastIndex&&(H.lastIndex=F.lastIndex);else if(c.__isDate(F))H=new Date(F.getTime());else{if(P&&export_Buffer.isBuffer(F))return export_Buffer.allocUnsafe?H=export_Buffer.allocUnsafe(F.length):H=new export_Buffer(F.length),F.copy(H),H;n(F,Error)?H=Object.create(F):typeof w>"u"?(te=Object.getPrototypeOf(F),H=Object.create(te)):(H=Object.create(w),te=w)}if(p){var J=x.indexOf(F);if(J!=-1)return B[J];x.push(F),B.push(H)}n(F,o)&&F.forEach(function(W,re){var ne=U(re,G-1),ge=U(W,G-1);H.set(ne,ge)}),n(F,s)&&F.forEach(function(W){var re=U(W,G-1);H.add(re)});for(var le in F){var z;te&&(z=Object.getOwnPropertyDescriptor(te,le)),!(z&&z.set==null)&&(H[le]=U(F[le],G-1))}if(Object.getOwnPropertySymbols)for(var q=Object.getOwnPropertySymbols(F),le=0;le<q.length;le++){var he=q[le],V=Object.getOwnPropertyDescriptor(F,he);V&&!V.enumerable&&!E||(H[he]=U(F[he],G-1),V.enumerable||Object.defineProperty(H,he,{enumerable:!1}))}if(E)for(var _e=Object.getOwnPropertyNames(F),le=0;le<_e.length;le++){var ee=_e[le],V=Object.getOwnPropertyDescriptor(F,ee);V&&V.enumerable||(H[ee]=U(F[ee],G-1),Object.defineProperty(H,ee,{enumerable:!1}))}return H}return U(_,y)}c.clonePrototype=function(_){if(_===null)return null;var p=function(){};return p.prototype=_,new p};function l(_){return Object.prototype.toString.call(_)}c.__objToStr=l;function h(_){return typeof _=="object"&&l(_)==="[object Date]"}c.__isDate=h;function u(_){return typeof _=="object"&&l(_)==="[object Array]"}c.__isArray=u;function d(_){return typeof _=="object"&&l(_)==="[object RegExp]"}c.__isRegExp=d;function f(_){var p="";return _.global&&(p+="g"),_.ignoreCase&&(p+="i"),_.multiline&&(p+="m"),p}return c.__getRegExpFlags=f,c}();typeof t=="object"&&t.exports&&(t.exports=r)}}),require_cipher=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/cipher.js"(e,t){init_inject_globals();var{sodium_malloc:r,sodium_memzero:n}=import$sodium_universal_memory,{crypto_aead_chacha20poly1305_ietf_KEYBYTES:o,crypto_aead_chacha20poly1305_ietf_NPUBBYTES:s,crypto_aead_chacha20poly1305_ietf_ABYTES:a,crypto_aead_chacha20poly1305_ietf_encrypt:c,crypto_aead_chacha20poly1305_ietf_decrypt:l}=import$sodium_universal_crypto_aead,h=require_nanoassert(),u=32,d=8,f=16;h(o===u),h(s===4+d),h(a===f),t.exports={KEYLEN:u,NONCELEN:d,MACLEN:f,encrypt:p,decrypt:y,rekey:P};var _=r(s);function p(U,F,G,H,te){h(U.byteLength>=te.byteLength+f,"output buffer must be at least plaintext plus MACLEN bytes long"),h(F.byteLength===u),h(G.byteLength===d),h(H==null?!0:H.byteLength!=null),n(_),_.set(G,4),p.bytesWritten=c(U.subarray(0,te.byteLength+f),te,H,null,_,F),p.bytesRead=p.bytesWritten-f,n(_)}p.bytesWritten=0,p.bytesRead=0;function y(U,F,G,H,te){h(U.byteLength>=te.byteLength-f),h(F.byteLength===u),h(G.byteLength===d),h(H==null?!0:H.byteLength!=null),n(_),_.set(G,4),y.bytesWritten=l(U.subarray(0,te.byteLength-f),null,te,H,_,F),y.bytesRead=y.bytesWritten+f,n(_)}y.bytesWritten=0,y.bytesRead=0;var w=new Uint8Array(8).fill(255),E=new Uint8Array(0),x=new Uint8Array(32),B=r(u+f);n(B);function P(U,F){h(U.byteLength===u),h(F.byteLength===u),n(B),B.set(F),p(B,F,w,E,x),P.bytesWritten=p.bytesWritten,P.bytesRead=p.bytesRead,U.set(B.subarray(0,u)),n(B)}P.bytesWritten=0,P.bytesRead=0}}),require_cipher_state=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/cipher-state.js"(e,t){init_inject_globals();var{sodium_memzero:r}=import$sodium_universal_memory,{sodium_increment:n,sodium_memcmp:o,sodium_is_zero:s}=import$sodium_universal_helpers,a=require_nanoassert(),c=require_cipher(),l=c.KEYLEN+c.NONCELEN,h=c.NONCELEN,u=c.MACLEN;t.exports={STATELEN:l,NONCELEN:h,MACLEN:u,initializeKey:y,hasKey:w,setNonce:E,encryptWithAd:B,decryptWithAd:P,rekey:U};var d=0,f=c.KEYLEN,_=f,p=_+c.NONCELEN;function y(F,G){if(a(F.byteLength===l),a(G==null?!0:G.byteLength===c.KEYLEN),G==null){r(F.subarray(d,f));return}F.set(G),r(F.subarray(_,p))}function w(F){a(F.byteLength===l);var G=F.subarray(d,f);return s(G)===!1}function E(F,G){a(F.byteLength===l),a(G.byteLength===h),F.set(G,_)}var x=new Uint8Array(8).fill(255);function B(F,G,H,te){a(F.byteLength===l),a(G.byteLength!=null),a(te.byteLength!=null);var J=F.subarray(_,p);if(o(J,x))throw new Error("Nonce overflow");if(w(F)===!1){G.set(te),B.bytesRead=te.byteLength,B.bytesWritten=B.bytesRead;return}var le=F.subarray(d,f);c.encrypt(G,le,J,H,te),B.bytesRead=c.encrypt.bytesRead,B.bytesWritten=c.encrypt.bytesWritten,n(J)}B.bytesRead=0,B.bytesWritten=0;function P(F,G,H,te){a(F.byteLength===l),a(G.byteLength!=null),a(te.byteLength!=null);var J=F.subarray(_,p);if(o(J,x))throw new Error("Nonce overflow");if(w(F)===!1){G.set(te),P.bytesRead=te.byteLength,P.bytesWritten=P.bytesRead;return}var le=F.subarray(d,f);c.decrypt(G,le,J,H,te),P.bytesRead=c.decrypt.bytesRead,P.bytesWritten=c.decrypt.bytesWritten,n(J)}P.bytesRead=0,P.bytesWritten=0;function U(F){a(F.byteLength===l);var G=F.subarray(d,f);c.rekey(G,G),U.bytesRead=c.rekey.bytesRead,U.bytesWritten=c.rekey.bytesWritten}U.bytesRead=0,U.bytesWritten=0}}),require_nanoassert2=__commonJS({"node_modules/.pnpm/nanoassert@1.1.0/node_modules/nanoassert/index.js"(e,t){init_inject_globals(),s.notEqual=n,s.notOk=o,s.equal=r,s.ok=s,t.exports=s;function r(a,c,l){s(a==c,l)}function n(a,c,l){s(a!=c,l)}function o(a,c){s(!a,c)}function s(a,c){if(!a)throw new Error(c||"AssertionError")}}}),require_hmac_blake2b=__commonJS({"node_modules/.pnpm/hmac-blake2b@2.0.0/node_modules/hmac-blake2b/index.js"(e,t){init_inject_globals();var{sodium_malloc:r,sodium_memzero:n}=import$sodium_universal_memory,{crypto_generichash:o,crypto_generichash_batch:s}=import$sodium_universal_crypto_generichash,a=require_nanoassert2(),c=64,l=128,h=r(l*3),u=h.subarray(l*0,l*1),d=h.subarray(l*1,l*2),f=h.subarray(l*2,l*3);t.exports=function(_,p,y){a(_.byteLength===c),a(y.byteLength!=null),a(Array.isArray(p)?p.every(E=>E.byteLength!=null):p.byteLength!=null),y.byteLength>l?(o(u.subarray(0,c),y),n(u.subarray(c))):(u.set(y),n(u.subarray(y.byteLength)));for(var w=0;w<u.byteLength;w++)d[w]=92^u[w],f[w]=54^u[w];n(u),s(_,[f].concat(p)),n(f),s(_,[d].concat(_)),n(d)},t.exports.BYTES=c,t.exports.KEYBYTES=l}}),require_dh=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/dh.js"(e,t){init_inject_globals();var{crypto_kx_SEEDBYTES:r,crypto_kx_keypair:n,crypto_kx_seed_keypair:o}=import$sodium_universal_crypto_kx,{crypto_scalarmult_BYTES:s,crypto_scalarmult_SCALARBYTES:a,crypto_scalarmult:c}=import$sodium_universal_crypto_scalarmult,l=require_nanoassert(),h=s,u=s,d=a,f=r;t.exports={DHLEN:h,PKLEN:u,SKLEN:d,SEEDLEN:f,generateKeypair:_,generateSeedKeypair:p,dh:y};function _(w,E){l(w.byteLength===u),l(E.byteLength===d),n(w,E)}function p(w,E,x){l(w.byteLength===u),l(E.byteLength===d),l(x.byteLength===d),o(w,E,x)}function y(w,E,x){l(w.byteLength===h),l(E.byteLength===d),l(x.byteLength===u),c(w,E,x)}}}),require_hash=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/hash.js"(e,t){init_inject_globals();var{sodium_malloc:r,sodium_memzero:n}=import$sodium_universal_memory,{crypto_generichash_batch:o}=import$sodium_universal_crypto_generichash,s=require_nanoassert(),a=require_hmac_blake2b(),c=require_dh(),l=64,h=128;s(a.KEYBYTES===h,"mismatching hmac BLOCKLEN"),s(a.BYTES===l,"mismatching hmac HASHLEN"),t.exports={HASHLEN:l,BLOCKLEN:h,hash:u,hkdf:w};function u(E,x){s(E.byteLength===l),s(Array.isArray(x)),o(E,x)}function d(E,x,B){return a(E,B,x)}var f=r(l),_=new Uint8Array([1]),p=new Uint8Array([2]),y=new Uint8Array([3]);function w(E,x,B,P,U){s(E.byteLength===l),s(x.byteLength===l),s(B==null?!0:B.byteLength===l),s(P.byteLength===l),s([0,32,c.DHLEN,c.PKLEN].includes(U.byteLength)),n(f),d(f,P,[U]),d(E,f,[_]),d(x,f,[E,p]),B!=null&&d(B,f,[x,y]),n(f)}}}),require_symmetric_state=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/symmetric-state.js"(e,t){init_inject_globals();var{sodium_malloc:r,sodium_memzero:n}=import$sodium_universal_memory,o=require_nanoassert(),s=require_cipher_state(),a=require_hash(),c=a.HASHLEN+a.HASHLEN+s.STATELEN,l=a.HASHLEN;t.exports={STATELEN:c,initializeSymmetric:y,mixKey:E,mixHash:x,mixKeyAndHash:P,getHandshakeHash:U,encryptAndHash:F,decryptAndHash:G,split:le,_hasKey:z};var h=0,u=a.HASHLEN,d=u,f=d+a.HASHLEN,_=f,p=_+s.STATELEN;function y(q,he){o(q.byteLength===c),o(he.byteLength!=null),n(q),he.byteLength<=l?q.set(he,d):a.hash(q.subarray(d,f),[he]),q.subarray(h,u).set(q.subarray(d,f)),s.initializeKey(q.subarray(_,p),null)}var w=r(l);function E(q,he){o(q.byteLength===c),o(he.byteLength!=null),a.hkdf(q.subarray(h,u),w,null,q.subarray(h,u),he),s.initializeKey(q.subarray(_,p),w.subarray(0,32)),n(w)}function x(q,he){o(q.byteLength===c);var V=q.subarray(d,f);a.hash(V,[V,he])}var B=r(l);function P(q,he){o(q.byteLength===c),o(he.byteLength!=null),a.hkdf(q.subarray(h,u),B,w,q.subarray(h,u),he),x(q,B),n(B),s.initializeKey(q.subarray(_,p),w.subarray(0,32)),n(w)}function U(q,he){o(q.byteLength===c),o(he.byteLength===l),he.set(q.subarray(d,f))}function F(q,he,V){o(q.byteLength===c),o(he.byteLength!=null),o(V.byteLength!=null);var _e=q.subarray(_,p),ee=q.subarray(d,f);s.encryptWithAd(_e,he,ee,V),F.bytesRead=s.encryptWithAd.bytesRead,F.bytesWritten=s.encryptWithAd.bytesWritten,x(q,he.subarray(0,F.bytesWritten))}F.bytesRead=0,F.bytesWritten=0;function G(q,he,V){o(q.byteLength===c),o(he.byteLength!=null),o(V.byteLength!=null);var _e=q.subarray(_,p),ee=q.subarray(d,f);s.decryptWithAd(_e,he,ee,V),G.bytesRead=s.decryptWithAd.bytesRead,G.bytesWritten=s.decryptWithAd.bytesWritten,x(q,V.subarray(0,G.bytesRead))}G.bytesRead=0,G.bytesWritten=0;var H=r(l),te=r(l),J=new Uint8Array(0);function le(q,he,V){o(q.byteLength===c),o(he.byteLength===s.STATELEN),o(V.byteLength===s.STATELEN),a.hkdf(H,te,null,q.subarray(h,u),J),s.initializeKey(he,H.subarray(0,32)),s.initializeKey(V,te.subarray(0,32)),n(H),n(te)}function z(q){return s.hasKey(q.subarray(_,p))}}}),require_handshake_state=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/handshake-state.js"(e,t){init_inject_globals();var{sodium_malloc:r,sodium_memzero:n,sodium_free:o}=import$sodium_universal_memory,s=require_nanoassert(),a=require_clone(),c=require_symmetric_state(),l=require_cipher_state(),h=require_dh(),u=h.PKLEN,d=h.SKLEN;t.exports=Object.freeze({initialize:G,writeMessage:te,readMessage:J,destroy:le,keygen:z,seedKeygen:q,SKLEN:d,PKLEN:u});function f(){this.symmetricState=r(c.STATELEN),this.initiator=null,this.spk=null,this.ssk=null,this.epk=null,this.esk=null,this.rs=null,this.re=null,this.messagePatterns=null}var _=Symbol("initiator"),p=Symbol("responder"),y=Symbol("s"),w=Symbol("e"),E=Symbol("es"),x=Symbol("se"),B=Symbol("ee"),P=Symbol("es"),U=Object.freeze({N:{premessages:[[p,y]],messagePatterns:[[_,w,E]]},K:{premessages:[[_,y],[p,y]],messagePatterns:[[_,w,E,P]]},X:{premessages:[[p,y]],messagePatterns:[[_,w,E,y,P]]},NN:{premessages:[],messagePatterns:[[_,w],[p,w,B]]},KN:{premessages:[[_,y]],messagePatterns:[[_,w],[p,w,B,x]]},NK:{premessages:[[p,y]],messagePatterns:[[_,w,E],[p,w,B]]},KK:{premessages:[[_,y],[p,y]],messagePatterns:[[_,w,E,P],[p,w,B,x]]},NX:{premessages:[],messagePatterns:[[_,w],[p,w,B,y,E]]},KX:{premessages:[[_,y]],messagePatterns:[[_,w],[p,w,B,x,y,E]]},XN:{premessages:[],messagePatterns:[[_,w],[p,w,B],[_,y,x]]},IN:{premessages:[],messagePatterns:[[_,w,y],[p,w,B,x]]},XK:{premessages:[[p,y]],messagePatterns:[[_,w,E],[p,w,B],[_,y,x]]},IK:{premessages:[[p,y]],messagePatterns:[[_,w,E,y,P],[p,w,B,x]]},XX:{premessages:[],messagePatterns:[[_,w],[p,w,B,y,E],[_,y,x]]},IX:{premessages:[],messagePatterns:[[_,w,y],[p,w,B,x,y,E]]}});function F(V){var _e=r(V.byteLength);return _e.set(V),_e}function G(V,_e,ee,W,re,ne,ge){s(Object.keys(U).includes(V),"Unsupported handshake pattern"),s(typeof _e=="boolean","Initiator must be a boolean"),s(ee.byteLength!=null,"prolouge must be a Buffer"),s(re==null?!0:re.publicKey.byteLength===h.PKLEN,`e.publicKey must be ${h.PKLEN} bytes`),s(re==null?!0:re.secretKey.byteLength===h.SKLEN,`e.secretKey must be ${h.SKLEN} bytes`),s(ne==null?!0:ne.byteLength===h.PKLEN,`rs must be ${h.PKLEN} bytes`),s(ge==null?!0:ge.byteLength===h.PKLEN,`re must be ${h.PKLEN} bytes`);var de=new f,ye=Uint8Array.from(`Noise_${V}_25519_ChaChaPoly_BLAKE2b`,he);c.initializeSymmetric(de.symmetricState,ye),c.mixHash(de.symmetricState,ee),de.role=_e===!0?_:p,W!=null&&(s(W.publicKey.byteLength===h.PKLEN,`s.publicKey must be ${h.PKLEN} bytes`),s(W.secretKey.byteLength===h.SKLEN,`s.secretKey must be ${h.SKLEN} bytes`),de.spk=F(W.publicKey),de.ssk=F(W.secretKey)),re!=null&&(s(re.publicKey.byteLength===h.PKLEN),s(re.secretKey.byteLength===h.SKLEN),de.epk=F(re.publicKey),de.esk=F(re.secretKey)),ne!=null&&(s(ne.byteLength===h.PKLEN),de.rs=F(ne)),ge!=null&&(s(ge.byteLength===h.PKLEN),de.re=F(ge));var Ce=U[V];for(var ke of a(Ce.premessages)){var ae=ke.shift();for(var Q of ke)switch(Q){case w:s(de.role===ae?de.epk.byteLength!=null:de.re.byteLength!=null),c.mixHash(de.symmetricState,de.role===ae?de.epk:de.re);break;case y:s(de.role===ae?de.spk.byteLength!=null:de.rs.byteLength!=null),c.mixHash(de.symmetricState,de.role===ae?de.spk:de.rs);break;default:throw new Error("Invalid premessage pattern")}}return de.messagePatterns=a(Ce.messagePatterns),s(de.messagePatterns.filter(C=>C[0]===_).some(C=>C.includes(y))?de.spk!==null&&de.ssk!==null:!0,"This handshake pattern requires a static keypair"),de}var H=r(h.DHLEN);function te(V,_e,ee){s(V instanceof f),s(_e.byteLength!=null),s(ee.byteLength!=null);var W=V.messagePatterns.shift(),re=0;s(W!=null),s(V.role===W.shift());for(var ne of W)switch(ne){case w:s(V.epk==null),s(V.esk==null),V.epk=r(h.PKLEN),V.esk=r(h.SKLEN),h.generateKeypair(V.epk,V.esk),ee.set(V.epk,re),re+=V.epk.byteLength,c.mixHash(V.symmetricState,V.epk);break;case y:s(V.spk.byteLength===h.PKLEN),c.encryptAndHash(V.symmetricState,ee.subarray(re),V.spk),re+=c.encryptAndHash.bytesWritten;break;case B:h.dh(H,V.esk,V.re),c.mixKey(V.symmetricState,H),n(H);break;case E:V.role===_?h.dh(H,V.esk,V.rs):h.dh(H,V.ssk,V.re),c.mixKey(V.symmetricState,H),n(H);break;case x:V.role===_?h.dh(H,V.ssk,V.re):h.dh(H,V.esk,V.rs),c.mixKey(V.symmetricState,H),n(H);break;case P:h.dh(H,V.ssk,V.rs),c.mixKey(V.symmetricState,H),n(H);break;default:throw new Error("Invalid message pattern")}if(c.encryptAndHash(V.symmetricState,ee.subarray(re),_e),re+=c.encryptAndHash.bytesWritten,te.bytes=re,V.messagePatterns.length===0){var ge=r(l.STATELEN),de=r(l.STATELEN);return c.split(V.symmetricState,ge,de),{tx:ge,rx:de}}}te.bytes=0;function J(V,_e,ee){s(V instanceof f),s(_e.byteLength!=null),s(ee.byteLength!=null);var W=V.messagePatterns.shift(),re=0;s(W!=null),s(W.shift()!==V.role);for(var ne of W)switch(ne){case w:s(V.re==null),s(_e.byteLength-re>=h.PKLEN),V.re=r(h.PKLEN),V.re.set(_e.subarray(re,re+h.PKLEN)),re+=h.PKLEN,c.mixHash(V.symmetricState,V.re);break;case y:s(V.rs==null),V.rs=r(h.PKLEN);var ge=0;c._hasKey(V.symmetricState)?ge=h.PKLEN+16:ge=h.PKLEN,s(_e.byteLength-re>=ge),c.decryptAndHash(V.symmetricState,V.rs,_e.subarray(re,re+ge)),re+=c.decryptAndHash.bytesRead;break;case B:h.dh(H,V.esk,V.re),c.mixKey(V.symmetricState,H),n(H);break;case E:V.role===_?h.dh(H,V.esk,V.rs):h.dh(H,V.ssk,V.re),c.mixKey(V.symmetricState,H),n(H);break;case x:V.role===_?h.dh(H,V.ssk,V.re):h.dh(H,V.esk,V.rs),c.mixKey(V.symmetricState,H),n(H);break;case P:h.dh(H,V.ssk,V.rs),c.mixKey(V.symmetricState,H),n(H);break;default:throw new Error("Invalid message pattern")}if(c.decryptAndHash(V.symmetricState,ee,_e.subarray(re)),J.bytes=c.decryptAndHash.bytesWritten,V.messagePatterns.length===0){var de=r(l.STATELEN),ye=r(l.STATELEN);return c.split(V.symmetricState,ye,de),{tx:de,rx:ye}}}J.bytes=0;function le(V){V.symmetricState!=null&&(o(V.symmetricState),V.symmetricState=null),V.role=null,V.spk!=null&&(o(V.spk),V.spk=null),V.ssk!=null&&(o(V.ssk),V.ssk=null),V.epk!=null&&(o(V.epk),V.epk=null),V.esk!=null&&(o(V.esk),V.esk=null),V.rs!=null&&(o(V.rs),V.rs=null),V.re!=null&&(o(V.re),V.re=null),V.messagePatterns=null}function z(V,_e){if(!V)return V={publicKey:r(u),secretKey:r(d)},z(V);if(V.publicKey)return h.generateKeypair(V.publicKey,V.secretKey),V;V.byteLength!=null&&h.generateKeypair(null,V)}function q(V){var _e={publicKey:r(u),secretKey:r(d)};return h.generateSeedKeypair(_e.publicKey,_e.secretKey,V),_e}function he(V){return V.charCodeAt(0)}}}),require_noise_protocol=__commonJS({"node_modules/.pnpm/noise-protocol@3.0.1/node_modules/noise-protocol/index.js"(e,t){init_inject_globals(),t.exports=require_handshake_state()}}),require_simple_handshake=__commonJS({"node_modules/.pnpm/simple-handshake@3.0.0/node_modules/simple-handshake/index.js"(e,t){init_inject_globals();var r=require_noise_protocol(),n=require_symmetric_state(),o=require_hash(),s=require_nanoassert(),a=export_Buffer.alloc(0);function c(l,h){if(!(this instanceof c))return new c(l,h);h=h||{};var u=h.pattern||"NN",d=h.prolouge||a;this.handshakeHash=null,this.onstatickey=h.onstatickey||function(f,_){_()},this.onephemeralkey=h.onephemeralkey||function(f,_){_()},this.onhandshake=h.onhandshake||function(f,_){_()},this.state=r.initialize(u,l,d,h.staticKeyPair,h.ephemeralKeyPair,h.remoteStaticKey,h.remoteEphemeralKey),this.waiting=l===!1,this.finished=!1,this.split=null,this._tx=export_Buffer.alloc(65535),this._rx=export_Buffer.alloc(65535)}c.prototype.recv=function(l,h){var u=this;s(u.finished===!1,"Should not call recv if finished"),s(l!=null,"must have data"),s(l.byteLength<=u._rx.byteLength,"too much data received"),s(u.waiting===!0,"Wrong state, not ready to receive data"),s(u.split==null,"split should be null");var d=u.state.re!=null,f=u.state.rs!=null;try{u.split=r.readMessage(u.state,l,u._rx)}catch(E){return u._finish(E,null,h)}u.waiting=!1;var _=u.state.re!=null,p=u.state.rs!=null;if(d===!1&&_===!0)return u.onephemeralkey(u.state.re,y);return y();function y(E){return E?w(E):f===!1&&p===!0?u.onstatickey(u.state.rs,w):w()}function w(E){if(E)return u._finish(E,null,h);var x=u._rx.subarray(0,r.readMessage.bytes);if(u.split)return u._finish(null,x,h);h(null,x)}},c.prototype.send=function(l,h){s(this.finished===!1,"Should not call send if finished"),s(this.waiting===!1,"Wrong state, not ready to send data"),s(this.split==null,"split should be null"),l=l||a;try{this.split=r.writeMessage(this.state,l,this._tx)}catch(d){return this._finish(d,null,h)}this.waiting=!0;var u=this._tx.subarray(0,r.writeMessage.bytes);return this.split!=null?this._finish(null,u,h):h(null,u)},c.prototype.destroy=function(){this._finish(null,null,function(){})},c.prototype._finish=function(l,h,u){s(this.finished===!1,"Already finished");const d=this;if(d.finished=!0,d.waiting=!1,d.split&&(d.handshakeHash=export_Buffer.alloc(o.HASHLEN),n.getHandshakeHash(d.state.symmetricState,d.handshakeHash)),l)return f(l);d.onhandshake(d.state,f);function f(_){r.destroy(d.state),u(_,h,d.split),d._rx.fill(0),d._tx.fill(0)}},c.keygen=r.keygen,c.seedKeygen=r.seedKeygen,t.exports=c}}),require_encode2=__commonJS({"node_modules/.pnpm/varint@5.0.2/node_modules/varint/encode.js"(e,t){init_inject_globals(),t.exports=a;var r=128,n=127,o=~n,s=Math.pow(2,31);function a(c,l,h){l=l||[],h=h||0;for(var u=h;c>=s;)l[h++]=c&255|r,c/=128;for(;c&o;)l[h++]=c&255|r,c>>>=7;return l[h]=c|0,a.bytes=h-u+1,l}}}),require_decode2=__commonJS({"node_modules/.pnpm/varint@5.0.2/node_modules/varint/decode.js"(e,t){init_inject_globals(),t.exports=o;var r=128,n=127;function o(s,l){var c=0,l=l||0,h=0,u=l,d,f=s.length;do{if(u>=f)throw o.bytes=0,new RangeError("Could not decode varint");d=s[u++],c+=h<28?(d&n)<<h:(d&n)*Math.pow(2,h),h+=7}while(d>=r);return o.bytes=u-l,c}}}),require_length2=__commonJS({"node_modules/.pnpm/varint@5.0.2/node_modules/varint/length.js"(e,t){init_inject_globals();var r=Math.pow(2,7),n=Math.pow(2,14),o=Math.pow(2,21),s=Math.pow(2,28),a=Math.pow(2,35),c=Math.pow(2,42),l=Math.pow(2,49),h=Math.pow(2,56),u=Math.pow(2,63);t.exports=function(d){return d<r?1:d<n?2:d<o?3:d<s?4:d<a?5:d<c?6:d<l?7:d<h?8:d<u?9:10}}}),require_varint2=__commonJS({"node_modules/.pnpm/varint@5.0.2/node_modules/varint/index.js"(e,t){init_inject_globals(),t.exports={encode:require_encode2(),decode:require_decode2(),encodingLength:require_length2()}}}),require_handshake=__commonJS({"node_modules/.pnpm/simple-hypercore-protocol@2.1.2/node_modules/simple-hypercore-protocol/lib/handshake.js"(e,t){init_inject_globals();var r=require_simple_handshake(),n=require_dh(),o=require_hypercore_crypto(),s=require_varint2();t.exports=class Ws{constructor(f,_,p,y){this.options=p,this.ondone=y,this.buffer=null,this.length=0,this.remotePayload=null,this.payload=_,this.keyPair=p.keyPair||Ws.keyPair(),this.remotePublicKey=null,this.onrecv=h.bind(this),this.onsend=l.bind(this),this.destroyed=!1,this.noise=r(f,{pattern:"XX",onhandshake:E,staticKeyPair:this.keyPair,onstatickey:u.bind(this)});const w=this;this.noise.waiting===!1&&process$1.nextTick(c,this);function E(x,B){process$1.nextTick(a,w),B(null)}}recv(f){if(!this.destroyed)for(this.buffer?this.buffer=export_Buffer.concat([this.buffer,f]):this.buffer=f;!this.destroyed&&!this.noise.finished;){if(!this.buffer||this.buffer.length<3)return;if(this.length){if(this.buffer.length<this.length)return;const _=this.buffer.slice(0,this.length);this.buffer=this.length<this.buffer.length?this.buffer.slice(this.length):null,this.length=0,this.noise.recv(_,this.onrecv)}else this.length=s.decode(this.buffer,0),this.buffer=this.buffer.slice(s.decode.bytes)}}destroy(f){this.destroyed||(this.destroyed=!0,this.noise.finished||this.noise.destroy(),this.ondone(f))}static keyPair(f){const _={publicKey:export_Buffer.alloc(n.PKLEN),secretKey:export_Buffer.alloc(n.SKLEN)};return f?n.generateSeedKeypair(_.publicKey,_.secretKey,f):n.generateKeypair(_.publicKey,_.secretKey),_}};function a(d){if(d.destroyed)return;d.destroyed=!0;const f={rx:export_Buffer.from(d.noise.split.rx),tx:export_Buffer.from(d.noise.split.tx)};o.free(d.noise.split.rx),o.free(d.noise.split.tx),d.ondone(null,d.remotePayload,f,d.buffer,d.remotePublicKey,d.noise.handshakeHash)}function c(d){d.destroyed||d.noise.send(d.payload,d.onsend)}function l(d,f){if(d)return this.destroy(d);const _=export_Buffer.allocUnsafe(s.encodingLength(f.length)+f.length);s.encode(f.length,_,0),f.copy(_,s.encode.bytes),this.options.send(_)}function h(d,f){if(d)return this.destroy(d);f&&f.length&&(this.remotePayload=export_Buffer.from(f)),!(this.destroyed||this.noise.finished)&&this.noise.waiting===!1&&this.noise.send(this.payload,this.onsend)}function u(d,f){this.remotePublicKey=export_Buffer.from(d),this.options.onauthenticate?this.options.onauthenticate(this.remotePublicKey,f):f(null)}}}),require_encode3=__commonJS({"node_modules/.pnpm/varint@5.0.0/node_modules/varint/encode.js"(e,t){init_inject_globals(),t.exports=a;var r=128,n=127,o=~n,s=Math.pow(2,31);function a(c,l,h){l=l||[],h=h||0;for(var u=h;c>=s;)l[h++]=c&255|r,c/=128;for(;c&o;)l[h++]=c&255|r,c>>>=7;return l[h]=c|0,a.bytes=h-u+1,l}}}),require_decode3=__commonJS({"node_modules/.pnpm/varint@5.0.0/node_modules/varint/decode.js"(e,t){init_inject_globals(),t.exports=o;var r=128,n=127;function o(s,l){var c=0,l=l||0,h=0,u=l,d,f=s.length;do{if(u>=f)throw o.bytes=0,new RangeError("Could not decode varint");d=s[u++],c+=h<28?(d&n)<<h:(d&n)*Math.pow(2,h),h+=7}while(d>=r);return o.bytes=u-l,c}}}),require_length3=__commonJS({"node_modules/.pnpm/varint@5.0.0/node_modules/varint/length.js"(e,t){init_inject_globals();var r=Math.pow(2,7),n=Math.pow(2,14),o=Math.pow(2,21),s=Math.pow(2,28),a=Math.pow(2,35),c=Math.pow(2,42),l=Math.pow(2,49),h=Math.pow(2,56),u=Math.pow(2,63);t.exports=function(d){return d<r?1:d<n?2:d<o?3:d<s?4:d<a?5:d<c?6:d<l?7:d<h?8:d<u?9:10}}}),require_varint3=__commonJS({"node_modules/.pnpm/varint@5.0.0/node_modules/varint/index.js"(e,t){init_inject_globals(),t.exports={encode:require_encode3(),decode:require_decode3(),encodingLength:require_length3()}}}),require_signed_varint=__commonJS({"node_modules/.pnpm/signed-varint@2.0.1/node_modules/signed-varint/index.js"(e){init_inject_globals();var t=require_varint2();e.encode=function r(n,o,s){n=n>=0?n*2:n*-2-1;var a=t.encode(n,o,s);return r.bytes=t.encode.bytes,a},e.decode=function r(n,o){var s=t.decode(n,o);return r.bytes=t.decode.bytes,s&1?(s+1)/-2:s/2},e.encodingLength=function(r){return t.encodingLength(r>=0?r*2:r*-2-1)}}}),require_ascii=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/lib/ascii.js"(e,t){init_inject_globals();function r(s){return s.length}function n(s){const a=s.byteLength;let c="";for(let l=0;l<a;l++)c+=String.fromCharCode(s[l]);return c}function o(s,a,c=0,l=r(a)){const h=Math.min(l,s.byteLength-c);for(let u=0;u<h;u++)s[c+u]=a.charCodeAt(u);return h}t.exports={byteLength:r,toString:n,write:o}}}),require_base64=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/lib/base64.js"(e,t){init_inject_globals();var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256);for(let c=0;c<r.length;c++)n[r.charCodeAt(c)]=c;n[45]=62,n[95]=63;function o(c){let l=c.length;return c.charCodeAt(l-1)===61&&l--,l>1&&c.charCodeAt(l-1)===61&&l--,l*3>>>2}function s(c){const l=c.byteLength;let h="";for(let u=0;u<l;u+=3)h+=r[c[u]>>2]+r[(c[u]&3)<<4|c[u+1]>>4]+r[(c[u+1]&15)<<2|c[u+2]>>6]+r[c[u+2]&63];return l%3===2?h=h.substring(0,h.length-1)+"=":l%3===1&&(h=h.substring(0,h.length-2)+"=="),h}function a(c,l,h=0,u=o(l)){const d=Math.min(u,c.byteLength-h);for(let f=0,_=0;f<d;f+=4){const p=n[l.charCodeAt(f)],y=n[l.charCodeAt(f+1)],w=n[l.charCodeAt(f+2)],E=n[l.charCodeAt(f+3)];c[_++]=p<<2|y>>4,c[_++]=(y&15)<<4|w>>2,c[_++]=(w&3)<<6|E&63}return d}t.exports={byteLength:o,toString:s,write:a}}}),require_hex=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/lib/hex.js"(e,t){init_inject_globals();function r(a){return a.length>>>1}function n(a){const c=a.byteLength;a=new DataView(a.buffer,a.byteOffset,c);let l="",h=0;for(let u=c-c%4;h<u;h+=4)l+=a.getUint32(h).toString(16).padStart(8,"0");for(;h<c;h++)l+=a.getUint8(h).toString(16).padStart(2,"0");return l}function o(a,c,l=0,h=r(c)){const u=Math.min(h,a.byteLength-l);for(let d=0;d<u;d++){const f=s(c.charCodeAt(d*2)),_=s(c.charCodeAt(d*2+1));if(f===void 0||_===void 0)return a.subarray(0,d);a[l+d]=f<<4|_}return u}t.exports={byteLength:r,toString:n,write:o};function s(a){if(a>=48&&a<=57)return a-48;if(a>=65&&a<=70)return a-65+10;if(a>=97&&a<=102)return a-97+10}}}),require_utf8=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/lib/utf8.js"(e,t){init_inject_globals();function r(s){let a=0;for(let c=0,l=s.length;c<l;c++){const h=s.charCodeAt(c);if(h>=55296&&h<=56319&&c+1<l){const u=s.charCodeAt(c+1);if(u>=56320&&u<=57343){a+=4,c++;continue}}h<=127?a+=1:h<=2047?a+=2:a+=3}return a}var n;if(typeof TextDecoder<"u"){const s=new TextDecoder;n=function(a){return s.decode(a)}}else n=function(s){const a=s.byteLength;let c="",l=0;for(;l<a;){let h=s[l];if(h<=127){c+=String.fromCharCode(h),l++;continue}let u=0,d=0;if(h<=223?(u=1,d=h&31):h<=239?(u=2,d=h&15):h<=244&&(u=3,d=h&7),a-l-u>0){let f=0;for(;f<u;)h=s[l+f+1],d=d<<6|h&63,f+=1}else d=65533,u=a-l;c+=String.fromCodePoint(d),l+=u+1}return c};var o;if(typeof TextEncoder<"u"){const s=new TextEncoder;o=function(a,c,l=0,h=r(c)){const u=Math.min(h,a.byteLength-l);return s.encodeInto(c,a.subarray(l,l+u)),u}}else o=function(s,a,c=0,l=r(a)){const h=Math.min(l,s.byteLength-c);s=s.subarray(c,c+h);let u=0,d=0;for(;u<a.length;){const f=a.codePointAt(u);if(f<=127){s[d++]=f,u++;continue}let _=0,p=0;for(f<=2047?(_=6,p=192):f<=65535?(_=12,p=224):f<=2097151&&(_=18,p=240),s[d++]=p|f>>_,_-=6;_>=0;)s[d++]=128|f>>_&63,_-=6;u+=f>=65536?2:1}return h};t.exports={byteLength:r,toString:n,write:o}}}),require_utf16le=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/lib/utf16le.js"(e,t){init_inject_globals();function r(s){return s.length*2}function n(s){const a=s.byteLength;let c="";for(let l=0;l<a-1;l+=2)c+=String.fromCharCode(s[l]+s[l+1]*256);return c}function o(s,a,c=0,l=r(a)){const h=Math.min(l,s.byteLength-c);let u=h;for(let d=0;d<a.length&&!((u-=2)<0);++d){const f=a.charCodeAt(d),_=f>>8,p=f%256;s[c+d*2]=p,s[c+d*2+1]=_}return h}t.exports={byteLength:r,toString:n,write:o}}}),require_browser2=__commonJS({"node_modules/.pnpm/b4a@1.6.0/node_modules/b4a/browser.js"(e,t){init_inject_globals();var r=require_ascii(),n=require_base64(),o=require_hex(),s=require_utf8(),a=require_utf16le(),c=new Uint8Array(Uint16Array.of(255).buffer)[0]===255;function l(C){switch(C){case"ascii":return r;case"base64":return n;case"hex":return o;case"utf8":case"utf-8":case void 0:return s;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a;default:throw new Error(`Unknown encoding: ${C}`)}}function h(C){return C instanceof Uint8Array}function u(C){try{return l(C),!0}catch{return!1}}function d(C,$,j){const O=new Uint8Array(C);return $!==void 0&&$(O,$,0,O.byteLength,j),O}function f(C){return new Uint8Array(C)}function _(C){return new Uint8Array(C)}function p(C,$){return l($).byteLength(C)}function y(C,$){if(C===$)return 0;const j=Math.min(C.byteLength,$.byteLength);C=new DataView(C.buffer,C.byteOffset,C.byteLength),$=new DataView($.buffer,$.byteOffset,$.byteLength);let O=0;for(let k=j-j%4;O<k;O+=4){const ue=C.getUint32(O,c),pe=$.getUint32(O,c);if(ue!==pe)break}for(;O<j;O++){const k=C.getUint8(O),ue=$.getUint8(O);if(k<ue)return-1;if(k>ue)return 1}return C.byteLength>$.byteLength?1:C.byteLength<$.byteLength?-1:0}function w(C,$){$===void 0&&($=C.reduce((O,k)=>O+k.byteLength,0));const j=new Uint8Array($);return C.reduce((O,k)=>(j.set(k,O),O+k.byteLength),0),j}function E(C,$,j=0,O=0,k=C.byteLength){if(k>0&&k<O||k===O||C.byteLength===0||$.byteLength===0)return 0;if(j<0)throw new RangeError("targetStart is out of range");if(O<0||O>=C.byteLength)throw new RangeError("sourceStart is out of range");if(k<0)throw new RangeError("sourceEnd is out of range");j>=$.byteLength&&(j=$.byteLength),k>C.byteLength&&(k=C.byteLength),$.byteLength-j<k-O&&(k=$.length-j+O);const ue=k-O;return C===$?$.copyWithin(j,O,k):$.set(C.subarray(O,k),j),ue}function x(C,$){if(C===$)return!0;if(C.byteLength!==$.byteLength)return!1;const j=C.byteLength;C=new DataView(C.buffer,C.byteOffset,C.byteLength),$=new DataView($.buffer,$.byteOffset,$.byteLength);let O=0;for(let k=j-j%4;O<k;O+=4)if(C.getUint32(O,c)!==$.getUint32(O,c))return!1;for(;O<j;O++)if(C.getUint8(O)!==$.getUint8(O))return!1;return!0}function B(C,$,j,O,k){if(typeof $=="string"?typeof j=="string"?(k=j,j=0,O=C.byteLength):typeof O=="string"&&(k=O,O=C.byteLength):typeof val=="number"?$=$&255:typeof val=="boolean"&&($=+$),j<0||C.byteLength<j||C.byteLength<O)throw new RangeError("Out of range index");if(j===void 0&&(j=0),O===void 0&&(O=C.byteLength),O<=j)return C;if($||($=0),typeof $=="number")for(let ue=j;ue<O;++ue)C[ue]=$;else{$=h($)?$:P($,k);const ue=$.byteLength;for(let pe=0;pe<O-j;++pe)C[pe+j]=$[pe%ue]}return C}function P(C,$,j){return typeof C=="string"?U(C,$):Array.isArray(C)?F(C):ArrayBuffer.isView(C)?G(C):H(C,$,j)}function U(C,$){const j=l($),O=new Uint8Array(j.byteLength(C));return j.write(O,C,0,O.byteLength),O}function F(C){const $=new Uint8Array(C.length);return $.set(C),$}function G(C){const $=new Uint8Array(C.byteLength);return $.set(C),$}function H(C,$,j){return new Uint8Array(C,$,j)}function te(C,$,j,O){return le(C,$,j,O)!==-1}function J(C,$,j,O,k){if(C.byteLength===0)return-1;if(typeof j=="string"?(O=j,j=0):j===void 0?j=k?0:C.length-1:j<0&&(j+=C.byteLength),j>=C.byteLength){if(k)return-1;j=C.byteLength-1}else if(j<0)if(k)j=0;else return-1;if(typeof $=="string")$=P($,O);else if(typeof $=="number")return $=$&255,k?C.indexOf($,j):C.lastIndexOf($,j);if($.byteLength===0)return-1;if(k){let ue=-1;for(let pe=j;pe<C.byteLength;pe++)if(C[pe]===$[ue===-1?0:pe-ue]){if(ue===-1&&(ue=pe),pe-ue+1===$.byteLength)return ue}else ue!==-1&&(pe-=pe-ue),ue=-1}else{j+$.byteLength>C.byteLength&&(j=C.byteLength-$.byteLength);for(let ue=j;ue>=0;ue--){let pe=!0;for(let Oe=0;Oe<$.byteLength;Oe++)if(C[ue+Oe]!==$[Oe]){pe=!1;break}if(pe)return ue}}return-1}function le(C,$,j,O){return J(C,$,j,O,!0)}function z(C,$,j,O){return J(C,$,j,O,!1)}function q(C,$,j){const O=C[$];C[$]=C[j],C[j]=O}function he(C){const $=C.byteLength;if($%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let j=0;j<$;j+=2)q(C,j,j+1);return C}function V(C){const $=C.byteLength;if($%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let j=0;j<$;j+=4)q(C,j,j+3),q(C,j+1,j+2);return C}function _e(C){const $=C.byteLength;if($%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let j=0;j<$;j+=8)q(C,j,j+7),q(C,j+1,j+6),q(C,j+2,j+5),q(C,j+3,j+4);return C}function ee(C){return C}function W(C,$,j=0,O=C.byteLength){const k=C.byteLength;return j>=k||O<=j?"":(j<0&&(j=0),O>k&&(O=k),(j!==0||O<k)&&(C=C.subarray(j,O)),l($).toString(C))}function re(C,$,j,O,k){return j===void 0?k="utf8":O===void 0&&typeof j=="string"?(k=j,j=void 0):k===void 0&&typeof O=="string"&&(k=O,O=void 0),l(k).write(C,$,j,O)}function ne(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setFloat64(j,$,!0),j+8}function ge(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setFloat32(j,$,!0),j+4}function de(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setUint32(j,$,!0),j+4}function ye(C,$,j){return j===void 0&&(j=0),new DataView(C.buffer,C.byteOffset,C.byteLength).setInt32(j,$,!0),j+4}function Ce(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getFloat64($,!0)}function ke(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getFloat32($,!0)}function ae(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getUint32($,!0)}function Q(C,$){return $===void 0&&($=0),new DataView(C.buffer,C.byteOffset,C.byteLength).getInt32($,!0)}t.exports={isBuffer:h,isEncoding:u,alloc:d,allocUnsafe:f,allocUnsafeSlow:_,byteLength:p,compare:y,concat:w,copy:E,equals:x,fill:B,from:P,includes:te,indexOf:le,lastIndexOf:z,swap16:he,swap32:V,swap64:_e,toBuffer:ee,toString:W,write:re,writeDoubleLE:ne,writeFloatLE:ge,writeUInt32LE:de,writeInt32LE:ye,readDoubleLE:Ce,readFloatLE:ke,readUInt32LE:ae,readInt32LE:Q}}}),require_protocol_buffers_encodings=__commonJS({"node_modules/.pnpm/protocol-buffers-encodings@1.2.0/node_modules/protocol-buffers-encodings/index.js"(e){init_inject_globals();var t=require_varint3(),r=require_signed_varint(),n=require_browser2();e.make=o,e.name=function(a){for(var c=Object.keys(e),l=0;l<c.length;l++)if(e[c[l]]===a)return c[l];return null},e.skip=function(a,c,l){switch(a){case 0:return t.decode(c,l),l+t.decode.bytes;case 1:return l+8;case 2:var h=t.decode(c,l);return l+t.decode.bytes+h;case 3:case 4:throw new Error("Groups are not supported");case 5:return l+4}throw new Error("Unknown wire type: "+a)},e.bytes=o(2,function a(c,l,h){var u=h,d=s(c);return t.encode(d,l,h),h+=t.encode.bytes,n.isBuffer(c)?n.copy(c,l,h):n.write(l,c,h,d),h+=d,a.bytes=h-u,l},function a(c,l){var h=l,u=t.decode(c,l);l+=t.decode.bytes;var d=c.subarray(l,l+u);return l+=d.length,a.bytes=l-h,d},function(a){var c=s(a);return t.encodingLength(c)+c}),e.string=o(2,function a(c,l,h){var u=h,d=n.byteLength(c);return t.encode(d,l,h,"utf-8"),h+=t.encode.bytes,n.write(l,c,h,d),h+=d,a.bytes=h-u,l},function a(c,l){var h=l,u=t.decode(c,l);l+=t.decode.bytes;var d=n.toString(c,"utf-8",l,l+u);return l+=u,a.bytes=l-h,d},function(a){var c=n.byteLength(a);return t.encodingLength(c)+c}),e.bool=o(0,function a(c,l,h){return l[h]=c?1:0,a.bytes=1,l},function a(c,l){var h=c[l]>0;return a.bytes=1,h},function(){return 1}),e.int32=o(0,function a(c,l,h){return t.encode(c<0?c+4294967296:c,l,h),a.bytes=t.encode.bytes,l},function a(c,l){var h=t.decode(c,l);return a.bytes=t.decode.bytes,h>2147483647?h-4294967296:h},function(a){return t.encodingLength(a<0?a+4294967296:a)}),e.int64=o(0,function a(c,l,h){if(c<0){var u=h+9;for(t.encode(c*-1,l,h),h+=t.encode.bytes-1,l[h]=l[h]|128;h<u-1;)h++,l[h]=255;l[u]=1,a.bytes=10}else t.encode(c,l,h),a.bytes=t.encode.bytes;return l},function a(c,l){var h=t.decode(c,l);if(h>=Math.pow(2,63)){for(var u=9;c[l+u-1]===255;)u--;u=u||9;var d=n.allocUnsafe(u);n.copy(c,d,0,l,l+u),d[u-1]=d[u-1]&127,h=-1*t.decode(d,0),a.bytes=10}else a.bytes=t.decode.bytes;return h},function(a){return a<0?10:t.encodingLength(a)}),e.sint32=e.sint64=o(0,r.encode,r.decode,r.encodingLength),e.uint32=e.uint64=e.enum=e.varint=o(0,t.encode,t.decode,t.encodingLength),e.fixed64=e.sfixed64=o(1,function a(c,l,h){return n.copy(c,l,h),a.bytes=8,l},function a(c,l){var h=c.subarray(l,l+8);return a.bytes=8,h},function(){return 8}),e.double=o(1,function a(c,l,h){return n.writeDoubleLE(l,c,h),a.bytes=8,l},function a(c,l){var h=n.readDoubleLE(c,l);return a.bytes=8,h},function(){return 8}),e.fixed32=o(5,function a(c,l,h){return n.writeUInt32LE(l,c,h),a.bytes=4,l},function a(c,l){var h=n.readUInt32LE(c,l);return a.bytes=4,h},function(){return 4}),e.sfixed32=o(5,function a(c,l,h){return n.writeInt32LE(l,c,h),a.bytes=4,l},function a(c,l){var h=n.readInt32LE(c,l);return a.bytes=4,h},function(){return 4}),e.float=o(5,function a(c,l,h){return n.writeFloatLE(l,c,h),a.bytes=4,l},function a(c,l){var h=n.readFloatLE(c,l);return a.bytes=4,h},function(){return 4});function o(a,c,l,h){return c.bytes=l.bytes=0,{type:a,encode:c,decode:l,encodingLength:h}}function s(a){return n.isBuffer(a)?a.length:n.byteLength(a)}}}),require_messages=__commonJS({"node_modules/.pnpm/simple-hypercore-protocol@2.1.2/node_modules/simple-hypercore-protocol/messages.js"(e){init_inject_globals();var t=require_protocol_buffers_encodings(),r=t.varint,n=t.skip,o=e.NoisePayload={buffer:!0,encodingLength:null,encode:null,decode:null},s=e.Open={buffer:!0,encodingLength:null,encode:null,decode:null},a=e.Options={buffer:!0,encodingLength:null,encode:null,decode:null},c=e.Status={buffer:!0,encodingLength:null,encode:null,decode:null},l=e.Have={buffer:!0,encodingLength:null,encode:null,decode:null},h=e.Unhave={buffer:!0,encodingLength:null,encode:null,decode:null},u=e.Want={buffer:!0,encodingLength:null,encode:null,decode:null},d=e.Unwant={buffer:!0,encodingLength:null,encode:null,decode:null},f=e.Request={buffer:!0,encodingLength:null,encode:null,decode:null},_=e.Cancel={buffer:!0,encodingLength:null,encode:null,decode:null},p=e.Data={buffer:!0,encodingLength:null,encode:null,decode:null},y=e.Close={buffer:!0,encodingLength:null,encode:null,decode:null};w(),E(),x(),B(),P(),U(),F(),G(),H(),te(),J(),le();function w(){var q=[t.bytes];o.encodingLength=he,o.encode=V,o.decode=_e;function he(ee){var W=0;if(!z(ee.nonce))throw new Error("nonce is required");var re=q[0].encodingLength(ee.nonce);return W+=1+re,W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.nonce))throw new Error("nonce is required");return W[re++]=10,q[0].encode(ee.nonce,W,re),re+=q[0].encode.bytes,V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={nonce:null},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.nonce=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;default:W=n(ye&7,ee,W)}}}}function E(){var q=[t.bytes];s.encodingLength=he,s.encode=V,s.decode=_e;function he(ee){var W=0;if(!z(ee.discoveryKey))throw new Error("discoveryKey is required");var re=q[0].encodingLength(ee.discoveryKey);if(W+=1+re,z(ee.capability)){var re=q[0].encodingLength(ee.capability);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.discoveryKey))throw new Error("discoveryKey is required");return W[re++]=10,q[0].encode(ee.discoveryKey,W,re),re+=q[0].encode.bytes,z(ee.capability)&&(W[re++]=18,q[0].encode(ee.capability,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={discoveryKey:null,capability:null},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.discoveryKey=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.capability=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function x(){var q=[t.string,t.bool];a.encodingLength=he,a.encode=V,a.decode=_e;function he(ee){var W=0;if(z(ee.extensions)){for(var re=0;re<ee.extensions.length;re++)if(z(ee.extensions[re])){var ne=q[0].encodingLength(ee.extensions[re]);W+=1+ne}}if(z(ee.ack)){var ne=q[1].encodingLength(ee.ack);W+=1+ne}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(z(ee.extensions))for(var ge=0;ge<ee.extensions.length;ge++)z(ee.extensions[ge])&&(W[re++]=10,q[0].encode(ee.extensions[ge],W,re),re+=q[0].encode.bytes);return z(ee.ack)&&(W[re++]=16,q[1].encode(ee.ack,W,re),re+=q[1].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={extensions:[],ack:!1};;){if(re<=W)return _e.bytes=W-ne,ge;var de=r.decode(ee,W);W+=r.decode.bytes;var ye=de>>3;switch(ye){case 1:ge.extensions.push(q[0].decode(ee,W)),W+=q[0].decode.bytes;break;case 2:ge.ack=q[1].decode(ee,W),W+=q[1].decode.bytes;break;default:W=n(de&7,ee,W)}}}}function B(){var q=[t.bool];c.encodingLength=he,c.encode=V,c.decode=_e;function he(ee){var W=0;if(z(ee.uploading)){var re=q[0].encodingLength(ee.uploading);W+=1+re}if(z(ee.downloading)){var re=q[0].encodingLength(ee.downloading);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;return z(ee.uploading)&&(W[re++]=8,q[0].encode(ee.uploading,W,re),re+=q[0].encode.bytes),z(ee.downloading)&&(W[re++]=16,q[0].encode(ee.downloading,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={uploading:!1,downloading:!1};;){if(re<=W)return _e.bytes=W-ne,ge;var de=r.decode(ee,W);W+=r.decode.bytes;var ye=de>>3;switch(ye){case 1:ge.uploading=q[0].decode(ee,W),W+=q[0].decode.bytes;break;case 2:ge.downloading=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(de&7,ee,W)}}}}function P(){var q=[t.varint,t.bytes,t.bool];l.encodingLength=he,l.encode=V,l.decode=_e;function he(ee){var W=0;if(!z(ee.start))throw new Error("start is required");var re=q[0].encodingLength(ee.start);if(W+=1+re,z(ee.length)){var re=q[0].encodingLength(ee.length);W+=1+re}if(z(ee.bitfield)){var re=q[1].encodingLength(ee.bitfield);W+=1+re}if(z(ee.ack)){var re=q[2].encodingLength(ee.ack);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.start))throw new Error("start is required");return W[re++]=8,q[0].encode(ee.start,W,re),re+=q[0].encode.bytes,z(ee.length)&&(W[re++]=16,q[0].encode(ee.length,W,re),re+=q[0].encode.bytes),z(ee.bitfield)&&(W[re++]=26,q[1].encode(ee.bitfield,W,re),re+=q[1].encode.bytes),z(ee.ack)&&(W[re++]=32,q[2].encode(ee.ack,W,re),re+=q[2].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={start:0,length:1,bitfield:null,ack:!1},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.start=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.length=q[0].decode(ee,W),W+=q[0].decode.bytes;break;case 3:ge.bitfield=q[1].decode(ee,W),W+=q[1].decode.bytes;break;case 4:ge.ack=q[2].decode(ee,W),W+=q[2].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function U(){var q=[t.varint];h.encodingLength=he,h.encode=V,h.decode=_e;function he(ee){var W=0;if(!z(ee.start))throw new Error("start is required");var re=q[0].encodingLength(ee.start);if(W+=1+re,z(ee.length)){var re=q[0].encodingLength(ee.length);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.start))throw new Error("start is required");return W[re++]=8,q[0].encode(ee.start,W,re),re+=q[0].encode.bytes,z(ee.length)&&(W[re++]=16,q[0].encode(ee.length,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={start:0,length:1},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.start=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.length=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function F(){var q=[t.varint];u.encodingLength=he,u.encode=V,u.decode=_e;function he(ee){var W=0;if(!z(ee.start))throw new Error("start is required");var re=q[0].encodingLength(ee.start);if(W+=1+re,z(ee.length)){var re=q[0].encodingLength(ee.length);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.start))throw new Error("start is required");return W[re++]=8,q[0].encode(ee.start,W,re),re+=q[0].encode.bytes,z(ee.length)&&(W[re++]=16,q[0].encode(ee.length,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={start:0,length:0},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.start=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.length=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function G(){var q=[t.varint];d.encodingLength=he,d.encode=V,d.decode=_e;function he(ee){var W=0;if(!z(ee.start))throw new Error("start is required");var re=q[0].encodingLength(ee.start);if(W+=1+re,z(ee.length)){var re=q[0].encodingLength(ee.length);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.start))throw new Error("start is required");return W[re++]=8,q[0].encode(ee.start,W,re),re+=q[0].encode.bytes,z(ee.length)&&(W[re++]=16,q[0].encode(ee.length,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={start:0,length:0},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.start=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.length=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function H(){var q=[t.varint,t.bool];f.encodingLength=he,f.encode=V,f.decode=_e;function he(ee){var W=0;if(!z(ee.index))throw new Error("index is required");var re=q[0].encodingLength(ee.index);if(W+=1+re,z(ee.bytes)){var re=q[0].encodingLength(ee.bytes);W+=1+re}if(z(ee.hash)){var re=q[1].encodingLength(ee.hash);W+=1+re}if(z(ee.nodes)){var re=q[0].encodingLength(ee.nodes);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.index))throw new Error("index is required");return W[re++]=8,q[0].encode(ee.index,W,re),re+=q[0].encode.bytes,z(ee.bytes)&&(W[re++]=16,q[0].encode(ee.bytes,W,re),re+=q[0].encode.bytes),z(ee.hash)&&(W[re++]=24,q[1].encode(ee.hash,W,re),re+=q[1].encode.bytes),z(ee.nodes)&&(W[re++]=32,q[0].encode(ee.nodes,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={index:0,bytes:0,hash:!1,nodes:0},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.index=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.bytes=q[0].decode(ee,W),W+=q[0].decode.bytes;break;case 3:ge.hash=q[1].decode(ee,W),W+=q[1].decode.bytes;break;case 4:ge.nodes=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function te(){var q=[t.varint,t.bool];_.encodingLength=he,_.encode=V,_.decode=_e;function he(ee){var W=0;if(!z(ee.index))throw new Error("index is required");var re=q[0].encodingLength(ee.index);if(W+=1+re,z(ee.bytes)){var re=q[0].encodingLength(ee.bytes);W+=1+re}if(z(ee.hash)){var re=q[1].encodingLength(ee.hash);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;if(!z(ee.index))throw new Error("index is required");return W[re++]=8,q[0].encode(ee.index,W,re),re+=q[0].encode.bytes,z(ee.bytes)&&(W[re++]=16,q[0].encode(ee.bytes,W,re),re+=q[0].encode.bytes),z(ee.hash)&&(W[re++]=24,q[1].encode(ee.hash,W,re),re+=q[1].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={index:0,bytes:0,hash:!1},de=!1;;){if(re<=W){if(!de)throw new Error("Decoded message is not valid");return _e.bytes=W-ne,ge}var ye=r.decode(ee,W);W+=r.decode.bytes;var Ce=ye>>3;switch(Ce){case 1:ge.index=q[0].decode(ee,W),W+=q[0].decode.bytes,de=!0;break;case 2:ge.bytes=q[0].decode(ee,W),W+=q[0].decode.bytes;break;case 3:ge.hash=q[1].decode(ee,W),W+=q[1].decode.bytes;break;default:W=n(ye&7,ee,W)}}}}function J(){var q=p.Node={buffer:!0,encodingLength:null,encode:null,decode:null};he();function he(){var re=[t.varint,t.bytes];q.encodingLength=ne,q.encode=ge,q.decode=de;function ne(ye){var Ce=0;if(!z(ye.index))throw new Error("index is required");var ke=re[0].encodingLength(ye.index);if(Ce+=1+ke,!z(ye.hash))throw new Error("hash is required");var ke=re[1].encodingLength(ye.hash);if(Ce+=1+ke,!z(ye.size))throw new Error("size is required");var ke=re[0].encodingLength(ye.size);return Ce+=1+ke,Ce}function ge(ye,Ce,ke){ke||(ke=0),Ce||(Ce=export_Buffer.allocUnsafe(ne(ye)));var ae=ke;if(!z(ye.index))throw new Error("index is required");if(Ce[ke++]=8,re[0].encode(ye.index,Ce,ke),ke+=re[0].encode.bytes,!z(ye.hash))throw new Error("hash is required");if(Ce[ke++]=18,re[1].encode(ye.hash,Ce,ke),ke+=re[1].encode.bytes,!z(ye.size))throw new Error("size is required");return Ce[ke++]=24,re[0].encode(ye.size,Ce,ke),ke+=re[0].encode.bytes,ge.bytes=ke-ae,Ce}function de(ye,Ce,ke){if(Ce||(Ce=0),ke||(ke=ye.length),!(ke<=ye.length&&Ce<=ye.length))throw new Error("Decoded message is not valid");for(var ae=Ce,Q={index:0,hash:null,size:0},C=!1,$=!1,j=!1;;){if(ke<=Ce){if(!C||!$||!j)throw new Error("Decoded message is not valid");return de.bytes=Ce-ae,Q}var O=r.decode(ye,Ce);Ce+=r.decode.bytes;var k=O>>3;switch(k){case 1:Q.index=re[0].decode(ye,Ce),Ce+=re[0].decode.bytes,C=!0;break;case 2:Q.hash=re[1].decode(ye,Ce),Ce+=re[1].decode.bytes,$=!0;break;case 3:Q.size=re[0].decode(ye,Ce),Ce+=re[0].decode.bytes,j=!0;break;default:Ce=n(O&7,ye,Ce)}}}}var V=[t.varint,t.bytes,q];p.encodingLength=_e,p.encode=ee,p.decode=W;function _e(re){var ne=0;if(!z(re.index))throw new Error("index is required");var ge=V[0].encodingLength(re.index);if(ne+=1+ge,z(re.value)){var ge=V[1].encodingLength(re.value);ne+=1+ge}if(z(re.nodes)){for(var de=0;de<re.nodes.length;de++)if(z(re.nodes[de])){var ge=V[2].encodingLength(re.nodes[de]);ne+=r.encodingLength(ge),ne+=1+ge}}if(z(re.signature)){var ge=V[1].encodingLength(re.signature);ne+=1+ge}return ne}function ee(re,ne,ge){ge||(ge=0),ne||(ne=export_Buffer.allocUnsafe(_e(re)));var de=ge;if(!z(re.index))throw new Error("index is required");if(ne[ge++]=8,V[0].encode(re.index,ne,ge),ge+=V[0].encode.bytes,z(re.value)&&(ne[ge++]=18,V[1].encode(re.value,ne,ge),ge+=V[1].encode.bytes),z(re.nodes))for(var ye=0;ye<re.nodes.length;ye++)z(re.nodes[ye])&&(ne[ge++]=26,r.encode(V[2].encodingLength(re.nodes[ye]),ne,ge),ge+=r.encode.bytes,V[2].encode(re.nodes[ye],ne,ge),ge+=V[2].encode.bytes);return z(re.signature)&&(ne[ge++]=34,V[1].encode(re.signature,ne,ge),ge+=V[1].encode.bytes),ee.bytes=ge-de,ne}function W(re,ne,ge){if(ne||(ne=0),ge||(ge=re.length),!(ge<=re.length&&ne<=re.length))throw new Error("Decoded message is not valid");for(var de=ne,ye={index:0,value:null,nodes:[],signature:null},Ce=!1;;){if(ge<=ne){if(!Ce)throw new Error("Decoded message is not valid");return W.bytes=ne-de,ye}var ke=r.decode(re,ne);ne+=r.decode.bytes;var ae=ke>>3;switch(ae){case 1:ye.index=V[0].decode(re,ne),ne+=V[0].decode.bytes,Ce=!0;break;case 2:ye.value=V[1].decode(re,ne),ne+=V[1].decode.bytes;break;case 3:var Q=r.decode(re,ne);ne+=r.decode.bytes,ye.nodes.push(V[2].decode(re,ne,ne+Q)),ne+=V[2].decode.bytes;break;case 4:ye.signature=V[1].decode(re,ne),ne+=V[1].decode.bytes;break;default:ne=n(ke&7,re,ne)}}}}function le(){var q=[t.bytes];y.encodingLength=he,y.encode=V,y.decode=_e;function he(ee){var W=0;if(z(ee.discoveryKey)){var re=q[0].encodingLength(ee.discoveryKey);W+=1+re}return W}function V(ee,W,re){re||(re=0),W||(W=export_Buffer.allocUnsafe(he(ee)));var ne=re;return z(ee.discoveryKey)&&(W[re++]=10,q[0].encode(ee.discoveryKey,W,re),re+=q[0].encode.bytes),V.bytes=re-ne,W}function _e(ee,W,re){if(W||(W=0),re||(re=ee.length),!(re<=ee.length&&W<=ee.length))throw new Error("Decoded message is not valid");for(var ne=W,ge={discoveryKey:null};;){if(re<=W)return _e.bytes=W-ne,ge;var de=r.decode(ee,W);W+=r.decode.bytes;var ye=de>>3;switch(ye){case 1:ge.discoveryKey=q[0].decode(ee,W),W+=q[0].decode.bytes;break;default:W=n(de&7,ee,W)}}}}function z(q){return q!=null&&(typeof q!="number"||!isNaN(q))}}}),require_xsalsa20=__commonJS({"node_modules/.pnpm/xsalsa20@1.2.0/node_modules/xsalsa20/xsalsa20.js"(e,t){init_inject_globals();var r=(c,l)=>function(){return l||(0,c[Object.keys(c)[0]])((l={exports:{}}).exports,l),l.exports},n=(()=>{for(var c=new Uint8Array(128),l=0;l<64;l++)c[l<26?l+65:l<52?l+71:l<62?l-4:l*4-205]=l;return h=>{for(var u=h.length,d=new Uint8Array((u-(h[u-1]=="=")-(h[u-2]=="="))*3/4|0),f=0,_=0;f<u;){var p=c[h.charCodeAt(f++)],y=c[h.charCodeAt(f++)],w=c[h.charCodeAt(f++)],E=c[h.charCodeAt(f++)];d[_++]=p<<2|y>>4,d[_++]=y<<4|w>>2,d[_++]=w<<6|E}return d}})(),o=r({"wasm-binary:./xsalsa20.wat"(c,l){l.exports=n("AGFzbQEAAAABGgNgBn9/f39/fwBgBn9/f39+fwF+YAN/f38AAwcGAAEBAgICBQUBAQroBwcoAwZtZW1vcnkCAAx4c2Fsc2EyMF94b3IAAAxjb3JlX3NhbHNhMjAABArqEQYYACAAIAEgAiADIAQgACkDACAFEAE3AwALPQBB8AAgAyAFEAMgACABIAIgA0EQaiAEQfAAEAJB8ABCADcDAEH4AEIANwMAQYABQgA3AwBBiAFCADcDAAuHBQEBfyACQQBGBEBCAA8LQdAAIAUpAwA3AwBB2AAgBUEIaikDADcDAEHgACAFQRBqKQMANwMAQegAIAVBGGopAwA3AwBBACADKQMANwMAQQggBDcDAAJAA0AgAkHAAEkNAUEQQQBB0AAQBSAAIAEpAwBBECkDAIU3AwAgAEEIaiABQQhqKQMAQRgpAwCFNwMAIABBEGogAUEQaikDAEEgKQMAhTcDACAAQRhqIAFBGGopAwBBKCkDAIU3AwAgAEEgaiABQSBqKQMAQTApAwCFNwMAIABBKGogAUEoaikDAEE4KQMAhTcDACAAQTBqIAFBMGopAwBBwAApAwCFNwMAIABBOGogAUE4aikDAEHIACkDAIU3AwBBCEEIKQMAQgF8NwMAIABBwABqIQAgAUHAAGohASACQcAAayECDAALC0EIKQMAIQQgAkEASwRAQRBBAEHQABAFAkACQAJAAkACQAJAAkACQCACQQhuDgcHBgUEAwIBAAsgAEE4aiABQThqKQMAQcgAKQMAhTcDAAsgAEEwaiABQTBqKQMAQcAAKQMAhTcDAAsgAEEoaiABQShqKQMAQTgpAwCFNwMACyAAQSBqIAFBIGopAwBBMCkDAIU3AwALIABBGGogAUEYaikDAEEoKQMAhTcDAAsgAEEQaiABQRBqKQMAQSApAwCFNwMACyAAQQhqIAFBCGopAwBBGCkDAIU3AwALIAAgASkDAEEQKQMAhTcDAAtBEEIANwMAQRhCADcDAEEgQgA3AwBBKEIANwMAQTBCADcDAEE4QgA3AwBBwABCADcDAEHIAEIANwMAQdAAQgA3AwBB2ABCADcDAEHgAEIANwMAQegAQgA3AwAgBA8LnQUBEX9B5fDBiwYhA0HuyIGZAyEIQbLaiMsHIQ1B9MqB2QYhEiACKAIAIQQgAkEEaigCACEFIAJBCGooAgAhBiACQQxqKAIAIQcgAkEQaigCACEOIAJBFGooAgAhDyACQRhqKAIAIRAgAkEcaigCACERIAEoAgAhCSABQQRqKAIAIQogAUEIaigCACELIAFBDGooAgAhDEEUIRMCQANAIBNBAEYNASAHIAMgD2pBB3dzIQcgCyAHIANqQQl3cyELIA8gCyAHakENd3MhDyADIA8gC2pBEndzIQMgDCAIIARqQQd3cyEMIBAgDCAIakEJd3MhECAEIBAgDGpBDXdzIQQgCCAEIBBqQRJ3cyEIIBEgDSAJakEHd3MhESAFIBEgDWpBCXdzIQUgCSAFIBFqQQ13cyEJIA0gCSAFakESd3MhDSAGIBIgDmpBB3dzIQYgCiAGIBJqQQl3cyEKIA4gCiAGakENd3MhDiASIA4gCmpBEndzIRIgBCADIAZqQQd3cyEEIAUgBCADakEJd3MhBSAGIAUgBGpBDXdzIQYgAyAGIAVqQRJ3cyEDIAkgCCAHakEHd3MhCSAKIAkgCGpBCXdzIQogByAKIAlqQQ13cyEHIAggByAKakESd3MhCCAOIA0gDGpBB3dzIQ4gCyAOIA1qQQl3cyELIAwgCyAOakENd3MhDCANIAwgC2pBEndzIQ0gDyASIBFqQQd3cyEPIBAgDyASakEJd3MhECARIBAgD2pBDXdzIREgEiARIBBqQRJ3cyESIBNBAmshEwwACwsgACADNgIAIABBBGogCDYCACAAQQhqIA02AgAgAEEMaiASNgIAIABBEGogCTYCACAAQRRqIAo2AgAgAEEYaiALNgIAIABBHGogDDYCAAsKACAAIAEgAhAFC90GASF/QeXwwYsGIQNB7siBmQMhCEGy2ojLByENQfTKgdkGIRIgAigCACEEIAJBBGooAgAhBSACQQhqKAIAIQYgAkEMaigCACEHIAJBEGooAgAhDiACQRRqKAIAIQ8gAkEYaigCACEQIAJBHGooAgAhESABKAIAIQkgAUEEaigCACEKIAFBCGooAgAhCyABQQxqKAIAIQwgAyETIAQhFCAFIRUgBiEWIAchFyAIIRggCSEZIAohGiALIRsgDCEcIA0hHSAOIR4gDyEfIBAhICARISEgEiEiQRQhIwJAA0AgI0EARg0BIAcgAyAPakEHd3MhByALIAcgA2pBCXdzIQsgDyALIAdqQQ13cyEPIAMgDyALakESd3MhAyAMIAggBGpBB3dzIQwgECAMIAhqQQl3cyEQIAQgECAMakENd3MhBCAIIAQgEGpBEndzIQggESANIAlqQQd3cyERIAUgESANakEJd3MhBSAJIAUgEWpBDXdzIQkgDSAJIAVqQRJ3cyENIAYgEiAOakEHd3MhBiAKIAYgEmpBCXdzIQogDiAKIAZqQQ13cyEOIBIgDiAKakESd3MhEiAEIAMgBmpBB3dzIQQgBSAEIANqQQl3cyEFIAYgBSAEakENd3MhBiADIAYgBWpBEndzIQMgCSAIIAdqQQd3cyEJIAogCSAIakEJd3MhCiAHIAogCWpBDXdzIQcgCCAHIApqQRJ3cyEIIA4gDSAMakEHd3MhDiALIA4gDWpBCXdzIQsgDCALIA5qQQ13cyEMIA0gDCALakESd3MhDSAPIBIgEWpBB3dzIQ8gECAPIBJqQQl3cyEQIBEgECAPakENd3MhESASIBEgEGpBEndzIRIgI0ECayEjDAALCyAAIAMgE2o2AgAgAEEEaiAEIBRqNgIAIABBCGogBSAVajYCACAAQQxqIAYgFmo2AgAgAEEQaiAHIBdqNgIAIABBFGogCCAYajYCACAAQRhqIAkgGWo2AgAgAEEcaiAKIBpqNgIAIABBIGogCyAbajYCACAAQSRqIAwgHGo2AgAgAEEoaiANIB1qNgIAIABBLGogDiAeajYCACAAQTBqIA8gH2o2AgAgAEE0aiAQICBqNgIAIABBOGogESAhajYCACAAQTxqIBIgImo2AgAL")}}),s=o(),a=new WebAssembly.Module(s);t.exports=c=>new WebAssembly.Instance(a,c).exports}}),require_xsalsa202=__commonJS({"node_modules/.pnpm/xsalsa20@1.2.0/node_modules/xsalsa20/index.js"(e,t){init_inject_globals();var r=typeof WebAssembly<"u"&&require_xsalsa20()(),n=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]),o=144,s=o,a=[];t.exports=c,c.NONCEBYTES=24,c.KEYBYTES=32,c.core_hsalsa20=d,c.SIGMA=n;function c(f,_){if(!(this instanceof c))return new c(f,_);if(!f||f.length<24)throw new Error("nonce must be at least 24 bytes");if(!_||_.length<32)throw new Error("key must be at least 32 bytes");this._xor=r?new l(f,_):new h(f,_)}c.prototype.update=function(f,_){if(!f)throw new Error("input must be Uint8Array or Buffer");return _||(_=new Uint8Array(f.length)),f.length&&this._xor.update(f,_),_},c.prototype.final=c.prototype.finalize=function(){this._xor.finalize(),this._xor=null};function l(f,_){a.length||(a.push(o),o+=64),this._pointer=a.pop(),this._nonce=this._pointer+8,this._key=this._nonce+24,this._overflow=0,this._memory=new Uint8Array(r.memory.buffer),this._memory.fill(0,this._pointer,this._pointer+8),this._memory.set(f,this._nonce),this._memory.set(_,this._key)}l.prototype.realloc=function(f){r.memory.grow(Math.ceil(Math.abs(f-this._memory.length)/65536)),this._memory=new Uint8Array(r.memory.buffer)},l.prototype.update=function(f,_){var p=this._overflow+f.length,y=o+this._overflow;s=o+p,s>=this._memory.length&&this.realloc(s),this._memory.set(f,y),r.xsalsa20_xor(this._pointer,o,o,p,this._nonce,this._key),_.set(this._memory.subarray(y,o+p)),this._overflow=p&63},l.prototype.finalize=function(){this._memory.fill(0,this._pointer,this._key+32),s>o&&(this._memory.fill(0,o,s),s=0),a.push(this._pointer)};function h(f,_){this._s=new Uint8Array(32),this._z=new Uint8Array(16),this._overflow=0,d(this._s,f,_,n);for(var p=0;p<8;p++)this._z[p]=f[p+16]}h.prototype.update=function(f,_){for(var p=new Uint8Array(64),y=0,w=this._overflow,E=f.length+this._overflow,x=this._z,B=-this._overflow,P=-this._overflow;E>=64;){for(u(p,x,this._s,n);w<64;w++)_[P+w]=f[B+w]^p[w];for(y=1,w=8;w<16;w++)y+=x[w]&255|0,x[w]=y&255,y>>>=8;E-=64,P+=64,B+=64,w=0}if(E>0)for(u(p,x,this._s,n);w<E;w++)_[P+w]=f[B+w]^p[w];this._overflow=E&63},h.prototype.finalize=function(){this._s.fill(0),this._z.fill(0)};function u(f,_,p,y){for(var w=y[0]&255|(y[1]&255)<<8|(y[2]&255)<<16|(y[3]&255)<<24,E=p[0]&255|(p[1]&255)<<8|(p[2]&255)<<16|(p[3]&255)<<24,x=p[4]&255|(p[5]&255)<<8|(p[6]&255)<<16|(p[7]&255)<<24,B=p[8]&255|(p[9]&255)<<8|(p[10]&255)<<16|(p[11]&255)<<24,P=p[12]&255|(p[13]&255)<<8|(p[14]&255)<<16|(p[15]&255)<<24,U=y[4]&255|(y[5]&255)<<8|(y[6]&255)<<16|(y[7]&255)<<24,F=_[0]&255|(_[1]&255)<<8|(_[2]&255)<<16|(_[3]&255)<<24,G=_[4]&255|(_[5]&255)<<8|(_[6]&255)<<16|(_[7]&255)<<24,H=_[8]&255|(_[9]&255)<<8|(_[10]&255)<<16|(_[11]&255)<<24,te=_[12]&255|(_[13]&255)<<8|(_[14]&255)<<16|(_[15]&255)<<24,J=y[8]&255|(y[9]&255)<<8|(y[10]&255)<<16|(y[11]&255)<<24,le=p[16]&255|(p[17]&255)<<8|(p[18]&255)<<16|(p[19]&255)<<24,z=p[20]&255|(p[21]&255)<<8|(p[22]&255)<<16|(p[23]&255)<<24,q=p[24]&255|(p[25]&255)<<8|(p[26]&255)<<16|(p[27]&255)<<24,he=p[28]&255|(p[29]&255)<<8|(p[30]&255)<<16|(p[31]&255)<<24,V=y[12]&255|(y[13]&255)<<8|(y[14]&255)<<16|(y[15]&255)<<24,_e=w,ee=E,W=x,re=B,ne=P,ge=U,de=F,ye=G,Ce=H,ke=te,ae=J,Q=le,C=z,$=q,j=he,O=V,k,ue=0;ue<20;ue+=2)k=_e+C|0,ne^=k<<7|k>>>25,k=ne+_e|0,Ce^=k<<9|k>>>23,k=Ce+ne|0,C^=k<<13|k>>>19,k=C+Ce|0,_e^=k<<18|k>>>14,k=ge+ee|0,ke^=k<<7|k>>>25,k=ke+ge|0,$^=k<<9|k>>>23,k=$+ke|0,ee^=k<<13|k>>>19,k=ee+$|0,ge^=k<<18|k>>>14,k=ae+de|0,j^=k<<7|k>>>25,k=j+ae|0,W^=k<<9|k>>>23,k=W+j|0,de^=k<<13|k>>>19,k=de+W|0,ae^=k<<18|k>>>14,k=O+Q|0,re^=k<<7|k>>>25,k=re+O|0,ye^=k<<9|k>>>23,k=ye+re|0,Q^=k<<13|k>>>19,k=Q+ye|0,O^=k<<18|k>>>14,k=_e+re|0,ee^=k<<7|k>>>25,k=ee+_e|0,W^=k<<9|k>>>23,k=W+ee|0,re^=k<<13|k>>>19,k=re+W|0,_e^=k<<18|k>>>14,k=ge+ne|0,de^=k<<7|k>>>25,k=de+ge|0,ye^=k<<9|k>>>23,k=ye+de|0,ne^=k<<13|k>>>19,k=ne+ye|0,ge^=k<<18|k>>>14,k=ae+ke|0,Q^=k<<7|k>>>25,k=Q+ae|0,Ce^=k<<9|k>>>23,k=Ce+Q|0,ke^=k<<13|k>>>19,k=ke+Ce|0,ae^=k<<18|k>>>14,k=O+j|0,C^=k<<7|k>>>25,k=C+O|0,$^=k<<9|k>>>23,k=$+C|0,j^=k<<13|k>>>19,k=j+$|0,O^=k<<18|k>>>14;_e=_e+w|0,ee=ee+E|0,W=W+x|0,re=re+B|0,ne=ne+P|0,ge=ge+U|0,de=de+F|0,ye=ye+G|0,Ce=Ce+H|0,ke=ke+te|0,ae=ae+J|0,Q=Q+le|0,C=C+z|0,$=$+q|0,j=j+he|0,O=O+V|0,f[0]=_e>>>0&255,f[1]=_e>>>8&255,f[2]=_e>>>16&255,f[3]=_e>>>24&255,f[4]=ee>>>0&255,f[5]=ee>>>8&255,f[6]=ee>>>16&255,f[7]=ee>>>24&255,f[8]=W>>>0&255,f[9]=W>>>8&255,f[10]=W>>>16&255,f[11]=W>>>24&255,f[12]=re>>>0&255,f[13]=re>>>8&255,f[14]=re>>>16&255,f[15]=re>>>24&255,f[16]=ne>>>0&255,f[17]=ne>>>8&255,f[18]=ne>>>16&255,f[19]=ne>>>24&255,f[20]=ge>>>0&255,f[21]=ge>>>8&255,f[22]=ge>>>16&255,f[23]=ge>>>24&255,f[24]=de>>>0&255,f[25]=de>>>8&255,f[26]=de>>>16&255,f[27]=de>>>24&255,f[28]=ye>>>0&255,f[29]=ye>>>8&255,f[30]=ye>>>16&255,f[31]=ye>>>24&255,f[32]=Ce>>>0&255,f[33]=Ce>>>8&255,f[34]=Ce>>>16&255,f[35]=Ce>>>24&255,f[36]=ke>>>0&255,f[37]=ke>>>8&255,f[38]=ke>>>16&255,f[39]=ke>>>24&255,f[40]=ae>>>0&255,f[41]=ae>>>8&255,f[42]=ae>>>16&255,f[43]=ae>>>24&255,f[44]=Q>>>0&255,f[45]=Q>>>8&255,f[46]=Q>>>16&255,f[47]=Q>>>24&255,f[48]=C>>>0&255,f[49]=C>>>8&255,f[50]=C>>>16&255,f[51]=C>>>24&255,f[52]=$>>>0&255,f[53]=$>>>8&255,f[54]=$>>>16&255,f[55]=$>>>24&255,f[56]=j>>>0&255,f[57]=j>>>8&255,f[58]=j>>>16&255,f[59]=j>>>24&255,f[60]=O>>>0&255,f[61]=O>>>8&255,f[62]=O>>>16&255,f[63]=O>>>24&255}function d(f,_,p,y){for(var w=y[0]&255|(y[1]&255)<<8|(y[2]&255)<<16|(y[3]&255)<<24,E=p[0]&255|(p[1]&255)<<8|(p[2]&255)<<16|(p[3]&255)<<24,x=p[4]&255|(p[5]&255)<<8|(p[6]&255)<<16|(p[7]&255)<<24,B=p[8]&255|(p[9]&255)<<8|(p[10]&255)<<16|(p[11]&255)<<24,P=p[12]&255|(p[13]&255)<<8|(p[14]&255)<<16|(p[15]&255)<<24,U=y[4]&255|(y[5]&255)<<8|(y[6]&255)<<16|(y[7]&255)<<24,F=_[0]&255|(_[1]&255)<<8|(_[2]&255)<<16|(_[3]&255)<<24,G=_[4]&255|(_[5]&255)<<8|(_[6]&255)<<16|(_[7]&255)<<24,H=_[8]&255|(_[9]&255)<<8|(_[10]&255)<<16|(_[11]&255)<<24,te=_[12]&255|(_[13]&255)<<8|(_[14]&255)<<16|(_[15]&255)<<24,J=y[8]&255|(y[9]&255)<<8|(y[10]&255)<<16|(y[11]&255)<<24,le=p[16]&255|(p[17]&255)<<8|(p[18]&255)<<16|(p[19]&255)<<24,z=p[20]&255|(p[21]&255)<<8|(p[22]&255)<<16|(p[23]&255)<<24,q=p[24]&255|(p[25]&255)<<8|(p[26]&255)<<16|(p[27]&255)<<24,he=p[28]&255|(p[29]&255)<<8|(p[30]&255)<<16|(p[31]&255)<<24,V=y[12]&255|(y[13]&255)<<8|(y[14]&255)<<16|(y[15]&255)<<24,_e=w,ee=E,W=x,re=B,ne=P,ge=U,de=F,ye=G,Ce=H,ke=te,ae=J,Q=le,C=z,$=q,j=he,O=V,k,ue=0;ue<20;ue+=2)k=_e+C|0,ne^=k<<7|k>>>25,k=ne+_e|0,Ce^=k<<9|k>>>23,k=Ce+ne|0,C^=k<<13|k>>>19,k=C+Ce|0,_e^=k<<18|k>>>14,k=ge+ee|0,ke^=k<<7|k>>>25,k=ke+ge|0,$^=k<<9|k>>>23,k=$+ke|0,ee^=k<<13|k>>>19,k=ee+$|0,ge^=k<<18|k>>>14,k=ae+de|0,j^=k<<7|k>>>25,k=j+ae|0,W^=k<<9|k>>>23,k=W+j|0,de^=k<<13|k>>>19,k=de+W|0,ae^=k<<18|k>>>14,k=O+Q|0,re^=k<<7|k>>>25,k=re+O|0,ye^=k<<9|k>>>23,k=ye+re|0,Q^=k<<13|k>>>19,k=Q+ye|0,O^=k<<18|k>>>14,k=_e+re|0,ee^=k<<7|k>>>25,k=ee+_e|0,W^=k<<9|k>>>23,k=W+ee|0,re^=k<<13|k>>>19,k=re+W|0,_e^=k<<18|k>>>14,k=ge+ne|0,de^=k<<7|k>>>25,k=de+ge|0,ye^=k<<9|k>>>23,k=ye+de|0,ne^=k<<13|k>>>19,k=ne+ye|0,ge^=k<<18|k>>>14,k=ae+ke|0,Q^=k<<7|k>>>25,k=Q+ae|0,Ce^=k<<9|k>>>23,k=Ce+Q|0,ke^=k<<13|k>>>19,k=ke+Ce|0,ae^=k<<18|k>>>14,k=O+j|0,C^=k<<7|k>>>25,k=C+O|0,$^=k<<9|k>>>23,k=$+C|0,j^=k<<13|k>>>19,k=j+$|0,O^=k<<18|k>>>14;f[0]=_e>>>0&255,f[1]=_e>>>8&255,f[2]=_e>>>16&255,f[3]=_e>>>24&255,f[4]=ge>>>0&255,f[5]=ge>>>8&255,f[6]=ge>>>16&255,f[7]=ge>>>24&255,f[8]=ae>>>0&255,f[9]=ae>>>8&255,f[10]=ae>>>16&255,f[11]=ae>>>24&255,f[12]=O>>>0&255,f[13]=O>>>8&255,f[14]=O>>>16&255,f[15]=O>>>24&255,f[16]=de>>>0&255,f[17]=de>>>8&255,f[18]=de>>>16&255,f[19]=de>>>24&255,f[20]=ye>>>0&255,f[21]=ye>>>8&255,f[22]=ye>>>16&255,f[23]=ye>>>24&255,f[24]=Ce>>>0&255,f[25]=Ce>>>8&255,f[26]=Ce>>>16&255,f[27]=Ce>>>24&255,f[28]=ke>>>0&255,f[29]=ke>>>8&255,f[30]=ke>>>16&255,f[31]=ke>>>24&255}}}),require_browser3=__commonJS({"node_modules/.pnpm/xsalsa20-universal@1.0.0/node_modules/xsalsa20-universal/browser.js"(e,t){init_inject_globals();var r=require_xsalsa202();t.exports=class{constructor(n,o){this.instance=r(n,o)}update(n,o){this.instance.update(o,n)}final(){this.instance.finalize()}}}}),require_xor=__commonJS({"node_modules/.pnpm/simple-hypercore-protocol@2.1.2/node_modules/simple-hypercore-protocol/lib/xor.js"(e,t){init_inject_globals();var r=require_browser3(),n=require_hypercore_crypto();t.exports=class{constructor(o,s){this.rnonce=o.rnonce,this.tnonce=o.tnonce,this.rx=new r(this.rnonce,s.rx.slice(0,32)),this.tx=new r(this.tnonce,s.tx.slice(0,32))}encrypt(o){return this.tx.update(o,o),o}decrypt(o){return this.rx.update(o,o),o}destroy(){this.tx.final(),this.rx.final()}static nonce(){return n.randomBytes(24)}}}}),require_simple_message_channels=__commonJS({"node_modules/.pnpm/simple-message-channels@1.2.1/node_modules/simple-message-channels/index.js"(e,t){init_inject_globals();var r=require_varint2();t.exports=class{constructor({maxSize:n=8*1024*1024,context:o=null,onmessage:s=null,onmissing:a=null,types:c=null}={}){this._message=null,this._ptr=0,this._varint=0,this._factor=1,this._length=0,this._header=0,this._state=0,this._consumed=0,this._maxSize=n,this._types=c||[],this.receiving=!1,this.destroyed=!1,this.error=null,this.context=o,this.onmessage=s,this.onmissing=a}destroy(n){n&&(this.error=n),this.destroyed=!0}recv(n){if(this.receiving===!0)throw new Error("Cannot recursively receive data");this.receiving=!0;let o=0;for(;o<n.length;)this._state===2?o=this._readMessage(n,o):o=this._readVarint(n,o);return this._state===2&&this._length===0&&this._readMessage(n,o),this.receiving=!1,!this.destroyed}_readMessage(n,o){const s=n.length-o;return s>=this._length?(this._message?n.copy(this._message,this._message.length-this._length,o):this._message=n.slice(o,o+this._length),this._nextState(n,o+=this._length)?o:n.length):(this._message||(this._message=export_Buffer.allocUnsafe(this._length)),n.copy(this._message,this._message.length-this._length,o),this._length-=s,n.length)}_readVarint(n,o){for(;o<n.length;o++){if(this._varint+=(n[o]&127)*this._factor,this._consumed++,n[o]<128)return this._nextState(n,++o)?o:n.length;this._factor*=128}return this._consumed>=8&&this.destroy(new Error("Incoming varint is invalid")),n.length}_nextState(n,o){switch(this._state){case 0:return this._state=1,this._factor=1,this._length=this._varint,this._consumed=this._varint=0,this._length===0&&(this._state=0),!0;case 1:if(this._state=2,this._factor=1,this._header=this._varint,this._length-=this._consumed,this._consumed=this._varint=0,this._length<0||this._length>this._maxSize)return this.destroy(new Error("Incoming message is larger than max size")),!1;if(this.onmissing){const s=n.length-o;this._length>s&&this.onmissing(this._length-s,this.context)}return!0;case 2:return this._state=0,this._onmessage(this._header>>4,this._header&15,this._message,n,o),this._message=null,!this.destroyed;default:return!1}}_onmessage(n,o,s,a,c){if(o>=this._types.length)return this.onmessage===null?void 0:this.onmessage(n,o,s,this.context,a,c);let l=null;const{onmessage:h,encoding:u,context:d}=this._types[o];try{l=u.decode(s)}catch(f){this.destroy(f);return}h(n,l,d,a,c)}send(n,o,s){const a=n<<4|o,c=this._encodingLength(o,s)+r.encodingLength(a),l=export_Buffer.allocUnsafe(r.encodingLength(c)+c);r.encode(c,l,0);const h=r.encode.bytes;return r.encode(a,l,h),this._encode(o,s,l,h+r.encode.bytes),l}sendBatch(n){let o=0,s=0;for(const{type:c,message:l}of n)o+=16+this._encodingLength(c,l);const a=export_Buffer.allocUnsafe(o);for(const{channel:c,type:l,message:h}of n){const u=c<<4|l,d=this._encodingLength(l,h)+r.encodingLength(u);r.encode(d,a,s),s+=r.encode.bytes,r.encode(u,a,s),s+=r.encode.bytes,s+=this._encode(l,h,a,s)}return a.slice(0,s)}_encodingLength(n,o){return n>=this._types.length?o.length:this._types[n].encoding.encodingLength(o)}_encode(n,o,s,a){if(n>=this._types.length)return o.copy(s,a),o.length;const c=this._types[n].encoding;return c.encode(o,s,a),c.encode.bytes}}}}),require_simple_hypercore_protocol=__commonJS({"node_modules/.pnpm/simple-hypercore-protocol@2.1.2/node_modules/simple-hypercore-protocol/index.js"(e,t){init_inject_globals();var r=require_handshake(),n=require_messages(),o=require_xor(),s=require_simple_message_channels(),a=require_hypercore_crypto(),c=require_varint2();t.exports=class{constructor(U,F){const G={nonce:o.nonce()};this.handlers=F||{},this.remotePayload=null,this.remotePublicKey=null,this.publicKey=null,this.handshakeHash=null,this.destroyed=!1,this._initiator=U,this._payload=G,this._pending=[],this._handshake=null,this._split=null,this._encryption=null,this._noise=!(F.encrypted===!1&&F.noise===!1),this._buffering=null,this._handshaking=!1,this._messages=new s({onmessage:B,onmissing:P,context:this,types:[{context:this,onmessage:l,encoding:n.Open},{context:this,onmessage:h,encoding:n.Options},{context:this,onmessage:u,encoding:n.Status},{context:this,onmessage:d,encoding:n.Have},{context:this,onmessage:f,encoding:n.Unhave},{context:this,onmessage:_,encoding:n.Want},{context:this,onmessage:p,encoding:n.Unwant},{context:this,onmessage:y,encoding:n.Request},{context:this,onmessage:w,encoding:n.Cancel},{context:this,onmessage:E,encoding:n.Data},{context:this,onmessage:x,encoding:n.Close}]}),(F.encrypted!==!1||F.noise!==!1)&&(this._handshaking=!0,typeof this.handlers.keyPair!="function"?this._onkeypair(null,this.handlers.keyPair||null):(this._buffering=[],this.handlers.keyPair(this._onkeypair.bind(this))))}_onkeypair(U,F){if(U)return this.destroy(U);if(this._handshake!==null)return;this.handlers.keyPair=F;const G=new r(this._initiator,n.NoisePayload.encode(this._payload),this.handlers,this._onhandshake.bind(this));if(this.publicKey=G.keyPair.publicKey,this._handshake=G,this._buffering)for(;this._buffering.length;)this._recv(this._buffering.shift());this._buffering=null}open(U,F){return this._send(U,0,F)}options(U,F){return this._send(U,1,F)}status(U,F){return this._send(U,2,F)}have(U,F){return this._send(U,3,F)}unhave(U,F){return this._send(U,4,F)}want(U,F){return this._send(U,5,F)}unwant(U,F){return this._send(U,6,F)}request(U,F){return this._send(U,7,F)}cancel(U,F){return this._send(U,8,F)}data(U,F){return this._send(U,9,F)}close(U,F){return this._send(U,10,F||{})}extension(U,F,G){const H=export_Buffer.allocUnsafe(c.encodingLength(F)+G.length);return c.encode(F,H,0),G.copy(H,c.encode.bytes),this._send(U,15,H)}ping(){if(this._handshaking||this._pending.length)return;let U=export_Buffer.from([0]);return this._encryption!==null&&(U=this._encryption.encrypt(U)),this.handlers.send(U)}_onhandshake(U,F,G,H,te,J){if(U)return this.destroy(new Error("Noise handshake error"));if(!F)return this.destroy(new Error("Remote did not include a handshake payload"));this.remotePublicKey=te,this.handshakeHash=J;try{F=n.NoisePayload.decode(F)}catch{return this.destroy(new Error("Could not parse remote payload"))}if(this._handshake=null,this._handshaking=!1,this._split=G,this._encryption=this.handlers.encrypted===!1?null:new o({rnonce:F.nonce,tnonce:this._payload.nonce},G),this.remotePayload=F,this.handlers.onhandshake&&this.handlers.onhandshake(),!this.destroyed)for(H&&this.recv(H);this._pending.length&&!this.destroyed;)this._sendNow(...this._pending.shift())}_send(U,F,G){return this._handshaking||this._pending.length?(this._pending.push([U,F,G]),!1):this._sendNow(U,F,G)}_sendNow(U,F,G){F===0&&G.key&&!G.capability&&(G.capability=this.capability(G.key),G.key=null);let H=this._messages.send(U,F,G);return this._encryption!==null&&(H=this._encryption.encrypt(H)),this.handlers.send(H)}capability(U){return a.capability(U,this._split)}remoteCapability(U){return a.remoteCapability(U,this._split)}recv(U){this._buffering!==null?this._buffering.push(U):this._recv(U)}_recv(U){if(!this.destroyed){if(this._handshaking){this._handshake.recv(U);return}this._encryption!==null&&(U=this._encryption.decrypt(U)),this._messages.recv(U)||this.destroy(this._messages.error)}}destroy(U){this.destroyed||(this.destroyed=!0,this._handshake&&this._handshake.destroy(),this._encryption&&this._encryption.destroy(),this.handlers.destroy&&this.handlers.destroy(U))}static keyPair(U){return r.keyPair(U)}};function l(U,F,G){G.handlers.onopen&&G.handlers.onopen(U,F)}function h(U,F,G){G.handlers.onoptions&&G.handlers.onoptions(U,F)}function u(U,F,G){G.handlers.onstatus&&G.handlers.onstatus(U,F)}function d(U,F,G){G.handlers.onhave&&G.handlers.onhave(U,F)}function f(U,F,G){G.handlers.onunhave&&G.handlers.onunhave(U,F)}function _(U,F,G){G.handlers.onwant&&G.handlers.onwant(U,F)}function p(U,F,G){G.handlers.onunwant&&G.handlers.onunwant(U,F)}function y(U,F,G){G.handlers.onrequest&&G.handlers.onrequest(U,F)}function w(U,F,G){G.handlers.oncancel&&G.handlers.oncancel(U,F)}function E(U,F,G){G.handlers.ondata&&G.handlers.ondata(U,F)}function x(U,F,G){G.handlers.onclose&&G.handlers.onclose(U,F)}function B(U,F,G,H){if(F!==15)return;const te=c.decode(G),J=G.slice(c.decode.bytes);H.handlers.onextension&&H.handlers.onextension(U,te,J)}function P(U,F){F.handlers.onmissing&&F.handlers.onmissing(U)}}}),require_browser4=__commonJS({"node_modules/.pnpm/timeout-refresh@1.0.3/node_modules/timeout-refresh/browser.js"(e,t){init_inject_globals(),t.exports=r;function r(o,s,a){if(!(this instanceof r))return new r(o,s,a);this.ms=o,this.ontimeout=s,this.context=a||null,this.called=!1,this._timeout=setTimeout(n,o,this)}r.prototype.refresh=function(){this.called||this.ontimeout===null||(clearTimeout(this._timeout),this._timeout=setTimeout(n,this.ms,this))},r.prototype.destroy=function(){this.ontimeout=null,clearTimeout(this._timeout)};function n(o){o.called=!0,o.ontimeout.call(o.context)}}}),require_abstract_extension=__commonJS({"node_modules/.pnpm/abstract-extension@3.1.1/node_modules/abstract-extension/index.js"(e,t){init_inject_globals();var r=require_codecs(),n=class{constructor(l,h,u={}){this.id=0,this.name=h,this.encoding=r(u.encoding||"binary"),this.handlers=u,this.local=l}encode(l){return this.encoding.encode(l)}remoteSupports(){return!!(this.local&&this.local.map&&this.local.map[this.id]===this)}onmessage(l,h){if(!this.handlers.onmessage)return;let u;try{u=this.encoding.decode(l)}catch(d){this.handlers.onerror&&this.handlers.onerror(d,h);return}this.handlers.onmessage(u,h)}get destroyed(){return this.local===null}destroy(){this.local!==null&&(this.local._remove(this),this.local=null)}static createLocal(l=null){return new s(l,this)}},o=class{constructor(l){this.local=l,this.names=null,this.map=null,this.changes=0}update(l){this.names=l,this.changes=0}onmessage(l,h,u=null){this.changes!==this.local.changes&&(this.map=this.names?c(this.local.messages,this.names):null,this.changes=this.local.changes);const d=this.map&&this.map[l];d&&d.onmessage(h,u)}},s=class{constructor(l=null,h){this.messages=[],this.handlers=l,this.Extension=h,this.changes=1,this.exclusive=!0}get length(){return this.messages.length}[Symbol.iterator](){return this.messages[Symbol.iterator]()}get(l){for(const h of this.messages)if(h.name===l)return h;return null}add(l,h){let u;typeof h!="function"?u=new this.Extension(this,l,h):(u=new this.Extension(this,l,{}),u.handlers=h(u)||{},u.encoding=r(u.handlers.encoding||"binary")),this.changes++,this.messages.push(u),this.messages.sort(a);for(let d=0;d<this.messages.length;d++)this.messages[d].id=d;if(this.exclusive&&(u.id>0&&this.messages[u.id-1].name===u.name||u.id<this.messages.length-1&&this.messages[u.id+1].name===u.name))throw this._remove(u),new Error("Cannot add multiple messages with the same name");return this.handlers&&this.handlers.onextensionupdate&&this.handlers.onextensionupdate(),u}remote(){return new o(this)}_remove(l){this.changes++,this.messages.splice(l.id,1),l.id=-1,this.handlers&&this.handlers.onextensionupdate&&this.handlers.onextensionupdate()}names(){const l=new Array(this.messages.length);for(let h=0;h<l.length;h++)l[h]=this.messages[h].name;return l}};function a(l,h){return l.name<h.name?-1:l.name>h.name?1:0}function c(l,h){let u=0,d=0;const f=new Array(h.length);for(;u<l.length&&d<h.length;){const _=l[u].name,p=h[d];_<p?u++:_>p?d++:f[d++]=l[u]}return f}t.exports=n}}),require_ms=__commonJS({"node_modules/.pnpm/ms@2.1.2/node_modules/ms/index.js"(e,t){init_inject_globals();var r=1e3,n=r*60,o=n*60,s=o*24,a=s*7,c=s*365.25;t.exports=function(f,_){_=_||{};var p=typeof f;if(p==="string"&&f.length>0)return l(f);if(p==="number"&&isFinite(f))return _.long?u(f):h(f);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(f))};function l(f){if(f=String(f),!(f.length>100)){var _=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(f);if(_){var p=parseFloat(_[1]),y=(_[2]||"ms").toLowerCase();switch(y){case"years":case"year":case"yrs":case"yr":case"y":return p*c;case"weeks":case"week":case"w":return p*a;case"days":case"day":case"d":return p*s;case"hours":case"hour":case"hrs":case"hr":case"h":return p*o;case"minutes":case"minute":case"mins":case"min":case"m":return p*n;case"seconds":case"second":case"secs":case"sec":case"s":return p*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function h(f){var _=Math.abs(f);return _>=s?Math.round(f/s)+"d":_>=o?Math.round(f/o)+"h":_>=n?Math.round(f/n)+"m":_>=r?Math.round(f/r)+"s":f+"ms"}function u(f){var _=Math.abs(f);return _>=s?d(f,_,s,"day"):_>=o?d(f,_,o,"hour"):_>=n?d(f,_,n,"minute"):_>=r?d(f,_,r,"second"):f+" ms"}function d(f,_,p,y){var w=_>=p*1.5;return Math.round(f/p)+" "+y+(w?"s":"")}}}),require_common=__commonJS({"node_modules/.pnpm/debug@4.3.4_supports-color@8.1.1/node_modules/debug/src/common.js"(e,t){init_inject_globals();function r(n){s.debug=s,s.default=s,s.coerce=d,s.disable=l,s.enable=c,s.enabled=h,s.humanize=require_ms(),s.destroy=f,Object.keys(n).forEach(_=>{s[_]=n[_]}),s.names=[],s.skips=[],s.formatters={};function o(_){let p=0;for(let y=0;y<_.length;y++)p=(p<<5)-p+_.charCodeAt(y),p|=0;return s.colors[Math.abs(p)%s.colors.length]}s.selectColor=o;function s(_){let p,y=null,w,E;function x(...B){if(!x.enabled)return;const P=x,U=Number(new Date),F=U-(p||U);P.diff=F,P.prev=p,P.curr=U,p=U,B[0]=s.coerce(B[0]),typeof B[0]!="string"&&B.unshift("%O");let G=0;B[0]=B[0].replace(/%([a-zA-Z%])/g,(H,te)=>{if(H==="%%")return"%";G++;const J=s.formatters[te];if(typeof J=="function"){const le=B[G];H=J.call(P,le),B.splice(G,1),G--}return H}),s.formatArgs.call(P,B),(P.log||s.log).apply(P,B)}return x.namespace=_,x.useColors=s.useColors(),x.color=s.selectColor(_),x.extend=a,x.destroy=s.destroy,Object.defineProperty(x,"enabled",{enumerable:!0,configurable:!1,get:()=>y!==null?y:(w!==s.namespaces&&(w=s.namespaces,E=s.enabled(_)),E),set:B=>{y=B}}),typeof s.init=="function"&&s.init(x),x}function a(_,p){const y=s(this.namespace+(typeof p>"u"?":":p)+_);return y.log=this.log,y}function c(_){s.save(_),s.namespaces=_,s.names=[],s.skips=[];let p;const y=(typeof _=="string"?_:"").split(/[\s,]+/),w=y.length;for(p=0;p<w;p++)y[p]&&(_=y[p].replace(/\*/g,".*?"),_[0]==="-"?s.skips.push(new RegExp("^"+_.slice(1)+"$")):s.names.push(new RegExp("^"+_+"$")))}function l(){const _=[...s.names.map(u),...s.skips.map(u).map(p=>"-"+p)].join(",");return s.enable(""),_}function h(_){if(_[_.length-1]==="*")return!0;let p,y;for(p=0,y=s.skips.length;p<y;p++)if(s.skips[p].test(_))return!1;for(p=0,y=s.names.length;p<y;p++)if(s.names[p].test(_))return!0;return!1}function u(_){return _.toString().substring(2,_.toString().length-2).replace(/\.\*\?$/,"*")}function d(_){return _ instanceof Error?_.stack||_.message:_}function f(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}t.exports=r}}),require_browser5=__commonJS({"node_modules/.pnpm/debug@4.3.4_supports-color@8.1.1/node_modules/debug/src/browser.js"(e,t){init_inject_globals(),e.formatArgs=n,e.save=o,e.load=s,e.useColors=r,e.storage=a(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const h="color: "+this.color;l.splice(1,0,h,"color: inherit");let u=0,d=0;l[0].replace(/%[a-zA-Z%]/g,f=>{f!=="%%"&&(u++,f==="%c"&&(d=u))}),l.splice(d,0,h)}e.log=console.debug||console.log||(()=>{});function o(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function s(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&typeof process$1<"u"&&"env"in process$1&&(l=process$1.env.DEBUG),l}function a(){try{return localStorage}catch{}}t.exports=require_common()(e);var{formatters:c}=t.exports;c.j=function(l){try{return JSON.stringify(l)}catch(h){return"[UnexpectedJSONParseError]: "+h.message}}}}),require_hypercore_protocol=__commonJS({"node_modules/.pnpm/hypercore-protocol@8.0.7/node_modules/hypercore-protocol/index.js"(e,t){init_inject_globals();var r=require_simple_hypercore_protocol(),n=require_hypercore_crypto(),o=require_browser4(),s=require_browser(),a=require_nanoguard(),c=require_pretty_hash(),l=require_abstract_extension(),{Duplex:h}=import$streamx,u=require_browser5()("hypercore-protocol"),d=class extends l{send(p){const y=this.local.handlers;return y._changes!==this.local.changes&&(y._changes=this.local.changes,y.state.options(0,{extensions:this.local.names()})),y.state.extension(0,this.id,this.encode(p))}},f=class{constructor(p,{encrypted:y,noise:w,keyPair:E}){this.stream=p,this.created=new Map,this.local=[null],this.remote=[null],this.noise=!(w===!1&&y===!1),this.encrypted=y!==!1,this.keyPair=E}allocLocal(){const p=this.local.indexOf(null);return p>0?p:(this.local.push(null),this.local.length-1)}attachLocal(p){const y=this.allocLocal();this.local[y]=p,p.localId=y}attachRemote(p,y){this.remote.length===y&&this.remote.push(null),this.remote[y]=p,p.remoteId=y}detachChannel(p){p.localId>-1&&this.local[p.localId]===p&&(this.local[p.localId]=null,p.localId=-1,p.handlers&&p.handlers.onclose&&p.handlers.onclose()),p.remoteId>-1&&this.remote[p.remoteId]===p&&(this.remote[p.remoteId]=null);const y=p.discoveryKey.toString("hex");this.created.get(y)===p&&this.created.delete(y)}getChannel(p){return this.created.get(p.toString("hex"))}createChannel(p){const y=p.toString("hex"),w=this.created.get(y);if(w)return w;const E=new _(this.stream.state,this.stream,p);return this.created.set(y,E),E}onauthenticate(p,y){this.stream.handlers&&this.stream.handlers.onauthenticate?this.stream.handlers.onauthenticate(p,y):y(null)}onhandshake(){u("recv handshake"),this.stream.handlers&&this.stream.handlers.onhandshake&&this.stream.handlers.onhandshake(),this.stream.emit("handshake")}onopen(p,y){u("recv open",p,y);const w=this.createChannel(y.discoveryKey);if(w.remoteCapability=y.capability,this.attachRemote(w,p),w.localId===-1)this.stream.handlers.ondiscoverykey&&this.stream.handlers.ondiscoverykey(w.discoveryKey),this.stream.emit("discovery-key",w.discoveryKey);else{if(this.noise&&!w.remoteVerified){this.stream.destroy(new Error("Invalid remote channel capability"));return}this.stream.emit("duplex-channel",w)}w.handlers&&w.handlers.onopen&&w.handlers.onopen(),this.stream.handlers.onremoteopen&&this.stream.handlers.onremoteopen(w.discoveryKey),this.stream.emit("remote-open",w.discoveryKey)}onoptions(p,y){u("recv options",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onoptions?w.handlers.onoptions(y):p===0&&!w&&this.stream._updateExtensions(y.extensions)}onstatus(p,y){u("recv status",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onstatus&&w.handlers.onstatus(y)}onhave(p,y){u("recv have",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onhave&&w.handlers.onhave(y)}onunhave(p,y){u("recv unhave",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onunhave&&w.handlers.onunhave(y)}onwant(p,y){u("recv want",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onwant&&w.handlers.onwant(y)}onunwant(p,y){u("recv unwant",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onunwant&&w.handlers.onunwant(y)}onrequest(p,y){u("recv request",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.onrequest&&w.handlers.onrequest(y)}oncancel(p,y){u("recv cancel",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.oncancel&&w.handlers.oncancel(y)}ondata(p,y){u("recv data",p,y);const w=this.remote[p];w&&w.handlers&&w.handlers.ondata&&w.handlers.ondata(y)}onextension(p,y,w){u("recv extension",p,y);const E=this.remote[p];E&&E.handlers&&E.handlers.onextension?E.handlers.onextension(y,w):p===0&&!E&&this.stream.remoteExtensions.onmessage(y,w)}onclose(p,y){u("recv close",p,y);let w=p<this.remote.length?this.remote[p]:null;if(w?this.remote[p]=null:y.discoveryKey&&(w=this.getChannel(y.discoveryKey)),!w)return;w.localId>-1&&this.local[w.localId]===w&&(this.local[w.localId]=null,w.state.close(w.localId,{}),w.localId=-1,w.handlers&&w.handlers.onclose&&w.handlers.onclose()),this.stream.handlers&&this.stream.handlers.onchannelclose&&this.stream.handlers.onchannelclose(w.discoveryKey,w.key);const E=w.discoveryKey.toString("hex");this.created.get(E)===w&&this.created.delete(E),this.stream._prefinalize()}onmissing(p){this.stream._utp!==null&&this.stream._utp.setContentSize(p)}send(p){return this.stream.keepAlive!==null&&this.stream.keepAlive.refresh(),this.stream.bytesSent+=p.length,this.stream.push(p)}destroy(p){this.stream.destroy(p),this.local=[],this.remote=[];for(const y of this.created.values()){const w=y.localId===-1;y.localId=y.remoteId=-1,!w&&y.handlers&&y.handlers.onclose&&y.handlers.onclose(),this.stream.handlers&&this.stream.handlers.onchannelclose&&this.stream.handlers.onchannelclose(y.discoveryKey,y.key)}this.created.clear()}},_=class{constructor(p,y,w){this.key=null,this.discoveryKey=w,this.localId=-1,this.remoteId=-1,this.remoteCapability=null,this.handlers=null,this.state=p,this.stream=y}get opened(){return this.localId>-1}get closed(){return this.localId===-1}get remoteOpened(){return this.remoteId>-1}get remoteVerified(){return this.localId>-1&&this.remoteId>-1&&!!this.remoteCapability&&this.remoteCapability.equals(this.state.remoteCapability(this.key))}options(p){return u("send options",p),this.state.options(this.localId,p)}status(p){return u("send status",p),this.state.status(this.localId,p)}have(p){return u("send have",p),this.state.have(this.localId,p)}unhave(p){return u("send unhave",p),this.state.unhave(this.localId,p)}want(p){return u("send want",p),this.state.want(this.localId,p)}unwant(p){return u("send unwant",p),this.state.unwant(this.localId,p)}request(p){return u("send request",p),this.state.request(this.localId,p)}cancel(p){return u("send cancel",p),this.state.cancel(this.localId,p)}data(p){return u("send data",p),this.state.data(this.localId,p)}extension(p,y){return u("send extension",p),this.state.extension(this.localId,p,y)}close(){if(u("send close"),this.closed)return;const p=this.localId;this.stream.channelizer.detachChannel(this),this.state.close(p,{}),this.stream._prefinalize()}destroy(p){this.stream.destroy(p)}};t.exports=class Js extends h{constructor(y,w={}){if(super(),typeof y!="boolean")throw new Error("Must specify initiator boolean in replication stream");if(this.initiator=y,this.handlers=w,this.channelizer=new f(this,{encrypted:w.encrypted,noise:w.noise,keyPair:w.keyPair}),this.state=new r(y,this.channelizer),this.live=!!w.live,this.timeout=null,this.keepAlive=null,this.prefinalize=new a,this.bytesSent=0,this.bytesReceived=0,this.extensions=d.createLocal(this),this.remoteExtensions=this.extensions.remote(),this._utp=null,this._changes=0,this.once("finish",this.push.bind(this,null)),this.on("pipe",this._onpipe),w.timeout!==!1&&w.timeout!==0){const E=w.timeout||2e4;this.setTimeout(E,()=>this.destroy(new Error("ETIMEDOUT"))),this.setKeepAlive(Math.ceil(E/2))}}registerExtension(y,w){return this.extensions.add(y,w)}[s](y,w){let E="";if(typeof w.indentationLvl=="number")for(;E.length<w.indentationLvl;)E+=" ";return`HypercoreProtocolStream(
`+E+"  publicKey: "+w.stylize(this.publicKey&&c(this.publicKey),"string")+`
`+E+"  remotePublicKey: "+w.stylize(this.remotePublicKey&&c(this.remotePublicKey),"string")+`
`+E+"  remoteAddress: "+w.stylize(this.remoteAddress,"string")+`
`+E+"  remoteType: "+w.stylize(this.remoteType,"string")+`
`+E+"  live: "+w.stylize(this.live,"boolean")+`
`+E+"  initiator: "+w.stylize(this.initiator,"boolean")+`
`+E+"  channelCount: "+w.stylize(this.channelCount,"number")+`
`+E+"  destroyed: "+w.stylize(this.destroyed,"boolean")+`
`+E+"  prefinalized: "+w.stylize(!this.prefinalize.waiting,"boolean")+`
`+E+"  bytesSent: "+w.stylize(this.bytesSent,"number")+`
`+E+"  bytesReceived: "+w.stylize(this.bytesReceived,"number")+`
`+E+")"}static isProtocolStream(y){return!!(y&&typeof y.initiator=="boolean"&&typeof y.pipe=="function"&&y.state)}static keyPair(y){return r.keyPair(y)}get remoteAddress(){const y=this._readableState.pipeTo;return!y||Js.isProtocolStream(y)?null:y.remoteAddress}get remoteType(){const y=this._readableState.pipeTo;return y?y._utp?"utp":y.remoteAddress?"tcp":"unknown":null}get publicKey(){return this.state.publicKey}get remotePublicKey(){return this.state.remotePublicKey}_onpipe(y){typeof y.setContentSize=="function"&&(this._utp=y)}_write(y,w){this.timeout!==null&&this.timeout.refresh(),this.bytesReceived+=y.length,this.state.recv(y),w(null)}_destroy(y){this._predestroy(),this.channelizer.destroy(),this.state.destroy(),y(null)}_predestroy(){this.timeout!==null&&(this.timeout.destroy(),this.timeout=null),this.keepAlive!==null&&(this.keepAlive.destroy(),this.keepAlive=null),this.prefinalize.destroy()}_prefinalize(){this.emit("prefinalize"),this.prefinalize.ready(()=>{this.destroyed||this.channelCount||this.live||this.finalize()})}_updateExtensions(y){this.remoteExtensions.update(y),this.handlers.onextensions&&this.handlers.onextensions(y),this.emit("extensions",y)}remoteOpened(y){const w=this.channelizer.getChannel(n.discoveryKey(y));return!!(w&&w.remoteId>-1)}remoteVerified(y){const w=this.channelizer.getChannel(n.discoveryKey(y));return!!w&&!!w.remoteCapability&&w.remoteCapability.equals(this.state.remoteCapability(y))}opened(y){const w=this.channelizer.getChannel(n.discoveryKey(y));return!!(w&&w.localId>-1)}ping(){return this.state.ping()}setKeepAlive(y){if(this.keepAlive&&this.keepAlive.destroy(),!y){this.keepAlive=null;return}this.keepAlive=o(y,w,this);function w(){this.ping(),this.keepAlive=o(y,w,this)}}setTimeout(y,w){if(this.timeout&&this.timeout.destroy(),!y){this.timeout=null;return}this.timeout=o(y,this.emit.bind(this,"timeout")),w&&this.once("timeout",w)}get channelCount(){return this.channelizer.created.size}get channels(){return this.channelizer.created.values()}open(y,w){const E=n.discoveryKey(y),x=this.channelizer.createChannel(E);return x.key===null&&(x.key=y,this.channelizer.attachLocal(x),this.state.open(x.localId,{key:y,discoveryKey:E})),w&&(x.handlers=w),x.remoteId>-1&&this.emit("duplex-channel",x),x}close(y){const w=this.channelizer.getChannel(y);if(w&&w.localId>-1){w.close();return}this.state.close(this.channelizer.allocLocal(),{discoveryKey:y})}finalize(){this.push(null)}}}}),require_ctz=__commonJS({"node_modules/.pnpm/count-trailing-zeros@1.0.1/node_modules/count-trailing-zeros/ctz.js"(e,t){init_inject_globals(),t.exports=function(r){var n=32;return r&=-r,r&&n--,r&65535&&(n-=16),r&16711935&&(n-=8),r&252645135&&(n-=4),r&858993459&&(n-=2),r&1431655765&&(n-=1),n}}}),require_fast_bitfield=__commonJS({"node_modules/.pnpm/fast-bitfield@1.2.2/node_modules/fast-bitfield/index.js"(e,t){init_inject_globals();var r=require_ctz();t.exports=()=>new h;var n=class{constructor(_){const p=new Uint8Array(_?8456:4360),y=p.byteOffset;this.buffer=p,this.bits=_?null:new Uint32Array(p.buffer,y,1024),this.children=_?new Array(32768):null,this.level=_,this.allOne=_?[new Uint32Array(p.buffer,y,1024),new Uint32Array(p.buffer,y+4096,32),new Uint32Array(p.buffer,y+4224,1)]:[this.bits,new Uint32Array(p.buffer,y+4096,32),new Uint32Array(p.buffer,y+4224,1)],this.oneOne=_?[new Uint32Array(p.buffer,y+4228,1024),new Uint32Array(p.buffer,y+8324,32),new Uint32Array(p.buffer,y+8452,1)]:[this.bits,new Uint32Array(p.buffer,y+4228,32),new Uint32Array(p.buffer,y+4356,1)]}},o=[new n(0),new n(1),new n(2),new n(3)],s=new Uint32Array(32),a=new Uint32Array(32);for(c=0;c<32;c++)s[c]=Math.pow(2,31-c)-1,a[c]=Math.pow(2,32-c)-1;var c,l=new Uint8Array(s.buffer,s.byteOffset,1)[0]===255,h=class{constructor(){this.length=32768,this.littleEndian=l,this._path=new Uint16Array(5),this._offsets=new Uint16Array(this._path.buffer,this._path.byteOffset+2,4),this._parents=new Array(4).fill(null),this._page=new n(0),this._allocs=1}last(){for(var _=this._page,p=0;;){for(var y=2;y>=0;y--){const w=r(_.oneOne[y][p]);if(w===32)return-1;p=(p<<5)+(31-w)}if(this._path[_.level]=p,!_.level)return d(this._path);_=_.children[p],p=0}}set(_,p){const y=this._getPage(_,p);if(!y)return!1;const w=this._path[0],E=w&31,x=w>>>5,B=y.bits[x];y.bits[x]=p?B|2147483648>>>E:B&~(2147483648>>>E);const P=y.bits[x];return P===B?!1:(this._updateAllOne(y,x,P),this._updateOneOne(y,x,P),!0)}get(_){const p=this._getPage(_,!1);if(!p)return!1;const y=this._path[0],w=y&31;return(p.bits[y>>>5]&2147483648>>>w)!==0}iterator(){return new u(this)}fill(_,p,y){if(p||(p=0),_===!0)return this._fillBit(!0,p,y===0?y:y||this.length);if(_===!1)return this._fillBit(!1,p,y===0?y:y||this.length);this._fillBuffer(_,p,y===0?y:y||p+8*_.length)}grow(){if(this._page.level===3)throw new Error("Cannot grow beyond "+this.length);const _=this._page;this._page=new n(_.level+1),this._page.children[0]=_,this._page.level===3?this.length=Number.MAX_SAFE_INTEGER:this.length*=32768}_fillBuffer(_,p,y){if(p&7||y&7)throw new Error("Offsets must be a multiple of 8");for(p/=8;y>this.length;)this.grow();y/=8;const w=p;for(var E=this._getPage(8*p,!0);p<y;){const x=y-p<4096?y-p:4096,B=p-w;p+=this._setPageBuffer(E,_.subarray(B,B+x),p&1023),p!==y&&(E=this._nextPage(E,8*p))}}_fillBit(_,p,y){for(var w=this._getPage(p,_);p<y;){const E=y-p<32768?y-p:32768;p+=this._setPageBits(w,_,p&32767,E),p!==y&&(w=this._nextPage(w,p))}}_nextPage(_,p){const y=++this._offsets[_.level];return y===32768?this._getPage(p,!0):this._parents[_.level].children[y]||this._addPage(this._parents[_.level],y)}_setPageBuffer(_,p,y){return new Uint8Array(_.bits.buffer,_.bits.byteOffset,_.bits.length*4).set(p,y),y>>>=2,this._update(_,y,y+(p.length>>>2)+(p.length&3?1:0)),p.length}_setPageBits(_,p,y,w){const E=y>>>5,x=w>>>5,B=4294967295>>>(y&31),P=~(4294967295>>>(w&31));return E===x?(_.bits[E]=p?_.bits[E]|B&P:_.bits[E]&~(B&P),this._update(_,E,E+1),w-y):(_.bits[E]=p?_.bits[E]|B:_.bits[E]&~B,x-E>2&&_.bits.fill(p?4294967295:0,E+1,x-1),x===1024?(_.bits[x-1]=p?4294967295:0,this._update(_,E,x),w-y):(_.bits[x]=p?_.bits[x]|P:_.bits[x]&~P,this._update(_,E,x+1),w-y))}_update(_,p,y){for(;p<y;p++){const w=_.bits[p];this._updateAllOne(_,p,w),this._updateOneOne(_,p,w)}}_updateAllOne(_,p,y){var w=1;do{for(;w<3;w++){const E=_.allOne[w],x=p&31,B=E[p>>>=5];if(E[p]=y===4294967295?B|2147483648>>>x:B&~(2147483648>>>x),y=E[p],y===B)return}p+=this._offsets[_.level],_=this._parents[_.level],w=0}while(_)}_updateOneOne(_,p,y){var w=1;do{for(;w<3;w++){const E=_.oneOne[w],x=p&31,B=E[p>>>=5];if(E[p]=y!==0?B|2147483648>>>x:B&~(2147483648>>>x),y=E[p],y===B)return}p+=this._offsets[_.level],_=this._parents[_.level],w=0,y===0&&_&&(_.children[this._offsets[_.level-1]]=void 0)}while(_)}_getPage(_,p){for(f(_,this._path);_>=this.length;){if(!p)return null;this.grow()}for(var y=this._page,w=y.level;w>0&&y;w--){const E=this._path[w];this._parents[w-1]=y,y=y.children[E]||(p?this._addPage(y,E):null)}return y}_addPage(_,p){return this._allocs++,_=_.children[p]=new n(_.level-1),_}},u=class{constructor(_){this._bitfield=_,this._path=new Uint16Array(5),this._offsets=new Uint16Array(this._path.buffer,this._path.byteOffset+2,4),this._parents=new Array(4).fill(null),this._page=null,this._allocs=_._allocs,this.seek(0)}seek(_){if(this._allocs=this._bitfield._allocs,_>=this._bitfield.length)return this._page=null,this;f(_,this._path),this._page=this._bitfield._page;for(var p=this._page.level;p>0;p--)this._parents[p-1]=this._page,this._page=this._page.children[this._path[p]]||o[p-1];return this}next(_){return _?this.nextTrue():this.nextFalse()}nextFalse(){this._allocs!==this._bitfield._allocs&&this.seek(d(this._path));for(var _=this._page,p=this._path[0],y=a;_;){for(var w=0;w<3;w++){const E=p&31,x=Math.clz32(~_.allOne[w][p>>>=5]&y[E]);if(x!==32)return this._downLeftFalse(_,w,p,x);y=s}p=this._offsets[_.level],_=this._parents[_.level]}return-1}_downLeftFalse(_,p,y,w){for(;;){for(;p;)y=(y<<5)+w,w=Math.clz32(~_.allOne[--p][y]);if(y=(y<<5)+w,!_.level)break;this._parents[_.level-1]=_,this._path[_.level]=y,_=_.children[y],p=3,w=y=0}return this._page=_,this._path[0]=y,this._inc()}nextTrue(){for(var _=this._page,p=this._path[0],y=a;_;){for(var w=0;w<3;w++){const E=p&31,x=Math.clz32(_.oneOne[w][p>>>=5]&y[E]);if(x!==32)return this._downLeftTrue(_,w,p,x);y=s}p=this._offsets[_.level],_=this._parents[_.level]}return-1}_downLeftTrue(_,p,y,w){for(;;){for(;p;)y=(y<<5)+w,w=Math.clz32(_.oneOne[--p][y]);if(y=(y<<5)+w,!_.level)break;this._parents[_.level-1]=_,this._path[_.level]=y,_=_.children[y],p=3,w=y=0}return this._page=_,this._path[0]=y,this._inc()}_inc(){const _=d(this._path);return this._path[0]<32767?this._path[0]++:this.seek(_+1),_}};function d(_){return((_[3]*32768+_[2])*32768+_[1])*32768+_[0]}function f(_,p){_=(_-(p[0]=_&32767))/32768,_=(_-(p[1]=_&32767))/32768,p[3]=(_-(p[2]=_&32767))/32768&32767}}}),require_replicate=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/lib/replicate.js"(e,t){init_inject_globals();var r=require_hypercore_protocol(),n=require_browser4(),o=require_fast_bitfield(),s=require_unordered_set(),a=require_bitfield_rle().align(4),c=require_tree_index(),l=new Uint8Array(1024);t.exports=h;function h(p,y,w){p.ifAvailable.wait();var E=r.isProtocolStream(y)?y:w.stream;return E||(w.keyPair||(w.keyPair=p.noiseKeyPair),E=new r(y,w)),p.opened?x(null):p.ready(x),E;function x(F){if(p.ifAvailable.continue(),F)return E.destroy(F);if(!E.destroyed&&!E.opened(p.key)){if(w.noise!==!1&&w.onfeedauthenticate){if(!E.remotePublicKey){p.ifAvailable.wait(),E.setMaxListeners(0),E.on("close",B),E.on("handshake",B);return}P();return}U()}}function B(){p.ifAvailable.continue(),E.off("close",B),E.off("handshake",B),P()}function P(){E.destroyed||E.opened(p.key)||(p.ifAvailable.wait(),w.onfeedauthenticate(p,E.remotePublicKey,function(F){if(p.ifAvailable.continue(),!E.destroyed&&!E.opened(p.key)){if(F){E.close(p.discoveryKey);return}U()}}))}function U(){if(w.noise!==!1&&E.remoteOpened(p.key)&&!E.remoteVerified(p.key)){E.close(p.discoveryKey);return}var F=new u(p,w);F.feed=p,F.stream=E.open(p.key,F),E.setMaxListeners(0),F.ready(),p.emit("replicating",E)}}function u(p,y){if(y.extensions)throw new Error("Per peer extensions is not supported. Use feed.registerExtension instead");this.feed=p,this.stream=null,this.wants=o(),this.remoteBitfield=o(),this.remoteLength=0,this.remoteWant=!1,this.remoteTree=null,this.remoteAck=!1,this.remoteOpened=!1,this.live=!!y.live,this.sparse=p.sparse,this.ack=!!y.ack,this.remoteDownloading=!0,this.remoteUploading=!0,this.remoteExtensions=p.extensions.remote(),this.downloading=typeof y.download=="boolean"?y.download:p.downloading,this.uploading=typeof y.upload=="boolean"?y.upload:p.uploading,this.updated=!1,this.maxRequests=y.maxRequests||p.maxRequests||16,this.urgentRequests=this.maxRequests+16,this.inflightRequests=[],this.inflightWants=0,this._index=-1,this._lastBytes=0,this._first=!0,this._closed=!1,this._destroyed=!1,this._defaultDownloading=this.downloading,this._iterator=this.remoteBitfield.iterator(),this._requestTimeout=null,this.stats=y.stats?{uploadedBytes:0,uploadedBlocks:0,downloadedBytes:0,downloadedBlocks:0}:null}Object.defineProperty(u.prototype,"remoteAddress",{enumerable:!0,get:function(){return this.stream.stream.remoteAddress}}),Object.defineProperty(u.prototype,"remoteType",{enumerable:!0,get:function(){return this.stream.stream.remoteType}}),Object.defineProperty(u.prototype,"remotePublicKey",{enumerable:!0,get:function(){return this.stream.state.remotePublicKey}}),u.prototype.onwant=function(p){if(this.uploading&&!(p.start&8191||p.length&8191)){!this.remoteWant&&this.feed.length&&this.feed.bitfield.get(this.feed.length-1)&&this.stream.have({start:this.feed.length-1}),this.remoteWant=!0;var y=this.feed.bitfield.compress(p.start,p.length);this.stream.have({start:p.start,length:p.length,bitfield:y})}},u.prototype.ondata=function(p){var y=this,w=this.feed.allowPush||!p.value;if(!w&&!this.feed._reserved.get(p.index)){y.feed.bitfield.get(p.index)||y.unhave({start:p.index}),y._clear(p.index,!p.value);return}this.feed._putBuffer(p.index,p.value,p,this,function(E){if(E)return y.destroy(E);p.value&&y.remoteBitfield.set(p.index,!1),y.remoteAck&&y.stream.have({start:p.index,length:1,ack:!0}),y.stats&&p.value&&(y.stats.downloadedBlocks+=1,y.stats.downloadedBytes+=p.value.length),y._clear(p.index,!p.value)})},u.prototype._clear=function(p,y){for(var w=0;w<this.inflightRequests.length;w++)this.inflightRequests[w].index===p&&(this._requestTimeout!==null&&this._requestTimeout.refresh(),this.inflightRequests.splice(w,1),w--);this.feed._reserved.set(p,!1),this.feed._updatePeers(),this.inflightRequests.length===0&&this._requestTimeout!==null&&(this._requestTimeout.destroy(),this._requestTimeout=null)},u.prototype.onrequest=function(p){if(!this.uploading)return;if(p.bytes)return this._onbytes(p);this.remoteTree||(this.remoteTree=c());var y=this,w={digest:p.nodes,hash:p.hash,tree:this.remoteTree};this.feed.proof(p.index,w,E);function E(x,B){if(x)return y.destroy(x);p.hash?P(null,null):y.feed.bitfield.get(p.index)&&y.feed._getBuffer(p.index,P);function P(U,F){if(y.uploading){if(U)return y.destroy(U);F&&(y.stats&&(y.stats.uploadedBlocks+=1,y.stats.uploadedBytes+=F.length,y.feed._stats.uploadedBlocks+=1,y.feed._stats.uploadedBytes+=F.length),y.feed.emit("upload",p.index,F,y)),p.index+1>y.remoteLength&&(y.remoteLength=p.index+1,y._updateEnd()),y.stream.data({index:p.index,value:F,nodes:B.nodes,signature:B.signature})}}}},u.prototype._updateOptions=function(){(this.ack||this.feed.extensions.length)&&this.stream.options({ack:this.ack,extensions:this.feed.extensions.names()})},u.prototype.setDownloading=function(p){p!==this.downloading&&(this.downloading=p,this.stream.status({downloading:p,uploading:this.uploading}),this.update())},u.prototype.setUploading=function(p){p!==this.uploading&&(this.uploading=p,this.stream.status({downloading:this.downloading,uploading:p}),this.update())},u.prototype._onbytes=function(p){var y=this;this.feed.seek(p.bytes,{wait:!1},function(w,E){if(w){p.bytes=0,y.onrequest(p);return}y._lastBytes!==p.bytes&&(y._lastBytes=p.bytes,p.bytes=0,p.index=E,p.nodes=0,y.onrequest(p))})},u.prototype._onrequesttimeout=function(){if(this._requestTimeout=null,!!this.inflightRequests.length){var p=this.inflightRequests[0];if(p.hash?this.feed.tree.get(2*p.index):this.feed.bitfield.get(p.index)){this.inflightRequests.shift(),this.feed._reserved.set(p.index,!1),this.stream.stream.timeout&&(this._requestTimeout=n(this.stream.stream.timeout.ms,this._onrequesttimeout,this));return}this.destroy(new Error("Request timeout"))}},u.prototype.onhave=function(p){if(this.feed.emit("peer-ack",this,p),this.ack&&p.ack&&!p.bitfield&&this.feed.bitfield.get(p.start)){this.stream.stream.emit("ack",p);return}var y=this._first;if(this._first&&(this._first=!1),p.length===1024*1024&&this.inflightWants>0&&(this.feed.ifAvailable.continue(),this.inflightWants--),p.bitfield){(p.length===0||p.length===1)&&(this.wants=null);var w=a.decode(p.bitfield),E=w.length*8;f(this.feed.bitfield,w,this.remoteBitfield.littleEndian,p.start),this.remoteBitfield.fill(w,p.start),E>this.remoteLength&&(this.remoteLength=this.remoteBitfield.last()+1,y=!0)}else{for(var x=p.start,B=p.length||1;B--;)this.remoteBitfield.set(x,!this.feed.bitfield.get(x++));x>this.remoteLength&&(this.remoteLength=x,y=!0)}y&&(this.updated=!0,this.feed.emit("remote-update",this)),this._updateEnd(),this.update()},u.prototype._updateEnd=function(){if(!(this.live||this.feed.sparse||!this.feed._selections.length)){for(var p=this.feed._selections[0],y=this.feed.length||-1,w=0;w<this.feed.peers.length;w++)this.feed.peers[w].remoteLength>y&&(y=this.feed.peers[w].remoteLength);p.end=y}},u.prototype.onextension=function(p,y){this.remoteExtensions.onmessage(p,y,this)},u.prototype.onstatus=function(p){if(this.remoteUploading=p.uploading,this.remoteDownloading=p.downloading,!p.uploading){for(;this.inflightRequests.length;){const w=this.inflightRequests[0];this._clear(w.index,!w.value)}for(var y=0;y<this.inflightWants;y++)this.feed.ifAvailable.continue();this.inflightWants=0,this.wants=o()}this.update(),!(p.downloading||this.live)&&(this.feed._selections.length&&this.downloading||this._autoEnd())},u.prototype._autoEnd=function(){this.uploading&&this.remoteDownloading||(this.sparse||this.live)&&(this.remoteUploading||this.downloading)||this.end()},u.prototype.onunhave=function(p){var y=p.start,w=p.length||1;if(y===0&&w>=this.remoteLength){this.remoteLength=0,this.remoteBitfield=o();return}for(;w--;)this.remoteBitfield.set(y++,!1)},u.prototype.onunwant=u.prototype.oncancel=function(){},u.prototype.onclose=function(){this._close()},u.prototype.have=function(p){this.stream&&this.remoteWant&&this.stream.have(p);for(var y=p.start,w=p.length;w--;)this.remoteBitfield.set(y++,!1)},u.prototype.unhave=function(p){this.stream&&this.remoteWant&&this.stream.unhave(p)},u.prototype.haveBytes=function(p){for(var y=0;y<this.inflightRequests.length;y++)this.inflightRequests[y].bytes===p&&(this.feed._reserved.set(this.inflightRequests[y].index,!1),this.inflightRequests.splice(y,1),y--);this.update(),this.inflightRequests.length===0&&this._requestTimeout!==null&&(this._requestTimeout.destroy(),this._requestTimeout=null)},u.prototype.update=function(){for(;this._update(););this._sendWantsMaybe()},u.prototype._update=function(){if(!this.downloading||!this.remoteUploading)return!1;for(var p=this.feed._selections,y=this.feed._waiting,w=y.length,E=p.length,x=this.inflightRequests.length,B=0,P=0;x<this.urgentRequests;){for(B=Math.floor(Math.random()*y.length),P=0;P<y.length;P++){var U=y[B++];if(B===y.length&&(B=0),this._downloadWaiting(U),y.length!==w)return!0;if(this.inflightRequests.length>=this.urgentRequests)return!1}if(x===this.inflightRequests.length)break;x=this.inflightRequests.length}for(;x<this.maxRequests;){for(B=Math.floor(Math.random()*p.length),P=0;P<p.length;P++){var F=p[B++];if(B===p.length&&(B=0),F.iterator||(F.iterator=this.feed.bitfield.iterator(F.start,F.end)),F.blocks?this._downloadBlocks(F):this._downloadRange(F),p.length!==E)return!0;if(this.inflightRequests.length>=this.maxRequests)return!1}if(x===this.inflightRequests.length)return!1;x=this.inflightRequests.length}return!1},u.prototype.onopen=function(){this.feed.ifAvailable.continue(),this.remoteOpened=!0,this._updateOptions(),(!this.uploading||!this.downloading)&&this.stream.status({uploading:this.uploading,downloading:this.downloading}),this._sendWants(),this.feed.emit("peer-open",this)},u.prototype.onoptions=function(p){this.remoteAck=p.ack,this.remoteExtensions.update(p.extensions)},u.prototype.ready=function(){this.feed.ifAvailable.wait(),s.add(this.feed.peers,this),this.feed.emit("peer-add",this),this.stream.remoteOpened&&this.onopen()},u.prototype.end=function(){if(!this.downloading&&!this.remoteDownloading&&!this.live){this._defaultDownloading||this.stream.status({downloading:!1,uploading:!1}),this._close();return}this._closed?this.live||this._close():(this._closed=!0,this.downloading=!1,this.stream.status({downloading:!1,uploading:!0}))},u.prototype._close=function(){if(this._destroyed||(this._destroyed=!0,this.stream.close()),this._index!==-1){s.remove(this.feed.peers,this),this._index=-1;for(var p=0;p<this.inflightRequests.length;p++)this.feed._reserved.set(this.inflightRequests[p].index,!1);for(this._requestTimeout!==null&&(this._requestTimeout.destroy(),this._requestTimeout=null),this._updateEnd(),this.remoteWant=!1,this.feed._updatePeers(),this.feed.emit("peer-remove",this),p=0;p<this.inflightWants;p++)this.feed.ifAvailable.continue();this.remoteOpened||this.feed.ifAvailable.continue()}},u.prototype.destroy=function(p){this._index===-1||this._destroyed||(this.stream.destroy(p),this._destroyed=!0,this._close())},u.prototype._sendWantsMaybe=function(){this.inflightRequests.length<this.urgentRequests&&this._sendWants()},u.prototype._sendWants=function(){if(!(!this.wants||!this.downloading||!this.remoteOpened||!this.remoteUploading)&&!(this.inflightWants>=16)){var p;for(p=0;p<this.feed._waiting.length;p++){var y=this.feed._waiting[p];if(y.index===-1?this._sendWantRange(y):this._sendWant(y.index),this.inflightWants>=16)return}for(p=0;p<this.feed._selections.length;p++){var w=this.feed._selections[p];if(this._sendWantRange(w),this.inflightWants>=16)return}this._sendWant(0)}},u.prototype._sendWantRange=function(p){if(p.blocks){if(p.selected||(p.selected=new WeakSet),p.selected.has(this))return;p.selected.add(this);for(const w of p.blocks)this._sendWant(w);return}for(var y=p.start?1024*1024*Math.floor(p.start/1024/1024):0;;){if(y>=this.remoteLength||p.end!==-1&&y>=p.end||this._sendWant(y)||!this.wants.get(Math.floor(y/1024/1024)))return;y+=1024*1024}},u.prototype._sendWant=function(p){var y=1048576,w=Math.floor(p/y);return this.wants.get(w)?!1:(this.wants.set(w,!0),this.inflightWants++,this.feed.ifAvailable.wait(),this.stream.want({start:w*y,length:y}),!0)},u.prototype._downloadWaiting=function(p){if(!p.bytes){if(!this.remoteBitfield.get(p.index)||!this.feed._reserved.set(p.index,!0)){if(!p.update||this.feed._reserved.get(p.index))return;const y=this._iterator.seek(p.index).next(!0);if(y===-1||!this.feed._reserved.set(y,!0))return;p.index=y}this._request(p.index,0,p.hash===!0);return}this._downloadRange(p)},u.prototype._downloadBlocks=function(p){for(;p.blocksDownloaded<p.blocks.length;){const w=p.blocks[p.blocksDownloaded];if(!this.feed.bitfield.get(w))break;p.blocksDownloaded++}if(p.blocksDownloaded>=p.blocks.length){s.remove(this.feed._selections,p),p.callback(null);return}for(var y=p.blocksDownloaded;y<p.blocks.length;y++){const w=p.blocks[y];if(this.remoteBitfield.get(w)&&this.feed._reserved.set(w,!0)){p.requested++,this._request(w,0,!1);return}}},u.prototype._downloadRange=function(p){p.iterator||(p.iterator=this.feed.bitfield.iterator(p.start,p.end));var y=this.feed._reserved,w=this._iterator,E=Math.min(p.end===-1?this.remoteLength:p.end,this.remoteLength),x=p.linear?w.seek(p.start).next(!0):_(w,p.start,E),B=x;if(x===-1||x>=E){!p.bytes&&p.end>-1&&this.feed.length>=p.end&&p.iterator.seek(0).next()===-1&&(s.remove(this.feed._selections,p),p.callback(null),!this.live&&!this.sparse&&!this.feed._selections.length&&this.end());return}for(;p.hash&&this.feed.tree.get(2*x)||!y.set(x,!0);)if(x=w.next(!0),!(x>-1&&x<E)&&!(!p.linear&&B!==0&&(x=w.seek(p.start).next(!0),B=0,x>-1&&x<E))){if(p.hash){for(var P=p.start;P<E;P++)if(!this.feed.tree.get(2*P))return;p.bytes||(s.remove(this.feed._selections,p),p.callback(null))}return}p.requested++,this._request(x,p.bytes||0,p.hash)},u.prototype._request=function(p,y,w){var E={bytes:y,index:p,hash:w,nodes:this.feed.digest(p)};this._requestTimeout===null&&this.stream.stream.timeout&&(this._requestTimeout=n(this.stream.stream.timeout.ms,this._onrequesttimeout,this)),this.inflightRequests.push(E),this.stream.request(E)},u.prototype.extension=function(p,y){this.stream.extension(p,y)};function d(p){var y=p?p.buffer:l;return new DataView(y.buffer,y.byteOffset,1024)}function f(p,y,w,E){for(var x=new DataView(y.buffer,y.byteOffset),B=Math.floor(y.length/4),P=new Uint32Array(y.buffer,y.byteOffset,B),U=E/8192,F=0,G=d(p.pages.get(U++,!0)),H=0;H<B;H++)P[H]=x.getUint32(4*H,!w)&~G.getUint32(4*F++,!w),F===256&&(G=d(p.pages.get(U++,!0)),F=0)}function _(p,y,w){var E=w-y,x=p.seek(Math.floor(Math.random()*E)+y).next(!0);return x===-1||x>=w?p.seek(y).next(!0):x}}}),require_emitter=__commonJS({"node_modules/.pnpm/nanoresource@1.3.0/node_modules/nanoresource/emitter.js"(e,t){init_inject_globals();var r=events_default,n=require_inherits_browser(),o=Symbol("opening queue"),s=Symbol("closing when inactive"),a=Symbol("closing queue"),c=Symbol("sync"),l=Symbol("fast close");t.exports=h;function h(_){if(!(this instanceof h))return new h(_);r.EventEmitter.call(this),_||(_={}),_.open&&(this._open=_.open),_.close&&(this._close=_.close),this.opening=!1,this.opened=!1,this.closing=!1,this.closed=!1,this.actives=0,this[o]=null,this[s]=null,this[a]=null,this[c]=!1,this[l]=!0}n(h,r.EventEmitter),h.prototype._open=function(_){_(null)},h.prototype._close=function(_){_(null)},h.prototype.open=function(_){if(_||(_=f),this[a]||this.closed)return process$1.nextTick(_,new Error("Resource is closed"));if(this.opened)return process$1.nextTick(_);if(this[o]){this[o].push(_);return}this.opening=!0,this[o]=[_],this[c]=!0,this._open(u.bind(this)),this[c]=!1},h.prototype.active=function(_){return this[l]&&this[s]||this[a]||this.closed?(_&&process$1.nextTick(_,new Error("Resource is closed")),!1):(this.actives++,!0)},h.prototype.inactive=function(_,p,y){if(!--this.actives){const w=this[s];if(w)for(this[s]=null;w.length;)this.close(w.shift())}_&&_(p,y)},h.prototype.close=function(_,p){if(typeof _=="function")return this.close(!1,_);if(p||(p=f),_&&(this[l]=!1),this.closed)return process$1.nextTick(p);if(this.actives||this[o]){this[s]||(this[s]=[]),this[s].push(p);return}if(!this.opened){this.closed=!0,process$1.nextTick(p);return}if(this[a]){this[a].push(p);return}this.closing=!0,this[a]=[p],this[c]=!0,this._close(d.bind(this)),this[c]=!1};function u(_){if(this[c])return process$1.nextTick(u.bind(this),_);const p=this[o];for(this[o]=null,this.opening=!1,this.opened=!_;p.length;)p.shift()(_);const y=this[s];if(y&&!this.actives)for(this[s]=null;y.length;)this.close(y.shift())}function d(_){if(this[c])return process$1.nextTick(d.bind(this),_);const p=this[a];for(this.closing=!1,this[a]=null,this.closed=!_;p.length;)p.shift()(_)}function f(){}}}),require_empty=__commonJS({"packages/common/hypercore/src/empty.ts"(e,t){init_inject_globals(),t.exports=new Proxy({},{get:(r,n)=>{throw new Error("Package has been stripped")}})}}),require_hypercore_streams=__commonJS({"node_modules/.pnpm/hypercore-streams@1.0.1/node_modules/hypercore-streams/index.js"(e,t){init_inject_globals();var{Writable:r,Readable:n}=import$streamx,o=class extends r{constructor(a,c){super(),this.feed=a,this.maxBlockSize=c&&c.maxBlockSize||0}_writev(a,c){this.feed.append(this.maxBlockSize?this._ensureMaxSize(a):a,c)}_ensureMaxSize(a){for(let c=0;c<a.length;c++){let l=a[c];if(l.length>this.maxBlockSize){const h=[];for(;l.length>this.maxBlockSize;)h.push(l.slice(0,this.maxBlockSize)),l=l.slice(this.maxBlockSize);l.length&&h.push(l),a.splice(c,1,...h),c+=h.length-1}}return a}},s=class extends n{constructor(a,c={}){super(),this.feed=a,this.start=c.start||0,this.end=typeof c.end=="number"?c.end:-1,this.live=!!c.live,this.snapshot=c.snapshot!==!1,this.tail=!!c.tail,this.index=this.start,this.options={wait:c.wait!==!1,ifAvailable:!!c.ifAvailable,valueEncoding:c.valueEncoding}}_open(a){this.feed.ready(c=>{if(c)return a(c);this.end===-1&&(this.live?this.end=1/0:this.snapshot&&(this.end=this.feed.length),this.start>this.end&&this.push(null)),this.tail&&(this.start=this.feed.length),this.index=this.start,a(null)})}_read(a){if(this.index===this.end||this.end===-1&&this.index>=this.feed.length)return this.push(null),a(null);this.feed.get(this.index++,this.options,(c,l)=>{if(c)return a(c);this.push(l),a(null)})}};t.exports={WriteStream:o,ReadStream:s}}}),require_hypercore=__commonJS({"node_modules/.pnpm/hypercore@9.12.0/node_modules/hypercore/index.js"(e,t){init_inject_globals();var r=require_last_one_wins(),n=require_unordered_array_remove(),o=require_unordered_set(),s=require_generator(),a=require_flat_tree(),c=require_codecs(),l=require_atomic_batcher(),h=require_inherits_browser(),u=require_bitfield(),d=require_sparse_bitfield(),f=require_tree_index(),_=require_storage(),p=require_hypercore_crypto(),y=require_browser(),w=require_pretty_hash(),E=require_nanoguard(),x=require_safe_buffer_equals(),B=require_replicate(),P=require_hypercore_protocol(),U=require_abstract_extension(),F=require_emitter(),G=require_empty(),{WriteStream:H,ReadStream:te}=require_hypercore_streams(),J=class extends U{broadcast(Q){const C=this.local.handlers,$=this.encoding.encode(Q);let j=!1;for(const O of C.peers)j=!0,O.extension(this.id,$);return j}send(Q,C){C.extension(this.id,this.encode(Q))}},le={sign(Q,C,$){return $(null,p.sign(Q,C))},verify(Q,C,$,j){return j(null,p.verify(Q,C,$))}};t.exports=z;function z(Q,C,$){if(!(this instanceof z))return new z(Q,C,$);if(F.call(this),typeof Q=="string"&&(Q=ye(Q)),typeof Q!="function")throw new Error("Storage should be a function or string");typeof C=="string"&&(C=export_Buffer.from(C,"hex")),!export_Buffer.isBuffer(C)&&!$&&($=C,C=null),$||($={});var j=this,O=$.secretKey||null;typeof O=="string"&&(O=export_Buffer.from(O,"hex")),this.noiseKeyPair=$.noiseKeyPair||P.keyPair(),this.live=$.live!==!1,this.sparse=!!$.sparse,this.length=0,this.byteLength=0,this.maxRequests=$.maxRequests||16,this.key=C||$.key||null,this.discoveryKey=this.key&&p.discoveryKey(this.key),this.secretKey=O,this.bitfield=null,this.tree=null,this.writable=!!$.writable,this.readable=!0,this.downloading=$.downloading!==!1,this.uploading=$.uploading!==!1,this.allowPush=!!$.allowPush,this.peers=[],this.ifAvailable=new E,this.extensions=J.createLocal(this),this.crypto=$.crypto||le,this._onwrite=$.onwrite||null,this._force=!!$.force,this._expectedLength=-1,this._indexing=!!$.indexing,this._createIfMissing=$.createIfMissing!==!1,this._overwrite=!!$.overwrite,this._storeSecretKey=$.storeSecretKey!==!1,this._alwaysIfAvailable=!!$.ifAvailable,this._merkle=null,this._storage=_(Q,$),this._batch=l(this._onwrite?ue:pe),this.timeouts=$.timeouts||{get(Le){Le(null)},update(Le){Le(null)}},this._seq=0,this._waiting=[],this._selections=[],this._reserved=d(),this._synced=null,this._downloadingSet=typeof $.downloading=="boolean",this._stats=typeof $.stats<"u"&&!$.stats?null:{downloadedBlocks:0,downloadedBytes:0,uploadedBlocks:0,uploadedBytes:0},this._codec=W($.valueEncoding),this._sync=r(Oe),this.sparse||this.download({start:0,end:-1}),this.sparse&&$.eagerUpdate&&this.update(function Le(Me){Me&&j.emit("update-error",Me),j.update(Le)}),this.open(k);function k(Le){Le&&j.emit("error",Le)}function ue(Le,Me){if(!j._merkle)return j._reloadMerkleStateBeforeAppend(ue,Le,Me);j._appendHook(Le,Me)}function pe(Le,Me){if(!j._merkle)return j._reloadMerkleStateBeforeAppend(pe,Le,Me);j._append(Le,Me)}function Oe(Le,Me){j._syncBitfield(Me)}}h(z,F),z.discoveryKey=p.discoveryKey,z.prototype[y]=function(Q,C){var $="";if(typeof C.indentationLvl=="number")for(;$.length<C.indentationLvl;)$+=" ";return`Hypercore(
`+$+"  key: "+C.stylize(this.key&&w(this.key),"string")+`
`+$+"  discoveryKey: "+C.stylize(this.discoveryKey&&w(this.discoveryKey),"string")+`
`+$+"  opened: "+C.stylize(this.opened,"boolean")+`
`+$+"  sparse: "+C.stylize(this.sparse,"boolean")+`
`+$+"  writable: "+C.stylize(this.writable,"boolean")+`
`+$+"  length: "+C.stylize(this.length,"number")+`
`+$+"  byteLength: "+C.stylize(this.byteLength,"number")+`
`+$+"  peers: "+C.stylize(this.peers.length,"number")+`
`+$+")"},Object.defineProperty(z.prototype,"remoteLength",{enumerable:!0,get:function(){for(var Q=0,C=0;C<this.peers.length;C++){var $=this.peers[C].remoteLength;$>Q&&(Q=$)}return Q}}),Object.defineProperty(z.prototype,"stats",{enumerable:!0,get:function(){if(!this._stats)return null;for(var Q=[],C=0;C<this.peers.length;C++){var $=this.peers[C];Q[C]=$.stats}return{peers:Q,totals:this._stats}}}),z.prototype.replicate=function(Q,C){return(!this._selections.length||this._selections[0].end!==-1)&&!this.sparse&&!(C&&C.live)&&this.download({start:0,end:-1}),Ce(Q)&&!C&&(C=Q,Q=C.initiator),C=C||{},C.stats=!!this._stats,C.noise=!(C.noise===!1&&C.encrypted===!1),B(this,Q,C)},z.prototype.registerExtension=function(Q,C){return this.extensions.add(Q,C)},z.prototype.onextensionupdate=function(){for(const Q of this.peers)Q._updateOptions()},z.prototype.setDownloading=function(Q){this.downloading===Q&&this._downloadingSet||(this.downloading=Q,this._downloadingSet=!0,this.ready(C=>{if(!C)for(const $ of this.peers)$.setDownloading(this.downloading)}))},z.prototype.setUploading=function(Q){Q!==this.uploading&&(this.uploading=Q,this.ready(C=>{if(!C)for(const $ of this.peers)$.setUploading(this.uploading)}))},z.prototype.ready=z.prototype.open,z.prototype.update=function(Q,C){if(typeof Q=="function")return this.update(-1,Q);typeof Q=="number"&&(Q={minLength:Q}),Q||(Q={}),C||(C=he);var $=this,j=typeof Q.minLength=="number"?Q.minLength:-1;this.ready(function(O){if(O)return C(O);if(j===-1&&(j=$.length+1),$.length>=j)return C(null);const k=typeof Q.ifAvailable=="boolean"?Q.ifAvailable:$._alwaysIfAvailable;if(k&&$.writable&&!Q.force)return C(new Error("No update available from peers"));$.writable&&(C=$._writeStateReloader(C));var ue={hash:Q.hash!==!1,bytes:0,index:j-1,options:Q,update:!0,callback:C};$._waiting.push(ue),k&&$._ifAvailable(ue,j),$._updatePeers()})},z.prototype.setExpectedLength=function(Q){this._expectedLength=Q,this.ready(C=>{if(!C&&(this.ifAvailable.ready(()=>{this._expectedLength=-1}),!(this._expectedLength===-1||this._expectedLength>this.length)))for(const $ of this._waiting)$.update&&$.ifAvailable&&$.callback(new Error("Expected length is less than current length"))})},z.prototype.truncate=function(Q,C){C||(C=he);const $=this;this.ready(function(j){if(j)return C(j);$._roots(Q,function(O,k){if(O)return C(O);const ue=$.length;if(ue<=Q)return C(null);let pe=0;for(const{size:Oe}of k)pe+=Oe;for(let Oe=ue;Oe<Q;Oe++)$.data.set(Oe,!1);$.byteLength=pe,$.length=Q,$.tree.truncate(2*Q),$._merkle=new s(p,k),$._sync(null,function(Oe){if(Oe)return C(Oe);$._storage.deleteSignatures(Q,ue,C)})})})},z.prototype._ifAvailable=function(Q,C){var $=Q.callback,j=!1,O=this;if(Q.callback=k,Q.ifAvailable=!0,this._expectedLength>-1&&this._expectedLength<=this.length)return process$1.nextTick(Q.callback,new Error("Expected length is less than current length"));this.timeouts.update(function(){if(O.closed)return k(new Error("Closed"));process$1.nextTick(ke,O.ifAvailable,function(){if(O.closed)return k(new Error("Closed"));O.length>=C||O.remoteLength>=C||k(new Error("No update available from peers"))})});function k(ue){if(!j){j=!0;var pe=O._waiting.indexOf(Q);pe>-1&&n(O._waiting,pe),$(ue)}}},z.prototype._ifAvailableGet=function(Q){var C=Q.callback,$=!1,j=this;Q.callback=O,j.timeouts.get(function(){if(j.closed)return O(new Error("Closed"));process$1.nextTick(ke,j.ifAvailable,function(){if(j.closed)return O(new Error("Closed"));for(var k=0;k<j.peers.length;k++){var ue=j.peers[k];if(ue.remoteBitfield.get(Q.index))return}O(new Error("Block not available from peers"))})});function O(k,ue){if(!$){$=!0;var pe=j._waiting.indexOf(Q);pe>-1&&n(j._waiting,pe),C(k,ue)}}},z.prototype._writeStateReloader=function(Q){var C=this;return function($){if($)return Q($);C._reloadMerkleState(Q)}},z.prototype._reloadMerkleState=function(Q){var C=this;this._roots(C.length,function($,j){if($)return Q($);C._merkle=new s(p,j),Q(null)})},z.prototype._reloadMerkleStateBeforeAppend=function(Q,C,$){this._reloadMerkleState(function(j){if(j)return $(j);Q(C,$)})},z.prototype._open=function(Q){var C=this,$=!1,j=!0;this._storage.openKey(function(k,ue){if(ue&&!C._overwrite&&!C.key&&(C.key=ue),!C.key&&C.live){var pe=p.keyPair();C.secretKey=pe.secretKey,C.key=pe.publicKey,$=!0}C.discoveryKey=C.key&&p.discoveryKey(C.key),C._storage.open({key:C.key,discoveryKey:C.discoveryKey},O)});function O(k,ue){if(k)return Q(k);if(!ue.key&&ue.bitfield.length&&(C._overwrite=!0),C._force&&ue.key&&C.key&&export_Buffer.compare(ue.key,C.key)!==0&&(C._overwrite=!0),C._overwrite&&(ue.bitfield=[],ue.key=ue.secretKey=null),C.bitfield=u(ue.bitfieldPageSize,ue.bitfield),C.tree=f(C.bitfield.tree),C.length=C.tree.blocks(),C._seq=C.length,ue.key&&C.key&&export_Buffer.compare(ue.key,C.key)!==0)return C._forceClose(Q,new Error("Another hypercore is stored here"));if(ue.key&&(C.key=ue.key),ue.secretKey&&(C.secretKey=ue.secretKey),!C.length)return pe(null,null);C._storage.getSignature(C.length-1,pe);function pe(Oe,Le){if(C.length&&(C.live=!!Le),($||!C.key)&&!C._createIfMissing)return C._forceClose(Q,new Error("No hypercore is stored here"));if(!C.key&&C.live){var Me=p.keyPair();C.secretKey=Me.secretKey,C.key=Me.publicKey}var We=!!C.secretKey||C.key===null;if(!We&&C.writable)return C._forceClose(Q,new Error("Feed is not writable"));C.writable=We,C._downloadingSet||(C.downloading=!We),C.discoveryKey=C.key&&p.discoveryKey(C.key),C._storeSecretKey&&!C.secretKey&&(C._storeSecretKey=!1);var Fe=$||!x(C.key,ue.key),st=C._storeSecretKey&&($||!x(C.secretKey,ue.secretKey)),ft=1+(Fe?1:0)+(st?1:0)+(C._overwrite?1:0),rt=null;Fe&&C._storage.key.write(0,C.key,lt),st&&C._storage.secretKey.write(0,C.secretKey,lt),C._overwrite&&C._storage.bitfield.del(32,1/0,lt),lt(null);function lt(qe){if(qe&&(rt=qe),!--ft){if(rt)return C._forceClose(Q,rt);C._roots(C.length,At)}}function At(qe,Je){if(qe&&j){j=!1,C.length--,C._storage.getSignature(C.length-1,pe);return}if(qe)return C._forceClose(Q,qe);C._merkle=new s(p,Je),C.byteLength=Je.reduce(_e,0),C.emit("ready"),Q(null)}}}},z.prototype.download=function(Q,C){if(typeof Q=="function")return this.download(null,Q);if(typeof Q=="number"&&(Q={start:Q,end:Q+1}),Array.isArray(Q)&&(Q={blocks:Q}),Q||(Q={}),C||(C=he),!this.readable)return C(new Error("Feed is closed"));if(Q.blocks&&typeof Q.start!="number"){for(var $=-1,j=0,O=0;O<Q.blocks.length;O++){const ue=Q.blocks[O];($===-1||ue<$)&&($=ue),ue>=j&&(j=ue+1)}Q.start=$===-1?0:$,Q.end=j}var k={_index:this._selections.length,hash:!!Q.hash,iterator:null,start:Q.start||0,end:Q.end||-1,want:0,linear:!!Q.linear,blocks:Q.blocks||null,blocksDownloaded:0,requested:0,callback:C};return k.want=ge(k.start),this._selections.push(k),this._updatePeers(),k},z.prototype.undownload=function(Q){if(typeof Q=="number"&&(Q={start:Q,end:Q+1}),Q||(Q={}),Q.callback&&Q._index>-1){o.remove(this._selections,Q),process$1.nextTick(Q.callback,de("ECANCELED",-11,"Download was cancelled"));return}for(var C=Q.start||0,$=Q.end||-1,j=!!Q.hash,O=!!Q.linear,k=0;k<this._selections.length;k++){var ue=this._selections[k];if(ue.start===C&&ue.end===$&&ue.hash===j&&ue.linear===O){o.remove(this._selections,ue),process$1.nextTick(Q.callback,de("ECANCELED",-11,"Download was cancelled"));return}}},z.prototype.digest=function(Q){return this.tree.digest(2*Q)},z.prototype.proof=function(Q,C,$){if(typeof C=="function")return this.proof(Q,null,C);if(!this.opened)return this._readyAndProof(Q,C,$);C||(C={});var j=this.tree.proof(2*Q,C);if(!j)return $(new Error("No proof available for this index"));var O=this.live&&!!j.verifiedBy,k=j.nodes.length+(O?1:0),ue=null,pe=null,Oe=new Array(j.nodes.length);if(!k)return $(null,{nodes:Oe,signature:null});for(var Le=0;Le<j.nodes.length;Le++)this._storage.getNode(j.nodes[Le],We);O&&this._storage.getSignature(j.verifiedBy/2-1,Me);function Me(Fe,st){st&&(pe=st),We(Fe,null)}function We(Fe,st){if(Fe&&(ue=Fe),st&&(Oe[j.nodes.indexOf(st.index)]=st),!--k){if(ue)return $(ue);$(null,{nodes:Oe,signature:pe})}}},z.prototype._readyAndProof=function(Q,C,$){var j=this;this.ready(function(O){if(O)return $(O);j.proof(Q,C,$)})},z.prototype.put=function(Q,C,$,j){if(!this.opened)return this._readyAndPut(Q,C,$,j);this._putBuffer(Q,C===null?null:this._codec.encode(C),$,null,j)},z.prototype.cancel=function(Q,C){if(typeof Q!="symbol"){C||(C=Q+1);for(var $=this._selections.length-1;$>=0;$--){var j=this._selections[$];Q<=j.start&&j.end<=C&&this.undownload(j)}}this.opened?this._cancel(Q,C):this._readyAndCancel(Q,C)},z.prototype._cancel=function(Q,C){var $=0;if(typeof Q=="symbol"){for($=this._waiting.length-1;$>=0;$--){const O=this._waiting[$];if(O.options.cancel===Q){n(this._waiting,$),this._reserved.set(O.index,!1),O.callback&&process$1.nextTick(O.callback,new Error("Request cancelled")),this._updatePeers();return}}return}for($=Q;$<C;$++)this._reserved.set($,!1);for($=this._waiting.length-1;$>=0;$--){var j=this._waiting[$];(Q<=j.start&&j.end<=C||Q<=j.index&&j.index<C)&&(n(this._waiting,$),j.callback&&process$1.nextTick(j.callback,new Error("Request cancelled")))}},z.prototype.clear=function(Q,C,$,j){if(typeof C=="function")return this.clear(Q,Q+1,null,C);if(typeof $=="function")return this.clear(Q,C,null,$);$||($={}),C||(C=Q+1),j||(j=he);var O=this,k=Q===0?0:typeof $.byteOffset=="number"?$.byteOffset:-1,ue=typeof $.byteLength=="number"?$.byteLength:-1;this.ready(function(pe){if(pe)return j(pe);for(var Oe=!1,Le=Q;Le<C;Le++)O.bitfield.set(Le,!1)&&(Oe=!0);if(!Oe)return process$1.nextTick(j);if(O._unannounce({start:Q,length:C-Q}),$.delete===!1||O._indexing)return Me();if(k>-1)return We(null,k);O._storage.dataOffset(Q,[],We);function Me(){O.emit("clear",Q,C),O._sync(null,j)}function We(st,ft){if(st)return j(st);if(k=ft,ue>-1)return Fe(null,ue+k);if(C===O.length)return Fe(null,O.byteLength);O._storage.dataOffset(C,[],Fe)}function Fe(st,ft){if(st)return j(st);if(!O._storage.data.del)return Me();O._storage.data.del(k,ft-k,Me)}})},z.prototype.signature=function(Q,C){if(typeof Q=="function")return this.signature(this.length-1,Q);if(Q<0||Q>=this.length)return C(new Error("No signature available for this index"));this._storage.nextSignature(Q,C)},z.prototype.verify=function(Q,C,$){var j=this;this.rootHashes(Q,function(O,k){if(O)return $(O);var ue=p.signable(k,Q+1);ae(j,ue,C,function(pe,Oe){return pe?$(pe):Oe?$(null,!0):$(new Error("Signature verification failed"))})})},z.prototype.rootHashes=function(Q,C){this._getRootsToVerify(Q*2+2,{},[],C)},z.prototype.seek=function(Q,C,$){if(typeof C=="function")return this.seek(Q,null,C);if(C||(C={}),!this.opened)return this._readyAndSeek(Q,C,$);var j=this;if(Q===this.byteLength)return process$1.nextTick($,null,this.length,0);this._seek(Q,function(k,ue,pe){if(!k&&ee(ue))return O(ue/2,pe);if(C.wait===!1)return $(k||new Error("Unable to seek to this offset"));var Oe=C.start||0,Le=C.end||-1;if(!k){var Me=a.leftSpan(ue)/2,We=a.rightSpan(ue)/2+1;Me>Oe&&(Oe=Me),(We<Le||Le===-1)&&(Le=We)}if(Le>-1&&Le<=Oe)return $(new Error("Unable to seek to this offset"));var Fe={hash:C.hash!==!1,bytes:Q,index:-1,ifAvailable:C&&typeof C.ifAvailable=="boolean"?C.ifAvailable:j._alwaysIfAvailable,start:Oe,end:Le,want:ge(Oe),requested:0,callback:$||he};j._waiting.push(Fe),j._updatePeers(),Fe.ifAvailable&&j._ifAvailableSeek(Fe)});function O(k,ue){for(var pe=0;pe<j.peers.length;pe++)j.peers[pe].haveBytes(Q);$(null,k,ue)}},z.prototype._ifAvailableSeek=function(Q){var C=this,$=Q.callback;C.timeouts.get(function(){if(C.closed)return j(new Error("Closed"));process$1.nextTick(ke,C.ifAvailable,function(){if(C.closed)return j(new Error("Closed"));let O=!1;for(const k of C.peers){const ue=k._iterator;let pe=ue.seek(Q.start).next(!0);for(;C.tree.get(pe*2)&&pe>-1;)pe=ue.next(!0);if(pe>-1&&(Q.end===-1||pe<Q.end)){O=!0;break}}O||j(new Error("Seek not available from peers"))})});function j(O){var k=C._waiting.indexOf(Q);k>-1&&(n(C._waiting,k),Q.callback=he,$(O))}},z.prototype._seek=function(Q,C){if(Q===0)return C(null,0,0);var $=this,j=a.fullRoots(this.length*2),O=0;pe(null,null);function k(Oe){if(ee(Oe))return C(null,O,Q);for(var Le=a.leftChild(Oe);!$.tree.get(Le);){if(ee(Le))return C(null,O,Q);Le=a.leftChild(Le)}$._storage.getNode(Le,ue)}function ue(Oe,Le){if(Oe)return C(Oe);Le.size>Q?(O=Le.index,k(Le.index)):(Q-=Le.size,a.parent(Le.index)===O?(O=a.sibling(Le.index),k(O)):k(a.sibling(Le.index)))}function pe(Oe,Le){if(Oe)return C(Oe);if(Le){if(Le.size>Q)return O=Le.index,k(Le.index);Q-=Le.size}if(!j.length)return C(new Error("Out of bounds"));$._storage.getNode(j.shift(),pe)}},z.prototype._readyAndSeek=function(Q,C,$){var j=this;this.ready(function(O){if(O)return $(O);j.seek(Q,C,$)})},z.prototype._getBuffer=function(Q,C){this._storage.getData(Q,C)},z.prototype._putBuffer=function(Q,C,$,j,O){for(var k=this,ue=-1,pe=[],Oe=2*Q,Le=C?0:1;;){if(this.tree.get(Oe)){ue=Oe;break}var Me=a.sibling(Oe);if(Oe=a.parent(Oe),Le<$.nodes.length&&$.nodes[Le].index===Me){Le++;continue}if(!this.tree.get(Me))break;pe.push(Me)}ue===-1&&this.tree.get(Oe)&&(ue=Oe);var We=null,Fe=null,st=new Array(pe.length),ft=pe.length+(ue>-1?1:0);for(Le=0;Le<pe.length;Le++)this._storage.getNode(pe[Le],lt);ue>-1&&this._storage.getNode(ue,rt),!pe.length&&ue===-1&&At(null);function rt(qe,Je){qe&&(We=qe),Je&&(Fe=Je),--ft||At(We)}function lt(qe,Je){qe&&(We=qe),Je&&(st[pe.indexOf(Je.index)]=Je),--ft||At(We)}function At(qe){if(qe)return O(qe);k._verifyAndWrite(Q,C,$,st,Fe,j,O)}},z.prototype._readyAndPut=function(Q,C,$,j){var O=this;this.ready(function(k){if(k)return j(k);O.put(Q,C,$,j)})},z.prototype._write=function(Q,C,$,j,O,k){if(!this._onwrite)return this._writeAfterHook(Q,C,$,j,O,k);this._onwrite(Q,C,O,q(this,Q,C,$,j,O,k))};function q(Q,C,$,j,O,k,ue){return function(pe){if(pe)return ue(pe);Q._writeAfterHook(C,$,j,O,k,ue)}}z.prototype._writeAfterHook=function(Q,C,$,j,O,k){for(var ue=this,pe=$.length+1+(j?1:0),Oe=null,Le=0;Le<$.length;Le++)this._storage.putNode($[Le].index,$[Le],Me);C?this._storage.putData(Q,C,$,Me):Me(),j&&this._storage.putSignature(j.index,j.signature,Me);function Me(We){if(We&&(Oe=We),!--pe){if(Oe)return k(Oe);ue._writeDone(Q,C,$,O,k)}}},z.prototype._writeDone=function(Q,C,$,j,O){for(var k=0;k<$.length;k++)this.tree.set($[k].index);this.tree.set(2*Q),C&&(this.bitfield.set(Q,!0)&&(this._stats&&(this._stats.downloadedBlocks+=1,this._stats.downloadedBytes+=C.length),this.emit("download",Q,C,j)),this.peers.length&&this._announce({start:Q},j),this.writable||(this._synced||(this._synced=this.bitfield.iterator(0,this.length)),this._synced.next()===-1&&(this._synced.range(0,this.length),this._synced.seek(0),this._synced.next()===-1&&this.emit("sync")))),this._sync(null,O)},z.prototype._verifyAndWrite=function(Q,C,$,j,O,k,ue){var pe=[],Oe=$.nodes,Le=C?new _.Node(2*Q,p.data(C),C.length):Oe.shift();if(V(O,Le)){this._write(Q,C,pe,null,k,ue);return}for(;;){var Me=null,We=a.sibling(Le.index);if(Oe.length&&Oe[0].index===We)Me=Oe.shift(),pe.push(Me);else if(j.length&&j[0].index===We)Me=j.shift();else{this._verifyRootsAndWrite(Q,C,Le,$,pe,k,ue);return}if(pe.push(Le),Le=new _.Node(a.parent(Le.index),p.parent(Le,Me),Le.size+Me.size),V(O,Le)){this._write(Q,C,pe,null,k,ue);return}}},z.prototype._verifyRootsAndWrite=function(Q,C,$,j,O,k,ue){var pe=j.nodes,Oe=pe.length?pe[pe.length-1].index:$.index,Le=Math.max(a.rightSpan($.index),a.rightSpan(Oe))+2,Me=Le/2,We=this;this._getRootsToVerify(Le,$,pe,function(Fe,st,ft){if(Fe)return ue(Fe);var rt=p.signable(st,Me),lt=null;if(We.length&&We.live&&!j.signature)return ue(new Error("Remote did not include a signature"));if(j.signature)ae(We,rt,j.signature,function(qe,Je){if(qe)return ue(qe);if(!Je)return ue(new Error("Remote signature could not be verified"));lt={index:Le/2-1,signature:j.signature},At()});else{if(export_Buffer.compare(rt.slice(0,32),We.key)!==0)return ue(new Error("Remote checksum failed"));At()}function At(){We.live=!!lt,Me>We.length&&(We.writable&&(We._merkle=null),We.length=Me,We._seq=Me,We.byteLength=st.reduce(_e,0),We._synced&&We._synced.seek(0,We.length),We.emit("append")),We._write(Q,C,O.concat(ft),lt,k,ue)}})},z.prototype._getRootsToVerify=function(Q,C,$,j){for(var O=a.fullRoots(Q),k=new Array(O.length),ue=[],pe=null,Oe=k.length,Le=0;Le<O.length;Le++)O[Le]===C.index?(ue.push(C),Me(null,C)):$.length&&O[Le]===$[0].index?(ue.push($[0]),Me(null,$.shift())):this.tree.get(O[Le])?this._storage.getNode(O[Le],Me):Me(new Error("Missing tree roots needed for verify"));function Me(Fe,st){Fe&&(pe=Fe),st&&(k[O.indexOf(st.index)]=st),--Oe||We(pe)}function We(Fe){if(Fe)return j(Fe);j(null,k,ue)}},z.prototype._announce=function(Q,C){for(var $=0;$<this.peers.length;$++){var j=this.peers[$];j!==C&&j.have(Q)}},z.prototype._unannounce=function(Q){for(var C=0;C<this.peers.length;C++)this.peers[C].unhave(Q)},z.prototype.downloaded=function(Q,C,$){const j=this.bitfield.total(Q,C);return $&&process$1.nextTick($,null,j),j},z.prototype.has=function(Q,C,$){if(typeof C=="function")return this.has(Q,void 0,C);if(C===void 0){const O=this.bitfield.get(Q);return $&&process$1.nextTick($,null,O),O}const j=C-Q===this.bitfield.total(Q,C);return $&&process$1.nextTick($,null,j),j},z.prototype.getBlockInfo=function(Q,C){var $=this;this.ready(function(j){if(j)return C(j);$._storage.getNode(2*Q,C)})},z.prototype.head=function(Q,C){if(typeof Q=="function")return this.head({},Q);var $=this;this.ready(function(O){if(O)return C(O);Q&&Q.update?$.update(Q,j):process$1.nextTick(j)});function j(){$.length===0?C(new Error("feed is empty")):$.get($.length-1,Q,C)}},z.prototype.get=function(Q,C,$){if(typeof C=="function")return this.get(Q,null,C);if(C={...C},C.cancel||(C.cancel=Symbol("hypercore-get")),!this.opened)return this._readyAndGet(Q,C,$);if(!this.readable)return process$1.nextTick($,new Error("Feed is closed")),C.cancel;if(C.timeout&&($=ne($,C.timeout)),!this.bitfield.get(Q)){if(C&&C.wait===!1)return process$1.nextTick($,new Error("Block not downloaded"));var j={bytes:0,hash:!1,index:Q,options:C,requested:0,callback:$};if(this._waiting.push(j),(C&&typeof C.ifAvailable=="boolean"?C.ifAvailable:this._alwaysIfAvailable)&&this._ifAvailableGet(j),this._updatePeers(),C.onwait){const O=C.onwait;C.onwait=null,O(Q)}return C.cancel}return C&&C.valueEncoding?$=re(W(C.valueEncoding),$):this._codec!==c.binary&&($=re(this._codec,$)),this._getBuffer(Q,$),C.cancel},z.prototype._readyAndGet=function(Q,C,$){var j=this;return this.ready(function(O){if(O)return $(O);j.get(Q,C,$)}),C.cancel},z.prototype.getBatch=function(Q,C,$,j){if(typeof $=="function")return this.getBatch(Q,C,null,$);if(!this.opened)return this._readyAndGetBatch(Q,C,$,j);var O=this,k=!$||$.wait!==!1;if(this.has(Q,C))return this._getBatch(Q,C,$,j);if(!k)return process$1.nextTick(j,new Error("Block not downloaded"));$&&$.timeout&&(j=ne(j,$.timeout)),this.download({start:Q,end:C},function(ue){if(ue)return j(ue);O._getBatch(Q,C,$,j)})},z.prototype._getBatch=function(Q,C,$,j){var O=$&&$.valueEncoding,k=O?W(O):this._codec;this._storage.getDataBatch(Q,C-Q,ue);function ue(pe,Oe){if(pe)return j(pe);for(var Le=new Array(Oe.length),Me=0;Me<Oe.length;Me++)try{Le[Me]=k?k.decode(Oe[Me]):Oe[Me]}catch(We){return j(We)}j(null,Le)}},z.prototype._readyAndGetBatch=function(Q,C,$,j){var O=this;this.ready(function(k){if(k)return j(k);O.getBatch(Q,C,$,j)})},z.prototype._updatePeers=function(){for(var Q=0;Q<this.peers.length;Q++)this.peers[Q].update()},z.prototype.createWriteStream=function(Q){return new H(this,Q)},z.prototype.createReadStream=function(Q){return new te(this,Q)},z.prototype.finalize=function(Q){this.key||(this.key=p.tree(this._merkle.roots),this.discoveryKey=p.discoveryKey(this.key)),this._storage.key.write(0,this.key,Q)},z.prototype.append=function(Q,C){C||(C=he);var $=this,j=Array.isArray(Q)?Q:[Q];this._batch(j,O);function O(k){if(k)return C(k);var ue=$._seq;$._seq+=j.length,C(null,ue)}},z.prototype.flush=function(Q){this.append([],Q)},z.prototype.destroyStorage=function(Q){const C=this;this.close(function($){$?Q($):C._storage.destroy(Q)})},z.prototype._close=function(Q){const C=this;for(const j of this.peers)j._destroyed||j._close();this._forceClose($,null);function $(j){j||C.emit("close"),Q(j)}},z.prototype._forceClose=function(Q,C){var $=this;this.writable=!1,this.readable=!1,this._storage.close(function(j){j||(j=C),$._destroy(j||new Error("Feed is closed")),Q(j)})},z.prototype._destroy=function(Q){for(this.ifAvailable.destroy();this._waiting.length;)this._waiting.pop().callback(Q);for(;this._selections.length;)this._selections.pop().callback(Q)},z.prototype._appendHook=function(Q,C){var $=this,j=Q.length,O=null;if(!j)return this._append(Q,C);for(var k=0;k<Q.length;k++)this._onwrite(k+this.length,Q[k],null,ue);function ue(pe){if(pe&&(O=pe),!--j){if(O)return C(O);$._append(Q,C)}}},z.prototype._append=function(Q,C){if(!this.opened)return this._readyAndAppend(Q,C);if(!this.writable)return C(new Error("This feed is not writable. Did you create it?"));var $=this,j=1,O=0,k=null,ue=new Array(Q.length?Q.length*2-1:0),pe=this.length*2,Oe=new Array(Q.length);if(!j)return C();for(var Le=0;Le<Q.length;Le++){var Me=this._codec.encode(Q[Le]),We=this._merkle.next(Me);if(Me.length>8388608)return C(new Error("Individual blocks has be less than 8MB"));O+=Me.length,Oe[Le]=Me;for(var Fe=0;Fe<We.length;Fe++){var st=We[Fe];st.index>=pe&&st.index-pe<ue.length?ue[st.index-pe]=st:(j++,this._storage.putNode(st.index,st,ft))}}this.live&&Q.length&&(j++,this.crypto.sign(p.signable(this._merkle.roots,$.length+Q.length),this.secretKey,function(rt,lt){if(rt)return ft(rt);$._storage.putSignature($.length+Q.length-1,lt,ft)})),this._indexing||(j++,Oe.length===1?this._storage.data.write(this.byteLength,Oe[0],ft):this._storage.data.write(this.byteLength,export_Buffer.concat(Oe),ft)),this._storage.putNodeBatch(pe,ue,ft);function ft(rt){if(rt&&(k=rt),!--j){if(k)return C(k);var lt=$.length;$.byteLength+=O;for(var At=0;At<Q.length;At++)$.bitfield.set($.length,!0),$.tree.set(2*$.length++);$.emit("append");var qe=$.length-lt>1?{start:lt,length:$.length-lt}:{start:lt};$.peers.length&&$._announce(qe),$._sync(null,C)}}},z.prototype._readyAndAppend=function(Q,C){var $=this;this.ready(function(j){if(j)return C(j);$._append(Q,C)})},z.prototype._readyAndCancel=function(Q,C){var $=this;this.ready(function(){$._cancel(Q,C)})},z.prototype._pollWaiting=function(){for(var Q=this._waiting.length,C=0;C<Q;C++){var $=this._waiting[C];!$.bytes&&!this.bitfield.get($.index)&&(!$.hash||!this.tree.get($.index*2))||(n(this._waiting,C--),Q--,$.bytes?this.seek($.bytes,$,$.callback):$.update?this.update($.index+1,$.callback):this.get($.index,$.options,$.callback))}},z.prototype._syncBitfield=function(Q){var C=this.bitfield.pages.updates.length,$=null,j=null;if(!C)return this._pollWaiting(),Q(null);for(;($=this.bitfield.pages.lastUpdate())!==null;)this._storage.putBitfield($.offset,$.buffer,O);this._pollWaiting();function O(k){k&&(j=k),!--C&&Q(j)}},z.prototype._roots=function(Q,C){var $=a.fullRoots(2*Q),j=new Array($.length),O=$.length,k=null;if(!O)return C(null,j);for(var ue=0;ue<$.length;ue++)this._storage.getNode($[ue],pe);function pe(Oe,Le){if(Oe&&(k=Oe),Le&&(j[$.indexOf(Le.index)]=Le),!--O){if(k)return C(k);C(null,j)}}},z.prototype.audit=function(Q){Q||(Q=he);var C=this,$={valid:0,invalid:0};this.ready(function(j){if(j)return Q(j);var O=0,k=C.length;pe();function ue(Le,Me){if(Le)return We(null,null);C._storage.getData(O,We);function We(Fe,st){var ft=st&&p.data(st).equals(Me.hash);ft?$.valid++:$.invalid++,C.bitfield.set(O,ft),O++,pe()}}function pe(){for(;O<k&&!C.bitfield.get(O);)O++;if(O>=k)return Oe();C._storage.getNode(2*O,ue)}function Oe(){C._sync(null,function(Le){if(Le)return Q(Le);Q(null,$)})}})},z.prototype.extension=function(Q,C){for(var $=this.peers,j=0;j<$.length;j++)$[j].extension(Q,C)};function he(){}function V(Q,C){return Q&&Q.index===C.index&&export_Buffer.compare(Q.hash,C.hash)===0}function _e(Q,C){return Q+C.size}function ee(Q){return(Q&1)===0}function W(Q){return c(Q==="json"?"ndjson":Q)}function re(Q,C){return function($,j){if($)return C($);try{j=Q.decode(j)}catch(O){return C(O)}C(null,j)}}function ne(Q,C){var $=!1,j=setTimeout(O,C);return k;function O(){$=!0;var ue=new Error("ETIMEDOUT");ue.code="ETIMEDOUT",Q(ue)}function k(ue,pe){$||(clearTimeout(j),Q(ue,pe))}}function ge(Q){return Math.floor(Q/1024/1024)*1024*1024}function de(Q,C,$){var j=new Error($);return j.code=Q,j.errno=C,j}function ye(Q){return function(C){return G(C,{directory:Q})}}function Ce(Q){return!P.isProtocolStream(Q)&&typeof Q=="object"&&!!Q&&typeof Q.initiator=="boolean"}function ke(Q,C){Q.ready(C)}function ae(Q,C,$,j){Q.crypto.verify(C,$,Q.key,function(O,k){if(O||k)return j(O,k);Q.crypto.verify(C.slice(0,32),$,Q.key,j)})}}});init_inject_globals();var import_hypercore2=__toESM(require_hypercore());init_inject_globals();var __dxlog_file$n="/home/runner/work/dxos/dxos/packages/common/hypercore/src/crypto.ts",createCodecEncoding=(e,t)=>({encode:r=>arrayToBuffer(e.encode(r,t)),decode:r=>e.decode(r,t)}),createCrypto=(e,t)=>(invariant$1(e,void 0,{F:__dxlog_file$n,L:27,S:void 0,A:["signer",""]}),invariant$1(t,void 0,{F:__dxlog_file$n,L:28,S:void 0,A:["publicKey",""]}),{sign:(r,n,o)=>{export_callbackify(e.sign.bind(e))(t,r,(s,a)=>{if(s){o(s,null);return}o(null,arrayToBuffer(a))})},verify:async(r,n,o,s)=>{export_callbackify(verifySignature)(t,r,n,s)}});init_inject_globals(),init_inject_globals(),__toESM(require_hypercore()),init_inject_globals(),init_inject_globals();var export_hypercore=import_hypercore2.default,__dxlog_file$m="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-wrapper.ts",FeedWrapper=class{constructor(e,t,r){this._hypercore=e,this._key=t,this._storageDirectory=r,this._pendingWrites=new Set,this._binder=createBinder(this._hypercore),this._writeLock=new Trigger,this._closed=!1,this.on=this._binder.fn(this._hypercore.on),this.off=this._binder.fn(this._hypercore.off),this.open=this._binder.async(this._hypercore.open),this._close=this._binder.async(this._hypercore.close),this.close=async()=>{this._pendingWrites.size&&log.warn("Closing feed with pending writes",{feed:this._key,count:this._pendingWrites.size,pendingWrites:Array.from(this._pendingWrites.values()).map(n=>n.getStack())},{F:__dxlog_file$m,L:172,S:this,C:(n,o)=>n(...o)}),this._closed=!0,await this.flushToDisk(),await this._close()},this.has=this._binder.fn(this._hypercore.has),this.get=this._binder.async(this._hypercore.get),this.append=this._binder.async(this._hypercore.append),this.download=this._binder.fn(this._hypercore.download),this.undownload=this._binder.fn(this._hypercore.undownload),this.setDownloading=this._binder.fn(this._hypercore.setDownloading),this.replicate=this._binder.fn(this._hypercore.replicate),this.clear=this._binder.async(this._hypercore.clear),invariant$1(this._hypercore,void 0,{F:__dxlog_file$m,L:36,S:this,A:["this._hypercore",""]}),invariant$1(this._key,void 0,{F:__dxlog_file$m,L:37,S:this,A:["this._key",""]}),this._writeLock.wake()}[export_inspect.custom](){return inspectObject(this)}toJSON(){return{feedKey:this._key,length:this.properties.length,opened:this.properties.opened,closed:this.properties.closed}}get key(){return this._key}get core(){return this._hypercore}get properties(){return this._hypercore}createReadableStream(e){const t=this,r=new streamx.Transform({transform(n,o){t._writeLock.wait().then(()=>{this.push(n),o()})}});return((e==null?void 0:e.batch)!==void 0&&(e==null?void 0:e.batch)>1?new BatchedReadStream(this._hypercore,e):this._hypercore.createReadStream(e)).pipe(r,n=>{}),r}createFeedWriter(){return{write:async(e,{afterWrite:t}={})=>{log("write",{feed:this._key,seq:this._hypercore.length,data:e},{F:__dxlog_file$m,L:96,S:this,C:(n,o)=>n(...o)}),invariant$1(!this._closed,"Feed closed",{F:__dxlog_file$m,L:97,S:this,A:["!this._closed","'Feed closed'"]});const r=new StackTrace;try{this._pendingWrites.add(r),this._pendingWrites.size===1&&this._writeLock.reset();const n=await this.appendWithReceipt(e);return await this.flushToDisk(),await(t==null?void 0:t(n)),n}finally{this._pendingWrites.delete(r),this._pendingWrites.size===0&&this._writeLock.wake()}}}}async appendWithReceipt(e){const t=await this.append(e);return invariant$1(t<this.length,"Invalid seq after write",{F:__dxlog_file$m,L:128,S:this,A:["seq < this.length","'Invalid seq after write'"]}),log("write complete",{feed:this._key,seq:t},{F:__dxlog_file$m,L:129,S:this,C:(r,n)=>r(...n)}),{feedKey:this.key,seq:t}}async flushToDisk(){await this._storageDirectory.flush()}get opened(){return this._hypercore.opened}get closed(){return this._hypercore.closed}get readable(){return this._hypercore.readable}get length(){return this._hypercore.length}get byteLength(){return this._hypercore.byteLength}async safeClear(e,t){invariant$1(e>=0&&e<t&&t<=this.length,"Invalid range",{F:__dxlog_file$m,L:200,S:this,A:["from >= 0 && from < to && to <= this.length","'Invalid range'"]});const r=20,n=t,o=Math.min(n+r,this.length),s=await Promise.all(rangeFromTo(n,o).map(c=>this.get(c,{valueEncoding:{decode:l=>l}})));await this.clear(e,t);const a=await Promise.all(rangeFromTo(n,o).map(c=>this.get(c,{valueEncoding:{decode:l=>l}})));for(let c=0;c<s.length;c++){const l=arrayToBuffer(s[c]),h=arrayToBuffer(a[c]);if(!l.equals(h))throw new Error("Feed corruption on clear. There has likely been a data loss.")}}},BatchedReadStream=class extends streamx.Readable{constructor(e,t={}){super({objectMode:!0}),this._reading=!1,invariant$1(t.live===!0,"Only live mode supported",{F:__dxlog_file$m,L:242,S:this,A:["opts.live === true","'Only live mode supported'"]}),invariant$1(t.batch!==void 0&&t.batch>1,void 0,{F:__dxlog_file$m,L:243,S:this,A:["opts.batch !== undefined && opts.batch > 1",""]}),this._feed=e,this._batch=t.batch,this._cursor=t.start??0}_open(e){this._feed.ready(e)}_read(e){this._reading||(this._feed.bitfield.total(this._cursor,this._cursor+this._batch)===this._batch?this._batchedRead(e):this._nonBatchedRead(e))}_nonBatchedRead(e){this._feed.get(this._cursor,{wait:!0},(t,r)=>{t?e(t):(this._cursor++,this._reading=!1,this.push(r),e(null))})}_batchedRead(e){this._feed.getBatch(this._cursor,this._cursor+this._batch,{wait:!0},(t,r)=>{if(t)e(t);else{this._cursor+=r.length,this._reading=!1;for(const n of r)this.push(n);e(null)}})}},__dxlog_file2$e="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-factory.ts",FeedFactory=class{constructor({root:e,signer:t,hypercore:r}){log("FeedFactory",{options:r},{F:__dxlog_file2$e,L:43,S:this,C:(n,o)=>n(...o)}),this._root=e??failUndefined(),this._signer=t,this._hypercoreOptions=r}get storageRoot(){return this._root}async createFeed(e,t){if(t!=null&&t.writable&&!this._signer)throw new Error("Signer required to create writable feeds.");t!=null&&t.secretKey&&log.warn("Secret key ignored due to signer.",void 0,{F:__dxlog_file2$e,L:58,S:this,C:(a,c)=>a(...c)});const r=await subtleCrypto.digest("SHA-256",export_Buffer.from(e.toHex())),n=defaultsDeep({},this._hypercoreOptions,{secretKey:this._signer&&(t!=null&&t.writable)?export_Buffer.from("secret"):void 0,crypto:this._signer?createCrypto(this._signer,e):void 0,onwrite:t==null?void 0:t.onwrite,noiseKeyPair:{}},t),o=this._root.createDirectory(e.toHex()),s=export_hypercore(a=>{const{type:c,native:l}=o.getOrCreateFile(a);return log("created",{path:`${c}:${this._root.path}/${e.truncate()}/${a}`},{F:__dxlog_file2$e,L:82,S:this,C:(h,u)=>h(...u)}),l},export_Buffer.from(r),n);return new FeedWrapper(s,e,o)}},__dxlog_file3$d="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-store.ts",FeedStore=class{constructor({factory:e}){this._feeds=new ComplexMap(PublicKey.hash),this._mutexes=new ComplexMap(PublicKey.hash),this._closed=!1,this.feedOpened=new Event$1,this._factory=e??failUndefined()}get size(){return this._feeds.size}get feeds(){return Array.from(this._feeds.values())}getFeed(e){return this._feeds.get(e)}async openFeed(e,{writable:t,sparse:r}={}){return log("opening feed",{feedKey:e},{F:__dxlog_file3$d,L:55,S:this,C:(n,o)=>n(...o)}),invariant$1(e,void 0,{F:__dxlog_file3$d,L:56,S:this,A:["feedKey",""]}),invariant$1(!this._closed,"Feed store is closed",{F:__dxlog_file3$d,L:57,S:this,A:["!this._closed","'Feed store is closed'"]}),defaultMap(this._mutexes,e,()=>new Mutex).executeSynchronized(async()=>{let n=this.getFeed(e);if(n){if(t&&!n.properties.writable)throw new Error(`Read-only feed is already open: ${e.truncate()}`);if((r??!1)!==n.properties.sparse)throw new Error(`Feed already open with different sparse setting: ${e.truncate()} [${r} !== ${n.properties.sparse}]`);return await n.open(),n}return n=await this._factory.createFeed(e,{writable:t,sparse:r}),this._feeds.set(n.key,n),await n.open(),this.feedOpened.emit(n),log("opened",{feedKey:e},{F:__dxlog_file3$d,L:85,S:this,C:(o,s)=>o(...s)}),n})}async close(){log("closing...",void 0,{F:__dxlog_file3$d,L:94,S:this,C:(e,t)=>e(...t)}),this._closed=!0,await Promise.all(Array.from(this._feeds.values()).map(async e=>{await e.close(),invariant$1(e.closed,void 0,{F:__dxlog_file3$d,L:99,S:this,A:["feed.closed",""]})})),this._feeds.clear(),log("closed",void 0,{F:__dxlog_file3$d,L:108,S:this,C:(e,t)=>e(...t)})}};function isPrimitive(e){return e===null||typeof e!="object"&&typeof e!="function"}function addRaceContender(e){const t=new Set,r={deferreds:t,settled:!1};return Promise.resolve(e).then(n=>{for(const{resolve:o}of t)o(n);t.clear(),r.settled=!0},n=>{for(const{reject:o}of t)o(n);t.clear(),r.settled=!0}),r}const wm=new WeakMap;function safeRace(e){let t;return new Promise((r,n)=>{t={resolve:r,reject:n};for(const o of e){if(isPrimitive(o)){Promise.resolve(o).then(r,n);continue}let s=wm.get(o);s===void 0?(s=addRaceContender(o),s.deferreds.add(t),wm.set(o,s)):s.settled?Promise.resolve(o).then(r,n):s.deferreds.add(t)}}).finally(()=>{for(const r of e)isPrimitive(r)||wm.get(r).deferreds.delete(t)})}var raceAsPromised=safeRace;const safeRace$1=getDefaultExportFromCjs(raceAsPromised);var __dxlog_file$l="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-queue.ts",defaultReadStreamOptions={live:!0,batch:1024},FeedQueue=class{constructor(e,t={}){this._feed=e,this._options=t,this.updated=new Event$1,this._messageTrigger=new Trigger({autoReset:!0}),this._feedConsumer=void 0,this._currentBlock=void 0,this._index=-1}[export_inspect.custom](){return inspectObject(this)}toJSON(){return{feedKey:this._feed.key,index:this.index,length:this.length,open:this.isOpen}}get feed(){return this._feed}get isOpen(){return!!this._feedConsumer}get length(){return this._feed.properties.length}get index(){return this._index}async open(e={}){if(this.isOpen)return;this._index=e.start??0,log("opening",{feedKey:this._feed.key},{F:__dxlog_file$l,L:92,S:this,C:(s,a)=>s(...a)});const t=Object.assign({},defaultReadStreamOptions,e),r=this._feed.createReadableStream(t);this._feedConsumer=new streamx.Writable({write:(s,a)=>{this._next=()=>{this._next=void 0,this._currentBlock=void 0,this._index++,a()},this._currentBlock={feedKey:this._feed.key,seq:this._index,data:s},this._messageTrigger.wake(this._currentBlock),this.updated.emit(this)}});const n=()=>{var s,a;this.feed.core.off("close",n),(s=this._feedConsumer)==null||s.off("close",n),(a=this._feedConsumer)==null||a.off("error",o),this._destroyConsumer()},o=s=>{s&&(s.message==="Writable stream closed prematurely"||s.message==="Feed is closed"||log.catch(s,{feedKey:this._feed.key},{F:__dxlog_file$l,L:135,S:this,C:(a,c)=>a(...c)}))};this._feed.core.once("close",n),this._feedConsumer.on("error",o),this._feedConsumer.once("close",n),r.pipe(this._feedConsumer,s=>{s&&o(s),this._destroyConsumer()}),log("opened",void 0,{F:__dxlog_file$l,L:153,S:this,C:(s,a)=>s(...a)})}async close(){var e;if(this.isOpen){invariant$1(this._feedConsumer,void 0,{F:__dxlog_file$l,L:161,S:this,A:["this._feedConsumer",""]}),invariant$1(!this._feed.properties.closed,void 0,{F:__dxlog_file$l,L:162,S:this,A:["!this._feed.properties.closed",""]}),log("closing",{feedKey:this._feed.key},{F:__dxlog_file$l,L:164,S:this,C:(n,o)=>n(...o)});const[t,r]=latch();this._feedConsumer.once("close",r),this._feedConsumer.destroy(),(e=this._next)==null||e.call(this),await t(),log("closed",void 0,{F:__dxlog_file$l,L:170,S:this,C:(n,o)=>n(...o)})}}peek(){return this._currentBlock}async pop(){var t;if(!this.isOpen)throw new Error(`Queue closed: ${this.feed.key.truncate()}`);let e=this.peek();return e||(e=await this._messageTrigger.wait()),e&&((t=this._next)==null||t.call(this)),e}_destroyConsumer(){this._feedConsumer&&(log("queue closed",{feedKey:this._feed.key},{F:__dxlog_file$l,L:203,S:this,C:(e,t)=>e(...t)}),this._feedConsumer=void 0,this._next=void 0,this._currentBlock=void 0,this._index=-1)}},__dxlog_file2$d="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-iterator.ts",AbstractFeedIterator=class{constructor(){this._stopTrigger=new Trigger,this._open=!1,this._running=!1}toJSON(){return{open:this.isOpen,running:this.isRunning}}get isOpen(){return this._open}get isRunning(){return this._running}async open(){this._open||(log("opening...",void 0,{F:__dxlog_file2$d,L:41,S:this,C:(e,t)=>e(...t)}),await this._onOpen(),this._open=!0,await this.start(),log("opened",void 0,{F:__dxlog_file2$d,L:46,S:this,C:(e,t)=>e(...t)}))}async close(){this._open&&(log("closing...",void 0,{F:__dxlog_file2$d,L:52,S:this,C:(e,t)=>e(...t)}),await this.stop(),await this._onClose(),this._open=!1,log("closed",void 0,{F:__dxlog_file2$d,L:57,S:this,C:(e,t)=>e(...t)}))}async start(){invariant$1(this._open,void 0,{F:__dxlog_file2$d,L:62,S:this,A:["this._open",""]}),this._running||(this._running=!0)}async stop(){invariant$1(this._open,void 0,{F:__dxlog_file2$d,L:69,S:this,A:["this._open",""]}),this._running&&(this._running=!1,this._stopTrigger.wake())}[Symbol.asyncIterator](){return this._generator()}async*_generator(){for(log("started",void 0,{F:__dxlog_file2$d,L:85,S:this,C:(e,t)=>e(...t)});this._running;){const e=await safeRace$1([this._stopTrigger.wait(),this._nextBlock()]);if(e===void 0)break;yield e}log("stopped",void 0,{F:__dxlog_file2$d,L:97,S:this,C:(e,t)=>e(...t)})}},FeedIterator=class extends AbstractFeedIterator{constructor(e){super(),this._feed=e,this._queue=new FeedQueue(this._feed)}async _onOpen(){await this._queue.open()}async _onClose(){await this._queue.close()}async _nextBlock(){return this._queue.pop()}},__dxlog_file3$c="/home/runner/work/dxos/dxos/packages/common/feed-store/src/feed-set-iterator.ts",defaultFeedSetIteratorOptions={stallTimeout:1e3},FeedSetIterator=class extends AbstractFeedIterator{constructor(e,t=defaultFeedSetIteratorOptions){super(),this._selector=e,this.options=t,this._feedQueues=new ComplexMap(PublicKey.hash),this._trigger=new Trigger({autoReset:!0}),this._subscriptions=new EventSubscriptions,this.stalled=new Event$1,invariant$1(e,void 0,{F:__dxlog_file3$c,L:55,S:this,A:["_selector",""]}),invariant$1(t,void 0,{F:__dxlog_file3$c,L:56,S:this,A:["options",""]})}[export_inspect.custom](){return inspectObject(this)}toJSON(){return{open:this.isOpen,running:this.isRunning,indexes:this.indexes}}get size(){return this._feedQueues.size}get feeds(){return Array.from(this._feedQueues.values()).map(e=>e.feed)}get indexes(){return Array.from(this._feedQueues.values()).map(e=>({feedKey:e.feed.key,index:e.index}))}async addFeed(e){var r,n;invariant$1(!this._feedQueues.has(e.key),`Feed already added: ${e.key}`,{F:__dxlog_file3$c,L:87,S:this,A:["!this._feedQueues.has(feed.key)","`Feed already added: ${feed.key}`"]}),invariant$1(e.properties.opened,void 0,{F:__dxlog_file3$c,L:88,S:this,A:["feed.properties.opened",""]}),log("feed added",{feedKey:e.key},{F:__dxlog_file3$c,L:89,S:this,C:(o,s)=>o(...s)});const t=new FeedQueue(e);this._feedQueues.set(e.key,t),this._subscriptions.add(t.updated.on(()=>{this._trigger.wake()})),await t.open({start:(n=(r=this.options.start)==null?void 0:r.find(o=>o.feedKey.equals(e.key)))==null?void 0:n.index}),this._trigger.wake()}hasFeed(e){return this._feedQueues.has(e)}async _onOpen(){for(const e of this._feedQueues.values())await e.open()}async _onClose(){this._subscriptions.clear(),await Promise.all(Array.from(this._feedQueues.values()).map(e=>e.close())),this._trigger.wake()}async _nextBlock(){let e;for(;this._running;){const t=Array.from(this._feedQueues.values()).map(r=>r.peek()).filter(isNotNullOrUndefined);if(t.length){const r=this._selector(t);if(log("selected",{idx:r,blocks:t},{F:__dxlog_file3$c,L:139,S:this,C:(n,o)=>n(...o)}),r===void 0)e===void 0&&(e=setTimeout(()=>{this.stalled.emit(this)},this.options.stallTimeout));else{if(e!==void 0&&(clearTimeout(e),e=void 0),r>=t.length)throw new Error(`Index out of bounds: ${r} of ${t.length}`);const n=this._feedQueues.get(t[r].feedKey);log("popping",n.toJSON(),{F:__dxlog_file3$c,L:158,S:this,C:(o,s)=>o(...s)});try{const o=await n.pop();return invariant$1(o===t[r],void 0,{F:__dxlog_file3$c,L:161,S:this,A:["message === blocks[idx]",""]}),o}catch{log.warn("queue closed",{feedKey:n.feed.key},{F:__dxlog_file3$c,L:165,S:this,C:(o,s)=>o(...s)})}}}await this._trigger.wait()}}},writeMessages=async(e,t)=>{const r=[];for(const n of t)r.push(await e.write(n));return r},jsonify={},parse$1,hasRequiredParse;function requireParse(){if(hasRequiredParse)return parse$1;hasRequiredParse=1;var e,t,r={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},n;function o(_){throw{name:"SyntaxError",message:_,at:e,text:n}}function s(_){return _&&_!==t&&o("Expected '"+_+"' instead of '"+t+"'"),t=n.charAt(e),e+=1,t}function a(){var _,p="";for(t==="-"&&(p="-",s("-"));t>="0"&&t<="9";)p+=t,s();if(t===".")for(p+=".";s()&&t>="0"&&t<="9";)p+=t;if(t==="e"||t==="E")for(p+=t,s(),(t==="-"||t==="+")&&(p+=t,s());t>="0"&&t<="9";)p+=t,s();return _=Number(p),isFinite(_)||o("Bad number"),_}function c(){var _,p,y="",w;if(t==='"')for(;s();){if(t==='"')return s(),y;if(t==="\\")if(s(),t==="u"){for(w=0,p=0;p<4&&(_=parseInt(s(),16),!!isFinite(_));p+=1)w=w*16+_;y+=String.fromCharCode(w)}else if(typeof r[t]=="string")y+=r[t];else break;else y+=t}o("Bad string")}function l(){for(;t&&t<=" ";)s()}function h(){switch(t){case"t":return s("t"),s("r"),s("u"),s("e"),!0;case"f":return s("f"),s("a"),s("l"),s("s"),s("e"),!1;case"n":return s("n"),s("u"),s("l"),s("l"),null;default:o("Unexpected '"+t+"'")}}function u(){var _=[];if(t==="["){if(s("["),l(),t==="]")return s("]"),_;for(;t;){if(_.push(f()),l(),t==="]")return s("]"),_;s(","),l()}}o("Bad array")}function d(){var _,p={};if(t==="{"){if(s("{"),l(),t==="}")return s("}"),p;for(;t;){if(_=c(),l(),s(":"),Object.prototype.hasOwnProperty.call(p,_)&&o('Duplicate key "'+_+'"'),p[_]=f(),l(),t==="}")return s("}"),p;s(","),l()}}o("Bad object")}function f(){switch(l(),t){case"{":return d();case"[":return u();case'"':return c();case"-":return a();default:return t>="0"&&t<="9"?a():h()}}return parse$1=function(_,p){var y;return n=_,e=0,t=" ",y=f(),l(),t&&o("Syntax error"),typeof p=="function"?function w(E,x){var B,P,U=E[x];if(U&&typeof U=="object")for(B in f)Object.prototype.hasOwnProperty.call(U,B)&&(P=w(U,B),typeof P>"u"?delete U[B]:U[B]=P);return p.call(E,x,U)}({"":y},""):y},parse$1}var stringify$1,hasRequiredStringify;function requireStringify(){if(hasRequiredStringify)return stringify$1;hasRequiredStringify=1;var e=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,t,r,n={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},o;function s(c){return e.lastIndex=0,e.test(c)?'"'+c.replace(e,function(l){var h=n[l];return typeof h=="string"?h:"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+c+'"'}function a(c,l){var h,u,d,f,_=t,p,y=l[c];switch(y&&typeof y=="object"&&typeof y.toJSON=="function"&&(y=y.toJSON(c)),typeof o=="function"&&(y=o.call(l,c,y)),typeof y){case"string":return s(y);case"number":return isFinite(y)?String(y):"null";case"boolean":case"null":return String(y);case"object":if(!y)return"null";if(t+=r,p=[],Object.prototype.toString.apply(y)==="[object Array]"){for(f=y.length,h=0;h<f;h+=1)p[h]=a(h,y)||"null";return d=p.length===0?"[]":t?`[
`+t+p.join(`,
`+t)+`
`+_+"]":"["+p.join(",")+"]",t=_,d}if(o&&typeof o=="object")for(f=o.length,h=0;h<f;h+=1)u=o[h],typeof u=="string"&&(d=a(u,y),d&&p.push(s(u)+(t?": ":":")+d));else for(u in y)Object.prototype.hasOwnProperty.call(y,u)&&(d=a(u,y),d&&p.push(s(u)+(t?": ":":")+d));return d=p.length===0?"{}":t?`{
`+t+p.join(`,
`+t)+`
`+_+"}":"{"+p.join(",")+"}",t=_,d}}return stringify$1=function(c,l,h){var u;if(t="",r="",typeof h=="number")for(u=0;u<h;u+=1)r+=" ";else typeof h=="string"&&(r=h);if(o=l,l&&typeof l!="function"&&(typeof l!="object"||typeof l.length!="number"))throw new Error("JSON.stringify");return a("",{"":c})},stringify$1}var hasRequiredJsonify;function requireJsonify(){return hasRequiredJsonify||(hasRequiredJsonify=1,jsonify.parse=requireParse(),jsonify.stringify=requireStringify()),jsonify}var toString$3={}.toString,isarray=Array.isArray||function(e){return toString$3.call(e)=="[object Array]"},toStr$1=Object.prototype.toString,isArguments=function e(t){var r=toStr$1.call(t),n=r==="[object Arguments]";return n||(n=r!=="[object Array]"&&t!==null&&typeof t=="object"&&typeof t.length=="number"&&t.length>=0&&toStr$1.call(t.callee)==="[object Function]"),n},implementation$2,hasRequiredImplementation;function requireImplementation(){if(hasRequiredImplementation)return implementation$2;hasRequiredImplementation=1;var e;if(!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,n=isArguments,o=Object.prototype.propertyIsEnumerable,s=!o.call({toString:null},"toString"),a=o.call(function(){},"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],l=function(f){var _=f.constructor;return _&&_.prototype===f},h={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if(typeof window>"u")return!1;for(var f in window)try{if(!h["$"+f]&&t.call(window,f)&&window[f]!==null&&typeof window[f]=="object")try{l(window[f])}catch{return!0}}catch{return!0}return!1}(),d=function(f){if(typeof window>"u"||!u)return l(f);try{return l(f)}catch{return!1}};e=function(f){var _=f!==null&&typeof f=="object",p=r.call(f)==="[object Function]",y=n(f),w=_&&r.call(f)==="[object String]",E=[];if(!_&&!p&&!y)throw new TypeError("Object.keys called on a non-object");var x=a&&p;if(w&&f.length>0&&!t.call(f,0))for(var B=0;B<f.length;++B)E.push(String(B));if(y&&f.length>0)for(var P=0;P<f.length;++P)E.push(String(P));else for(var U in f)!(x&&U==="prototype")&&t.call(f,U)&&E.push(String(U));if(s)for(var F=d(f),G=0;G<c.length;++G)!(F&&c[G]==="constructor")&&t.call(f,c[G])&&E.push(c[G]);return E}}return implementation$2=e,implementation$2}var slice=Array.prototype.slice,isArgs=isArguments,origKeys=Object.keys,keysShim=origKeys?function e(t){return origKeys(t)}:requireImplementation(),originalKeys=Object.keys;keysShim.shim=function e(){if(Object.keys){var t=function(){var r=Object.keys(arguments);return r&&r.length===arguments.length}(1,2);t||(Object.keys=function(r){return isArgs(r)?originalKeys(slice.call(r)):originalKeys(r)})}else Object.keys=keysShim;return Object.keys||keysShim};var objectKeys$1=keysShim,callBind$2={exports:{}},ERROR_MESSAGE="Function.prototype.bind called on incompatible ",toStr=Object.prototype.toString,max=Math.max,funcType="[object Function]",concatty=function e(t,r){for(var n=[],o=0;o<t.length;o+=1)n[o]=t[o];for(var s=0;s<r.length;s+=1)n[s+t.length]=r[s];return n},slicy=function e(t,r){for(var n=[],o=r,s=0;o<t.length;o+=1,s+=1)n[s]=t[o];return n},joiny=function(e,t){for(var r="",n=0;n<e.length;n+=1)r+=e[n],n+1<e.length&&(r+=t);return r},implementation$1=function e(t){var r=this;if(typeof r!="function"||toStr.apply(r)!==funcType)throw new TypeError(ERROR_MESSAGE+r);for(var n=slicy(arguments,1),o,s=function(){if(this instanceof o){var u=r.apply(this,concatty(n,arguments));return Object(u)===u?u:this}return r.apply(t,concatty(n,arguments))},a=max(0,r.length-n.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(o=Function("binder","return function ("+joiny(c,",")+"){ return binder.apply(this,arguments); }")(s),r.prototype){var h=function(){};h.prototype=r.prototype,o.prototype=new h,h.prototype=null}return o},implementation=implementation$1,functionBind=Function.prototype.bind||implementation,esErrors=Error,_eval=EvalError,range=RangeError,ref=ReferenceError,syntax=SyntaxError,type=TypeError,uri=URIError,shams=function e(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var t={},r=Symbol("test"),n=Object(r);if(typeof r=="string"||Object.prototype.toString.call(r)!=="[object Symbol]"||Object.prototype.toString.call(n)!=="[object Symbol]")return!1;var o=42;t[r]=o;for(r in t)return!1;if(typeof Object.keys=="function"&&Object.keys(t).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(t).length!==0)return!1;var s=Object.getOwnPropertySymbols(t);if(s.length!==1||s[0]!==r||!Object.prototype.propertyIsEnumerable.call(t,r))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var a=Object.getOwnPropertyDescriptor(t,r);if(a.value!==o||a.enumerable!==!0)return!1}return!0},origSymbol=typeof Symbol<"u"&&Symbol,hasSymbolSham=shams,hasSymbols$1=function e(){return typeof origSymbol!="function"||typeof Symbol!="function"||typeof origSymbol("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:hasSymbolSham()},test={__proto__:null,foo:{}},$Object=Object,hasProto$1=function e(){return{__proto__:test}.foo===test.foo&&!(test instanceof $Object)},call=Function.prototype.call,$hasOwn=Object.prototype.hasOwnProperty,bind$1=functionBind,hasown=bind$1.call(call,$hasOwn),undefined$1,$Error=esErrors,$EvalError=_eval,$RangeError=range,$ReferenceError=ref,$SyntaxError$1=syntax,$TypeError$2=type,$URIError=uri,$Function=Function,getEvalledConstructor=function(e){try{return $Function('"use strict"; return ('+e+").constructor;")()}catch{}},$gOPD$1=Object.getOwnPropertyDescriptor;if($gOPD$1)try{$gOPD$1({},"")}catch{$gOPD$1=null}var throwTypeError=function(){throw new $TypeError$2},ThrowTypeError=$gOPD$1?function(){try{return arguments.callee,throwTypeError}catch{try{return $gOPD$1(arguments,"callee").get}catch{return throwTypeError}}}():throwTypeError,hasSymbols=hasSymbols$1(),hasProto=hasProto$1(),getProto=Object.getPrototypeOf||(hasProto?function(e){return e.__proto__}:null),needsEval={},TypedArray=typeof Uint8Array>"u"||!getProto?undefined$1:getProto(Uint8Array),INTRINSICS={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?undefined$1:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?undefined$1:ArrayBuffer,"%ArrayIteratorPrototype%":hasSymbols&&getProto?getProto([][Symbol.iterator]()):undefined$1,"%AsyncFromSyncIteratorPrototype%":undefined$1,"%AsyncFunction%":needsEval,"%AsyncGenerator%":needsEval,"%AsyncGeneratorFunction%":needsEval,"%AsyncIteratorPrototype%":needsEval,"%Atomics%":typeof Atomics>"u"?undefined$1:Atomics,"%BigInt%":typeof BigInt>"u"?undefined$1:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?undefined$1:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?undefined$1:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?undefined$1:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":$Error,"%eval%":eval,"%EvalError%":$EvalError,"%Float32Array%":typeof Float32Array>"u"?undefined$1:Float32Array,"%Float64Array%":typeof Float64Array>"u"?undefined$1:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?undefined$1:FinalizationRegistry,"%Function%":$Function,"%GeneratorFunction%":needsEval,"%Int8Array%":typeof Int8Array>"u"?undefined$1:Int8Array,"%Int16Array%":typeof Int16Array>"u"?undefined$1:Int16Array,"%Int32Array%":typeof Int32Array>"u"?undefined$1:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":hasSymbols&&getProto?getProto(getProto([][Symbol.iterator]())):undefined$1,"%JSON%":typeof JSON=="object"?JSON:undefined$1,"%Map%":typeof Map>"u"?undefined$1:Map,"%MapIteratorPrototype%":typeof Map>"u"||!hasSymbols||!getProto?undefined$1:getProto(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?undefined$1:Promise,"%Proxy%":typeof Proxy>"u"?undefined$1:Proxy,"%RangeError%":$RangeError,"%ReferenceError%":$ReferenceError,"%Reflect%":typeof Reflect>"u"?undefined$1:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?undefined$1:Set,"%SetIteratorPrototype%":typeof Set>"u"||!hasSymbols||!getProto?undefined$1:getProto(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?undefined$1:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":hasSymbols&&getProto?getProto(""[Symbol.iterator]()):undefined$1,"%Symbol%":hasSymbols?Symbol:undefined$1,"%SyntaxError%":$SyntaxError$1,"%ThrowTypeError%":ThrowTypeError,"%TypedArray%":TypedArray,"%TypeError%":$TypeError$2,"%Uint8Array%":typeof Uint8Array>"u"?undefined$1:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?undefined$1:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?undefined$1:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?undefined$1:Uint32Array,"%URIError%":$URIError,"%WeakMap%":typeof WeakMap>"u"?undefined$1:WeakMap,"%WeakRef%":typeof WeakRef>"u"?undefined$1:WeakRef,"%WeakSet%":typeof WeakSet>"u"?undefined$1:WeakSet};if(getProto)try{null.error}catch(e){var errorProto=getProto(getProto(e));INTRINSICS["%Error.prototype%"]=errorProto}var doEval=function e(t){var r;if(t==="%AsyncFunction%")r=getEvalledConstructor("async function () {}");else if(t==="%GeneratorFunction%")r=getEvalledConstructor("function* () {}");else if(t==="%AsyncGeneratorFunction%")r=getEvalledConstructor("async function* () {}");else if(t==="%AsyncGenerator%"){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if(t==="%AsyncIteratorPrototype%"){var o=e("%AsyncGenerator%");o&&getProto&&(r=getProto(o.prototype))}return INTRINSICS[t]=r,r},LEGACY_ALIASES={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},bind=functionBind,hasOwn=hasown,$concat=bind.call(Function.call,Array.prototype.concat),$spliceApply=bind.call(Function.apply,Array.prototype.splice),$replace=bind.call(Function.call,String.prototype.replace),$strSlice=bind.call(Function.call,String.prototype.slice),$exec=bind.call(Function.call,RegExp.prototype.exec),rePropName$2=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,reEscapeChar$2=/\\(\\)?/g,stringToPath$1=function e(t){var r=$strSlice(t,0,1),n=$strSlice(t,-1);if(r==="%"&&n!=="%")throw new $SyntaxError$1("invalid intrinsic syntax, expected closing `%`");if(n==="%"&&r!=="%")throw new $SyntaxError$1("invalid intrinsic syntax, expected opening `%`");var o=[];return $replace(t,rePropName$2,function(s,a,c,l){o[o.length]=c?$replace(l,reEscapeChar$2,"$1"):a||s}),o},getBaseIntrinsic=function e(t,r){var n=t,o;if(hasOwn(LEGACY_ALIASES,n)&&(o=LEGACY_ALIASES[n],n="%"+o[0]+"%"),hasOwn(INTRINSICS,n)){var s=INTRINSICS[n];if(s===needsEval&&(s=doEval(n)),typeof s>"u"&&!r)throw new $TypeError$2("intrinsic "+t+" exists, but is not available. Please file an issue!");return{alias:o,name:n,value:s}}throw new $SyntaxError$1("intrinsic "+t+" does not exist!")},getIntrinsic=function e(t,r){if(typeof t!="string"||t.length===0)throw new $TypeError$2("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof r!="boolean")throw new $TypeError$2('"allowMissing" argument must be a boolean');if($exec(/^%?[^%]*%?$/,t)===null)throw new $SyntaxError$1("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var n=stringToPath$1(t),o=n.length>0?n[0]:"",s=getBaseIntrinsic("%"+o+"%",r),a=s.name,c=s.value,l=!1,h=s.alias;h&&(o=h[0],$spliceApply(n,$concat([0,1],h)));for(var u=1,d=!0;u<n.length;u+=1){var f=n[u],_=$strSlice(f,0,1),p=$strSlice(f,-1);if((_==='"'||_==="'"||_==="`"||p==='"'||p==="'"||p==="`")&&_!==p)throw new $SyntaxError$1("property names with quotes must have matching quotes");if((f==="constructor"||!d)&&(l=!0),o+="."+f,a="%"+o+"%",hasOwn(INTRINSICS,a))c=INTRINSICS[a];else if(c!=null){if(!(f in c)){if(!r)throw new $TypeError$2("base intrinsic for "+t+" exists, but the property is not available.");return}if($gOPD$1&&u+1>=n.length){var y=$gOPD$1(c,f);d=!!y,d&&"get"in y&&!("originalValue"in y.get)?c=y.get:c=c[f]}else d=hasOwn(c,f),c=c[f];d&&!l&&(INTRINSICS[a]=c)}}return c},esDefineProperty,hasRequiredEsDefineProperty;function requireEsDefineProperty(){if(hasRequiredEsDefineProperty)return esDefineProperty;hasRequiredEsDefineProperty=1;var e=getIntrinsic,t=e("%Object.defineProperty%",!0)||!1;if(t)try{t({},"a",{value:1})}catch{t=!1}return esDefineProperty=t,esDefineProperty}var GetIntrinsic$2=getIntrinsic,$gOPD=GetIntrinsic$2("%Object.getOwnPropertyDescriptor%",!0);if($gOPD)try{$gOPD([],"length")}catch{$gOPD=null}var gopd$1=$gOPD,$defineProperty$1=requireEsDefineProperty(),$SyntaxError=syntax,$TypeError$1=type,gopd=gopd$1,defineDataProperty=function e(t,r,n){if(!t||typeof t!="object"&&typeof t!="function")throw new $TypeError$1("`obj` must be an object or a function`");if(typeof r!="string"&&typeof r!="symbol")throw new $TypeError$1("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new $TypeError$1("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new $TypeError$1("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new $TypeError$1("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new $TypeError$1("`loose`, if provided, must be a boolean");var o=arguments.length>3?arguments[3]:null,s=arguments.length>4?arguments[4]:null,a=arguments.length>5?arguments[5]:null,c=arguments.length>6?arguments[6]:!1,l=!!gopd&&gopd(t,r);if($defineProperty$1)$defineProperty$1(t,r,{configurable:a===null&&l?l.configurable:!a,enumerable:o===null&&l?l.enumerable:!o,value:n,writable:s===null&&l?l.writable:!s});else if(c||!o&&!s&&!a)t[r]=n;else throw new $SyntaxError("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")},$defineProperty=requireEsDefineProperty(),hasPropertyDescriptors=function e(){return!!$defineProperty};hasPropertyDescriptors.hasArrayLengthDefineBug=function e(){if(!$defineProperty)return null;try{return $defineProperty([],"length",{value:1}).length!==1}catch{return!0}};var hasPropertyDescriptors_1=hasPropertyDescriptors,GetIntrinsic$1=getIntrinsic,define=defineDataProperty,hasDescriptors=hasPropertyDescriptors_1(),gOPD=gopd$1,$TypeError=type,$floor=GetIntrinsic$1("%Math.floor%"),setFunctionLength=function e(t,r){if(typeof t!="function")throw new $TypeError("`fn` is not a function");if(typeof r!="number"||r<0||r>4294967295||$floor(r)!==r)throw new $TypeError("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],o=!0,s=!0;if("length"in t&&gOPD){var a=gOPD(t,"length");a&&!a.configurable&&(o=!1),a&&!a.writable&&(s=!1)}return(o||s||!n)&&(hasDescriptors?define(t,"length",r,!0,!0):define(t,"length",r)),t};(function(e){var t=functionBind,r=getIntrinsic,n=setFunctionLength,o=type,s=r("%Function.prototype.apply%"),a=r("%Function.prototype.call%"),c=r("%Reflect.apply%",!0)||t.call(a,s),l=requireEsDefineProperty(),h=r("%Math.max%");e.exports=function(d){if(typeof d!="function")throw new o("a function is required");var f=c(t,a,arguments);return n(f,1+h(0,d.length-(arguments.length-1)),!0)};var u=function(){return c(t,s,arguments)};l?l(e.exports,"apply",{value:u}):e.exports.apply=u})(callBind$2);var callBindExports=callBind$2.exports,GetIntrinsic=getIntrinsic,callBind$1=callBindExports,$indexOf=callBind$1(GetIntrinsic("String.prototype.indexOf")),callBound$1=function e(t,r){var n=GetIntrinsic(t,!!r);return typeof n=="function"&&$indexOf(t,".prototype.")>-1?callBind$1(n):n},jsonStringify=(typeof JSON<"u"?JSON:requireJsonify()).stringify,isArray$2=isarray,objectKeys=objectKeys$1,callBind=callBindExports,callBound=callBound$1,$join=callBound("Array.prototype.join"),$push=callBound("Array.prototype.push"),strRepeat=function e(t,r){for(var n="",o=0;o<t;o+=1)n+=r;return n},defaultReplacer=function(e,t,r){return r},jsonStableStringify=function e(t){var r=arguments.length>1?arguments[1]:void 0,n=r&&r.space||"";typeof n=="number"&&(n=strRepeat(n," "));var o=!!r&&typeof r.cycles=="boolean"&&r.cycles,s=r&&r.replacer?callBind(r.replacer):defaultReplacer,a=typeof r=="function"?r:r&&r.cmp,c=a&&function(h){var u=a.length>2&&function(d){return h[d]};return function(d,f){return a({key:d,value:h[d]},{key:f,value:h[f]},u?{__proto__:null,get:u}:void 0)}},l=[];return function h(u,d,f,_){var p=n?`
`+strRepeat(_,n):"",y=n?": ":":";if(f&&f.toJSON&&typeof f.toJSON=="function"&&(f=f.toJSON()),f=s(u,d,f),f!==void 0){if(typeof f!="object"||f===null)return jsonStringify(f);if(isArray$2(f)){for(var w=[],E=0;E<f.length;E++){var x=h(f,E,f[E],_+1)||jsonStringify(null);$push(w,p+n+x)}return"["+$join(w,",")+p+"]"}if(l.indexOf(f)!==-1){if(o)return jsonStringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else $push(l,f);for(var B=objectKeys(f).sort(c&&c(f)),w=[],E=0;E<B.length;E++){var d=B[E],P=h(f,d,f[d],_+1);if(P){var U=jsonStringify(d)+y+P;$push(w,p+n+U)}}return l.splice(l.indexOf(f),1),"{"+$join(w,",")+p+"}"}}({"":t},"",t,0)};const stableStringify=getDefaultExportFromCjs(jsonStableStringify);var SpaceMember;(function(e){(function(t){t[t.INVALID=0]="INVALID",t[t.ADMIN=1]="ADMIN",t[t.EDITOR=2]="EDITOR",t[t.READER=3]="READER",t[t.OWNER=4]="OWNER",t[t.REMOVED=5]="REMOVED"})(e.Role||(e.Role={}))})(SpaceMember||(SpaceMember={}));var AdmittedFeed;(function(e){(function(t){t[t.GENERAL=0]="GENERAL",t[t.CONTROL=1]="CONTROL",t[t.DATA=2]="DATA"})(e.Designation||(e.Designation={}))})(AdmittedFeed||(AdmittedFeed={}));var DeviceType;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BROWSER=1]="BROWSER",e[e.NATIVE=2]="NATIVE",e[e.AGENT=3]="AGENT",e[e.AGENT_MANAGED=4]="AGENT_MANAGED",e[e.MOBILE=5]="MOBILE"})(DeviceType||(DeviceType={}));var generatePasscode=(e=4)=>{let t="";for(let r=0;r<e;r++)t+=`${Math.floor(Math.random()*10)}`;return t},getCredentialProofPayload=e=>{var r;const t={...e,proof:{...e.proof,value:new Uint8Array,chain:void 0}};return((r=t.parentCredentialIds)==null?void 0:r.length)===0&&delete t.parentCredentialIds,delete t.id,export_Buffer.from(canonicalStringify(t))},canonicalStringify=e=>stableStringify(e,{replacer:function(t,r){if(t.toString().startsWith("__")||t.toString()==="@type"||r===null)return;const n=this[t];if(r){if(PublicKey.isPublicKey(r))return r.toHex();if(export_Buffer.isBuffer(r))return r.toString("hex");if(r instanceof Uint8Array)return arrayToBuffer(r).toString("hex");if(r.data&&r.type==="Buffer")return export_Buffer.from(r).toString("hex");if(n instanceof Timeframe)return n.frames().reduce((o,[s,a])=>(o[truncateKey(s)]=a,o),{})}return r}}),truncateKey=e=>{const t=e.toHex();return`${t.substring(0,4)}...${t.substring(t.length-4)}`},getPresentationProofPayload=(e,t)=>{const r={credentials:e.map(n=>{var s;const o={...n};return((s=o.parentCredentialIds)==null?void 0:s.length)===0&&delete o.parentCredentialIds,o}),proof:{...t,value:new Uint8Array,chain:void 0}};return export_Buffer.from(canonicalStringify(r))},getCredentialAssertion=e=>e.subject.assertion,isValidAuthorizedDeviceCredential=(e,t,r)=>{const n=getCredentialAssertion(e);return e.subject.id.equals(r)&&e.issuer.equals(t)&&n["@type"]==="dxos.halo.credentials.AuthorizedDevice"&&n.identityKey.equals(t)&&n.deviceKey.equals(r)},checkCredentialType=(e,t)=>e.subject.assertion["@type"]===t,credentialTypeFilter=e=>t=>checkCredentialType(t,e),SIGNATURE_TYPE_ED25519="ED25519Signature",verifyCredential=async e=>{var r;if(((r=e.parentCredentialIds)==null?void 0:r.length)===0&&delete e.parentCredentialIds,!e.issuer.equals(e.proof.signer)){if(!e.proof.chain)return{kind:"fail",errors:["Delegated credential is missing credential chain."]};const n=await verifyChain(e.proof.chain,e.issuer,e.proof.signer);if(n.kind==="fail")return n}const t=await verifyCredentialSignature(e);return t.kind==="fail"?t:{kind:"pass"}},verifyCredentialSignature=async e=>{if(e.proof.type!==SIGNATURE_TYPE_ED25519)return{kind:"fail",errors:[`Invalid signature type: ${e.proof.type}`]};const t=getCredentialProofPayload(e);return await verifySignature(e.proof.signer,t,e.proof.value)?{kind:"pass"}:{kind:"fail",errors:["Invalid signature"]}},verifyChain=async(e,t,r)=>{const n=await verifyCredential(e.credential);return n.kind==="fail"?n:isValidAuthorizedDeviceCredential(e.credential,t,r)?{kind:"pass"}:{kind:"fail",errors:[`Invalid credential chain: invalid assertion for key: ${r}`]}},__dxlog_file$k="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/credentials/credential-factory.ts",createCredential=async({signer:e,issuer:t,subject:r,assertion:n,signingKey:o,chain:s,nonce:a,parentCredentialIds:c})=>{if(invariant$1(n["@type"],"Invalid assertion.",{F:__dxlog_file$k,L:48,S:void 0,A:["assertion['@type']","'Invalid assertion.'"]}),invariant$1(!!o==!!s,"Chain must be provided if and only if the signing key differs from the issuer.",{F:__dxlog_file$k,L:49,S:void 0,A:["!!signingKey === !!chain","'Chain must be provided if and only if the signing key differs from the issuer.'"]}),s){const u=await verifyChain(s,t,o);invariant$1(u.kind==="pass","Invalid chain.",{F:__dxlog_file$k,L:52,S:void 0,A:["result.kind === 'pass'","'Invalid chain.'"]})}const l={issuer:t,issuanceDate:new Date,subject:{id:r,assertion:n},parentCredentialIds:c,proof:{type:SIGNATURE_TYPE_ED25519,creationDate:new Date,signer:o??t,value:new Uint8Array,nonce:a}},h=getCredentialProofPayload(l);return l.proof.value=await e.sign(o??t,h),s&&(l.proof.chain=s),l.id=PublicKey.from(await subtleCrypto.digest("SHA-256",h)),l},createCredentialSignerWithKey=(e,t)=>({getIssuer:()=>t,createCredential:({subject:r,assertion:n,nonce:o,parentCredentialIds:s})=>createCredential({signer:e,issuer:t,subject:r,assertion:n,nonce:o,parentCredentialIds:s})}),createCredentialSignerWithChain=(e,t,r)=>({getIssuer:()=>t.credential.issuer,createCredential:({subject:n,assertion:o,nonce:s,parentCredentialIds:a})=>createCredential({signer:e,issuer:t.credential.issuer,signingKey:r,chain:t,subject:n,assertion:o,nonce:s,parentCredentialIds:a})}),CredentialGenerator=class{constructor(e,t,r){this._signer=e,this._identityKey=t,this._deviceKey=r}async createSpaceGenesis(e,t,r){return[await createCredential({signer:this._signer,issuer:e,subject:e,assertion:{"@type":"dxos.halo.credentials.SpaceGenesis",spaceKey:e}}),await createCredential({signer:this._signer,issuer:e,subject:this._identityKey,assertion:{"@type":"dxos.halo.credentials.SpaceMember",spaceKey:e,role:SpaceMember.Role.ADMIN,profile:r,genesisFeedKey:t}}),await this.createFeedAdmission(e,t,AdmittedFeed.Designation.CONTROL)]}async createMemberInvitation(e,t,r,n,o,s){return[await createCredential({signer:this._signer,issuer:this._identityKey,subject:t,assertion:{"@type":"dxos.halo.credentials.SpaceMember",spaceKey:e,role:SpaceMember.Role.EDITOR,genesisFeedKey:s}}),await this.createFeedAdmission(e,n,AdmittedFeed.Designation.CONTROL),await this.createFeedAdmission(e,o,AdmittedFeed.Designation.DATA)]}async createDeviceAuthorization(e){return createCredential({signer:this._signer,issuer:this._identityKey,subject:e,assertion:{"@type":"dxos.halo.credentials.AuthorizedDevice",identityKey:this._identityKey,deviceKey:e}})}async createDeviceProfile(e){return createCredential({signer:this._signer,issuer:this._identityKey,subject:this._deviceKey,assertion:{"@type":"dxos.halo.credentials.DeviceProfile",profile:e}})}async createFeedAdmission(e,t,r){return createCredential({signer:this._signer,issuer:this._identityKey,subject:t,assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:e,identityKey:this._identityKey,deviceKey:this._deviceKey,designation:r}})}async createProfileCredential(e){return createCredential({signer:this._signer,issuer:this._identityKey,subject:this._identityKey,assertion:{"@type":"dxos.halo.credentials.IdentityProfile",profile:e}})}async createEpochCredential(e){return createCredential({signer:this._signer,issuer:this._identityKey,subject:e,assertion:{"@type":"dxos.halo.credentials.Epoch",number:0,timeframe:new Timeframe}})}},createAdmissionCredentials=async(e,t,r,n,o=SpaceMember.Role.ADMIN,s=[],a,c)=>(await Promise.all([await e.createCredential({subject:t,parentCredentialIds:s,assertion:{"@type":"dxos.halo.credentials.SpaceMember",spaceKey:r,role:o,profile:a,genesisFeedKey:n,invitationCredentialId:c}})])).map(l=>({credential:{credential:l}})),createDelegatedSpaceInvitationCredential=async(e,t,r)=>({credential:{credential:await e.createCredential({subject:t,assertion:{"@type":"dxos.halo.invitations.DelegateSpaceInvitation",invitationId:r.invitationId,authMethod:r.authMethod,swarmKey:r.swarmKey,role:r.role,guestKey:r.guestKey,expiresOn:r.expiresOn,multiUse:r.multiUse}})}}),createCancelDelegatedSpaceInvitationCredential=async(e,t,r)=>({credential:{credential:await e.createCredential({subject:t,assertion:{"@type":"dxos.halo.invitations.CancelDelegatedInvitation",credentialId:r}})}}),signPresentation=async({presentation:e,signer:t,signerKey:r,chain:n,nonce:o})=>{const s={type:SIGNATURE_TYPE_ED25519,value:new Uint8Array,creationDate:new Date,signer:r,nonce:o},a=getPresentationProofPayload(e.credentials??[],s);return s.value=await t.sign(r,a),n&&(s.chain=n),{credentials:e.credentials,proofs:[...e.proofs??[],s]}},__dxlog_file2$c="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/state-machine/feed-state-machine.ts",FeedStateMachine=class{constructor(e){this._spaceKey=e,this._feeds=new ComplexMap(PublicKey.hash),this.onFeedAdmitted=new Callback}get feeds(){return this._feeds}async process(e,t){const r=getCredentialAssertion(e);invariant$1(r["@type"]==="dxos.halo.credentials.AdmittedFeed",void 0,{F:__dxlog_file2$c,L:47,S:this,A:["assertion['@type'] === 'dxos.halo.credentials.AdmittedFeed'",""]}),invariant$1(r.spaceKey.equals(this._spaceKey),void 0,{F:__dxlog_file2$c,L:48,S:this,A:["assertion.spaceKey.equals(this._spaceKey)",""]});const n={key:e.subject.id,credential:e,assertion:r,parent:t};this._feeds.set(e.subject.id,n),await this.onFeedAdmitted.callIfSet(n)}},InvitationStateMachine=class{constructor(){this._invitations=new ComplexMap(PublicKey.hash),this._redeemedInvitationCredentialIds=new ComplexSet(PublicKey.hash),this._cancelledInvitationCredentialIds=new ComplexSet(PublicKey.hash),this.onDelegatedInvitation=new Callback,this.onDelegatedInvitationRemoved=new Callback}get invitations(){return this._invitations}async process(e){if(e.id==null)return;const t=getCredentialAssertion(e);switch(t["@type"]){case"dxos.halo.invitations.CancelDelegatedInvitation":{this._cancelledInvitationCredentialIds.add(t.credentialId);const r=this._invitations.get(t.credentialId);r!=null&&(this._invitations.delete(t.credentialId),await this.onDelegatedInvitationRemoved.callIfSet({credentialId:t.credentialId,invitation:r}));break}case"dxos.halo.invitations.DelegateSpaceInvitation":{if(e.id){const r=t.expiresOn&&t.expiresOn.getTime()<Date.now(),n=this._redeemedInvitationCredentialIds.has(e.id)&&!t.multiUse,o=this._cancelledInvitationCredentialIds.has(e.id);if(r||o||n)return;const s={...t};this._invitations.set(e.id,s),await this.onDelegatedInvitation.callIfSet({credentialId:e.id,invitation:s})}break}case"dxos.halo.credentials.SpaceMember":{if(t.invitationCredentialId!=null){this._redeemedInvitationCredentialIds.add(t.invitationCredentialId);const r=this._invitations.get(t.invitationCredentialId);r!=null&&!r.multiUse&&(this._invitations.delete(t.invitationCredentialId),await this.onDelegatedInvitationRemoved.callIfSet({credentialId:t.invitationCredentialId,invitation:r}))}break}}}},__dxlog_file3$b="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/graph/credential-graph.ts",CredentialGraph=class{constructor(e){this._stateHandler=e,this._vertexIdGenerator=1,this._root={id:-1,parents:[],children:[]},this._sentinel={id:-2,parents:[],children:[]},this._vertexByCredentialId=new ComplexMap(PublicKey.hash),this._subjectToVertex=new ComplexMap(PublicKey.hash),this._subjectToState=new ComplexMap(PublicKey.hash),this.onSubjectStateChanged=new Callback}getSubjectState(e){return this._subjectToState.get(e)}getState(){return this._subjectToState}getLeafIds(){return this._sentinel.parents.map(e=>e.credential.id)}getGlobalStateScope(){return{state:this._subjectToVertex}}addVertex(e,t){const r={id:this._vertexIdGenerator++,credential:e,assertion:t,parents:[],children:[]};this._vertexByCredentialId.set(e.id,r);const n=e.parentCredentialIds??[];if(n.length===0)this._root.children.push(r),r.parents.push(this._root);else for(const o of n){const s=this._vertexByCredentialId.get(o);if(s==null){log.error("credential skipped because of the unknown parent",{credential:e,parentId:o},{F:__dxlog_file3$b,L:72,S:this,C:(a,c)=>a(...c)});continue}s.children.push(r),r.parents.push(s),this._removeSentinelConnection(s)}return r.children.push(this._sentinel),this._sentinel.parents.push(r),this._onVertexInserted(r)}_removeSentinelConnection(e){const t=e.children.indexOf(this._sentinel);if(t>=0){e.children.splice(t,1);const r=this._sentinel.parents.indexOf(e);invariant$1(r>=0,void 0,{F:__dxlog_file3$b,L:90,S:this,A:["vertexInSentinelIdx >= 0",""]}),this._sentinel.parents.splice(r,1)}}async _onVertexInserted(e){const{credential:t,assertion:r}=e;invariant$1(t,void 0,{F:__dxlog_file3$b,L:97,S:this,A:["credential",""]});let n=[];if(this._sentinel.parents.length===1){const o=t.subject.id;if(this._stateHandler.isUpdateAllowed(this.getGlobalStateScope(),t,r)){const s=this._stateHandler.createState(t,e.assertion),a=this._subjectToState.get(o);this._subjectToState.set(o,s),this._subjectToVertex.set(o,e),this._stateHandler.hasStateChanged(s,a)&&n.push(s)}}else n=this._recomputeState();n.length>0&&await this.onSubjectStateChanged.callIfSet(n)}_recomputeState(){const e=new Map,t=[this._createRootPath()];let r=null;for(;r==null;){const n=t.pop();log("visit vertex",{id:n.head.id},{F:__dxlog_file3$b,L:132,S:this,C:(c,l)=>c(...l)}),this._updatePathState(n);const o=this._handleMergePoint(t,e,n);if(o==null){log("waiting for other paths",void 0,{F:__dxlog_file3$b,L:136,S:this,C:(c,l)=>c(...l)});continue}const s=this._mergePaths(o);if(s.type==="replay_required"){this._replayFailedPaths(t,e,s,o);continue}const a=s.path;a.head.children.length===0?r=a:a.head.children.length===1?(a.head=a.head.children[0],t.push(a)):this._forkTraversal(t,a)}return t.length>0&&log.error("traversal finished while there were active paths",{paths:t.map(n=>({path:toChosenPath(n),head:n.head.id}))},{F:__dxlog_file3$b,L:155,S:this,C:(n,o)=>n(...o)}),this._setCurrentState(r)}_replayFailedPaths(e,t,r,n){e.push(...r.replay.map(s=>{const a=s.stateOverrides??new ComplexMap(PublicKey.hash);return r.stateOverrides.forEach((c,l)=>a.set(l,c)),{...r.from,chosenPath:s.chosenPath,stateOverrides:a}})),log("replay paths",()=>({count:e.length,paths:e.map(s=>{var a;return{from:r.from.head.id,path:toChosenPath(s),overrides:(a=s==null?void 0:s.stateOverrides)==null?void 0:a.mapValues(c=>this._stateHandler.toLogString(c.assertion))}})}),{F:__dxlog_file3$b,L:175,S:this,C:(s,a)=>s(...a)});const o=n.filter(s=>!r.replay.includes(s));t.set(n[0].head.id,o)}_handleMergePoint(e,t,r){const n=t.get(r.head.id)??[];return t.set(r.head.id,n),n.push(r),n.length<r.head.parents.length?null:r.head.id===this._sentinel.id&&e.length>0?(log("waiting for all the active paths to converge on the sentinel",void 0,{F:__dxlog_file3$b,L:199,S:this,C:(o,s)=>o(...s)}),null):(t.delete(r.head.id),n)}_updatePathState(e){var o;const t=e.head.credential;if(t==null)return;const r=t.subject.id;e.credentials.add(t.id);let n=this._stateHandler.isUpdateAllowed(e,t,e.head.assertion);if(!n&&((o=e.head.parents[0])==null?void 0:o.id)===this._root.id){const s=this.getGlobalStateScope();n=this._stateHandler.isUpdateAllowed(s,t,e.head.assertion)}n&&(e.forkChangedSubjects.add(r),e.forkIssuers.add(t.issuer),e.state.set(r,e.head),log("path state updated",()=>({subject:r,newState:this._stateHandler.toLogString(e.head.assertion)}),{F:__dxlog_file3$b,L:223,S:this,C:(s,a)=>s(...a)}))}_forkTraversal(e,t){var n;const r=((n=t.chosenPath)==null?void 0:n[t.head.id])??t.head.children;for(const o of r){log("edge traversal",{from:t.head.id,to:o.id},{F:__dxlog_file3$b,L:234,S:this,C:(a,c)=>a(...c)});const s={forkPoint:t,chosenPath:{...t.chosenPath,[t.head.id]:[o]},head:o,credentials:new ComplexSet(PublicKey.hash,t.credentials),state:new ComplexMap(PublicKey.hash,[...t.state.entries()]),forkIssuers:new ComplexSet(PublicKey.hash),forkChangedSubjects:new ComplexSet(PublicKey.hash),stateOverrides:t.stateOverrides};e.push(s)}}_setCurrentState(e){const t=[],r=new ComplexMap(PublicKey.hash),n=new ComplexMap(PublicKey.hash);for(const[o,s]of e.state.entries()){const a=this._stateHandler.createState(s.credential,s.assertion),c=this._subjectToState.get(o);r.set(o,a),n.set(o,s),this._stateHandler.hasStateChanged(a,c)&&t.push(a)}return this._subjectToState=r,this._subjectToVertex=n,t}_leastCommonAncestor(e){const t=e.reduce((o,s)=>{let a=s.forkPoint;for(;a;)o.set(a.head.id,a),a=a.forkPoint;return o},new Map);let r=this._root.id,n=null;for(const[o,s]of t.entries()){const a=s.head.credential;a!=null&&e.every(c=>c.credentials.has(a.id))&&o>r&&(r=o,n=s)}return n??this._createRootPath()}_moveUpToForkPoint(e,t){var n;if(t.chosenPath[e.head.id]==null||t.forkPoint==null||e.head.id===((n=t.forkPoint)==null?void 0:n.head.id))return t;let r=t.forkPoint;for(;r.head.id!==e.head.id;)r.forkIssuers.forEach(o=>t.forkIssuers.add(o)),r.forkChangedSubjects.forEach(o=>t.forkChangedSubjects.add(o)),r=r.forkPoint,t.forkPoint=r;return t}_mergePaths(e){if(invariant$1(e.length>=1,void 0,{F:__dxlog_file3$b,L:324,S:this,A:["convergedPaths.length >= 1",""]}),e.length===1)return{type:"merged",path:e[0]};const t=this._leastCommonAncestor(e);log("merging paths",()=>({forkPointId:t.head.id,pathCount:e.length,forkPoints:e.map(c=>{var l;return(l=c.forkPoint)==null?void 0:l.head.id})}),{F:__dxlog_file3$b,L:329,S:this,C:(c,l)=>c(...l)});const r=e.map(c=>this._moveUpToForkPoint(t,c));invariant$1(t,void 0,{F:__dxlog_file3$b,L:335,S:this,A:["forkPoint",""]});const n={forkPoint:t.forkPoint,chosenPath:{...t.chosenPath,[t.head.id]:[]},stateOverrides:t.stateOverrides,credentials:new ComplexSet(PublicKey.hash,t.credentials),forkIssuers:new ComplexSet(PublicKey.hash,t.forkIssuers),forkChangedSubjects:new ComplexSet(PublicKey.hash,t.forkChangedSubjects),state:t.state.mapValues(c=>c),head:r[0].head},o=new ComplexMap(PublicKey.hash);for(const c of r){log("processing a path",()=>({choices:toChosenPath(c),modified:c.forkChangedSubjects,forkIssuers:c.forkIssuers,state:c.state.mapValues(l=>this._stateHandler.toLogString(l.assertion))}),{F:__dxlog_file3$b,L:348,S:this,C:(l,h)=>l(...h)}),c.forkIssuers.forEach(l=>n.forkIssuers.add(l)),c.credentials.forEach(l=>n.credentials.add(l)),n.chosenPath[t.head.id].push(...c.chosenPath[t.head.id]??[]);for(const l of c.forkChangedSubjects){const h=o.get(l);(h==null||this._shouldOverrideCredential(h,c,l))&&o.set(l,c)}}const s=new Set,a=s.add.bind(s);for(const[c,l]of o.entries()){n.forkChangedSubjects.add(c);const h=l.state.get(c);n.state.set(c,h),log("set subject state",()=>({subject:c,state:this._stateHandler.toLogString(h.assertion)}),{F:__dxlog_file3$b,L:370,S:this,C:(d,f)=>d(...f)});const u=r.filter(d=>d!==l);this._stateHandler.getConflictingPaths(u,h).forEach(a)}return s.size>0?{type:"replay_required",replay:[...s.values()],from:t,stateOverrides:o.mapValues((c,l)=>c.state.get(l))}:{type:"merged",path:n}}_shouldOverrideCredential(e,t,r){const n=t.state.get(r),o=e.state.get(r);if(n.id===o.id)return!1;const s=e.head.id;if(n.id===s||o.id===s)return log("merge point chosen to break the tie",{mergePointId:e.head.id},{F:__dxlog_file3$b,L:408,S:this,C:(h,u)=>h(...u)}),s===n.id;const a=n.credential,c=o.credential;if(e.credentials.has(a.id)!==t.credentials.has(c.id))return log("one of the credentials was overridden in another branch",{current:o.id,candidate:n.id},{F:__dxlog_file3$b,L:415,S:this,C:(h,u)=>h(...u)}),t.credentials.has(c.id);const l=this._stateHandler.tryPickWinningUpdate(e,c,t,a);return l!=null?l===a:t.forkIssuers.size!==e.forkIssuers.size?(log("longer issuers branch used to break the tie",{issuerCount:[e.forkIssuers.size,t.forkIssuers.size]},{F:__dxlog_file3$b,L:432,S:this,C:(h,u)=>h(...u)}),t.forkIssuers.size>e.forkIssuers.size):(log("issuance date used to break the tie",void 0,{F:__dxlog_file3$b,L:437,S:this,C:(h,u)=>h(...u)}),a.issuanceDate.getTime()>c.issuanceDate.getTime())}_createRootPath(){return{head:this._root,chosenPath:{},forkIssuers:new ComplexSet(PublicKey.hash),forkChangedSubjects:new ComplexSet(PublicKey.hash),state:new ComplexMap(PublicKey.hash),credentials:new ComplexSet(PublicKey.hash)}}},toChosenPath=e=>Object.fromEntries(Object.entries(e.chosenPath).map(([t,r])=>[t,r.map(n=>n.id)])),__dxlog_file4$8="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/state-machine/member-state-machine.ts",MemberStateMachine=class{constructor(e){this._spaceKey=e,this._memberProfiles=new ComplexMap(PublicKey.hash),this._hashgraph=new CredentialGraph(this),this.onMemberRoleChanged=this._hashgraph.onSubjectStateChanged}get creator(){return this._ownerKey&&this._hashgraph.getSubjectState(this._ownerKey)}get members(){return this._hashgraph.getState()}get membershipChainHeads(){return this._hashgraph.getLeafIds()}getRole(e){return this._getRole(this._hashgraph.getGlobalStateScope(),e)}async process(e){const t=getCredentialAssertion(e);switch(t["@type"]){case"dxos.halo.credentials.SpaceMember":{invariant$1(t.spaceKey.equals(this._spaceKey),void 0,{F:__dxlog_file4$8,L:66,S:this,A:["assertion.spaceKey.equals(this._spaceKey)",""]}),this._ownerKey==null&&e.issuer===this._spaceKey&&(this._ownerKey=e.subject.id),t.profile!=null&&this._memberProfiles.set(e.subject.id,t.profile),await this._hashgraph.addVertex(e,t);break}case"dxos.halo.credentials.MemberProfile":{const r=this._hashgraph.getSubjectState(e.subject.id);r?r.profile=t.profile:log.warn("Member not found",{id:e.subject.id},{F:__dxlog_file4$8,L:81,S:this,C:(n,o)=>n(...o)}),this._memberProfiles.set(e.subject.id,t.profile);break}default:throw new Error("Invalid assertion type")}}createState(e,t){const r=e.subject.id;return{key:r,role:t.role,credential:e,assertion:t,profile:this._memberProfiles.get(r)}}isUpdateAllowed(e,t,r){if(r.role===SpaceMember.Role.OWNER)return t.issuer.equals(this._spaceKey);const n=t.issuer;if(n.equals(t.subject.id))return!1;if(n.equals(r.spaceKey))return!0;const o=this._getRole(e,n);return o===SpaceMember.Role.ADMIN||o===SpaceMember.Role.OWNER}getConflictingPaths(e,t){if(t.assertion.role!==SpaceMember.Role.REMOVED&&t.assertion.role!==SpaceMember.Role.EDITOR)return[];const r=t.credential.subject.id;return e.filter(n=>n.forkIssuers.has(r))}tryPickWinningUpdate(e,t,r,n){const o=this._getRole(e,t.issuer);return this._getRole(r,n.issuer)===SpaceMember.Role.OWNER!=(o===SpaceMember.Role.OWNER)?(log("owner decision used to break the tie",void 0,{F:__dxlog_file4$8,L:139,S:this,C:(s,a)=>s(...a)}),o===SpaceMember.Role.OWNER?t:n):null}toLogString(e){const t=(e==null?void 0:e.role)??SpaceMember.Role.REMOVED;return Object.entries(SpaceMember.Role).find(([r,n])=>n===t)[0]}hasStateChanged(e,t){return(e==null?void 0:e.role)!==(t==null?void 0:t.role)}_getRole(e,t){var n,o,s;if((n=this._ownerKey)!=null&&n.equals(t))return SpaceMember.Role.OWNER;const r=((s=(o=e.state.get(t))==null?void 0:o.assertion)==null?void 0:s.role)??SpaceMember.Role.REMOVED;if(e.stateOverrides!=null){const a=e.stateOverrides.get(t);if(a!=null)return log("member role overridden in path",()=>{var c,l;return{headId:(c=e.head)==null?void 0:c.id,roleOverride:this.toLogString(a.assertion),realRole:this.toLogString((l=e.state.get(t))==null?void 0:l.assertion)}},{F:__dxlog_file4$8,L:162,S:this,C:(c,l)=>c(...l)}),a.assertion.role}return r}},__dxlog_file5$6="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/state-machine/space-state-machine.ts",SpaceStateMachine=class{constructor(e){this._spaceKey=e,this._members=new MemberStateMachine(this._spaceKey),this._feeds=new FeedStateMachine(this._spaceKey),this._invitations=new InvitationStateMachine,this._credentials=[],this._credentialsById=new ComplexMap(PublicKey.hash),this._processedCredentials=new ComplexSet(PublicKey.hash),this._credentialProcessors=[],this.onCredentialProcessed=new Callback,this.onMemberRoleChanged=this._members.onMemberRoleChanged,this.onFeedAdmitted=this._feeds.onFeedAdmitted,this.onDelegatedInvitation=this._invitations.onDelegatedInvitation,this.onDelegatedInvitationRemoved=this._invitations.onDelegatedInvitationRemoved}get creator(){return this._members.creator}get members(){return this._members.members}get membershipChainHeads(){return this._members.membershipChainHeads}get feeds(){return this._feeds.feeds}get credentials(){return this._credentials.map(e=>e.credential)}get credentialEntries(){return this._credentials}get genesisCredential(){return this._genesisCredential}get invitations(){return this._invitations.invitations}async addCredentialProcessor(e){if(this._credentialProcessors.find(r=>r.processor===e))throw new Error("Credential processor already added.");const t=new CredentialConsumer(e,async()=>{for(const r of this.credentials)await t._process(r);t._isReadyForLiveCredentials=!0},async()=>{this._credentialProcessors=this._credentialProcessors.filter(r=>r!==t)});this._credentialProcessors.push(t),await t.open()}async removeCredentialProcessor(e){var t;await((t=this._credentialProcessors.find(r=>r.processor===e))==null?void 0:t.close())}getCredentialsOfType(e){return this.credentials.filter(t=>getCredentialAssertion(t)["@type"]===e)}async process(e,{sourceFeed:t,skipVerification:r}){if(e.id){if(this._processedCredentials.has(e.id))return!0;this._processedCredentials.add(e.id)}if(!r){const s=await verifyCredential(e);if(s.kind!=="pass")return log.warn(`Invalid credential: ${s.errors.join(", ")}`,void 0,{F:__dxlog_file5$6,L:155,S:this,C:(a,c)=>a(...c)}),!1}const n=getCredentialAssertion(e);switch(n["@type"]){case"dxos.halo.credentials.SpaceGenesis":{if(this._genesisCredential)return log.warn("Space already has a genesis credential.",void 0,{F:__dxlog_file5$6,L:164,S:this,C:(s,a)=>s(...a)}),!1;if(!e.issuer.equals(this._spaceKey))return log.warn("Space genesis credential must be issued by space.",void 0,{F:__dxlog_file5$6,L:168,S:this,C:(s,a)=>s(...a)}),!1;if(!e.subject.id.equals(this._spaceKey))return log.warn("Space genesis credential must be issued to space.",void 0,{F:__dxlog_file5$6,L:172,S:this,C:(s,a)=>s(...a)}),!1;this._genesisCredential=e;break}case"dxos.halo.credentials.SpaceMember":{if(!n.spaceKey.equals(this._spaceKey))break;if(!this._genesisCredential)return log.warn("Space must have a genesis credential before adding members.",void 0,{F:__dxlog_file5$6,L:185,S:this,C:(s,a)=>s(...a)}),!1;if(!this._canInviteNewMembers(e.issuer))return log.warn(`Space member is not authorized to invite new members: ${e.issuer}`,void 0,{F:__dxlog_file5$6,L:189,S:this,C:(s,a)=>s(...a)}),!1;await this._members.process(e),await this._invitations.process(e);break}case"dxos.halo.credentials.MemberProfile":{if(!this._genesisCredential)return log.warn("Space must have a genesis credential before adding members.",void 0,{F:__dxlog_file5$6,L:200,S:this,C:(s,a)=>s(...a)}),!1;await this._members.process(e);break}case"dxos.halo.credentials.AdmittedFeed":{if(!this._genesisCredential)return log.warn("Space must have a genesis credential before admitting feeds.",void 0,{F:__dxlog_file5$6,L:210,S:this,C:(s,a)=>s(...a)}),!1;if(!this._canAdmitFeeds(e.issuer))return log.warn(`Space member is not authorized to admit feeds: ${e.issuer}`,void 0,{F:__dxlog_file5$6,L:214,S:this,C:(s,a)=>s(...a)}),!1;await this._feeds.process(e,t);break}case"dxos.halo.invitations.CancelDelegatedInvitation":case"dxos.halo.invitations.DelegateSpaceInvitation":{if(!this._canInviteNewMembers(e.issuer))return log.warn(`Invalid invitation, space member is not authorized to invite new members: ${e.issuer}`,void 0,{F:__dxlog_file5$6,L:225,S:this,C:(s,a)=>s(...a)}),!1;await this._invitations.process(e);break}}const o={credential:e,sourceFeed:t,revoked:!1};this._credentials.push(o),e.id&&this._credentialsById.set(e.id,o);for(const s of this._credentialProcessors)s._isReadyForLiveCredentials&&await s._process(e);return await this.onCredentialProcessed.callIfSet(e),!0}getMemberRole(e){return this._members.getRole(e)}hasMembershipManagementPermission(e){return this._canInviteNewMembers(e)}_canInviteNewMembers(e){return e.equals(this._spaceKey)||this._members.getRole(e)===SpaceMember.Role.ADMIN||this._members.getRole(e)===SpaceMember.Role.OWNER}_canAdmitFeeds(e){const t=this._members.getRole(e);return t===SpaceMember.Role.EDITOR||t===SpaceMember.Role.ADMIN||t===SpaceMember.Role.OWNER}},CredentialConsumer=class{constructor(e,t,r){this.processor=e,this._onOpen=t,this._onClose=r,this._ctx=new Context,this._isReadyForLiveCredentials=!1}async _process(e){await runInContextAsync(this._ctx,async()=>{await this.processor.processCredential(e)})}async open(){if(this._ctx.disposed)throw new Error("CredentialProcessor is disposed");await this._onOpen()}async close(){await this._ctx.dispose(),await this._onClose()}},__dxlog_file6$6="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/processor/device-state-machine.ts",DeviceStateMachine=class{constructor(e){this._params=e,this.authorizedDeviceKeys=new ComplexMap(PublicKey.hash),this.deviceChainReady=new Trigger}async processCredential(e){var r,n,o,s;log("processing credential...",{identityKey:this._params.identityKey,deviceKey:this._params.deviceKey,credential:e},{F:__dxlog_file6$6,L:35,S:this,C:(a,c)=>a(...c)}),isValidAuthorizedDeviceCredential(e,this._params.identityKey,this._params.deviceKey)&&(this.deviceCredentialChain={credential:e},this.deviceChainReady.wake());const t=getCredentialAssertion(e);switch(t["@type"]){case"dxos.halo.credentials.AuthorizedDevice":{invariant$1(!this.authorizedDeviceKeys.has(t.deviceKey),"Device already added.",{F:__dxlog_file6$6,L:51,S:this,A:["!this.authorizedDeviceKeys.has(assertion.deviceKey)","'Device already added.'"]}),this.authorizedDeviceKeys.set(t.deviceKey,{}),log("added device",{localDeviceKey:this._params.deviceKey,deviceKey:t.deviceKey,size:this.authorizedDeviceKeys.size},{F:__dxlog_file6$6,L:54,S:this,C:(a,c)=>a(...c)}),(n=(r=this._params).onUpdate)==null||n.call(r);break}case"dxos.halo.credentials.DeviceProfile":{invariant$1(this.authorizedDeviceKeys.has(e.subject.id),"Device not found.",{F:__dxlog_file6$6,L:64,S:this,A:["this.authorizedDeviceKeys.has(credential.subject.id)","'Device not found.'"]}),t&&e.subject.id.equals(this._params.deviceKey)&&log.trace("dxos.halo.device",{deviceKey:e.subject.id,profile:t.profile},{F:__dxlog_file6$6,L:67,S:this,C:(a,c)=>a(...c)}),this.authorizedDeviceKeys.set(e.subject.id,t.profile),(s=(o=this._params).onUpdate)==null||s.call(o);break}}}},__dxlog_file7$4="/home/runner/work/dxos/dxos/packages/core/halo/credentials/src/processor/profile-state-machine.ts",ProfileStateMachine=class{constructor(e){this._params=e}async processCredential(e){var r,n;const t=getCredentialAssertion(e);switch(t["@type"]){case"dxos.halo.credentials.IdentityProfile":{if(!e.issuer.equals(this._params.identityKey)||!e.subject.id.equals(this._params.identityKey)){log.warn("Invalid profile credential",{expectedIdentity:this._params.identityKey,credential:e},{F:__dxlog_file7$4,L:34,S:this,C:(o,s)=>o(...s)});return}this.profile=t.profile,log("updated profile",{identityKey:this._params.identityKey,profile:this.profile},{F:__dxlog_file7$4,L:40,S:this,C:(o,s)=>o(...s)}),(n=(r=this._params).onUpdate)==null||n.call(r);break}}}},platform$1={exports:{}};platform$1.exports,function(e,t){(function(){var r={function:!0,object:!0},n=r[typeof window]&&window||this,o=t,s=e&&!e.nodeType&&e,a=o&&s&&typeof commonjsGlobal=="object"&&commonjsGlobal;a&&(a.global===a||a.window===a||a.self===a)&&(n=a);var c=Math.pow(2,53)-1,l=/\bOpera/,h=Object.prototype,u=h.hasOwnProperty,d=h.toString;function f(H){return H=String(H),H.charAt(0).toUpperCase()+H.slice(1)}function _(H,te,J){var le={"10.0":"10","6.4":"10 Technical Preview","6.3":"8.1","6.2":"8","6.1":"Server 2008 R2 / 7","6.0":"Server 2008 / Vista","5.2":"Server 2003 / XP 64-bit","5.1":"XP","5.01":"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return te&&J&&/^Win/i.test(H)&&!/^Windows Phone /i.test(H)&&(le=le[/[\d.]+$/.exec(H)])&&(H="Windows "+le),H=String(H),te&&J&&(H=H.replace(RegExp(te,"i"),J)),H=y(H.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0]),H}function p(H,te){var J=-1,le=H?H.length:0;if(typeof le=="number"&&le>-1&&le<=c)for(;++J<le;)te(H[J],J,H);else w(H,te)}function y(H){return H=U(H),/^(?:webOS|i(?:OS|P))/.test(H)?H:f(H)}function w(H,te){for(var J in H)u.call(H,J)&&te(H[J],J,H)}function E(H){return H==null?f(H):d.call(H).slice(8,-1)}function x(H,te){var J=H!=null?typeof H[te]:"number";return!/^(?:boolean|number|string|undefined)$/.test(J)&&(J=="object"?!!H[te]:!0)}function B(H){return String(H).replace(/([ -])(?!$)/g,"$1?")}function P(H,te){var J=null;return p(H,function(le,z){J=te(J,le,z,H)}),J}function U(H){return String(H).replace(/^ +| +$/g,"")}function F(H){var te=n,J=H&&typeof H=="object"&&E(H)!="String";J&&(te=H,H=null);var le=te.navigator||{},z=le.userAgent||"";H||(H=z);var q=J?!!le.likeChrome:/\bChrome\b/.test(H)&&!/internal|\n/i.test(d.toString()),he="Object",V=J?he:"ScriptBridgingProxyObject",_e=J?he:"Environment",ee=J&&te.java?"JavaPackage":E(te.java),W=J?he:"RuntimeObject",re=/\bJava/.test(ee)&&te.java,ne=re&&E(te.environment)==_e,ge=re?"a":"\u03B1",de=re?"b":"\u03B2",ye=te.document||{},Ce=te.operamini||te.opera,ke=l.test(ke=J&&Ce?Ce["[[Class]]"]:E(Ce))?ke:Ce=null,ae,Q=H,C=[],$=null,j=H==z,O=j&&Ce&&typeof Ce.version=="function"&&Ce.version(),k,ue=We([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"]),pe=st(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),Oe=rt([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),Le=Fe({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}}),Me=ft(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function We(Je){return P(Je,function(g,b){return g||RegExp("\\b"+(b.pattern||B(b))+"\\b","i").exec(H)&&(b.label||b)})}function Fe(Je){return P(Je,function(g,b,T){return g||(b[Oe]||b[/^[a-z]+(?: +[a-z]+\b)*/i.exec(Oe)]||RegExp("\\b"+B(T)+"(?:\\b|\\w*\\d)","i").exec(H))&&T})}function st(Je){return P(Je,function(g,b){return g||RegExp("\\b"+(b.pattern||B(b))+"\\b","i").exec(H)&&(b.label||b)})}function ft(Je){return P(Je,function(g,b){var T=b.pattern||B(b);return!g&&(g=RegExp("\\b"+T+"(?:/[\\d.]+|[ \\w.]*)","i").exec(H))&&(g=_(g,T,b.label||b)),g})}function rt(Je){return P(Je,function(g,b){var T=b.pattern||B(b);return!g&&(g=RegExp("\\b"+T+" *\\d+[.\\w_]*","i").exec(H)||RegExp("\\b"+T+" *\\w+-[\\w]*","i").exec(H)||RegExp("\\b"+T+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(H))&&((g=String(b.label&&!RegExp(T,"i").test(b.label)?b.label:g).split("/"))[1]&&!/[\d.]+/.test(g[0])&&(g[0]+=" "+g[1]),b=b.label||b,g=y(g[0].replace(RegExp(T,"i"),b).replace(RegExp("; *(?:"+b+"[_-])?","i")," ").replace(RegExp("("+b+")[-_.]?(\\w)","i"),"$1 $2"))),g})}function lt(Je){return P(Je,function(g,b){return g||(RegExp(b+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(H)||0)[1]||null})}function At(){return this.description||""}if(ue&&(ue=[ue]),/\bAndroid\b/.test(Me)&&!Oe&&(ae=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(H))&&(Oe=U(ae[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),Le&&!Oe?Oe=rt([Le]):Le&&Oe&&(Oe=Oe.replace(RegExp("^("+B(Le)+")[-_.\\s]","i"),Le+" ").replace(RegExp("^("+B(Le)+")[-_.]?(\\w)","i"),Le+" $2")),(ae=/\bGoogle TV\b/.exec(Oe))&&(Oe=ae[0]),/\bSimulator\b/i.test(H)&&(Oe=(Oe?Oe+" ":"")+"Simulator"),pe=="Opera Mini"&&/\bOPiOS\b/.test(H)&&C.push("running in Turbo/Uncompressed mode"),pe=="IE"&&/\blike iPhone OS\b/.test(H)?(ae=F(H.replace(/like iPhone OS/,"")),Le=ae.manufacturer,Oe=ae.product):/^iP/.test(Oe)?(pe||(pe="Safari"),Me="iOS"+((ae=/ OS ([\d_]+)/i.exec(H))?" "+ae[1].replace(/_/g,"."):"")):pe=="Konqueror"&&/^Linux\b/i.test(Me)?Me="Kubuntu":Le&&Le!="Google"&&(/Chrome/.test(pe)&&!/\bMobile Safari\b/i.test(H)||/\bVita\b/.test(Oe))||/\bAndroid\b/.test(Me)&&/^Chrome/.test(pe)&&/\bVersion\//i.test(H)?(pe="Android Browser",Me=/\bAndroid\b/.test(Me)?Me:"Android"):pe=="Silk"?(/\bMobi/i.test(H)||(Me="Android",C.unshift("desktop mode")),/Accelerated *= *true/i.test(H)&&C.unshift("accelerated")):pe=="UC Browser"&&/\bUCWEB\b/.test(H)?C.push("speed mode"):pe=="PaleMoon"&&(ae=/\bFirefox\/([\d.]+)\b/.exec(H))?C.push("identifying as Firefox "+ae[1]):pe=="Firefox"&&(ae=/\b(Mobile|Tablet|TV)\b/i.exec(H))?(Me||(Me="Firefox OS"),Oe||(Oe=ae[1])):!pe||(ae=!/\bMinefield\b/i.test(H)&&/\b(?:Firefox|Safari)\b/.exec(pe))?(pe&&!Oe&&/[\/,]|^[^(]+?\)/.test(H.slice(H.indexOf(ae+"/")+8))&&(pe=null),(ae=Oe||Le||Me)&&(Oe||Le||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(Me))&&(pe=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(Me)?Me:ae)+" Browser")):pe=="Electron"&&(ae=(/\bChrome\/([\d.]+)\b/.exec(H)||0)[1])&&C.push("Chromium "+ae),O||(O=lt(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",B(pe),"(?:Firefox|Minefield|NetFront)"])),(ae=ue=="iCab"&&parseFloat(O)>3&&"WebKit"||/\bOpera\b/.test(pe)&&(/\bOPR\b/.test(H)?"Blink":"Presto")||/\b(?:Midori|Nook|Safari)\b/i.test(H)&&!/^(?:Trident|EdgeHTML)$/.test(ue)&&"WebKit"||!ue&&/\bMSIE\b/i.test(H)&&(Me=="Mac OS"?"Tasman":"Trident")||ue=="WebKit"&&/\bPlayStation\b(?! Vita\b)/i.test(pe)&&"NetFront")&&(ue=[ae]),pe=="IE"&&(ae=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(H)||0)[1])?(pe+=" Mobile",Me="Windows Phone "+(/\+$/.test(ae)?ae:ae+".x"),C.unshift("desktop mode")):/\bWPDesktop\b/i.test(H)?(pe="IE Mobile",Me="Windows Phone 8.x",C.unshift("desktop mode"),O||(O=(/\brv:([\d.]+)/.exec(H)||0)[1])):pe!="IE"&&ue=="Trident"&&(ae=/\brv:([\d.]+)/.exec(H))&&(pe&&C.push("identifying as "+pe+(O?" "+O:"")),pe="IE",O=ae[1]),j){if(x(te,"global"))if(re&&(ae=re.lang.System,Q=ae.getProperty("os.arch"),Me=Me||ae.getProperty("os.name")+" "+ae.getProperty("os.version")),ne){try{O=te.require("ringo/engine").version.join("."),pe="RingoJS"}catch{(ae=te.system)&&ae.global.system==te.system&&(pe="Narwhal",Me||(Me=ae[0].os||null))}pe||(pe="Rhino")}else typeof te.process=="object"&&!te.process.browser&&(ae=te.process)&&(typeof ae.versions=="object"&&(typeof ae.versions.electron=="string"?(C.push("Node "+ae.versions.node),pe="Electron",O=ae.versions.electron):typeof ae.versions.nw=="string"&&(C.push("Chromium "+O,"Node "+ae.versions.node),pe="NW.js",O=ae.versions.nw)),pe||(pe="Node.js",Q=ae.arch,Me=ae.platform,O=/[\d.]+/.exec(ae.version),O=O?O[0]:null));else E(ae=te.runtime)==V?(pe="Adobe AIR",Me=ae.flash.system.Capabilities.os):E(ae=te.phantom)==W?(pe="PhantomJS",O=(ae=ae.version||null)&&ae.major+"."+ae.minor+"."+ae.patch):typeof ye.documentMode=="number"&&(ae=/\bTrident\/(\d+)/i.exec(H))?(O=[O,ye.documentMode],(ae=+ae[1]+4)!=O[1]&&(C.push("IE "+O[1]+" mode"),ue&&(ue[1]=""),O[1]=ae),O=pe=="IE"?String(O[1].toFixed(1)):O[0]):typeof ye.documentMode=="number"&&/^(?:Chrome|Firefox)\b/.test(pe)&&(C.push("masking as "+pe+" "+O),pe="IE",O="11.0",ue=["Trident"],Me="Windows");Me=Me&&y(Me)}if(O&&(ae=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(O)||/(?:alpha|beta)(?: ?\d)?/i.exec(H+";"+(j&&le.appMinorVersion))||/\bMinefield\b/i.test(H)&&"a")&&($=/b/i.test(ae)?"beta":"alpha",O=O.replace(RegExp(ae+"\\+?$"),"")+($=="beta"?de:ge)+(/\d+\+?/.exec(ae)||"")),pe=="Fennec"||pe=="Firefox"&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(Me))pe="Firefox Mobile";else if(pe=="Maxthon"&&O)O=O.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(Oe))Oe=="Xbox 360"&&(Me=null),Oe=="Xbox 360"&&/\bIEMobile\b/.test(H)&&C.unshift("mobile mode");else if((/^(?:Chrome|IE|Opera)$/.test(pe)||pe&&!Oe&&!/Browser|Mobi/.test(pe))&&(Me=="Windows CE"||/Mobi/i.test(H)))pe+=" Mobile";else if(pe=="IE"&&j)try{te.external===null&&C.unshift("platform preview")}catch{C.unshift("embedded")}else(/\bBlackBerry\b/.test(Oe)||/\bBB10\b/.test(H))&&(ae=(RegExp(Oe.replace(/ +/g," *")+"/([.\\d]+)","i").exec(H)||0)[1]||O)?(ae=[ae,/BB10/.test(H)],Me=(ae[1]?(Oe=null,Le="BlackBerry"):"Device Software")+" "+ae[0],O=null):this!=w&&Oe!="Wii"&&(j&&Ce||/Opera/.test(pe)&&/\b(?:MSIE|Firefox)\b/i.test(H)||pe=="Firefox"&&/\bOS X (?:\d+\.){2,}/.test(Me)||pe=="IE"&&(Me&&!/^Win/.test(Me)&&O>5.5||/\bWindows XP\b/.test(Me)&&O>8||O==8&&!/\bTrident\b/.test(H)))&&!l.test(ae=F.call(w,H.replace(l,"")+";"))&&ae.name&&(ae="ing as "+ae.name+((ae=ae.version)?" "+ae:""),l.test(pe)?(/\bIE\b/.test(ae)&&Me=="Mac OS"&&(Me=null),ae="identify"+ae):(ae="mask"+ae,ke?pe=y(ke.replace(/([a-z])([A-Z])/g,"$1 $2")):pe="Opera",/\bIE\b/.test(ae)&&(Me=null),j||(O=null)),ue=["Presto"],C.push(ae));(ae=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(H)||0)[1])&&(ae=[parseFloat(ae.replace(/\.(\d)$/,".0$1")),ae],pe=="Safari"&&ae[1].slice(-1)=="+"?(pe="WebKit Nightly",$="alpha",O=ae[1].slice(0,-1)):(O==ae[1]||O==(ae[2]=(/\bSafari\/([\d.]+\+?)/i.exec(H)||0)[1]))&&(O=null),ae[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(H)||0)[1],ae[0]==537.36&&ae[2]==537.36&&parseFloat(ae[1])>=28&&ue=="WebKit"&&(ue=["Blink"]),!j||!q&&!ae[1]?(ue&&(ue[1]="like Safari"),ae=(ae=ae[0],ae<400?1:ae<500?2:ae<526?3:ae<533?4:ae<534?"4+":ae<535?5:ae<537?6:ae<538?7:ae<601?8:ae<602?9:ae<604?10:ae<606?11:ae<608?12:"12")):(ue&&(ue[1]="like Chrome"),ae=ae[1]||(ae=ae[0],ae<530?1:ae<532?2:ae<532.05?3:ae<533?4:ae<534.03?5:ae<534.07?6:ae<534.1?7:ae<534.13?8:ae<534.16?9:ae<534.24?10:ae<534.3?11:ae<535.01?12:ae<535.02?"13+":ae<535.07?15:ae<535.11?16:ae<535.19?17:ae<536.05?18:ae<536.1?19:ae<537.01?20:ae<537.11?"21+":ae<537.13?23:ae<537.18?24:ae<537.24?25:ae<537.36?26:ue!="Blink"?"27":"28")),ue&&(ue[1]+=" "+(ae+=typeof ae=="number"?".x":/[.+]/.test(ae)?"":"+")),pe=="Safari"&&(!O||parseInt(O)>45)?O=ae:pe=="Chrome"&&/\bHeadlessChrome/i.test(H)&&C.unshift("headless")),pe=="Opera"&&(ae=/\bzbov|zvav$/.exec(Me))?(pe+=" ",C.unshift("desktop mode"),ae=="zvav"?(pe+="Mini",O=null):pe+="Mobile",Me=Me.replace(RegExp(" *"+ae+"$"),"")):pe=="Safari"&&/\bChrome\b/.exec(ue&&ue[1])?(C.unshift("desktop mode"),pe="Chrome Mobile",O=null,/\bOS X\b/.test(Me)?(Le="Apple",Me="iOS 4.3+"):Me=null):/\bSRWare Iron\b/.test(pe)&&!O&&(O=lt("Chrome")),O&&O.indexOf(ae=/[\d.]+$/.exec(Me))==0&&H.indexOf("/"+ae+"-")>-1&&(Me=U(Me.replace(ae,""))),Me&&Me.indexOf(pe)!=-1&&!RegExp(pe+" OS").test(Me)&&(Me=Me.replace(RegExp(" *"+B(pe)+" *"),"")),ue&&!/\b(?:Avant|Nook)\b/.test(pe)&&(/Browser|Lunascape|Maxthon/.test(pe)||pe!="Safari"&&/^iOS/.test(Me)&&/\bSafari\b/.test(ue[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(pe)&&ue[1])&&(ae=ue[ue.length-1])&&C.push(ae),C.length&&(C=["("+C.join("; ")+")"]),Le&&Oe&&Oe.indexOf(Le)<0&&C.push("on "+Le),Oe&&C.push((/^on /.test(C[C.length-1])?"":"on ")+Oe),Me&&(ae=/ ([\d.+]+)$/.exec(Me),k=ae&&Me.charAt(Me.length-ae[0].length-1)=="/",Me={architecture:32,family:ae&&!k?Me.replace(ae[0],""):Me,version:ae?ae[1]:null,toString:function(){var Je=this.version;return this.family+(Je&&!k?" "+Je:"")+(this.architecture==64?" 64-bit":"")}}),(ae=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(Q))&&!/\bi686\b/i.test(Q)?(Me&&(Me.architecture=64,Me.family=Me.family.replace(RegExp(" *"+ae),"")),pe&&(/\bWOW64\b/i.test(H)||j&&/\w(?:86|32)$/.test(le.cpuClass||le.platform)&&!/\bWin64; x64\b/i.test(H))&&C.unshift("32-bit")):Me&&/^OS X/.test(Me.family)&&pe=="Chrome"&&parseFloat(O)>=39&&(Me.architecture=64),H||(H=null);var qe={};return qe.description=H,qe.layout=ue&&ue[0],qe.manufacturer=Le,qe.name=pe,qe.prerelease=$,qe.product=Oe,qe.ua=H,qe.version=pe&&O,qe.os=Me||{architecture:null,family:null,version:null,toString:function(){return"null"}},qe.parse=F,qe.toString=At,qe.version&&C.unshift(O),qe.name&&C.unshift(pe),Me&&pe&&!(Me==String(Me).split(" ")[0]&&(Me==pe.split(" ")[0]||Oe))&&C.push(Oe?"("+Me+")":"on "+Me),C.length&&(qe.description=C.join(" ")),qe}var G=F();o&&s?w(G,function(H,te){o[te]=H}):n.platform=G}).call(commonjsGlobal)}(platform$1,platform$1.exports);var platformExports=platform$1.exports;const platform=getDefaultExportFromCjs(platformExports);var __dxlog_file$j="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-gossip/src/gossip-extension.ts",GossipExtension=class{constructor(e={}){this._callbacks=e,this._opened=new Trigger,this._closed=!1}async onOpen(e){log("onOpen",{localPeerId:e.localPeerId,remotePeerId:e.remotePeerId},{F:__dxlog_file$j,L:37,S:this,C:(t,r)=>t(...r)}),this._rpc=createProtoRpcPeer({requested:{GossipService:schema.getService("dxos.mesh.teleport.gossip.GossipService")},exposed:{GossipService:schema.getService("dxos.mesh.teleport.gossip.GossipService")},handlers:{GossipService:{announce:async t=>{var r,n;log("received announce",{localPeerId:e.localPeerId,remotePeerId:e.remotePeerId,message:t},{F:__dxlog_file$j,L:49,S:this,C:(o,s)=>o(...s)}),await((n=(r=this._callbacks).onAnnounce)==null?void 0:n.call(r,t))}}},port:await e.createPort("rpc",{contentType:'application/x-protobuf; messageType="dxos.rpc.Message"'})}),await this._rpc.open(),this._opened.wake()}async onClose(e){var t,r,n;log("close",{err:e},{F:__dxlog_file$j,L:61,S:this,C:(o,s)=>o(...s)}),await((t=this._rpc)==null?void 0:t.close()),await((n=(r=this._callbacks).onClose)==null?void 0:n.call(r,e)),this._closed=!0}async onAbort(e){var t,r,n;log("abort",{err:e},{F:__dxlog_file$j,L:68,S:this,C:(o,s)=>o(...s)});try{await((t=this._rpc)==null?void 0:t.abort())}catch(o){log.catch(o,void 0,{F:__dxlog_file$j,L:72,S:this,C:(s,a)=>s(...a)})}finally{await((n=(r=this._callbacks).onClose)==null?void 0:n.call(r,e))}this._closed=!0}async sendAnnounce(e){this._closed||(await this._opened.wait(),invariant$1(this._rpc,"RPC not initialized",{F:__dxlog_file$j,L:84,S:this,A:["this._rpc","'RPC not initialized'"]}),await this._rpc.rpc.GossipService.announce(e))}},__dxlog_file2$b="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-gossip/src/gossip.ts",RECEIVED_MESSAGES_GC_INTERVAL$1=12e4,MAX_CTX_TASKS=50,Gossip=class{constructor(e){this._params=e,this._ctx=new Context({onError:t=>{log.catch(t,void 0,{F:__dxlog_file2$b,L:32,S:this,C:(r,n)=>r(...n)})}}),this._listeners=new Map,this._receivedMessages=new ComplexSet(PublicKey.hash),this._toClear=new ComplexSet(PublicKey.hash),this._connections=new ComplexMap(PublicKey.hash),this.connectionClosed=new Event$1}get localPeerId(){return this._params.localPeerId}async open(){scheduleTaskInterval(this._ctx,async()=>{this._performGc()},RECEIVED_MESSAGES_GC_INTERVAL$1)}async close(){await this._ctx.dispose()}getConnections(){return Array.from(this._connections.keys())}createExtension({remotePeerId:e}){const t=new GossipExtension({onAnnounce:async r=>{if(!this._receivedMessages.has(r.messageId)){if(this._receivedMessages.add(r.messageId),this._callListeners(r),this._ctx.disposeCallbacksLength>MAX_CTX_TASKS){log(`skipping propagating gossip message due to exessive tasks (${MAX_CTX_TASKS})`,void 0,{F:__dxlog_file2$b,L:84,S:this,C:(n,o)=>n(...o)});return}scheduleTask(this._ctx,async()=>{await this._propagateAnnounce(r)})}},onClose:async r=>{r&&log.catch(r,void 0,{F:__dxlog_file2$b,L:93,S:this,C:(n,o)=>n(...o)}),this._connections.has(e)&&this._connections.delete(e),this.connectionClosed.emit(e)}});return this._connections.set(e,t),t}postMessage(e,t){for(const r of this._connections.values())this._sendAnnounceWithTimeoutTracking(r,{peerId:this._params.localPeerId,messageId:PublicKey.random(),channelId:e,timestamp:new Date,payload:t}).catch(async n=>{n instanceof RpcClosedError?log("sendAnnounce failed because of RpcClosedError",{err:n},{F:__dxlog_file2$b,L:116,S:this,C:(o,s)=>o(...s)}):n instanceof TimeoutError$1||n.constructor.name==="TimeoutError"||n.message.startsWith("Timeout")?log("sendAnnounce failed because of TimeoutError",{err:n},{F:__dxlog_file2$b,L:122,S:this,C:(o,s)=>o(...s)}):log.catch(n,void 0,{F:__dxlog_file2$b,L:124,S:this,C:(o,s)=>o(...s)})})}listen(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),{unsubscribe:()=>{this._listeners.get(e).delete(t)}}}_callListeners(e){this._listeners.has(e.channelId)&&this._listeners.get(e.channelId).forEach(t=>{t(e)})}_propagateAnnounce(e){return Promise.all([...this._connections.entries()].map(async([t,r])=>{if(!(this._params.localPeerId.equals(e.peerId)||t.equals(e.peerId)))return this._sendAnnounceWithTimeoutTracking(r,e).catch(n=>log(n,void 0,{F:__dxlog_file2$b,L:157,S:this,C:(o,s)=>o(...s)}))}))}_performGc(){const e=performance.now();for(const r of this._toClear.keys())this._receivedMessages.delete(r);this._toClear.clear();for(const r of this._receivedMessages.keys())this._toClear.add(r);const t=performance.now()-e;t>100&&log.warn("GC took too long",{elapsed:t},{F:__dxlog_file2$b,L:175,S:this,C:(r,n)=>r(...n)})}_sendAnnounceWithTimeoutTracking(e,t){return e.sendAnnounce(t).catch(r=>{})}},__dxlog_file3$a="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-gossip/src/presence.ts",PRESENCE_CHANNEL_ID="dxos.mesh.presence.Presence",Presence=class{constructor(e){this._params=e,this.updated=new Event$1,this.newPeer=new Event$1,this._ctx=new Context({onError:t=>{log.catch(t,void 0,{F:__dxlog_file3$a,L:49,S:this,C:(r,n)=>r(...n)})}}),this._peerStates=new ComplexMap(PublicKey.hash),this._peersByIdentityKey=new ComplexMap(PublicKey.hash),this._isOnline=t=>t.timestamp.getTime()>Date.now()-this._params.offlineTimeout,invariant$1(this._params.announceInterval<this._params.offlineTimeout,"Announce interval should be less than offline timeout.",{F:__dxlog_file3$a,L:59,S:this,A:["this._params.announceInterval < this._params.offlineTimeout","'Announce interval should be less than offline timeout.'"]}),this._params.gossip.listen(PRESENCE_CHANNEL_ID,t=>{this._receiveAnnounces(t)}),scheduleTaskInterval(this._ctx,async()=>{const t={"@type":"dxos.mesh.presence.PeerState",identityKey:this._params.identityKey,connections:this._params.gossip.getConnections()};await this._params.gossip.postMessage(PRESENCE_CHANNEL_ID,t)},e.announceInterval),scheduleTaskInterval(this._ctx,async()=>{this.updated.emit()},e.offlineTimeout),this._params.gossip.connectionClosed.on(t=>{const r=this._peerStates.get(t);r!=null&&(this._peerStates.delete(t),this._removePeerFromIdentityKeyIndex(r),this.updated.emit())})}getPeers(){return Array.from(this._peerStates.values()).map(e=>e.payload)}getPeersByIdentityKey(e){return(this._peersByIdentityKey.get(e)??[]).filter(this._isOnline).map(t=>t.payload)}getPeersOnline(){return Array.from(this._peerStates.values()).filter(this._isOnline).map(e=>e.payload)}getLocalState(){return{identityKey:this._params.identityKey,connections:this._params.gossip.getConnections(),peerId:this._params.gossip.localPeerId}}async destroy(){await this._ctx.dispose()}_receiveAnnounces(e){invariant$1(e.channelId===PRESENCE_CHANNEL_ID,`Invalid channel ID: ${e.channelId}`,{F:__dxlog_file3$a,L:133,S:this,A:["message.channelId === PRESENCE_CHANNEL_ID","`Invalid channel ID: ${message.channelId}`"]});const t=this._peerStates.get(e.peerId);(!t||t.timestamp.getTime()<e.timestamp.getTime())&&(e.payload.peerId=e.peerId,this._peerStates.set(e.peerId,e),this._updatePeerInIdentityKeyIndex(e),this.updated.emit())}_removePeerFromIdentityKeyIndex(e){const t=this._peersByIdentityKey.get(e.payload.identityKey)??[],r=t.findIndex(n=>{var o;return(o=n.peerId)==null?void 0:o.equals(e.peerId)});r>=0&&t.splice(r,1)}_updatePeerInIdentityKeyIndex(e){const t=e.payload.identityKey,r=this._peersByIdentityKey.get(t)??[],n=r.findIndex(o=>{var s;return o.peerId&&((s=e.peerId)==null?void 0:s.equals(o.peerId))});if(n>=0){const o=r.splice(n,1,e)[0];this._isOnline(o)||this.newPeer.emit(e.payload)}else this._peersByIdentityKey.set(t,r),r.push(e),this.newPeer.emit(e.payload)}},SignalState;(function(e){e[e.CONNECTING=0]="CONNECTING",e[e.RECONNECTING=1]="RECONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.DISCONNECTED=3]="DISCONNECTED",e[e.ERROR=4]="ERROR",e[e.CLOSED=5]="CLOSED"})(SignalState||(SignalState={}));var ws=null;typeof WebSocket<"u"?ws=WebSocket:typeof MozWebSocket<"u"?ws=MozWebSocket:typeof global<"u"?ws=global.WebSocket||global.MozWebSocket:typeof window<"u"?ws=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(ws=self.WebSocket||self.MozWebSocket);const WebSocket3=ws;var MESSAGE_TIMEOUT=1e4,__dxlog_file$i="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/messenger.ts",ReliablePayload=schema.getCodecForType("dxos.mesh.messaging.ReliablePayload"),Acknowledgement=schema.getCodecForType("dxos.mesh.messaging.Acknowledgement"),RECEIVED_MESSAGES_GC_INTERVAL=12e4,Messenger=class{constructor({signalManager:e,retryDelay:t=300}){this._listeners=new ComplexMap(({peerId:r,payloadType:n})=>r.toHex()+n),this._defaultListeners=new ComplexMap(PublicKey.hash),this._onAckCallbacks=new ComplexMap(PublicKey.hash),this._receivedMessages=new ComplexSet(PublicKey.hash),this._toClear=new ComplexSet(PublicKey.hash),this._closed=!0,this._signalManager=e,this._retryDelay=t,this.open()}open(){if(!this._closed)return;const e=PublicKey.random().toHex();log.trace("dxos.mesh.messenger.open",trace$1.begin({id:e}),{F:__dxlog_file$i,L:69,S:this,C:(t,r)=>t(...r)}),this._ctx=new Context({onError:t=>log.catch(t,void 0,{F:__dxlog_file$i,L:71,S:this,C:(r,n)=>r(...n)})}),this._ctx.onDispose(this._signalManager.onMessage.on(async t=>{log("received message",{from:t.author},{F:__dxlog_file$i,L:75,S:this,C:(r,n)=>r(...n)}),await this._handleMessage(t)})),scheduleTaskInterval(this._ctx,async()=>{this._performGc()},RECEIVED_MESSAGES_GC_INTERVAL),this._closed=!1,log.trace("dxos.mesh.messenger.open",trace$1.end({id:e}),{F:__dxlog_file$i,L:90,S:this,C:(t,r)=>t(...r)})}async close(){this._closed||(this._closed=!0,await this._ctx.dispose())}async sendMessage({author:e,recipient:t,payload:r}){invariant$1(!this._closed,"Closed",{F:__dxlog_file$i,L:102,S:this,A:["!this._closed","'Closed'"]});const n=this._ctx.derive(),o={messageId:PublicKey.random(),payload:r};invariant$1(!this._onAckCallbacks.has(o.messageId),void 0,{F:__dxlog_file$i,L:109,S:this,A:["!this._onAckCallbacks.has(reliablePayload.messageId!)",""]}),log("send message",{messageId:o.messageId,author:e,recipient:t},{F:__dxlog_file$i,L:110,S:this,C:(l,h)=>l(...h)});let s,a;const c=new Promise((l,h)=>{s=l,a=h});return scheduleExponentialBackoffTaskInterval(n,async()=>{log("retrying message",{messageId:o.messageId},{F:__dxlog_file$i,L:124,S:this,C:(l,h)=>l(...h)}),await this._encodeAndSend({author:e,recipient:t,reliablePayload:o}).catch(l=>log("failed to send message",{err:l},{F:__dxlog_file$i,L:126,S:this,C:(h,u)=>h(...u)}))},this._retryDelay),scheduleTask(n,()=>{log("message not delivered",{messageId:o.messageId},{F:__dxlog_file$i,L:135,S:this,C:(l,h)=>l(...h)}),this._onAckCallbacks.delete(o.messageId),a(new TimeoutError$1("signaling message not delivered",new TimeoutError$2(MESSAGE_TIMEOUT,"Message not delivered"))),n.dispose()},MESSAGE_TIMEOUT),this._onAckCallbacks.set(o.messageId,()=>{s(),this._onAckCallbacks.delete(o.messageId),n.dispose()}),await this._encodeAndSend({author:e,recipient:t,reliablePayload:o}),c}async listen({peerId:e,payloadType:t,onMessage:r}){invariant$1(!this._closed,"Closed",{F:__dxlog_file$i,L:171,S:this,A:["!this._closed","'Closed'"]}),await this._signalManager.subscribeMessages(e);let n;return t?(n=this._listeners.get({peerId:e,payloadType:t}),n||(n=new Set,this._listeners.set({peerId:e,payloadType:t},n))):(n=this._defaultListeners.get(e),n||(n=new Set,this._defaultListeners.set(e,n))),n.add(r),{unsubscribe:async()=>{n.delete(r)}}}async _encodeAndSend({author:e,recipient:t,reliablePayload:r}){await this._signalManager.sendMessage({author:e,recipient:t,payload:{type_url:"dxos.mesh.messaging.ReliablePayload",value:ReliablePayload.encode(r,{preserveAny:!0})}})}async _handleMessage(e){switch(e.payload.type_url){case"dxos.mesh.messaging.ReliablePayload":{await this._handleReliablePayload(e);break}case"dxos.mesh.messaging.Acknowledgement":{await this._handleAcknowledgement({payload:e.payload});break}}}async _handleReliablePayload({author:e,recipient:t,payload:r}){invariant$1(r.type_url==="dxos.mesh.messaging.ReliablePayload",void 0,{F:__dxlog_file$i,L:232,S:this,A:["payload.type_url === 'dxos.mesh.messaging.ReliablePayload'",""]});const n=ReliablePayload.decode(r.value,{preserveAny:!0});log("handling message",{messageId:n.messageId},{F:__dxlog_file$i,L:235,S:this,C:(o,s)=>o(...s)}),await this._sendAcknowledgement({author:e,recipient:t,messageId:n.messageId}),!this._receivedMessages.has(n.messageId)&&(this._receivedMessages.add(n.messageId),await this._callListeners({author:e,recipient:t,payload:n.payload}))}async _handleAcknowledgement({payload:e}){var t;invariant$1(e.type_url==="dxos.mesh.messaging.Acknowledgement",void 0,{F:__dxlog_file$i,L:258,S:this,A:["payload.type_url === 'dxos.mesh.messaging.Acknowledgement'",""]}),(t=this._onAckCallbacks.get(Acknowledgement.decode(e.value).messageId))==null||t()}async _sendAcknowledgement({author:e,recipient:t,messageId:r}){log("sending ACK",{messageId:r,from:t,to:e},{F:__dxlog_file$i,L:271,S:this,C:(n,o)=>n(...o)}),await this._signalManager.sendMessage({author:t,recipient:e,payload:{type_url:"dxos.mesh.messaging.Acknowledgement",value:Acknowledgement.encode({messageId:r})}})}async _callListeners(e){{const t=this._defaultListeners.get(e.recipient);if(t)for(const r of t)await r(e)}{const t=this._listeners.get({peerId:e.recipient,payloadType:e.payload.type_url});if(t)for(const r of t)await r(e)}}_performGc(){const e=performance.now();for(const r of this._toClear.keys())this._receivedMessages.delete(r);this._toClear.clear();for(const r of this._receivedMessages.keys())this._toClear.add(r);const t=performance.now()-e;t>100&&log.warn("GC took too long",{elapsed:t},{F:__dxlog_file$i,L:319,S:this,C:(r,n)=>r(...n)})}},__dxlog_file2$a="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/signal-client/signal-rpc-client.ts",SIGNAL_KEEPALIVE_INTERVAL=1e4,SignalRPCClient=class{constructor({url:e,callbacks:t={}}){this._connectTrigger=new Trigger,this._closed=!1,this._closeComplete=new Trigger;const r=PublicKey.random().toHex();log.trace("dxos.mesh.signal-rpc-client.constructor",trace$1.begin({id:r}),{F:__dxlog_file2$a,L:55,S:this,C:(n,o)=>n(...o)}),this._url=e,this._callbacks=t,this._socket=new WebSocket3(this._url),this._rpc=createProtoRpcPeer({requested:{Signal:schema.getService("dxos.mesh.signal.Signal")},noHandshake:!0,port:{send:n=>{if(!this._closed)try{this._socket.send(n)}catch(o){log.warn("send error",o,{F:__dxlog_file2$a,L:74,S:this,C:(s,a)=>s(...a)})}},subscribe:n=>{this._socket.onmessage=async o=>{typeof Blob<"u"&&o.data instanceof Blob?n(export_Buffer.from(await o.data.arrayBuffer())):n(o.data)}}},encodingOptions:{preserveAny:!0}}),this._socket.onopen=async()=>{var n,o,s,a;try{await this._rpc.open(),log(`RPC open ${this._url}`,void 0,{F:__dxlog_file2$a,L:95,S:this,C:(c,l)=>c(...l)}),(o=(n=this._callbacks).onConnected)==null||o.call(n),this._connectTrigger.wake(),this._keepaliveCtx=new Context,scheduleTaskInterval(this._keepaliveCtx,async()=>{var c;(c=this._socket)==null||c.send("__ping__")},SIGNAL_KEEPALIVE_INTERVAL)}catch(c){(a=(s=this._callbacks).onError)==null||a.call(s,c)}},this._socket.onclose=async()=>{var n,o;log(`Disconnected ${this._url}`,void 0,{F:__dxlog_file2$a,L:116,S:this,C:(s,a)=>s(...a)}),(o=(n=this._callbacks).onDisconnected)==null||o.call(n),this._closeComplete.wake(),await this.close()},this._socket.onerror=async n=>{var o,s,a;if(!this._closed){(s=(o=this._callbacks).onError)==null||s.call(o,n.error??new Error(n.message)),this._connectTrigger.reset();try{await((a=this._rpc)==null?void 0:a.close())}catch(c){log.catch(c,void 0,{F:__dxlog_file2$a,L:134,S:this,C:(l,h)=>l(...h)})}this._closed=!0,log.warn(n.message??"Socket error",{url:this._url},{F:__dxlog_file2$a,L:138,S:this,C:(c,l)=>c(...l)})}},log.trace("dxos.mesh.signal-rpc-client.constructor",trace$1.end({id:r}),{F:__dxlog_file2$a,L:141,S:this,C:(n,o)=>n(...o)})}async close(){var e,t,r,n;await((e=this._keepaliveCtx)==null?void 0:e.dispose()),this._closed=!0;try{await((t=this._rpc)==null?void 0:t.close()),(((r=this._socket)==null?void 0:r.readyState)===WebSocket3.OPEN||((n=this._socket)==null?void 0:n.readyState)===WebSocket3.CONNECTING)&&this._socket.close(),await this._closeComplete.wait({timeout:1e3})}catch(o){log.warn("close error",o,{F:__dxlog_file2$a,L:156,S:this,C:(s,a)=>s(...a)})}}async join({topic:e,peerId:t}){var n,o,s,a;log("join",{topic:e,peerId:t,metadata:(o=(n=this._callbacks)==null?void 0:n.getMetadata)==null?void 0:o.call(n)},{F:__dxlog_file2$a,L:161,S:this,C:(c,l)=>c(...l)}),await this._connectTrigger.wait(),invariant$1(!this._closed,"SignalRPCClient is closed",{F:__dxlog_file2$a,L:163,S:this,A:["!this._closed","'SignalRPCClient is closed'"]}),invariant$1(this._rpc,"Rpc is not initialized",{F:__dxlog_file2$a,L:164,S:this,A:["this._rpc","'Rpc is not initialized'"]});const r=this._rpc.rpc.Signal.join({swarm:e.asUint8Array(),peer:t.asUint8Array(),metadata:(a=(s=this._callbacks)==null?void 0:s.getMetadata)==null?void 0:a.call(s)});return await r.waitUntilReady(),r}async receiveMessages(e){log("receiveMessages",{peerId:e},{F:__dxlog_file2$a,L:175,S:this,C:(r,n)=>r(...n)}),invariant$1(!this._closed,"SignalRPCClient is closed",{F:__dxlog_file2$a,L:176,S:this,A:["!this._closed","'SignalRPCClient is closed'"]}),await this._connectTrigger.wait(),invariant$1(this._rpc,"Rpc is not initialized",{F:__dxlog_file2$a,L:178,S:this,A:["this._rpc","'Rpc is not initialized'"]});const t=this._rpc.rpc.Signal.receiveMessages({peer:e.asUint8Array()});return await t.waitUntilReady(),t}async sendMessage({author:e,recipient:t,payload:r}){var n,o,s,a;log("sendMessage",{author:e,recipient:t,payload:r,metadata:(o=(n=this._callbacks)==null?void 0:n.getMetadata)==null?void 0:o.call(n)},{F:__dxlog_file2$a,L:187,S:this,C:(c,l)=>c(...l)}),invariant$1(!this._closed,"SignalRPCClient is closed",{F:__dxlog_file2$a,L:188,S:this,A:["!this._closed","'SignalRPCClient is closed'"]}),await this._connectTrigger.wait(),invariant$1(this._rpc,"Rpc is not initialized",{F:__dxlog_file2$a,L:190,S:this,A:["this._rpc","'Rpc is not initialized'"]}),await this._rpc.rpc.Signal.sendMessage({author:e.asUint8Array(),recipient:t.asUint8Array(),payload:r,metadata:(a=(s=this._callbacks)==null?void 0:s.getMetadata)==null?void 0:a.call(s)})}},__dxlog_file3$9="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/signal-client/signal-client.ts",DEFAULT_RECONNECT_TIMEOUT=100,MAX_RECONNECT_TIMEOUT=5e3,ERROR_RECONCILE_DELAY=1e3,RECONCILE_INTERVAL=5e3,SignalClient=class{constructor(e,t,r,n){if(this._host=e,this._onMessage=t,this._onSwarmEvent=r,this._getMetadata=n,this._state=SignalState.CLOSED,this._reconnectAfter=DEFAULT_RECONNECT_TIMEOUT,this._connectionStarted=new Date,this._lastStateChange=new Date,this._clientReady=new Trigger,this.statusChanged=new Event$1,this.commandTrace=new Event$1,this._swarmStreams=new ComplexMap(({topic:o,peerId:s})=>o.toHex()+s.toHex()),this._joinedTopics=new ComplexSet(({topic:o,peerId:s})=>o.toHex()+s.toHex()),this._messageStreams=new ComplexMap(o=>o.toHex()),this._subscribedMessages=new ComplexSet(({peerId:o})=>o.toHex()),this._reconciled=new Event$1,this._instanceId=PublicKey.random().toHex(),this._performance={sentMessages:0,receivedMessages:0,reconnectCounter:0,joinCounter:0,leaveCounter:0},!this._host.startsWith("wss://")&&!this._host.startsWith("ws://"))throw new Error(`Signal server requires a websocket URL. Provided: ${this._host}`)}async open(){log.trace("dxos.mesh.signal-client.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file3$9,L:128,S:this,C:(e,t)=>e(...t)}),![SignalState.CONNECTED,SignalState.CONNECTING].includes(this._state)&&(this._ctx=new Context({onError:e=>{var t;this._state===SignalState.CLOSED||(t=this._ctx)!=null&&t.disposed||(this._state===SignalState.CONNECTED&&log.warn("SignalClient error:",e,{F:__dxlog_file3$9,L:140,S:this,C:(r,n)=>r(...n)}),this._scheduleReconcileAfterError())}}),this._reconcileTask=new DeferredTask(this._ctx,async()=>{await this._reconcileSwarmSubscriptions(),await this._reconcileMessageSubscriptions(),this._reconciled.emit()}),scheduleTaskInterval(this._ctx,async()=>{this._state===SignalState.CONNECTED&&this._reconcileTask.schedule()},RECONCILE_INTERVAL),this._reconnectTask=new DeferredTask(this._ctx,async()=>{await this._reconnect()}),this._setState(SignalState.CONNECTING),this._createClient(),log.trace("dxos.mesh.signal-client.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file3$9,L:169,S:this,C:(e,t)=>e(...t)}))}async close(){var e,t;log("closing...",void 0,{F:__dxlog_file3$9,L:173,S:this,C:(r,n)=>r(...n)}),![SignalState.CLOSED].includes(this._state)&&(await((e=this._ctx)==null?void 0:e.dispose()),this._clientReady.reset(),await((t=this._client)==null?void 0:t.close()),this._client=void 0,this._setState(SignalState.CLOSED),log("closed",void 0,{F:__dxlog_file3$9,L:184,S:this,C:(r,n)=>r(...n)}))}getStatus(){var e;return{host:this._host,state:this._state,error:(e=this._lastError)==null?void 0:e.message,reconnectIn:this._reconnectAfter,connectionStarted:this._connectionStarted,lastStateChange:this._lastStateChange}}async join({topic:e,peerId:t}){log("joining",{topic:e,peerId:t},{F:__dxlog_file3$9,L:199,S:this,C:(r,n)=>r(...n)}),this._performance.joinCounter++,this._joinedTopics.add({topic:e,peerId:t}),this._reconcileTask.schedule()}async leave({topic:e,peerId:t}){var r;this._performance.leaveCounter++,log("leaving",{topic:e,peerId:t},{F:__dxlog_file3$9,L:207,S:this,C:(n,o)=>n(...o)}),(r=this._swarmStreams.get({topic:e,peerId:t}))==null||r.close(),this._swarmStreams.delete({topic:e,peerId:t}),this._joinedTopics.delete({topic:e,peerId:t})}async sendMessage(e){this._performance.sentMessages++,await this._clientReady.wait(),invariant$1(this._state===SignalState.CONNECTED,"Not connected to Signal Server",{F:__dxlog_file3$9,L:216,S:this,A:["this._state === SignalState.CONNECTED","'Not connected to Signal Server'"]}),await this._client.sendMessage(e)}async subscribeMessages(e){log("subscribing to messages",{peerId:e},{F:__dxlog_file3$9,L:221,S:this,C:(t,r)=>t(...r)}),this._subscribedMessages.add({peerId:e}),this._reconcileTask.schedule()}async unsubscribeMessages(e){var t;log("unsubscribing from messages",{peerId:e},{F:__dxlog_file3$9,L:227,S:this,C:(r,n)=>r(...n)}),this._subscribedMessages.delete({peerId:e}),(t=this._messageStreams.get(e))==null||t.close(),this._messageStreams.delete(e)}_scheduleReconcileAfterError(){scheduleTask(this._ctx,()=>{this._reconcileTask.schedule()},ERROR_RECONCILE_DELAY)}_setState(e){this._state=e,this._lastStateChange=new Date,log("signal state changed",{status:this.getStatus()},{F:__dxlog_file3$9,L:246,S:this,C:(t,r)=>t(...r)}),this.statusChanged.emit(this.getStatus())}_createClient(){log("creating client",{host:this._host,state:this._state},{F:__dxlog_file3$9,L:251,S:this,C:(e,t)=>e(...t)}),invariant$1(!this._client,"Client already created",{F:__dxlog_file3$9,L:252,S:this,A:["!this._client","'Client already created'"]}),this._connectionStarted=new Date,this._connectionCtx=this._ctx.derive(),this._connectionCtx.onDispose(async()=>{log("connection context disposed",void 0,{F:__dxlog_file3$9,L:259,S:this,C:(e,t)=>e(...t)}),await Promise.all(Array.from(this._swarmStreams.values()).map(e=>e.close())),await Promise.all(Array.from(this._messageStreams.values()).map(e=>e.close())),this._swarmStreams.clear(),this._messageStreams.clear()});try{this._client=new SignalRPCClient({url:this._host,callbacks:{onConnected:()=>{log("socket connected",void 0,{F:__dxlog_file3$9,L:271,S:this,C:(e,t)=>e(...t)}),this._lastError=void 0,this._reconnectAfter=DEFAULT_RECONNECT_TIMEOUT,this._setState(SignalState.CONNECTED),this._clientReady.wake(),this._reconcileTask.schedule()},onDisconnected:()=>{if(log("socket disconnected",{state:this._state},{F:__dxlog_file3$9,L:280,S:this,C:(e,t)=>e(...t)}),this._state===SignalState.ERROR){this._setState(SignalState.DISCONNECTED);return}this._state!==SignalState.CONNECTED&&this._state!==SignalState.CONNECTING&&this._incrementReconnectTimeout(),this._setState(SignalState.DISCONNECTED),this._reconnectTask.schedule()},onError:e=>{log("socket error",{error:e,state:this._state},{F:__dxlog_file3$9,L:295,S:this,C:(t,r)=>t(...r)}),this._lastError=e,this._state!==SignalState.CONNECTED&&this._state!==SignalState.CONNECTING&&this._incrementReconnectTimeout(),this._setState(SignalState.ERROR),this._reconnectTask.schedule()},getMetadata:this._getMetadata}})}catch(e){this._state!==SignalState.CONNECTED&&this._state!==SignalState.CONNECTING&&this._incrementReconnectTimeout(),this._lastError=e,this._setState(SignalState.DISCONNECTED),this._reconnectTask.schedule()}}_incrementReconnectTimeout(){this._reconnectAfter*=2,this._reconnectAfter=Math.min(this._reconnectAfter,MAX_RECONNECT_TIMEOUT)}async _reconnect(){var e,t;if(log(`reconnecting in ${this._reconnectAfter}ms`,{state:this._state},{F:__dxlog_file3$9,L:323,S:this,C:(r,n)=>r(...n)}),this._performance.reconnectCounter++,this._state===SignalState.RECONNECTING){log.warn("Signal api already reconnecting.",void 0,{F:__dxlog_file3$9,L:327,S:this,C:(r,n)=>r(...n)});return}this._state!==SignalState.CLOSED&&(this._clientReady.reset(),await((e=this._connectionCtx)==null?void 0:e.dispose()),(t=this._client)==null||t.close().catch(()=>{}),this._client=void 0,await cancelWithContext(this._ctx,sleep(this._reconnectAfter)),this._setState(SignalState.RECONNECTING),this._createClient())}async _reconcileSwarmSubscriptions(){var t;await asyncTimeout(cancelWithContext(this._connectionCtx,this._clientReady.wait()),5e3);const e=this._client;invariant$1(this._state===SignalState.CONNECTED,"Not connected to Signal Server",{F:__dxlog_file3$9,L:352,S:this,A:["this._state === SignalState.CONNECTED","'Not connected to Signal Server'"]});for(const{topic:r,peerId:n}of this._swarmStreams.keys())this._joinedTopics.has({topic:r,peerId:n})||((t=this._swarmStreams.get({topic:r,peerId:n}))==null||t.close(),this._swarmStreams.delete({topic:r,peerId:n}));for(const{topic:r,peerId:n}of this._joinedTopics.values()){if(this._swarmStreams.has({topic:r,peerId:n}))continue;const o=await asyncTimeout(cancelWithContext(this._connectionCtx,e.join({topic:r,peerId:n})),5e3);o.subscribe(async s=>{log("swarm event",{swarmEvent:s},{F:__dxlog_file3$9,L:379,S:this,C:(a,c)=>a(...c)}),await this._onSwarmEvent({topic:r,swarmEvent:s})}),this._swarmStreams.set({topic:r,peerId:n},o)}}async _reconcileMessageSubscriptions(){var t;await asyncTimeout(cancelWithContext(this._connectionCtx,this._clientReady.wait()),5e3);const e=this._client;invariant$1(this._state===SignalState.CONNECTED,"Not connected to Signal Server",{F:__dxlog_file3$9,L:392,S:this,A:["this._state === SignalState.CONNECTED","'Not connected to Signal Server'"]});for(const r of this._messageStreams.keys())this._subscribedMessages.has({peerId:r})||((t=this._messageStreams.get(r))==null||t.close(),this._messageStreams.delete(r));for(const{peerId:r}of this._subscribedMessages.values()){if(this._messageStreams.has(r))continue;const n=await asyncTimeout(cancelWithContext(this._connectionCtx,e.receiveMessages(r)),5e3);n.subscribe(async o=>{this._performance.receivedMessages++,await this._onMessage({author:PublicKey.from(o.author),recipient:PublicKey.from(o.recipient),payload:o.payload})}),this._messageStreams.set(r,n)}}},__dxlog_file4$7="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/signal-manager/memory-signal-manager.ts",MemorySignalManagerContext=class{constructor(){this.swarmEvent=new Event$1,this.swarms=new ComplexMap(PublicKey.hash),this.connections=new ComplexMap(PublicKey.hash)}},MemorySignalManager=class{constructor(e){this._context=e,this.statusChanged=new Event$1,this.commandTrace=new Event$1,this.swarmEvent=new Event$1,this.onMessage=new Event$1,this._joinedSwarms=new ComplexSet(({topic:t,peerId:r})=>t.toHex()+r.toHex()),this._freezeTrigger=new Trigger().wake(),this._ctx=new Context,this._ctx.onDispose(this._context.swarmEvent.on(t=>this.swarmEvent.emit(t)))}async open(){this._ctx.disposed&&(this._ctx=new Context,this._ctx.onDispose(this._context.swarmEvent.on(e=>this.swarmEvent.emit(e))),await Promise.all([...this._joinedSwarms.values()].map(e=>this.join(e))))}async close(){if(this._ctx.disposed)return;const e=new ComplexSet(({topic:t,peerId:r})=>t.toHex()+r.toHex(),[...this._joinedSwarms.values()]);await Promise.all([...this._joinedSwarms.values()].map(t=>this.leave(t))),this._joinedSwarms=e,await this._ctx.dispose()}getStatus(){return[]}async join({topic:e,peerId:t}){invariant$1(!this._ctx.disposed,"Closed",{F:__dxlog_file4$7,L:102,S:this,A:["!this._ctx.disposed","'Closed'"]}),this._joinedSwarms.add({topic:e,peerId:t}),this._context.swarms.has(e)||this._context.swarms.set(e,new ComplexSet(PublicKey.hash)),this._context.swarms.get(e).add(t),this._context.swarmEvent.emit({topic:e,swarmEvent:{peerAvailable:{peer:t.asUint8Array(),since:new Date}}});for(const[r,n]of this._context.swarms)Array.from(n).forEach(o=>{this.swarmEvent.emit({topic:r,swarmEvent:{peerAvailable:{peer:o.asUint8Array(),since:new Date}}})})}async leave({topic:e,peerId:t}){invariant$1(!this._ctx.disposed,"Closed",{F:__dxlog_file4$7,L:138,S:this,A:["!this._ctx.disposed","'Closed'"]}),this._joinedSwarms.delete({topic:e,peerId:t}),this._context.swarms.has(e)||this._context.swarms.set(e,new ComplexSet(PublicKey.hash)),this._context.swarms.get(e).delete(t);const r={peerLeft:{peer:t.asUint8Array()}};this._context.swarmEvent.emit({topic:e,swarmEvent:r})}async sendMessage({author:e,recipient:t,payload:r}){log("send message",{author:e,recipient:t,...dec(r)},{F:__dxlog_file4$7,L:158,S:this,C:(o,s)=>o(...s)}),invariant$1(t,void 0,{F:__dxlog_file4$7,L:160,S:this,A:["recipient",""]}),invariant$1(!this._ctx.disposed,"Closed",{F:__dxlog_file4$7,L:161,S:this,A:["!this._ctx.disposed","'Closed'"]}),await this._freezeTrigger.wait();const n=this._context.connections.get(t);if(!n){log.warn("recipient is not subscribed for messages",{author:e,recipient:t},{F:__dxlog_file4$7,L:167,S:this,C:(o,s)=>o(...s)});return}if(n._ctx.disposed){log.warn("recipient is disposed",{author:e,recipient:t},{F:__dxlog_file4$7,L:172,S:this,C:(o,s)=>o(...s)});return}n._freezeTrigger.wait().then(()=>{if(n._ctx.disposed){log.warn("recipient is disposed",{author:e,recipient:t},{F:__dxlog_file4$7,L:180,S:this,C:(o,s)=>o(...s)});return}log("receive message",{author:e,recipient:t,...dec(r)},{F:__dxlog_file4$7,L:184,S:this,C:(o,s)=>o(...s)}),n.onMessage.emit({author:e,recipient:t,payload:r})}).catch(o=>{log.error("error while waiting for freeze",{err:o},{F:__dxlog_file4$7,L:189,S:this,C:(s,a)=>s(...a)})})}async subscribeMessages(e){log("subscribing",{peerId:e},{F:__dxlog_file4$7,L:194,S:this,C:(t,r)=>t(...r)}),this._context.connections.set(e,this)}async unsubscribeMessages(e){log("unsubscribing",{peerId:e},{F:__dxlog_file4$7,L:199,S:this,C:(t,r)=>t(...r)}),this._context.connections.delete(e)}freeze(){this._freezeTrigger.reset()}unfreeze(){this._freezeTrigger.wake()}},dec=e=>{var r,n,o;if(!e.type_url.endsWith("ReliablePayload"))return{};const t=schema.getCodecForType("dxos.mesh.messaging.ReliablePayload").decode(e.value);return typeof((r=t==null?void 0:t.payload)==null?void 0:r.data)=="object"?{payload:Object.keys((n=t==null?void 0:t.payload)==null?void 0:n.data)[0],sessionId:(o=t==null?void 0:t.payload)==null?void 0:o.sessionId}:{}};function _ts_decorate$f(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file5$5="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/signal-manager/websocket-signal-manager.ts",MAX_SERVER_FAILURES=5,WSS_SIGNAL_SERVER_REBOOT_DELAY=3e3,WebsocketSignalManager=class{constructor(e,t){this._hosts=e,this._getMetadata=t,this._servers=new Map,this._opened=!1,this.failureCount=new Map,this.statusChanged=new Event$1,this.commandTrace=new Event$1,this.swarmEvent=new Event$1,this.onMessage=new Event$1,this._instanceId=PublicKey.random().toHex(),log("Created WebsocketSignalManager",{hosts:this._hosts},{F:__dxlog_file5$5,L:51,S:this,C:(r,n)=>r(...n)});for(const r of this._hosts){if(this._servers.has(r.server))continue;const n=new SignalClient(r.server,async o=>this.onMessage.emit(o),async o=>this.swarmEvent.emit(o),this._getMetadata);n.statusChanged.on(()=>this.statusChanged.emit(this.getStatus())),this._servers.set(r.server,n),this.failureCount.set(r.server,0),n.commandTrace.on(o=>this.commandTrace.emit(o))}}async open(){this._opened||(log("open signal manager",{hosts:this._hosts},{F:__dxlog_file5$5,L:78,S:this,C:(e,t)=>e(...t)}),log.trace("dxos.mesh.websocket-signal-manager.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file5$5,L:79,S:this,C:(e,t)=>e(...t)}),this._initContext(),[...this._servers.values()].forEach(e=>e.open()),this._opened=!0,log.trace("dxos.mesh.websocket-signal-manager.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file5$5,L:87,S:this,C:(e,t)=>e(...t)}))}async close(){this._opened&&(this._opened=!1,await this._ctx.dispose(),await Promise.all(Array.from(this._servers.values()).map(e=>e.close())))}async restartServer(e){log("restarting server",{serverName:e},{F:__dxlog_file5$5,L:103,S:this,C:(r,n)=>r(...n)}),invariant$1(this._opened,"server already closed",{F:__dxlog_file5$5,L:104,S:this,A:["this._opened","'server already closed'"]});const t=this._servers.get(e);invariant$1(t,"server not found",{F:__dxlog_file5$5,L:107,S:this,A:["server","'server not found'"]}),await t.close(),await sleep(WSS_SIGNAL_SERVER_REBOOT_DELAY),await t.open()}getStatus(){return Array.from(this._servers.values()).map(e=>e.getStatus())}async join({topic:e,peerId:t}){log("join",{topic:e,peerId:t},{F:__dxlog_file5$5,L:120,S:this,C:(r,n)=>r(...n)}),invariant$1(this._opened,"Closed",{F:__dxlog_file5$5,L:121,S:this,A:["this._opened","'Closed'"]}),await this._forEachServer(r=>r.join({topic:e,peerId:t}))}async leave({topic:e,peerId:t}){log("leaving",{topic:e,peerId:t},{F:__dxlog_file5$5,L:127,S:this,C:(r,n)=>r(...n)}),invariant$1(this._opened,"Closed",{F:__dxlog_file5$5,L:128,S:this,A:["this._opened","'Closed'"]}),await this._forEachServer(r=>r.leave({topic:e,peerId:t}))}async sendMessage({author:e,recipient:t,payload:r}){log("signal",{recipient:t},{F:__dxlog_file5$5,L:142,S:this,C:(n,o)=>n(...o)}),invariant$1(this._opened,"Closed",{F:__dxlog_file5$5,L:143,S:this,A:["this._opened","'Closed'"]}),this._forEachServer(async(n,o)=>{n.sendMessage({author:e,recipient:t,payload:r}).catch(s=>{s instanceof RateLimitExceededError?log.info("WSS rate limit exceeded",{err:s},{F:__dxlog_file5$5,L:148,S:this,C:(a,c)=>a(...c)}):s instanceof TimeoutError$1||s.constructor.name==="TimeoutError"?(log.info("WSS sendMessage timeout",{err:s},{F:__dxlog_file5$5,L:150,S:this,C:(a,c)=>a(...c)}),this.checkServerFailure(o)):(log.info(`error sending to ${o}`,{err:s},{F:__dxlog_file5$5,L:153,S:this,C:(a,c)=>a(...c)}),this.checkServerFailure(o))})})}async checkServerFailure(e){const t=this.failureCount.get(e)??0;if(t>MAX_SERVER_FAILURES){log.warn(`too many failures sending to ${e} (${t} > ${MAX_SERVER_FAILURES}), restarting`,void 0,{F:__dxlog_file5$5,L:164,S:this,C:(r,n)=>r(...n)}),await this.restartServer(e),this.failureCount.set(e,0);return}this.failureCount.set(e,(this.failureCount.get(e)??0)+1)}async subscribeMessages(e){log("subscribed for message stream",{peerId:e},{F:__dxlog_file5$5,L:174,S:this,C:(t,r)=>t(...r)}),invariant$1(this._opened,"Closed",{F:__dxlog_file5$5,L:175,S:this,A:["this._opened","'Closed'"]}),await this._forEachServer(async t=>t.subscribeMessages(e))}async unsubscribeMessages(e){log("subscribed for message stream",{peerId:e},{F:__dxlog_file5$5,L:181,S:this,C:(t,r)=>t(...r)}),invariant$1(this._opened,"Closed",{F:__dxlog_file5$5,L:182,S:this,A:["this._opened","'Closed'"]}),await this._forEachServer(async t=>t.unsubscribeMessages(e))}_initContext(){this._ctx=new Context({onError:e=>log.catch(e,void 0,{F:__dxlog_file5$5,L:189,S:this,C:(t,r)=>t(...r)})})}async _forEachServer(e){return Promise.all(Array.from(this._servers.entries()).map(([t,r])=>e(r,t)))}};_ts_decorate$f([synchronized],WebsocketSignalManager.prototype,"open",null),_ts_decorate$f([synchronized],WebsocketSignalManager.prototype,"close",null),_ts_decorate$f([synchronized],WebsocketSignalManager.prototype,"join",null),_ts_decorate$f([synchronized],WebsocketSignalManager.prototype,"leave",null),_ts_decorate$f([synchronized],WebsocketSignalManager.prototype,"checkServerFailure",null);let __dxlog_file6$5;__dxlog_file6$5="/home/runner/work/dxos/dxos/packages/core/mesh/messaging/src/signal-manager/utils.ts",setIdentityTags=({identityService:e,devicesService:t,setTag:r})=>{e.queryIdentity().subscribe(n=>{var o;if(!((o=n==null?void 0:n.identity)!=null&&o.identityKey)){log("empty response from identity service",{idqr:n},{F:__dxlog_file6$5,L:21,S:void 0,C:(s,a)=>s(...a)});return}r("identityKey",n.identity.identityKey.truncate())}),t.queryDevices().subscribe(n=>{if(!n||!n.devices||n.devices.length===0){log("empty response from device service",{device:n},{F:__dxlog_file6$5,L:30,S:void 0,C:(s,a)=>s(...a)});return}invariant$1(n,"empty response from device service",{F:__dxlog_file6$5,L:33,S:void 0,A:["dqr","'empty response from device service'"]});const o=n.devices.find(s=>s.kind===DeviceKind.CURRENT);if(!o){log("no current device",{device:n},{F:__dxlog_file6$5,L:37,S:void 0,C:(s,a)=>s(...a)});return}r("deviceKey",o.deviceKey.truncate())})},index$2=Object.freeze(Object.defineProperty({__proto__:null,MemorySignalManager,MemorySignalManagerContext,Messenger,SignalClient,WebsocketSignalManager,setIdentityTags},Symbol.toStringTag,{value:"Module"}));var xorDistance=dist;function dist(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");for(var r=Buffer.allocUnsafe(e.length),n=0;n<e.length;n++)r[n]=e[n]^t[n];return r}dist.compare=function e(t,r){if(t.length!==r.length)throw new Error("Inputs should have the same length");for(var n=0;n<t.length;n++)if(t[n]!==r[n])return t[n]<r[n]?-1:1;return 0},dist.gt=function e(t,r){return dist.compare(t,r)===1},dist.lt=function e(t,r){return dist.compare(t,r)===-1},dist.eq=function e(t,r){return dist.compare(t,r)===0};const distance=getDefaultExportFromCjs(xorDistance);var browser$2={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var e=1e3,t=e*60,r=t*60,n=r*24,o=n*7,s=n*365.25;ms=function(u,d){d=d||{};var f=typeof u;if(f==="string"&&u.length>0)return a(u);if(f==="number"&&isFinite(u))return d.long?l(u):c(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function a(u){if(u=String(u),!(u.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(d){var f=parseFloat(d[1]),_=(d[2]||"ms").toLowerCase();switch(_){case"years":case"year":case"yrs":case"yr":case"y":return f*s;case"weeks":case"week":case"w":return f*o;case"days":case"day":case"d":return f*n;case"hours":case"hour":case"hrs":case"hr":case"h":return f*r;case"minutes":case"minute":case"mins":case"min":case"m":return f*t;case"seconds":case"second":case"secs":case"sec":case"s":return f*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return f;default:return}}}}function c(u){var d=Math.abs(u);return d>=n?Math.round(u/n)+"d":d>=r?Math.round(u/r)+"h":d>=t?Math.round(u/t)+"m":d>=e?Math.round(u/e)+"s":u+"ms"}function l(u){var d=Math.abs(u);return d>=n?h(u,d,n,"day"):d>=r?h(u,d,r,"hour"):d>=t?h(u,d,t,"minute"):d>=e?h(u,d,e,"second"):u+" ms"}function h(u,d,f,_){var p=d>=f*1.5;return Math.round(u/f)+" "+_+(p?"s":"")}return ms}function setup$1(e){r.debug=r,r.default=r,r.coerce=l,r.disable=s,r.enable=o,r.enabled=a,r.humanize=requireMs(),r.destroy=h,Object.keys(e).forEach(u=>{r[u]=e[u]}),r.names=[],r.skips=[],r.formatters={};function t(u){let d=0;for(let f=0;f<u.length;f++)d=(d<<5)-d+u.charCodeAt(f),d|=0;return r.colors[Math.abs(d)%r.colors.length]}r.selectColor=t;function r(u){let d,f=null,_,p;function y(...w){if(!y.enabled)return;const E=y,x=Number(new Date),B=x-(d||x);E.diff=B,E.prev=d,E.curr=x,d=x,w[0]=r.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let P=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(U,F)=>{if(U==="%%")return"%";P++;const G=r.formatters[F];if(typeof G=="function"){const H=w[P];U=G.call(E,H),w.splice(P,1),P--}return U}),r.formatArgs.call(E,w),(E.log||r.log).apply(E,w)}return y.namespace=u,y.useColors=r.useColors(),y.color=r.selectColor(u),y.extend=n,y.destroy=r.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(_!==r.namespaces&&(_=r.namespaces,p=r.enabled(u)),p),set:w=>{f=w}}),typeof r.init=="function"&&r.init(y),y}function n(u,d){const f=r(this.namespace+(typeof d>"u"?":":d)+u);return f.log=this.log,f}function o(u){r.save(u),r.namespaces=u,r.names=[],r.skips=[];let d;const f=(typeof u=="string"?u:"").split(/[\s,]+/),_=f.length;for(d=0;d<_;d++)f[d]&&(u=f[d].replace(/\*/g,".*?"),u[0]==="-"?r.skips.push(new RegExp("^"+u.slice(1)+"$")):r.names.push(new RegExp("^"+u+"$")))}function s(){const u=[...r.names.map(c),...r.skips.map(c).map(d=>"-"+d)].join(",");return r.enable(""),u}function a(u){if(u[u.length-1]==="*")return!0;let d,f;for(d=0,f=r.skips.length;d<f;d++)if(r.skips[d].test(u))return!1;for(d=0,f=r.names.length;d<f;d++)if(r.names[d].test(u))return!0;return!1}function c(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function l(u){return u instanceof Error?u.stack||u.message:u}function h(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}var common$1=setup$1;(function(e,t){var r={};t.formatArgs=o,t.save=s,t.load=a,t.useColors=n,t.storage=c(),t.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function o(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;h.splice(1,0,u,"color: inherit");let d=0,f=0;h[0].replace(/%[a-zA-Z%]/g,_=>{_!=="%%"&&(d++,_==="%c"&&(f=d))}),h.splice(f,0,u)}t.log=console.debug||console.log||(()=>{});function s(h){try{h?t.storage.setItem("debug",h):t.storage.removeItem("debug")}catch{}}function a(){let h;try{h=t.storage.getItem("debug")}catch{}return!h&&typeof process<"u"&&"env"in process&&(h=r.DEBUG),h}function c(){try{return localStorage}catch{}}e.exports=common$1(t);const{formatters:l}=e.exports;l.j=function(h){try{return JSON.stringify(h)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(browser$2,browser$2.exports);var browserExports$1=browser$2.exports;const debug7=getDefaultExportFromCjs(browserExports$1);var getBrowserRtc=function e(){if(typeof globalThis>"u")return null;var t={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return t.RTCPeerConnection?t:null},browser$1={exports:{}},MAX_BYTES=65536,MAX_UINT32=4294967295;function oldBrowser(){throw new Error(`Secure random number generation is not supported by this browser.
Use Chrome, Firefox or Internet Explorer 11`)}var Buffer$5=safeBufferExports.Buffer,crypto$2=commonjsGlobal.crypto||commonjsGlobal.msCrypto;crypto$2&&crypto$2.getRandomValues?browser$1.exports=randomBytes:browser$1.exports=oldBrowser;function randomBytes(e,t){if(e>MAX_UINT32)throw new RangeError("requested too many random bytes");var r=Buffer$5.allocUnsafe(e);if(e>0)if(e>MAX_BYTES)for(var n=0;n<e;n+=MAX_BYTES)crypto$2.getRandomValues(r.slice(n,n+MAX_BYTES));else crypto$2.getRandomValues(r);return typeof t=="function"?process.nextTick(function(){t(null,r)}):r}var browserExports=browser$1.exports;let promise;var queueMicrotask_1=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:commonjsGlobal):e=>(promise||(promise=Promise.resolve())).then(e).catch(t=>setTimeout(()=>{throw t},0));function assign$1(e,t){for(const r in t)Object.defineProperty(e,r,{value:t[r],enumerable:!0,configurable:!0});return e}function createError(e,t,r){if(!e||typeof e=="string")throw new TypeError("Please pass an Error to err-code");r||(r={}),typeof t=="object"&&(r=t,t=""),t&&(r.code=t);try{return assign$1(e,r)}catch{r.message=e.message,r.stack=e.stack;const n=function(){};return n.prototype=Object.create(Object.getPrototypeOf(e)),assign$1(new n,r)}}var errCode$1=createError;const debug=browserExports$1("simple-peer"),getBrowserRTC=getBrowserRtc,randombytes=browserExports,stream$1=readableBrowserExports,queueMicrotask$2=queueMicrotask_1,errCode=errCode$1,{Buffer:Buffer$4}=buffer,MAX_BUFFERED_AMOUNT$1=64*1024,ICECOMPLETE_TIMEOUT=5*1e3,CHANNEL_CLOSING_TIMEOUT=5*1e3;function filterTrickle(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}function warn(e){console.warn(e)}let Peer$1=class ki extends stream$1.Duplex{constructor(t){if(t=Object.assign({allowHalfOpen:!1},t),super(t),this._id=randombytes(4).toString("hex").slice(0,7),this._debug("new peer %o",t),this.channelName=t.initiator?t.channelName||randombytes(20).toString("hex"):null,this.initiator=t.initiator||!1,this.channelConfig=t.channelConfig||ki.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},ki.config,t.config),this.offerOptions=t.offerOptions||{},this.answerOptions=t.answerOptions||{},this.sdpTransform=t.sdpTransform||(r=>r),this.streams=t.streams||(t.stream?[t.stream]:[]),this.trickle=t.trickle!==void 0?t.trickle:!0,this.allowHalfTrickle=t.allowHalfTrickle!==void 0?t.allowHalfTrickle:!1,this.iceCompleteTimeout=t.iceCompleteTimeout||ICECOMPLETE_TIMEOUT,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=t.wrtc&&typeof t.wrtc=="object"?t.wrtc:getBrowserRTC(),!this._wrtc)throw errCode(typeof window>"u"?new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"):new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(r){this.destroy(errCode(r,"ERR_PC_CONSTRUCTOR"));return}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=r=>{this._onIceCandidate(r)},typeof this._pc.peerIdentity=="object"&&this._pc.peerIdentity.catch(r=>{this.destroy(errCode(r,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=r=>{this._setupData(r)},this.streams&&this.streams.forEach(r=>{this.addStream(r)}),this._pc.ontrack=r=>{this._onTrack(r)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(t){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if(typeof t=="string")try{t=JSON.parse(t)}catch{t={}}this._debug("signal()"),t.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),t.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(t.transceiverRequest.kind,t.transceiverRequest.init)),t.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(t.candidate):this._pendingCandidates.push(t.candidate)),t.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(t)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(r=>{this._addIceCandidate(r)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer())}).catch(r=>{this.destroy(errCode(r,"ERR_SET_REMOTE_DESCRIPTION"))}),!t.sdp&&!t.candidate&&!t.renegotiate&&!t.transceiverRequest&&this.destroy(errCode(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(t){const r=new this._wrtc.RTCIceCandidate(t);this._pc.addIceCandidate(r).catch(n=>{!r.address||r.address.endsWith(".local")?warn("Ignoring unsupported ICE candidate."):this.destroy(errCode(n,"ERR_ADD_ICE_CANDIDATE"))})}send(t){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(t)}}addTransceiver(t,r){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(t,r),this._needsNegotiation()}catch(n){this.destroy(errCode(n,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:t,init:r}})}}addStream(t){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),t.getTracks().forEach(r=>{this.addTrack(r,t)})}}addTrack(t,r){if(this.destroying)return;if(this.destroyed)throw errCode(new Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const n=this._senderMap.get(t)||new Map;let o=n.get(r);if(!o)o=this._pc.addTrack(t,r),n.set(r,o),this._senderMap.set(t,n),this._needsNegotiation();else throw o.removed?errCode(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):errCode(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}replaceTrack(t,r,n){if(this.destroying)return;if(this.destroyed)throw errCode(new Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const o=this._senderMap.get(t),s=o?o.get(n):null;if(!s)throw errCode(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");r&&this._senderMap.set(r,o),s.replaceTrack!=null?s.replaceTrack(r):this.destroy(errCode(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(t,r){if(this.destroying)return;if(this.destroyed)throw errCode(new Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const n=this._senderMap.get(t),o=n?n.get(r):null;if(!o)throw errCode(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{o.removed=!0,this._pc.removeTrack(o)}catch(s){s.name==="NS_ERROR_UNEXPECTED"?this._sendersAwaitingStable.push(o):this.destroy(errCode(s,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(t){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),t.getTracks().forEach(r=>{this.removeTrack(r,t)})}}_needsNegotiation(){this._debug("_needsNegotiation"),!this._batchedNegotiation&&(this._batchedNegotiation=!0,queueMicrotask$2(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this.destroying){if(this.destroyed)throw errCode(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(t){this._destroy(t,()=>{})}_destroy(t,r){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),queueMicrotask$2(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",t&&(t.message||t)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch{}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch{}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),this.emit("close"),r()}))}_setupData(t){if(!t.channel)return this.destroy(errCode(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=t.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=MAX_BUFFERED_AMOUNT$1),this.channelName=this._channel.label,this._channel.onmessage=n=>{this._onChannelMessage(n)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=n=>{const o=n.error instanceof Error?n.error:new Error(`Datachannel error: ${n.message} ${n.filename}:${n.lineno}:${n.colno}`);this.destroy(errCode(o,"ERR_DATA_CHANNEL"))};let r=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(r&&this._onChannelClose(),r=!0):r=!1},CHANNEL_CLOSING_TIMEOUT)}_read(){}_write(t,r,n){if(this.destroyed)return n(errCode(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(t)}catch(o){return this.destroy(errCode(o,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT$1?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=n):n(null)}else this._debug("write before connect"),this._chunk=t,this._cb=n}_onFinish(){if(this.destroyed)return;const t=()=>{setTimeout(()=>this.destroy(),1e3)};this._connected?t():this.once("connect",t)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(t=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(t.sdp=filterTrickle(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const r=()=>{if(this.destroyed)return;const s=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:s.type,sdp:s.sdp})},n=()=>{this._debug("createOffer success"),!this.destroyed&&(this.trickle||this._iceComplete?r():this.once("_iceComplete",r))},o=s=>{this.destroy(errCode(s,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(t).then(n).catch(o)}).catch(t=>{this.destroy(errCode(t,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(t=>{!t.mid&&t.sender.track&&!t.requested&&(t.requested=!0,this.addTransceiver(t.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(t=>{if(this.destroyed)return;!this.trickle&&!this.allowHalfTrickle&&(t.sdp=filterTrickle(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const r=()=>{if(this.destroyed)return;const s=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:s.type,sdp:s.sdp}),this.initiator||this._requestMissingTransceivers()},n=()=>{this.destroyed||(this.trickle||this._iceComplete?r():this.once("_iceComplete",r))},o=s=>{this.destroy(errCode(s,"ERR_SET_LOCAL_DESCRIPTION"))};this._pc.setLocalDescription(t).then(n).catch(o)}).catch(t=>{this.destroy(errCode(t,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._pc.connectionState==="failed"&&this.destroy(errCode(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const t=this._pc.iceConnectionState,r=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",t,r),this.emit("iceStateChange",t,r),(t==="connected"||t==="completed")&&(this._pcReady=!0,this._maybeReady()),t==="failed"&&this.destroy(errCode(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),t==="closed"&&this.destroy(errCode(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(t){const r=n=>(Object.prototype.toString.call(n.values)==="[object Array]"&&n.values.forEach(o=>{Object.assign(n,o)}),n);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then(n=>{const o=[];n.forEach(s=>{o.push(r(s))}),t(null,o)},n=>t(n)):this._pc.getStats.length>0?this._pc.getStats(n=>{if(this.destroyed)return;const o=[];n.result().forEach(s=>{const a={};s.names().forEach(c=>{a[c]=s.stat(c)}),a.id=s.id,a.type=s.type,a.timestamp=s.timestamp,o.push(r(a))}),t(null,o)},n=>t(n)):t(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const t=()=>{this.destroyed||this.getStats((r,n)=>{if(this.destroyed)return;r&&(n=[]);const o={},s={},a={};let c=!1;n.forEach(h=>{(h.type==="remotecandidate"||h.type==="remote-candidate")&&(o[h.id]=h),(h.type==="localcandidate"||h.type==="local-candidate")&&(s[h.id]=h),(h.type==="candidatepair"||h.type==="candidate-pair")&&(a[h.id]=h)});const l=h=>{c=!0;let u=s[h.localCandidateId];u&&(u.ip||u.address)?(this.localAddress=u.ip||u.address,this.localPort=Number(u.port)):u&&u.ipAddress?(this.localAddress=u.ipAddress,this.localPort=Number(u.portNumber)):typeof h.googLocalAddress=="string"&&(u=h.googLocalAddress.split(":"),this.localAddress=u[0],this.localPort=Number(u[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let d=o[h.remoteCandidateId];d&&(d.ip||d.address)?(this.remoteAddress=d.ip||d.address,this.remotePort=Number(d.port)):d&&d.ipAddress?(this.remoteAddress=d.ipAddress,this.remotePort=Number(d.portNumber)):typeof h.googRemoteAddress=="string"&&(d=h.googRemoteAddress.split(":"),this.remoteAddress=d[0],this.remotePort=Number(d[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(n.forEach(h=>{h.type==="transport"&&h.selectedCandidatePairId&&l(a[h.selectedCandidatePairId]),(h.type==="googCandidatePair"&&h.googActiveConnection==="true"||(h.type==="candidatepair"||h.type==="candidate-pair")&&h.selected)&&l(h)}),!c&&(!Object.keys(a).length||Object.keys(s).length)){setTimeout(t,100);return}else this._connecting=!1,this._connected=!0;if(this._chunk){try{this.send(this._chunk)}catch(u){return this.destroy(errCode(u,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const h=this._cb;this._cb=null,h(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};t()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT$1||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||(this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(t=>{this._pc.removeTrack(t),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(t){this.destroyed||(t.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}}):!t.candidate&&!this._iceComplete&&(this._iceComplete=!0,this.emit("_iceComplete")),t.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(t){if(this.destroyed)return;let r=t.data;r instanceof ArrayBuffer&&(r=Buffer$4.from(r)),this.push(r)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const t=this._cb;this._cb=null,t(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(t){this.destroyed||t.streams.forEach(r=>{this._debug("on track"),this.emit("track",t.track,r),this._remoteTracks.push({track:t.track,stream:r}),!this._remoteStreams.some(n=>n.id===r.id)&&(this._remoteStreams.push(r),queueMicrotask$2(()=>{this._debug("on stream"),this.emit("stream",r)}))})}_debug(){const t=[].slice.call(arguments);t[0]="["+this._id+"] "+t[0],debug.apply(null,t)}};Peer$1.WEBRTC_SUPPORT=!!getBrowserRTC(),Peer$1.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},Peer$1.channelConfig={};var simplePeer=Peer$1;const SimplePeerConstructor=getDefaultExportFromCjs(simplePeer);var prefix="Invariant failed";function invariant(e,t){if(!e)throw new Error(prefix)}var ConnectionState$1;(function(e){e[e.INVALID=0]="INVALID",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.CLOSED=3]="CLOSED"})(ConnectionState$1||(ConnectionState$1={}));var emitterComponent=Emitter$1;function Emitter$1(e){if(e)return mixin(e)}function mixin(e){for(var t in Emitter$1.prototype)e[t]=Emitter$1.prototype[t];return e}Emitter$1.prototype.on=Emitter$1.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},Emitter$1.prototype.once=function(e,t){var r=this;this._callbacks=this._callbacks||{};function n(){r.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},Emitter$1.prototype.off=Emitter$1.prototype.removeListener=Emitter$1.prototype.removeAllListeners=Emitter$1.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var r=this._callbacks[e];if(!r)return this;if(arguments.length==1)return delete this._callbacks[e],this;for(var n,o=0;o<r.length;o++)if(n=r[o],n===t||n.fn===t){r.splice(o,1);break}return this},Emitter$1.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),r=this._callbacks[e];if(r){r=r.slice(0);for(var n=0,o=r.length;n<o;++n)r[n].apply(this,t)}return this},Emitter$1.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},Emitter$1.prototype.hasListeners=function(e){return!!this.listeners(e).length};var Emitter=emitterComponent;function Stream(){Emitter.call(this)}Stream.prototype=new Emitter;var stream=Stream;Stream.Stream=Stream,Stream.prototype.pipe=function(e,t){var r=this;function n(u){e.writable&&e.write(u)===!1&&r.pause&&r.pause()}r.on("data",n);function o(){r.readable&&r.resume&&r.resume()}e.on("drain",o),!e._isStdio&&(!t||t.end!==!1)&&(r.on("end",a),r.on("close",c));var s=!1;function a(){s||(s=!0,e.end())}function c(){s||(s=!0,typeof e.destroy=="function"&&e.destroy())}function l(u){if(h(),!this.hasListeners("error"))throw u}r.on("error",l),e.on("error",l);function h(){r.off("data",n),e.off("drain",o),r.off("end",a),r.off("close",c),r.off("error",l),e.off("error",l),r.off("end",h),r.off("close",h),e.off("end",h),e.off("close",h)}return r.on("end",h),r.on("close",h),e.on("end",h),e.on("close",h),e.emit("pipe",r),e};var encode_1=encode$1,MSB$1=128,REST$1=127,MSBALL=~REST$1,INT$1=Math.pow(2,31);function encode$1(e,t,r){if(Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw encode$1.bytes=0,new RangeError("Could not encode varint");t=t||[],r=r||0;for(var n=r;e>=INT$1;)t[r++]=e&255|MSB$1,e/=128;for(;e&MSBALL;)t[r++]=e&255|MSB$1,e>>>=7;return t[r]=e|0,encode$1.bytes=r-n+1,t}var decode$2=read$1,MSB=128,REST=127;function read$1(e,n){var r=0,n=n||0,o=0,s=n,a,c=e.length;do{if(s>=c||o>49)throw read$1.bytes=0,new RangeError("Could not decode varint");a=e[s++],r+=o<28?(a&REST)<<o:(a&REST)*Math.pow(2,o),o+=7}while(a>=MSB);return read$1.bytes=s-n,r}var N1=Math.pow(2,7),N2=Math.pow(2,14),N3=Math.pow(2,21),N4=Math.pow(2,28),N5=Math.pow(2,35),N6=Math.pow(2,42),N7=Math.pow(2,49),N8=Math.pow(2,56),N9=Math.pow(2,63),length=function(e){return e<N1?1:e<N2?2:e<N3?3:e<N4?4:e<N5?5:e<N6?6:e<N7?7:e<N8?8:e<N9?9:10},varint={encode:encode_1,decode:decode$2,encodingLength:length},__dxlog_file$h="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/control-extension.ts",HEARTBEAT_RTT_WARN_THRESH=1e4,DEBUG_PRINT_HEARTBEAT=!1,ControlExtension=class{constructor(e,t,r){this.opts=e,this.localPeerId=t,this.remotePeerId=r,this._ctx=new Context({onError:n=>{this._extensionContext.close(n)}}),this.onExtensionRegistered=new Callback}async registerExtension(e){await this._rpc.rpc.Control.registerExtension({name:e})}async onOpen(e){this._extensionContext=e,this._rpc=createProtoRpcPeer({requested:{Control:schema.getService("dxos.mesh.teleport.control.ControlService")},exposed:{Control:schema.getService("dxos.mesh.teleport.control.ControlService")},handlers:{Control:{registerExtension:async t=>{this.onExtensionRegistered.call(t.name)},heartbeat:async t=>({requestTimestamp:t.requestTimestamp})}},port:await e.createPort("rpc",{contentType:'application/x-protobuf; messageType="dxos.rpc.Message"'}),timeout:this.opts.heartbeatTimeout}),await this._rpc.open(),scheduleTaskInterval(this._ctx,async()=>{const t=new Date;try{const r=await asyncTimeout(this._rpc.rpc.Control.heartbeat({requestTimestamp:t}),this.opts.heartbeatTimeout),n=Date.now();r.requestTimestamp instanceof Date&&n-r.requestTimestamp.getTime()>(HEARTBEAT_RTT_WARN_THRESH<this.opts.heartbeatTimeout?HEARTBEAT_RTT_WARN_THRESH:this.opts.heartbeatTimeout/2)&&log.warn(`heartbeat RTT for Teleport > ${HEARTBEAT_RTT_WARN_THRESH/1e3}s`,{rtt:n-r.requestTimestamp.getTime(),localPeerId:this.localPeerId.truncate(),remotePeerId:this.remotePeerId.truncate()},{F:__dxlog_file$h,L:106,S:this,C:(o,s)=>o(...s)})}catch(r){const n=Date.now();if(r instanceof RpcClosedError){log("ignoring RpcClosedError in heartbeat",void 0,{F:__dxlog_file$h,L:125,S:this,C:(o,s)=>o(...s)}),this._extensionContext.close(r);return}r instanceof TimeoutError$2?(log("timeout waiting for heartbeat response",{err:r,delay:n-t.getTime()},{F:__dxlog_file$h,L:130,S:this,C:(o,s)=>o(...s)}),this.opts.onTimeout(r)):(log.info("other error waiting for heartbeat response",{err:r,delay:n-t.getTime()},{F:__dxlog_file$h,L:133,S:this,C:(o,s)=>o(...s)}),this.opts.onTimeout(r))}},this.opts.heartbeatInterval)}async onClose(e){await this._ctx.dispose(),await this._rpc.close()}async onAbort(e){await this._ctx.dispose(),await this._rpc.abort()}},__dxlog_file2$9="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/muxing/framer.ts",FRAME_LENGTH_SIZE=2,Framer=class{constructor(){this._messageCb=void 0,this._subscribeCb=void 0,this._buffer=void 0,this._sendCallbacks=[],this._bytesSent=0,this._bytesReceived=0,this._writable=!0,this.drain=new Event$1,this._stream=new readableBrowserExports.Duplex({objectMode:!1,read:()=>{this._processResponseQueue()},write:(e,t,r)=>{invariant$1(!this._subscribeCb,"Internal Framer bug. Concurrent writes detected.",{F:__dxlog_file2$9,L:40,S:this,A:["!this._subscribeCb","'Internal Framer bug. Concurrent writes detected.'"]}),this._bytesReceived+=e.length,this._buffer&&this._buffer.length>0?this._buffer=export_Buffer.concat([this._buffer,e]):this._buffer=e,this._messageCb?(this._popFrames(),r()):this._subscribeCb=()=>{this._popFrames(),this._subscribeCb=void 0,r()}}}),this.port={send:e=>new Promise(t=>{const r=encodeFrame(e);this._bytesSent+=r.length,this._writable=this._stream.push(r),this._writable?t():this._sendCallbacks.push(t)}),subscribe:e=>{var t;return invariant$1(!this._messageCb,"Rpc port already has a message listener.",{F:__dxlog_file2$9,L:79,S:this,A:["!this._messageCb","'Rpc port already has a message listener.'"]}),this._messageCb=e,(t=this._subscribeCb)==null||t.call(this),()=>{this._messageCb=void 0}}}}get stream(){return this._stream}get bytesSent(){return this._bytesSent}get bytesReceived(){return this._bytesReceived}get writable(){return this._writable}_processResponseQueue(){const e=this._sendCallbacks;this._sendCallbacks=[],this._writable=!0,this.drain.emit(),e.forEach(t=>t())}_popFrames(){let e=0;for(;e<this._buffer.length;){const t=decodeFrame(this._buffer,e);if(!t)break;e+=t.bytesConsumed,this._messageCb(t.payload)}e<this._buffer.length?this._buffer=this._buffer.subarray(e):this._buffer=void 0}destroy(){this._stream.readableLength>0&&log("framer destroyed while there are still read bytes in the buffer.",void 0,{F:__dxlog_file2$9,L:140,S:this,C:(e,t)=>e(...t)}),this._stream.writableLength>0&&log.warn("framer destroyed while there are still write bytes in the buffer.",void 0,{F:__dxlog_file2$9,L:143,S:this,C:(e,t)=>e(...t)}),this._stream.destroy()}},decodeFrame=(e,t)=>{if(e.length<t+FRAME_LENGTH_SIZE)return;const r=e.readUInt16BE(t),n=FRAME_LENGTH_SIZE+r;return e.length<t+n?void 0:{payload:e.subarray(t+FRAME_LENGTH_SIZE,t+n),bytesConsumed:n}},encodeFrame=e=>{const t=export_Buffer.allocUnsafe(FRAME_LENGTH_SIZE+e.length);return t.writeUInt16BE(e.length,0),t.set(e,FRAME_LENGTH_SIZE),t},__dxlog_file3$8="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/muxing/balancer.ts",MAX_CHUNK_SIZE=8192,Balancer=class{constructor(e){this._sysChannelId=e,this._lastCallerIndex=0,this._channels=[],this._framer=new Framer,this._sendBuffers=new Map,this._receiveBuffers=new Map,this._sending=!1,this.incomingData=new Event$1,this.stream=this._framer.stream,this._channels.push(e),this._framer.port.subscribe(this._processIncomingMessage.bind(this))}get bytesSent(){return this._framer.bytesSent}get bytesReceived(){return this._framer.bytesReceived}get buffersCount(){return this._sendBuffers.size}addChannel(e){this._channels.push(e)}pushData(e,t,r){this._enqueueChunk(e,t,r),this._sendChunks().catch(n=>log.catch(n,void 0,{F:__dxlog_file3$8,L:75,S:this,C:(o,s)=>o(...s)}))}destroy(){this._sendBuffers.size!==0&&log.info("destroying balancer with pending calls",void 0,{F:__dxlog_file3$8,L:80,S:this,C:(e,t)=>e(...t)}),this._sendBuffers.clear(),this._framer.destroy()}_processIncomingMessage(e){const{channelId:t,dataLength:r,chunk:n}=decodeChunk(e,o=>!this._receiveBuffers.has(o));if(!this._receiveBuffers.has(t))n.length<r?this._receiveBuffers.set(t,{buffer:export_Buffer.from(n),msgLength:r}):this.incomingData.emit(n);else{const o=this._receiveBuffers.get(t);if(o.buffer=export_Buffer.concat([o.buffer,n]),o.buffer.length<o.msgLength)return;const s=o.buffer;this._receiveBuffers.delete(t),this.incomingData.emit(s)}}_getNextCallerId(){if(this._sendBuffers.has(this._sysChannelId))return this._sysChannelId;const e=this._lastCallerIndex;return this._lastCallerIndex=(this._lastCallerIndex+1)%this._channels.length,this._channels[e]}_enqueueChunk(e,t,r){if(!this._channels.includes(r))throw new Error(`Unknown channel ${r}`);this._sendBuffers.has(r)||this._sendBuffers.set(r,[]);const n=this._sendBuffers.get(r),o=[];for(let s=0;s<e.length;s+=MAX_CHUNK_SIZE)o.push(e.subarray(s,s+MAX_CHUNK_SIZE));o.forEach((s,a)=>{const c=encodeChunk({chunk:s,channelId:r,dataLength:a===0?e.length:void 0});n.push({msg:c,trigger:a===o.length-1?t:void 0})})}_getNextChunk(){let e;for(;this._sendBuffers.size>0;){const t=this._getNextCallerId(),r=this._sendBuffers.get(t);if(r&&(e=r.shift(),!!e))return r.length===0&&this._sendBuffers.delete(t),e}return null}async _sendChunks(){var t,r;if(this._sending)return;this._sending=!0;let e;for(e=this._getNextChunk();e;){this._framer.writable||(log("PAUSE for drain",void 0,{F:__dxlog_file3$8,L:179,S:this,C:(n,o)=>n(...o)}),await this._framer.drain.waitForCount(1),log("RESUME for drain",void 0,{F:__dxlog_file3$8,L:181,S:this,C:(n,o)=>n(...o)}));try{await this._framer.port.send(e.msg),(t=e.trigger)==null||t.wake()}catch(n){log("Error sending chunk",{err:n},{F:__dxlog_file3$8,L:187,S:this,C:(o,s)=>o(...s)}),(r=e.trigger)==null||r.throw(n)}e=this._getNextChunk()}invariant$1(this._sendBuffers.size===0,"sendBuffers not empty",{F:__dxlog_file3$8,L:192,S:this,A:["this._sendBuffers.size === 0","'sendBuffers not empty'"]}),this._sending=!1}},encodeChunk=({channelId:e,dataLength:t,chunk:r})=>{const n=varint.encodingLength(e),o=t?varint.encodingLength(t):0,s=export_Buffer.allocUnsafe(n+o+r.length);return varint.encode(e,s),t&&varint.encode(t,s,n),s.set(r,n+o),s},decodeChunk=(e,t)=>{const r=varint.decode(e);let n,o=varint.decode.bytes;t(r)&&(n=varint.decode(e,o),o+=varint.decode.bytes);const s=e.subarray(o);return{channelId:r,dataLength:n,chunk:s}};function _ts_decorate$e(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file4$6="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/muxing/muxer.ts",Command=schema.getCodecForType("dxos.mesh.muxer.Command"),DEFAULT_SEND_COMMAND_TIMEOUT=6e4,DESTROY_COMMAND_SEND_TIMEOUT=5e3,STATS_INTERVAL=1e3,MAX_SAFE_FRAME_SIZE=1e6,SYSTEM_CHANNEL_ID=0,GRACEFUL_CLOSE_TIMEOUT=3e3,Muxer=class{constructor(){this._balancer=new Balancer(SYSTEM_CHANNEL_ID),this._channelsByLocalId=new Map,this._channelsByTag=new Map,this._ctx=new Context,this._nextId=1,this._closing=!1,this._destroying=!1,this._disposed=!1,this._lastStats=void 0,this._lastChannelStats=new Map,this.afterClosed=new Event$1,this.statsUpdated=new Event$1,this.stream=this._balancer.stream,this._balancer.incomingData.on(async e=>{await this._handleCommand(Command.decode(e))})}setSessionId(e){this._sessionId=e}get sessionIdString(){return this._sessionId?this._sessionId.truncate():"none"}async createStream(e,t={}){const r=this._getOrCreateStream({tag:e,contentType:t.contentType});invariant$1(!r.push,`Channel already open: ${e}`,{F:__dxlog_file4$6,L:151,S:this,A:["!channel.push","`Channel already open: ${tag}`"]});const n=new readableBrowserExports.Duplex({write:(o,s,a)=>{this._sendData(r,o).then(()=>a()).catch(a)},read:()=>{}});r.push=o=>{r.stats.bytesReceived+=o.length,n.push(o)},r.destroy=o=>{o&&n.listeners("error").length>0?n.destroy(o):n.destroy()};try{await this._sendCommand({openChannel:{id:r.id,tag:r.tag,contentType:r.contentType}},SYSTEM_CHANNEL_ID)}catch(o){throw this._destroyChannel(r,o),o}return n}async createPort(e,t={}){const r=this._getOrCreateStream({tag:e,contentType:t.contentType});invariant$1(!r.push,`Channel already open: ${e}`,{F:__dxlog_file4$6,L:211,S:this,A:["!channel.push","`Channel already open: ${tag}`"]});let n=[],o;r.push=a=>{r.stats.bytesReceived+=a.length,o?o(a):n.push(a)};const s={send:async(a,c)=>{await this._sendData(r,a,c)},subscribe:a=>{invariant$1(!o,"Only one subscriber is allowed",{F:__dxlog_file4$6,L:233,S:this,A:["!callback","'Only one subscriber is allowed'"]}),o=a;for(const c of n)a(c);n=[]}};try{await this._sendCommand({openChannel:{id:r.id,tag:r.tag,contentType:r.contentType}},SYSTEM_CHANNEL_ID)}catch(a){throw this._destroyChannel(r,a),a}return s}async close(e){if(this._destroying){log("already destroying, ignoring graceful close request",void 0,{F:__dxlog_file4$6,L:266,S:this,C:(t,r)=>t(...r)});return}if(this._closing){log("already closing, ignoring graceful close request",void 0,{F:__dxlog_file4$6,L:270,S:this,C:(t,r)=>t(...r)});return}this._closing=!0,await this._sendCommand({close:{error:e==null?void 0:e.message}},SYSTEM_CHANNEL_ID,DESTROY_COMMAND_SEND_TIMEOUT).catch(async t=>{log("error sending close command",{err:t},{F:__dxlog_file4$6,L:285,S:this,C:(r,n)=>r(...n)}),await this._dispose(t)}),await asyncTimeout(this._dispose(e),GRACEFUL_CLOSE_TIMEOUT,new TimeoutError$1("gracefully closing muxer"))}async destroy(e){if(this._destroying){log("already destroying, ignoring destroy request",void 0,{F:__dxlog_file4$6,L:298,S:this,C:(t,r)=>t(...r)});return}this._destroying=!0,this._ctx.dispose(),this._closing?(log("destroy cancelling graceful close",void 0,{F:__dxlog_file4$6,L:304,S:this,C:(t,r)=>t(...r)}),this._closing=!1):await this._sendCommand({close:{error:e==null?void 0:e.message}},SYSTEM_CHANNEL_ID).catch(async t=>{log("error sending courtesy close command",{err:t},{F:__dxlog_file4$6,L:317,S:this,C:(r,n)=>r(...n)})}),this._dispose(e).catch(t=>{log("error disposing after destroy",{err:t},{F:__dxlog_file4$6,L:322,S:this,C:(r,n)=>r(...n)})})}async _dispose(e){var t;if(this._disposed){log("already destroyed, ignoring dispose request",void 0,{F:__dxlog_file4$6,L:330,S:this,C:(r,n)=>r(...n)});return}this._ctx.dispose(),await this._balancer.destroy();for(const r of this._channelsByTag.values())(t=r.destroy)==null||t.call(r,e);this._disposed=!0,await this._emitStats(),this.afterClosed.emit(e),this._channelsByLocalId.clear(),this._channelsByTag.clear()}async _handleCommand(e){if(this._disposed){log.warn("Received command after disposed",{cmd:e},{F:__dxlog_file4$6,L:353,S:this,C:(t,r)=>t(...r)});return}if(e.close){this._closing?log("received close from peer, already closing",void 0,{F:__dxlog_file4$6,L:362,S:this,C:(t,r)=>t(...r)}):(log("received peer close, initiating my own graceful close",void 0,{F:__dxlog_file4$6,L:359,S:this,C:(t,r)=>t(...r)}),await this.close(new Error("received peer close")));return}if(e.openChannel){const t=this._getOrCreateStream({tag:e.openChannel.tag,contentType:e.openChannel.contentType});t.remoteId=e.openChannel.id;for(const r of t.buffer)await this._sendCommand({data:{channelId:t.remoteId,data:r}},t.id);t.buffer=[]}else if(e.data){const t=this._channelsByLocalId.get(e.data.channelId)??failUndefined();if(!t.push){log.warn("Received data for channel before it was opened",{tag:t.tag},{F:__dxlog_file4$6,L:391,S:this,C:(r,n)=>r(...n)});return}t.push(e.data.data)}}async _sendCommand(e,t=-1,r=DEFAULT_SEND_COMMAND_TIMEOUT){if(this._disposed){log.info("ignoring sendCommand after disposed",{cmd:e},{F:__dxlog_file4$6,L:400,S:this,C:(n,o)=>n(...o)});return}try{const n=new Trigger;this._balancer.pushData(Command.encode(e),n,t),await n.wait({timeout:r})}catch(n){await this.destroy(n)}}_getOrCreateStream(e){this._channelsByTag.size===0&&scheduleTaskInterval(this._ctx,async()=>this._emitStats(),STATS_INTERVAL);let t=this._channelsByTag.get(e.tag);return t||(t={id:this._nextId++,remoteId:null,tag:e.tag,contentType:e.contentType,buffer:[],push:null,destroy:null,stats:{bytesSent:0,bytesReceived:0}},this._channelsByTag.set(t.tag,t),this._channelsByLocalId.set(t.id,t),this._balancer.addChannel(t.id)),t}async _sendData(e,t,r){if(t.length>MAX_SAFE_FRAME_SIZE&&log.warn("frame size exceeds maximum safe value",{size:t.length,threshold:MAX_SAFE_FRAME_SIZE},{F:__dxlog_file4$6,L:441,S:this,C:(n,o)=>n(...o)}),e.stats.bytesSent+=t.length,e.remoteId===null){e.buffer.push(t);return}await this._sendCommand({data:{channelId:e.remoteId,data:t}},e.id,r)}_destroyChannel(e,t){e.destroy&&e.destroy(t),this._channelsByLocalId.delete(e.id),this._channelsByTag.delete(e.tag)}async _emitStats(){if(this._disposed||this._destroying){if(!this._lastStats)return;const s=this._lastStats;this._lastStats=void 0,s.readBufferSize=0,s.writeBufferSize=0;for(const a of s.channels)a.writeBufferSize=0;this.statsUpdated.emit(s),this._lastChannelStats.clear();return}const e=this._balancer.bytesSent,t=this._balancer.bytesReceived,r=Date.now(),n=this._lastStats?(r-this._lastStats.timestamp)/1e3:0,o=(s,a)=>a?{bytesSentRate:n?(s.bytesSent-a.bytesSent)/n:void 0,bytesReceivedRate:n?(s.bytesReceived-a.bytesReceived)/n:void 0}:{};this._lastStats={timestamp:r,channels:Array.from(this._channelsByTag.values()).map(s=>{const a={id:s.id,tag:s.tag,contentType:s.contentType,writeBufferSize:s.buffer.length,bytesSent:s.stats.bytesSent,bytesReceived:s.stats.bytesReceived,...o(s.stats,this._lastChannelStats.get(s.id))};return this._lastChannelStats.set(s.id,a),a}),bytesSent:e,bytesReceived:t,...o({bytesSent:e,bytesReceived:t},this._lastStats),readBufferSize:this._balancer.stream.readableLength,writeBufferSize:this._balancer.stream.writableLength},this.statsUpdated.emit(this._lastStats)}};_ts_decorate$e([logInfo],Muxer.prototype,"sessionIdString",null);function _ts_decorate2$8(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file5$4="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/teleport.ts",CONTROL_HEARTBEAT_INTERVAL=1e4,CONTROL_HEARTBEAT_TIMEOUT=6e4,Teleport=class{constructor({initiator:e,localPeerId:t,remotePeerId:r,...n}){this._ctx=new Context({onError:o=>{this.destroy(o).catch(()=>{log.error("Error during destroy",o,{F:__dxlog_file5$4,L:41,S:this,C:(s,a)=>s(...a)})})}}),this._muxer=new Muxer,this._extensions=new Map,this._remoteExtensions=new Set,this._open=!1,this._destroying=!1,this._aborting=!1,invariant$1(typeof e=="boolean",void 0,{F:__dxlog_file5$4,L:58,S:this,A:["typeof initiator === 'boolean'",""]}),invariant$1(PublicKey.isPublicKey(t),void 0,{F:__dxlog_file5$4,L:59,S:this,A:["PublicKey.isPublicKey(localPeerId)",""]}),invariant$1(PublicKey.isPublicKey(r),void 0,{F:__dxlog_file5$4,L:60,S:this,A:["PublicKey.isPublicKey(remotePeerId)",""]}),this.initiator=e,this.localPeerId=t,this.remotePeerId=r,this._control=new ControlExtension({heartbeatInterval:n.controlHeartbeatInterval??CONTROL_HEARTBEAT_INTERVAL,heartbeatTimeout:n.controlHeartbeatTimeout??CONTROL_HEARTBEAT_TIMEOUT,onTimeout:()=>{this._destroying||this._aborting||(log.info("abort teleport due to onTimeout in ControlExtension",void 0,{F:__dxlog_file5$4,L:73,S:this,C:(o,s)=>o(...s)}),this.abort(new TimeoutError$1("control extension")).catch(o=>log.catch(o,void 0,{F:__dxlog_file5$4,L:74,S:this,C:(s,a)=>s(...a)})))}},this.localPeerId,this.remotePeerId),this._control.onExtensionRegistered.set(async o=>{if(log("remote extension",{name:o},{F:__dxlog_file5$4,L:82,S:this,C:(s,a)=>s(...a)}),invariant$1(!this._remoteExtensions.has(o),"Remote extension already exists",{F:__dxlog_file5$4,L:83,S:this,A:["!this._remoteExtensions.has(name)","'Remote extension already exists'"]}),this._remoteExtensions.add(o),this._extensions.has(o))try{await this._openExtension(o)}catch(s){await this.destroy(s)}}),this._muxer.stream.on("close",async()=>{if(this._destroying||this._aborting){log("destroy teleport due to muxer stream close, skipping due to already destroying/aborting",void 0,{F:__dxlog_file5$4,L:99,S:this,C:(o,s)=>o(...s)});return}await this.destroy()}),this._muxer.stream.on("error",async o=>{await this.destroy(o)}),this._muxer.statsUpdated.on(o=>{log.trace("dxos.mesh.teleport.stats",{localPeerId:t,remotePeerId:r,bytesSent:o.bytesSent,bytesSentRate:o.bytesSentRate,bytesReceived:o.bytesReceived,bytesReceivedRate:o.bytesReceivedRate,channels:o.channels},{F:__dxlog_file5$4,L:112,S:this,C:(s,a)=>s(...a)})})}get sessionIdString(){return this._sessionId?this._sessionId.truncate():"none"}get stream(){return this._muxer.stream}get stats(){return this._muxer.statsUpdated}async open(e=PublicKey.random()){this._sessionId=e,log("open",void 0,{F:__dxlog_file5$4,L:146,S:this,C:(t,r)=>t(...r)}),this._setExtension("dxos.mesh.teleport.control",this._control),await this._openExtension("dxos.mesh.teleport.control"),this._open=!0,this._muxer.setSessionId(e)}async close(e){await this.destroy(e)}async abort(e){if(!(this._aborting||this._destroying)&&(this._aborting=!0,!this._ctx.disposed)){await this._ctx.dispose();for(const t of this._extensions.values())try{await t.onAbort(e)}catch(r){log.catch(r,void 0,{F:__dxlog_file5$4,L:175,S:this,C:(n,o)=>n(...o)})}await this._muxer.destroy(e)}}async destroy(e){if(!(this._destroying||this._aborting)&&(log("destroying teleport...",{extensionsCount:this._extensions.size},{F:__dxlog_file5$4,L:188,S:this,C:(t,r)=>t(...r)}),this._destroying=!0,!this._ctx.disposed)){await this._ctx.dispose();for(const t of this._extensions.values())try{log("destroying extension",{name:t.constructor.name},{F:__dxlog_file5$4,L:198,S:this,C:(r,n)=>r(...n)}),await t.onClose(e),log("destroyed extension",{name:t.constructor.name},{F:__dxlog_file5$4,L:200,S:this,C:(r,n)=>r(...n)})}catch(r){log.catch(r,void 0,{F:__dxlog_file5$4,L:202,S:this,C:(n,o)=>n(...o)})}await this._muxer.close(),log("teleport destroyed",void 0,{F:__dxlog_file5$4,L:207,S:this,C:(t,r)=>t(...r)})}}addExtension(e,t){if(!this._open)throw new Error("Not open");log("addExtension",{name:e},{F:__dxlog_file5$4,L:215,S:this,C:(r,n)=>r(...n)}),this._setExtension(e,t),scheduleTask(this._ctx,async()=>{try{await this._control.registerExtension(e)}catch(r){if(r instanceof RpcClosedError)return;throw r}}),this._remoteExtensions.has(e)&&scheduleTask(this._ctx,async()=>{await this._openExtension(e)})}_setExtension(e,t){invariant$1(!e.includes("/"),"Invalid extension name",{F:__dxlog_file5$4,L:239,S:this,A:["!extensionName.includes('/')","'Invalid extension name'"]}),invariant$1(!this._extensions.has(e),"Extension already exists",{F:__dxlog_file5$4,L:240,S:this,A:["!this._extensions.has(extensionName)","'Extension already exists'"]}),this._extensions.set(e,t)}async _openExtension(e){log("open extension",{extensionName:e},{F:__dxlog_file5$4,L:245,S:this,C:(n,o)=>n(...o)});const t=this._extensions.get(e)??failUndefined(),r={initiator:this.initiator,localPeerId:this.localPeerId,remotePeerId:this.remotePeerId,createPort:async(n,o)=>(invariant$1(!n.includes("/"),"Invalid channel name",{F:__dxlog_file5$4,L:253,S:this,A:["!channelName.includes('/')","'Invalid channel name'"]}),this._muxer.createPort(`${e}/${n}`,o)),createStream:async(n,o)=>(invariant$1(!n.includes("/"),"Invalid channel name",{F:__dxlog_file5$4,L:257,S:this,A:["!channelName.includes('/')","'Invalid channel name'"]}),this._muxer.createStream(`${e}/${n}`,o)),close:n=>{runInContextAsync(this._ctx,async()=>{await this.close(n)})}};await t.onOpen(r),log("extension opened",{extensionName:e},{F:__dxlog_file5$4,L:268,S:this,C:(n,o)=>n(...o)})}};_ts_decorate2$8([logInfo],Teleport.prototype,"sessionIdString",null),_ts_decorate2$8([synchronized],Teleport.prototype,"abort",null),_ts_decorate2$8([synchronized],Teleport.prototype,"destroy",null);var __dxlog_file$g="/home/runner/work/dxos/dxos/packages/core/mesh/teleport/src/rpc-extension.ts",RpcExtension=class{constructor(e){this._rpcParams=e,this._isClosed=!1}get initiator(){var e;return(e=this._extensionContext)==null?void 0:e.initiator}get localPeerId(){var e;return(e=this._extensionContext)==null?void 0:e.localPeerId}get remotePeerId(){var e;return(e=this._extensionContext)==null?void 0:e.remotePeerId}get rpc(){return invariant$1(this._rpc,void 0,{F:__dxlog_file$g,L:32,S:this,A:["this._rpc",""]}),this._rpc.rpc}async onOpen(e){this._extensionContext=e;const t=await this.getHandlers();if(this._isClosed)return;const r=await e.createPort("rpc",{contentType:'application/x-protobuf; messageType="dxos.rpc.Message"'});this._rpc=createProtoRpcPeer({...this._rpcParams,handlers:t,port:r}),await this._rpc.open()}async onClose(e){var t;this._isClosed=!0,await((t=this._rpc)==null?void 0:t.close())}async onAbort(e){var t;this._isClosed=!0,await((t=this._rpc)==null?void 0:t.abort())}close(){var e;(e=this._extensionContext)==null||e.close()}},__require=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function _ts_decorate$d(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file$f,STARTING_SIGNALLING_DELAY,TRANSPORT_CONNECTION_TIMEOUT,TRANSPORT_STATS_INTERVAL,MAX_SIGNALLING_DELAY;__dxlog_file$f="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/swarm/connection.ts",STARTING_SIGNALLING_DELAY=10,TRANSPORT_CONNECTION_TIMEOUT=1e4,TRANSPORT_STATS_INTERVAL=5e3,MAX_SIGNALLING_DELAY=300,function(e){e.CREATED="CREATED",e.INITIAL="INITIAL",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.CLOSING="CLOSING",e.CLOSED="CLOSED",e.ABORTING="ABORTING",e.ABORTED="ABORTED"}(ConnectionState||(ConnectionState={})),Connection=class{constructor(e,t,r,n,o,s,a,c,l){this.topic=e,this.ownId=t,this.remoteId=r,this.sessionId=n,this.initiator=o,this._signalMessaging=s,this._protocol=a,this._transportFactory=c,this._callbacks=l,this._ctx=new Context,this.connectedTimeoutContext=new Context,this._protocolClosed=new Trigger,this._transportClosed=new Trigger,this._state="CREATED",this._incomingSignalBuffer=[],this._outgoingSignalBuffer=[],this.stateChanged=new Event$1,this.errors=new ErrorStream,this._instanceId=PublicKey.random().toHex(),this.transportStats=new Event$1,this._signalSendTask=new DeferredTask(this._ctx,async()=>{await this._flushSignalBuffer()}),this._signallingDelay=STARTING_SIGNALLING_DELAY,log.trace("dxos.mesh.connection.construct",{sessionId:this.sessionId,topic:this.topic,localPeerId:this.ownId,remotePeerId:this.remoteId,initiator:this.initiator},{F:__dxlog_file$f,L:137,S:this,C:(h,u)=>h(...u)})}get sessionIdString(){return this.sessionId.truncate()}get state(){return this._state}get transport(){return this._transport}get protocol(){return this._protocol}async openConnection(){invariant$1(this._state==="INITIAL","Invalid state.",{F:__dxlog_file$f,L:167,S:this,A:["this._state === ConnectionState.INITIAL","'Invalid state.'"]}),log.trace("dxos.mesh.connection.open-connection",trace$1.begin({id:this._instanceId}),{F:__dxlog_file$f,L:168,S:this,C:(e,t)=>e(...t)}),log.trace("dxos.mesh.connection.open",{sessionId:this.sessionId,topic:this.topic,localPeerId:this.ownId,remotePeerId:this.remoteId,initiator:this.initiator},{F:__dxlog_file$f,L:169,S:this,C:(e,t)=>e(...t)}),this._changeState("CONNECTING"),this._protocol.open(this.sessionId).catch(e=>{this.errors.raise(e)}),this._protocol.stream.on("close",()=>{log("protocol stream closed",void 0,{F:__dxlog_file$f,L:186,S:this,C:(e,t)=>e(...t)}),this._protocolClosed.wake(),this.close(new ProtocolError("protocol stream closed")).catch(e=>this.errors.raise(e))}),scheduleTask(this.connectedTimeoutContext,async()=>{log.info(`timeout waiting ${TRANSPORT_CONNECTION_TIMEOUT/1e3}s for transport to connect, aborting`,void 0,{F:__dxlog_file$f,L:194,S:this,C:(e,t)=>e(...t)}),await this.abort(new TimeoutError$1(`${TRANSPORT_CONNECTION_TIMEOUT/1e3}s for transport to connect`)).catch(e=>this.errors.raise(e))},TRANSPORT_CONNECTION_TIMEOUT),invariant$1(!this._transport,void 0,{F:__dxlog_file$f,L:202,S:this,A:["!this._transport",""]}),this._transport=this._transportFactory.createTransport({initiator:this.initiator,stream:this._protocol.stream,sendSignal:async e=>this._sendSignal(e),sessionId:this.sessionId}),await this._transport.open(),this._transport.connected.once(async()=>{var e,t;this._changeState("CONNECTED"),await this.connectedTimeoutContext.dispose(),(t=(e=this._callbacks)==null?void 0:e.onConnected)==null||t.call(e),scheduleTaskInterval(this._ctx,async()=>this._emitTransportStats(),TRANSPORT_STATS_INTERVAL)}),this._transport.closed.once(()=>{this._transport=void 0,this._transportClosed.wake(),log("abort triggered by transport close",void 0,{F:__dxlog_file$f,L:223,S:this,C:(e,t)=>e(...t)}),this.abort().catch(e=>this.errors.raise(e))}),this._transport.errors.handle(async e=>{log("transport error:",{err:e},{F:__dxlog_file$f,L:228,S:this,C:(t,r)=>t(...r)}),this.closeReason||(this.closeReason=e==null?void 0:e.message),e instanceof ConnectionResetError?(log.info("aborting due to transport ConnectionResetError",void 0,{F:__dxlog_file$f,L:235,S:this,C:(t,r)=>t(...r)}),this.abort().catch(t=>this.errors.raise(t))):e instanceof ConnectivityError?(log.info("aborting due to transport ConnectivityError",void 0,{F:__dxlog_file$f,L:238,S:this,C:(t,r)=>t(...r)}),this.abort().catch(t=>this.errors.raise(t))):e instanceof UnknownProtocolError&&log.warn("unsure what to do with UnknownProtocolError, will keep on truckin",{err:e},{F:__dxlog_file$f,L:241,S:this,C:(t,r)=>t(...r)}),this._state!=="CLOSED"&&this._state!=="CLOSING"&&(await this.connectedTimeoutContext.dispose(),this.errors.raise(e))});for(const e of this._incomingSignalBuffer)this._transport.onSignal(e);this._incomingSignalBuffer=[],log.trace("dxos.mesh.connection.open-connection",trace$1.end({id:this._instanceId}),{F:__dxlog_file$f,L:257,S:this,C:(e,t)=>e(...t)})}async abort(e){var t,r;if(log("aborting...",{err:e},{F:__dxlog_file$f,L:264,S:this,C:(n,o)=>n(...o)}),this._state==="CLOSED"||this._state==="ABORTED"){log(`abort ignored: already ${this._state}`,this.closeReason,{F:__dxlog_file$f,L:266,S:this,C:(n,o)=>n(...o)});return}await this.connectedTimeoutContext.dispose(),this._changeState("ABORTING"),this.closeReason||(this.closeReason=e==null?void 0:e.message),await this._ctx.dispose();try{await this._closeProtocol()}catch(n){log.catch(n,void 0,{F:__dxlog_file$f,L:282,S:this,C:(o,s)=>o(...s)})}try{await this._closeTransport()}catch(n){log.catch(n,void 0,{F:__dxlog_file$f,L:289,S:this,C:(o,s)=>o(...s)})}try{(r=(t=this._callbacks)==null?void 0:t.onClosed)==null||r.call(t,e)}catch(n){log.catch(n,void 0,{F:__dxlog_file$f,L:295,S:this,C:(o,s)=>o(...s)})}this._changeState("ABORTED")}async close(e){var r,n;if(this.closeReason?this.closeReason+=`; ${e==null?void 0:e.message}`:this.closeReason=e==null?void 0:e.message,this._state==="CLOSED"||this._state==="ABORTING"||this._state==="ABORTED")return;const t=this._state;if(this._changeState("CLOSING"),await this.connectedTimeoutContext.dispose(),await this._ctx.dispose(),log("closing...",{peerId:this.ownId},{F:__dxlog_file$f,L:320,S:this,C:(o,s)=>o(...s)}),t==="CONNECTED"){try{await this._closeProtocol()}catch(o){log.catch(o,void 0,{F:__dxlog_file$f,L:327,S:this,C:(s,a)=>s(...a)})}try{await this._closeTransport()}catch(o){log.catch(o,void 0,{F:__dxlog_file$f,L:334,S:this,C:(s,a)=>s(...a)})}}else{log(`graceful close requested when we were in ${t} state? aborting`,void 0,{F:__dxlog_file$f,L:337,S:this,C:(o,s)=>o(...s)});try{await this._closeProtocol()}catch(o){log.catch(o,void 0,{F:__dxlog_file$f,L:341,S:this,C:(s,a)=>s(...a)})}try{await this._closeTransport()}catch(o){log.catch(o,void 0,{F:__dxlog_file$f,L:346,S:this,C:(s,a)=>s(...a)})}}log("closed",{peerId:this.ownId},{F:__dxlog_file$f,L:350,S:this,C:(o,s)=>o(...s)}),this._changeState("CLOSED"),(n=(r=this._callbacks)==null?void 0:r.onClosed)==null||n.call(r,e)}async _closeProtocol(){log("closing protocol",void 0,{F:__dxlog_file$f,L:356,S:this,C:(e,t)=>e(...t)}),await Promise.race([this._protocol.close(),this._protocolClosed.wait()]),log("protocol closed",void 0,{F:__dxlog_file$f,L:358,S:this,C:(e,t)=>e(...t)})}async _closeTransport(){var e;log("closing transport",void 0,{F:__dxlog_file$f,L:362,S:this,C:(t,r)=>t(...r)}),await Promise.race([(e=this._transport)==null?void 0:e.close(),this._transportClosed.wait()]),log("transport closed",void 0,{F:__dxlog_file$f,L:364,S:this,C:(t,r)=>t(...r)})}_sendSignal(e){this._outgoingSignalBuffer.push(e),this._signalSendTask.schedule()}async _flushSignalBuffer(){var e;if(this._outgoingSignalBuffer.length!==0)try{await cancelWithContext(this._ctx,sleep(this._signallingDelay)),this._signallingDelay=Math.min(this._signallingDelay*2,MAX_SIGNALLING_DELAY);const t=[...this._outgoingSignalBuffer];this._outgoingSignalBuffer.length=0,await this._signalMessaging.signal({author:this.ownId,recipient:this.remoteId,sessionId:this.sessionId,topic:this.topic,data:{signalBatch:{signals:t}}})}catch(t){if(t instanceof CancelledError||t instanceof Error&&((e=t.message)!=null&&e.includes("CANCELLED")))return;log.info("signal message failed to deliver",{err:t},{F:__dxlog_file$f,L:400,S:this,C:(r,n)=>r(...n)}),await this.close(new ConnectivityError("signal message failed to deliver",t))}}async signal(e){var r,n;if(invariant$1(e.sessionId,void 0,{F:__dxlog_file$f,L:409,S:this,A:["msg.sessionId",""]}),!e.sessionId.equals(this.sessionId)){log("dropping signal for incorrect session id",void 0,{F:__dxlog_file$f,L:411,S:this,C:(o,s)=>o(...s)});return}invariant$1(e.data.signal||e.data.signalBatch,void 0,{F:__dxlog_file$f,L:414,S:this,A:["msg.data.signal || msg.data.signalBatch",""]}),invariant$1((r=e.author)==null?void 0:r.equals(this.remoteId),void 0,{F:__dxlog_file$f,L:415,S:this,A:["msg.author?.equals(this.remoteId)",""]}),invariant$1((n=e.recipient)==null?void 0:n.equals(this.ownId),void 0,{F:__dxlog_file$f,L:416,S:this,A:["msg.recipient?.equals(this.ownId)",""]});const t=e.data.signalBatch?e.data.signalBatch.signals??[]:[e.data.signal];for(const o of t)o&&(["CREATED","INITIAL"].includes(this.state)?(log("buffered signal",{peerId:this.ownId,remoteId:this.remoteId,msg:e.data},{F:__dxlog_file$f,L:425,S:this,C:(s,a)=>s(...a)}),this._incomingSignalBuffer.push(o)):(invariant$1(this._transport,"Connection not ready to accept signals.",{F:__dxlog_file$f,L:428,S:this,A:["this._transport","'Connection not ready to accept signals.'"]}),log("received signal",{peerId:this.ownId,remoteId:this.remoteId,msg:e.data},{F:__dxlog_file$f,L:429,S:this,C:(s,a)=>s(...a)}),await this._transport.onSignal(o)))}initiate(){this._changeState("INITIAL")}_changeState(e){log("stateChanged",{from:this._state,to:e,peerId:this.ownId},{F:__dxlog_file$f,L:440,S:this,C:(t,r)=>t(...r)}),invariant$1(e!==this._state,"Already in this state.",{F:__dxlog_file$f,L:441,S:this,A:["state !== this._state","'Already in this state.'"]}),this._state=e,this.stateChanged.emit(e)}async _emitTransportStats(){var t;const e=await((t=this.transport)==null?void 0:t.getStats());e&&this.transportStats.emit(e)}},_ts_decorate$d([logInfo],Connection.prototype,"sessionIdString",null),_ts_decorate$d([synchronized],Connection.prototype,"abort",null),_ts_decorate$d([synchronized],Connection.prototype,"close",null);let __dxlog_file2$8,SwarmMessage;__dxlog_file2$8="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/signal/swarm-messenger.ts",SwarmMessage=schema.getCodecForType("dxos.mesh.swarm.SwarmMessage"),SwarmMessenger=class{constructor({sendMessage:e,onSignal:t,onOffer:r,topic:n}){this._ctx=new Context,this._offerRecords=new ComplexMap(o=>o.toHex()),this._sendMessage=e,this._onSignal=t,this._onOffer=r,this._topic=n}async receiveMessage({author:e,recipient:t,payload:r}){var o,s,a,c;if(r.type_url!=="dxos.mesh.swarm.SwarmMessage")return;const n=SwarmMessage.decode(r.value);this._topic.equals(n.topic)&&(log("received",{from:e,to:t,msg:n},{F:__dxlog_file2$8,L:69,S:this,C:(l,h)=>l(...h)}),(o=n.data)!=null&&o.offer?await this._handleOffer({author:e,recipient:t,message:n}):(s=n.data)!=null&&s.answer?await this._resolveAnswers(n):(a=n.data)!=null&&a.signal?await this._handleSignal({author:e,recipient:t,message:n}):(c=n.data)!=null&&c.signalBatch?await this._handleSignal({author:e,recipient:t,message:n}):log.warn("unknown message",{message:n},{F:__dxlog_file2$8,L:80,S:this,C:(l,h)=>l(...h)}))}async signal(e){var t,r;invariant$1(((t=e.data)==null?void 0:t.signal)||((r=e.data)==null?void 0:r.signalBatch),"Invalid message",{F:__dxlog_file2$8,L:85,S:this,A:["message.data?.signal || message.data?.signalBatch","'Invalid message'"]}),await this._sendReliableMessage({author:e.author,recipient:e.recipient,message:e})}async offer(e){const t={...e,messageId:PublicKey.random()};return new Promise((r,n)=>{this._offerRecords.set(t.messageId,{resolve:r}),this._sendReliableMessage({author:e.author,recipient:e.recipient,message:t}).catch(o=>n(o))})}async _sendReliableMessage({author:e,recipient:t,message:r}){const n={...r,messageId:r.messageId??PublicKey.random()};log("sending",{from:e,to:t,msg:n},{F:__dxlog_file2$8,L:123,S:this,C:(o,s)=>o(...s)}),await this._sendMessage({author:e,recipient:t,payload:{type_url:"dxos.mesh.swarm.SwarmMessage",value:SwarmMessage.encode(n)}})}async _resolveAnswers(e){var r,n,o;invariant$1((n=(r=e.data)==null?void 0:r.answer)==null?void 0:n.offerMessageId,"No offerMessageId",{F:__dxlog_file2$8,L:135,S:this,A:["message.data?.answer?.offerMessageId","'No offerMessageId'"]});const t=this._offerRecords.get(e.data.answer.offerMessageId);t&&(this._offerRecords.delete(e.data.answer.offerMessageId),invariant$1((o=e.data)==null?void 0:o.answer,"No answer",{F:__dxlog_file2$8,L:139,S:this,A:["message.data?.answer","'No answer'"]}),log("resolving",{answer:e.data.answer},{F:__dxlog_file2$8,L:140,S:this,C:(s,a)=>s(...a)}),t.resolve(e.data.answer))}async _handleOffer({author:e,recipient:t,message:r}){invariant$1(r.data.offer,"No offer",{F:__dxlog_file2$8,L:154,S:this,A:["message.data.offer","'No offer'"]});const n={author:e,recipient:t,...r,data:{offer:r.data.offer}},o=await this._onOffer(n);o.offerMessageId=r.messageId;try{await this._sendReliableMessage({author:t,recipient:e,message:{topic:r.topic,sessionId:r.sessionId,data:{answer:o}}})}catch(s){s instanceof TimeoutError$1?log.info("timeout sending answer to offer",{err:s},{F:__dxlog_file2$8,L:175,S:this,C:(a,c)=>a(...c)}):log.info("error sending answer to offer",{err:s},{F:__dxlog_file2$8,L:177,S:this,C:(a,c)=>a(...c)})}}async _handleSignal({author:e,recipient:t,message:r}){invariant$1(r.messageId,void 0,{F:__dxlog_file2$8,L:191,S:this,A:["message.messageId",""]}),invariant$1(r.data.signal||r.data.signalBatch,"Invalid message",{F:__dxlog_file2$8,L:192,S:this,A:["message.data.signal || message.data.signalBatch","'Invalid message'"]});const n={author:e,recipient:t,...r,data:{signal:r.data.signal,signalBatch:r.data.signalBatch}};await this._onSignal(n)}};function _ts_decorate2$7(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file3$7="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/swarm/peer.ts",ConnectionDisplacedError=class extends SystemError{constructor(){super("Connection displaced by remote initiator.")}},CONNECTION_COUNTS_STABLE_AFTER=5e3,Peer=class{constructor(e,t,r,n,o,s,a,c){this.id=e,this.topic=t,this.localPeerId=r,this._signalMessaging=n,this._protocolProvider=o,this._transportFactory=s,this._connectionLimiter=a,this._callbacks=c,this._availableAfter=0,this.availableToConnect=!0,this._ctx=new Context,this.advertizing=!1,this.initiating=!1,this.connectionDisplaced=new Event$1}async onOffer(e){var r;const t=e.author;if(this.connection&&![ConnectionState.CREATED,ConnectionState.INITIAL,ConnectionState.CONNECTING].includes(this.connection.state))return log.info(`received offer when connection already in ${this.connection.state} state`,void 0,{F:__dxlog_file3$7,L:114,S:this,C:(n,o)=>n(...o)}),{accept:!1};if(this.connection||this.initiating)if(t.toHex()<this.localPeerId.toHex())log("close local connection",{localPeerId:this.id,topic:this.topic,remotePeerId:this.localPeerId,sessionId:(r=this.connection)==null?void 0:r.sessionId},{F:__dxlog_file3$7,L:123,S:this,C:(n,o)=>n(...o)}),this.connection&&await this.closeConnection(new ConnectionDisplacedError);else return{accept:!1};if(await this._callbacks.onOffer(t)&&!this.connection){invariant$1(e.sessionId,void 0,{F:__dxlog_file3$7,L:143,S:this,A:["message.sessionId",""]});const n=this._createConnection(!1,e.sessionId);try{await this._connectionLimiter.connecting(e.sessionId),n.initiate(),await n.openConnection()}catch(o){o instanceof CancelledError||log.info("connection error",{topic:this.topic,peerId:this.localPeerId,remoteId:this.id,err:o},{F:__dxlog_file3$7,L:153,S:this,C:(s,a)=>s(...a)}),await this.closeConnection(o)}return{accept:!0}}return{accept:!1}}async initiateConnection(){invariant$1(!this.initiating,"Initiation in progress.",{F:__dxlog_file3$7,L:170,S:this,A:["!this.initiating","'Initiation in progress.'"]}),invariant$1(!this.connection,"Already connected.",{F:__dxlog_file3$7,L:171,S:this,A:["!this.connection","'Already connected.'"]});const e=PublicKey.random();log("initiating...",{ownPeerId:this.localPeerId,topic:this.topic,remotePeerId:this.id,sessionId:e},{F:__dxlog_file3$7,L:173,S:this,C:(n,o)=>n(...o)});const t=this._createConnection(!0,e);this.initiating=!0;let r;try{if(await this._connectionLimiter.connecting(e),t.initiate(),r=await this._signalMessaging.offer({author:this.localPeerId,recipient:this.id,sessionId:e,topic:this.topic,data:{offer:{}}}),log("received",{answer:r,topic:this.topic,ownId:this.localPeerId,remoteId:this.id},{F:__dxlog_file3$7,L:190,S:this,C:(n,o)=>n(...o)}),t.state!==ConnectionState.INITIAL){log("ignoring response",void 0,{F:__dxlog_file3$7,L:192,S:this,C:(n,o)=>n(...o)});return}}catch(n){throw log("initiation error: send offer",{err:n,topic:this.topic,peerId:this.localPeerId,remoteId:this.id},{F:__dxlog_file3$7,L:196,S:this,C:(o,s)=>o(...s)}),await t.abort(n),n}finally{this.initiating=!1}try{if(!r.accept){this._callbacks.onRejected();return}}catch(n){throw log("initiation error: accept answer",{err:n,topic:this.topic,peerId:this.localPeerId,remoteId:this.id},{F:__dxlog_file3$7,L:209,S:this,C:(o,s)=>o(...s)}),await t.abort(n),n}finally{this.initiating=!1}try{log("opening connection as initiator",void 0,{F:__dxlog_file3$7,L:222,S:this,C:(n,o)=>n(...o)}),await t.openConnection(),this._callbacks.onAccepted()}catch(n){throw log("initiation error: open connection",{err:n,topic:this.topic,peerId:this.localPeerId,remoteId:this.id},{F:__dxlog_file3$7,L:226,S:this,C:(o,s)=>o(...s)}),log.warn("closing connection due to unhandled error on openConnection",{err:n},{F:__dxlog_file3$7,L:233,S:this,C:(o,s)=>o(...s)}),await this.closeConnection(n),n}finally{this.initiating=!1}}_createConnection(e,t){var n;log("creating connection",{topic:this.topic,peerId:this.localPeerId,remoteId:this.id,initiator:e,sessionId:t},{F:__dxlog_file3$7,L:247,S:this,C:(o,s)=>o(...s)}),invariant$1(!this.connection,"Already connected.",{F:__dxlog_file3$7,L:254,S:this,A:["!this.connection","'Already connected.'"]});const r=new Connection(this.topic,this.localPeerId,this.id,t,e,this._signalMessaging,this._protocolProvider({initiator:e,localPeerId:this.localPeerId,remotePeerId:this.id,topic:this.topic}),this._transportFactory,{onConnected:()=>{this.availableToConnect=!0,this._lastConnectionTime=Date.now(),this._callbacks.onConnected(),this._connectionLimiter.doneConnecting(t),log.trace("dxos.mesh.connection.connected",{topic:this.topic,localPeerId:this.localPeerId,remotePeerId:this.id,sessionId:t,initiator:e},{F:__dxlog_file3$7,L:273,S:this,C:(o,s)=>o(...s)})},onClosed:o=>{log("connection closed",{topic:this.topic,peerId:this.localPeerId,remoteId:this.id,initiator:e},{F:__dxlog_file3$7,L:282,S:this,C:(s,a)=>s(...a)}),this._connectionLimiter.doneConnecting(t),invariant$1(this.connection===r,"Connection mismatch (race condition).",{F:__dxlog_file3$7,L:287,S:this,A:["this.connection === connection","'Connection mismatch (race condition).'"]}),log.trace("dxos.mesh.connection.closed",{topic:this.topic,localPeerId:this.localPeerId,remotePeerId:this.id,sessionId:t,initiator:e},{F:__dxlog_file3$7,L:289,S:this,C:(s,a)=>s(...a)}),o instanceof ConnectionDisplacedError?this.connectionDisplaced.emit(this.connection):(this._lastConnectionTime&&this._lastConnectionTime+CONNECTION_COUNTS_STABLE_AFTER<Date.now()?this._availableAfter=0:(this.availableToConnect=!1,this._availableAfter=increaseInterval(this._availableAfter)),this._callbacks.onDisconnected(),scheduleTask(this._connectionCtx,()=>{this.availableToConnect=!0,this._callbacks.onPeerAvailable()},this._availableAfter)),this.connection=void 0}});return this._callbacks.onInitiated(r),(n=this._connectionCtx)==null||n.dispose(),this._connectionCtx=this._ctx.derive(),r.errors.handle(o=>{log.info("connection error, closing",{topic:this.topic,peerId:this.localPeerId,remoteId:this.id,initiator:e,err:o},{F:__dxlog_file3$7,L:329,S:this,C:(s,a)=>s(...a)}),log.trace("dxos.mesh.connection.error",{topic:this.topic,localPeerId:this.localPeerId,remotePeerId:this.id,sessionId:t,initiator:e,err:o},{F:__dxlog_file3$7,L:336,S:this,C:(s,a)=>s(...a)}),this.closeConnection(o)}),this.connection=r,r}async closeConnection(e){if(!this.connection)return;const t=this.connection;log("closing...",{peerId:this.id,sessionId:t.sessionId},{F:__dxlog_file3$7,L:361,S:this,C:(r,n)=>r(...n)}),await t.close(e),log("closed",{peerId:this.id,sessionId:t.sessionId},{F:__dxlog_file3$7,L:367,S:this,C:(r,n)=>r(...n)})}async onSignal(e){if(!this.connection){log("dropping signal message for non-existent connection",{message:e},{F:__dxlog_file3$7,L:372,S:this,C:(t,r)=>t(...r)});return}await this.connection.signal(e)}async destroy(e){var t;await this._ctx.dispose(),log("Destroying peer",{peerId:this.id,topic:this.topic},{F:__dxlog_file3$7,L:382,S:this,C:(r,n)=>r(...n)}),await((t=this==null?void 0:this.connection)==null?void 0:t.close(e))}};_ts_decorate2$7([synchronized],Peer.prototype,"destroy",null);var increaseInterval=e=>e===0?50:e<500?500:e<1e3?1e3:e<5e3?5e3:1e4;function _ts_decorate3$6(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file4$5,INITIATION_DELAY,getClassName;__dxlog_file4$5="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/swarm/swarm.ts",INITIATION_DELAY=100,getClassName=e=>Object.getPrototypeOf(e).constructor.name,Swarm=class{constructor(e,t,r,n,o,s,a,c,l=INITIATION_DELAY){this._topic=e,this._ownPeerId=t,this._topology=r,this._protocolProvider=n,this._messenger=o,this._transportFactory=s,this._label=a,this._connectionLimiter=c,this._initiationDelay=l,this._ctx=new Context,this._listeningHandle=void 0,this._peers=new ComplexMap(PublicKey.hash),this._instanceId=PublicKey.random().toHex(),this.connectionAdded=new Event$1,this.disconnected=new Event$1,this.connected=new Event$1,this.errors=new ErrorStream,log.trace("dxos.mesh.swarm.constructor",trace$1.begin({id:this._instanceId,data:{topic:this._topic.toHex(),peerId:this._ownPeerId.toHex()}}),{F:__dxlog_file4$5,L:89,S:this,C:(h,u)=>h(...u)}),log("creating swarm",{peerId:t},{F:__dxlog_file4$5,L:93,S:this,C:(h,u)=>h(...u)}),r.init(this._getSwarmController()),this._swarmMessenger=new SwarmMessenger({sendMessage:async h=>await this._messenger.sendMessage(h),onSignal:async h=>await this.onSignal(h),onOffer:async h=>await this.onOffer(h),topic:this._topic}),log.trace("dxos.mesh.swarm.constructor",trace$1.end({id:this._instanceId}),{F:__dxlog_file4$5,L:102,S:this,C:(h,u)=>h(...u)})}get connections(){return Array.from(this._peers.values()).map(e=>e.connection).filter(isNotNullOrUndefined)}get ownPeerId(){return this._ownPeerId}get label(){return this._label}get topic(){return this._topic}async open(){invariant$1(!this._listeningHandle,void 0,{F:__dxlog_file4$5,L:129,S:this,A:["!this._listeningHandle",""]}),this._listeningHandle=await this._messenger.listen({peerId:this._ownPeerId,payloadType:"dxos.mesh.swarm.SwarmMessage",onMessage:async e=>{await this._swarmMessenger.receiveMessage(e).catch(t=>log.info("Error while receiving message",{err:t},{F:__dxlog_file4$5,L:137,S:this,C:(r,n)=>r(...n)}))}})}async destroy(){var e;log("destroying...",void 0,{F:__dxlog_file4$5,L:143,S:this,C:(t,r)=>t(...r)}),await((e=this._listeningHandle)==null?void 0:e.unsubscribe()),this._listeningHandle=void 0,await this._ctx.dispose(),await this._topology.destroy(),await Promise.all(Array.from(this._peers.keys()).map(t=>this._destroyPeer(t,"swarm destroyed"))),log("destroyed",void 0,{F:__dxlog_file4$5,L:150,S:this,C:(t,r)=>t(...r)})}async setTopology(e){invariant$1(!this._ctx.disposed,"Swarm is offline",{F:__dxlog_file4$5,L:154,S:this,A:["!this._ctx.disposed","'Swarm is offline'"]}),e!==this._topology&&(log("setting topology",{previous:getClassName(this._topology),topology:getClassName(e)},{F:__dxlog_file4$5,L:158,S:this,C:(t,r)=>t(...r)}),await this._topology.destroy(),this._topology=e,this._topology.init(this._getSwarmController()),this._topology.update())}onSwarmEvent(e){var t;if(log("swarm event",{swarmEvent:e},{F:__dxlog_file4$5,L:171,S:this,C:(r,n)=>r(...n)}),this._ctx.disposed){log("swarm event ignored for disposed swarm",void 0,{F:__dxlog_file4$5,L:174,S:this,C:(r,n)=>r(...n)});return}if(e.peerAvailable){const r=PublicKey.from(e.peerAvailable.peer);if(log("new peer",{peerId:r},{F:__dxlog_file4$5,L:180,S:this,C:(n,o)=>n(...o)}),!r.equals(this._ownPeerId)){const n=this._getOrCreatePeer(r);n.advertizing=!0}}else if(e.peerLeft){const r=this._peers.get(PublicKey.from(e.peerLeft.peer));r?(r.advertizing=!1,((t=r.connection)==null?void 0:t.state)!==ConnectionState.CONNECTED&&this._destroyPeer(r.id,"peer left").catch(n=>log.catch(n,void 0,{F:__dxlog_file4$5,L:191,S:this,C:(o,s)=>o(...s)}))):log("received peerLeft but no peer found",{peer:e.peerLeft.peer},{F:__dxlog_file4$5,L:194,S:this,C:(n,o)=>n(...o)})}this._topology.update()}async onOffer(e){var r,n;if(log("offer",{message:e},{F:__dxlog_file4$5,L:203,S:this,C:(o,s)=>o(...s)}),this._ctx.disposed)return log("ignored for disposed swarm",void 0,{F:__dxlog_file4$5,L:205,S:this,C:(o,s)=>o(...s)}),{accept:!1};if(invariant$1(e.author,void 0,{F:__dxlog_file4$5,L:210,S:this,A:["message.author",""]}),!((r=e.recipient)!=null&&r.equals(this._ownPeerId)))return log("rejecting offer with incorrect peerId",{message:e},{F:__dxlog_file4$5,L:212,S:this,C:(o,s)=>o(...s)}),{accept:!1};if(!((n=e.topic)!=null&&n.equals(this._topic)))return log("rejecting offer with incorrect topic",{message:e},{F:__dxlog_file4$5,L:216,S:this,C:(o,s)=>o(...s)}),{accept:!1};const t=await this._getOrCreatePeer(e.author).onOffer(e);return this._topology.update(),t}async onSignal(e){var t,r;if(log("signal",{message:e},{F:__dxlog_file4$5,L:227,S:this,C:(n,o)=>n(...o)}),this._ctx.disposed){log.info("ignored for offline swarm",void 0,{F:__dxlog_file4$5,L:229,S:this,C:(n,o)=>n(...o)});return}invariant$1((t=e.recipient)==null?void 0:t.equals(this._ownPeerId),`Invalid signal peer id expected=${this.ownPeerId}, actual=${e.recipient}`,{F:__dxlog_file4$5,L:232,S:this,A:["message.recipient?.equals(this._ownPeerId)","`Invalid signal peer id expected=${this.ownPeerId}, actual=${message.recipient}`"]}),invariant$1((r=e.topic)==null?void 0:r.equals(this._topic),void 0,{F:__dxlog_file4$5,L:236,S:this,A:["message.topic?.equals(this._topic)",""]}),invariant$1(e.author,void 0,{F:__dxlog_file4$5,L:237,S:this,A:["message.author",""]}),await this._getOrCreatePeer(e.author).onSignal(e)}async goOffline(){await this._ctx.dispose(),await Promise.all([...this._peers.keys()].map(e=>this._destroyPeer(e,"goOffline")))}async goOnline(){this._ctx=new Context}_getOrCreatePeer(e){let t=this._peers.get(e);return t||(t=new Peer(e,this._topic,this._ownPeerId,this._swarmMessenger,this._protocolProvider,this._transportFactory,this._connectionLimiter,{onInitiated:r=>{this.connectionAdded.emit(r)},onConnected:()=>{this.connected.emit(e)},onDisconnected:async()=>{t.advertizing||await this._destroyPeer(t.id,"peer disconnected"),this.disconnected.emit(e),this._topology.update()},onRejected:()=>{this._peers.has(e)&&(log("peer rejected connection",{peerId:e},{F:__dxlog_file4$5,L:286,S:this,C:(r,n)=>r(...n)}),this._destroyPeer(e,"peer rejected connection"))},onAccepted:()=>{this._topology.update()},onOffer:r=>this._topology.onOffer(r),onPeerAvailable:()=>{this._topology.update()}}),this._peers.set(e,t)),t}async _destroyPeer(e,t){invariant$1(this._peers.has(e),void 0,{F:__dxlog_file4$5,L:308,S:this,A:["this._peers.has(peerId)",""]}),await this._peers.get(e).destroy(new Error(t)),this._peers.delete(e)}_getSwarmController(){return{getState:()=>({ownPeerId:this._ownPeerId,connected:Array.from(this._peers.values()).filter(e=>e.connection).map(e=>e.id),candidates:Array.from(this._peers.values()).filter(e=>!e.connection&&e.advertizing&&e.availableToConnect).map(e=>e.id),allPeers:Array.from(this._peers.values()).map(e=>e.id)}),connect:e=>{this._ctx.disposed||scheduleTask(this._ctx,async()=>{try{await this._initiateConnection(e)}catch(t){log("initiation error",t,{F:__dxlog_file4$5,L:335,S:this,C:(r,n)=>r(...n)})}})},disconnect:async e=>{this._ctx.disposed||scheduleTask(this._ctx,async()=>{await this._closeConnection(e),this._topology.update()})}}}async _initiateConnection(e){const t=this._ctx,r=this._getOrCreatePeer(e);if(e.toHex()<this._ownPeerId.toHex()&&(log("initiation delay",{remoteId:e},{F:__dxlog_file4$5,L:363,S:this,C:(n,o)=>n(...o)}),await sleep(this._initiationDelay)),!t.disposed){if(this._peers.get(e)==null)throw new Error("Peer left during initiation delay");r.connection||(log("initiating connection...",{remoteId:e},{F:__dxlog_file4$5,L:379,S:this,C:(n,o)=>n(...o)}),await r.initiateConnection(),this._topology.update(),log("initiated",{remoteId:e},{F:__dxlog_file4$5,L:382,S:this,C:(n,o)=>n(...o)}))}}async _closeConnection(e){const t=this._peers.get(e);t&&await t.closeConnection()}},_ts_decorate3$6([logInfo],Swarm.prototype,"_instanceId",void 0),_ts_decorate3$6([logInfo],Swarm.prototype,"ownPeerId",null),_ts_decorate3$6([logInfo],Swarm.prototype,"topic",null),_ts_decorate3$6([synchronized],Swarm.prototype,"onSwarmEvent",null),_ts_decorate3$6([synchronized],Swarm.prototype,"onOffer",null),_ts_decorate3$6([synchronized],Swarm.prototype,"goOffline",null),_ts_decorate3$6([synchronized],Swarm.prototype,"goOnline",null);let __dxlog_file5$3,__dxlog_file6$4,CONNECTION_GC_THRESHOLD;__dxlog_file5$3="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/swarm/swarm-mapper.ts",SwarmMapper=class{get peers(){return Array.from(this._peers.values())}constructor(e){this._swarm=e,this._subscriptions=new EventSubscriptions,this._connectionSubscriptions=new ComplexMap(PublicKey.hash),this._peers=new ComplexMap(PublicKey.hash),this.mapUpdated=new Event$1,this._subscriptions.add(e.connectionAdded.on(t=>{this._update(),this._connectionSubscriptions.set(t.remoteId,t.stateChanged.on(()=>{this._update()}))})),this._subscriptions.add(e.disconnected.on(t=>{var r;(r=this._connectionSubscriptions.get(t))==null||r(),this._connectionSubscriptions.delete(t),this._update()})),this._update()}_update(){log("updating swarm",void 0,{F:__dxlog_file5$3,L:72,S:this,C:(e,t)=>e(...t)}),this._peers.clear(),this._peers.set(this._swarm.ownPeerId,{id:this._swarm.ownPeerId,state:"ME",connections:[]});for(const e of this._swarm.connections)this._peers.set(e.remoteId,{id:e.remoteId,state:e.state,connections:[this._swarm.ownPeerId]});log("graph changed",{directConnections:this._swarm.connections.length,totalPeersInSwarm:this._peers.size},{F:__dxlog_file5$3,L:113,S:this,C:(e,t)=>e(...t)}),this.mapUpdated.emit(Array.from(this._peers.values()))}destroy(){Array.from(this._connectionSubscriptions.values()).forEach(e=>e()),this._subscriptions.clear()}},__dxlog_file6$4="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/swarm/connection-limiter.ts",MAX_CONCURRENT_INITIATING_CONNECTIONS=50,ConnectionLimiter=class{constructor({maxConcurrentInitConnections:e=MAX_CONCURRENT_INITIATING_CONNECTIONS}={}){this._ctx=new Context,this._waitingPromises=new ComplexMap(PublicKey.hash),this.resolveWaitingPromises=new DeferredTask(this._ctx,async()=>{Array.from(this._waitingPromises.values()).slice(0,this._maxConcurrentInitConnections).forEach(({resolve:t})=>{t()})}),this._maxConcurrentInitConnections=e}async connecting(e){invariant$1(!this._waitingPromises.has(e),"Peer is already waiting for connection",{F:__dxlog_file6$4,L:48,S:this,A:["!this._waitingPromises.has(sessionId)","'Peer is already waiting for connection'"]}),log("waiting",{sessionId:e},{F:__dxlog_file6$4,L:49,S:this,C:(t,r)=>t(...r)}),await new Promise((t,r)=>{this._waitingPromises.set(e,{resolve:t,reject:r}),this.resolveWaitingPromises.schedule()}),log("allow",{sessionId:e},{F:__dxlog_file6$4,L:57,S:this,C:(t,r)=>t(...r)})}doneConnecting(e){log("done",{sessionId:e},{F:__dxlog_file6$4,L:64,S:this,C:(t,r)=>t(...r)}),this._waitingPromises.has(e)&&(this._waitingPromises.get(e).reject(new CancelledError),this._waitingPromises.delete(e),this.resolveWaitingPromises.schedule())}},CONNECTION_GC_THRESHOLD=9e5,function(e){e.CONNECTION_STATE_CHANGED="CONNECTION_STATE_CHANGED",e.PROTOCOL_ERROR="PROTOCOL_ERROR",e.PROTOCOL_EXTENSIONS_INITIALIZED="PROTOCOL_EXTENSIONS_INITIALIZED",e.PROTOCOL_EXTENSIONS_HANDSHAKE="PROTOCOL_EXTENSIONS_HANDSHAKE",e.PROTOCOL_HANDSHAKE="PROTOCOL_HANDSHAKE"}(EventType||(EventType={}));let gcSwarm;ConnectionLog=class{constructor(){this._swarms=new ComplexMap(PublicKey.hash),this.update=new Event$1}getSwarmInfo(e){return this._swarms.get(e)??raise$1(new Error(`Swarm not found: ${e}`))}get swarms(){return Array.from(this._swarms.values())}joinedSwarm(e){const t={id:PublicKey.from(e._instanceId),topic:e.topic,isActive:!0,label:e.label,connections:[]};this._swarms.set(PublicKey.from(e._instanceId),t),this.update.emit(),e.connectionAdded.on(r=>{var o,s,a;const n={state:ConnectionState.CREATED,closeReason:r.closeReason,remotePeerId:r.remoteId,sessionId:r.sessionId,transport:r.transport&&Object.getPrototypeOf(r.transport).constructor.name,protocolExtensions:[],events:[],lastUpdate:new Date};t.connections.push(n),this.update.emit(),r.stateChanged.on(async c=>{var l;if(n.state=c,n.closeReason=r.closeReason,n.lastUpdate=new Date,n.events.push({type:"CONNECTION_STATE_CHANGED",newState:c}),c===ConnectionState.CONNECTED){const h=await((l=r.transport)==null?void 0:l.getDetails());n.transportDetails=h}this.update.emit()}),(s=(o=r.protocol)==null?void 0:o.stats)==null||s.on(c=>{n.readBufferSize=c.readBufferSize,n.writeBufferSize=c.writeBufferSize,n.streams=c.channels,n.lastUpdate=new Date,this.update.emit()}),(a=r.transportStats)==null||a.on(c=>{n.transportBytesSent=c.bytesSent,n.transportBytesReceived=c.bytesReceived,n.transportPacketsSent=c.packetsSent,n.transportPacketsReceived=c.packetsReceived}),gcSwarm(t)})}leftSwarm(e){this.getSwarmInfo(PublicKey.from(e._instanceId)).isActive=!1,this.update.emit()}},gcSwarm=e=>{var t;e.connections=(t=e.connections)==null?void 0:t.filter(r=>r.lastUpdate?Date.now()-r.lastUpdate.getTime()<CONNECTION_GC_THRESHOLD:!0)};function _ts_decorate4$3(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file7$3;__dxlog_file7$3="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/network-manager.ts",NetworkManager=class{constructor({transportFactory:e,signalManager:t,log:r}){this._swarms=new ComplexMap(PublicKey.hash),this._mappers=new ComplexMap(PublicKey.hash),this._connectionState=ConnectionState$2.ONLINE,this.connectionStateChanged=new Event$1,this.topicsUpdated=new Event$1,this._instanceId=PublicKey.random().toHex(),this._transportFactory=e,this._signalManager=t,this._signalManager.swarmEvent.on(({topic:n,swarmEvent:o})=>{var s;return(s=this._swarms.get(n))==null?void 0:s.onSwarmEvent(o)}),this._messenger=new Messenger({signalManager:this._signalManager}),this._signalConnection={join:n=>this._signalManager.join(n),leave:n=>this._signalManager.leave(n)},this._connectionLimiter=new ConnectionLimiter,r&&(this._connectionLog=new ConnectionLog)}get connectionLog(){return this._connectionLog}get connectionState(){return this._connectionState}get topics(){return Array.from(this._swarms.keys())}getSwarmMap(e){return this._mappers.get(e)}getSwarm(e){return this._swarms.get(e)}async open(){log.trace("dxos.mesh.network-manager.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file7$3,L:130,S:this,C:(e,t)=>e(...t)}),await this._messenger.open(),await this._signalManager.open(),log.trace("dxos.mesh.network-manager.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file7$3,L:133,S:this,C:(e,t)=>e(...t)})}async close(){for(const e of this._swarms.keys())await this.leaveSwarm(e).catch(t=>{log(t,void 0,{F:__dxlog_file7$3,L:139,S:this,C:(r,n)=>r(...n)})});await this._messenger.close(),await this._signalManager.close()}async joinSwarm({topic:e,peerId:t,topology:r,protocolProvider:n,label:o}){var a;if(invariant$1(PublicKey.isPublicKey(e),void 0,{F:__dxlog_file7$3,L:158,S:this,A:["PublicKey.isPublicKey(topic)",""]}),invariant$1(PublicKey.isPublicKey(t),void 0,{F:__dxlog_file7$3,L:159,S:this,A:["PublicKey.isPublicKey(peerId)",""]}),invariant$1(r,void 0,{F:__dxlog_file7$3,L:160,S:this,A:["topology",""]}),invariant$1(typeof n=="function",void 0,{F:__dxlog_file7$3,L:161,S:this,A:["typeof protocol === 'function'",""]}),this._swarms.has(e))throw new Error(`Already connected to swarm: ${PublicKey.from(e)}`);log("joining",{topic:PublicKey.from(e),peerId:t,topology:r.toString()},{F:__dxlog_file7$3,L:166,S:this,C:(c,l)=>c(...l)});const s=new Swarm(e,t,r,n,this._messenger,this._transportFactory,o,this._connectionLimiter);return s.errors.handle(c=>{log("swarm error",{error:c},{F:__dxlog_file7$3,L:179,S:this,C:(l,h)=>l(...h)})}),this._swarms.set(e,s),this._mappers.set(e,new SwarmMapper(s)),await s.open(),this._signalConnection.join({topic:e,peerId:t}).catch(c=>log.catch(c,void 0,{F:__dxlog_file7$3,L:188,S:this,C:(l,h)=>l(...h)})),this.topicsUpdated.emit(),(a=this._connectionLog)==null||a.joinedSwarm(s),log("joined",{topic:PublicKey.from(e),count:this._swarms.size},{F:__dxlog_file7$3,L:192,S:this,C:(c,l)=>c(...l)}),{close:()=>this.leaveSwarm(e)}}async leaveSwarm(e){var r;if(!this._swarms.has(e))return;log("leaving",{topic:PublicKey.from(e)},{F:__dxlog_file7$3,L:209,S:this,C:(n,o)=>n(...o)});const t=this._swarms.get(e);await this._signalConnection.leave({topic:e,peerId:t.ownPeerId}),this._mappers.get(e).destroy(),this._mappers.delete(e),(r=this._connectionLog)==null||r.leftSwarm(t),await t.destroy(),this._swarms.delete(e),await this.topicsUpdated.emit(),log("left",{topic:PublicKey.from(e),count:this._swarms.size},{F:__dxlog_file7$3,L:223,S:this,C:(n,o)=>n(...o)})}async setConnectionState(e){if(e!==this._connectionState){switch(e){case ConnectionState$2.OFFLINE:{this._connectionState=e,await Promise.all([...this._swarms.values()].map(t=>t.goOffline())),await this._messenger.close(),await this._signalManager.close();break}case ConnectionState$2.ONLINE:{this._connectionState=e,this._messenger.open(),await Promise.all([...this._swarms.values()].map(t=>t.goOnline())),await this._signalManager.open();break}}this.connectionStateChanged.emit(this._connectionState)}}},_ts_decorate4$3([synchronized],NetworkManager.prototype,"joinSwarm",null),_ts_decorate4$3([synchronized],NetworkManager.prototype,"leaveSwarm",null);let __dxlog_file9$3,MIN_UPDATE_INTERVAL,MAX_CHANGES_PER_UPDATE,sortByXorDistance;__dxlog_file9$3="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/topology/mmst-topology.ts",MIN_UPDATE_INTERVAL=1e4,MAX_CHANGES_PER_UPDATE=1,MMSTTopology=class{constructor({originateConnections:e=2,maxPeers:t=4,sampleSize:r=10}={}){this._sampleCollected=!1,this._lastAction=new Date(0),this._originateConnections=e,this._maxPeers=t,this._sampleSize=r}init(e){invariant$1(!this._controller,"Already initialized",{F:__dxlog_file9$3,L:51,S:this,A:["!this._controller","'Already initialized'"]}),this._controller=e}update(){invariant$1(this._controller,"Not initialized",{F:__dxlog_file9$3,L:56,S:this,A:["this._controller","'Not initialized'"]});const{connected:e,candidates:t}=this._controller.getState();(this._sampleCollected||e.length>this._maxPeers||t.length>0)&&(log("Running the algorithm.",void 0,{F:__dxlog_file9$3,L:60,S:this,C:(r,n)=>r(...n)}),this._sampleCollected=!0,this._runAlgorithm())}forceUpdate(){this._lastAction=new Date(0),this.update()}async onOffer(e){invariant$1(this._controller,"Not initialized",{F:__dxlog_file9$3,L:72,S:this,A:["this._controller","'Not initialized'"]});const{connected:t}=this._controller.getState(),r=t.length<this._maxPeers;return log(`Offer ${e} accept=${r}`,void 0,{F:__dxlog_file9$3,L:75,S:this,C:(n,o)=>n(...o)}),r}async destroy(){}_runAlgorithm(){invariant$1(this._controller,"Not initialized",{F:__dxlog_file9$3,L:84,S:this,A:["this._controller","'Not initialized'"]});const{connected:e,candidates:t,ownPeerId:r}=this._controller.getState();if(e.length>this._maxPeers){log(`disconnect ${e.length-this._maxPeers} peers.`,void 0,{F:__dxlog_file9$3,L:90,S:this,C:(o,s)=>o(...s)});const n=sortByXorDistance(e,r).reverse().slice(0,this._maxPeers-e.length);if(invariant$1(n.length===0,void 0,{F:__dxlog_file9$3,L:94,S:this,A:["sorted.length === 0",""]}),n.length>MAX_CHANGES_PER_UPDATE&&log(`want to disconnect ${n.length} peers but limited to ${MAX_CHANGES_PER_UPDATE}`,void 0,{F:__dxlog_file9$3,L:97,S:this,C:(o,s)=>o(...s)}),Date.now()-this._lastAction.getTime()>MIN_UPDATE_INTERVAL){for(const o of n.slice(0,MAX_CHANGES_PER_UPDATE))log(`Disconnect ${o}.`,void 0,{F:__dxlog_file9$3,L:102,S:this,C:(s,a)=>s(...a)}),this._controller.disconnect(o);this._lastAction=new Date}else log("rate limited disconnect",void 0,{F:__dxlog_file9$3,L:107,S:this,C:(o,s)=>o(...s)})}else if(e.length<this._originateConnections){log(`connect ${this._originateConnections-e.length} peers.`,void 0,{F:__dxlog_file9$3,L:111,S:this,C:(s,a)=>s(...a)});const n=t.sort(()=>Math.random()-.5).slice(0,this._sampleSize),o=sortByXorDistance(n,r).slice(0,this._originateConnections-e.length);if(o.length>MAX_CHANGES_PER_UPDATE&&log(`want to connect ${o.length} peers but limited to ${MAX_CHANGES_PER_UPDATE}`,void 0,{F:__dxlog_file9$3,L:116,S:this,C:(s,a)=>s(...a)}),Date.now()-this._lastAction.getTime()>MIN_UPDATE_INTERVAL){for(const s of o.slice(0,MAX_CHANGES_PER_UPDATE))log(`Connect ${s}.`,void 0,{F:__dxlog_file9$3,L:120,S:this,C:(a,c)=>a(...c)}),this._controller.connect(s);this._lastAction=new Date}else log("rate limited connect",void 0,{F:__dxlog_file9$3,L:125,S:this,C:(s,a)=>s(...a)})}}toString(){return"MMSTTopology"}},sortByXorDistance=(e,t)=>e.sort((r,n)=>distance.gt(distance(r.asBuffer(),t.asBuffer()),distance(n.asBuffer(),t.asBuffer())));function _ts_decorate5$2(e,t,r,n){var o=arguments.length,s=o<3?t:n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file11$2,MEMORY_TRANSPORT_DELAY,createStreamDelay;__dxlog_file11$2="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/transport/memory-transport.ts",MEMORY_TRANSPORT_DELAY=1,createStreamDelay=e=>new readableBrowserExports.Transform({objectMode:!0,transform:(t,r,n)=>{setTimeout(()=>n(null,t),e)}}),MemoryTransportFactory={createTransport:e=>new MemoryTransport(e)},MemoryTransport=(Yr=class{constructor(t){this._options=t,this._instanceId=PublicKey.random(),this._remote=new Trigger,this._outgoingDelay=createStreamDelay(MEMORY_TRANSPORT_DELAY),this._incomingDelay=createStreamDelay(MEMORY_TRANSPORT_DELAY),this._closed=!1,this.closed=new Event$1,this.connected=new Event$1,this.errors=new ErrorStream,invariant$1(!Yr._connections.has(this._instanceId),"Duplicate memory connection",{F:__dxlog_file11$2,L:64,S:this,A:["!MemoryTransport._connections.has(this._instanceId)","'Duplicate memory connection'"]}),Yr._connections.set(this._instanceId,this)}get isOpen(){return!this._closed}async open(){if(log("opening...",void 0,{F:__dxlog_file11$2,L:74,S:this,C:(t,r)=>t(...r)}),this._options.initiator){log("sending signal",void 0,{F:__dxlog_file11$2,L:78,S:this,C:(t,r)=>t(...r)});try{await this._options.sendSignal({payload:{transportId:this._instanceId.toHex()}})}catch(t){this._closed||this.errors.raise(toError(t))}}else this._remote.wait({timeout:this._options.timeout??1e3}).then(t=>{if(!this._closed){if(this._remoteInstanceId=t,this._remoteConnection=Yr._connections.get(this._remoteInstanceId),!this._remoteConnection){this._closed=!0,this.closed.emit();return}invariant$1(!this._remoteConnection._remoteConnection,`Remote already connected: ${this._remoteInstanceId}`,{F:__dxlog_file11$2,L:104,S:this,A:["!this._remoteConnection._remoteConnection","`Remote already connected: ${this._remoteInstanceId}`"]}),this._remoteConnection._remoteConnection=this,this._remoteConnection._remoteInstanceId=this._instanceId,log("connected",void 0,{F:__dxlog_file11$2,L:108,S:this,C:(r,n)=>r(...n)}),this._options.stream.pipe(this._outgoingDelay).pipe(this._remoteConnection._options.stream).pipe(this._incomingDelay).pipe(this._options.stream),this.connected.emit(),this._remoteConnection.connected.emit()}}).catch(t=>{this._closed||this.errors.raise(t)})}async close(){log("closing...",void 0,{F:__dxlog_file11$2,L:129,S:this,C:(t,r)=>t(...r)}),this._closed=!0,Yr._connections.delete(this._instanceId),this._remoteConnection&&(this._remoteConnection._closed=!0,Yr._connections.delete(this._remoteInstanceId),this._options.stream.unpipe(this._incomingDelay),this._incomingDelay.unpipe(this._remoteConnection._options.stream),this._remoteConnection._options.stream.unpipe(this._outgoingDelay),this._outgoingDelay.unpipe(this._options.stream),this._options.stream.unpipe(this._outgoingDelay),this._remoteConnection.closed.emit(),this._remoteConnection._remoteConnection=void 0,this._remoteConnection=void 0),this.closed.emit(),log("closed",void 0,{F:__dxlog_file11$2,L:157,S:this,C:(t,r)=>t(...r)})}async onSignal({payload:t}){if(log("received signal",{payload:t},{F:__dxlog_file11$2,L:161,S:this,C:(n,o)=>n(...o)}),!(t!=null&&t.transportId))return;const r=t.transportId;if(r){const n=PublicKey.fromHex(r);this._remote.wake(n)}}async getDetails(){return this._instanceId.toHex()}async getStats(){return{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0}}},Yr._connections=new ComplexMap(PublicKey.hash),Yr),_ts_decorate5$2([logInfo],MemoryTransport.prototype,"_instanceId",void 0),_ts_decorate5$2([logInfo],MemoryTransport.prototype,"_remoteInstanceId",void 0);let toError;toError=e=>e instanceof Error?e:new Error(String(e)),function(e){e.SIMPLE_PEER="SIMPLE_PEER",e.SIMPLE_PEER_PROXY="SIMPLE_PEER_PROXY",e.LIBDATACHANNEL="LIBDATACHANNEL",e.MEMORY="MEMORY",e.TCP="TCP"}(TransportKind||(TransportKind={}));var wrtc=null;try{wrtc=__require("@koush/wrtc")}catch{}let __dxlog_file12$2,__dxlog_file13$2;__dxlog_file12$2="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/transport/simplepeer-transport.ts",createSimplePeerTransportFactory=e=>({createTransport:t=>new SimplePeerTransport({...t,webrtcConfig:e})}),SimplePeerTransport=class{get isOpen(){return this._piped&&!this._closed}constructor(e){this._params=e,this._closed=!1,this._piped=!1,this.closed=new Event$1,this.connected=new Event$1,this.errors=new ErrorStream,this._instanceId=PublicKey.random().toHex(),log.trace("dxos.mesh.webrtc-transport.constructor",trace$1.begin({id:this._instanceId}),{F:__dxlog_file12$2,L:50,S:this,C:(t,r)=>t(...r)}),log("created connection",e,{F:__dxlog_file12$2,L:51,S:this,C:(t,r)=>t(...r)}),this._peer=new SimplePeerConstructor({channelName:"dxos.mesh.transport",initiator:this._params.initiator,wrtc:SimplePeerConstructor.WEBRTC_SUPPORT?void 0:wrtc??raise$1(new Error("wrtc not available")),config:this._params.webrtcConfig}),this._peer.on("signal",async t=>{log("signal",t,{F:__dxlog_file12$2,L:60,S:this,C:(r,n)=>r(...n)}),await this._params.sendSignal({payload:{data:t}})}),this._peer.on("connect",()=>{log("connected",void 0,{F:__dxlog_file12$2,L:65,S:this,C:(t,r)=>t(...r)}),this._params.stream.pipe(this._peer).pipe(this._params.stream),this._piped=!0,this.connected.emit()}),this._peer.on("close",async()=>{log("closed",void 0,{F:__dxlog_file12$2,L:72,S:this,C:(t,r)=>t(...r)}),await this.close()}),this._peer.on("error",async t=>{var r,n;if(typeof RTCError<"u"&&t instanceof RTCError)t.errorDetail==="sctp-failure"?this.errors.raise(new ConnectionResetError("sctp-failure from RTCError",t)):(log.info("unknown RTCError",{err:t},{F:__dxlog_file12$2,L:83,S:this,C:(o,s)=>o(...s)}),this.errors.raise(new UnknownProtocolError("unknown RTCError",t)));else if("code"in t)switch(log.info("simple-peer error",t,{F:__dxlog_file12$2,L:88,S:this,C:(o,s)=>o(...s)}),t.code){case"ERR_WEBRTC_SUPPORT":this.errors.raise(new ProtocolError("WebRTC not supported",t));break;case"ERR_SIGNALING":this.errors.raise(new ConnectivityError("signaling failure",t));break;case"ERR_ICE_CONNECTION_FAILURE":case"ERR_DATA_CHANNEL":case"ERR_CONNECTION_FAILURE":this.errors.raise(new ConnectivityError("unknown communication failure",t));break;case"ERR_CREATE_OFFER":case"ERR_CREATE_ANSWER":case"ERR_SET_LOCAL_DESCRIPTION":case"ERR_SET_REMOTE_DESCRIPTION":case"ERR_ADD_ICE_CANDIDATE":this.errors.raise(new UnknownProtocolError("unknown simple-peer library failure",t));break;default:this.errors.raise(new Error("unknown simple-peer error"));break}else log.info("unknown peer connection error",t,{F:__dxlog_file12$2,L:114,S:this,C:(o,s)=>o(...s)}),this.errors.raise(t);try{typeof((n=(r=this._peer)==null?void 0:r._pc)==null?void 0:n.getStats)=="function"&&this._peer._pc.getStats().then(o=>{log.info("report after webrtc error",{config:this._params.webrtcConfig,stats:Object.fromEntries(o.entries())},{F:__dxlog_file12$2,L:122,S:this,C:(s,a)=>s(...a)})})}catch(o){log.catch(o,void 0,{F:__dxlog_file12$2,L:129,S:this,C:(s,a)=>s(...a)})}await this.close()}),log.trace("dxos.mesh.webrtc-transport.constructor",trace$1.end({id:this._instanceId}),{F:__dxlog_file12$2,L:135,S:this,C:(t,r)=>t(...r)})}async getStats(){const e=await this._getStats();return e?{bytesSent:e.transport.bytesSent,bytesReceived:e.transport.bytesReceived,packetsSent:e.transport.packetsSent,packetsReceived:e.transport.packetsReceived,rawStats:e.raw}:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0,rawStats:{}}}async _getStats(){var e,t;return typeof((t=(e=this._peer)==null?void 0:e._pc)==null?void 0:t.getStats)!="function"?null:await this._peer._pc.getStats().then(r=>{const n=Array.from(r.entries()),o=n.filter(l=>l[1].type==="transport")[0][1],s=n.filter(l=>l[0]===o.selectedCandidatePairId);let a,c;return s.length>0&&(a=s[0][1],c=n.filter(l=>l[0]===a.remoteCandidateId)[0][1]),{datachannel:n.filter(l=>l[1].type==="data-channel")[0][1],transport:o,selectedCandidatePair:a,remoteCandidate:c,raw:Object.fromEntries(r.entries())}})}async getDetails(){var t;const e=(t=await this._getStats())==null?void 0:t.remoteCandidate;return e?e.candidateType==="relay"?`${e.ip}:${e.port}/${e.protocol} relay for ${e.relatedAddress}:${e.relatedPort}`:`${e.ip}:${e.port}/${e.protocol} ${e.candidateType}`:"unavailable"}async open(){}async close(){log("closing...",void 0,{F:__dxlog_file12$2,L:200,S:this,C:(e,t)=>e(...t)}),!this._closed&&(this._disconnectStreams(),this._peer.destroy(),this._closed=!0,this.closed.emit(),log("closed",void 0,{F:__dxlog_file12$2,L:208,S:this,C:(e,t)=>e(...t)}))}async onSignal(e){this._closed||(invariant(e.payload.data),this._peer.signal(e.payload.data))}_disconnectStreams(){var e,t,r,n;this._piped&&((n=(r=(t=(e=this._params.stream).unpipe)==null?void 0:t.call(e,this._peer))==null?void 0:r.unpipe)==null||n.call(r,this._params.stream))}},__dxlog_file13$2="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/transport/simplepeer-transport-service.ts",SimplePeerTransportService=class{constructor(e){this._webrtcConfig=e,this.transports=new ComplexMap(PublicKey.hash)}open(e){return new Stream$2(({ready:t,next:r,close:n})=>{const o=new readableBrowserExports.Duplex({read:()=>{const c=[...a.writeCallbacks];a.writeCallbacks.length=0;for(const l of c)l()},write:function(c,l,h){r({data:{payload:c}}),h()}}),s=new SimplePeerTransport({initiator:e.initiator,stream:o,webrtcConfig:this._webrtcConfig,sendSignal:async c=>{r({signal:{payload:c}})}});s.open(),r({connection:{state:ConnectionState$1.CONNECTING}}),s.connected.on(()=>{r({connection:{state:ConnectionState$1.CONNECTED}})}),s.errors.handle(c=>{r({connection:{state:ConnectionState$1.CLOSED,error:c.toString()}}),n(c)}),s.closed.on(()=>{r({connection:{state:ConnectionState$1.CLOSED}}),n()});const a={transport:s,stream:o,writeCallbacks:[],state:"OPEN"};t(),this.transports.set(e.proxyId,a)})}async sendSignal({proxyId:e,signal:t}){invariant$1(this.transports.has(e),void 0,{F:__dxlog_file13$2,L:119,S:this,A:["this.transports.has(proxyId)",""]}),await this.transports.get(e).transport.onSignal(t)}async getDetails({proxyId:e}){return invariant$1(this.transports.has(e),void 0,{F:__dxlog_file13$2,L:124,S:this,A:["this.transports.has(proxyId)",""]}),{details:await this.transports.get(e).transport.getDetails()}}async getStats({proxyId:e}){return invariant$1(this.transports.has(e),void 0,{F:__dxlog_file13$2,L:129,S:this,A:["this.transports.has(proxyId)",""]}),{stats:await this.transports.get(e).transport.getStats()}}async sendData({proxyId:e,payload:t}){var n;((n=this.transports.get(e))==null?void 0:n.state)!=="OPEN"&&log.debug("transport is closed",void 0,{F:__dxlog_file13$2,L:135,S:this,C:(o,s)=>o(...s)}),invariant$1(this.transports.has(e),void 0,{F:__dxlog_file13$2,L:137,S:this,A:["this.transports.has(proxyId)",""]});const r=this.transports.get(e);r.stream.push(t)||await new Promise(o=>{r.writeCallbacks.push(o)})}async close({proxyId:e}){var t,r;await((t=this.transports.get(e))==null?void 0:t.transport.close()),await((r=this.transports.get(e))==null?void 0:r.stream.end()),this.transports.get(e)&&(this.transports.get(e).state="CLOSED"),log("Closed.",void 0,{F:__dxlog_file13$2,L:153,S:this,C:(n,o)=>n(...o)})}};function _ts_decorate6$2(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file15$2,DATACHANNEL_LABEL,MAX_BUFFERED_AMOUNT,MAX_MESSAGE_SIZE;__dxlog_file15$2="/home/runner/work/dxos/dxos/packages/core/mesh/network-manager/src/transport/libdatachannel-transport.ts",DATACHANNEL_LABEL="dxos.mesh.transport",MAX_BUFFERED_AMOUNT=65536,MAX_MESSAGE_SIZE=65536,createLibDataChannelTransportFactory=e=>({createTransport:t=>new LibDataChannelTransport({...t,webrtcConfig:e})}),LibDataChannelTransport=(An=class{constructor(t){this._options=t,this._closed=!1,this._connected=!1,this._writeCallback=null,this._readyForCandidates=new Trigger,this.closed=new Event$1,this.connected=new Event$1,this.errors=new ErrorStream}get isOpen(){return!!this._peer&&!this._closed}async open(){this._closed&&this.errors.raise(new Error("connection already closed"));const{RTCPeerConnection:t}=(await importESM("node-datachannel/polyfill")).default;this._options.webrtcConfig?this._options.webrtcConfig.iceServers=this._options.webrtcConfig.iceServers??[]:this._options.webrtcConfig={iceServers:[]},this._peer=new t(this._options.webrtcConfig),this._peer.onicecandidateerror=r=>{log.error("peer.onicecandidateerror",{event:r},{F:__dxlog_file15$2,L:77,S:this,C:(n,o)=>n(...o)})},this._peer.onconnectionstatechange=r=>{var n;log.debug("peer.onconnectionstatechange",{event:r,peerConnectionState:(n=this._peer)==null?void 0:n.connectionState,transportConnectionState:this._connected},{F:__dxlog_file15$2,L:81,S:this,C:(o,s)=>o(...s)})},this._peer.onicecandidate=async r=>{if(log.debug("peer.onicecandidate",{event:r},{F:__dxlog_file15$2,L:91,S:this,C:(n,o)=>n(...o)}),r.candidate)try{await this._options.sendSignal({payload:{data:{type:"candidate",candidate:{candidate:r.candidate.candidate,sdpMLineIndex:r.candidate.sdpMLineIndex??0,sdpMid:r.candidate.sdpMid??0}}}})}catch(n){log.info("signaling error",{err:n},{F:__dxlog_file15$2,L:108,S:this,C:(o,s)=>o(...s)})}},this._options.initiator?(invariant$1(this._peer,"not open",{F:__dxlog_file15$2,L:114,S:this,A:["this._peer","'not open'"]}),this._peer.createOffer().then(async r=>{var n;this._closed||(((n=this._peer)==null?void 0:n.connectionState)!=="connecting"&&(log.error("peer not connecting",{peer:this._peer},{F:__dxlog_file15$2,L:125,S:this,C:(o,s)=>o(...s)}),this.errors.raise(new Error("invalid state: peer is initiator, but other peer not in state connecting"))),log.debug("creating offer",{peer:this._peer,offer:r},{F:__dxlog_file15$2,L:129,S:this,C:(o,s)=>o(...s)}),await this._peer.setLocalDescription(r),await this._options.sendSignal({payload:{data:{type:r.type,sdp:r.sdp}}}))}).catch(r=>{this.errors.raise(r)}),this._handleChannel(this._peer.createDataChannel(DATACHANNEL_LABEL)),log.debug("created data channel",void 0,{F:__dxlog_file15$2,L:139,S:this,C:(r,n)=>r(...n)}),this._peer.ondatachannel=()=>{this.errors.raise(new Error("unexpected ondatachannel event for initiator"))}):this._peer.ondatachannel=r=>{log.debug("peer.ondatachannel (non-initiator)",{event:r},{F:__dxlog_file15$2,L:145,S:this,C:(n,o)=>n(...o)}),r.channel.label!==DATACHANNEL_LABEL&&this.errors.raise(new Error(`unexpected channel label ${r.channel.label}`)),this._handleChannel(r.channel)},An._instanceCount++}async close(){await this._close(),--An._instanceCount===0&&(await importESM("node-datachannel")).cleanup()}async _close(){var t;if(!this._closed){await this._disconnectStreams();try{(t=this._peer)==null||t.close()}catch(r){this.errors.raise(r)}this._peer=void 0,this._closed=!0,this.closed.emit()}}_handleChannel(t){this._channel=t,this._channel.onopen=()=>{log.debug("channel.onopen",void 0,{F:__dxlog_file15$2,L:190,S:this,C:(n,o)=>n(...o)});const r=new stream.Duplex({read:()=>{},write:async(n,o,s)=>{n.length>MAX_MESSAGE_SIZE&&this.errors.raise(new Error(`message too large: ${n.length} > ${MAX_MESSAGE_SIZE}`));try{t.send(n)}catch(a){this.errors.raise(a),await this._close()}this._channel.bufferedAmount>MAX_BUFFERED_AMOUNT?(this._writeCallback!==null&&log.error("consumer trying to write before we are ready for more data",void 0,{F:__dxlog_file15$2,L:207,S:this,C:(a,c)=>a(...c)}),this._writeCallback=s):s()}});r.pipe(this._options.stream).pipe(r),this._stream=r,this._connected=!0,this.connected.emit()},this._channel.onclose=async r=>{log.info("channel.onclose",{err:r},{F:__dxlog_file15$2,L:223,S:this,C:(n,o)=>n(...o)}),await this._close()},this._channel.onerror=async r=>{this.errors.raise(new Error("channel error: "+r.toString())),await this._close()},this._channel.onbufferedamountlow=()=>{const r=this._writeCallback;this._writeCallback=null,r==null||r()},this._channel.onmessage=r=>{let n=r.data;n instanceof ArrayBuffer&&(n=export_Buffer.from(n)),this._stream.push(n)}}async onSignal(t){invariant$1(this._peer,"not open",{F:__dxlog_file15$2,L:249,S:this,A:["this._peer","'not open'"]});try{const r=t.payload.data;switch(r.type){case"offer":{if(this._peer.connectionState!=="new"){log.error("received offer but peer not in state new",{peer:this._peer},{F:__dxlog_file15$2,L:256,S:this,C:(n,o)=>n(...o)}),this.errors.raise(new Error("invalid signalling state: received offer when peer is not in state new"));break}try{await this._peer.setRemoteDescription({type:r.type,sdp:r.sdp});const n=await this._peer.createAnswer();await this._peer.setLocalDescription(n),await this._options.sendSignal({payload:{data:{type:n.type,sdp:n.sdp}}}),this._readyForCandidates.wake()}catch(n){log.error("cannot handle offer from signalling server",{err:n},{F:__dxlog_file15$2,L:268,S:this,C:(o,s)=>o(...s)}),this.errors.raise(new Error("error handling offer"))}break}case"answer":try{await this._peer.setRemoteDescription({type:r.type,sdp:r.sdp}),this._readyForCandidates.wake()}catch(n){log.error("cannot handle answer from signalling server",{err:n},{F:__dxlog_file15$2,L:279,S:this,C:(o,s)=>o(...s)}),this.errors.raise(new Error("error handling answer"))}break;case"candidate":await this._readyForCandidates.wait(),await this._peer.addIceCandidate({candidate:r.candidate.candidate});break;default:log.error("unhandled signal type",{type:r.type,signal:t},{F:__dxlog_file15$2,L:290,S:this,C:(n,o)=>n(...o)}),this.errors.raise(new Error(`unhandled signal type ${r.type}`))}}catch(r){log.catch(r,void 0,{F:__dxlog_file15$2,L:294,S:this,C:(n,o)=>n(...o)})}}async getDetails(){var r;const t=(r=await this._getStats())==null?void 0:r.remoteCandidate;return t?t.candidateType==="relay"?`${t.ip}:${t.port} relay for ${t.relatedAddress}:${t.relatedPort}`:`${t.ip}:${t.port} ${t.candidateType}`:"unavailable"}async getStats(){const t=await this._getStats();return t?{bytesSent:t.transport.bytesSent,bytesReceived:t.transport.bytesReceived,packetsSent:0,packetsReceived:0,rawStats:t.raw}:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0,rawStats:{}}}async _getStats(){invariant$1(this._peer,"not open",{F:__dxlog_file15$2,L:334,S:this,A:["this._peer","'not open'"]});const t=await this._peer.getStats(),r=Array.from(t.entries()),n=r.filter(c=>c[1].type==="transport")[0][1],o=r.filter(c=>c[0]===n.selectedCandidatePairId);let s,a;return o.length>0&&(s=o[0][1],a=r.filter(c=>c[0]===s.remoteCandidateId)[0][1]),{transport:n,selectedCandidatePair:s,remoteCandidate:a,raw:Object.fromEntries(t)}}async _disconnectStreams(){var t,r,n,o;(o=(n=(r=(t=this._options.stream).unpipe)==null?void 0:r.call(t,this._stream))==null?void 0:n.unpipe)==null||o.call(n,this._options.stream)}},An._instanceCount=0,An),_ts_decorate6$2([synchronized],LibDataChannelTransport.prototype,"_close",null);let importESM,Options;importESM=Function("path","return import(path)"),createTeleportProtocolFactory=(e,t)=>r=>{const n=new Teleport({...t,...r});return{stream:n.stream,open:async o=>{await n.open(o),await e(n)},close:async()=>{await n.close()},abort:async()=>{await n.abort()}}},function(e){(function(t){t[t.GUEST=0]="GUEST",t[t.HOST=1]="HOST"})(e.Role||(e.Role={}))}(Options||(Options={}));var AuthenticationResponse;(function(e){(function(t){t[t.OK=0]="OK",t[t.INVALID_OTP=1]="INVALID_OTP",t[t.INVALID_OPT_ATTEMPTS=2]="INVALID_OPT_ATTEMPTS",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t[t.INVALID_SIGNATURE=4]="INVALID_SIGNATURE"})(e.Status||(e.Status={}))})(AuthenticationResponse||(AuthenticationResponse={}));var BlobMeta;(function(e){(function(t){t[t.PARTIALLY_PRESENT=0]="PARTIALLY_PRESENT",t[t.FULLY_PRESENT=1]="FULLY_PRESENT"})(e.State||(e.State={}))})(BlobMeta||(BlobMeta={}));var crc32={};(function(e){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?e:{})})(function(t){t.version="1.2.2";function r(){for(var H=0,te=new Array(256),J=0;J!=256;++J)H=J,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,H=H&1?-306674912^H>>>1:H>>>1,te[J]=H;return typeof Int32Array<"u"?new Int32Array(te):te}var n=r();function o(H){var te=0,J=0,le=0,z=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(le=0;le!=256;++le)z[le]=H[le];for(le=0;le!=256;++le)for(J=H[le],te=256+le;te<4096;te+=256)J=z[te]=J>>>8^H[J&255];var q=[];for(le=1;le!=16;++le)q[le-1]=typeof Int32Array<"u"?z.subarray(le*256,le*256+256):z.slice(le*256,le*256+256);return q}var s=o(n),a=s[0],c=s[1],l=s[2],h=s[3],u=s[4],d=s[5],f=s[6],_=s[7],p=s[8],y=s[9],w=s[10],E=s[11],x=s[12],B=s[13],P=s[14];function U(H,te){for(var J=te^-1,le=0,z=H.length;le<z;)J=J>>>8^n[(J^H.charCodeAt(le++))&255];return~J}function F(H,te){for(var J=te^-1,le=H.length-15,z=0;z<le;)J=P[H[z++]^J&255]^B[H[z++]^J>>8&255]^x[H[z++]^J>>16&255]^E[H[z++]^J>>>24]^w[H[z++]]^y[H[z++]]^p[H[z++]]^_[H[z++]]^f[H[z++]]^d[H[z++]]^u[H[z++]]^h[H[z++]]^l[H[z++]]^c[H[z++]]^a[H[z++]]^n[H[z++]];for(le+=15;z<le;)J=J>>>8^n[(J^H[z++])&255];return~J}function G(H,te){for(var J=te^-1,le=0,z=H.length,q=0,he=0;le<z;)q=H.charCodeAt(le++),q<128?J=J>>>8^n[(J^q)&255]:q<2048?(J=J>>>8^n[(J^(192|q>>6&31))&255],J=J>>>8^n[(J^(128|q&63))&255]):q>=55296&&q<57344?(q=(q&1023)+64,he=H.charCodeAt(le++)&1023,J=J>>>8^n[(J^(240|q>>8&7))&255],J=J>>>8^n[(J^(128|q>>2&63))&255],J=J>>>8^n[(J^(128|he>>6&15|(q&3)<<4))&255],J=J>>>8^n[(J^(128|he&63))&255]):(J=J>>>8^n[(J^(224|q>>12&15))&255],J=J>>>8^n[(J^(128|q>>6&63))&255],J=J>>>8^n[(J^(128|q&63))&255]);return~J}t.table=n,t.bstr=U,t.buf=F,t.str=G})})(crc32);const CRC32=getDefaultExportFromCjs(crc32);function _ts_decorate$c(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$e="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-object-sync/src/blob-sync-extension.ts",MIN_WANT_LIST_UPDATE_INTERVAL=500,MAX_CONCURRENT_UPLOADS=20,BlobSyncExtension=class extends RpcExtension{constructor(e){super({exposed:{BlobSyncService:schema.getService("dxos.mesh.teleport.blobsync.BlobSyncService")},requested:{BlobSyncService:schema.getService("dxos.mesh.teleport.blobsync.BlobSyncService")},timeout:2e4,encodingOptions:{preserveAny:!0}}),this._params=e,this._ctx=new Context({onError:t=>log.catch(t,void 0,{F:__dxlog_file$e,L:34,S:this,C:(r,n)=>r(...n)})}),this._lastWantListUpdate=0,this._localWantList={blobs:[]},this._updateWantList=new DeferredTask(this._ctx,async()=>{this._lastWantListUpdate+MIN_WANT_LIST_UPDATE_INTERVAL>Date.now()&&(await sleep(this._lastWantListUpdate+MIN_WANT_LIST_UPDATE_INTERVAL-Date.now()),this._ctx.disposed)||(log("want",{list:this._localWantList},{F:__dxlog_file$e,L:48,S:this,C:(t,r)=>t(...r)}),await this.rpc.BlobSyncService.want(this._localWantList),this._lastWantListUpdate=Date.now())}),this._currentUploads=0,this._upload=new DeferredTask(this._ctx,async()=>{if(this._currentUploads>=MAX_CONCURRENT_UPLOADS)return;const t=await this._pickBlobChunks(MAX_CONCURRENT_UPLOADS-this._currentUploads);if(t)for(const r of t){if(this._ctx.disposed)break;this._currentUploads++,this.push(r).catch(n=>{n instanceof RpcClosedError||log.warn("push failed",{err:n},{F:__dxlog_file$e,L:75,S:this,C:(o,s)=>o(...s)})}).finally(()=>{this._currentUploads--,this.reconcileUploads()})}}),this.remoteWantList={blobs:[]}}async onOpen(e){log("open",void 0,{F:__dxlog_file$e,L:107,S:this,C:(t,r)=>t(...r)}),await super.onOpen(e),await this._params.onOpen()}async onClose(e){log("close",void 0,{F:__dxlog_file$e,L:113,S:this,C:(t,r)=>t(...r)}),await this._ctx.dispose(),await this._params.onClose(),await super.onClose(e)}async onAbort(e){log("abort",void 0,{F:__dxlog_file$e,L:120,S:this,C:(t,r)=>t(...r)}),await this._ctx.dispose(),await this._params.onAbort(),await super.onAbort(e)}async getHandlers(){return{BlobSyncService:{want:async e=>{log("remote want",{remoteWantList:e},{F:__dxlog_file$e,L:130,S:this,C:(t,r)=>t(...r)}),this.remoteWantList=e,this.reconcileUploads()},push:async e=>{log("received",{data:e},{F:__dxlog_file$e,L:135,S:this,C:(t,r)=>t(...r)}),await this._params.onPush(e)}}}}async push(e){this._ctx.disposed||(log("push",{data:e},{F:__dxlog_file$e,L:147,S:this,C:(t,r)=>t(...r)}),await this.rpc.BlobSyncService.push(e))}updateWantList(e){this._ctx.disposed||(this._localWantList=e,this._updateWantList.schedule())}reconcileUploads(){this._ctx.disposed||this._upload.schedule()}async _pickBlobChunks(e=1){var n;if(this._ctx.disposed||!this.remoteWantList.blobs||((n=this.remoteWantList.blobs)==null?void 0:n.length)===0)return;const t=[...this.remoteWantList.blobs].sort(()=>Math.random()-.5),r=[];for(const o of t){const s=await this._params.blobStore.getMeta(o.id);if(!s)continue;if(invariant$1(s.bitfield,void 0,{F:__dxlog_file$e,L:186,S:this,A:["meta.bitfield",""]}),invariant$1(s.chunkSize,void 0,{F:__dxlog_file$e,L:187,S:this,A:["meta.chunkSize",""]}),invariant$1(s.length,void 0,{F:__dxlog_file$e,L:188,S:this,A:["meta.length",""]}),o.chunkSize&&o.chunkSize!==s.chunkSize){log.warn("Invalid chunk size",{header:o,meta:s},{F:__dxlog_file$e,L:191,S:this,C:(h,u)=>h(...u)});continue}const a=o.bitfield??BitField.ones(s.length/s.chunkSize),c=BitField.and(a,s.bitfield),l=BitField.findIndexes(c).sort(()=>Math.random()-.5);for(const h of l){const u=await this._params.blobStore.get(o.id,{offset:h*s.chunkSize,length:Math.min(s.chunkSize,s.length-h*s.chunkSize)});if(r.push({id:o.id,totalLength:s.length,chunkSize:s.chunkSize,chunkOffset:h*s.chunkSize,payload:u}),r.length>=e)return r}}return r}};_ts_decorate$c([synchronized],BlobSyncExtension.prototype,"push",null);function _ts_decorate2$6(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file2$7="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-object-sync/src/blob-sync.ts",BlobSync=class{constructor(e){this._params=e,this._ctx=new Context,this._mutex=new Mutex,this._downloadRequests=new ComplexMap(t=>PublicKey.from(t).toHex()),this._extensions=new Set}async open(){}async close(){await this._ctx.dispose()}async download(e,t){log("download",{id:t},{F:__dxlog_file2$7,L:53,S:this,C:(n,o)=>n(...o)});const r=await this._mutex.executeSynchronized(async()=>{const n=this._downloadRequests.get(t);if(n)return n.counter++,n;const o=await this._params.blobStore.getMeta(t),s={trigger:new Trigger,counter:1,want:{id:t,chunkSize:o==null?void 0:o.chunkSize,bitfield:(o==null?void 0:o.bitfield)&&Uint8Array.from(BitField.invert(o.bitfield))}};return(o==null?void 0:o.state)===BlobMeta.State.FULLY_PRESENT?s.trigger.wake():(this._downloadRequests.set(t,s),this._updateExtensionsWantList()),s});return e==null||e.onDispose(()=>this._mutex.executeSynchronized(async()=>{const n=this._downloadRequests.get(t);n&&(--n.counter===0&&this._downloadRequests.delete(t),this._updateExtensionsWantList())})),e?cancelWithContext(e,r.trigger.wait()):r.trigger.wait()}createExtension(){const e=new BlobSyncExtension({blobStore:this._params.blobStore,onOpen:async()=>{log("extension opened",void 0,{F:__dxlog_file2$7,L:105,S:this,C:(t,r)=>t(...r)}),this._extensions.add(e),e.updateWantList(this._getWantList())},onClose:async()=>{log("extension closed",void 0,{F:__dxlog_file2$7,L:110,S:this,C:(t,r)=>t(...r)}),this._extensions.delete(e)},onAbort:async()=>{log("extension aborted",void 0,{F:__dxlog_file2$7,L:114,S:this,C:(t,r)=>t(...r)}),this._extensions.delete(e)},onPush:async t=>{var n;if(!this._downloadRequests.has(t.id))return;log("received",{blobChunk:t},{F:__dxlog_file2$7,L:121,S:this,C:(o,s)=>o(...s)});const r=await this._params.blobStore.setChunk(t);r.state===BlobMeta.State.FULLY_PRESENT?((n=this._downloadRequests.get(t.id))==null||n.trigger.wake(),this._downloadRequests.delete(t.id)):(invariant$1(r.bitfield,void 0,{F:__dxlog_file2$7,L:127,S:this,A:["meta.bitfield",""]}),this._downloadRequests.get(t.id).want.bitfield=BitField.invert(r.bitfield)),this._updateExtensionsWantList(),this._reconcileUploads()}});return e}async notifyBlobAdded(e){this._reconcileUploads()}_getWantList(){return{blobs:Array.from(this._downloadRequests.values()).map(e=>e.want)}}_reconcileUploads(){for(const e of this._extensions)e.reconcileUploads()}_updateExtensionsWantList(){for(const e of this._extensions)e.updateWantList(this._getWantList())}};BlobSync=_ts_decorate2$6([trackLeaks("open","close")],BlobSync);function _ts_decorate3$5(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file3$6="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-object-sync/src/blob-store.ts",DEFAULT_CHUNK_SIZE=4096,BlobMetaCodec=schema.getCodecForType("dxos.echo.blob.BlobMeta"),BlobStore=class{constructor(e){this._directory=e}async getMeta(e){return this._getMeta(e)}async get(e,t={}){const r=await this._getMeta(e);if(!r)throw new Error("Blob not available");const{offset:n=0,length:o=r.length}=t;if(n+o>r.length)throw new Error("Invalid range");if(r.state===BlobMeta.State.FULLY_PRESENT)return this._getDataFile(e).read(n,o);if(t.offset===void 0&&t.length===void 0)throw new Error("Blob not available");const s=Math.floor(n/r.chunkSize),a=Math.ceil((n+o)/r.chunkSize);if(invariant$1(r.bitfield,"Bitfield not present",{F:__dxlog_file3$6,L:61,S:this,A:["metadata.bitfield","'Bitfield not present'"]}),invariant$1(r.bitfield.length*8>=a,"Invalid bitfield length",{F:__dxlog_file3$6,L:62,S:this,A:["metadata.bitfield.length * 8 >= endChunk","'Invalid bitfield length'"]}),BitField.count(r.bitfield,s,a)!==a-s)throw new Error("Blob not available");return this._getDataFile(e).read(n,o)}async list(){const e=new Set((await this._directory.list()).map(r=>r.split("_")[0])),t=[];for(const r of e){const n=PublicKey.from(r).asUint8Array(),o=await this._getMeta(n);o&&t.push(o)}return t}async set(e){const t=new Uint8Array(await subtleCrypto.digest("SHA-256",e)),r=BitField.ones(e.length/DEFAULT_CHUNK_SIZE),n={id:t,state:BlobMeta.State.FULLY_PRESENT,length:e.length,chunkSize:DEFAULT_CHUNK_SIZE,bitfield:r,created:new Date,updated:new Date};return await this._getDataFile(t).write(0,arrayToBuffer(e)),await this._writeMeta(t,n),n}async setChunk(e){let t=await this._getMeta(e.id);if(t||(invariant$1(e.totalLength,"totalLength is not present",{F:__dxlog_file3$6,L:124,S:this,A:["chunk.totalLength","'totalLength is not present'"]}),t={id:e.id,state:BlobMeta.State.PARTIALLY_PRESENT,length:e.totalLength,chunkSize:e.chunkSize??DEFAULT_CHUNK_SIZE,created:new Date},t.bitfield=BitField.zeros(t.length/t.chunkSize)),e.chunkSize&&e.chunkSize!==t.chunkSize)throw new Error("Invalid chunk size");return invariant$1(t.bitfield,"Bitfield not present",{F:__dxlog_file3$6,L:139,S:this,A:["meta.bitfield","'Bitfield not present'"]}),invariant$1(e.chunkOffset!==void 0,"chunkOffset is not present",{F:__dxlog_file3$6,L:140,S:this,A:["chunk.chunkOffset !== undefined","'chunkOffset is not present'"]}),await this._getDataFile(e.id).write(e.chunkOffset,arrayToBuffer(e.payload)),BitField.set(t.bitfield,Math.floor(e.chunkOffset/t.chunkSize),!0),BitField.count(t.bitfield,0,t.length)*t.chunkSize>=t.length&&(t.state=BlobMeta.State.FULLY_PRESENT),t.updated=new Date,await this._writeMeta(e.id,t),t}async _writeMeta(e,t){const r=arrayToBuffer(BlobMetaCodec.encode(t)),n=export_Buffer.alloc(r.length+4);n.writeUInt32LE(r.length,0),r.copy(n,4),await this._getMetaFile(e).write(0,n)}async _getMeta(e){const t=this._getMetaFile(e),r=(await t.stat()).size;if(r===0)return;const n=await t.read(0,r),o=n.readUInt32LE(0);return BlobMetaCodec.decode(n.subarray(4,o+4))}_getMetaFile(e){return this._directory.getOrCreateFile(path_default.join(arrayToBuffer(e).toString("hex"),"meta"))}_getDataFile(e){return this._directory.getOrCreateFile(path_default.join(arrayToBuffer(e).toString("hex"),"data"))}};_ts_decorate3$5([synchronized],BlobStore.prototype,"getMeta",null),_ts_decorate3$5([synchronized],BlobStore.prototype,"get",null),_ts_decorate3$5([synchronized],BlobStore.prototype,"list",null),_ts_decorate3$5([synchronized],BlobStore.prototype,"set",null),_ts_decorate3$5([synchronized],BlobStore.prototype,"setChunk",null);function _ts_decorate$b(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$d="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-replicator/src/replicator-extension.ts",ReplicatorExtension=class{constructor(){this._ctx=new Context({onError:e=>{var t;(t=this._extensionContext)==null||t.close(e)}}),this._feeds=new ComplexMap(PublicKey.hash),this._streams=new ComplexMap(PublicKey.hash),this._options={upload:!1},this._updateTask=new DeferredTask(this._ctx,async()=>{try{this._extensionContext.initiator===!1?await this._rpc.rpc.ReplicatorService.updateFeeds({feeds:Array.from(this._feeds.values()).map(e=>({feedKey:e.key,download:!0,upload:this._options.upload}))}):this._extensionContext.initiator===!0&&await this._reevaluateFeeds()}catch(e){if(e instanceof RpcClosedError)return;throw e}})}get extensionInfo(){var e,t,r;return{initiator:(e=this._extensionContext)==null?void 0:e.initiator,localPeerId:(t=this._extensionContext)==null?void 0:t.localPeerId,remotePeerId:(r=this._extensionContext)==null?void 0:r.remotePeerId,feeds:Array.from(this._feeds.keys())}}setOptions(e){return this._options=e,log("setOptions",{options:e},{F:__dxlog_file$d,L:78,S:this,C:(t,r)=>t(...r)}),this._extensionContext&&this._updateTask.schedule(),this}addFeed(e){this._feeds.set(e.key,e),log("addFeed",{feedKey:e.key},{F:__dxlog_file$d,L:87,S:this,C:(t,r)=>t(...r)}),this._extensionContext&&this._updateTask.schedule()}async onOpen(e){this._extensionContext=e,log("open",void 0,{F:__dxlog_file$d,L:95,S:this,C:(t,r)=>t(...r)}),this._rpc=createProtoRpcPeer({requested:{ReplicatorService:schema.getService("dxos.mesh.teleport.replicator.ReplicatorService")},exposed:{ReplicatorService:schema.getService("dxos.mesh.teleport.replicator.ReplicatorService")},handlers:{ReplicatorService:{updateFeeds:async({feeds:t})=>{log("received feed info",{feeds:t},{F:__dxlog_file$d,L:107,S:this,C:(r,n)=>r(...n)}),invariant$1(this._extensionContext.initiator===!0,"Invalid call",{F:__dxlog_file$d,L:108,S:this,A:["this._extensionContext!.initiator === true","'Invalid call'"]}),this._updateTask.schedule()},startReplication:async({info:t})=>(log("starting replication...",{info:t},{F:__dxlog_file$d,L:112,S:this,C:(r,n)=>r(...n)}),invariant$1(this._extensionContext.initiator===!1,"Invalid call",{F:__dxlog_file$d,L:113,S:this,A:["this._extensionContext!.initiator === false","'Invalid call'"]}),{streamTag:await this._acceptReplication(t)}),stopReplication:async({info:t})=>{log("stopping replication...",{info:t},{F:__dxlog_file$d,L:121,S:this,C:(r,n)=>r(...n)}),invariant$1(this._extensionContext.initiator===!1,"Invalid call",{F:__dxlog_file$d,L:123,S:this,A:["this._extensionContext!.initiator === false","'Invalid call'"]}),await this._stopReplication(t.feedKey)}}},port:await e.createPort("rpc",{contentType:'application/x-protobuf; messageType="dxos.rpc.Message"'}),timeout:1e4}),await this._rpc.open(),this._updateTask.schedule()}async onClose(e){var t;log("close",{err:e},{F:__dxlog_file$d,L:140,S:this,C:(r,n)=>r(...n)}),await this._ctx.dispose(),await((t=this._rpc)==null?void 0:t.close());for(const r of this._streams.keys())await this._stopReplication(r)}async onAbort(e){var t;log("abort",{err:e},{F:__dxlog_file$d,L:149,S:this,C:(r,n)=>r(...n)}),await this._ctx.dispose(),await((t=this._rpc)==null?void 0:t.abort());for(const r of this._streams.keys())await this._stopReplication(r)}async _reevaluateFeeds(){var e;log("_reevaluateFeeds",void 0,{F:__dxlog_file$d,L:160,S:this,C:(t,r)=>t(...r)});for(const t of this._feeds.keys()){if(this._ctx.disposed)return;if(this._streams.has(t)&&this._options.upload!==((e=this._streams.get(t))==null?void 0:e.info.upload))try{await asyncTimeout(this._stopReplication(t),1e3)}catch(r){log.catch(r,void 0,{F:__dxlog_file$d,L:169,S:this,C:(n,o)=>n(...o)})}if(this._ctx.disposed)return;this._streams.has(t)||await this._initiateReplication({feedKey:t,download:!0,upload:this._options.upload})}}async _initiateReplication(e){log("initiating replication",{feedInfo:e},{F:__dxlog_file$d,L:190,S:this,C:(r,n)=>r(...n)}),invariant$1(this._extensionContext.initiator===!0,"Invalid call",{F:__dxlog_file$d,L:191,S:this,A:["this._extensionContext!.initiator === true","'Invalid call'"]}),invariant$1(!this._streams.has(e.feedKey),`Replication already in progress for feed: ${e.feedKey}`,{F:__dxlog_file$d,L:192,S:this,A:["!this._streams.has(feedInfo.feedKey)","`Replication already in progress for feed: ${feedInfo.feedKey}`"]});const{streamTag:t}=await this._rpc.rpc.ReplicatorService.startReplication({info:e});t&&await this._replicateFeed(e,t)}async _acceptReplication(e){if(invariant$1(this._extensionContext.initiator===!1,"Invalid call",{F:__dxlog_file$d,L:207,S:this,A:["this._extensionContext!.initiator === false","'Invalid call'"]}),!this._feeds.has(e.feedKey)||this._streams.has(e.feedKey))return;const t=`feed-${e.feedKey.toHex()}-${PublicKey.random().toHex().slice(0,8)}`;return await this._replicateFeed(e,t),t}async _replicateFeed(e,t){log("replicate",{info:e,streamTag:t},{F:__dxlog_file$d,L:219,S:this,C:(a,c)=>a(...c)}),invariant$1(!this._streams.has(e.feedKey),`Replication already in progress for feed: ${e.feedKey}`,{F:__dxlog_file$d,L:220,S:this,A:["!this._streams.has(info.feedKey)","`Replication already in progress for feed: ${info.feedKey}`"]});const r=this._feeds.get(e.feedKey)??failUndefined(),n=await this._extensionContext.createStream(t,{contentType:"application/x-hypercore"});let o=0;const s=r.replicate(!0,{live:!0,upload:e.upload,download:e.download,noise:!1,encrypted:!1,maxRequests:1024});s.on("error",a=>{if(a instanceof TimeoutError$1){log.info("replication stream timeout",{err:a,info:e},{F:__dxlog_file$d,L:256,S:this,C:(c,l)=>c(...l)});return}if((a==null?void 0:a.message)==="Writable stream closed prematurely"||(a==null?void 0:a.message)==="Cannot call write after a stream was destroyed"){log("replication stream closed",{err:a,info:e},{F:__dxlog_file$d,L:264,S:this,C:(c,l)=>c(...l)});return}o===0?log.info("replication stream error",{err:a,info:e},{F:__dxlog_file$d,L:270,S:this,C:(c,l)=>c(...l)}):log.info("replication stream error",{err:a,feedKey:e.feedKey,count:o},{F:__dxlog_file$d,L:272,S:this,C:(c,l)=>c(...l)}),o++}),this._streams.set(e.feedKey,{streamTag:t,networkStream:n,replicationStream:s,info:e}),n.pipe(s).pipe(n)}async _stopReplication(e){const t=this._streams.get(e);t&&(t.networkStream.destroy(),this._streams.delete(e))}};_ts_decorate$b([logInfo],ReplicatorExtension.prototype,"extensionInfo",null),_ts_decorate$b([synchronized],ReplicatorExtension.prototype,"_reevaluateFeeds",null),_ts_decorate$b([synchronized],ReplicatorExtension.prototype,"_acceptReplication",null);var codec=schema.getCodecForType("dxos.echo.feed.FeedMessage"),valueEncoding=createCodecEncoding(codec),__dxlog_file$c="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/common/feeds.ts",createMappedFeedWriter=(e,t)=>(invariant$1(e,void 0,{F:__dxlog_file$c,L:16,S:void 0,A:["mapper",""]}),invariant$1(t,void 0,{F:__dxlog_file$c,L:17,S:void 0,A:["writer",""]}),{write:async(r,n)=>await t.write(await e(r),n)}),SpaceSnapshot=schema.getCodecForType("dxos.echo.snapshot.SpaceSnapshot"),SnapshotManager=class{constructor(e,t,r){this._snapshotStore=e,this._blobStore=t,this._blobSync=r}async _getBlob(e){const t=await this._blobStore.get(e);return SpaceSnapshot.decode(t)}async load(e,t){const r=PublicKey.fromHex(t).asUint8Array(),n=await this._blobStore.getMeta(r);return n&&n.state===BlobMeta.State.FULLY_PRESENT?this._getBlob(r):await cancelWithContext(e,this._snapshotStore.loadSnapshot(t))||(await this._blobSync.download(e,r),this._getBlob(r))}async store(e){const{id:t}=await this._blobStore.set(SpaceSnapshot.encode(e));return await this._blobSync.notifyBlobAdded(t),PublicKey.from(t).toHex()}},SpaceSnapshot2=schema.getCodecForType("dxos.echo.snapshot.SpaceSnapshot"),SnapshotStore=class{constructor(e){this._directory=e}async saveSnapshot(e){const t=SpaceSnapshot2.encode(e),r=await subtleCrypto.digest("SHA-256",t),n=export_Buffer.from(r).toString("hex"),o=await this._directory.getOrCreateFile(n);try{await o.write(0,export_Buffer.from(t))}finally{await o.close()}return n}async loadSnapshot(e){const t=await this._directory.getOrCreateFile(e);try{const{size:r}=await t.stat();if(r===0)return;const n=await t.read(0,r);return SpaceSnapshot2.decode(n)}finally{await t.close()}}async listSnapshots(){const e=await this._directory.list();return await Promise.all(e.map(async t=>{const{size:r}=await this._directory.getOrCreateFile(t).stat();return{key:t,size:r}}))}},DataServiceImpl=class{constructor(e){this._automergeHost=e}subscribe(e){throw new Error("Deprecated.")}write(e){throw new Error("Deprecated.")}async flush(e){await this._automergeHost.flush(e)}async getHostInfo(e){return this._automergeHost.getHostInfo()}syncRepo(e){return this._automergeHost.syncRepo(e)}sendSyncMessage(e){return this._automergeHost.sendSyncMessage(e)}};function _ts_decorate$a(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file2$6="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/metadata/metadata-store.ts",EXPIRED_INVITATION_CLEANUP_INTERVAL=60*60*1e3,emptyEchoMetadata=()=>({version:STORAGE_VERSION,spaces:[],created:new Date,updated:new Date}),emptyLargeSpaceMetadata=()=>({}),EchoMetadata=schema.getCodecForType("dxos.echo.metadata.EchoMetadata"),LargeSpaceMetadata=schema.getCodecForType("dxos.echo.metadata.LargeSpaceMetadata"),MetadataStore=class{constructor(e){this._metadata=emptyEchoMetadata(),this._spaceLargeMetadata=new ComplexMap(PublicKey.hash),this._metadataFile=void 0,this.update=new Event$1,this._invitationCleanupCtx=new Context,this._directory=e}get metadata(){return this._metadata}get version(){return this._metadata.version??0}get spaces(){return this._metadata.spaces??[]}async _readFile(e,t){try{const{size:r}=await e.stat();if(r<8)return;const n=fromBytesInt32(await e.read(0,4)),o=fromBytesInt32(await e.read(4,4));if(log("loaded",{size:n,checksum:o,name:e.filename},{F:__dxlog_file2$6,L:89,S:this,C:(a,c)=>a(...c)}),r<n+8)throw new DataCorruptionError("Metadata size is smaller than expected.",{fileLength:r,dataSize:n});const s=await e.read(8,n);if(CRC32.buf(s)!==o)throw new DataCorruptionError("Metadata checksum is invalid.");return t.decode(s)}finally{await e.close()}}async _writeFile(e,t,r){const n=arrayToBuffer(t.encode(r)),o=CRC32.buf(n),s=export_Buffer.alloc(8+n.length);s.writeInt32LE(n.length,0),s.writeInt32LE(o,4),n.copy(s,8),await e.write(0,s),log("saved",{size:n.length,checksum:o},{F:__dxlog_file2$6,L:124,S:this,C:(a,c)=>a(...c)})}async close(){var e;await this._invitationCleanupCtx.dispose(),await this.flush(),await((e=this._metadataFile)==null?void 0:e.close()),this._metadataFile=void 0,this._metadata=emptyEchoMetadata(),this._spaceLargeMetadata.clear()}async load(){var e,t,r;(!this._metadataFile||this._metadataFile.closed)&&(this._metadataFile=this._directory.getOrCreateFile("EchoMetadata"));try{const n=await this._readFile(this._metadataFile,EchoMetadata);n&&(this._metadata=n),(e=this._metadata.spaces)==null||e.forEach(o=>{o.state??(o.state=SpaceState.ACTIVE)})}catch(n){log.error("failed to load metadata",{err:n},{F:__dxlog_file2$6,L:156,S:this,C:(o,s)=>o(...s)}),this._metadata=emptyEchoMetadata()}await forEachAsync([(t=this._metadata.identity)==null?void 0:t.haloSpace.key,...((r=this._metadata.spaces)==null?void 0:r.map(n=>n.key))??[]].filter(isNotNullOrUndefined),async n=>{try{await this._loadSpaceLargeMetadata(n)}catch(o){log.error("failed to load space large metadata",{err:o},{F:__dxlog_file2$6,L:168,S:this,C:(s,a)=>s(...a)})}}),scheduleTaskInterval(this._invitationCleanupCtx,async()=>{for(const n of this._metadata.invitations??[])(hasInvitationExpired(n)||isLegacyInvitationFormat(n))&&await this.removeInvitation(n.invitationId)},EXPIRED_INVITATION_CLEANUP_INTERVAL)}async _save(){const e={...this._metadata,version:STORAGE_VERSION,created:this._metadata.created??new Date,updated:new Date};this.update.emit(e);const t=this._directory.getOrCreateFile("EchoMetadata");await this._writeFile(t,EchoMetadata,e)}async _loadSpaceLargeMetadata(e){const t=this._directory.getOrCreateFile(`space_${e.toHex()}_large`);try{const r=await this._readFile(t,LargeSpaceMetadata);r&&this._spaceLargeMetadata.set(e,r)}catch(r){log.error("failed to load space large metadata",{err:r},{F:__dxlog_file2$6,L:210,S:this,C:(n,o)=>n(...o)})}}async _saveSpaceLargeMetadata(e){const t=this._getLargeSpaceMetadata(e),r=this._directory.getOrCreateFile(`space_${e.toHex()}_large`);await this._writeFile(r,LargeSpaceMetadata,t)}async flush(){await this._directory.flush()}_getSpace(e){var r;if((r=this._metadata.identity)!=null&&r.haloSpace.key.equals(e))return this._metadata.identity.haloSpace;const t=this.spaces.find(n=>n.key===e);return invariant$1(t,"Space not found",{F:__dxlog_file2$6,L:232,S:this,A:["space","'Space not found'"]}),t}_getLargeSpaceMetadata(e){let t=this._spaceLargeMetadata.get(e);return t||(t=emptyLargeSpaceMetadata(),this._spaceLargeMetadata.set(e,t),t)}async clear(){log("clearing all metadata",void 0,{F:__dxlog_file2$6,L:251,S:this,C:(e,t)=>e(...t)}),await this._directory.delete(),this._metadata=emptyEchoMetadata()}getIdentityRecord(){return this._metadata.identity}async setIdentityRecord(e){invariant$1(!this._metadata.identity,"Cannot overwrite existing identity in metadata",{F:__dxlog_file2$6,L:261,S:this,A:["!this._metadata.identity","'Cannot overwrite existing identity in metadata'"]}),this._metadata.identity=e,await this._save(),await this.flush()}getInvitations(){return this._metadata.invitations??[]}async addInvitation(e){var t,r;(t=this._metadata.invitations)!=null&&t.find(n=>n.invitationId===e.invitationId)||(((r=this._metadata).invitations??(r.invitations=[])).push(e),await this._save(),await this.flush())}async removeInvitation(e){this._metadata.invitations=(this._metadata.invitations??[]).filter(t=>t.invitationId!==e),await this._save(),await this.flush()}async addSpace(e){var t;invariant$1(!(this._metadata.spaces??[]).find(r=>r.key===e.key),"Cannot overwrite existing space in metadata",{F:__dxlog_file2$6,L:289,S:this,A:["!(this._metadata.spaces ?? []).find((space) => space.key === record.key)","'Cannot overwrite existing space in metadata'"]}),((t=this._metadata).spaces??(t.spaces=[])).push(e),await this._save(),await this.flush()}async setSpaceDataLatestTimeframe(e,t){this._getSpace(e).dataTimeframe=t,await this._save()}async setSpaceControlLatestTimeframe(e,t){this._getSpace(e).controlTimeframe=t,await this._save(),await this.flush()}async setCache(e,t){this._getSpace(e).cache=t,await this._save()}async setWritableFeedKeys(e,t,r){const n=this._getSpace(e);n.controlFeedKey=t,n.dataFeedKey=r,await this._save(),await this.flush()}async setSpaceState(e,t){this._getSpace(e).state=t,await this._save(),await this.flush()}getSpaceControlPipelineSnapshot(e){return this._getLargeSpaceMetadata(e).controlPipelineSnapshot}async setSpaceControlPipelineSnapshot(e,t){this._getLargeSpaceMetadata(e).controlPipelineSnapshot=t,await this._saveSpaceLargeMetadata(e),await this.flush()}};_ts_decorate$a([synchronized],MetadataStore.prototype,"load",null),_ts_decorate$a([synchronized],MetadataStore.prototype,"_save",null),_ts_decorate$a([synchronized],MetadataStore.prototype,"_saveSpaceLargeMetadata",null);var fromBytesInt32=e=>e.readInt32LE(0),hasInvitationExpired=e=>!!(e.created&&e.lifetime&&e.lifetime!==0&&e.created.getTime()+e.lifetime*1e3<Date.now()),isLegacyInvitationFormat=e=>e.type===Invitation.Type.MULTIUSE;function _ts_decorate2$5(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file3$5="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/pipeline/timeframe-clock.ts",mapFeedIndexesToTimeframe=e=>new Timeframe(e.map(({feedKey:t,index:r})=>[t,r])),startAfter=e=>e.frames().map(([t,r])=>({feedKey:t,index:r+1})),TimeframeClock=class{constructor(e=new Timeframe){this._timeframe=e,this.update=new Event$1,this._pendingTimeframe=e}get timeframe(){return this._timeframe}get pendingTimeframe(){return this._pendingTimeframe}setTimeframe(e){this._timeframe=e,this._pendingTimeframe=e,this.update.emit(this._timeframe)}updatePendingTimeframe(e,t){this._pendingTimeframe=Timeframe.merge(this._pendingTimeframe,new Timeframe([[e,t]]))}updateTimeframe(){this._timeframe=this._pendingTimeframe,this.update.emit(this._timeframe)}hasGaps(e){return!Timeframe.dependencies(e,this._timeframe).isEmpty()}async waitUntilReached(e){log("waitUntilReached",{target:e,current:this._timeframe},{F:__dxlog_file3$5,L:70,S:this,C:(t,r)=>t(...r)}),await this.update.waitForCondition(()=>(log("check if reached",{target:e,current:this._timeframe,deps:Timeframe.dependencies(e,this._timeframe)},{F:__dxlog_file3$5,L:72,S:this,C:(t,r)=>t(...r)}),Timeframe.dependencies(e,this._timeframe).isEmpty()))}};_ts_decorate2$5([timed(5e3)],TimeframeClock.prototype,"waitUntilReached",null);var __dxlog_file4$4="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/pipeline/message-selector.ts",createMessageSelector=e=>t=>{for(let r=0;r<t.length;r++){const{data:{timeframe:n}}=t[r];if(invariant$1(n,void 0,{F:__dxlog_file4$4,L:25,S:void 0,A:["timeframe",""]}),!e.hasGaps(n))return r}log("Skipping...",void 0,{F:__dxlog_file4$4,L:33,S:void 0,C:(r,n)=>r(...n)})};function _ts_decorate3$4(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file5$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/pipeline/pipeline.ts",PipelineState=class{constructor(e,t){this._feeds=e,this._timeframeClock=t,this._ctx=new Context,this.timeframeUpdate=this._timeframeClock.update,this.stalled=new Event$1,this._startTimeframe=new Timeframe,this._reachedTarget=!1}get endTimeframe(){return mapFeedIndexesToTimeframe(Array.from(this._feeds.values()).filter(e=>e.length>0).map(e=>({feedKey:e.key,index:e.length-1})))}get startTimeframe(){return this._startTimeframe}get timeframe(){return this._timeframeClock.timeframe}get pendingTimeframe(){return this._timeframeClock.pendingTimeframe}get targetTimeframe(){return this._targetTimeframe?this._targetTimeframe:new Timeframe}get reachedTarget(){return this._reachedTarget}get feeds(){return Array.from(this._feeds.values())}async waitUntilTimeframe(e){await this._timeframeClock.waitUntilReached(e)}setTargetTimeframe(e){this._targetTimeframe=e}async waitUntilReachedTargetTimeframe({ctx:e=new Context,timeout:t,breakOnStall:r=!0}={}){log("waitUntilReachedTargetTimeframe",{timeout:t,current:this.timeframe,target:this.targetTimeframe},{F:__dxlog_file5$2,L:133,S:this,C:(o,s)=>o(...s)}),this._reachedTargetPromise??(this._reachedTargetPromise=Promise.race([this._timeframeClock.update.waitForCondition(()=>Timeframe.dependencies(this.targetTimeframe,this.timeframe).isEmpty()),...r?[this.stalled.discardParameter().waitForCount(1)]:[]]));let n=!1;return t?Promise.race([rejectOnDispose(e),rejectOnDispose(this._ctx),this._reachedTargetPromise.then(()=>{n=!0,this._reachedTarget=!0}),sleepWithContext(this._ctx,t).then(()=>{n||log.warn("waitUntilReachedTargetTimeframe timed out",{timeout:t,current:this.timeframe,target:this.targetTimeframe,dependencies:Timeframe.dependencies(this.targetTimeframe,this.timeframe)},{F:__dxlog_file5$2,L:161,S:this,C:(o,s)=>o(...s)})})]):this._reachedTargetPromise}},Pipeline=class{constructor(){this._timeframeClock=new TimeframeClock(new Timeframe),this._feeds=new ComplexMap(PublicKey.hash),this._state=new PipelineState(this._feeds,this._timeframeClock),this._processingTrigger=new Trigger().wake(),this._pauseTrigger=new Trigger().wake(),this._downloads=new ComplexMap(e=>PublicKey.hash(e.key)),this._isStopping=!1,this._isStarted=!1,this._isBeingConsumed=!1,this._isPaused=!1}get state(){return this._state}get writer(){return invariant$1(this._writer,"Writer not set.",{F:__dxlog_file5$2,L:243,S:this,A:["this._writer","'Writer not set.'"]}),this._writer}hasFeed(e){return this._feeds.has(e)}getFeeds(){return this._feedSetIterator.feeds}async addFeed(e){this._feeds.set(e.key,e),this._feedSetIterator&&await this._feedSetIterator.addFeed(e),this._isStarted&&!this._isPaused&&this._setFeedDownloadState(e)}setWriteFeed(e){invariant$1(!this._writer,"Writer already set.",{F:__dxlog_file5$2,L:270,S:this,A:["!this._writer","'Writer already set.'"]}),invariant$1(e.properties.writable,"Feed must be writable.",{F:__dxlog_file5$2,L:271,S:this,A:["feed.properties.writable","'Feed must be writable.'"]}),this._writer=createMappedFeedWriter(t=>({timeframe:this._timeframeClock.timeframe,payload:t}),e.createFeedWriter())}async start(){if(invariant$1(!this._isStarted,"Pipeline is already started.",{F:__dxlog_file5$2,L:284,S:this,A:["!this._isStarted","'Pipeline is already started.'"]}),log("starting...",void 0,{F:__dxlog_file5$2,L:285,S:this,C:(e,t)=>e(...t)}),await this._initIterator(),await this._feedSetIterator.open(),this._isStarted=!0,log("started",void 0,{F:__dxlog_file5$2,L:289,S:this,C:(e,t)=>e(...t)}),!this._isPaused)for(const e of this._feeds.values())this._setFeedDownloadState(e)}async stop(){var e;log("stopping...",void 0,{F:__dxlog_file5$2,L:300,S:this,C:(t,r)=>t(...r)}),this._isStopping=!0;for(const[t,r]of this._downloads.entries())t.undownload(r);this._downloads.clear(),await((e=this._feedSetIterator)==null?void 0:e.close()),await this._processingTrigger.wait(),await this._state._ctx.dispose(),this._state._ctx=new Context,this._state._reachedTargetPromise=void 0,this._state._reachedTarget=!1,this._isStarted=!1,log("stopped",void 0,{F:__dxlog_file5$2,L:313,S:this,C:(t,r)=>t(...r)})}async setCursor(e){invariant$1(!this._isStarted||this._isPaused,"Invalid state.",{F:__dxlog_file5$2,L:322,S:this,A:["!this._isStarted || this._isPaused","'Invalid state.'"]}),this._state._startTimeframe=e,this._timeframeClock.setTimeframe(e),this._feedSetIterator&&(await this._feedSetIterator.close(),await this._initIterator(),await this._feedSetIterator.open())}async pause(){this._isPaused||(this._pauseTrigger.reset(),await this._processingTrigger.wait(),this._isPaused=!0)}async unpause(){invariant$1(this._isPaused,"Pipeline is not paused.",{F:__dxlog_file5$2,L:351,S:this,A:["this._isPaused","'Pipeline is not paused.'"]}),this._pauseTrigger.wake(),this._isPaused=!1;for(const e of this._feeds.values())this._setFeedDownloadState(e)}async*consume(){invariant$1(!this._isBeingConsumed,"Pipeline is already being consumed.",{F:__dxlog_file5$2,L:366,S:this,A:["!this._isBeingConsumed","'Pipeline is already being consumed.'"]}),this._isBeingConsumed=!0,invariant$1(this._feedSetIterator,"Iterator not initialized.",{F:__dxlog_file5$2,L:369,S:this,A:["this._feedSetIterator","'Iterator not initialized.'"]});let e=this._feedSetIterator,t=e[Symbol.asyncIterator]();for(;!this._isStopping;){await this._pauseTrigger.wait(),e!==this._feedSetIterator&&(invariant$1(this._feedSetIterator,"Iterator not initialized.",{F:__dxlog_file5$2,L:378,S:this,A:["this._feedSetIterator","'Iterator not initialized.'"]}),e=this._feedSetIterator,t=e[Symbol.asyncIterator]());const{done:r,value:n}=await t.next();if(!r){const o=n??failUndefined();this._processingTrigger.reset(),this._timeframeClock.updatePendingTimeframe(PublicKey.from(o.feedKey),o.seq),yield o,this._processingTrigger.wake(),this._timeframeClock.updateTimeframe()}}this._isBeingConsumed=!1}_setFeedDownloadState(e){let t=this._downloads.get(e);t&&e.undownload(t);const r=this._state._startTimeframe.get(e.key)??-1;log("download",{feed:e.key.truncate(),seq:r,length:e.length},{F:__dxlog_file5$2,L:407,S:this,C:(n,o)=>n(...o)}),t=e.download({start:r+1,linear:!0},(n,o)=>{n||log.info("downloaded",{data:o},{F:__dxlog_file5$2,L:412,S:this,C:(s,a)=>s(...a)})}),this._downloads.set(e,t)}async _initIterator(){this._feedSetIterator=new FeedSetIterator(createMessageSelector(this._timeframeClock),{start:startAfter(this._timeframeClock.timeframe),stallTimeout:1e3}),this._feedSetIterator.stalled.on(e=>{log.warn(`Stalled after ${e.options.stallTimeout}ms with ${e.size} feeds.`,void 0,{F:__dxlog_file5$2,L:426,S:this,C:(t,r)=>t(...r)}),this._state.stalled.emit()});for(const e of this._feeds.values())await this._feedSetIterator.addFeed(e)}};_ts_decorate3$4([synchronized],Pipeline.prototype,"start",null),_ts_decorate3$4([synchronized],Pipeline.prototype,"stop",null),_ts_decorate3$4([synchronized],Pipeline.prototype,"setCursor",null),_ts_decorate3$4([synchronized],Pipeline.prototype,"pause",null),_ts_decorate3$4([synchronized],Pipeline.prototype,"unpause",null);var __dxlog_file6$3="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/space/auth.ts",AuthExtension=class extends RpcExtension{constructor(e){super({requested:{AuthService:schema.getService("dxos.mesh.teleport.auth.AuthService")},exposed:{AuthService:schema.getService("dxos.mesh.teleport.auth.AuthService")},timeout:60*1e3}),this._authParams=e,this._ctx=new Context({onError:t=>{log.catch(t,void 0,{F:__dxlog_file6$3,L:28,S:this,C:(r,n)=>r(...n)})}})}async getHandlers(){return{AuthService:{authenticate:async({challenge:e})=>{try{const t=await this._authParams.provider(e);if(!t)throw new Error("auth rejected");return{credential:t}}catch(t){throw log.error("failed to generate auth credentials",t,{F:__dxlog_file6$3,L:55,S:this,C:(r,n)=>r(...n)}),new Error("auth rejected")}}}}}async onOpen(e){await super.onOpen(e),scheduleTask(this._ctx,async()=>{try{const t=randomBytes$1(32),{credential:r}=await this.rpc.AuthService.authenticate({challenge:t});invariant$1((r==null?void 0:r.length)>0,"invalid credential",{F:__dxlog_file6$3,L:69,S:this,A:["credential?.length > 0","'invalid credential'"]});const n=await this._authParams.verifier(t,r);invariant$1(n,"credential not verified",{F:__dxlog_file6$3,L:71,S:this,A:["success","'credential not verified'"]}),runInContext(this._ctx,()=>this._authParams.onAuthSuccess())}catch(t){log("auth failed",t,{F:__dxlog_file6$3,L:74,S:this,C:(r,n)=>r(...n)}),this.close(),this._authParams.onAuthFailure()}})}async onClose(){await this._ctx.dispose(),await super.onClose()}async onAbort(){await this._ctx.dispose(),await super.onAbort()}};function _ts_decorate4$2(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file7$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/space/control-pipeline.ts",TIMEFRAME_SAVE_DEBOUNCE_INTERVAL=500,CONTROL_PIPELINE_SNAPSHOT_DELAY=1e4,ControlPipeline=class{constructor({spaceKey:e,genesisFeed:t,feedProvider:r,metadataStore:n}){this._ctx=new Context,this._lastTimeframeSaveTime=Date.now(),this.onFeedAdmitted=new Callback,this._usage=new TimeUsageCounter,this._mutations=new TimeSeriesCounter,this._snapshotTask=new DeferredTask(this._ctx,async()=>{await sleepWithContext(this._ctx,CONTROL_PIPELINE_SNAPSHOT_DELAY),await this._saveSnapshot()}),this._spaceKey=e,this._metadata=n,this._pipeline=new Pipeline,this._pipeline.addFeed(t),this._spaceStateMachine=new SpaceStateMachine(e),this._spaceStateMachine.onFeedAdmitted.set(async o=>{log("feed admitted",{key:o.key},{F:__dxlog_file7$2,L:82,S:this,C:(s,a)=>s(...a)}),o.assertion.designation===AdmittedFeed.Designation.CONTROL&&!o.key.equals(t.key)&&queueMicrotask(async()=>{try{const s=await r(o.key);this._pipeline.hasFeed(s.key)||await this._pipeline.addFeed(s)}catch(s){log.catch(s,void 0,{F:__dxlog_file7$2,L:93,S:this,C:(a,c)=>a(...c)})}}),await this.onFeedAdmitted.callIfSet(o)}),this.onMemberRoleChanged=this._spaceStateMachine.onMemberRoleChanged,this.onCredentialProcessed=this._spaceStateMachine.onCredentialProcessed,this.onDelegatedInvitation=this._spaceStateMachine.onDelegatedInvitation,this.onDelegatedInvitationRemoved=this._spaceStateMachine.onDelegatedInvitationRemoved}get spaceState(){return this._spaceStateMachine}get pipeline(){return this._pipeline}async setWriteFeed(e){await this._pipeline.addFeed(e),this._pipeline.setWriteFeed(e)}async start(){const e=this._metadata.getSpaceControlPipelineSnapshot(this._spaceKey);log("load snapshot",{key:this._spaceKey,present:!!e,tf:e==null?void 0:e.timeframe},{F:__dxlog_file7$2,L:123,S:this,C:(t,r)=>t(...r)}),e&&await this._processSnapshot(e),log("starting...",void 0,{F:__dxlog_file7$2,L:128,S:this,C:(t,r)=>t(...r)}),setTimeout(async()=>{this._consumePipeline(new Context)}),await this._pipeline.start(),log("started",void 0,{F:__dxlog_file7$2,L:134,S:this,C:(t,r)=>t(...r)})}async _processSnapshot(e){await this._pipeline.setCursor(e.timeframe);for(const t of e.messages??[])await this._spaceStateMachine.process(t.credential,{sourceFeed:t.feedKey,skipVerification:!0})||log.warn("credential processing failed from snapshot",{message:t},{F:__dxlog_file7$2,L:147,S:this,C:(r,n)=>r(...n)})}async _saveSnapshot(){await this._pipeline.pause();const e={timeframe:this._pipeline.state.timeframe,messages:this._spaceStateMachine.credentialEntries.map(t=>({feedKey:t.sourceFeed,credential:t.credential}))};await this._pipeline.unpause(),log("save snapshot",{key:this._spaceKey,snapshot:e},{F:__dxlog_file7$2,L:163,S:this,C:(t,r)=>t(...r)}),await this._metadata.setSpaceControlPipelineSnapshot(this._spaceKey,e)}async _consumePipeline(e){for await(const t of this._pipeline.consume()){const r=this._usage.beginRecording();this._mutations.inc();try{await this._processMessage(e,t)}catch(n){log.catch(n,void 0,{F:__dxlog_file7$2,L:176,S:this,C:(o,s)=>o(...s)})}r.end()}}async _processMessage(e,t){if(log("processing",{key:t.feedKey,seq:t.seq},{F:__dxlog_file7$2,L:186,S:this,C:(r,n)=>r(...n)}),t.data.payload.credential){const r=tracer.mark("dxos.echo.pipeline.control"),n=await this._spaceStateMachine.process(t.data.payload.credential.credential,{sourceFeed:PublicKey.from(t.feedKey)});r.end(),n?await this._noteTargetStateIfNeeded(this._pipeline.state.pendingTimeframe):log.warn("processing failed",{msg:t},{F:__dxlog_file7$2,L:195,S:this,C:(o,s)=>o(...s)}),this._snapshotTask.schedule()}}async _noteTargetStateIfNeeded(e){Date.now()-this._lastTimeframeSaveTime>TIMEFRAME_SAVE_DEBOUNCE_INTERVAL&&(this._lastTimeframeSaveTime=Date.now(),await this._saveTargetTimeframe(e))}async stop(){log("stopping...",void 0,{F:__dxlog_file7$2,L:215,S:this,C:(e,t)=>e(...t)}),await this._ctx.dispose(),await this._pipeline.stop(),await this._saveTargetTimeframe(this._pipeline.state.timeframe),log("stopped",void 0,{F:__dxlog_file7$2,L:219,S:this,C:(e,t)=>e(...t)})}async _saveTargetTimeframe(e){try{const t=Timeframe.merge(this._targetTimeframe??new Timeframe,e);await this._metadata.setSpaceControlLatestTimeframe(this._spaceKey,t),this._targetTimeframe=t}catch(t){log(t,void 0,{F:__dxlog_file7$2,L:228,S:this,C:(r,n)=>r(...n)})}}};_ts_decorate4$2([trace.metricsCounter()],ControlPipeline.prototype,"_usage",void 0),_ts_decorate4$2([trace.metricsCounter()],ControlPipeline.prototype,"_mutations",void 0),_ts_decorate4$2([trace.span({showInBrowserTimeline:!0})],ControlPipeline.prototype,"start",null),_ts_decorate4$2([trace.span()],ControlPipeline.prototype,"_consumePipeline",null),_ts_decorate4$2([trace.span()],ControlPipeline.prototype,"_processMessage",null),ControlPipeline=_ts_decorate4$2([trace.resource(),trackLeaks("start","stop")],ControlPipeline);function _ts_decorate5$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file8$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/space/space.ts",Space=class extends Resource{constructor(e){super(),this._addFeedMutex=new Mutex,this.onCredentialProcessed=new Callback,this.stateUpdate=new Event$1,invariant$1(e.spaceKey&&e.feedProvider,void 0,{F:__dxlog_file8$2,L:75,S:this,A:["params.spaceKey && params.feedProvider",""]}),this._key=e.spaceKey,this._genesisFeedKey=e.genesisFeed.key,this._feedProvider=e.feedProvider,this._snapshotManager=e.snapshotManager,this._controlPipeline=new ControlPipeline({spaceKey:e.spaceKey,genesisFeed:e.genesisFeed,feedProvider:e.feedProvider,metadataStore:e.metadataStore}),this._controlPipeline.onFeedAdmitted.set(async t=>{const r=t.assertion.designation===AdmittedFeed.Designation.DATA;t.key.equals(e.genesisFeed.key)||queueMicrotask(async()=>{this.protocol.addFeed(await e.feedProvider(t.key,{sparse:r}))})}),this._controlPipeline.onCredentialProcessed.set(async t=>{await this.onCredentialProcessed.callIfSet(t),log("onCredentialProcessed",{credential:t},{F:__dxlog_file8$2,L:102,S:this,C:(r,n)=>r(...n)}),this.stateUpdate.emit()}),this._controlPipeline.onDelegatedInvitation.set(async t=>{log("onDelegatedInvitation",{invitation:t},{F:__dxlog_file8$2,L:106,S:this,C:(r,n)=>r(...n)}),await e.onDelegatedInvitationStatusChange(t,!0)}),this._controlPipeline.onDelegatedInvitationRemoved.set(async t=>{log("onDelegatedInvitationRemoved",{invitation:t},{F:__dxlog_file8$2,L:110,S:this,C:(r,n)=>r(...n)}),await e.onDelegatedInvitationStatusChange(t,!1)}),this._controlPipeline.onMemberRoleChanged.set(async t=>{log("onMemberRoleChanged",()=>({changedMembers:t.map(r=>[r.key,r.role])}),{F:__dxlog_file8$2,L:114,S:this,C:(r,n)=>r(...n)}),await e.onMemberRolesChanged(t)}),this.protocol=e.protocol,this.protocol.addFeed(e.genesisFeed)}get key(){return this._key}get isOpen(){return this._lifecycleState===LifecycleState.OPEN}get genesisFeedKey(){return this._genesisFeedKey}get controlFeedKey(){var e;return(e=this._controlFeed)==null?void 0:e.key}get dataFeedKey(){var e;return(e=this._dataFeed)==null?void 0:e.key}get spaceState(){return this._controlPipeline.spaceState}get controlPipeline(){return this._controlPipeline.pipeline}get snapshotManager(){return this._snapshotManager}async setControlFeed(e){return invariant$1(!this._controlFeed,"Control feed already set.",{F:__dxlog_file8$2,L:161,S:this,A:["!this._controlFeed","'Control feed already set.'"]}),this._controlFeed=e,await this._controlPipeline.setWriteFeed(e),this}async setDataFeed(e){return invariant$1(!this._dataFeed,"Data feed already set.",{F:__dxlog_file8$2,L:168,S:this,A:["!this._dataFeed","'Data feed already set.'"]}),this._dataFeed=e,this}getControlFeeds(){return Array.from(this._controlPipeline.spaceState.feeds.values())}async _open(e){log("opening...",void 0,{F:__dxlog_file8$2,L:182,S:this,C:(t,r)=>t(...r)}),await this._controlPipeline.start(),await this.protocol.start(),log("opened",void 0,{F:__dxlog_file8$2,L:188,S:this,C:(t,r)=>t(...r)})}async _close(){log("closing...",{key:this._key},{F:__dxlog_file8$2,L:193,S:this,C:(e,t)=>e(...t)}),await this.protocol.stop(),await this._controlPipeline.stop(),log("closed",void 0,{F:__dxlog_file8$2,L:199,S:this,C:(e,t)=>e(...t)})}};_ts_decorate5$1([trace.info()],Space.prototype,"protocol",void 0),_ts_decorate5$1([trace.info()],Space.prototype,"_controlPipeline",void 0),_ts_decorate5$1([logInfo,trace.info()],Space.prototype,"key",null),_ts_decorate5$1([trace.span()],Space.prototype,"_open",null),_ts_decorate5$1([synchronized],Space.prototype,"_close",null),Space=_ts_decorate5$1([trackLeaks("open","close"),trace.resource()],Space);function _ts_decorate6$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file9$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/space/space-protocol.ts",SpaceProtocol=class{constructor({topic:e,swarmIdentity:t,networkManager:r,onSessionAuth:n,onAuthFailure:o,blobStore:s}){this._feeds=new Set,this._sessions=new ComplexMap(PublicKey.hash),this._topology=new MMSTTopology({originateConnections:4,maxPeers:10,sampleSize:20}),this._spaceKey=e,this._networkManager=r,this._swarmIdentity=t,this._onSessionAuth=n,this._onAuthFailure=o,this.blobSync=new BlobSync({blobStore:s}),this._topic=subtleCrypto.digest("SHA-256",e.asBuffer()).then(discoveryKey).then(PublicKey.from)}get sessions(){return this._sessions}get feeds(){return this._feeds}get _ownPeerKey(){return this._swarmIdentity.peerKey}addFeed(e){log("addFeed",{key:e.key},{F:__dxlog_file9$2,L:109,S:this,C:(t,r)=>t(...r)}),this._feeds.add(e);for(const t of this._sessions.values())t.replicator.addFeed(e)}async start(){if(this._connection)return;const e=await this._swarmIdentity.credentialProvider(export_Buffer.from(""));await this.blobSync.open(),log("starting...",void 0,{F:__dxlog_file9$2,L:128,S:this,C:(r,n)=>r(...n)});const t=await this._topic;this._connection=await this._networkManager.joinSwarm({protocolProvider:this._createProtocolProvider(e),peerId:this._swarmIdentity.peerKey,topic:t,topology:this._topology,label:`swarm ${t.truncate()} for space ${this._spaceKey.truncate()}`}),log("started",void 0,{F:__dxlog_file9$2,L:138,S:this,C:(r,n)=>r(...n)})}updateTopology(){this._topology.forceUpdate()}async stop(){await this.blobSync.close(),this._connection&&(log("stopping...",void 0,{F:__dxlog_file9$2,L:149,S:this,C:(e,t)=>e(...t)}),await this._connection.close(),log("stopped",void 0,{F:__dxlog_file9$2,L:151,S:this,C:(e,t)=>e(...t)}))}_createProtocolProvider(e){return t=>{const r=new SpaceProtocolSession({wireParams:t,swarmIdentity:this._swarmIdentity,onSessionAuth:this._onSessionAuth,onAuthFailure:this._onAuthFailure,blobSync:this.blobSync});this._sessions.set(t.remotePeerId,r);for(const n of this._feeds)r.replicator.addFeed(n);return r}}};_ts_decorate6$1([logInfo,trace.info()],SpaceProtocol.prototype,"_topic",void 0),_ts_decorate6$1([trace.info()],SpaceProtocol.prototype,"_spaceKey",void 0),_ts_decorate6$1([logInfo],SpaceProtocol.prototype,"_ownPeerKey",null),SpaceProtocol=_ts_decorate6$1([trace.resource()],SpaceProtocol);var AuthStatus;(function(e){e.INITIAL="INITIAL",e.SUCCESS="SUCCESS",e.FAILURE="FAILURE"})(AuthStatus||(AuthStatus={}));var SpaceProtocolSession=class{constructor({wireParams:e,swarmIdentity:t,onSessionAuth:r,onAuthFailure:n,blobSync:o}){this.replicator=new ReplicatorExtension().setOptions({upload:!0}),this._authStatus="INITIAL",this._wireParams=e,this._swarmIdentity=t,this._onSessionAuth=r,this._onAuthFailure=n,this._blobSync=o,this._teleport=new Teleport(e)}get authStatus(){return this._authStatus}get stats(){return this._teleport.stats}get stream(){return this._teleport.stream}async open(e){await this._teleport.open(e),this._teleport.addExtension("dxos.mesh.teleport.auth",new AuthExtension({provider:this._swarmIdentity.credentialProvider,verifier:this._swarmIdentity.credentialAuthenticator,onAuthSuccess:()=>{var t;log("Peer authenticated",void 0,{F:__dxlog_file9$2,L:248,S:this,C:(r,n)=>r(...n)}),this._authStatus="SUCCESS",(t=this._onSessionAuth)==null||t.call(this,this._teleport)},onAuthFailure:()=>{var t;this._authStatus="FAILURE",(t=this._onAuthFailure)==null||t.call(this,this._teleport)}})),this._teleport.addExtension("dxos.mesh.teleport.replicator",this.replicator),this._teleport.addExtension("dxos.mesh.teleport.blobsync",this._blobSync.createExtension())}async close(){log("close",void 0,{F:__dxlog_file9$2,L:264,S:this,C:(e,t)=>e(...t)}),await this._teleport.close()}async abort(){await this._teleport.abort()}};_ts_decorate6$1([logInfo],SpaceProtocolSession.prototype,"_wireParams",void 0),_ts_decorate6$1([logInfo],SpaceProtocolSession.prototype,"authStatus",null);function _ts_decorate7$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file10$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/space/space-manager.ts",SpaceManager=class{constructor({feedStore:e,networkManager:t,metadataStore:r,snapshotStore:n,blobStore:o}){this._spaces=new ComplexMap(PublicKey.hash),this._instanceId=PublicKey.random().toHex(),this._feedStore=e,this._networkManager=t,this._metadataStore=r,this._snapshotStore=n,this._blobStore=o}get spaces(){return this._spaces}async open(){}async close(){await Promise.all([...this._spaces.values()].map(e=>e.close()))}async constructSpace({metadata:e,swarmIdentity:t,onAuthorizedConnection:r,onAuthFailure:n,onDelegatedInvitationStatusChange:o,onMemberRolesChanged:s,memberKey:a}){log.trace("dxos.echo.space-manager.construct-space",trace$1.begin({id:this._instanceId}),{F:__dxlog_file10$2,L:94,S:this,C:(f,_)=>f(..._)}),log("constructing space...",{spaceKey:e.genesisFeedKey},{F:__dxlog_file10$2,L:95,S:this,C:(f,_)=>f(..._)});const c=await this._feedStore.openFeed(e.genesisFeedKey??failUndefined()),l=e.key,h=new SpaceProtocol({topic:l,swarmIdentity:t,networkManager:this._networkManager,onSessionAuth:r,onAuthFailure:n,blobStore:this._blobStore}),u=new SnapshotManager(this._snapshotStore,this._blobStore,h.blobSync),d=new Space({spaceKey:l,protocol:h,genesisFeed:c,feedProvider:(f,_)=>this._feedStore.openFeed(f,_),metadataStore:this._metadataStore,snapshotManager:u,memberKey:a,onDelegatedInvitationStatusChange:o,onMemberRolesChanged:s});return this._spaces.set(d.key,d),log.trace("dxos.echo.space-manager.construct-space",trace$1.end({id:this._instanceId}),{F:__dxlog_file10$2,L:124,S:this,C:(f,_)=>f(..._)}),d}};_ts_decorate7$1([synchronized],SpaceManager.prototype,"open",null),_ts_decorate7$1([synchronized],SpaceManager.prototype,"close",null),SpaceManager=_ts_decorate7$1([trackLeaks("open","close")],SpaceManager);var __defProp=Object.defineProperty,__export=(e,t)=>{for(var r in t)__defProp(e,r,{get:t[r],enumerable:!0})};let getRandomValues;const rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(e){return typeof e=="string"&&REGEX.test(e)}const byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]}function stringify(e,t=0){const r=unsafeStringify(e,t);if(!validate(r))throw TypeError("Stringified UUID is invalid");return r}function parse(e){if(!validate(e))throw TypeError("Invalid UUID");let t;const r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=t&255,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=t&255,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=t&255,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=t&255,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=t&255,r}const randomUUID=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),native={randomUUID};function v4(e,t,r){if(native.randomUUID&&!t&&!e)return native.randomUUID();e=e||{};const n=e.random||(e.rng||rng)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){r=r||0;for(let o=0;o<16;++o)t[r+o]=n[o];return t}return unsafeStringify(n)}const __vite__wasmUrl="/automerge_wasm_bg.wasm",__vite__initWasm=async(e={},t)=>{let r;if(t.startsWith("data:")){const n=t.replace(/^data:.*?base64,/,"");let o;if(typeof Buffer=="function"&&typeof Buffer.from=="function")o=Buffer.from(n,"base64");else if(typeof atob=="function"){const s=atob(n);o=new Uint8Array(s.length);for(let a=0;a<s.length;a++)o[a]=s.charCodeAt(a)}else throw new Error("Cannot decode base64-encoded data URL");r=await WebAssembly.instantiate(o,e)}else{const n=await fetch(t),o=n.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&o.startsWith("application/wasm"))r=await WebAssembly.instantiateStreaming(n,e);else{const s=await n.arrayBuffer();r=await WebAssembly.instantiate(s,e)}}return r.instance.exports};let wasm$2;function __wbg_set_wasm(e){wasm$2=e}const heap=new Array(128).fill(void 0);heap.push(void 0,null,!0,!1);function getObject(e){return heap[e]}let heap_next=heap.length;function dropObject(e){e<132||(heap[e]=heap_next,heap_next=e)}function takeObject(e){const t=getObject(e);return dropObject(e),t}let WASM_VECTOR_LEN=0,cachedUint8Memory0=null;function getUint8Memory0(){return(cachedUint8Memory0===null||cachedUint8Memory0.byteLength===0)&&(cachedUint8Memory0=new Uint8Array(wasm$2.memory.buffer)),cachedUint8Memory0}const lTextEncoder=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder;let cachedTextEncoder=new lTextEncoder("utf-8");const encodeString=typeof cachedTextEncoder.encodeInto=="function"?function(e,t){return cachedTextEncoder.encodeInto(e,t)}:function(e,t){const r=cachedTextEncoder.encode(e);return t.set(r),{read:e.length,written:r.length}};function passStringToWasm0(e,t,r){if(r===void 0){const c=cachedTextEncoder.encode(e),l=t(c.length,1)>>>0;return getUint8Memory0().subarray(l,l+c.length).set(c),WASM_VECTOR_LEN=c.length,l}let n=e.length,o=t(n,1)>>>0;const s=getUint8Memory0();let a=0;for(;a<n;a++){const c=e.charCodeAt(a);if(c>127)break;s[o+a]=c}if(a!==n){a!==0&&(e=e.slice(a)),o=r(o,n,n=a+e.length*3,1)>>>0;const c=getUint8Memory0().subarray(o+a,o+n),l=encodeString(e,c);a+=l.written,o=r(o,n,a,1)>>>0}return WASM_VECTOR_LEN=a,o}function isLikeNone(e){return e==null}let cachedInt32Memory0=null;function getInt32Memory0(){return(cachedInt32Memory0===null||cachedInt32Memory0.byteLength===0)&&(cachedInt32Memory0=new Int32Array(wasm$2.memory.buffer)),cachedInt32Memory0}const lTextDecoder=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder;let cachedTextDecoder=new lTextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});cachedTextDecoder.decode();function getStringFromWasm0(e,t){return e=e>>>0,cachedTextDecoder.decode(getUint8Memory0().subarray(e,e+t))}function addHeapObject(e){heap_next===heap.length&&heap.push(heap.length+1);const t=heap_next;return heap_next=heap[t],heap[t]=e,t}let cachedFloat64Memory0=null;function getFloat64Memory0(){return(cachedFloat64Memory0===null||cachedFloat64Memory0.byteLength===0)&&(cachedFloat64Memory0=new Float64Array(wasm$2.memory.buffer)),cachedFloat64Memory0}function debugString(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return`${e}`;if(t=="string")return`"${e}"`;if(t=="symbol"){const o=e.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=e.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(e)){const o=e.length;let s="[";o>0&&(s+=debugString(e[0]));for(let a=1;a<o;a++)s+=", "+debugString(e[a]);return s+="]",s}const r=/\[object ([^\]]+)\]/.exec(toString.call(e));let n;if(r.length>1)n=r[1];else return toString.call(e);if(n=="Object")try{return"Object("+JSON.stringify(e)+")"}catch{return"Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:n}function _assertClass(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function create$1(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.create(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return Automerge.__wrap(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function load$2(e,t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.load(s,addHeapObject(e),addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return Automerge.__wrap(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function encodeChange$2(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.encodeChange(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function decodeChange$2(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.decodeChange(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function initSyncState$2(){const e=wasm$2.initSyncState();return SyncState.__wrap(e)}function importSyncState$1(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.importSyncState(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return SyncState.__wrap(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function exportSyncState$1(e){_assertClass(e,SyncState);const t=wasm$2.exportSyncState(e.__wbg_ptr);return takeObject(t)}function encodeSyncMessage$2(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.encodeSyncMessage(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function decodeSyncMessage$2(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.decodeSyncMessage(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function encodeSyncState$2(e){_assertClass(e,SyncState);const t=wasm$2.encodeSyncState(e.__wbg_ptr);return takeObject(t)}function decodeSyncState$2(e){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.decodeSyncState(o,addHeapObject(e));var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return SyncState.__wrap(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}function handleError(e,t){try{return e.apply(this,t)}catch(r){wasm$2.__wbindgen_exn_store(addHeapObject(r))}}const TextRepresentation=Object.freeze({Array:0,0:"Array",String:1,1:"String"}),AutomergeFinalization=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>wasm$2.__wbg_automerge_free(e>>>0));class Automerge{static __wrap(t){t=t>>>0;const r=Object.create(Automerge.prototype);return r.__wbg_ptr=t,AutomergeFinalization.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,AutomergeFinalization.unregister(this),t}free(){const t=this.__destroy_into_raw();wasm$2.__wbg_automerge_free(t)}static new(t,r){try{const l=wasm$2.__wbindgen_add_to_stack_pointer(-16);var n=isLikeNone(t)?0:passStringToWasm0(t,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;wasm$2.automerge_new(l,n,o,r);var s=getInt32Memory0()[l/4+0],a=getInt32Memory0()[l/4+1],c=getInt32Memory0()[l/4+2];if(c)throw takeObject(a);return Automerge.__wrap(s)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}clone(t){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);var r=isLikeNone(t)?0:passStringToWasm0(t,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),n=WASM_VECTOR_LEN;wasm$2.automerge_clone(c,this.__wbg_ptr,r,n);var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return Automerge.__wrap(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}fork(t,r){try{const l=wasm$2.__wbindgen_add_to_stack_pointer(-16);var n=isLikeNone(t)?0:passStringToWasm0(t,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;wasm$2.automerge_fork(l,this.__wbg_ptr,n,o,addHeapObject(r));var s=getInt32Memory0()[l/4+0],a=getInt32Memory0()[l/4+1],c=getInt32Memory0()[l/4+2];if(c)throw takeObject(a);return Automerge.__wrap(s)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}pendingOps(){const t=wasm$2.automerge_pendingOps(this.__wbg_ptr);return takeObject(t)}commit(t,r){var n=isLikeNone(t)?0:passStringToWasm0(t,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;const s=wasm$2.automerge_commit(this.__wbg_ptr,n,o,!isLikeNone(r),isLikeNone(r)?0:r);return takeObject(s)}merge(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);_assertClass(t,Automerge),wasm$2.automerge_merge(s,this.__wbg_ptr,t.__wbg_ptr);var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}rollback(){return wasm$2.automerge_rollback(this.__wbg_ptr)}keys(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_keys(a,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}text(t,r){let n,o;try{const d=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_text(d,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var s=getInt32Memory0()[d/4+0],a=getInt32Memory0()[d/4+1],c=getInt32Memory0()[d/4+2],l=getInt32Memory0()[d/4+3],h=s,u=a;if(l)throw h=0,u=0,takeObject(c);return n=h,o=u,getStringFromWasm0(h,u)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16),wasm$2.__wbindgen_free(n,o,1)}}spans(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_spans(a,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}splice(t,r,n,o){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_splice(c,this.__wbg_ptr,addHeapObject(t),r,n,addHeapObject(o));var s=getInt32Memory0()[c/4+0],a=getInt32Memory0()[c/4+1];if(a)throw takeObject(s)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}updateText(t,r){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_updateText(s,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];if(o)throw takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}updateSpans(t,r){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_updateSpans(s,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];if(o)throw takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}push(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_push(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}pushObject(t,r){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_pushObject(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[c/4+0],o=getInt32Memory0()[c/4+1],s=getInt32Memory0()[c/4+2],a=getInt32Memory0()[c/4+3];if(a)throw takeObject(s);let l;return n!==0&&(l=getStringFromWasm0(n,o).slice(),wasm$2.__wbindgen_free(n,o*1,1)),l}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}insert(t,r,n,o){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_insert(c,this.__wbg_ptr,addHeapObject(t),r,addHeapObject(n),addHeapObject(o));var s=getInt32Memory0()[c/4+0],a=getInt32Memory0()[c/4+1];if(a)throw takeObject(s)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}splitBlock(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_splitBlock(a,this.__wbg_ptr,addHeapObject(t),r,addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}joinBlock(t,r){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_joinBlock(s,this.__wbg_ptr,addHeapObject(t),r);var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];if(o)throw takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}updateBlock(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_updateBlock(a,this.__wbg_ptr,addHeapObject(t),r,addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getBlock(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getBlock(c,this.__wbg_ptr,addHeapObject(t),r,isLikeNone(n)?0:addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}insertObject(t,r,n){try{const l=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_insertObject(l,this.__wbg_ptr,addHeapObject(t),r,addHeapObject(n));var o=getInt32Memory0()[l/4+0],s=getInt32Memory0()[l/4+1],a=getInt32Memory0()[l/4+2],c=getInt32Memory0()[l/4+3];if(c)throw takeObject(a);let h;return o!==0&&(h=getStringFromWasm0(o,s).slice(),wasm$2.__wbindgen_free(o,s*1,1)),h}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}put(t,r,n,o){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_put(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n),addHeapObject(o));var s=getInt32Memory0()[c/4+0],a=getInt32Memory0()[c/4+1];if(a)throw takeObject(s)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}putObject(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_putObject(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}increment(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_increment(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}get(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_get(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),isLikeNone(n)?0:addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getWithType(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getWithType(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),isLikeNone(n)?0:addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}objInfo(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_objInfo(a,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getAll(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getAll(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),isLikeNone(n)?0:addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}enableFreeze(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_enableFreeze(s,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}registerDatatype(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_registerDatatype(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}applyPatches(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_applyPatches(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}applyAndReturnPatches(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_applyAndReturnPatches(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}diffIncremental(){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_diffIncremental(o,this.__wbg_ptr);var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}updateDiffCursor(){wasm$2.automerge_updateDiffCursor(this.__wbg_ptr)}resetDiffCursor(){wasm$2.automerge_resetDiffCursor(this.__wbg_ptr)}diff(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_diff(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}isolate(t){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_isolate(o,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[o/4+0],n=getInt32Memory0()[o/4+1];if(n)throw takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}integrate(){wasm$2.automerge_integrate(this.__wbg_ptr)}length(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_length(a,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var n=getFloat64Memory0()[a/8+0],o=getInt32Memory0()[a/4+2],s=getInt32Memory0()[a/4+3];if(s)throw takeObject(o);return n}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}delete(t,r){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_delete(s,this.__wbg_ptr,addHeapObject(t),addHeapObject(r));var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];if(o)throw takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}save(){const t=wasm$2.automerge_save(this.__wbg_ptr);return takeObject(t)}saveIncremental(){const t=wasm$2.automerge_saveIncremental(this.__wbg_ptr);return takeObject(t)}saveSince(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_saveSince(s,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}saveNoCompress(){const t=wasm$2.automerge_saveNoCompress(this.__wbg_ptr);return takeObject(t)}saveAndVerify(){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_saveAndVerify(o,this.__wbg_ptr);var t=getInt32Memory0()[o/4+0],r=getInt32Memory0()[o/4+1],n=getInt32Memory0()[o/4+2];if(n)throw takeObject(r);return takeObject(t)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}loadIncremental(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_loadIncremental(s,this.__wbg_ptr,addHeapObject(t));var r=getFloat64Memory0()[s/8+0],n=getInt32Memory0()[s/4+2],o=getInt32Memory0()[s/4+3];if(o)throw takeObject(n);return r}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}applyChanges(t){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_applyChanges(o,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[o/4+0],n=getInt32Memory0()[o/4+1];if(n)throw takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getChanges(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getChanges(s,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getChangeByHash(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getChangeByHash(s,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getChangesAdded(t){_assertClass(t,Automerge);const r=wasm$2.automerge_getChangesAdded(this.__wbg_ptr,t.__wbg_ptr);return takeObject(r)}getHeads(){const t=wasm$2.automerge_getHeads(this.__wbg_ptr);return takeObject(t)}getActorId(){let t,r;try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getActorId(s,this.__wbg_ptr);var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];return t=n,r=o,getStringFromWasm0(n,o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16),wasm$2.__wbindgen_free(t,r,1)}}getLastLocalChange(){const t=wasm$2.automerge_getLastLocalChange(this.__wbg_ptr);return takeObject(t)}dump(){wasm$2.automerge_dump(this.__wbg_ptr)}getMissingDeps(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getMissingDeps(s,this.__wbg_ptr,isLikeNone(t)?0:addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}receiveSyncMessage(t,r){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);_assertClass(t,SyncState),wasm$2.automerge_receiveSyncMessage(s,this.__wbg_ptr,t.__wbg_ptr,addHeapObject(r));var n=getInt32Memory0()[s/4+0],o=getInt32Memory0()[s/4+1];if(o)throw takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}generateSyncMessage(t){_assertClass(t,SyncState);const r=wasm$2.automerge_generateSyncMessage(this.__wbg_ptr,t.__wbg_ptr);return takeObject(r)}toJS(t){try{const s=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_toJS(s,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[s/4+0],n=getInt32Memory0()[s/4+1],o=getInt32Memory0()[s/4+2];if(o)throw takeObject(n);return takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}materialize(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_materialize(c,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}getCursor(t,r,n){let o,s;try{const f=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getCursor(f,this.__wbg_ptr,addHeapObject(t),r,isLikeNone(n)?0:addHeapObject(n));var a=getInt32Memory0()[f/4+0],c=getInt32Memory0()[f/4+1],l=getInt32Memory0()[f/4+2],h=getInt32Memory0()[f/4+3],u=a,d=c;if(h)throw u=0,d=0,takeObject(l);return o=u,s=d,getStringFromWasm0(u,d)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16),wasm$2.__wbindgen_free(o,s,1)}}getCursorPosition(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_getCursorPosition(c,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),isLikeNone(n)?0:addHeapObject(n));var o=getFloat64Memory0()[c/8+0],s=getInt32Memory0()[c/4+2],a=getInt32Memory0()[c/4+3];if(a)throw takeObject(s);return o}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}emptyChange(t,r){var n=isLikeNone(t)?0:passStringToWasm0(t,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;const s=wasm$2.automerge_emptyChange(this.__wbg_ptr,n,o,!isLikeNone(r),isLikeNone(r)?0:r);return takeObject(s)}mark(t,r,n,o,s){try{const l=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_mark(l,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n),addHeapObject(o),addHeapObject(s));var a=getInt32Memory0()[l/4+0],c=getInt32Memory0()[l/4+1];if(c)throw takeObject(a)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}unmark(t,r,n){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_unmark(a,this.__wbg_ptr,addHeapObject(t),addHeapObject(r),addHeapObject(n));var o=getInt32Memory0()[a/4+0],s=getInt32Memory0()[a/4+1];if(s)throw takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}marks(t,r){try{const a=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_marks(a,this.__wbg_ptr,addHeapObject(t),isLikeNone(r)?0:addHeapObject(r));var n=getInt32Memory0()[a/4+0],o=getInt32Memory0()[a/4+1],s=getInt32Memory0()[a/4+2];if(s)throw takeObject(o);return takeObject(n)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}marksAt(t,r,n){try{const c=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.automerge_marksAt(c,this.__wbg_ptr,addHeapObject(t),r,isLikeNone(n)?0:addHeapObject(n));var o=getInt32Memory0()[c/4+0],s=getInt32Memory0()[c/4+1],a=getInt32Memory0()[c/4+2];if(a)throw takeObject(s);return takeObject(o)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}}const SyncStateFinalization=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>wasm$2.__wbg_syncstate_free(e>>>0));class SyncState{static __wrap(t){t=t>>>0;const r=Object.create(SyncState.prototype);return r.__wbg_ptr=t,SyncStateFinalization.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,SyncStateFinalization.unregister(this),t}free(){const t=this.__destroy_into_raw();wasm$2.__wbg_syncstate_free(t)}get sharedHeads(){const t=wasm$2.syncstate_sharedHeads(this.__wbg_ptr);return takeObject(t)}get lastSentHeads(){const t=wasm$2.syncstate_lastSentHeads(this.__wbg_ptr);return takeObject(t)}set lastSentHeads(t){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.syncstate_set_lastSentHeads(o,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[o/4+0],n=getInt32Memory0()[o/4+1];if(n)throw takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}set sentHashes(t){try{const o=wasm$2.__wbindgen_add_to_stack_pointer(-16);wasm$2.syncstate_set_sentHashes(o,this.__wbg_ptr,addHeapObject(t));var r=getInt32Memory0()[o/4+0],n=getInt32Memory0()[o/4+1];if(n)throw takeObject(r)}finally{wasm$2.__wbindgen_add_to_stack_pointer(16)}}clone(){const t=wasm$2.syncstate_clone(this.__wbg_ptr);return SyncState.__wrap(t)}}function __wbindgen_object_drop_ref(e){takeObject(e)}function __wbindgen_string_get(e,t){const r=getObject(t),n=typeof r=="string"?r:void 0;var o=isLikeNone(n)?0:passStringToWasm0(n,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),s=WASM_VECTOR_LEN;getInt32Memory0()[e/4+1]=s,getInt32Memory0()[e/4+0]=o}function __wbindgen_string_new(e,t){const r=getStringFromWasm0(e,t);return addHeapObject(r)}function __wbindgen_number_new(e){return addHeapObject(e)}function __wbindgen_object_clone_ref(e){const t=getObject(e);return addHeapObject(t)}function __wbindgen_error_new(e,t){const r=new Error(getStringFromWasm0(e,t));return addHeapObject(r)}function __wbindgen_number_get(e,t){const r=getObject(t),n=typeof r=="number"?r:void 0;getFloat64Memory0()[e/8+1]=isLikeNone(n)?0:n,getInt32Memory0()[e/4+0]=!isLikeNone(n)}function __wbindgen_is_undefined(e){return getObject(e)===void 0}function __wbindgen_boolean_get(e){const t=getObject(e);return typeof t=="boolean"?t?1:0:2}function __wbindgen_is_null(e){return getObject(e)===null}function __wbindgen_is_string(e){return typeof getObject(e)=="string"}function __wbindgen_is_function(e){return typeof getObject(e)=="function"}function __wbindgen_is_object(e){const t=getObject(e);return typeof t=="object"&&t!==null}function __wbindgen_is_array(e){return Array.isArray(getObject(e))}function __wbindgen_json_serialize(e,t){const r=getObject(t),n=JSON.stringify(r===void 0?null:r),o=passStringToWasm0(n,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),s=WASM_VECTOR_LEN;getInt32Memory0()[e/4+1]=s,getInt32Memory0()[e/4+0]=o}function __wbg_new_abda76e883ba8a5f(){const e=new Error;return addHeapObject(e)}function __wbg_stack_658279fe44541cf6(e,t){const r=getObject(t).stack,n=passStringToWasm0(r,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;getInt32Memory0()[e/4+1]=o,getInt32Memory0()[e/4+0]=n}function __wbg_error_f851667af71bcfc6(e,t){let r,n;try{r=e,n=t,console.error(getStringFromWasm0(e,t))}finally{wasm$2.__wbindgen_free(r,n,1)}}function __wbindgen_jsval_loose_eq(e,t){return getObject(e)==getObject(t)}function __wbg_String_91fba7ded13ba54c(e,t){const r=String(getObject(t)),n=passStringToWasm0(r,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;getInt32Memory0()[e/4+1]=o,getInt32Memory0()[e/4+0]=n}function __wbindgen_bigint_from_i64(e){return addHeapObject(e)}function __wbindgen_bigint_from_u64(e){const t=BigInt.asUintN(64,e);return addHeapObject(t)}function __wbg_set_20cbc34131e76824(e,t,r){getObject(e)[takeObject(t)]=takeObject(r)}function __wbg_getRandomValues_3aa56aa6edec874c(){return handleError(function(e,t){getObject(e).getRandomValues(getObject(t))},arguments)}function __wbg_randomFillSync_5c9c955aa56b6049(){return handleError(function(e,t){getObject(e).randomFillSync(takeObject(t))},arguments)}function __wbg_crypto_1d1f22824a6a080c(e){const t=getObject(e).crypto;return addHeapObject(t)}function __wbg_process_4a72847cc503995b(e){const t=getObject(e).process;return addHeapObject(t)}function __wbg_versions_f686565e586dd935(e){const t=getObject(e).versions;return addHeapObject(t)}function __wbg_node_104a2ff8d6ea03a2(e){const t=getObject(e).node;return addHeapObject(t)}function __wbg_msCrypto_eb05e62b530a1508(e){const t=getObject(e).msCrypto;return addHeapObject(t)}function __wbg_require_cca90b1a94a0255b(){return handleError(function(){const e=module.require;return addHeapObject(e)},arguments)}function __wbg_log_5bb5f88f245d7762(e){console.log(getObject(e))}function __wbg_log_1746d5c75ec89963(e,t){console.log(getObject(e),getObject(t))}function __wbg_get_bd8e338fbd5f5cc8(e,t){const r=getObject(e)[t>>>0];return addHeapObject(r)}function __wbg_length_cd7af8117672b8b8(e){return getObject(e).length}function __wbg_new_16b304a2cfa7ff4a(){const e=new Array;return addHeapObject(e)}function __wbg_newnoargs_e258087cd0daa0ea(e,t){const r=new Function(getStringFromWasm0(e,t));return addHeapObject(r)}function __wbg_next_40fc327bfc8770e6(e){const t=getObject(e).next;return addHeapObject(t)}function __wbg_next_196c84450b364254(){return handleError(function(e){const t=getObject(e).next();return addHeapObject(t)},arguments)}function __wbg_done_298b57d23c0fc80c(e){return getObject(e).done}function __wbg_value_d93c65011f51a456(e){const t=getObject(e).value;return addHeapObject(t)}function __wbg_iterator_2cee6dadfd956dfa(){return addHeapObject(Symbol.iterator)}function __wbg_get_e3c254076557e348(){return handleError(function(e,t){const r=Reflect.get(getObject(e),getObject(t));return addHeapObject(r)},arguments)}function __wbg_call_27c0f87801dedf93(){return handleError(function(e,t){const r=getObject(e).call(getObject(t));return addHeapObject(r)},arguments)}function __wbg_new_72fb9a18b5ae2624(){const e=new Object;return addHeapObject(e)}function __wbg_length_dee433d4c85c9387(e){return getObject(e).length}function __wbg_set_d4638f722068f043(e,t,r){getObject(e)[t>>>0]=takeObject(r)}function __wbg_from_89e3fc3ba5e6fb48(e){const t=Array.from(getObject(e));return addHeapObject(t)}function __wbg_isArray_2ab64d95e09ea0ae(e){return Array.isArray(getObject(e))}function __wbg_push_a5b05aedc7234f9f(e,t){return getObject(e).push(getObject(t))}function __wbg_unshift_e22df4b34bcf5070(e,t){return getObject(e).unshift(getObject(t))}function __wbg_instanceof_ArrayBuffer_836825be07d4c9d2(e){let t;try{t=getObject(e)instanceof ArrayBuffer}catch{t=!1}return t}function __wbg_new_28c511d9baebfa89(e,t){const r=new Error(getStringFromWasm0(e,t));return addHeapObject(r)}function __wbg_call_b3ca7c6051f9bec1(){return handleError(function(e,t,r){const n=getObject(e).call(getObject(t),getObject(r));return addHeapObject(n)},arguments)}function __wbg_instanceof_Date_f65cf97fb83fc369(e){let t;try{t=getObject(e)instanceof Date}catch{t=!1}return t}function __wbg_getTime_2bc4375165f02d15(e){return getObject(e).getTime()}function __wbg_new_cf3ec55744a78578(e){const t=new Date(getObject(e));return addHeapObject(t)}function __wbg_instanceof_Object_71ca3c0a59266746(e){let t;try{t=getObject(e)instanceof Object}catch{t=!1}return t}function __wbg_assign_496d2d14fecafbcf(e,t){const r=Object.assign(getObject(e),getObject(t));return addHeapObject(r)}function __wbg_defineProperty_cc00e2de8a0f5141(e,t,r){const n=Object.defineProperty(getObject(e),getObject(t),getObject(r));return addHeapObject(n)}function __wbg_entries_95cc2c823b285a09(e){const t=Object.entries(getObject(e));return addHeapObject(t)}function __wbg_freeze_cc6bc19f75299986(e){const t=Object.freeze(getObject(e));return addHeapObject(t)}function __wbg_keys_91e412b4b222659f(e){const t=Object.keys(getObject(e));return addHeapObject(t)}function __wbg_values_9c75e6e2bfbdb70d(e){const t=Object.values(getObject(e));return addHeapObject(t)}function __wbg_new_dd6a5dd7b538af21(e,t){const r=new RangeError(getStringFromWasm0(e,t));return addHeapObject(r)}function __wbg_apply_0a5aa603881e6d79(){return handleError(function(e,t,r){const n=Reflect.apply(getObject(e),getObject(t),getObject(r));return addHeapObject(n)},arguments)}function __wbg_deleteProperty_13e721a56f19e842(){return handleError(function(e,t){return Reflect.deleteProperty(getObject(e),getObject(t))},arguments)}function __wbg_ownKeys_658942b7f28d1fe9(){return handleError(function(e){const t=Reflect.ownKeys(getObject(e));return addHeapObject(t)},arguments)}function __wbg_set_1f9b04f170055d33(){return handleError(function(e,t,r){return Reflect.set(getObject(e),getObject(t),getObject(r))},arguments)}function __wbg_buffer_12d079cc21e14bdb(e){const t=getObject(e).buffer;return addHeapObject(t)}function __wbg_concat_3de229fe4fe90fea(e,t){const r=getObject(e).concat(getObject(t));return addHeapObject(r)}function __wbg_slice_52fb626ffdc8da8f(e,t,r){const n=getObject(e).slice(t>>>0,r>>>0);return addHeapObject(n)}function __wbg_for_27c67e2dbdce22f6(e,t){const r=Symbol.for(getStringFromWasm0(e,t));return addHeapObject(r)}function __wbg_toString_7df3c77999517c20(e){const t=getObject(e).toString();return addHeapObject(t)}function __wbg_self_ce0dbfc45cf2f5be(){return handleError(function(){const e=self.self;return addHeapObject(e)},arguments)}function __wbg_window_c6fb939a7f436783(){return handleError(function(){const e=window.window;return addHeapObject(e)},arguments)}function __wbg_globalThis_d1e6af4856ba331b(){return handleError(function(){const e=globalThis.globalThis;return addHeapObject(e)},arguments)}function __wbg_global_207b558942527489(){return handleError(function(){const e=global.global;return addHeapObject(e)},arguments)}function __wbg_newwithbyteoffsetandlength_aa4a17c33a06e5cb(e,t,r){const n=new Uint8Array(getObject(e),t>>>0,r>>>0);return addHeapObject(n)}function __wbg_new_63b92bc8671ed464(e){const t=new Uint8Array(getObject(e));return addHeapObject(t)}function __wbg_set_a47bac70306a19a7(e,t,r){getObject(e).set(getObject(t),r>>>0)}function __wbg_length_c20a40f15020d68a(e){return getObject(e).length}function __wbg_instanceof_Uint8Array_2b3bbecd033d19f6(e){let t;try{t=getObject(e)instanceof Uint8Array}catch{t=!1}return t}function __wbg_newwithlength_e9b4878cebadb3d3(e){const t=new Uint8Array(e>>>0);return addHeapObject(t)}function __wbg_subarray_a1f73cd4b5b42fe1(e,t,r){const n=getObject(e).subarray(t>>>0,r>>>0);return addHeapObject(n)}function __wbindgen_debug_string(e,t){const r=debugString(getObject(t)),n=passStringToWasm0(r,wasm$2.__wbindgen_malloc,wasm$2.__wbindgen_realloc),o=WASM_VECTOR_LEN;getInt32Memory0()[e/4+1]=o,getInt32Memory0()[e/4+0]=n}function __wbindgen_throw(e,t){throw new Error(getStringFromWasm0(e,t))}function __wbindgen_memory(){const e=wasm$2.memory;return addHeapObject(e)}URL=globalThis.URL;const __vite__wasmModule=await __vite__initWasm({"./automerge_wasm_bg.js":{__wbindgen_object_drop_ref,__wbindgen_string_get,__wbindgen_string_new,__wbindgen_number_new,__wbindgen_object_clone_ref,__wbindgen_error_new,__wbindgen_number_get,__wbindgen_is_undefined,__wbindgen_boolean_get,__wbindgen_is_null,__wbindgen_is_string,__wbindgen_is_function,__wbindgen_is_object,__wbindgen_is_array,__wbindgen_json_serialize,__wbg_new_abda76e883ba8a5f,__wbg_stack_658279fe44541cf6,__wbg_error_f851667af71bcfc6,__wbindgen_jsval_loose_eq,__wbg_String_91fba7ded13ba54c,__wbindgen_bigint_from_i64,__wbindgen_bigint_from_u64,__wbg_set_20cbc34131e76824,__wbg_getRandomValues_3aa56aa6edec874c,__wbg_randomFillSync_5c9c955aa56b6049,__wbg_crypto_1d1f22824a6a080c,__wbg_process_4a72847cc503995b,__wbg_versions_f686565e586dd935,__wbg_node_104a2ff8d6ea03a2,__wbg_msCrypto_eb05e62b530a1508,__wbg_require_cca90b1a94a0255b,__wbg_log_5bb5f88f245d7762,__wbg_log_1746d5c75ec89963,__wbg_get_bd8e338fbd5f5cc8,__wbg_length_cd7af8117672b8b8,__wbg_new_16b304a2cfa7ff4a,__wbg_newnoargs_e258087cd0daa0ea,__wbg_next_40fc327bfc8770e6,__wbg_next_196c84450b364254,__wbg_done_298b57d23c0fc80c,__wbg_value_d93c65011f51a456,__wbg_iterator_2cee6dadfd956dfa,__wbg_get_e3c254076557e348,__wbg_call_27c0f87801dedf93,__wbg_new_72fb9a18b5ae2624,__wbg_length_dee433d4c85c9387,__wbg_set_d4638f722068f043,__wbg_from_89e3fc3ba5e6fb48,__wbg_isArray_2ab64d95e09ea0ae,__wbg_push_a5b05aedc7234f9f,__wbg_unshift_e22df4b34bcf5070,__wbg_instanceof_ArrayBuffer_836825be07d4c9d2,__wbg_new_28c511d9baebfa89,__wbg_call_b3ca7c6051f9bec1,__wbg_instanceof_Date_f65cf97fb83fc369,__wbg_getTime_2bc4375165f02d15,__wbg_new_cf3ec55744a78578,__wbg_instanceof_Object_71ca3c0a59266746,__wbg_assign_496d2d14fecafbcf,__wbg_defineProperty_cc00e2de8a0f5141,__wbg_entries_95cc2c823b285a09,__wbg_freeze_cc6bc19f75299986,__wbg_keys_91e412b4b222659f,__wbg_values_9c75e6e2bfbdb70d,__wbg_new_dd6a5dd7b538af21,__wbg_apply_0a5aa603881e6d79,__wbg_deleteProperty_13e721a56f19e842,__wbg_ownKeys_658942b7f28d1fe9,__wbg_set_1f9b04f170055d33,__wbg_buffer_12d079cc21e14bdb,__wbg_concat_3de229fe4fe90fea,__wbg_slice_52fb626ffdc8da8f,__wbg_for_27c67e2dbdce22f6,__wbg_toString_7df3c77999517c20,__wbg_self_ce0dbfc45cf2f5be,__wbg_window_c6fb939a7f436783,__wbg_globalThis_d1e6af4856ba331b,__wbg_global_207b558942527489,__wbg_newwithbyteoffsetandlength_aa4a17c33a06e5cb,__wbg_new_63b92bc8671ed464,__wbg_set_a47bac70306a19a7,__wbg_length_c20a40f15020d68a,__wbg_instanceof_Uint8Array_2b3bbecd033d19f6,__wbg_newwithlength_e9b4878cebadb3d3,__wbg_subarray_a1f73cd4b5b42fe1,__wbindgen_debug_string,__wbindgen_throw,__wbindgen_memory}},__vite__wasmUrl),memory=__vite__wasmModule.memory,__wbg_syncstate_free=__vite__wasmModule.__wbg_syncstate_free,syncstate_sharedHeads=__vite__wasmModule.syncstate_sharedHeads,syncstate_lastSentHeads=__vite__wasmModule.syncstate_lastSentHeads,syncstate_set_lastSentHeads=__vite__wasmModule.syncstate_set_lastSentHeads,syncstate_set_sentHashes=__vite__wasmModule.syncstate_set_sentHashes,syncstate_clone=__vite__wasmModule.syncstate_clone,__wbg_automerge_free=__vite__wasmModule.__wbg_automerge_free,automerge_new=__vite__wasmModule.automerge_new,automerge_clone=__vite__wasmModule.automerge_clone,automerge_fork=__vite__wasmModule.automerge_fork,automerge_pendingOps=__vite__wasmModule.automerge_pendingOps,automerge_commit=__vite__wasmModule.automerge_commit,automerge_merge=__vite__wasmModule.automerge_merge,automerge_rollback=__vite__wasmModule.automerge_rollback,automerge_keys=__vite__wasmModule.automerge_keys,automerge_text=__vite__wasmModule.automerge_text,automerge_spans=__vite__wasmModule.automerge_spans,automerge_splice=__vite__wasmModule.automerge_splice,automerge_updateText=__vite__wasmModule.automerge_updateText,automerge_updateSpans=__vite__wasmModule.automerge_updateSpans,automerge_push=__vite__wasmModule.automerge_push,automerge_pushObject=__vite__wasmModule.automerge_pushObject,automerge_insert=__vite__wasmModule.automerge_insert,automerge_splitBlock=__vite__wasmModule.automerge_splitBlock,automerge_joinBlock=__vite__wasmModule.automerge_joinBlock,automerge_updateBlock=__vite__wasmModule.automerge_updateBlock,automerge_getBlock=__vite__wasmModule.automerge_getBlock,automerge_insertObject=__vite__wasmModule.automerge_insertObject,automerge_put=__vite__wasmModule.automerge_put,automerge_putObject=__vite__wasmModule.automerge_putObject,automerge_increment=__vite__wasmModule.automerge_increment,automerge_get=__vite__wasmModule.automerge_get,automerge_getWithType=__vite__wasmModule.automerge_getWithType,automerge_objInfo=__vite__wasmModule.automerge_objInfo,automerge_getAll=__vite__wasmModule.automerge_getAll,automerge_enableFreeze=__vite__wasmModule.automerge_enableFreeze,automerge_registerDatatype=__vite__wasmModule.automerge_registerDatatype,automerge_applyPatches=__vite__wasmModule.automerge_applyPatches,automerge_applyAndReturnPatches=__vite__wasmModule.automerge_applyAndReturnPatches,automerge_diffIncremental=__vite__wasmModule.automerge_diffIncremental,automerge_updateDiffCursor=__vite__wasmModule.automerge_updateDiffCursor,automerge_resetDiffCursor=__vite__wasmModule.automerge_resetDiffCursor,automerge_diff=__vite__wasmModule.automerge_diff,automerge_isolate=__vite__wasmModule.automerge_isolate,automerge_integrate=__vite__wasmModule.automerge_integrate,automerge_length=__vite__wasmModule.automerge_length,automerge_delete=__vite__wasmModule.automerge_delete,automerge_save=__vite__wasmModule.automerge_save,automerge_saveIncremental=__vite__wasmModule.automerge_saveIncremental,automerge_saveSince=__vite__wasmModule.automerge_saveSince,automerge_saveNoCompress=__vite__wasmModule.automerge_saveNoCompress,automerge_saveAndVerify=__vite__wasmModule.automerge_saveAndVerify,automerge_loadIncremental=__vite__wasmModule.automerge_loadIncremental,automerge_applyChanges=__vite__wasmModule.automerge_applyChanges,automerge_getChanges=__vite__wasmModule.automerge_getChanges,automerge_getChangeByHash=__vite__wasmModule.automerge_getChangeByHash,automerge_getChangesAdded=__vite__wasmModule.automerge_getChangesAdded,automerge_getHeads=__vite__wasmModule.automerge_getHeads,automerge_getActorId=__vite__wasmModule.automerge_getActorId,automerge_getLastLocalChange=__vite__wasmModule.automerge_getLastLocalChange,automerge_dump=__vite__wasmModule.automerge_dump,automerge_getMissingDeps=__vite__wasmModule.automerge_getMissingDeps,automerge_receiveSyncMessage=__vite__wasmModule.automerge_receiveSyncMessage,automerge_generateSyncMessage=__vite__wasmModule.automerge_generateSyncMessage,automerge_toJS=__vite__wasmModule.automerge_toJS,automerge_materialize=__vite__wasmModule.automerge_materialize,automerge_getCursor=__vite__wasmModule.automerge_getCursor,automerge_getCursorPosition=__vite__wasmModule.automerge_getCursorPosition,automerge_emptyChange=__vite__wasmModule.automerge_emptyChange,automerge_mark=__vite__wasmModule.automerge_mark,automerge_unmark=__vite__wasmModule.automerge_unmark,automerge_marks=__vite__wasmModule.automerge_marks,automerge_marksAt=__vite__wasmModule.automerge_marksAt,create=__vite__wasmModule.create,load$1=__vite__wasmModule.load,encodeChange$1=__vite__wasmModule.encodeChange,decodeChange$1=__vite__wasmModule.decodeChange,initSyncState$1=__vite__wasmModule.initSyncState,importSyncState=__vite__wasmModule.importSyncState,exportSyncState=__vite__wasmModule.exportSyncState,encodeSyncMessage$1=__vite__wasmModule.encodeSyncMessage,decodeSyncMessage$1=__vite__wasmModule.decodeSyncMessage,encodeSyncState$1=__vite__wasmModule.encodeSyncState,decodeSyncState$1=__vite__wasmModule.decodeSyncState,__wbindgen_malloc=__vite__wasmModule.__wbindgen_malloc,__wbindgen_realloc=__vite__wasmModule.__wbindgen_realloc,__wbindgen_add_to_stack_pointer=__vite__wasmModule.__wbindgen_add_to_stack_pointer,__wbindgen_free=__vite__wasmModule.__wbindgen_free,__wbindgen_exn_store=__vite__wasmModule.__wbindgen_exn_store,wasm$1=Object.freeze(Object.defineProperty({__proto__:null,__wbg_automerge_free,__wbg_syncstate_free,__wbindgen_add_to_stack_pointer,__wbindgen_exn_store,__wbindgen_free,__wbindgen_malloc,__wbindgen_realloc,automerge_applyAndReturnPatches,automerge_applyChanges,automerge_applyPatches,automerge_clone,automerge_commit,automerge_delete,automerge_diff,automerge_diffIncremental,automerge_dump,automerge_emptyChange,automerge_enableFreeze,automerge_fork,automerge_generateSyncMessage,automerge_get,automerge_getActorId,automerge_getAll,automerge_getBlock,automerge_getChangeByHash,automerge_getChanges,automerge_getChangesAdded,automerge_getCursor,automerge_getCursorPosition,automerge_getHeads,automerge_getLastLocalChange,automerge_getMissingDeps,automerge_getWithType,automerge_increment,automerge_insert,automerge_insertObject,automerge_integrate,automerge_isolate,automerge_joinBlock,automerge_keys,automerge_length,automerge_loadIncremental,automerge_mark,automerge_marks,automerge_marksAt,automerge_materialize,automerge_merge,automerge_new,automerge_objInfo,automerge_pendingOps,automerge_push,automerge_pushObject,automerge_put,automerge_putObject,automerge_receiveSyncMessage,automerge_registerDatatype,automerge_resetDiffCursor,automerge_rollback,automerge_save,automerge_saveAndVerify,automerge_saveIncremental,automerge_saveNoCompress,automerge_saveSince,automerge_spans,automerge_splice,automerge_splitBlock,automerge_text,automerge_toJS,automerge_unmark,automerge_updateBlock,automerge_updateDiffCursor,automerge_updateSpans,automerge_updateText,create,decodeChange:decodeChange$1,decodeSyncMessage:decodeSyncMessage$1,decodeSyncState:decodeSyncState$1,encodeChange:encodeChange$1,encodeSyncMessage:encodeSyncMessage$1,encodeSyncState:encodeSyncState$1,exportSyncState,importSyncState,initSyncState:initSyncState$1,load:load$1,memory,syncstate_clone,syncstate_lastSentHeads,syncstate_set_lastSentHeads,syncstate_set_sentHashes,syncstate_sharedHeads},Symbol.toStringTag,{value:"Module"}));__wbg_set_wasm(wasm$1);const wasm=Object.freeze(Object.defineProperty({__proto__:null,Automerge,SyncState,TextRepresentation,__wbg_String_91fba7ded13ba54c,__wbg_apply_0a5aa603881e6d79,__wbg_assign_496d2d14fecafbcf,__wbg_buffer_12d079cc21e14bdb,__wbg_call_27c0f87801dedf93,__wbg_call_b3ca7c6051f9bec1,__wbg_concat_3de229fe4fe90fea,__wbg_crypto_1d1f22824a6a080c,__wbg_defineProperty_cc00e2de8a0f5141,__wbg_deleteProperty_13e721a56f19e842,__wbg_done_298b57d23c0fc80c,__wbg_entries_95cc2c823b285a09,__wbg_error_f851667af71bcfc6,__wbg_for_27c67e2dbdce22f6,__wbg_freeze_cc6bc19f75299986,__wbg_from_89e3fc3ba5e6fb48,__wbg_getRandomValues_3aa56aa6edec874c,__wbg_getTime_2bc4375165f02d15,__wbg_get_bd8e338fbd5f5cc8,__wbg_get_e3c254076557e348,__wbg_globalThis_d1e6af4856ba331b,__wbg_global_207b558942527489,__wbg_instanceof_ArrayBuffer_836825be07d4c9d2,__wbg_instanceof_Date_f65cf97fb83fc369,__wbg_instanceof_Object_71ca3c0a59266746,__wbg_instanceof_Uint8Array_2b3bbecd033d19f6,__wbg_isArray_2ab64d95e09ea0ae,__wbg_iterator_2cee6dadfd956dfa,__wbg_keys_91e412b4b222659f,__wbg_length_c20a40f15020d68a,__wbg_length_cd7af8117672b8b8,__wbg_length_dee433d4c85c9387,__wbg_log_1746d5c75ec89963,__wbg_log_5bb5f88f245d7762,__wbg_msCrypto_eb05e62b530a1508,__wbg_new_16b304a2cfa7ff4a,__wbg_new_28c511d9baebfa89,__wbg_new_63b92bc8671ed464,__wbg_new_72fb9a18b5ae2624,__wbg_new_abda76e883ba8a5f,__wbg_new_cf3ec55744a78578,__wbg_new_dd6a5dd7b538af21,__wbg_newnoargs_e258087cd0daa0ea,__wbg_newwithbyteoffsetandlength_aa4a17c33a06e5cb,__wbg_newwithlength_e9b4878cebadb3d3,__wbg_next_196c84450b364254,__wbg_next_40fc327bfc8770e6,__wbg_node_104a2ff8d6ea03a2,__wbg_ownKeys_658942b7f28d1fe9,__wbg_process_4a72847cc503995b,__wbg_push_a5b05aedc7234f9f,__wbg_randomFillSync_5c9c955aa56b6049,__wbg_require_cca90b1a94a0255b,__wbg_self_ce0dbfc45cf2f5be,__wbg_set_1f9b04f170055d33,__wbg_set_20cbc34131e76824,__wbg_set_a47bac70306a19a7,__wbg_set_d4638f722068f043,__wbg_set_wasm,__wbg_slice_52fb626ffdc8da8f,__wbg_stack_658279fe44541cf6,__wbg_subarray_a1f73cd4b5b42fe1,__wbg_toString_7df3c77999517c20,__wbg_unshift_e22df4b34bcf5070,__wbg_value_d93c65011f51a456,__wbg_values_9c75e6e2bfbdb70d,__wbg_versions_f686565e586dd935,__wbg_window_c6fb939a7f436783,__wbindgen_bigint_from_i64,__wbindgen_bigint_from_u64,__wbindgen_boolean_get,__wbindgen_debug_string,__wbindgen_error_new,__wbindgen_is_array,__wbindgen_is_function,__wbindgen_is_null,__wbindgen_is_object,__wbindgen_is_string,__wbindgen_is_undefined,__wbindgen_json_serialize,__wbindgen_jsval_loose_eq,__wbindgen_memory,__wbindgen_number_get,__wbindgen_number_new,__wbindgen_object_clone_ref,__wbindgen_object_drop_ref,__wbindgen_string_get,__wbindgen_string_new,__wbindgen_throw,create:create$1,decodeChange:decodeChange$2,decodeSyncMessage:decodeSyncMessage$2,decodeSyncState:decodeSyncState$2,encodeChange:encodeChange$2,encodeSyncMessage:encodeSyncMessage$2,encodeSyncState:encodeSyncState$2,exportSyncState:exportSyncState$1,importSyncState:importSyncState$1,initSyncState:initSyncState$2,load:load$2},Symbol.toStringTag,{value:"Module"}));var STATE=Symbol.for("_am_meta"),TRACE=Symbol.for("_am_trace"),OBJECT_ID=Symbol.for("_am_objectId"),IS_PROXY=Symbol.for("_am_isProxy"),CLEAR_CACHE=Symbol.for("_am_clearCache"),UINT=Symbol.for("_am_uint"),INT=Symbol.for("_am_int"),F64=Symbol.for("_am_f64"),COUNTER=Symbol.for("_am_counter"),TEXT=Symbol.for("_am_text"),Text=class _i{constructor(t){if(typeof t=="string")this.elems=[...t];else if(Array.isArray(t))this.elems=t;else if(t===void 0)this.elems=[];else throw new TypeError(`Unsupported initial value for Text: ${t}`);Reflect.defineProperty(this,TEXT,{value:!0})}get length(){return this.elems.length}get(t){return this.elems[t]}[Symbol.iterator](){const t=this.elems;let r=-1;return{next(){return r+=1,r<t.length?{done:!1,value:t[r]}:{done:!0}}}}toString(){if(!this.str){this.str="";for(const t of this.elems)typeof t=="string"?this.str+=t:this.str+="\uFFFC"}return this.str}toSpans(){if(!this.spans){this.spans=[];let t="";for(const r of this.elems)typeof r=="string"?t+=r:(t.length>0&&(this.spans.push(t),t=""),this.spans.push(r));t.length>0&&this.spans.push(t)}return this.spans}toJSON(){return this.toString()}set(t,r){if(this[STATE])throw new RangeError("object cannot be modified outside of a change block");this.elems[t]=r}insertAt(t,...r){if(this[STATE])throw new RangeError("object cannot be modified outside of a change block");r.every(n=>typeof n=="string")?this.elems.splice(t,0,...r.join("")):this.elems.splice(t,0,...r)}deleteAt(t,r=1){if(this[STATE])throw new RangeError("object cannot be modified outside of a change block");this.elems.splice(t,r)}map(t){this.elems.map(t)}lastIndexOf(t,r){this.elems.lastIndexOf(t,r)}concat(t){return new _i(this.elems.concat(t.elems))}every(t){return this.elems.every(t)}filter(t){return new _i(this.elems.filter(t))}find(t){return this.elems.find(t)}findIndex(t){return this.elems.findIndex(t)}forEach(t){this.elems.forEach(t)}includes(t){return this.elems.includes(t)}indexOf(t){return this.elems.indexOf(t)}join(t){return this.elems.join(t)}reduce(t){this.elems.reduce(t)}reduceRight(t){this.elems.reduceRight(t)}slice(t,r){return new _i(this.elems.slice(t,r))}some(t){return this.elems.some(t)}toLocaleString(){this.toString()}},Counter=class{constructor(e){this.value=e||0,Reflect.defineProperty(this,COUNTER,{value:!0})}valueOf(){return this.value}toString(){return this.valueOf().toString()}toJSON(){return this.value}increment(e){throw new Error("Counters should not be incremented outside of a change callback")}decrement(e){throw new Error("Counters should not be decremented outside of a change callback")}},WriteableCounter=class extends Counter{constructor(e,t,r,n,o){super(e),this.context=t,this.path=r,this.objectId=n,this.key=o}increment(e){return e=typeof e=="number"?e:1,this.context.increment(this.objectId,this.key,e),this.value+=e,this.value}decrement(e){return this.increment(typeof e=="number"?-e:-1)}};function getWriteableCounter(e,t,r,n,o){return new WriteableCounter(e,t,r,n,o)}var RawString=class{constructor(e){this.val=e}toString(){return this.val}toJSON(){return this.val}},Int=class{constructor(e){if(!(Number.isInteger(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER))throw new RangeError(`Value ${e} cannot be a uint`);this.value=e,Reflect.defineProperty(this,INT,{value:!0}),Object.freeze(this)}},Uint=class{constructor(e){if(!(Number.isInteger(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=0))throw new RangeError(`Value ${e} cannot be a uint`);this.value=e,Reflect.defineProperty(this,UINT,{value:!0}),Object.freeze(this)}},Float64=class{constructor(e){if(typeof e!="number")throw new RangeError(`Value ${e} cannot be a float64`);this.value=e||0,Reflect.defineProperty(this,F64,{value:!0}),Object.freeze(this)}};function parseListIndex(e){if(typeof e=="string"&&/^[0-9]+$/.test(e)&&(e=parseInt(e,10)),typeof e!="number")return e;if(e<0||isNaN(e)||e===1/0||e===-1/0)throw new RangeError("A list index must be positive, but you passed "+e);return e}function valueAt(e,t){const{context:r,objectId:n,path:o,textV2:s}=e,a=r.getWithType(n,t);if(a===null)return;const c=a[0],l=a[1];switch(c){case void 0:return;case"map":return mapProxy(r,l,s,[...o,t]);case"list":return listProxy(r,l,s,[...o,t]);case"text":return s?r.text(l):textProxy(r,l,[...o,t]);case"str":return l;case"uint":return l;case"int":return l;case"f64":return l;case"boolean":return l;case"null":return null;case"bytes":return l;case"timestamp":return l;case"counter":return getWriteableCounter(l,r,o,n,t);default:throw RangeError(`datatype ${c} unimplemented`)}}function import_value(e,t,r){switch(typeof e){case"object":if(e==null)return[null,"null"];if(e[UINT])return[e.value,"uint"];if(e[INT])return[e.value,"int"];if(e[F64])return[e.value,"f64"];if(e[COUNTER])return[e.value,"counter"];if(e instanceof Date)return[e.getTime(),"timestamp"];if(e instanceof RawString)return[e.toString(),"str"];if(e instanceof Text)return[e,"text"];if(e instanceof Uint8Array)return[e,"bytes"];if(e instanceof Array)return[e,"list"];if(Object.getPrototypeOf(e)===Object.getPrototypeOf({}))return[e,"map"];throw isSameDocument(e,context)?new RangeError("Cannot create a reference to an existing document object"):new RangeError(`Cannot assign unknown object: ${e}`);case"boolean":return[e,"boolean"];case"number":return Number.isInteger(e)?[e,"int"]:[e,"f64"];case"string":return t?[e,"text"]:[e,"str"];default:throw new RangeError(`Unsupported type ${typeof e} for path ${printPath(r)}`)}}function isSameDocument(e,t){var r,n;return e instanceof Date?!1:!!(e&&((n=(r=e[STATE])===null||r===void 0?void 0:r.handle)===null||n===void 0?void 0:n.__wbg_ptr)===t.__wbg_ptr)}var MapHandler={get(e,t){const{context:r,objectId:n,cache:o}=e;return t===Symbol.toStringTag?e[Symbol.toStringTag]:t===OBJECT_ID?n:t===IS_PROXY?!0:t===TRACE?e.trace:t===STATE?{handle:r,textV2:e.textV2}:(o[t]||(o[t]=valueAt(e,t)),o[t])},set(e,t,r){const{context:n,objectId:o,path:s,textV2:a}=e;if(e.cache={},isSameDocument(r,n))throw new RangeError("Cannot create a reference to an existing document object");if(t===TRACE)return e.trace=r,!0;if(t===CLEAR_CACHE)return!0;const[c,l]=import_value(r,a,[...s,t]);switch(l){case"list":{const h=n.putObject(o,t,[]),u=listProxy(n,h,a,[...s,t]);for(let d=0;d<c.length;d++)u[d]=c[d];break}case"text":{if(a)assertString(c),n.putObject(o,t,c);else{assertText(c);const h=n.putObject(o,t,"");textProxy(n,h,[...s,t]).splice(0,0,...c)}break}case"map":{const h=n.putObject(o,t,{}),u=mapProxy(n,h,a,[...s,t]);for(const d in c)u[d]=c[d];break}default:n.put(o,t,c,l)}return!0},deleteProperty(e,t){const{context:r,objectId:n}=e;return e.cache={},r.delete(n,t),!0},has(e,t){return this.get(e,t)!==void 0},getOwnPropertyDescriptor(e,t){const r=this.get(e,t);if(typeof r<"u")return{configurable:!0,enumerable:!0,value:r}},ownKeys(e){const{context:t,objectId:r}=e,n=t.keys(r);return[...new Set(n)]}},ListHandler={get(e,t){const{context:r,objectId:n}=e;return t=parseListIndex(t),t===Symbol.hasInstance?o=>Array.isArray(o):t===Symbol.toStringTag?e[Symbol.toStringTag]:t===OBJECT_ID?n:t===IS_PROXY?!0:t===TRACE?e.trace:t===STATE?{handle:r}:t==="length"?r.length(n):typeof t=="number"?valueAt(e,t):listMethods(e)[t]},set(e,t,r){const{context:n,objectId:o,path:s,textV2:a}=e;if(t=parseListIndex(t),isSameDocument(r,n))throw new RangeError("Cannot create a reference to an existing document object");if(t===CLEAR_CACHE)return!0;if(t===TRACE)return e.trace=r,!0;if(typeof t=="string")throw new RangeError("list index must be a number");const[c,l]=import_value(r,a,[...s,t]);switch(l){case"list":{let h;t>=n.length(o)?h=n.insertObject(o,t,[]):h=n.putObject(o,t,[]),listProxy(n,h,a,[...s,t]).splice(0,0,...c);break}case"text":{if(a)assertString(c),t>=n.length(o)?n.insertObject(o,t,c):n.putObject(o,t,c);else{let h;assertText(c),t>=n.length(o)?h=n.insertObject(o,t,""):h=n.putObject(o,t,""),textProxy(n,h,[...s,t]).splice(0,0,...c)}break}case"map":{let h;t>=n.length(o)?h=n.insertObject(o,t,{}):h=n.putObject(o,t,{});const u=mapProxy(n,h,a,[...s,t]);for(const d in c)u[d]=c[d];break}default:t>=n.length(o)?n.insert(o,t,c,l):n.put(o,t,c,l)}return!0},deleteProperty(e,t){const{context:r,objectId:n}=e;t=parseListIndex(t);const o=r.get(n,t);if(o!=null&&o[0]=="counter")throw new TypeError("Unsupported operation: deleting a counter from a list");return r.delete(n,t),!0},has(e,t){const{context:r,objectId:n}=e;return t=parseListIndex(t),typeof t=="number"?t<r.length(n):t==="length"},getOwnPropertyDescriptor(e,t){const{context:r,objectId:n}=e;return t==="length"?{writable:!0,value:r.length(n)}:t===OBJECT_ID?{configurable:!1,enumerable:!1,value:n}:(t=parseListIndex(t),{configurable:!0,enumerable:!0,value:valueAt(e,t)})},getPrototypeOf(e){return Object.getPrototypeOf(e)},ownKeys(){const e=[];return e.push("length"),e}},TextHandler=Object.assign({},ListHandler,{get(e,t){const{context:r,objectId:n}=e;return t=parseListIndex(t),t===Symbol.hasInstance?o=>Array.isArray(o):t===Symbol.toStringTag?e[Symbol.toStringTag]:t===OBJECT_ID?n:t===IS_PROXY?!0:t===TRACE?e.trace:t===STATE?{handle:r}:t==="length"?r.length(n):typeof t=="number"?valueAt(e,t):textMethods(e)[t]||listMethods(e)[t]},getPrototypeOf(){return Object.getPrototypeOf(new Text)}});function mapProxy(e,t,r,n){const o={context:e,objectId:t,path:n||[],cache:{},textV2:r},s={};return Object.assign(s,o),new Proxy(s,MapHandler)}function listProxy(e,t,r,n){const o={context:e,objectId:t,path:n||[],cache:{},textV2:r},s=[];return Object.assign(s,o),new Proxy(s,ListHandler)}function textProxy(e,t,r){const n={context:e,objectId:t,path:r||[],cache:{},textV2:!1},o={};return Object.assign(o,n),new Proxy(o,TextHandler)}function rootProxy(e,t){return mapProxy(e,"_root",t,[])}function listMethods(e){const{context:t,objectId:r,path:n,textV2:o}=e;return{deleteAt(s,a){return typeof a=="number"?t.splice(r,s,a):t.delete(r,s),this},fill(s,a,c){const[l,h]=import_value(s,o,[...n,a]),u=t.length(r);a=parseListIndex(a||0),c=parseListIndex(c||u);for(let d=a;d<Math.min(c,u);d++)if(h==="list"||h==="map")t.putObject(r,d,l);else if(h==="text")if(o)assertString(l),t.putObject(r,d,l);else{assertText(l);const f=t.putObject(r,d,""),_=textProxy(t,f,[...n,d]);for(let p=0;p<l.length;p++)_[p]=l.get(p)}else t.put(r,d,l,h);return this},indexOf(s,a=0){const c=t.length(r);for(let l=a;l<c;l++){const h=t.getWithType(r,l);if(h&&(h[1]===s[OBJECT_ID]||h[1]===s))return l}return-1},insertAt(s,...a){return this.splice(s,0,...a),this},pop(){const s=t.length(r);if(s==0)return;const a=valueAt(e,s-1);return t.delete(r,s-1),a},push(...s){const a=t.length(r);return this.splice(a,0,...s),t.length(r)},shift(){if(t.length(r)==0)return;const s=valueAt(e,0);return t.delete(r,0),s},splice(s,a,...c){s=parseListIndex(s),typeof a!="number"&&(a=t.length(r)-s),a=parseListIndex(a);for(const u of c)if(isSameDocument(u,t))throw new RangeError("Cannot create a reference to an existing document object");const l=[];for(let u=0;u<a;u++){const d=valueAt(e,s);d!==void 0&&l.push(d),t.delete(r,s)}const h=c.map((u,d)=>{try{return import_value(u,o,[...n])}catch(f){throw f instanceof RangeError?new RangeError(`${f.message} at index ${d} in the input`):f}});for(const[u,d]of h){switch(d){case"list":{const f=t.insertObject(r,s,[]);listProxy(t,f,o,[...n,s]).splice(0,0,...u);break}case"text":{if(o)assertString(u),t.insertObject(r,s,u);else{const f=t.insertObject(r,s,"");textProxy(t,f,[...n,s]).splice(0,0,...u)}break}case"map":{const f=t.insertObject(r,s,{}),_=mapProxy(t,f,o,[...n,s]);for(const p in u)_[p]=u[p];break}default:t.insert(r,s,u,d)}s+=1}return l},unshift(...s){return this.splice(0,0,...s),t.length(r)},entries(){let s=0;return{next:()=>{const a=valueAt(e,s);return a===void 0?{value:void 0,done:!0}:{value:[s++,a],done:!1}},[Symbol.iterator](){return this}}},keys(){let s=0;const a=t.length(r);return{next:()=>s<a?{value:s++,done:!1}:{value:void 0,done:!0},[Symbol.iterator](){return this}}},values(){let s=0;return{next:()=>{const a=valueAt(e,s++);return a===void 0?{value:void 0,done:!0}:{value:a,done:!1}},[Symbol.iterator](){return this}}},toArray(){const s=[];let a;do a=valueAt(e,s.length),a!==void 0&&s.push(a);while(a!==void 0);return s},map(s){return this.toArray().map(s)},toString(){return this.toArray().toString()},toLocaleString(){return this.toArray().toLocaleString()},forEach(s){return this.toArray().forEach(s)},concat(s){return this.toArray().concat(s)},every(s){return this.toArray().every(s)},filter(s){return this.toArray().filter(s)},find(s){let a=0;for(const c of this){if(s(c,a))return c;a+=1}},findIndex(s){let a=0;for(const c of this){if(s(c,a))return a;a+=1}return-1},includes(s){return this.find(a=>a===s)!==void 0},join(s){return this.toArray().join(s)},reduce(s,a){return this.toArray().reduce(s,a)},reduceRight(s,a){return this.toArray().reduceRight(s,a)},lastIndexOf(s,a=1/0){return this.toArray().lastIndexOf(s,a)},slice(s,a){return this.toArray().slice(s,a)},some(s){let a=0;for(const c of this){if(s(c,a))return!0;a+=1}return!1},[Symbol.iterator]:function*(){let s=0,a=valueAt(e,s);for(;a!==void 0;)yield a,s+=1,a=valueAt(e,s)}}}function textMethods(e){const{context:t,objectId:r}=e;return{set(n,o){return this[n]=o},get(n){return this[n]},toString(){return t.text(r).replace(/￼/g,"")},toSpans(){const n=[];let o="";const s=t.length(r);for(let a=0;a<s;a++){const c=this[a];typeof c=="string"?o+=c:(o.length>0&&(n.push(o),o=""),n.push(c))}return o.length>0&&n.push(o),n},toJSON(){return this.toString()},indexOf(n,o=0){return t.text(r).indexOf(n,o)},insertAt(n,...o){o.every(s=>typeof s=="string")?t.splice(r,n,0,o.join("")):listMethods(e).insertAt(n,...o)}}}function assertText(e){if(!(e instanceof Text))throw new Error("value was not a Text instance")}function assertString(e){if(typeof e!="string")throw new Error("value was not a string")}function printPath(e){const t=e.map(r=>{if(typeof r=="number")return r.toString();if(typeof r=="string")return r.replace(/~/g,"~0").replace(/\//g,"~1")});return e.length===0?"":"/"+t.join("/")}function UseApi(e){for(const t in e)ApiHandler[t]=e[t]}var ApiHandler={create(e){throw new RangeError("Automerge.use() not called")},load(e,t){throw new RangeError("Automerge.use() not called (load)")},encodeChange(e){throw new RangeError("Automerge.use() not called (encodeChange)")},decodeChange(e){throw new RangeError("Automerge.use() not called (decodeChange)")},initSyncState(){throw new RangeError("Automerge.use() not called (initSyncState)")},encodeSyncMessage(e){throw new RangeError("Automerge.use() not called (encodeSyncMessage)")},decodeSyncMessage(e){throw new RangeError("Automerge.use() not called (decodeSyncMessage)")},encodeSyncState(e){throw new RangeError("Automerge.use() not called (encodeSyncState)")},decodeSyncState(e){throw new RangeError("Automerge.use() not called (decodeSyncState)")},exportSyncState(e){throw new RangeError("Automerge.use() not called (exportSyncState)")},importSyncState(e){throw new RangeError("Automerge.use() not called (importSyncState)")}};function _state(e,t=!0){if(typeof e!="object")throw new RangeError("must be the document root");const r=Reflect.get(e,STATE);if(r===void 0||r==null||t&&_obj(e)!=="_root")throw new RangeError("must be the document root");return r}function _clear_cache(e){Reflect.set(e,CLEAR_CACHE,!0)}function _trace(e){return Reflect.get(e,TRACE)}function _obj(e){return typeof e!="object"||e===null?null:Reflect.get(e,OBJECT_ID)}function _is_proxy(e){return!!Reflect.get(e,IS_PROXY)}function unstableConflictAt(e,t,r){return conflictAt(e,t,r,!0,(n,o)=>n.text(o))}function conflictAt(e,t,r,n,o){const s=e.getAll(t,r);if(s.length<=1)return;const a={};for(const c of s)switch(c[0]){case"map":a[c[1]]=mapProxy(e,c[1],n,[r]);break;case"list":a[c[1]]=listProxy(e,c[1],n,[r]);break;case"text":a[c[1]]=o(e,c[1]);break;case"str":case"uint":case"int":case"f64":case"boolean":case"bytes":case"null":a[c[2]]=c[1];break;case"counter":a[c[2]]=new Counter(c[1]);break;case"timestamp":a[c[2]]=new Date(c[1]);break;default:throw RangeError(`datatype ${c[0]} unimplemented`)}return a}var __rest=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]]);return r};function insertAt(e,t,...r){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");e.insertAt(t,...r)}function deleteAt(e,t,r){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");e.deleteAt(t,r)}function use(e){UseApi(e)}use(wasm);function getBackend(e){return _state(e).handle}function importOpts(e){return typeof e=="object"?e:{actor:e}}function init(e){const t=importOpts(e),r=!!t.freeze,n=t.patchCallback,o=!t.enableTextV2,s=t.actor,a=ApiHandler.create({actor:s,text_v1:o});a.enableFreeze(!!t.freeze);const c=t.enableTextV2||!1;return registerDatatypes(a,c),a.materialize("/",void 0,{handle:a,heads:void 0,freeze:r,patchCallback:n,textV2:c})}function view(e,t){const r=_state(e),n=r.handle;return r.handle.materialize("/",t,Object.assign(Object.assign({},r),{handle:n,heads:t}))}function clone(e,t){const r=_state(e),n=r.heads,o=importOpts(t),s=r.handle.fork(o.actor,n);s.updateDiffCursor();const a=__rest(r,["heads"]);return a.patchCallback=o.patchCallback,s.applyPatches(e,Object.assign(Object.assign({},a),{handle:s}))}function free(e){return _state(e).handle.free()}function from$1(e,t){return _change(init(t),"from",{},r=>Object.assign(r,e)).newDoc}function change(e,t,r){if(typeof t=="function")return _change(e,"change",{},t).newDoc;if(typeof r=="function")return typeof t=="string"&&(t={message:t}),_change(e,"change",t,r).newDoc;throw RangeError("Invalid args for change")}function changeAt(e,t,r,n){if(typeof r=="function")return _change(e,"changeAt",{},r,t);if(typeof n=="function")return typeof r=="string"&&(r={message:r}),_change(e,"changeAt",r,n,t);throw RangeError("Invalid args for changeAt")}function progressDocument(e,t,r,n){if(r==null)return e;const o=_state(e),s=Object.assign(Object.assign({},o),{heads:void 0}),{value:a,patches:c}=o.handle.applyAndReturnPatches(e,s);if(c.length>0){n==null||n(c,{before:e,after:a,source:t});const l=_state(a);l.mostRecentPatch={before:_state(e).heads,after:l.handle.getHeads(),patches:c,source:t}}return o.heads=r,a}function _change(e,t,r,n,o){if(typeof n!="function")throw new RangeError("invalid change function");const s=_state(e);if(e===void 0||s===void 0)throw new RangeError("must be the document root");if(s.heads)throw new RangeError("Attempting to change an outdated document.  Use Automerge.clone() if you wish to make a writable copy.");if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");let a=s.handle.getHeads();o&&headsEqual(o,a)&&(o=void 0),o&&(s.handle.isolate(o),a=o);try{s.heads=a;const c=rootProxy(s.handle,s.textV2);if(n(c),s.handle.pendingOps()===0)return s.heads=void 0,o&&s.handle.integrate(),{newDoc:e,newHeads:null};{const l=s.handle.commit(r.message,r.time);return s.handle.integrate(),{newDoc:progressDocument(e,t,a,r.patchCallback||s.patchCallback),newHeads:l!=null?[l]:null}}}catch(c){throw s.heads=void 0,s.handle.rollback(),c}}function emptyChange(e,t){t===void 0&&(t={}),typeof t=="string"&&(t={message:t});const r=_state(e);if(r.heads)throw new RangeError("Attempting to change an outdated document.  Use Automerge.clone() if you wish to make a writable copy.");if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");const n=r.handle.getHeads();return r.handle.emptyChange(t.message,t.time),progressDocument(e,"emptyChange",n)}function load(e,t){const r=importOpts(t),n=r.actor,o=r.patchCallback,s=!r.enableTextV2,a=r.unchecked||!1,c=r.allowMissingChanges||!1,l=r.convertRawStringsToText||!1,h=ApiHandler.load(e,{text_v1:s,actor:n,unchecked:a,allowMissingDeps:c,convertRawStringsToText:l});h.enableFreeze(!!r.freeze);const u=r.enableTextV2||!1;return registerDatatypes(h,u),h.materialize("/",void 0,{handle:h,heads:void 0,patchCallback:o,textV2:u})}function loadIncremental(e,t,r){r||(r={});const n=_state(e);if(n.heads)throw new RangeError("Attempting to change an out of date document - set at: "+_trace(e));if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");const o=n.handle.getHeads();return n.handle.loadIncremental(t),progressDocument(e,"loadIncremental",o,r.patchCallback||n.patchCallback)}function saveIncremental(e){const t=_state(e);if(t.heads)throw new RangeError("Attempting to change an out of date document - set at: "+_trace(e));if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");return t.handle.saveIncremental()}function save(e){return _state(e).handle.save()}function merge(e,t){const r=_state(e);if(r.heads)throw new RangeError("Attempting to change an out of date document - set at: "+_trace(e));const n=r.handle.getHeads(),o=_state(t),s=r.handle.getChangesAdded(o.handle);return r.handle.applyChanges(s),progressDocument(e,"merge",n,r.patchCallback)}function getActorId(e){return _state(e).handle.getActorId()}function getLastLocalChange(e){return _state(e).handle.getLastLocalChange()||void 0}function getObjectId(e,t){if(t){const r=_state(e,!1),n=_obj(e);return!r||!n?null:r.handle.get(n,t)}else return _obj(e)}function getChanges(e,t){return _state(t).handle.getChanges(getHeads(e))}function getAllChanges(e){return _state(e).handle.getChanges([])}function applyChanges(e,t,r){const n=_state(e);if(r||(r={}),n.heads)throw new RangeError("Attempting to change an outdated document.  Use Automerge.clone() if you wish to make a writable copy.");if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");const o=n.handle.getHeads();return n.handle.applyChanges(t),n.heads=o,[progressDocument(e,"applyChanges",o,r.patchCallback||n.patchCallback)]}function getHistory(e){const t=_state(e).textV2,r=getAllChanges(e);return r.map((n,o)=>({get change(){return decodeChange(n)},get snapshot(){const[s]=applyChanges(init({enableTextV2:t}),r.slice(0,o+1));return s}}))}function diff(e,t,r){checkHeads(t,"before"),checkHeads(r,"after");const n=_state(e);return n.mostRecentPatch&&equals(n.mostRecentPatch.before,t)&&equals(n.mostRecentPatch.after,r)?n.mostRecentPatch.patches:n.handle.diff(t,r)}function headsEqual(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function checkHeads(e,t){if(!Array.isArray(e))throw new Error(`${t} must be an array`)}function equals(e,t){if(!isObject$2(e)||!isObject$2(t))return e===t;const r=Object.keys(e).sort(),n=Object.keys(t).sort();if(r.length!==n.length)return!1;for(let o=0;o<r.length;o++)if(r[o]!==n[o]||!equals(e[r[o]],t[n[o]]))return!1;return!0}function encodeSyncState(e){const t=ApiHandler.importSyncState(e),r=ApiHandler.encodeSyncState(t);return t.free(),r}function decodeSyncState(e){const t=ApiHandler.decodeSyncState(e),r=ApiHandler.exportSyncState(t);return t.free(),r}function generateSyncMessage(e,t){const r=_state(e),n=ApiHandler.importSyncState(t),o=r.handle.generateSyncMessage(n);return[ApiHandler.exportSyncState(n),o]}function receiveSyncMessage(e,t,r,n){const o=ApiHandler.importSyncState(t);n||(n={});const s=_state(e);if(s.heads)throw new RangeError("Attempting to change an outdated document.  Use Automerge.clone() if you wish to make a writable copy.");if(_is_proxy(e))throw new RangeError("Calls to Automerge.change cannot be nested");const a=s.handle.getHeads();s.handle.receiveSyncMessage(o,r);const c=ApiHandler.exportSyncState(o);return[progressDocument(e,"receiveSyncMessage",a,n.patchCallback||s.patchCallback),c,null]}function initSyncState(){return ApiHandler.exportSyncState(ApiHandler.initSyncState())}function encodeChange(e){return ApiHandler.encodeChange(e)}function decodeChange(e){return ApiHandler.decodeChange(e)}function encodeSyncMessage(e){return ApiHandler.encodeSyncMessage(e)}function decodeSyncMessage(e){return ApiHandler.decodeSyncMessage(e)}function getMissingDeps(e,t){return _state(e).handle.getMissingDeps(t)}function getHeads(e){const t=_state(e);return t.heads||t.handle.getHeads()}function dump(e){_state(e).handle.dump()}function toJS(e){const t=_state(e),r=t.handle.enableFreeze(!1),n=t.handle.materialize();return t.handle.enableFreeze(r),n}function isAutomerge(e){return typeof e=="object"&&e!==null?getObjectId(e)==="_root"&&!!Reflect.get(e,STATE):!1}function isObject$2(e){return typeof e=="object"&&e!==null}function saveSince(e,t){return _state(e).handle.saveSince(t)}function registerDatatypes(e,t){e.registerDatatype("counter",r=>new Counter(r),r=>{if(r instanceof Counter)return r.value}),t?e.registerDatatype("str",r=>new RawString(r),r=>{if(r instanceof RawString)return r.val}):e.registerDatatype("text",r=>new Text(r),r=>{if(r instanceof Text)return r.join("")})}var next_exports={};__export(next_exports,{Counter:()=>Counter,Float64:()=>Float64,Int:()=>Int,RawString:()=>RawString,Uint:()=>Uint,applyChanges:()=>applyChanges,block:()=>block,change:()=>change,changeAt:()=>changeAt,clone:()=>clone2,decodeChange:()=>decodeChange,decodeSyncMessage:()=>decodeSyncMessage,decodeSyncState:()=>decodeSyncState,deleteAt:()=>deleteAt,diff:()=>diff,dump:()=>dump,emptyChange:()=>emptyChange,encodeChange:()=>encodeChange,encodeSyncMessage:()=>encodeSyncMessage,encodeSyncState:()=>encodeSyncState,equals:()=>equals,free:()=>free,from:()=>from2,generateSyncMessage:()=>generateSyncMessage,getActorId:()=>getActorId,getAllChanges:()=>getAllChanges,getBackend:()=>getBackend2,getChanges:()=>getChanges,getConflicts:()=>getConflicts2,getCursor:()=>getCursor,getCursorPosition:()=>getCursorPosition,getHeads:()=>getHeads,getHistory:()=>getHistory,getLastLocalChange:()=>getLastLocalChange,getMissingDeps:()=>getMissingDeps,getObjectId:()=>getObjectId,init:()=>init2,initSyncState:()=>initSyncState,insertAt:()=>insertAt,isAutomerge:()=>isAutomerge,joinBlock:()=>joinBlock,load:()=>load2,loadIncremental:()=>loadIncremental,mark:()=>mark,marks:()=>marks,marksAt:()=>marksAt,merge:()=>merge,receiveSyncMessage:()=>receiveSyncMessage,save:()=>save,saveIncremental:()=>saveIncremental,saveSince:()=>saveSince,spans:()=>spans,splice:()=>splice$2,splitBlock:()=>splitBlock,toJS:()=>toJS,unmark:()=>unmark,updateBlock:()=>updateBlock,updateSpans:()=>updateSpans,updateText:()=>updateText,view:()=>view});var getBackend2=getBackend;function init2(e){const t=importOpts2(e);return t.enableTextV2=!0,init(t)}function clone2(e,t){const r=importOpts2(t);return r.enableTextV2=!0,clone(e,r)}function from2(e,t){const r=importOpts2(t);return r.enableTextV2=!0,from$1(e,r)}function load2(e,t){const r=importOpts2(t);return r.enableTextV2=!0,r.patchCallback?loadIncremental(init(r),e):load(e,r)}function importOpts2(e){return typeof e=="object"?e:{actor:e}}function cursorToIndex(e,t,r){if(typeof r=="string"){if(/^[0-9]+@[0-9a-zA-z]+$/.test(r))return e.handle.getCursorPosition(t,r);throw new RangeError("index must be a number or cursor")}else return r}function splice$2(e,t,r,n,o){const s=absoluteObjPath(e,t,"splice");if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const a=_state(e,!1);_clear_cache(e),r=cursorToIndex(a,s,r);try{return a.handle.splice(s,r,n,o)}catch(c){throw new RangeError(`Cannot splice: ${c}`)}}function updateText(e,t,r){const n=absoluteObjPath(e,t,"updateText");if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const o=_state(e,!1);_clear_cache(e);try{return o.handle.updateText(n,r)}catch(s){throw new RangeError(`Cannot updateText: ${s}`)}}function spans(e,t){const r=_state(e,!1),n=absoluteObjPath(e,t,"spans");try{return r.handle.spans(n,r.heads)}catch(o){throw new RangeError(`Cannot splice: ${o}`)}}function block(e,t,r){const n=absoluteObjPath(e,t,"splitBlock"),o=_state(e,!1);r=cursorToIndex(o,n,r);try{return o.handle.getBlock(n,r)}catch(s){throw new RangeError(`Cannot get block: ${s}`)}}function splitBlock(e,t,r,n){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const o=absoluteObjPath(e,t,"splitBlock"),s=_state(e,!1);_clear_cache(e),r=cursorToIndex(s,o,r);try{s.handle.splitBlock(o,r,n)}catch(a){throw new RangeError(`Cannot splice: ${a}`)}}function joinBlock(e,t,r){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const n=absoluteObjPath(e,t,"joinBlock"),o=_state(e,!1);_clear_cache(e),r=cursorToIndex(o,n,r);try{o.handle.joinBlock(n,r)}catch(s){throw new RangeError(`Cannot joinBlock: ${s}`)}}function updateBlock(e,t,r,n){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const o=absoluteObjPath(e,t,"updateBlock"),s=_state(e,!1);_clear_cache(e),r=cursorToIndex(s,o,r);try{s.handle.updateBlock(o,r,n)}catch(a){throw new RangeError(`Cannot updateBlock: ${a}`)}}function updateSpans(e,t,r){if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const n=absoluteObjPath(e,t,"updateSpans"),o=_state(e,!1);_clear_cache(e);try{o.handle.updateSpans(n,r)}catch(s){throw new RangeError(`Cannot updateBlock: ${s}`)}}function getCursor(e,t,r){const n=absoluteObjPath(e,t,"getCursor"),o=_state(e,!1);try{return o.handle.getCursor(n,r)}catch(s){throw new RangeError(`Cannot getCursor: ${s}`)}}function getCursorPosition(e,t,r){const n=absoluteObjPath(e,t,"getCursorPosition"),o=_state(e,!1);try{return o.handle.getCursorPosition(n,r)}catch(s){throw new RangeError(`Cannot getCursorPosition: ${s}`)}}function mark(e,t,r,n,o){const s=absoluteObjPath(e,t,"mark");if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const a=_state(e,!1);try{return a.handle.mark(s,r,n,o)}catch(c){throw new RangeError(`Cannot mark: ${c}`)}}function unmark(e,t,r,n){const o=absoluteObjPath(e,t,"unmark");if(!_is_proxy(e))throw new RangeError("object cannot be modified outside of a change block");const s=_state(e,!1);try{return s.handle.unmark(o,r,n)}catch(a){throw new RangeError(`Cannot unmark: ${a}`)}}function marks(e,t){const r=absoluteObjPath(e,t,"marks"),n=_state(e,!1);try{return n.handle.marks(r)}catch(o){throw new RangeError(`Cannot call marks(): ${o}`)}}function marksAt(e,t,r){const n=absoluteObjPath(e,t,"marksAt"),o=_state(e,!1);try{return o.handle.marksAt(n,r)}catch(s){throw new RangeError(`Cannot call marksAt(): ${s}`)}}function getConflicts2(e,t){const r=_state(e,!1);if(!r.textV2)throw new Error("use getConflicts for a stable document");const n=_obj(e);if(n!=null)return unstableConflictAt(r.handle,n,t)}function absoluteObjPath(e,t,r){t=t.slice();const n=_obj(e);if(!n)throw new RangeError(`invalid object for ${r}`);return t.unshift(n),t.join("/")}var eventemitter3={exports:{}};(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function o(l,h,u){this.fn=l,this.context=h,this.once=u||!1}function s(l,h,u,d,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var _=new o(u,d||l,f),p=r?r+h:h;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],_]:l._events[p].push(_):(l._events[p]=_,l._eventsCount++),l}function a(l,h){--l._eventsCount===0?l._events=new n:delete l._events[h]}function c(){this._events=new n,this._eventsCount=0}c.prototype.eventNames=function(){var l=[],h,u;if(this._eventsCount===0)return l;for(u in h=this._events)t.call(h,u)&&l.push(r?u.slice(1):u);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},c.prototype.listeners=function(l){var h=r?r+l:l,u=this._events[h];if(!u)return[];if(u.fn)return[u.fn];for(var d=0,f=u.length,_=new Array(f);d<f;d++)_[d]=u[d].fn;return _},c.prototype.listenerCount=function(l){var h=r?r+l:l,u=this._events[h];return u?u.fn?1:u.length:0},c.prototype.emit=function(l,h,u,d,f,_){var p=r?r+l:l;if(!this._events[p])return!1;var y=this._events[p],w=arguments.length,E,x;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),w){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,h),!0;case 3:return y.fn.call(y.context,h,u),!0;case 4:return y.fn.call(y.context,h,u,d),!0;case 5:return y.fn.call(y.context,h,u,d,f),!0;case 6:return y.fn.call(y.context,h,u,d,f,_),!0}for(x=1,E=new Array(w-1);x<w;x++)E[x-1]=arguments[x];y.fn.apply(y.context,E)}else{var B=y.length,P;for(x=0;x<B;x++)switch(y[x].once&&this.removeListener(l,y[x].fn,void 0,!0),w){case 1:y[x].fn.call(y[x].context);break;case 2:y[x].fn.call(y[x].context,h);break;case 3:y[x].fn.call(y[x].context,h,u);break;case 4:y[x].fn.call(y[x].context,h,u,d);break;default:if(!E)for(P=1,E=new Array(w-1);P<w;P++)E[P-1]=arguments[P];y[x].fn.apply(y[x].context,E)}}return!0},c.prototype.on=function(l,h,u){return s(this,l,h,u,!1)},c.prototype.once=function(l,h,u){return s(this,l,h,u,!0)},c.prototype.removeListener=function(l,h,u,d){var f=r?r+l:l;if(!this._events[f])return this;if(!h)return a(this,f),this;var _=this._events[f];if(_.fn)_.fn===h&&(!d||_.once)&&(!u||_.context===u)&&a(this,f);else{for(var p=0,y=[],w=_.length;p<w;p++)(_[p].fn!==h||d&&!_[p].once||u&&_[p].context!==u)&&y.push(_[p]);y.length?this._events[f]=y.length===1?y[0]:y:a(this,f)}return this},c.prototype.removeAllListeners=function(l){var h;return l?(h=r?r+l:l,this._events[h]&&a(this,h)):(this._events=new n,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=r,c.EventEmitter=c,e.exports=c})(eventemitter3);var eventemitter3Exports=eventemitter3.exports;const EventEmitter6=getDefaultExportFromCjs(eventemitter3Exports);var sha256$2={},_md={},_assert={};Object.defineProperty(_assert,"__esModule",{value:!0}),_assert.output=_assert.exists=_assert.hash=_assert.bytes=_assert.bool=_assert.number=_assert.isBytes=void 0;function number(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}_assert.number=number;function bool(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}_assert.bool=bool;function isBytes(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}_assert.isBytes=isBytes;function bytes(e,...t){if(!isBytes(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}_assert.bytes=bytes;function hash(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number(e.outputLen),number(e.blockLen)}_assert.hash=hash;function exists(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}_assert.exists=exists;function output(e,t){bytes(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}_assert.output=output;const assert={number,bool,bytes,hash,exists,output};_assert.default=assert;var utils={},crypto$1={};Object.defineProperty(crypto$1,"__esModule",{value:!0}),crypto$1.crypto=void 0,crypto$1.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.randomBytes=e.wrapXOFConstructorWithOpts=e.wrapConstructorWithOpts=e.wrapConstructor=e.checkOpts=e.Hash=e.concatBytes=e.toBytes=e.utf8ToBytes=e.asyncLoop=e.nextTick=e.hexToBytes=e.bytesToHex=e.byteSwap32=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=e.isBytes=void 0;const t=crypto$1,r=_assert;function n(z){return z instanceof Uint8Array||z!=null&&typeof z=="object"&&z.constructor.name==="Uint8Array"}e.isBytes=n;const o=z=>new Uint8Array(z.buffer,z.byteOffset,z.byteLength);e.u8=o;const s=z=>new Uint32Array(z.buffer,z.byteOffset,Math.floor(z.byteLength/4));e.u32=s;const a=z=>new DataView(z.buffer,z.byteOffset,z.byteLength);e.createView=a;const c=(z,q)=>z<<32-q|z>>>q;e.rotr=c;const l=(z,q)=>z<<q|z>>>32-q>>>0;e.rotl=l,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;const h=z=>z<<24&4278190080|z<<8&16711680|z>>>8&65280|z>>>24&255;e.byteSwap=h,e.byteSwapIfBE=e.isLE?z=>z:z=>(0,e.byteSwap)(z);function u(z){for(let q=0;q<z.length;q++)z[q]=(0,e.byteSwap)(z[q])}e.byteSwap32=u;const d=Array.from({length:256},(z,q)=>q.toString(16).padStart(2,"0"));function f(z){(0,r.bytes)(z);let q="";for(let he=0;he<z.length;he++)q+=d[z[he]];return q}e.bytesToHex=f;const _={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function p(z){if(z>=_._0&&z<=_._9)return z-_._0;if(z>=_._A&&z<=_._F)return z-(_._A-10);if(z>=_._a&&z<=_._f)return z-(_._a-10)}function y(z){if(typeof z!="string")throw new Error("hex string expected, got "+typeof z);const q=z.length,he=q/2;if(q%2)throw new Error("padded hex string expected, got unpadded hex of length "+q);const V=new Uint8Array(he);for(let _e=0,ee=0;_e<he;_e++,ee+=2){const W=p(z.charCodeAt(ee)),re=p(z.charCodeAt(ee+1));if(W===void 0||re===void 0){const ne=z[ee]+z[ee+1];throw new Error('hex string expected, got non-hex character "'+ne+'" at index '+ee)}V[_e]=W*16+re}return V}e.hexToBytes=y;const w=async()=>{};e.nextTick=w;async function E(z,q,he){let V=Date.now();for(let _e=0;_e<z;_e++){he(_e);const ee=Date.now()-V;ee>=0&&ee<q||(await(0,e.nextTick)(),V+=ee)}}e.asyncLoop=E;function x(z){if(typeof z!="string")throw new Error(`utf8ToBytes expected string, got ${typeof z}`);return new Uint8Array(new TextEncoder().encode(z))}e.utf8ToBytes=x;function B(z){return typeof z=="string"&&(z=x(z)),(0,r.bytes)(z),z}e.toBytes=B;function P(...z){let q=0;for(let V=0;V<z.length;V++){const _e=z[V];(0,r.bytes)(_e),q+=_e.length}const he=new Uint8Array(q);for(let V=0,_e=0;V<z.length;V++){const ee=z[V];he.set(ee,_e),_e+=ee.length}return he}e.concatBytes=P;class U{clone(){return this._cloneInto()}}e.Hash=U;const F={}.toString;function G(z,q){if(q!==void 0&&F.call(q)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(z,q)}e.checkOpts=G;function H(z){const q=V=>z().update(B(V)).digest(),he=z();return q.outputLen=he.outputLen,q.blockLen=he.blockLen,q.create=()=>z(),q}e.wrapConstructor=H;function te(z){const q=(V,_e)=>z(_e).update(B(V)).digest(),he=z({});return q.outputLen=he.outputLen,q.blockLen=he.blockLen,q.create=V=>z(V),q}e.wrapConstructorWithOpts=te;function J(z){const q=(V,_e)=>z(_e).update(B(V)).digest(),he=z({});return q.outputLen=he.outputLen,q.blockLen=he.blockLen,q.create=V=>z(V),q}e.wrapXOFConstructorWithOpts=J;function le(z=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(z));throw new Error("crypto.getRandomValues must be defined")}e.randomBytes=le}(utils),Object.defineProperty(_md,"__esModule",{value:!0}),_md.HashMD=_md.Maj=_md.Chi=void 0;const _assert_js_1=_assert,utils_js_1$1=utils;function setBigUint64(e,t,r,n){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,r,n);const o=BigInt(32),s=BigInt(4294967295),a=Number(r>>o&s),c=Number(r&s),l=n?4:0,h=n?0:4;e.setUint32(t+l,a,n),e.setUint32(t+h,c,n)}const Chi=(e,t,r)=>e&t^~e&r;_md.Chi=Chi;const Maj=(e,t,r)=>e&t^e&r^t&r;_md.Maj=Maj;class HashMD extends utils_js_1$1.Hash{constructor(t,r,n,o){super(),this.blockLen=t,this.outputLen=r,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=(0,utils_js_1$1.createView)(this.buffer)}update(t){(0,_assert_js_1.exists)(this);const{view:r,buffer:n,blockLen:o}=this;t=(0,utils_js_1$1.toBytes)(t);const s=t.length;for(let a=0;a<s;){const c=Math.min(o-this.pos,s-a);if(c===o){const l=(0,utils_js_1$1.createView)(t);for(;o<=s-a;a+=o)this.process(l,a);continue}n.set(t.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===o&&(this.process(r,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){(0,_assert_js_1.exists)(this),(0,_assert_js_1.output)(t,this),this.finished=!0;const{buffer:r,view:n,blockLen:o,isLE:s}=this;let{pos:a}=this;r[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>o-a&&(this.process(n,0),a=0);for(let d=a;d<o;d++)r[d]=0;setBigUint64(n,o-8,BigInt(this.length*8),s),this.process(n,0);const c=(0,utils_js_1$1.createView)(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const h=l/4,u=this.get();if(h>u.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<h;d++)c.setUint32(4*d,u[d],s)}digest(){const{buffer:t,outputLen:r}=this;this.digestInto(t);const n=t.slice(0,r);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:r,buffer:n,length:o,finished:s,destroyed:a,pos:c}=this;return t.length=o,t.pos=c,t.finished=s,t.destroyed=a,o%r&&t.buffer.set(n),t}}_md.HashMD=HashMD,Object.defineProperty(sha256$2,"__esModule",{value:!0}),sha256$2.sha224=sha256$2.sha256=void 0;const _md_js_1=_md,utils_js_1=utils,SHA256_K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W=new Uint32Array(64);class SHA256 extends _md_js_1.HashMD{constructor(){super(64,32,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:t,B:r,C:n,D:o,E:s,F:a,G:c,H:l}=this;return[t,r,n,o,s,a,c,l]}set(t,r,n,o,s,a,c,l){this.A=t|0,this.B=r|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=a|0,this.G=c|0,this.H=l|0}process(t,r){for(let d=0;d<16;d++,r+=4)SHA256_W[d]=t.getUint32(r,!1);for(let d=16;d<64;d++){const f=SHA256_W[d-15],_=SHA256_W[d-2],p=(0,utils_js_1.rotr)(f,7)^(0,utils_js_1.rotr)(f,18)^f>>>3,y=(0,utils_js_1.rotr)(_,17)^(0,utils_js_1.rotr)(_,19)^_>>>10;SHA256_W[d]=y+SHA256_W[d-7]+p+SHA256_W[d-16]|0}let{A:n,B:o,C:s,D:a,E:c,F:l,G:h,H:u}=this;for(let d=0;d<64;d++){const f=(0,utils_js_1.rotr)(c,6)^(0,utils_js_1.rotr)(c,11)^(0,utils_js_1.rotr)(c,25),_=u+f+(0,_md_js_1.Chi)(c,l,h)+SHA256_K[d]+SHA256_W[d]|0,p=((0,utils_js_1.rotr)(n,2)^(0,utils_js_1.rotr)(n,13)^(0,utils_js_1.rotr)(n,22))+(0,_md_js_1.Maj)(n,o,s)|0;u=h,h=l,l=c,c=a+_|0,a=s,s=o,o=n,n=_+p|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,h=h+this.G|0,u=u+this.H|0,this.set(n,o,s,a,c,l,h,u)}roundClean(){SHA256_W.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class SHA224 extends SHA256{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}sha256$2.sha256=(0,utils_js_1.wrapConstructor)(()=>new SHA256),sha256$2.sha224=(0,utils_js_1.wrapConstructor)(()=>new SHA224);function base$1(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var n=0;n<e.length;n++){var o=e.charAt(n),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=n}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function u(_){if(_ instanceof Uint8Array||(ArrayBuffer.isView(_)?_=new Uint8Array(_.buffer,_.byteOffset,_.byteLength):Array.isArray(_)&&(_=Uint8Array.from(_))),!(_ instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(_.length===0)return"";for(var p=0,y=0,w=0,E=_.length;w!==E&&_[w]===0;)w++,p++;for(var x=(E-w)*h+1>>>0,B=new Uint8Array(x);w!==E;){for(var P=_[w],U=0,F=x-1;(P!==0||U<y)&&F!==-1;F--,U++)P+=256*B[F]>>>0,B[F]=P%a>>>0,P=P/a>>>0;if(P!==0)throw new Error("Non-zero carry");y=U,w++}for(var G=x-y;G!==x&&B[G]===0;)G++;for(var H=c.repeat(p);G<x;++G)H+=e.charAt(B[G]);return H}function d(_){if(typeof _!="string")throw new TypeError("Expected String");if(_.length===0)return new Uint8Array;for(var p=0,y=0,w=0;_[p]===c;)y++,p++;for(var E=(_.length-p)*l+1>>>0,x=new Uint8Array(E);_[p];){var B=t[_.charCodeAt(p)];if(B===255)return;for(var P=0,U=E-1;(B!==0||P<w)&&U!==-1;U--,P++)B+=a*x[U]>>>0,x[U]=B%256>>>0,B=B/256>>>0;if(B!==0)throw new Error("Non-zero carry");w=P,p++}for(var F=E-w;F!==E&&x[F]===0;)F++;for(var G=new Uint8Array(y+(E-F)),H=y;F!==E;)G[H++]=x[F++];return G}function f(_){var p=d(_);if(p)return p;throw new Error("Non-base"+a+" character")}return{encode:u,decodeUnsafe:d,decode:f}}var src$1=base$1;const basex=src$1,ALPHABET="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";var bs58=basex(ALPHABET),base58=bs58,base=function(e){function t(s){var a=Uint8Array.from(s),c=e(a),l=a.length+4,h=new Uint8Array(l);return h.set(a,0),h.set(c.subarray(0,4),a.length),base58.encode(h,l)}function r(s){var a=s.slice(0,-4),c=s.slice(-4),l=e(a);if(!(c[0]^l[0]|c[1]^l[1]|c[2]^l[2]|c[3]^l[3]))return a}function n(s){var a=base58.decodeUnsafe(s);if(a)return r(a)}function o(s){var a=base58.decode(s),c=r(a);if(!c)throw new Error("Invalid checksum");return c}return{encode:t,decode:o,decodeUnsafe:n}},{sha256:sha256$1}=sha256$2,bs58checkBase=base;function sha256x2(e){return sha256$1(sha256$1(e))}var bs58check=bs58checkBase(sha256x2);const bs58check$1=getDefaultExportFromCjs(bs58check);let decoder;try{decoder=new TextDecoder}catch(e){}let src,srcEnd,position$1=0;const LEGACY_RECORD_INLINE_ID=105,RECORD_DEFINITIONS_ID=57342,RECORD_INLINE_ID=57343,BUNDLED_STRINGS_ID=57337,PACKED_REFERENCE_TAG_ID=6,STOP_CODE={};let currentDecoder={},currentStructures,srcString,srcStringStart=0,srcStringEnd=0,bundledStrings$1,referenceMap,currentExtensions=[],currentExtensionRanges=[],packedValues,dataView,restoreMapsAsObject,defaultOptions$1={useRecords:!1,mapsAsObjects:!0},sequentialMode=!1,inlineObjectReadThreshold=2;try{new Function("")}catch(e){inlineObjectReadThreshold=1/0}class Decoder{constructor(t){if(t&&((t.keyMap||t._keyMap)&&!t.useRecords&&(t.useRecords=!1,t.mapsAsObjects=!0),t.useRecords===!1&&t.mapsAsObjects===void 0&&(t.mapsAsObjects=!0),t.getStructures&&(t.getShared=t.getStructures),t.getShared&&!t.structures&&((t.structures=[]).uninitialized=!0),t.keyMap)){this.mapKey=new Map;for(let[r,n]of Object.entries(t.keyMap))this.mapKey.set(n,r)}Object.assign(this,t)}decodeKey(t){return this.keyMap&&this.mapKey.get(t)||t}encodeKey(t){return this.keyMap&&this.keyMap.hasOwnProperty(t)?this.keyMap[t]:t}encodeKeys(t){if(!this._keyMap)return t;let r=new Map;for(let[n,o]of Object.entries(t))r.set(this._keyMap.hasOwnProperty(n)?this._keyMap[n]:n,o);return r}decodeKeys(t){if(!this._keyMap||t.constructor.name!="Map")return t;if(!this._mapKey){this._mapKey=new Map;for(let[n,o]of Object.entries(this._keyMap))this._mapKey.set(o,n)}let r={};return t.forEach((n,o)=>r[safeKey(this._mapKey.has(o)?this._mapKey.get(o):o)]=n),r}mapDecode(t,r){let n=this.decode(t);if(this._keyMap)switch(n.constructor.name){case"Array":return n.map(o=>this.decodeKeys(o))}return n}decode(t,r){if(src)return saveState(()=>(clearSource(),this?this.decode(t,r):Decoder.prototype.decode.call(defaultOptions$1,t,r)));srcEnd=r>-1?r:t.length,position$1=0,srcStringEnd=0,srcString=null,bundledStrings$1=null,src=t;try{dataView=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))}catch(n){throw src=null,t instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(t&&typeof t=="object"?t.constructor.name:typeof t))}if(this instanceof Decoder){if(currentDecoder=this,packedValues=this.sharedValues&&(this.pack?new Array(this.maxPrivatePackedValues||16).concat(this.sharedValues):this.sharedValues),this.structures)return currentStructures=this.structures,checkedRead();(!currentStructures||currentStructures.length>0)&&(currentStructures=[])}else currentDecoder=defaultOptions$1,(!currentStructures||currentStructures.length>0)&&(currentStructures=[]),packedValues=null;return checkedRead()}decodeMultiple(t,r){let n,o=0;try{let s=t.length;sequentialMode=!0;let a=this?this.decode(t,s):defaultDecoder.decode(t,s);if(r){if(r(a)===!1)return;for(;position$1<s;)if(o=position$1,r(checkedRead())===!1)return}else{for(n=[a];position$1<s;)o=position$1,n.push(checkedRead());return n}}catch(s){throw s.lastPosition=o,s.values=n,s}finally{sequentialMode=!1,clearSource()}}}function checkedRead(){try{let e=read();if(bundledStrings$1){if(position$1>=bundledStrings$1.postBundlePosition){let t=new Error("Unexpected bundle position");throw t.incomplete=!0,t}position$1=bundledStrings$1.postBundlePosition,bundledStrings$1=null}if(position$1==srcEnd)currentStructures=null,src=null,referenceMap&&(referenceMap=null);else if(position$1>srcEnd){let t=new Error("Unexpected end of CBOR data");throw t.incomplete=!0,t}else if(!sequentialMode)throw new Error("Data read, but end of buffer not reached");return e}catch(e){throw clearSource(),(e instanceof RangeError||e.message.startsWith("Unexpected end of buffer"))&&(e.incomplete=!0),e}}function read(){let e=src[position$1++],t=e>>5;if(e=e&31,e>23)switch(e){case 24:e=src[position$1++];break;case 25:if(t==7)return getFloat16();e=dataView.getUint16(position$1),position$1+=2;break;case 26:if(t==7){let r=dataView.getFloat32(position$1);if(currentDecoder.useFloat32>2){let n=mult10[(src[position$1]&127)<<1|src[position$1+1]>>7];return position$1+=4,(n*r+(r>0?.5:-.5)>>0)/n}return position$1+=4,r}e=dataView.getUint32(position$1),position$1+=4;break;case 27:if(t==7){let r=dataView.getFloat64(position$1);return position$1+=8,r}if(t>1){if(dataView.getUint32(position$1)>0)throw new Error("JavaScript does not support arrays, maps, or strings with length over 4294967295");e=dataView.getUint32(position$1+4)}else currentDecoder.int64AsNumber?(e=dataView.getUint32(position$1)*4294967296,e+=dataView.getUint32(position$1+4)):e=dataView.getBigUint64(position$1);position$1+=8;break;case 31:switch(t){case 2:case 3:throw new Error("Indefinite length not supported for byte or text strings");case 4:let r=[],n,o=0;for(;(n=read())!=STOP_CODE;)r[o++]=n;return t==4?r:t==3?r.join(""):Buffer.concat(r);case 5:let s;if(currentDecoder.mapsAsObjects){let a={};if(currentDecoder.keyMap)for(;(s=read())!=STOP_CODE;)a[safeKey(currentDecoder.decodeKey(s))]=read();else for(;(s=read())!=STOP_CODE;)a[safeKey(s)]=read();return a}else{restoreMapsAsObject&&(currentDecoder.mapsAsObjects=!0,restoreMapsAsObject=!1);let a=new Map;if(currentDecoder.keyMap)for(;(s=read())!=STOP_CODE;)a.set(currentDecoder.decodeKey(s),read());else for(;(s=read())!=STOP_CODE;)a.set(s,read());return a}case 7:return STOP_CODE;default:throw new Error("Invalid major type for indefinite length "+t)}default:throw new Error("Unknown token "+e)}switch(t){case 0:return e;case 1:return~e;case 2:return readBin(e);case 3:if(srcStringEnd>=position$1)return srcString.slice(position$1-srcStringStart,(position$1+=e)-srcStringStart);if(srcStringEnd==0&&srcEnd<140&&e<32){let o=e<16?shortStringInJS(e):longStringInJS(e);if(o!=null)return o}return readFixedString(e);case 4:let r=new Array(e);for(let o=0;o<e;o++)r[o]=read();return r;case 5:if(currentDecoder.mapsAsObjects){let o={};if(currentDecoder.keyMap)for(let s=0;s<e;s++)o[safeKey(currentDecoder.decodeKey(read()))]=read();else for(let s=0;s<e;s++)o[safeKey(read())]=read();return o}else{restoreMapsAsObject&&(currentDecoder.mapsAsObjects=!0,restoreMapsAsObject=!1);let o=new Map;if(currentDecoder.keyMap)for(let s=0;s<e;s++)o.set(currentDecoder.decodeKey(read()),read());else for(let s=0;s<e;s++)o.set(read(),read());return o}case 6:if(e>=BUNDLED_STRINGS_ID){let o=currentStructures[e&8191];if(o)return o.read||(o.read=createStructureReader(o)),o.read();if(e<65536){if(e==RECORD_INLINE_ID){let s=readJustLength(),a=read(),c=read();recordDefinition(a,c);let l={};if(currentDecoder.keyMap)for(let h=2;h<s;h++){let u=currentDecoder.decodeKey(c[h-2]);l[safeKey(u)]=read()}else for(let h=2;h<s;h++){let u=c[h-2];l[safeKey(u)]=read()}return l}else if(e==RECORD_DEFINITIONS_ID){let s=readJustLength(),a=read();for(let c=2;c<s;c++)recordDefinition(a++,read());return read()}else if(e==BUNDLED_STRINGS_ID)return readBundleExt();if(currentDecoder.getShared&&(loadShared(),o=currentStructures[e&8191],o))return o.read||(o.read=createStructureReader(o)),o.read()}}let n=currentExtensions[e];if(n)return n.handlesRead?n(read):n(read());{let o=read();for(let s=0;s<currentExtensionRanges.length;s++){let a=currentExtensionRanges[s](e,o);if(a!==void 0)return a}return new Tag(o,e)}case 7:switch(e){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 31:default:let o=(packedValues||getPackedValues())[e];if(o!==void 0)return o;throw new Error("Unknown token "+e)}default:if(isNaN(e)){let o=new Error("Unexpected end of CBOR data");throw o.incomplete=!0,o}throw new Error("Unknown CBOR token "+e)}}const validName=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function createStructureReader(e){function t(){let r=src[position$1++];if(r=r&31,r>23)switch(r){case 24:r=src[position$1++];break;case 25:r=dataView.getUint16(position$1),position$1+=2;break;case 26:r=dataView.getUint32(position$1),position$1+=4;break;default:throw new Error("Expected array header, but got "+src[position$1-1])}let n=this.compiledReader;for(;n;){if(n.propertyCount===r)return n(read);n=n.next}if(this.slowReads++>=inlineObjectReadThreshold){let s=this.length==r?this:this.slice(0,r);return n=currentDecoder.keyMap?new Function("r","return {"+s.map(a=>currentDecoder.decodeKey(a)).map(a=>validName.test(a)?safeKey(a)+":r()":"["+JSON.stringify(a)+"]:r()").join(",")+"}"):new Function("r","return {"+s.map(a=>validName.test(a)?safeKey(a)+":r()":"["+JSON.stringify(a)+"]:r()").join(",")+"}"),this.compiledReader&&(n.next=this.compiledReader),n.propertyCount=r,this.compiledReader=n,n(read)}let o={};if(currentDecoder.keyMap)for(let s=0;s<r;s++)o[safeKey(currentDecoder.decodeKey(this[s]))]=read();else for(let s=0;s<r;s++)o[safeKey(this[s])]=read();return o}return e.slowReads=0,t}function safeKey(e){if(typeof e=="string")return e==="__proto__"?"__proto_":e;if(typeof e=="number"||typeof e=="boolean"||typeof e=="bigint")return e.toString();if(e==null)return e+"";throw new Error("Invalid property name type "+typeof e)}let readFixedString=readStringJS;function readStringJS(e){let t;if(e<16&&(t=shortStringInJS(e)))return t;if(e>64&&decoder)return decoder.decode(src.subarray(position$1,position$1+=e));const r=position$1+e,n=[];for(t="";position$1<r;){const o=src[position$1++];if(!(o&128))n.push(o);else if((o&224)===192){const s=src[position$1++]&63;n.push((o&31)<<6|s)}else if((o&240)===224){const s=src[position$1++]&63,a=src[position$1++]&63;n.push((o&31)<<12|s<<6|a)}else if((o&248)===240){const s=src[position$1++]&63,a=src[position$1++]&63,c=src[position$1++]&63;let l=(o&7)<<18|s<<12|a<<6|c;l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|l&1023),n.push(l)}else n.push(o);n.length>=4096&&(t+=fromCharCode.apply(String,n),n.length=0)}return n.length>0&&(t+=fromCharCode.apply(String,n)),t}let fromCharCode=String.fromCharCode;function longStringInJS(e){let t=position$1,r=new Array(e);for(let n=0;n<e;n++){const o=src[position$1++];if((o&128)>0){position$1=t;return}r[n]=o}return fromCharCode.apply(String,r)}function shortStringInJS(e){if(e<4)if(e<2){if(e===0)return"";{let t=src[position$1++];if((t&128)>1){position$1-=1;return}return fromCharCode(t)}}else{let t=src[position$1++],r=src[position$1++];if((t&128)>0||(r&128)>0){position$1-=2;return}if(e<3)return fromCharCode(t,r);let n=src[position$1++];if((n&128)>0){position$1-=3;return}return fromCharCode(t,r,n)}else{let t=src[position$1++],r=src[position$1++],n=src[position$1++],o=src[position$1++];if((t&128)>0||(r&128)>0||(n&128)>0||(o&128)>0){position$1-=4;return}if(e<6){if(e===4)return fromCharCode(t,r,n,o);{let s=src[position$1++];if((s&128)>0){position$1-=5;return}return fromCharCode(t,r,n,o,s)}}else if(e<8){let s=src[position$1++],a=src[position$1++];if((s&128)>0||(a&128)>0){position$1-=6;return}if(e<7)return fromCharCode(t,r,n,o,s,a);let c=src[position$1++];if((c&128)>0){position$1-=7;return}return fromCharCode(t,r,n,o,s,a,c)}else{let s=src[position$1++],a=src[position$1++],c=src[position$1++],l=src[position$1++];if((s&128)>0||(a&128)>0||(c&128)>0||(l&128)>0){position$1-=8;return}if(e<10){if(e===8)return fromCharCode(t,r,n,o,s,a,c,l);{let h=src[position$1++];if((h&128)>0){position$1-=9;return}return fromCharCode(t,r,n,o,s,a,c,l,h)}}else if(e<12){let h=src[position$1++],u=src[position$1++];if((h&128)>0||(u&128)>0){position$1-=10;return}if(e<11)return fromCharCode(t,r,n,o,s,a,c,l,h,u);let d=src[position$1++];if((d&128)>0){position$1-=11;return}return fromCharCode(t,r,n,o,s,a,c,l,h,u,d)}else{let h=src[position$1++],u=src[position$1++],d=src[position$1++],f=src[position$1++];if((h&128)>0||(u&128)>0||(d&128)>0||(f&128)>0){position$1-=12;return}if(e<14){if(e===12)return fromCharCode(t,r,n,o,s,a,c,l,h,u,d,f);{let _=src[position$1++];if((_&128)>0){position$1-=13;return}return fromCharCode(t,r,n,o,s,a,c,l,h,u,d,f,_)}}else{let _=src[position$1++],p=src[position$1++];if((_&128)>0||(p&128)>0){position$1-=14;return}if(e<15)return fromCharCode(t,r,n,o,s,a,c,l,h,u,d,f,_,p);let y=src[position$1++];if((y&128)>0){position$1-=15;return}return fromCharCode(t,r,n,o,s,a,c,l,h,u,d,f,_,p,y)}}}}}function readBin(e){return currentDecoder.copyBuffers?Uint8Array.prototype.slice.call(src,position$1,position$1+=e):src.subarray(position$1,position$1+=e)}let f32Array=new Float32Array(1),u8Array=new Uint8Array(f32Array.buffer,0,4);function getFloat16(){let e=src[position$1++],t=src[position$1++],r=(e&127)>>2;if(r===31)return t||e&3?NaN:e&128?-1/0:1/0;if(r===0){let n=((e&3)<<8|t)/16777216;return e&128?-n:n}return u8Array[3]=e&128|(r>>1)+56,u8Array[2]=(e&7)<<5|t>>3,u8Array[1]=t<<5,u8Array[0]=0,f32Array[0]}new Array(4096);class Tag{constructor(t,r){this.value=t,this.tag=r}}currentExtensions[0]=e=>new Date(e),currentExtensions[1]=e=>new Date(Math.round(e*1e3)),currentExtensions[2]=e=>{let t=BigInt(0);for(let r=0,n=e.byteLength;r<n;r++)t=BigInt(e[r])+t<<BigInt(8);return t},currentExtensions[3]=e=>BigInt(-1)-currentExtensions[2](e),currentExtensions[4]=e=>+(e[1]+"e"+e[0]),currentExtensions[5]=e=>e[1]*Math.exp(e[0]*Math.log(2));const recordDefinition=(e,t)=>{e=e-57344;let r=currentStructures[e];r&&r.isShared&&((currentStructures.restoreStructures||(currentStructures.restoreStructures=[]))[e]=r),currentStructures[e]=t,t.read=createStructureReader(t)};currentExtensions[LEGACY_RECORD_INLINE_ID]=e=>{let t=e.length,r=e[1];recordDefinition(e[0],r);let n={};for(let o=2;o<t;o++){let s=r[o-2];n[safeKey(s)]=e[o]}return n},currentExtensions[14]=e=>bundledStrings$1?bundledStrings$1[0].slice(bundledStrings$1.position0,bundledStrings$1.position0+=e):new Tag(e,14),currentExtensions[15]=e=>bundledStrings$1?bundledStrings$1[1].slice(bundledStrings$1.position1,bundledStrings$1.position1+=e):new Tag(e,15);let glbl={Error,RegExp};currentExtensions[27]=e=>(glbl[e[0]]||Error)(e[1],e[2]);const packedTable=e=>{if(src[position$1++]!=132){let r=new Error("Packed values structure must be followed by a 4 element array");throw src.length<position$1&&(r.incomplete=!0),r}let t=e();if(!t||!t.length){let r=new Error("Packed values structure must be followed by a 4 element array");throw r.incomplete=!0,r}return packedValues=packedValues?t.concat(packedValues.slice(t.length)):t,packedValues.prefixes=e(),packedValues.suffixes=e(),e()};packedTable.handlesRead=!0,currentExtensions[51]=packedTable,currentExtensions[PACKED_REFERENCE_TAG_ID]=e=>{if(!packedValues)if(currentDecoder.getShared)loadShared();else return new Tag(e,PACKED_REFERENCE_TAG_ID);if(typeof e=="number")return packedValues[16+(e>=0?2*e:-2*e-1)];let t=new Error("No support for non-integer packed references yet");throw e===void 0&&(t.incomplete=!0),t},currentExtensions[28]=e=>{referenceMap||(referenceMap=new Map,referenceMap.id=0);let t=referenceMap.id++,r=position$1,n=src[position$1],o;n>>5==4?o=[]:o={};let s={target:o};referenceMap.set(t,s);let a=e();return s.used?(Object.getPrototypeOf(o)!==Object.getPrototypeOf(a)&&(position$1=r,o=a,referenceMap.set(t,{target:o}),a=e()),Object.assign(o,a)):(s.target=a,a)},currentExtensions[28].handlesRead=!0,currentExtensions[29]=e=>{let t=referenceMap.get(e);return t.used=!0,t.target},currentExtensions[258]=e=>new Set(e),(currentExtensions[259]=e=>(currentDecoder.mapsAsObjects&&(currentDecoder.mapsAsObjects=!1,restoreMapsAsObject=!0),e())).handlesRead=!0;function combine(e,t){return typeof e=="string"?e+t:e instanceof Array?e.concat(t):Object.assign({},e,t)}function getPackedValues(){if(!packedValues)if(currentDecoder.getShared)loadShared();else throw new Error("No packed values available");return packedValues}const SHARED_DATA_TAG_ID=1399353956;currentExtensionRanges.push((e,t)=>{if(e>=225&&e<=255)return combine(getPackedValues().prefixes[e-224],t);if(e>=28704&&e<=32767)return combine(getPackedValues().prefixes[e-28672],t);if(e>=1879052288&&e<=2147483647)return combine(getPackedValues().prefixes[e-1879048192],t);if(e>=216&&e<=223)return combine(t,getPackedValues().suffixes[e-216]);if(e>=27647&&e<=28671)return combine(t,getPackedValues().suffixes[e-27639]);if(e>=1811940352&&e<=1879048191)return combine(t,getPackedValues().suffixes[e-1811939328]);if(e==SHARED_DATA_TAG_ID)return{packedValues,structures:currentStructures.slice(0),version:t};if(e==55799)return t});const isLittleEndianMachine$1=new Uint8Array(new Uint16Array([1]).buffer)[0]==1,typedArrays=[Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array>"u"?{name:"BigUint64Array"}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array>"u"?{name:"BigInt64Array"}:BigInt64Array,Float32Array,Float64Array],typedArrayTags=[64,68,69,70,71,72,77,78,79,85,86];for(let e=0;e<typedArrays.length;e++)registerTypedArray(typedArrays[e],typedArrayTags[e]);function registerTypedArray(e,t){let r="get"+e.name.slice(0,-5),n;typeof e=="function"?n=e.BYTES_PER_ELEMENT:e=null;for(let o=0;o<2;o++){if(!o&&n==1)continue;let s=n==2?1:n==4?2:n==8?3:0;currentExtensions[o?t:t-4]=n==1||o==isLittleEndianMachine$1?a=>{if(!e)throw new Error("Could not find typed array for code "+t);return!currentDecoder.copyBuffers&&(n===1||n===2&&!(a.byteOffset&1)||n===4&&!(a.byteOffset&3)||n===8&&!(a.byteOffset&7))?new e(a.buffer,a.byteOffset,a.byteLength>>s):new e(Uint8Array.prototype.slice.call(a,0).buffer)}:a=>{if(!e)throw new Error("Could not find typed array for code "+t);let c=new DataView(a.buffer,a.byteOffset,a.byteLength),l=a.length>>s,h=new e(l),u=c[r];for(let d=0;d<l;d++)h[d]=u.call(c,d<<s,o);return h}}}function readBundleExt(){let e=readJustLength(),t=position$1+read();for(let n=2;n<e;n++){let o=readJustLength();position$1+=o}let r=position$1;return position$1=t,bundledStrings$1=[readStringJS(readJustLength()),readStringJS(readJustLength())],bundledStrings$1.position0=0,bundledStrings$1.position1=0,bundledStrings$1.postBundlePosition=position$1,position$1=r,read()}function readJustLength(){let e=src[position$1++]&31;if(e>23)switch(e){case 24:e=src[position$1++];break;case 25:e=dataView.getUint16(position$1),position$1+=2;break;case 26:e=dataView.getUint32(position$1),position$1+=4;break}return e}function loadShared(){if(currentDecoder.getShared){let e=saveState(()=>(src=null,currentDecoder.getShared()))||{},t=e.structures||[];currentDecoder.sharedVersion=e.version,packedValues=currentDecoder.sharedValues=e.packedValues,currentStructures===!0?currentDecoder.structures=currentStructures=t:currentStructures.splice.apply(currentStructures,[0,t.length].concat(t))}}function saveState(e){let t=srcEnd,r=position$1,n=srcStringStart,o=srcStringEnd,s=srcString,a=referenceMap,c=bundledStrings$1,l=new Uint8Array(src.slice(0,srcEnd)),h=currentStructures,u=currentDecoder,d=sequentialMode,f=e();return srcEnd=t,position$1=r,srcStringStart=n,srcStringEnd=o,srcString=s,referenceMap=a,bundledStrings$1=c,src=l,sequentialMode=d,currentStructures=h,currentDecoder=u,dataView=new DataView(src.buffer,src.byteOffset,src.byteLength),f}function clearSource(){src=null,referenceMap=null,currentStructures=null}const mult10=new Array(147);for(let e=0;e<256;e++)mult10[e]=+("1e"+Math.floor(45.15-e*.30103));let defaultDecoder=new Decoder({useRecords:!1});const decode$1=defaultDecoder.decode;defaultDecoder.decodeMultiple;let textEncoder$2;try{textEncoder$2=new TextEncoder}catch(e){}let extensions,extensionClasses;const Buffer$3=typeof globalThis=="object"&&globalThis.Buffer,hasNodeBuffer=typeof Buffer$3<"u",ByteArrayAllocate=hasNodeBuffer?Buffer$3.allocUnsafeSlow:Uint8Array,ByteArray=hasNodeBuffer?Buffer$3:Uint8Array,MAX_STRUCTURES=256,MAX_BUFFER_SIZE=hasNodeBuffer?4294967296:2144337920;let throwOnIterable,target,targetView,position=0,safeEnd,bundledStrings=null;const MAX_BUNDLE_SIZE=61440,hasNonLatin=/[\u0080-\uFFFF]/,RECORD_SYMBOL=Symbol("record-id");class Encoder extends Decoder{constructor(t){super(t),this.offset=0;let r,n,o,s,a;t=t||{};let c=ByteArray.prototype.utf8Write?function(q,he,V){return target.utf8Write(q,he,V)}:textEncoder$2&&textEncoder$2.encodeInto?function(q,he){return textEncoder$2.encodeInto(q,target.subarray(he)).written}:!1,l=this,h=t.structures||t.saveStructures,u=t.maxSharedStructures;if(u==null&&(u=h?128:0),u>8190)throw new Error("Maximum maxSharedStructure is 8190");let d=t.sequential;d&&(u=0),this.structures||(this.structures=[]),this.saveStructures&&(this.saveShared=this.saveStructures);let f,_,p=t.sharedValues,y;if(p){y=Object.create(null);for(let q=0,he=p.length;q<he;q++)y[p[q]]=q}let w=[],E=0,x=0;this.mapEncode=function(q,he){if(this._keyMap&&!this._mapped)switch(q.constructor.name){case"Array":q=q.map(V=>this.encodeKeys(V));break}return this.encode(q,he)},this.encode=function(q,he){if(target||(target=new ByteArrayAllocate(8192),targetView=new DataView(target.buffer,0,8192),position=0),safeEnd=target.length-10,safeEnd-position<2048?(target=new ByteArrayAllocate(target.length),targetView=new DataView(target.buffer,0,target.length),safeEnd=target.length-10,position=0):he===REUSE_BUFFER_MODE&&(position=position+7&2147483640),r=position,l.useSelfDescribedHeader&&(targetView.setUint32(position,3654940416),position+=3),a=l.structuredClone?new Map:null,l.bundleStrings&&typeof q!="string"?(bundledStrings=[],bundledStrings.size=1/0):bundledStrings=null,n=l.structures,n){if(n.uninitialized){let _e=l.getShared()||{};l.structures=n=_e.structures||[],l.sharedVersion=_e.version;let ee=l.sharedValues=_e.packedValues;if(ee){y={};for(let W=0,re=ee.length;W<re;W++)y[ee[W]]=W}}let V=n.length;if(V>u&&!d&&(V=u),!n.transitions){n.transitions=Object.create(null);for(let _e=0;_e<V;_e++){let ee=n[_e];if(!ee)continue;let W,re=n.transitions;for(let ne=0,ge=ee.length;ne<ge;ne++){re[RECORD_SYMBOL]===void 0&&(re[RECORD_SYMBOL]=_e);let de=ee[ne];W=re[de],W||(W=re[de]=Object.create(null)),re=W}re[RECORD_SYMBOL]=_e|1048576}}d||(n.nextId=V)}if(o&&(o=!1),s=n||[],_=y,t.pack){let V=new Map;if(V.values=[],V.encoder=l,V.maxValues=t.maxPrivatePackedValues||(y?16:1/0),V.objectMap=y||!1,V.samplingPackedValues=f,findRepetitiveStrings(q,V),V.values.length>0){target[position++]=216,target[position++]=51,writeArrayHeader(4);let _e=V.values;B(_e),writeArrayHeader(0),writeArrayHeader(0),_=Object.create(y||null);for(let ee=0,W=_e.length;ee<W;ee++)_[_e[ee]]=ee}}throwOnIterable=he&THROW_ON_ITERABLE;try{if(throwOnIterable)return;if(B(q),bundledStrings&&writeBundles(r,B),l.offset=position,a&&a.idsToInsert){position+=a.idsToInsert.length*2,position>safeEnd&&U(position),l.offset=position;let V=insertIds(target.subarray(r,position),a.idsToInsert);return a=null,V}return he&REUSE_BUFFER_MODE?(target.start=r,target.end=position,target):target.subarray(r,position)}finally{if(n){if(x<10&&x++,n.length>u&&(n.length=u),E>1e4)n.transitions=null,x=0,E=0,w.length>0&&(w=[]);else if(w.length>0&&!d){for(let V=0,_e=w.length;V<_e;V++)w[V][RECORD_SYMBOL]=void 0;w=[]}}if(o&&l.saveShared){l.structures.length>u&&(l.structures=l.structures.slice(0,u));let V=target.subarray(r,position);return l.updateSharedData()===!1?l.encode(q):V}he&RESET_BUFFER_MODE&&(position=r)}},this.findCommonStringsToPack=()=>(f=new Map,y||(y=Object.create(null)),q=>{let he=q&&q.threshold||4,V=this.pack?q.maxPrivatePackedValues||16:0;p||(p=this.sharedValues=[]);for(let[_e,ee]of f)ee.count>he&&(y[_e]=V++,p.push(_e),o=!0);for(;this.saveShared&&this.updateSharedData()===!1;);f=null});const B=q=>{position>safeEnd&&(target=U(position));var he=typeof q,V;if(he==="string"){if(_){let re=_[q];if(re>=0){re<16?target[position++]=re+224:(target[position++]=198,re&1?B(15-re>>1):B(re-16>>1));return}else if(f&&!t.pack){let ne=f.get(q);ne?ne.count++:f.set(q,{count:1})}}let _e=q.length;if(bundledStrings&&_e>=4&&_e<1024){if((bundledStrings.size+=_e)>MAX_BUNDLE_SIZE){let ne,ge=(bundledStrings[0]?bundledStrings[0].length*3+bundledStrings[1].length:0)+10;position+ge>safeEnd&&(target=U(position+ge)),target[position++]=217,target[position++]=223,target[position++]=249,target[position++]=bundledStrings.position?132:130,target[position++]=26,ne=position-r,position+=4,bundledStrings.position&&writeBundles(r,B),bundledStrings=["",""],bundledStrings.size=0,bundledStrings.position=ne}let re=hasNonLatin.test(q);bundledStrings[re?0:1]+=q,target[position++]=re?206:207,B(_e);return}let ee;_e<32?ee=1:_e<256?ee=2:_e<65536?ee=3:ee=5;let W=_e*3;if(position+W>safeEnd&&(target=U(position+W)),_e<64||!c){let re,ne,ge,de=position+ee;for(re=0;re<_e;re++)ne=q.charCodeAt(re),ne<128?target[de++]=ne:ne<2048?(target[de++]=ne>>6|192,target[de++]=ne&63|128):(ne&64512)===55296&&((ge=q.charCodeAt(re+1))&64512)===56320?(ne=65536+((ne&1023)<<10)+(ge&1023),re++,target[de++]=ne>>18|240,target[de++]=ne>>12&63|128,target[de++]=ne>>6&63|128,target[de++]=ne&63|128):(target[de++]=ne>>12|224,target[de++]=ne>>6&63|128,target[de++]=ne&63|128);V=de-position-ee}else V=c(q,position+ee,W);V<24?target[position++]=96|V:V<256?(ee<2&&target.copyWithin(position+2,position+1,position+1+V),target[position++]=120,target[position++]=V):V<65536?(ee<3&&target.copyWithin(position+3,position+2,position+2+V),target[position++]=121,target[position++]=V>>8,target[position++]=V&255):(ee<5&&target.copyWithin(position+5,position+3,position+3+V),target[position++]=122,targetView.setUint32(position,V),position+=4),position+=V}else if(he==="number")if(!this.alwaysUseFloat&&q>>>0===q)q<24?target[position++]=q:q<256?(target[position++]=24,target[position++]=q):q<65536?(target[position++]=25,target[position++]=q>>8,target[position++]=q&255):(target[position++]=26,targetView.setUint32(position,q),position+=4);else if(!this.alwaysUseFloat&&q>>0===q)q>=-24?target[position++]=31-q:q>=-256?(target[position++]=56,target[position++]=~q):q>=-65536?(target[position++]=57,targetView.setUint16(position,~q),position+=2):(target[position++]=58,targetView.setUint32(position,~q),position+=4);else{let _e;if((_e=this.useFloat32)>0&&q<4294967296&&q>=-2147483648){target[position++]=250,targetView.setFloat32(position,q);let ee;if(_e<4||(ee=q*mult10[(target[position]&127)<<1|target[position+1]>>7])>>0===ee){position+=4;return}else position--}target[position++]=251,targetView.setFloat64(position,q),position+=8}else if(he==="object")if(!q)target[position++]=246;else{if(a){let ee=a.get(q);if(ee){if(target[position++]=216,target[position++]=29,target[position++]=25,!ee.references){let W=a.idsToInsert||(a.idsToInsert=[]);ee.references=[],W.push(ee)}ee.references.push(position-r),position+=2;return}else a.set(q,{offset:position-r})}let _e=q.constructor;if(_e===Object)P(q);else if(_e===Array){V=q.length,V<24?target[position++]=128|V:writeArrayHeader(V);for(let ee=0;ee<V;ee++)B(q[ee])}else if(_e===Map)if((this.mapsAsObjects?this.useTag259ForMaps!==!1:this.useTag259ForMaps)&&(target[position++]=217,target[position++]=1,target[position++]=3),V=q.size,V<24?target[position++]=160|V:V<256?(target[position++]=184,target[position++]=V):V<65536?(target[position++]=185,target[position++]=V>>8,target[position++]=V&255):(target[position++]=186,targetView.setUint32(position,V),position+=4),l.keyMap)for(let[ee,W]of q)B(l.encodeKey(ee)),B(W);else for(let[ee,W]of q)B(ee),B(W);else{for(let ee=0,W=extensions.length;ee<W;ee++){let re=extensionClasses[ee];if(q instanceof re){let ne=extensions[ee],ge=ne.tag;ge==null&&(ge=ne.getTag&&ne.getTag.call(this,q)),ge<24?target[position++]=192|ge:ge<256?(target[position++]=216,target[position++]=ge):ge<65536?(target[position++]=217,target[position++]=ge>>8,target[position++]=ge&255):ge>-1&&(target[position++]=218,targetView.setUint32(position,ge),position+=4),ne.encode.call(this,q,B,U);return}}if(q[Symbol.iterator]){if(throwOnIterable){let ee=new Error("Iterable should be serialized as iterator");throw ee.iteratorNotHandled=!0,ee}target[position++]=159;for(let ee of q)B(ee);target[position++]=255;return}if(q[Symbol.asyncIterator]||isBlob(q)){let ee=new Error("Iterable/blob should be serialized as iterator");throw ee.iteratorNotHandled=!0,ee}if(this.useToJSON&&q.toJSON){const ee=q.toJSON();if(ee!==q)return B(ee)}P(q)}}else if(he==="boolean")target[position++]=q?245:244;else if(he==="bigint"){if(q<BigInt(1)<<BigInt(64)&&q>=0)target[position++]=27,targetView.setBigUint64(position,q);else if(q>-(BigInt(1)<<BigInt(64))&&q<0)target[position++]=59,targetView.setBigUint64(position,-q-BigInt(1));else if(this.largeBigIntToFloat)target[position++]=251,targetView.setFloat64(position,Number(q));else throw new RangeError(q+" was too large to fit in CBOR 64-bit integer format, set largeBigIntToFloat to convert to float-64");position+=8}else if(he==="undefined")target[position++]=247;else throw new Error("Unknown type: "+he)},P=this.useRecords===!1?this.variableMapSize?q=>{let he=Object.keys(q),V=Object.values(q),_e=he.length;if(_e<24?target[position++]=160|_e:_e<256?(target[position++]=184,target[position++]=_e):_e<65536?(target[position++]=185,target[position++]=_e>>8,target[position++]=_e&255):(target[position++]=186,targetView.setUint32(position,_e),position+=4),l.keyMap)for(let ee=0;ee<_e;ee++)B(l.encodeKey(he[ee])),B(V[ee]);else for(let ee=0;ee<_e;ee++)B(he[ee]),B(V[ee])}:q=>{target[position++]=185;let he=position-r;position+=2;let V=0;if(l.keyMap)for(let _e in q)(typeof q.hasOwnProperty!="function"||q.hasOwnProperty(_e))&&(B(l.encodeKey(_e)),B(q[_e]),V++);else for(let _e in q)(typeof q.hasOwnProperty!="function"||q.hasOwnProperty(_e))&&(B(_e),B(q[_e]),V++);target[he+++r]=V>>8,target[he+r]=V&255}:(q,he)=>{let V,_e=s.transitions||(s.transitions=Object.create(null)),ee=0,W=0,re,ne;if(this.keyMap){ne=Object.keys(q).map(de=>this.encodeKey(de)),W=ne.length;for(let de=0;de<W;de++){let ye=ne[de];V=_e[ye],V||(V=_e[ye]=Object.create(null),ee++),_e=V}}else for(let de in q)(typeof q.hasOwnProperty!="function"||q.hasOwnProperty(de))&&(V=_e[de],V||(_e[RECORD_SYMBOL]&1048576&&(re=_e[RECORD_SYMBOL]&65535),V=_e[de]=Object.create(null),ee++),_e=V,W++);let ge=_e[RECORD_SYMBOL];if(ge!==void 0)ge&=65535,target[position++]=217,target[position++]=ge>>8|224,target[position++]=ge&255;else if(ne||(ne=_e.__keys__||(_e.__keys__=Object.keys(q))),re===void 0?(ge=s.nextId++,ge||(ge=0,s.nextId=1),ge>=MAX_STRUCTURES&&(s.nextId=(ge=u)+1)):ge=re,s[ge]=ne,ge<u){target[position++]=217,target[position++]=ge>>8|224,target[position++]=ge&255,_e=s.transitions;for(let de=0;de<W;de++)(_e[RECORD_SYMBOL]===void 0||_e[RECORD_SYMBOL]&1048576)&&(_e[RECORD_SYMBOL]=ge),_e=_e[ne[de]];_e[RECORD_SYMBOL]=ge|1048576,o=!0}else{if(_e[RECORD_SYMBOL]=ge,targetView.setUint32(position,3655335680),position+=3,ee&&(E+=x*ee),w.length>=MAX_STRUCTURES-u&&(w.shift()[RECORD_SYMBOL]=void 0),w.push(_e),writeArrayHeader(W+2),B(57344+ge),B(ne),he)return;for(let de in q)(typeof q.hasOwnProperty!="function"||q.hasOwnProperty(de))&&B(q[de]);return}if(W<24?target[position++]=128|W:writeArrayHeader(W),!he)for(let de in q)(typeof q.hasOwnProperty!="function"||q.hasOwnProperty(de))&&B(q[de])},U=q=>{let he;if(q>16777216){if(q-r>MAX_BUFFER_SIZE)throw new Error("Encoded buffer would be larger than maximum buffer size");he=Math.min(MAX_BUFFER_SIZE,Math.round(Math.max((q-r)*(q>67108864?1.25:2),4194304)/4096)*4096)}else he=(Math.max(q-r<<2,target.length-1)>>12)+1<<12;let V=new ByteArrayAllocate(he);return targetView=new DataView(V.buffer,0,he),target.copy?target.copy(V,0,r,q):V.set(target.slice(r,q)),position-=r,r=0,safeEnd=V.length-10,target=V};let F=100,G=1e3;this.encodeAsIterable=function(q,he){return le(q,he,H)},this.encodeAsAsyncIterable=function(q,he){return le(q,he,z)};function*H(q,he,V){let _e=q.constructor;if(_e===Object){let ee=l.useRecords!==!1;ee?P(q,!0):writeEntityLength(Object.keys(q).length,160);for(let W in q){let re=q[W];ee||B(W),re&&typeof re=="object"?he[W]?yield*H(re,he[W]):yield*te(re,he,W):B(re)}}else if(_e===Array){let ee=q.length;writeArrayHeader(ee);for(let W=0;W<ee;W++){let re=q[W];re&&(typeof re=="object"||position-r>F)?he.element?yield*H(re,he.element):yield*te(re,he,"element"):B(re)}}else if(q[Symbol.iterator]){target[position++]=159;for(let ee of q)ee&&(typeof ee=="object"||position-r>F)?he.element?yield*H(ee,he.element):yield*te(ee,he,"element"):B(ee);target[position++]=255}else isBlob(q)?(writeEntityLength(q.size,64),yield target.subarray(r,position),yield q,J()):q[Symbol.asyncIterator]?(target[position++]=159,yield target.subarray(r,position),yield q,J(),target[position++]=255):B(q);V&&position>r?yield target.subarray(r,position):position-r>F&&(yield target.subarray(r,position),J())}function*te(q,he,V){let _e=position-r;try{B(q),position-r>F&&(yield target.subarray(r,position),J())}catch(ee){if(ee.iteratorNotHandled)he[V]={},position=r+_e,yield*H.call(this,q,he[V]);else throw ee}}function J(){F=G,l.encode(null,THROW_ON_ITERABLE)}function le(q,he,V){return he&&he.chunkThreshold?F=G=he.chunkThreshold:F=100,q&&typeof q=="object"?(l.encode(null,THROW_ON_ITERABLE),V(q,l.iterateProperties||(l.iterateProperties={}),!0)):[l.encode(q)]}async function*z(q,he){for(let V of H(q,he,!0)){let _e=V.constructor;if(_e===ByteArray||_e===Uint8Array)yield V;else if(isBlob(V)){let ee=V.stream().getReader(),W;for(;!(W=await ee.read()).done;)yield W.value}else if(V[Symbol.asyncIterator])for await(let ee of V)J(),ee?yield*z(ee,he.async||(he.async={})):yield l.encode(ee);else yield V}}}useBuffer(t){target=t,targetView=new DataView(target.buffer,target.byteOffset,target.byteLength),position=0}clearSharedData(){this.structures&&(this.structures=[]),this.sharedValues&&(this.sharedValues=void 0)}updateSharedData(){let t=this.sharedVersion||0;this.sharedVersion=t+1;let r=this.structures.slice(0),n=new SharedData(r,this.sharedValues,this.sharedVersion),o=this.saveShared(n,s=>(s&&s.version||0)==t);return o===!1?(n=this.getShared()||{},this.structures=n.structures||[],this.sharedValues=n.packedValues,this.sharedVersion=n.version,this.structures.nextId=this.structures.length):r.forEach((s,a)=>this.structures[a]=s),o}}function writeEntityLength(e,t){e<24?target[position++]=t|e:e<256?(target[position++]=t|24,target[position++]=e):e<65536?(target[position++]=t|25,target[position++]=e>>8,target[position++]=e&255):(target[position++]=t|26,targetView.setUint32(position,e),position+=4)}class SharedData{constructor(t,r,n){this.structures=t,this.packedValues=r,this.version=n}}function writeArrayHeader(e){e<24?target[position++]=128|e:e<256?(target[position++]=152,target[position++]=e):e<65536?(target[position++]=153,target[position++]=e>>8,target[position++]=e&255):(target[position++]=154,targetView.setUint32(position,e),position+=4)}const BlobConstructor=typeof Blob>"u"?function(){}:Blob;function isBlob(e){if(e instanceof BlobConstructor)return!0;let t=e[Symbol.toStringTag];return t==="Blob"||t==="File"}function findRepetitiveStrings(e,t){switch(typeof e){case"string":if(e.length>3){if(t.objectMap[e]>-1||t.values.length>=t.maxValues)return;let n=t.get(e);if(n)++n.count==2&&t.values.push(e);else if(t.set(e,{count:1}),t.samplingPackedValues){let o=t.samplingPackedValues.get(e);o?o.count++:t.samplingPackedValues.set(e,{count:1})}}break;case"object":if(e)if(e instanceof Array)for(let n=0,o=e.length;n<o;n++)findRepetitiveStrings(e[n],t);else{let n=!t.encoder.useRecords;for(var r in e)e.hasOwnProperty(r)&&(n&&findRepetitiveStrings(r,t),findRepetitiveStrings(e[r],t))}break;case"function":console.log(e)}}const isLittleEndianMachine=new Uint8Array(new Uint16Array([1]).buffer)[0]==1;extensionClasses=[Date,Set,Error,RegExp,Tag,ArrayBuffer,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array>"u"?function(){}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array>"u"?function(){}:BigInt64Array,Float32Array,Float64Array,SharedData],extensions=[{tag:1,encode(e,t){let r=e.getTime()/1e3;(this.useTimestamp32||e.getMilliseconds()===0)&&r>=0&&r<4294967296?(target[position++]=26,targetView.setUint32(position,r),position+=4):(target[position++]=251,targetView.setFloat64(position,r),position+=8)}},{tag:258,encode(e,t){let r=Array.from(e);t(r)}},{tag:27,encode(e,t){t([e.name,e.message])}},{tag:27,encode(e,t){t(["RegExp",e.source,e.flags])}},{getTag(e){return e.tag},encode(e,t){t(e.value)}},{encode(e,t,r){writeBuffer(e,r)}},{getTag(e){if(e.constructor===Uint8Array&&(this.tagUint8Array||hasNodeBuffer&&this.tagUint8Array!==!1))return 64},encode(e,t,r){writeBuffer(e,r)}},typedArrayEncoder(68,1),typedArrayEncoder(69,2),typedArrayEncoder(70,4),typedArrayEncoder(71,8),typedArrayEncoder(72,1),typedArrayEncoder(77,2),typedArrayEncoder(78,4),typedArrayEncoder(79,8),typedArrayEncoder(85,4),typedArrayEncoder(86,8),{encode(e,t){let r=e.packedValues||[],n=e.structures||[];if(r.values.length>0){target[position++]=216,target[position++]=51,writeArrayHeader(4);let o=r.values;t(o),writeArrayHeader(0),writeArrayHeader(0),packedObjectMap=Object.create(sharedPackedObjectMap||null);for(let s=0,a=o.length;s<a;s++)packedObjectMap[o[s]]=s}if(n){targetView.setUint32(position,3655335424),position+=3;let o=n.slice(0);o.unshift(57344),o.push(new Tag(e.version,1399353956)),t(o)}else t(new Tag(e.version,1399353956))}}];function typedArrayEncoder(e,t){return!isLittleEndianMachine&&t>1&&(e-=4),{tag:e,encode:function(r,n){let o=r.byteLength,s=r.byteOffset||0,a=r.buffer||r;n(hasNodeBuffer?Buffer$3.from(a,s,o):new Uint8Array(a,s,o))}}}function writeBuffer(e,t){let r=e.byteLength;r<24?target[position++]=64+r:r<256?(target[position++]=88,target[position++]=r):r<65536?(target[position++]=89,target[position++]=r>>8,target[position++]=r&255):(target[position++]=90,targetView.setUint32(position,r),position+=4),position+r>=target.length&&t(position+r),target.set(e.buffer?e:new Uint8Array(e),position),position+=r}function insertIds(e,t){let r,n=t.length*2,o=e.length-n;t.sort((s,a)=>s.offset>a.offset?1:-1);for(let s=0;s<t.length;s++){let a=t[s];a.id=s;for(let c of a.references)e[c++]=s>>8,e[c]=s&255}for(;r=t.pop();){let s=r.offset;e.copyWithin(s+n,s,o),n-=2;let a=s+n;e[a++]=216,e[a++]=28,o=s}return e}function writeBundles(e,t){targetView.setUint32(bundledStrings.position+e,position-bundledStrings.position-e+1);let r=bundledStrings;bundledStrings=null,t(r[0]),t(r[1])}let defaultEncoder=new Encoder({useRecords:!1});defaultEncoder.encode,defaultEncoder.encodeAsIterable,defaultEncoder.encodeAsAsyncIterable;const REUSE_BUFFER_MODE=512,RESET_BUFFER_MODE=1024,THROW_ON_ITERABLE=2048;var sha256={exports:{}};(function(e){(function(t,r){var n={};r(n);var o=n.default;for(var s in n)o[s]=n[s];e.exports=o})(commonjsGlobal,function(t){t.__esModule=!0,t.digestLength=32,t.blockSize=64;var r=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function n(f,_,p,y,w){for(var E,x,B,P,U,F,G,H,te,J,le,z,q;w>=64;){for(E=_[0],x=_[1],B=_[2],P=_[3],U=_[4],F=_[5],G=_[6],H=_[7],J=0;J<16;J++)le=y+J*4,f[J]=(p[le]&255)<<24|(p[le+1]&255)<<16|(p[le+2]&255)<<8|p[le+3]&255;for(J=16;J<64;J++)te=f[J-2],z=(te>>>17|te<<15)^(te>>>19|te<<13)^te>>>10,te=f[J-15],q=(te>>>7|te<<25)^(te>>>18|te<<14)^te>>>3,f[J]=(z+f[J-7]|0)+(q+f[J-16]|0);for(J=0;J<64;J++)z=(((U>>>6|U<<26)^(U>>>11|U<<21)^(U>>>25|U<<7))+(U&F^~U&G)|0)+(H+(r[J]+f[J]|0)|0)|0,q=((E>>>2|E<<30)^(E>>>13|E<<19)^(E>>>22|E<<10))+(E&x^E&B^x&B)|0,H=G,G=F,F=U,U=P+z|0,P=B,B=x,x=E,E=z+q|0;_[0]+=E,_[1]+=x,_[2]+=B,_[3]+=P,_[4]+=U,_[5]+=F,_[6]+=G,_[7]+=H,y+=64,w-=64}return y}var o=function(){function f(){this.digestLength=t.digestLength,this.blockSize=t.blockSize,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}return f.prototype.reset=function(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this},f.prototype.clean=function(){for(var _=0;_<this.buffer.length;_++)this.buffer[_]=0;for(var _=0;_<this.temp.length;_++)this.temp[_]=0;this.reset()},f.prototype.update=function(_,p){if(p===void 0&&(p=_.length),this.finished)throw new Error("SHA256: can't update because hash was finished.");var y=0;if(this.bytesHashed+=p,this.bufferLength>0){for(;this.bufferLength<64&&p>0;)this.buffer[this.bufferLength++]=_[y++],p--;this.bufferLength===64&&(n(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(p>=64&&(y=n(this.temp,this.state,_,y,p),p%=64);p>0;)this.buffer[this.bufferLength++]=_[y++],p--;return this},f.prototype.finish=function(_){if(!this.finished){var p=this.bytesHashed,y=this.bufferLength,w=p/536870912|0,E=p<<3,x=p%64<56?64:128;this.buffer[y]=128;for(var B=y+1;B<x-8;B++)this.buffer[B]=0;this.buffer[x-8]=w>>>24&255,this.buffer[x-7]=w>>>16&255,this.buffer[x-6]=w>>>8&255,this.buffer[x-5]=w>>>0&255,this.buffer[x-4]=E>>>24&255,this.buffer[x-3]=E>>>16&255,this.buffer[x-2]=E>>>8&255,this.buffer[x-1]=E>>>0&255,n(this.temp,this.state,this.buffer,0,x),this.finished=!0}for(var B=0;B<8;B++)_[B*4+0]=this.state[B]>>>24&255,_[B*4+1]=this.state[B]>>>16&255,_[B*4+2]=this.state[B]>>>8&255,_[B*4+3]=this.state[B]>>>0&255;return this},f.prototype.digest=function(){var _=new Uint8Array(this.digestLength);return this.finish(_),_},f.prototype._saveState=function(_){for(var p=0;p<this.state.length;p++)_[p]=this.state[p]},f.prototype._restoreState=function(_,p){for(var y=0;y<this.state.length;y++)this.state[y]=_[y];this.bytesHashed=p,this.finished=!1,this.bufferLength=0},f}();t.Hash=o;var s=function(){function f(_){this.inner=new o,this.outer=new o,this.blockSize=this.inner.blockSize,this.digestLength=this.inner.digestLength;var p=new Uint8Array(this.blockSize);if(_.length>this.blockSize)new o().update(_).finish(p).clean();else for(var y=0;y<_.length;y++)p[y]=_[y];for(var y=0;y<p.length;y++)p[y]^=54;this.inner.update(p);for(var y=0;y<p.length;y++)p[y]^=106;this.outer.update(p),this.istate=new Uint32Array(8),this.ostate=new Uint32Array(8),this.inner._saveState(this.istate),this.outer._saveState(this.ostate);for(var y=0;y<p.length;y++)p[y]=0}return f.prototype.reset=function(){return this.inner._restoreState(this.istate,this.inner.blockSize),this.outer._restoreState(this.ostate,this.outer.blockSize),this},f.prototype.clean=function(){for(var _=0;_<this.istate.length;_++)this.ostate[_]=this.istate[_]=0;this.inner.clean(),this.outer.clean()},f.prototype.update=function(_){return this.inner.update(_),this},f.prototype.finish=function(_){return this.outer.finished?this.outer.finish(_):(this.inner.finish(_),this.outer.update(_,this.digestLength).finish(_)),this},f.prototype.digest=function(){var _=new Uint8Array(this.digestLength);return this.finish(_),_},f}();t.HMAC=s;function a(f){var _=new o().update(f),p=_.digest();return _.clean(),p}t.hash=a,t.default=a;function c(f,_){var p=new s(f).update(_),y=p.digest();return p.clean(),y}t.hmac=c;function l(f,_,p,y){var w=y[0];if(w===0)throw new Error("hkdf: cannot expand more");_.reset(),w>1&&_.update(f),p&&_.update(p),_.update(y),_.finish(f),y[0]++}var h=new Uint8Array(t.digestLength);function u(f,_,p,y){_===void 0&&(_=h),y===void 0&&(y=32);for(var w=new Uint8Array([1]),E=c(_,f),x=new s(E),B=new Uint8Array(x.digestLength),P=B.length,U=new Uint8Array(y),F=0;F<y;F++)P===B.length&&(l(B,x,p,w),P=0),U[F]=B[P++];return x.clean(),B.fill(0),w.fill(0),U}t.hkdf=u;function d(f,_,p,y){for(var w=new s(f),E=w.digestLength,x=new Uint8Array(4),B=new Uint8Array(E),P=new Uint8Array(E),U=new Uint8Array(y),F=0;F*E<y;F++){var G=F+1;x[0]=G>>>24&255,x[1]=G>>>16&255,x[2]=G>>>8&255,x[3]=G>>>0&255,w.reset(),w.update(_),w.update(x),w.finish(P);for(var H=0;H<E;H++)B[H]=P[H];for(var H=2;H<=p;H++){w.reset(),w.update(P).finish(P);for(var te=0;te<E;te++)B[te]^=P[te]}for(var H=0;H<E&&F*E+H<y;H++)U[F*E+H]=B[H]}for(var F=0;F<E;F++)B[F]=P[F]=0;for(var F=0;F<4;F++)x[F]=0;return w.clean(),U}t.pbkdf2=d})})(sha256);var sha256Exports=sha256.exports;function getGlobal(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function getDevTools(){const e=getGlobal();if(e.__xstate__)return e.__xstate__}var devToolsAdapter=e=>{if(typeof window>"u")return;const t=getDevTools();t&&t.register(e)},Mailbox=class{constructor(e){this._process=e,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(e){const t={value:e,next:null};if(this._current){this._last.next=t,this._last=t;return}this._current=t,this._last=t,this._active&&this.flush()}flush(){for(;this._current;){const e=this._current;this._process(e.value),this._current=e.next}this._last=null}},STATE_DELIMITER=".",TARGETLESS_KEY="",NULL_EVENT="",STATE_IDENTIFIER="#",WILDCARD="*",XSTATE_INIT="xstate.init",XSTATE_STOP="xstate.stop";function createAfterEvent(e,t){return{type:`xstate.after.${e}.${t}`}}function createDoneStateEvent(e,t){return{type:`xstate.done.state.${e}`,output:t}}function createDoneActorEvent(e,t){return{type:`xstate.done.actor.${e}`,output:t}}function createErrorActorEvent(e,t){return{type:`xstate.error.actor.${e}`,error:t}}function createInitEvent(e){return{type:XSTATE_INIT,input:e}}function reportUnhandledError(e){setTimeout(()=>{throw e})}var symbolObservable=typeof Symbol=="function"&&Symbol.observable||"@@observable";function createScheduledEventId(e,t){return`${e.sessionId}.${t}`}var idCounter=0;function createSystem(e,t){const r=new Map,n=new Map,o=new WeakMap,s=new Set,a={},{clock:c,logger:l}=t,h={schedule:(f,_,p,y,w=Math.random().toString(36).slice(2))=>{const E={source:f,target:_,event:p,delay:y,id:w,startedAt:Date.now()},x=createScheduledEventId(f,w);d._snapshot._scheduledEvents[x]=E;const B=c.setTimeout(()=>{delete a[x],delete d._snapshot._scheduledEvents[x],d._relay(f,_,p)},y);a[x]=B},cancel:(f,_)=>{const p=createScheduledEventId(f,_),y=a[p];delete a[p],delete d._snapshot._scheduledEvents[p],c.clearTimeout(y)},cancelAll:f=>{for(const _ in d._snapshot._scheduledEvents){const p=d._snapshot._scheduledEvents[_];p.source===f&&h.cancel(f,p.id)}}},u=f=>{if(!s.size)return;const _={...f,rootId:e.sessionId};s.forEach(p=>{var y;return(y=p.next)==null?void 0:y.call(p,_)})},d={_snapshot:{_scheduledEvents:((t==null?void 0:t.snapshot)&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${idCounter++}`,_register:(f,_)=>(r.set(f,_),f),_unregister:f=>{r.delete(f.sessionId);const _=o.get(f);_!==void 0&&(n.delete(_),o.delete(f))},get:f=>n.get(f),_set:(f,_)=>{const p=n.get(f);if(p&&p!==_)throw new Error(`Actor with system ID '${f}' already exists.`);n.set(f,_),o.set(_,f)},inspect:f=>{s.add(f)},_sendInspectionEvent:u,_relay:(f,_,p)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:f,actorRef:_,event:p}),_._send(p)},scheduler:h,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const f=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const _ in f){const{source:p,target:y,event:w,delay:E,id:x}=f[_];h.schedule(p,y,w,E,x)}},_clock:c,_logger:l};return d}function matchesState(e,t){const r=toStateValue(e),n=toStateValue(t);return typeof n=="string"?typeof r=="string"?n===r:!1:typeof r=="string"?r in n:Object.keys(r).every(o=>o in n?matchesState(r[o],n[o]):!1)}function toStatePath(e){if(isArray$1(e))return e;let t=[],r="";for(let n=0;n<e.length;n++){switch(e.charCodeAt(n)){case 92:r+=e[n+1],n++;continue;case 46:t.push(r),r="";continue}r+=e[n]}return t.push(r),t}function toStateValue(e){if(isMachineSnapshot(e))return e.value;if(typeof e!="string")return e;const t=toStatePath(e);return pathToStateValue(t)}function pathToStateValue(e){if(e.length===1)return e[0];const t={};let r=t;for(let n=0;n<e.length-1;n++)if(n===e.length-2)r[e[n]]=e[n+1];else{const o=r;r={},o[e[n]]=r}return t}function mapValues(e,t){const r={},n=Object.keys(e);for(let o=0;o<n.length;o++){const s=n[o];r[s]=t(e[s],s,e,o)}return r}function toArrayStrict(e){return isArray$1(e)?e:[e]}function toArray(e){return e===void 0?[]:toArrayStrict(e)}function resolveOutput(e,t,r,n){return typeof e=="function"?e({context:t,event:r,self:n}):e}function isArray$1(e){return Array.isArray(e)}function isErrorActorEvent(e){return e.type.startsWith("xstate.error.actor")}function toTransitionConfigArray(e){return toArrayStrict(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function normalizeTarget(e){if(!(e===void 0||e===TARGETLESS_KEY))return toArray(e)}function toObserver(e,t,r){var s,a,c;const n=typeof e=="object",o=n?e:void 0;return{next:(s=n?e.next:e)==null?void 0:s.bind(o),error:(a=n?e.error:t)==null?void 0:a.bind(o),complete:(c=n?e.complete:r)==null?void 0:c.bind(o)}}function createInvokeId(e,t){return`${t}.${e}`}function resolveReferencedActor(e,t){const r=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!r)return e.implementations.actors[t];const[,n,o]=r,s=e.getStateNodeById(o).config.invoke;return(Array.isArray(s)?s[n]:s).src}var $$ACTOR_TYPE=1,ProcessingStatus=function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e}({}),defaultOptions={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1},Actor=class{constructor(e,t){this.logic=e,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new Mailbox(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=ProcessingStatus.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const r={...defaultOptions,...t},{clock:n,logger:o,parent:s,syncSnapshot:a,id:c,systemId:l,inspect:h}=r;this.system=s?s.system:createSystem(this,{clock:n,logger:o}),h&&!s&&this.system.inspect(toObserver(h)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=(t==null?void 0:t.logger)??this.system._logger,this.clock=(t==null?void 0:t.clock)??this.system._clock,this._parent=s,this._syncSnapshot=a,this.options=r,this.src=r.src??e,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:u=>{this._deferred.push(u)},system:this.system,stopChild:u=>{if(u._parent!==this)throw new Error(`Cannot stop child actor ${u.id} of ${this.id} because it is not a child`);u._stop()},emit:u=>{const d=this.eventListeners.get(u.type);if(d)for(const f of Array.from(d))f(u)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),l&&(this._systemId=l,this.system._set(l,this)),this._initState((t==null?void 0:t.snapshot)??(t==null?void 0:t.state)),l&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(e){var t;try{this._snapshot=e?this.logic.restoreSnapshot?this.logic.restoreSnapshot(e,this._actorScope):e:this.logic.getInitialSnapshot(this._actorScope,(t=this.options)==null?void 0:t.input)}catch(r){this._snapshot={status:"error",output:void 0,error:r}}}update(e,t){var n,o;this._snapshot=e;let r;for(;r=this._deferred.shift();)try{r()}catch(s){this._deferred.length=0,this._snapshot={...e,status:"error",error:s}}switch(this._snapshot.status){case"active":for(const s of this.observers)try{(n=s.next)==null||n.call(s,e)}catch(a){reportUnhandledError(a)}break;case"done":for(const s of this.observers)try{(o=s.next)==null||o.call(s,e)}catch(a){reportUnhandledError(a)}this._stopProcedure(),this._complete(),this._doneEvent=createDoneActorEvent(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:t,snapshot:e})}subscribe(e,t,r){var o;const n=toObserver(e,t,r);if(this._processingStatus!==ProcessingStatus.Stopped)this.observers.add(n);else switch(this._snapshot.status){case"done":try{(o=n.complete)==null||o.call(n)}catch(s){reportUnhandledError(s)}break;case"error":{const s=this._snapshot.error;if(!n.error)reportUnhandledError(s);else try{n.error(s)}catch(a){reportUnhandledError(a)}break}}return{unsubscribe:()=>{this.observers.delete(n)}}}on(e,t){let r=this.eventListeners.get(e);r||(r=new Set,this.eventListeners.set(e,r));const n=t.bind(void 0);return r.add(n),{unsubscribe:()=>{r.delete(n)}}}start(){if(this._processingStatus===ProcessingStatus.Running)return this;this._syncSnapshot&&this.subscribe({next:t=>{t.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:t})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=ProcessingStatus.Running;const e=createInitEvent(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:e}),this._snapshot.status){case"done":return this.update(this._snapshot,e),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(t){return this._snapshot={...this._snapshot,status:"error",error:t},this._error(t),this}return this.update(this._snapshot,e),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(e){let t,r;try{t=this.logic.transition(this._snapshot,e,this._actorScope)}catch(n){r={err:n}}if(r){const{err:n}=r;this._snapshot={...this._snapshot,status:"error",error:n},this._error(n);return}this.update(t,e),e.type===XSTATE_STOP&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===ProcessingStatus.Stopped?this:(this.mailbox.clear(),this._processingStatus===ProcessingStatus.NotStarted?(this._processingStatus=ProcessingStatus.Stopped,this):(this.mailbox.enqueue({type:XSTATE_STOP}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){var e;for(const t of this.observers)try{(e=t.complete)==null||e.call(t)}catch(r){reportUnhandledError(r)}this.observers.clear()}_reportError(e){if(!this.observers.size){this._parent||reportUnhandledError(e);return}let t=!1;for(const r of this.observers){const n=r.error;t||(t=!n);try{n==null||n(e)}catch(o){reportUnhandledError(o)}}this.observers.clear(),t&&reportUnhandledError(e)}_error(e){this._stopProcedure(),this._reportError(e),this._parent&&this.system._relay(this,this._parent,createErrorActorEvent(this.id,e))}_stopProcedure(){return this._processingStatus!==ProcessingStatus.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new Mailbox(this._process.bind(this)),this._processingStatus=ProcessingStatus.Stopped,this.system._unregister(this),this)}_send(e){this._processingStatus!==ProcessingStatus.Stopped&&this.mailbox.enqueue(e)}send(e){this.system._relay(void 0,this,e)}attachDevTools(){const{devTools:e}=this.options;e&&(typeof e=="function"?e:devToolsAdapter)(this)}toJSON(){return{xstate$$type:$$ACTOR_TYPE,id:this.id}}getPersistedSnapshot(e){return this.logic.getPersistedSnapshot(this._snapshot,e)}[symbolObservable](){return this}getSnapshot(){return this._snapshot}};function createActor(e,...[t]){return new Actor(e,t)}function resolveCancel(e,t,r,n,{sendId:o}){const s=typeof o=="function"?o(r,n):o;return[t,s]}function executeCancel(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t)})}function cancel(e){function t(r,n){}return t.type="xstate.cancel",t.sendId=e,t.resolve=resolveCancel,t.execute=executeCancel,t}function resolveSpawn(e,t,r,n,{id:o,systemId:s,src:a,input:c,syncSnapshot:l}){const h=typeof a=="string"?resolveReferencedActor(t.machine,a):a,u=typeof o=="function"?o(r):o;let d;return h&&(d=createActor(h,{id:u,src:a,parent:e.self,syncSnapshot:l,systemId:s,input:typeof c=="function"?c({context:t.context,event:r.event,self:e.self}):c})),[cloneMachineSnapshot(t,{children:{...t.children,[u]:d}}),{id:o,actorRef:d}]}function executeSpawn(e,{id:t,actorRef:r}){r&&e.defer(()=>{r._processingStatus!==ProcessingStatus.Stopped&&r.start()})}function spawnChild(...[e,{id:t,systemId:r,input:n,syncSnapshot:o=!1}={}]){function s(a,c){}return s.type="snapshot.spawnChild",s.id=t,s.systemId=r,s.src=e,s.input=n,s.syncSnapshot=o,s.resolve=resolveSpawn,s.execute=executeSpawn,s}function resolveStop(e,t,r,n,{actorRef:o}){const s=typeof o=="function"?o(r,n):o,a=typeof s=="string"?t.children[s]:s;let c=t.children;return a&&(c={...c},delete c[a.id]),[cloneMachineSnapshot(t,{children:c}),a]}function executeStop(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==ProcessingStatus.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function stopChild(e){function t(r,n){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=resolveStop,t.execute=executeStop,t}function evaluateGuard(e,t,r,n){const{machine:o}=n,s=typeof e=="function",a=s?e:o.implementations.guards[typeof e=="string"?e:e.type];if(!s&&!a)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof a!="function")return evaluateGuard(a,t,r,n);const c={context:t,event:r},l=s||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:r}):e.params:void 0;return"check"in a?a.check(n,c,a):a(c,l)}var isAtomicStateNode=e=>e.type==="atomic"||e.type==="final";function getChildren(e){return Object.values(e.states).filter(t=>t.type!=="history")}function getProperAncestors(e,t){const r=[];if(t===e)return r;let n=e.parent;for(;n&&n!==t;)r.push(n),n=n.parent;return r}function getAllStateNodes(e){const t=new Set(e),r=getAdjList(t);for(const n of t)if(n.type==="compound"&&(!r.get(n)||!r.get(n).length))getInitialStateNodesWithTheirAncestors(n).forEach(o=>t.add(o));else if(n.type==="parallel"){for(const o of getChildren(n))if(o.type!=="history"&&!t.has(o)){const s=getInitialStateNodesWithTheirAncestors(o);for(const a of s)t.add(a)}}for(const n of t){let o=n.parent;for(;o;)t.add(o),o=o.parent}return t}function getValueFromAdj(e,t){const r=t.get(e);if(!r)return{};if(e.type==="compound"){const o=r[0];if(o){if(isAtomicStateNode(o))return o.key}else return{}}const n={};for(const o of r)n[o.key]=getValueFromAdj(o,t);return n}function getAdjList(e){const t=new Map;for(const r of e)t.has(r)||t.set(r,[]),r.parent&&(t.has(r.parent)||t.set(r.parent,[]),t.get(r.parent).push(r));return t}function getStateValue(e,t){const r=getAllStateNodes(t);return getValueFromAdj(e,getAdjList(r))}function isInFinalState(e,t){return t.type==="compound"?getChildren(t).some(r=>r.type==="final"&&e.has(r)):t.type==="parallel"?getChildren(t).every(r=>isInFinalState(e,r)):t.type==="final"}var isStateId=e=>e[0]===STATE_IDENTIFIER;function getCandidates(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(r=>{if(r===WILDCARD)return!0;if(!r.endsWith(".*"))return!1;const n=r.split("."),o=t.split(".");for(let s=0;s<n.length;s++){const a=n[s],c=o[s];if(a==="*")return s===n.length-1;if(a!==c)return!1}return!0}).sort((r,n)=>n.length-r.length).flatMap(r=>e.transitions.get(r))}function getDelayedTransitions(e){const t=e.config.after;if(!t)return[];const r=(n,o)=>{const s=createAfterEvent(n,e.id),a=s.type;return e.entry.push(raise(s,{id:a,delay:n})),e.exit.push(cancel(a)),a};return Object.keys(t).flatMap((n,o)=>{const s=t[n],a=typeof s=="string"?{target:s}:s,c=Number.isNaN(+n)?n:+n,l=r(c);return toArray(a).map(h=>({...h,event:l,delay:c}))}).map(n=>{const{delay:o}=n;return{...formatTransition(e,n.event,n),delay:o}})}function formatTransition(e,t,r){const n=normalizeTarget(r.target),o=r.reenter??!1,s=resolveTarget(e,n),a={...r,actions:toArray(r.actions),guard:r.guard,target:s,source:e,reenter:o,eventType:t,toJSON:()=>({...a,source:`#${e.id}`,target:s?s.map(c=>`#${c.id}`):void 0})};return a}function formatTransitions(e){const t=new Map;if(e.config.on)for(const r of Object.keys(e.config.on)){if(r===NULL_EVENT)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const n=e.config.on[r];t.set(r,toTransitionConfigArray(n).map(o=>formatTransition(e,r,o)))}if(e.config.onDone){const r=`xstate.done.state.${e.id}`;t.set(r,toTransitionConfigArray(e.config.onDone).map(n=>formatTransition(e,r,n)))}for(const r of e.invoke){if(r.onDone){const n=`xstate.done.actor.${r.id}`;t.set(n,toTransitionConfigArray(r.onDone).map(o=>formatTransition(e,n,o)))}if(r.onError){const n=`xstate.error.actor.${r.id}`;t.set(n,toTransitionConfigArray(r.onError).map(o=>formatTransition(e,n,o)))}if(r.onSnapshot){const n=`xstate.snapshot.${r.id}`;t.set(n,toTransitionConfigArray(r.onSnapshot).map(o=>formatTransition(e,n,o)))}}for(const r of e.after){let n=t.get(r.eventType);n||(n=[],t.set(r.eventType,n)),n.push(r)}return t}function formatInitialTransition(e,t){const r=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!r&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const n={source:e,actions:!t||typeof t=="string"?[]:toArray(t.actions),eventType:null,reenter:!1,target:r?[r]:[],toJSON:()=>({...n,source:`#${e.id}`,target:r?[`#${r.id}`]:[]})};return n}function resolveTarget(e,t){if(t!==void 0)return t.map(r=>{if(typeof r!="string")return r;if(isStateId(r))return e.machine.getStateNodeById(r);const n=r[0]===STATE_DELIMITER;if(n&&!e.parent)return getStateNodeByPath(e,r.slice(1));const o=n?e.key+r:r;if(e.parent)try{return getStateNodeByPath(e.parent,o)}catch(s){throw new Error(`Invalid transition definition for state node '${e.id}':
${s.message}`)}else throw new Error(`Invalid target: "${r}" is not a valid target from the root node. Did you mean ".${r}"?`)})}function resolveHistoryDefaultTransition(e){const t=normalizeTarget(e.config.target);return t?{target:t.map(r=>typeof r=="string"?getStateNodeByPath(e.parent,r):r)}:e.parent.initial}function isHistoryNode(e){return e.type==="history"}function getInitialStateNodesWithTheirAncestors(e){const t=getInitialStateNodes(e);for(const r of t)for(const n of getProperAncestors(r,e))t.add(n);return t}function getInitialStateNodes(e){const t=new Set;function r(n){if(!t.has(n)){if(t.add(n),n.type==="compound")r(n.initial.target[0]);else if(n.type==="parallel")for(const o of getChildren(n))r(o)}}return r(e),t}function getStateNode(e,t){if(isStateId(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const r=e.states[t];if(!r)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return r}function getStateNodeByPath(e,t){if(typeof t=="string"&&isStateId(t))try{return e.machine.getStateNodeById(t)}catch{}const r=toStatePath(t).slice();let n=e;for(;r.length;){const o=r.shift();if(!o.length)break;n=getStateNode(n,o)}return n}function getStateNodes(e,t){if(typeof t=="string"){const o=e.states[t];if(!o)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,o]}const r=Object.keys(t),n=r.map(o=>getStateNode(e,o)).filter(Boolean);return[e.machine.root,e].concat(n,r.reduce((o,s)=>{const a=getStateNode(e,s);if(!a)return o;const c=getStateNodes(a,t[s]);return o.concat(c)},[]))}function transitionAtomicNode(e,t,r,n){const o=getStateNode(e,t).next(r,n);return!o||!o.length?e.next(r,n):o}function transitionCompoundNode(e,t,r,n){const o=Object.keys(t),s=getStateNode(e,o[0]),a=transitionNode(s,t[o[0]],r,n);return!a||!a.length?e.next(r,n):a}function transitionParallelNode(e,t,r,n){const o=[];for(const s of Object.keys(t)){const a=t[s];if(!a)continue;const c=getStateNode(e,s),l=transitionNode(c,a,r,n);l&&o.push(...l)}return o.length?o:e.next(r,n)}function transitionNode(e,t,r,n){return typeof t=="string"?transitionAtomicNode(e,t,r,n):Object.keys(t).length===1?transitionCompoundNode(e,t,r,n):transitionParallelNode(e,t,r,n)}function getHistoryNodes(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function isDescendant(e,t){let r=e;for(;r.parent&&r.parent!==t;)r=r.parent;return r.parent===t}function hasIntersection(e,t){const r=new Set(e),n=new Set(t);for(const o of r)if(n.has(o))return!0;for(const o of n)if(r.has(o))return!0;return!1}function removeConflictingTransitions(e,t,r){const n=new Set;for(const o of e){let s=!1;const a=new Set;for(const c of n)if(hasIntersection(computeExitSet([o],t,r),computeExitSet([c],t,r)))if(isDescendant(o.source,c.source))a.add(c);else{s=!0;break}if(!s){for(const c of a)n.delete(c);n.add(o)}}return Array.from(n)}function findLeastCommonAncestor(e){const[t,...r]=e;for(const n of getProperAncestors(t,void 0))if(r.every(o=>isDescendant(o,n)))return n}function getEffectiveTargetStates(e,t){if(!e.target)return[];const r=new Set;for(const n of e.target)if(isHistoryNode(n))if(t[n.id])for(const o of t[n.id])r.add(o);else for(const o of getEffectiveTargetStates(resolveHistoryDefaultTransition(n),t))r.add(o);else r.add(n);return[...r]}function getTransitionDomain(e,t){const r=getEffectiveTargetStates(e,t);if(!r)return;if(!e.reenter&&r.every(o=>o===e.source||isDescendant(o,e.source)))return e.source;const n=findLeastCommonAncestor(r.concat(e.source));if(n)return n;if(!e.reenter)return e.source.machine.root}function computeExitSet(e,t,r){var o;const n=new Set;for(const s of e)if((o=s.target)!=null&&o.length){const a=getTransitionDomain(s,r);s.reenter&&s.source===a&&n.add(a);for(const c of t)isDescendant(c,a)&&n.add(c)}return[...n]}function areStateNodeCollectionsEqual(e,t){if(e.length!==t.size)return!1;for(const r of e)if(!t.has(r))return!1;return!0}function microstep(e,t,r,n,o,s){if(!e.length)return t;const a=new Set(t._nodes);let c=t.historyValue;const l=removeConflictingTransitions(e,a,c);let h=t;o||([h,c]=exitStates(h,n,r,l,a,c,s)),h=resolveActionsAndContext(h,n,r,l.flatMap(d=>d.actions),s),h=enterStates(h,n,r,l,a,s,c,o);const u=[...a];h.status==="done"&&(h=resolveActionsAndContext(h,n,r,u.sort((d,f)=>f.order-d.order).flatMap(d=>d.exit),s));try{return c===t.historyValue&&areStateNodeCollectionsEqual(t._nodes,a)?h:cloneMachineSnapshot(h,{_nodes:u,historyValue:c})}catch(d){throw d}}function getMachineOutput(e,t,r,n,o){if(n.output===void 0)return;const s=createDoneStateEvent(o.id,o.output!==void 0&&o.parent?resolveOutput(o.output,e.context,t,r.self):void 0);return resolveOutput(n.output,e.context,s,r.self)}function enterStates(e,t,r,n,o,s,a,c){let l=e;const h=new Set,u=new Set;computeEntrySet(n,a,u,h),c&&u.add(e.machine.root);const d=new Set;for(const f of[...h].sort((_,p)=>_.order-p.order)){o.add(f);const _=[];_.push(...f.entry);for(const p of f.invoke)_.push(spawnChild(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(u.has(f)){const p=f.initial.actions;_.push(...p)}if(l=resolveActionsAndContext(l,t,r,_,s,f.invoke.map(p=>p.id)),f.type==="final"){const p=f.parent;let y=(p==null?void 0:p.type)==="parallel"?p:p==null?void 0:p.parent,w=y||f;for((p==null?void 0:p.type)==="compound"&&s.push(createDoneStateEvent(p.id,f.output!==void 0?resolveOutput(f.output,l.context,t,r.self):void 0));(y==null?void 0:y.type)==="parallel"&&!d.has(y)&&isInFinalState(o,y);)d.add(y),s.push(createDoneStateEvent(y.id)),w=y,y=y.parent;if(y)continue;l=cloneMachineSnapshot(l,{status:"done",output:getMachineOutput(l,t,r,l.machine.root,w)})}}return l}function computeEntrySet(e,t,r,n){for(const o of e){const s=getTransitionDomain(o,t);for(const c of o.target||[])!isHistoryNode(c)&&(o.source!==c||o.source!==s||o.reenter)&&(n.add(c),r.add(c)),addDescendantStatesToEnter(c,t,r,n);const a=getEffectiveTargetStates(o,t);for(const c of a){const l=getProperAncestors(c,s);(s==null?void 0:s.type)==="parallel"&&l.push(s),addAncestorStatesToEnter(n,t,r,l,!o.source.parent&&o.reenter?void 0:s)}}}function addDescendantStatesToEnter(e,t,r,n){var o;if(isHistoryNode(e))if(t[e.id]){const s=t[e.id];for(const a of s)n.add(a),addDescendantStatesToEnter(a,t,r,n);for(const a of s)addProperAncestorStatesToEnter(a,e.parent,n,t,r)}else{const s=resolveHistoryDefaultTransition(e);for(const a of s.target)n.add(a),s===((o=e.parent)==null?void 0:o.initial)&&r.add(e.parent),addDescendantStatesToEnter(a,t,r,n);for(const a of s.target)addProperAncestorStatesToEnter(a,e.parent,n,t,r)}else if(e.type==="compound"){const[s]=e.initial.target;isHistoryNode(s)||(n.add(s),r.add(s)),addDescendantStatesToEnter(s,t,r,n),addProperAncestorStatesToEnter(s,e,n,t,r)}else if(e.type==="parallel")for(const s of getChildren(e).filter(a=>!isHistoryNode(a)))[...n].some(a=>isDescendant(a,s))||(isHistoryNode(s)||(n.add(s),r.add(s)),addDescendantStatesToEnter(s,t,r,n))}function addAncestorStatesToEnter(e,t,r,n,o){for(const s of n)if((!o||isDescendant(s,o))&&e.add(s),s.type==="parallel")for(const a of getChildren(s).filter(c=>!isHistoryNode(c)))[...e].some(c=>isDescendant(c,a))||(e.add(a),addDescendantStatesToEnter(a,t,r,e))}function addProperAncestorStatesToEnter(e,t,r,n,o){addAncestorStatesToEnter(r,n,o,getProperAncestors(e,t))}function exitStates(e,t,r,n,o,s,a){let c=e;const l=computeExitSet(n,o,s);l.sort((u,d)=>d.order-u.order);let h;for(const u of l)for(const d of getHistoryNodes(u)){let f;d.history==="deep"?f=_=>isAtomicStateNode(_)&&isDescendant(_,u):f=_=>_.parent===u,h??(h={...s}),h[d.id]=Array.from(o).filter(f)}for(const u of l)c=resolveActionsAndContext(c,t,r,[...u.exit,...u.invoke.map(d=>stopChild(d.id))],a),o.delete(u);return[c,h||s]}function resolveAndExecuteActionsWithContext(e,t,r,n,o,s){const{machine:a}=e;let c=e;for(const l of n){let h=function(){r.system._sendInspectionEvent({type:"@xstate.action",actorRef:r.self,action:{type:typeof l=="string"?l:typeof l=="object"?l.type:l.name||"(anonymous)",params:_}}),d(f,_)};const u=typeof l=="function",d=u?l:a.implementations.actions[typeof l=="string"?l:l.type];if(!d)continue;const f={context:c.context,event:t,self:r.self,system:r.system},_=u||typeof l=="string"?void 0:"params"in l?typeof l.params=="function"?l.params({context:c.context,event:t}):l.params:void 0;if(!("resolve"in d)){r.self._processingStatus===ProcessingStatus.Running?h():r.defer(()=>{h()});continue}const p=d,[y,w,E]=p.resolve(r,c,f,_,d,o);c=y,"retryResolve"in p&&(s==null||s.push([p,w])),"execute"in p&&(r.self._processingStatus===ProcessingStatus.Running?p.execute(r,w):r.defer(p.execute.bind(null,r,w))),E&&(c=resolveAndExecuteActionsWithContext(c,t,r,E,o,s))}return c}function resolveActionsAndContext(e,t,r,n,o,s){const a=s?[]:void 0,c=resolveAndExecuteActionsWithContext(e,t,r,n,{internalQueue:o,deferredActorIds:s},a);return a==null||a.forEach(([l,h])=>{l.retryResolve(r,c,h)}),c}function macrostep(e,t,r,n=[]){let o=e;const s=[];function a(h,u,d){r.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:r.self,event:u,snapshot:h,_transitions:d}),s.push(h)}if(t.type===XSTATE_STOP)return o=cloneMachineSnapshot(stopChildren(o,t,r),{status:"stopped"}),a(o,t,[]),{snapshot:o,microstates:s};let c=t;if(c.type!==XSTATE_INIT){const h=c,u=isErrorActorEvent(h),d=selectTransitions(h,o);if(u&&!d.length)return o=cloneMachineSnapshot(e,{status:"error",error:h.error}),a(o,h,[]),{snapshot:o,microstates:s};o=microstep(d,e,r,c,!1,n),a(o,h,d)}let l=!0;for(;o.status==="active";){let h=l?selectEventlessTransitions(o,c):[];const u=h.length?o:void 0;if(!h.length){if(!n.length)break;c=n.shift(),h=selectTransitions(c,o)}o=microstep(h,o,r,c,!1,n),l=o!==u,a(o,c,h)}return o.status!=="active"&&stopChildren(o,c,r),{snapshot:o,microstates:s}}function stopChildren(e,t,r){return resolveActionsAndContext(e,t,r,Object.values(e.children).map(n=>stopChild(n)),[])}function selectTransitions(e,t){return t.machine.getTransitionData(t,e)}function selectEventlessTransitions(e,t){const r=new Set,n=e._nodes.filter(isAtomicStateNode);for(const o of n)e:for(const s of[o].concat(getProperAncestors(o,void 0)))if(s.always){for(const a of s.always)if(a.guard===void 0||evaluateGuard(a.guard,e.context,t,e)){r.add(a);break e}}return removeConflictingTransitions(Array.from(r),new Set(e._nodes),e.historyValue)}function resolveStateValue(e,t){const r=getAllStateNodes(getStateNodes(e,t));return getStateValue(e,[...r])}function isMachineSnapshot(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}var machineSnapshotMatches=function e(t){return matchesState(t,this.value)},machineSnapshotHasTag=function e(t){return this.tags.has(t)},machineSnapshotCan=function e(t){const r=this.machine.getTransitionData(this,t);return!!(r!=null&&r.length)&&r.some(n=>n.target!==void 0||n.actions.length)},machineSnapshotToJSON=function e(){const{_nodes:t,tags:r,machine:n,getMeta:o,toJSON:s,can:a,hasTag:c,matches:l,...h}=this;return{...h,tags:Array.from(r)}},machineSnapshotGetMeta=function e(){return this._nodes.reduce((t,r)=>(r.meta!==void 0&&(t[r.id]=r.meta),t),{})};function createMachineSnapshot(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:getStateValue(t.root,e._nodes),tags:new Set(e._nodes.flatMap(r=>r.tags)),children:e.children,historyValue:e.historyValue||{},matches:machineSnapshotMatches,hasTag:machineSnapshotHasTag,can:machineSnapshotCan,getMeta:machineSnapshotGetMeta,toJSON:machineSnapshotToJSON}}function cloneMachineSnapshot(e,t={}){return createMachineSnapshot({...e,...t},e.machine)}function getPersistedSnapshot(e,t){const{_nodes:r,tags:n,machine:o,children:s,context:a,can:c,hasTag:l,matches:h,getMeta:u,toJSON:d,...f}=e,_={};for(const p in s){const y=s[p];_[p]={snapshot:y.getPersistedSnapshot(t),src:y.src,systemId:y._systemId,syncSnapshot:y._syncSnapshot}}return{...f,context:persistContext(a),children:_}}function persistContext(e){let t;for(const r in e){const n=e[r];if(n&&typeof n=="object")if("sessionId"in n&&"send"in n&&"ref"in n)t??(t=Array.isArray(e)?e.slice():{...e}),t[r]={xstate$$type:$$ACTOR_TYPE,id:n.id};else{const o=persistContext(n);o!==n&&(t??(t=Array.isArray(e)?e.slice():{...e}),t[r]=o)}}return t??e}function resolveRaise(e,t,r,n,{event:o,id:s,delay:a},{internalQueue:c}){const l=t.machine.implementations.delays;if(typeof o=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${o}" }) instead`);const h=typeof o=="function"?o(r,n):o;let u;if(typeof a=="string"){const d=l&&l[a];u=typeof d=="function"?d(r,n):d}else u=typeof a=="function"?a(r,n):a;return typeof u!="number"&&c.push(h),[t,{event:h,id:s,delay:u}]}function executeRaise(e,t){const{event:r,delay:n,id:o}=t;if(typeof n=="number"){e.defer(()=>{const s=e.self;e.system.scheduler.schedule(s,s,r,n,o)});return}}function raise(e,t){function r(n,o){}return r.type="xstate.raise",r.event=e,r.id=t==null?void 0:t.id,r.delay=t==null?void 0:t.delay,r.resolve=resolveRaise,r.execute=executeRaise,r}function createSpawner(e,{machine:t,context:r},n,o){const s=(a,c={})=>{const{systemId:l,input:h}=c;if(typeof a=="string"){const u=resolveReferencedActor(t,a);if(!u)throw new Error(`Actor logic '${a}' not implemented in machine '${t.id}'`);const d=createActor(u,{id:c.id,parent:e.self,syncSnapshot:c.syncSnapshot,input:typeof h=="function"?h({context:r,event:n,self:e.self}):h,src:a,systemId:l});return o[d.id]=d,d}else return createActor(a,{id:c.id,parent:e.self,syncSnapshot:c.syncSnapshot,input:c.input,src:a,systemId:l})};return(a,c)=>{const l=s(a,c);return o[l.id]=l,e.defer(()=>{l._processingStatus!==ProcessingStatus.Stopped&&l.start()}),l}}function resolveAssign(e,t,r,n,{assignment:o}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const s={},a={context:t.context,event:r.event,spawn:createSpawner(e,t,r.event,s),self:e.self,system:e.system};let c={};if(typeof o=="function")c=o(a,n);else for(const h of Object.keys(o)){const u=o[h];c[h]=typeof u=="function"?u(a,n):u}const l=Object.assign({},t.context,c);return[cloneMachineSnapshot(t,{context:l,children:Object.keys(s).length?{...t.children,...s}:t.children})]}function assign(e){function t(r,n){}return t.type="xstate.assign",t.assignment=e,t.resolve=resolveAssign,t}var cache=new WeakMap;function memo(e,t,r){let n=cache.get(e);return n?t in n||(n[t]=r()):(n={[t]:r()},cache.set(e,n)),n[t]}var EMPTY_OBJECT={},toSerializableAction=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e,StateNode=class Xs{constructor(t,r){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=r._parent,this.key=r._key,this.machine=r._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(STATE_DELIMITER),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?mapValues(this.config.states,(n,o)=>new Xs(n,{_parent:this,_key:o,_machine:this.machine})):EMPTY_OBJECT,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=toArray(this.config.entry).slice(),this.exit=toArray(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=toArray(t.tags).slice()}_initialize(){this.transitions=formatTransitions(this),this.config.always&&(this.always=toTransitionConfigArray(this.config.always).map(t=>formatTransition(this,NULL_EVENT,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(toSerializableAction),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(toSerializableAction),eventType:null})}:void 0,history:this.history,states:mapValues(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(toSerializableAction)})),entry:this.entry.map(toSerializableAction),exit:this.exit.map(toSerializableAction),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return memo(this,"invoke",()=>toArray(this.config.invoke).map((t,r)=>{const{src:n,systemId:o}=t,s=t.id??createInvokeId(this.id,r),a=typeof n=="string"?n:`xstate.invoke.${createInvokeId(this.id,r)}`;return{...t,src:a,id:s,systemId:o,toJSON(){const{onDone:c,onError:l,...h}=t;return{...h,type:"xstate.invoke",src:a,id:s}}}}))}get on(){return memo(this,"on",()=>[...this.transitions].flatMap(([t,r])=>r.map(n=>[t,n])).reduce((t,[r,n])=>(t[r]=t[r]||[],t[r].push(n),t),{}))}get after(){return memo(this,"delayedTransitions",()=>getDelayedTransitions(this))}get initial(){return memo(this,"initial",()=>formatInitialTransition(this,this.config.initial))}next(t,r){const n=r.type,o=[];let s;const a=memo(this,`candidates-${n}`,()=>getCandidates(this,n));for(const c of a){const{guard:l}=c,h=t.context;let u=!1;try{u=!l||evaluateGuard(l,h,r,t)}catch(d){const f=typeof l=="string"?l:typeof l=="object"?l.type:void 0;throw new Error(`Unable to evaluate guard ${f?`'${f}' `:""}in transition for event '${n}' in state node '${this.id}':
${d.message}`)}if(u){o.push(...c.actions),s=c;break}}return s?[s]:void 0}get events(){return memo(this,"events",()=>{const{states:t}=this,r=new Set(this.ownEvents);if(t)for(const n of Object.keys(t)){const o=t[n];if(o.states)for(const s of o.events)r.add(`${s}`)}return Array.from(r)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(r=>this.transitions.get(r).some(n=>!(!n.target&&!n.actions.length&&!n.reenter))));return Array.from(t)}},STATE_IDENTIFIER2="#",StateMachine=class Zs{constructor(t,r){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.__TResolvedTypesMeta=void 0,this.id=t.id||"(machine)",this.implementations={actors:(r==null?void 0:r.actors)??{},actions:(r==null?void 0:r.actions)??{},delays:(r==null?void 0:r.delays)??{},guards:(r==null?void 0:r.guards)??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new StateNode(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:r,guards:n,actors:o,delays:s}=this.implementations;return new Zs(this.config,{actions:{...r,...t.actions},guards:{...n,...t.guards},actors:{...o,...t.actors},delays:{...s,...t.delays}})}resolveState(t){const r=resolveStateValue(this.root,t.value),n=getAllStateNodes(getStateNodes(this.root,r));return createMachineSnapshot({_nodes:[...n],context:t.context||{},children:{},status:isInFinalState(n,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,r,n){return macrostep(t,r,n).snapshot}microstep(t,r,n){return macrostep(t,r,n).microstates}getTransitionData(t,r){return transitionNode(this.root,t.value,t,r)||[]}getPreInitialState(t,r,n){const{context:o}=this.config,s=createMachineSnapshot({context:typeof o!="function"&&o?o:{},_nodes:[this.root],children:{},status:"active"},this);return typeof o=="function"?resolveActionsAndContext(s,r,t,[assign(({spawn:a,event:c,self:l})=>o({spawn:a,input:c.input,self:l}))],n):s}getInitialSnapshot(t,r){const n=createInitEvent(r),o=[],s=this.getPreInitialState(t,n,o),a=microstep([{target:[...getInitialStateNodes(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],s,t,n,!0,o),{snapshot:c}=macrostep(a,n,t,o);return c}start(t){Object.values(t.children).forEach(r=>{r.getSnapshot().status==="active"&&r.start()})}getStateNodeById(t){const r=toStatePath(t),n=r.slice(1),o=isStateId(r[0])?r[0].slice(STATE_IDENTIFIER2.length):r[0],s=this.idMap.get(o);if(!s)throw new Error(`Child state node '#${o}' does not exist on machine '${this.id}'`);return getStateNodeByPath(s,n)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,r){return getPersistedSnapshot(t,r)}restoreSnapshot(t,r){const n={},o=t.children;Object.keys(o).forEach(l=>{const h=o[l],u=h.snapshot,d=h.src,f=typeof d=="string"?resolveReferencedActor(this,d):d;if(!f)return;const _=createActor(f,{id:l,parent:r.self,syncSnapshot:h.syncSnapshot,snapshot:u,src:d,systemId:h.systemId});n[l]=_});const s=createMachineSnapshot({...t,children:n,_nodes:Array.from(getAllStateNodes(getStateNodes(this.root,t.value)))},this);let a=new Set;function c(l,h){if(!a.has(l)){a.add(l);for(let u in l){const d=l[u];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===$$ACTOR_TYPE){l[u]=h[d.id];continue}c(d,h)}}}}return c(s.context,n),s}},defaultWaitForOptions={timeout:1/0};function waitFor(e,t,r){const n={...defaultWaitForOptions,...r};return new Promise((o,s)=>{let a=!1;const c=n.timeout===1/0?void 0:setTimeout(()=>{u.unsubscribe(),s(new Error(`Timeout of ${n.timeout} ms exceeded`))},n.timeout),l=()=>{clearTimeout(c),a=!0,u==null||u.unsubscribe()};function h(d){t(d)&&(l(),o(d))}let u;h(e.getSnapshot()),!a&&(u=e.subscribe({next:h,error:d=>{l(),s(d)},complete:()=>{l(),s(new Error("Actor terminated without satisfying predicate"))}}),a&&u.unsubscribe())})}function createMachine(e,t){return new StateMachine(e,t)}function setup({schemas:e,actors:t,actions:r,guards:n,delays:o}){return{createMachine:s=>createMachine({...s,schemas:e},{actors:t,actions:r,guards:n,delays:o})}}function assertEvent(e,t){const r=toArray(t);if(!r.includes(e.type)){const n=r.length===1?`type "${r[0]}"`:`one of types "${r.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(e)} to have ${n}`)}}var urlPrefix="automerge:",parseAutomergeUrl=e=>{const t=new RegExp(`^${urlPrefix}(\\w+)$`),[,r]=e.match(t)||[],n=r,o=documentIdToBinary(n);if(!o)throw new Error("Invalid document URL: "+e);return{binaryDocumentId:o,documentId:n}},stringifyAutomergeUrl=e=>{const t=e instanceof Uint8Array||typeof e=="string"?e:"documentId"in e?e.documentId:void 0,r=t instanceof Uint8Array?binaryToDocumentId(t):typeof t=="string"?t:void 0;if(r===void 0)throw new Error("Invalid documentId: "+t);return urlPrefix+r},isValidAutomergeUrl=e=>{if(!e||!e.startsWith(urlPrefix))return!1;const t=e;try{const{documentId:r}=parseAutomergeUrl(t);return isValidDocumentId(r)}catch{return!1}},isValidDocumentId=e=>{const t=documentIdToBinary(e);if(t===void 0)return!1;const r=stringify(t);return validate(r)},isValidUuid=e=>validate(e),generateAutomergeUrl=()=>{const e=v4(null,new Uint8Array(16));return stringifyAutomergeUrl({documentId:e})},documentIdToBinary=e=>bs58check$1.decodeUnsafe(e),binaryToDocumentId=e=>bs58check$1.encode(e),interpretAsDocumentId=e=>{if(e instanceof Uint8Array)return binaryToDocumentId(e);if(isValidAutomergeUrl(e))return parseAutomergeUrl(e).documentId;if(isValidDocumentId(e))return e;if(isValidUuid(e)){console.warn("Future versions will not support UUIDs as document IDs; use Automerge URLs instead.");const t=parse(e);return binaryToDocumentId(t)}throw new Error(`Invalid AutomergeUrl: '${e}'`)},cbor_exports={};__export(cbor_exports,{decode:()=>decode,encode:()=>encode});function encode(e){return new Encoder({tagUint8Array:!1,useRecords:!1}).encode(e)}function decode(e){return decode$1(e)}var arraysAreEqual=(e,t)=>e.length===t.length&&e.every((r,n)=>r===t[n]),headsAreSame=(e,t)=>arraysAreEqual(e,t),withTimeout=async(e,t)=>{let r;const n=new Promise((o,s)=>{r=setTimeout(()=>s(new TimeoutError(`withTimeout: timed out after ${t}ms`)),t)});try{return await Promise.race([e,n])}finally{clearTimeout(r)}},TimeoutError=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},DocHandle=(Ls=class extends EventEmitter6{constructor(t,r={}){super();dt(this,vr);ie(this,"documentId");dt(this,Zo);dt(this,Zt);dt(this,ei);dt(this,Ln,6e4);dt(this,ti,{});ie(this,"isReady",()=>this.inState(["ready"]));ie(this,"isDeleted",()=>this.inState(["deleted"]));ie(this,"isUnavailable",()=>this.inState(["unavailable"]));ie(this,"inState",t=>t.some(r=>Ae(this,Zt).getSnapshot().matches(r)));this.documentId=t,"timeoutDelay"in r&&r.timeoutDelay&&$t(this,Ln,r.timeoutDelay);let n;const o="isNew"in r&&r.isNew;o?(n=from2(r.initialValue),n=emptyChange(n)):n=init2(),$t(this,Zo,debug7(`automerge-repo:dochandle:${this.documentId.slice(0,5)}`));const s=Ae(this,Ln),a=setup({types:{context:{},events:{}},actions:{onUpdate:assign(({context:c,event:l})=>{const h=c.doc;assertEvent(l,UPDATE);const{callback:u}=l.payload;return{doc:u(h)}}),onDelete:assign(()=>(this.emit("delete",{handle:this}),{doc:void 0})),onUnavailable:()=>{this.emit("unavailable",{handle:this})}}}).createMachine({initial:"idle",context:{documentId:t,doc:n},on:{UPDATE:{actions:"onUpdate"},DELETE:".deleted"},states:{idle:{on:{CREATE:"ready",FIND:"loading"}},loading:{on:{REQUEST:"requesting",DOC_READY:"ready",AWAIT_NETWORK:"awaitingNetwork"},after:{[s]:"unavailable"}},awaitingNetwork:{on:{NETWORK_READY:"requesting"}},requesting:{on:{DOC_UNAVAILABLE:"unavailable",DOC_READY:"ready"},after:{[s]:"unavailable"}},unavailable:{entry:"onUnavailable",on:{DOC_READY:"ready"}},ready:{},deleted:{entry:"onDelete",type:"final"}}});$t(this,Zt,createActor(a)),Ae(this,Zt).subscribe(c=>{const l=Ae(this,ei),h=c.context.doc;Ae(this,Zo).call(this,`\u2192 ${c.value} %o`,h),vt(this,vr,ea).call(this,l,h)}),Ae(this,Zt).start(),Ae(this,Zt).send(o?{type:CREATE}:{type:FIND})}get url(){return stringifyAutomergeUrl({documentId:this.documentId})}get state(){return Ae(this,Zt).getSnapshot().value}async whenReady(t=["ready"]){await withTimeout(vt(this,vr,Oi).call(this,t),Ae(this,Ln))}async doc(t=["ready","unavailable"]){try{await vt(this,vr,Oi).call(this,t)}catch{return}return this.isUnavailable()?void 0:Ae(this,vr,gi)}docSync(){if(this.isReady())return Ae(this,vr,gi)}heads(){if(this.isReady())return getHeads(Ae(this,vr,gi))}update(t){Ae(this,Zt).send({type:UPDATE,payload:{callback:t}})}setRemoteHeads(t,r){Ae(this,ti)[t]=r,this.emit("remote-heads",{storageId:t,heads:r})}getRemoteHeads(t){return Ae(this,ti)[t]}change(t,r={}){if(!this.isReady())throw new Error(`DocHandle#${this.documentId} is not ready. Check \`handle.isReady()\` before accessing the document.`);Ae(this,Zt).send({type:UPDATE,payload:{callback:n=>change(n,r,t)}})}changeAt(t,r,n={}){if(!this.isReady())throw new Error(`DocHandle#${this.documentId} is not ready. Check \`handle.isReady()\` before accessing the document.`);let o;return Ae(this,Zt).send({type:UPDATE,payload:{callback:s=>{const a=changeAt(s,t,n,r);return o=a.newHeads||void 0,a.newDoc}}}),o}merge(t){if(!this.isReady()||!t.isReady())throw new Error("Both handles must be ready to merge");const r=t.docSync();if(!r)throw new Error("The document to be merged in is falsy, aborting.");this.update(n=>merge(n,r))}unavailable(){Ae(this,Zt).send({type:DOC_UNAVAILABLE})}request(){Ae(this,vr,yi)==="loading"&&Ae(this,Zt).send({type:REQUEST})}awaitNetwork(){Ae(this,vr,yi)==="loading"&&Ae(this,Zt).send({type:AWAIT_NETWORK})}networkReady(){Ae(this,vr,yi)==="awaitingNetwork"&&Ae(this,Zt).send({type:NETWORK_READY})}delete(){Ae(this,Zt).send({type:DELETE})}broadcast(t){this.emit("ephemeral-message-outbound",{handle:this,data:encode(t)})}},Zo=new WeakMap,Zt=new WeakMap,ei=new WeakMap,Ln=new WeakMap,ti=new WeakMap,vr=new WeakSet,gi=function(){var t;return(t=Ae(this,Zt))==null?void 0:t.getSnapshot().context.doc},yi=function(){var t;return(t=Ae(this,Zt))==null?void 0:t.getSnapshot().value},Oi=function(t){const r=Array.isArray(t)?t:[t];return waitFor(Ae(this,Zt),n=>r.some(o=>n.matches(o)),{timeout:Ae(this,Ln)*2})},ea=function(t,r){if(r&&t&&!headsAreSame(getHeads(r),getHeads(t))){this.emit("heads-changed",{handle:this,doc:r});const n=diff(r,getHeads(t),getHeads(r));n.length>0&&this.emit("change",{handle:this,doc:r,patches:n,patchInfo:{before:t,after:r,source:"change"}}),this.isReady()||Ae(this,Zt).send({type:DOC_READY})}$t(this,ei,r)},Ls),HandleState={IDLE:"idle",LOADING:"loading",AWAITING_NETWORK:"awaitingNetwork",REQUESTING:"requesting",READY:"ready",DELETED:"deleted",UNAVAILABLE:"unavailable"},{IDLE,LOADING,AWAITING_NETWORK,REQUESTING,READY,DELETED,UNAVAILABLE}=HandleState,CREATE="CREATE",FIND="FIND",REQUEST="REQUEST",DOC_READY="DOC_READY",AWAIT_NETWORK="AWAIT_NETWORK",NETWORK_READY="NETWORK_READY",UPDATE="UPDATE",DELETE="DELETE",DOC_UNAVAILABLE="DOC_UNAVAILABLE",RemoteHeadsSubscriptions=(Ms=class extends EventEmitter6{constructor(){super(...arguments);dt(this,Mn);dt(this,un,new Map);dt(this,Ir,new Set);dt(this,Rr,new Map);dt(this,dn,new Set);dt(this,wn,new Map);dt(this,fn,debug7("automerge-repo:remote-heads-subscriptions"))}subscribeToRemotes(t){Ae(this,fn).call(this,"subscribeToRemotes",t);const r=[];for(const n of t)Ae(this,Ir).has(n)||(Ae(this,Ir).add(n),r.push(n));r.length>0&&this.emit("change-remote-subs",{add:r,peers:Array.from(Ae(this,dn))})}unsubscribeFromRemotes(t){Ae(this,fn).call(this,"subscribeToRemotes",t);const r=[];for(const n of t)Ae(this,Ir).has(n)&&(Ae(this,Ir).delete(n),Ae(this,Rr).has(n)||r.push(n));r.length>0&&this.emit("change-remote-subs",{remove:r,peers:Array.from(Ae(this,dn))})}handleControlMessage(t){const r=[],n=[],o=[];if(Ae(this,fn).call(this,"handleControlMessage",t),t.add)for(const s of t.add){let a=Ae(this,Rr).get(s);(Ae(this,Ir).has(s)||a)&&o.push(s),a||(a=new Set,Ae(this,Rr).set(s,a),Ae(this,Ir).has(s)||r.push(s)),a.add(t.senderId)}if(t.remove)for(const s of t.remove){const a=Ae(this,Rr).get(s);a&&(a.delete(t.senderId),a.size==0&&!Ae(this,Ir).has(s)&&n.push(s))}(r.length>0||n.length>0)&&this.emit("change-remote-subs",{peers:Array.from(Ae(this,dn)),add:r,remove:n});for(const s of o){const a=Ae(this,wn).get(t.senderId);if(a)for(const c of a){const l=Ae(this,un).get(c);if(!l)continue;const h=l.get(s);h&&this.emit("notify-remote-heads",{targetId:t.senderId,documentId:c,heads:h.heads,timestamp:h.timestamp,storageId:s})}}}handleRemoteHeads(t){Ae(this,fn).call(this,"handleRemoteHeads",t);const r=vt(this,Mn,ta).call(this,t);for(const n of r)Ae(this,Ir).has(n.storageId)&&this.emit("remote-heads-changed",n);for(const n of r)for(const o of Ae(this,dn))o!==t.senderId&&this.emit("notify-remote-heads",{targetId:o,documentId:n.documentId,heads:n.remoteHeads,timestamp:n.timestamp,storageId:n.storageId});for(const n of r){const o=Ae(this,Rr).get(n.storageId);if(o)for(const s of o)vt(this,Mn,Ri).call(this,s,n.documentId)&&this.emit("notify-remote-heads",{targetId:s,documentId:n.documentId,heads:n.remoteHeads,timestamp:n.timestamp,storageId:n.storageId})}}handleImmediateRemoteHeadsChanged(t,r,n){Ae(this,fn).call(this,"handleLocalHeadsChanged",t,r,n);const o=Ae(this,un).get(t),s=Date.now();if(!o)Ae(this,un).set(t,new Map([[r,{heads:n,timestamp:s}]]));else{const c=o.get(r);(!c||c.timestamp<Date.now())&&o.set(r,{heads:n,timestamp:Date.now()})}const a=Ae(this,Rr).get(r);if(a)for(const c of a)vt(this,Mn,Ri).call(this,c,t)&&this.emit("notify-remote-heads",{targetId:c,documentId:t,heads:n,timestamp:s,storageId:r})}addGenerousPeer(t){Ae(this,fn).call(this,"addGenerousPeer",t),Ae(this,dn).add(t),Ae(this,Ir).size>0&&this.emit("change-remote-subs",{add:Array.from(Ae(this,Ir)),peers:[t]});for(const[r,n]of Ae(this,un))for(const[o,{heads:s,timestamp:a}]of n)this.emit("notify-remote-heads",{targetId:t,documentId:r,heads:s,timestamp:a,storageId:o})}removePeer(t){Ae(this,fn).call(this,"removePeer",t);const r=[];Ae(this,dn).delete(t),Ae(this,wn).delete(t);for(const[n,o]of Ae(this,Rr))o.has(t)&&(o.delete(t),o.size==0&&(r.push(n),Ae(this,Rr).delete(n)));r.length>0&&this.emit("change-remote-subs",{remove:r,peers:Array.from(Ae(this,dn))})}subscribePeerToDoc(t,r){let n=Ae(this,wn).get(t);n||(n=new Set,Ae(this,wn).set(t,n)),n.add(r);const o=Ae(this,un).get(r);if(o)for(const[s,a]of o){const c=Ae(this,Rr).get(s);c&&c.has(t)&&this.emit("notify-remote-heads",{targetId:t,documentId:r,heads:a.heads,timestamp:a.timestamp,storageId:s})}}},un=new WeakMap,Ir=new WeakMap,Rr=new WeakMap,dn=new WeakMap,wn=new WeakMap,fn=new WeakMap,Mn=new WeakSet,Ri=function(t,r){const n=Ae(this,wn).get(t);return n&&n.has(r)},ta=function(t){const r=[],{documentId:n,newHeads:o}=t;for(const[s,{heads:a,timestamp:c}]of Object.entries(o)){if(!Ae(this,Ir).has(s)&&!Ae(this,Rr).has(s))continue;let l=Ae(this,un).get(n);l||(l=new Map,Ae(this,un).set(n,l));const h=l.get(s);h&&h.timestamp>=c||(l.set(s,{timestamp:c,heads:a}),r.push({documentId:n,storageId:s,remoteHeads:a,timestamp:c}))}return r},Ms),throttle=(e,t)=>{let r=Date.now(),n,o;return function(...s){n=r+t-Date.now(),clearTimeout(o),o=setTimeout(()=>{e(...s),r=Date.now()},n)}},isRepoMessage=e=>isSyncMessage(e)||isEphemeralMessage(e)||isRequestMessage(e)||isDocumentUnavailableMessage(e)||isRemoteSubscriptionControlMessage(e)||isRemoteHeadsChanged(e),isDocumentUnavailableMessage=e=>e.type==="doc-unavailable",isRequestMessage=e=>e.type==="request",isSyncMessage=e=>e.type==="sync",isEphemeralMessage=e=>e.type==="ephemeral",isRemoteSubscriptionControlMessage=e=>e.type==="remote-subscription-change",isRemoteHeadsChanged=e=>e.type==="remote-heads-changed",getEphemeralMessageSource=e=>`${e.senderId}:${e.sessionId}`,NetworkSubsystem=(Ns=class extends EventEmitter6{constructor(t,r=randomPeerId(),n){super();ie(this,"peerId");ie(this,"peerMetadata");dt(this,Lr);dt(this,bn,{});dt(this,li,0);dt(this,hi,Math.random().toString(36).slice(2));dt(this,Qn,{});dt(this,Nn,0);dt(this,Dn,[]);ie(this,"isReady",()=>Ae(this,Nn)===Ae(this,Dn).length);ie(this,"whenReady",async()=>{if(!this.isReady())return new Promise(t=>{this.once("ready",()=>{t()})})});this.peerId=r,this.peerMetadata=n,$t(this,Lr,debug7(`automerge-repo:network:${this.peerId}`)),t.forEach(o=>this.addNetworkAdapter(o))}addNetworkAdapter(t){Ae(this,Dn).push(t),t.once("ready",()=>{Ii(this,Nn)._++,Ae(this,Lr).call(this,"Adapters ready: ",Ae(this,Nn),"/",Ae(this,Dn).length),Ae(this,Nn)===Ae(this,Dn).length&&this.emit("ready")}),t.on("peer-candidate",({peerId:r,peerMetadata:n})=>{Ae(this,Lr).call(this,`peer candidate: ${r} `),Ae(this,bn)[r]||(Ae(this,bn)[r]=t),this.emit("peer",{peerId:r,peerMetadata:n})}),t.on("peer-disconnected",({peerId:r})=>{Ae(this,Lr).call(this,`peer disconnected: ${r} `),delete Ae(this,bn)[r],this.emit("peer-disconnected",{peerId:r})}),t.on("message",r=>{if(!isRepoMessage(r)){Ae(this,Lr).call(this,`invalid message: ${JSON.stringify(r)}`);return}if(Ae(this,Lr).call(this,`message from ${r.senderId}`),isEphemeralMessage(r)){const n=getEphemeralMessageSource(r);(Ae(this,Qn)[n]===void 0||r.count>Ae(this,Qn)[n])&&(Ae(this,Qn)[n]=r.count,this.emit("message",r));return}this.emit("message",r)}),t.on("close",()=>{Ae(this,Lr).call(this,"adapter closed"),Object.entries(Ae(this,bn)).forEach(([r,n])=>{n===t&&delete Ae(this,bn)[r]})}),this.peerMetadata.then(r=>{t.connect(this.peerId,r)}).catch(r=>{Ae(this,Lr).call(this,"error connecting to network",r)})}send(t){const r=Ae(this,bn)[t.targetId];if(!r){Ae(this,Lr).call(this,`Tried to send message but peer not found: ${t.targetId}`);return}const n=(o=>o.type==="ephemeral"?"count"in o?o:{...o,count:++Ii(this,li)._,sessionId:Ae(this,hi),senderId:this.peerId}:{...o,senderId:this.peerId})(t);Ae(this,Lr).call(this,"sending message %o",n),r.send(n)}},Lr=new WeakMap,bn=new WeakMap,li=new WeakMap,hi=new WeakMap,Qn=new WeakMap,Nn=new WeakMap,Dn=new WeakMap,Ns);function randomPeerId(){return`user-${Math.round(Math.random()*1e5)}`}function mergeArrays(e){let t=0;e.forEach(o=>{t+=o.length});const r=new Uint8Array(t);let n=0;return e.forEach(o=>{r.set(o,n),n+=o.length}),r}function keyHash(e){const t=sha256Exports.hash(e);return bufferToHexString(t)}function headsHash(e){const t=new TextEncoder,r=mergeArrays(e.map(n=>t.encode(n)));return keyHash(r)}function bufferToHexString(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function chunkTypeFromKey(e){if(e.length<2)return null;const t=e[e.length-2];return t==="snapshot"||t==="incremental"?t:null}var StorageSubsystem=(Ds=class{constructor(e){dt(this,_n);dt(this,cr);dt(this,En,new Map);dt(this,pn,new Map);dt(this,zn,!1);dt(this,Yn,debug7("automerge-repo:storage-subsystem"));$t(this,cr,e)}async id(){const e=await Ae(this,cr).load(["storage-adapter-id"]);let t;return e?t=new TextDecoder().decode(e):(t=v4(),await Ae(this,cr).save(["storage-adapter-id"],new TextEncoder().encode(t))),t}async load(e,t){const r=[e,t];return await Ae(this,cr).load(r)}async save(e,t,r){const n=[e,t];await Ae(this,cr).save(n,r)}async remove(e,t){const r=[e,t];await Ae(this,cr).remove(r)}async loadDoc(e){const t=await Ae(this,cr).loadRange([e]),r=[],n=[];for(const a of t){if(a.data===void 0)continue;const c=chunkTypeFromKey(a.key);c!=null&&(n.push({key:a.key,type:c,size:a.data.length}),r.push(a.data))}Ae(this,pn).set(e,n);const o=mergeArrays(r);if(o.length===0)return null;const s=loadIncremental(init2(),o);return Ae(this,En).set(e,getHeads(s)),s}async saveDoc(e,t){if(!vt(this,_n,oa).call(this,e,t))return;const r=Ae(this,pn).get(e)??[];vt(this,_n,ia).call(this,r)?await vt(this,_n,na).call(this,e,t,r):await vt(this,_n,ra).call(this,e,t),Ae(this,En).set(e,getHeads(t))}async removeDoc(e){await Ae(this,cr).removeRange([e,"snapshot"]),await Ae(this,cr).removeRange([e,"incremental"]),await Ae(this,cr).removeRange([e,"sync-state"])}async loadSyncState(e,t){const r=[e,"sync-state",t],n=await Ae(this,cr).load(r);return n?decodeSyncState(n):void 0}async saveSyncState(e,t,r){const n=[e,"sync-state",t];await Ae(this,cr).save(n,encodeSyncState(r))}},cr=new WeakMap,En=new WeakMap,pn=new WeakMap,zn=new WeakMap,Yn=new WeakMap,_n=new WeakSet,ra=async function(e,t){const r=saveSince(t,Ae(this,En).get(e)??[]);if(r&&r.length>0){const n=[e,"incremental",keyHash(r)];Ae(this,Yn).call(this,`Saving incremental ${n} for document ${e}`),await Ae(this,cr).save(n,r),Ae(this,pn).has(e)||Ae(this,pn).set(e,[]),Ae(this,pn).get(e).push({key:n,type:"incremental",size:r.length}),Ae(this,En).set(e,getHeads(t))}else return Promise.resolve()},na=async function(e,t,r){var l;$t(this,zn,!0);const n=save(t),o=headsHash(getHeads(t)),s=[e,"snapshot",o],a=new Set(r.map(h=>h.key).filter(h=>h[2]!==o));Ae(this,Yn).call(this,`Saving snapshot ${s} for document ${e}`),Ae(this,Yn).call(this,`deleting old chunks ${Array.from(a)}`),await Ae(this,cr).save(s,n);for(const h of a)await Ae(this,cr).remove(h);const c=((l=Ae(this,pn).get(e))==null?void 0:l.filter(h=>!a.has(h.key)))??[];c.push({key:s,type:"snapshot",size:n.length}),Ae(this,pn).set(e,c),$t(this,zn,!1)},oa=function(e,t){const r=Ae(this,En).get(e);if(!r)return!0;const n=getHeads(t);return!headsAreSame(n,r)},ia=function(e){if(Ae(this,zn))return!1;let t=0,r=0;for(const n of e)n.type==="snapshot"?t+=n.size:r+=n.size;return t<1024||r>=t},Ds),Synchronizer=class extends EventEmitter6{},DocSynchronizer=(Ps=class extends Synchronizer{constructor({handle:t,onLoadSyncState:r}){super();dt(this,Lt);dt(this,jr);ie(this,"syncDebounceRate",100);dt(this,Cr,[]);dt(this,Pn,{});dt(this,yr,{});dt(this,Gn,{});dt(this,Vn,[]);dt(this,ri,!1);dt(this,er);dt(this,ni);$t(this,er,t),$t(this,ni,r??(()=>Promise.resolve(void 0)));const n=t.documentId.slice(0,5);$t(this,jr,debug7(`automerge-repo:docsync:${n}`)),t.on("change",throttle(()=>vt(this,Lt,sa).call(this),this.syncDebounceRate)),t.on("ephemeral-message-outbound",o=>vt(this,Lt,aa).call(this,o)),(async()=>(await t.doc([READY,REQUESTING]),vt(this,Lt,Mi).call(this)))()}get peerStates(){return Ae(this,yr)}get documentId(){return Ae(this,er).documentId}hasPeer(t){return Ae(this,Cr).includes(t)}beginSync(t){const r=t.every(o=>Ae(this,yr)[o]in["unavailable","wants"]),n=Ae(this,er).doc([READY,REQUESTING,UNAVAILABLE]).then(o=>{if($t(this,ri,!0),vt(this,Lt,ai).call(this),!(o===void 0&&r))return o??init2()});Ae(this,jr).call(this,`beginSync: ${t.join(", ")}`),t.forEach(o=>{vt(this,Lt,mi).call(this,o,s=>{const a=decodeSyncState(encodeSyncState(s));vt(this,Lt,bi).call(this,o,a),n.then(c=>{c&&vt(this,Lt,Si).call(this,o,c)}).catch(c=>{Ae(this,jr).call(this,`Error loading doc for ${o}: ${c}`)})})})}endSync(t){Ae(this,jr).call(this,`removing peer ${t}`),$t(this,Cr,Ae(this,Cr).filter(r=>r!==t))}receiveMessage(t){switch(t.type){case"sync":case"request":this.receiveSyncMessage(t);break;case"ephemeral":this.receiveEphemeralMessage(t);break;case"doc-unavailable":Ae(this,yr)[t.senderId]="unavailable",vt(this,Lt,ai).call(this);break;default:throw new Error(`unknown message type: ${t}`)}}receiveEphemeralMessage(t){if(t.documentId!==Ae(this,er).documentId)throw new Error("channelId doesn't match documentId");const{senderId:r,data:n}=t,o=decode$1(new Uint8Array(n));Ae(this,er).emit("ephemeral-message",{handle:Ae(this,er),senderId:r,message:o}),Ae(this,Cr).forEach(s=>{s!==r&&this.emit("message",{...t,targetId:s})})}receiveSyncMessage(t){if(t.documentId!==Ae(this,er).documentId)throw new Error("channelId doesn't match documentId");if(!Ae(this,er).inState([READY,REQUESTING,UNAVAILABLE])){Ae(this,Vn).push({message:t,received:new Date});return}vt(this,Lt,Mi).call(this),vt(this,Lt,Li).call(this,t)}},jr=new WeakMap,Cr=new WeakMap,Pn=new WeakMap,yr=new WeakMap,Gn=new WeakMap,Vn=new WeakMap,ri=new WeakMap,er=new WeakMap,ni=new WeakMap,Lt=new WeakSet,sa=async function(){Ae(this,jr).call(this,"syncWithPeers");const t=await Ae(this,er).doc();t!==void 0&&Ae(this,Cr).forEach(r=>vt(this,Lt,Si).call(this,r,t))},aa=async function({data:t}){Ae(this,jr).call(this,"broadcastToPeers",Ae(this,Cr)),Ae(this,Cr).forEach(r=>vt(this,Lt,ca).call(this,r,t))},ca=function(t,r){Ae(this,jr).call(this,`sendEphemeralMessage ->${t}`);const n={type:"ephemeral",targetId:t,documentId:Ae(this,er).documentId,data:r};this.emit("message",n)},mi=function(t,r){vt(this,Lt,la).call(this,t),t in Ae(this,yr)||(Ae(this,yr)[t]="unknown");const n=Ae(this,Gn)[t];if(n){r(n);return}let o=Ae(this,Pn)[t];o||(Ae(this,ni).call(this,t).then(s=>{vt(this,Lt,ha).call(this,t,s??initSyncState())}).catch(s=>{Ae(this,jr).call(this,`Error loading sync state for ${t}: ${s}`)}),o=Ae(this,Pn)[t]=[]),o.push(r)},la=function(t){Ae(this,Cr).includes(t)||(Ae(this,Cr).push(t),this.emit("open-doc",{documentId:this.documentId,peerId:t}))},ha=function(t,r){const n=Ae(this,Pn)[t];if(n)for(const o of n)o(r);delete Ae(this,Pn)[t],Ae(this,Gn)[t]=r},bi=function(t,r){Ae(this,Gn)[t]=r,this.emit("sync-state",{peerId:t,syncState:r,documentId:Ae(this,er).documentId})},Si=function(t,r){Ae(this,jr).call(this,`sendSyncMessage ->${t}`),vt(this,Lt,mi).call(this,t,n=>{const[o,s]=generateSyncMessage(r,n);if(s){vt(this,Lt,bi).call(this,t,o);const a=getHeads(r).length===0;!Ae(this,er).isReady()&&a&&o.sharedHeads.length===0&&!Object.values(Ae(this,yr)).includes("has")&&Ae(this,yr)[t]==="unknown"?this.emit("message",{type:"request",targetId:t,documentId:Ae(this,er).documentId,data:s}):this.emit("message",{type:"sync",targetId:t,data:s,documentId:Ae(this,er).documentId}),a||(Ae(this,yr)[t]="has")}})},Li=function(t){isRequestMessage(t)&&(Ae(this,yr)[t.senderId]="wants"),vt(this,Lt,ai).call(this),decodeSyncMessage(t.data).heads.length>0&&(Ae(this,yr)[t.senderId]="has"),vt(this,Lt,mi).call(this,t.senderId,r=>{Ae(this,er).update(n=>{const[o,s]=receiveSyncMessage(n,r,t.data);return vt(this,Lt,bi).call(this,t.senderId,s),vt(this,Lt,Si).call(this,t.senderId,n),o}),vt(this,Lt,ai).call(this)})},ai=function(){Ae(this,ri)&&Ae(this,er).inState([REQUESTING])&&Ae(this,Cr).every(t=>Ae(this,yr)[t]==="unavailable"||Ae(this,yr)[t]==="wants")&&(Ae(this,Cr).filter(t=>Ae(this,yr)[t]==="wants").forEach(t=>{const r={type:"doc-unavailable",documentId:Ae(this,er).documentId,targetId:t};this.emit("message",r)}),Ae(this,er).unavailable())},Mi=function(){for(const t of Ae(this,Vn))vt(this,Lt,Li).call(this,t.message);$t(this,Vn,[])},Ps),log2=debug7("automerge-repo:collectionsync"),CollectionSynchronizer=(Bs=class extends Synchronizer{constructor(t){super();dt(this,gn);ie(this,"repo");dt(this,In,new Set);dt(this,Cn,{});dt(this,oi,{});this.repo=t}async receiveMessage(t){log2(`onSyncMessage: ${t.senderId}, ${t.documentId}, ${"data"in t?t.data.byteLength+"bytes":""}`);const r=t.documentId;if(!r)throw new Error("received a message with an invalid documentId");Ae(this,oi)[r]=!0;const n=vt(this,gn,Ni).call(this,r);n.receiveMessage(t);const o=await vt(this,gn,Di).call(this,r);n.beginSync(o.filter(s=>!n.hasPeer(s)))}addDocument(t){if(Ae(this,oi)[t])return;const r=vt(this,gn,Ni).call(this,t);vt(this,gn,Di).call(this,t).then(n=>{r.beginSync(n)})}removeDocument(t){throw new Error("not implemented")}addPeer(t){if(log2(`adding ${t} & synchronizing with them`),!Ae(this,In).has(t)){Ae(this,In).add(t);for(const r of Object.values(Ae(this,Cn))){const{documentId:n}=r;this.repo.sharePolicy(t,n).then(o=>{o&&r.beginSync([t])})}}}removePeer(t){log2(`removing peer ${t}`),Ae(this,In).delete(t);for(const r of Object.values(Ae(this,Cn)))r.endSync(t)}get peers(){return Array.from(Ae(this,In))}},In=new WeakMap,Cn=new WeakMap,oi=new WeakMap,gn=new WeakSet,Ni=function(t){if(!Ae(this,Cn)[t]){const r=this.repo.find(stringifyAutomergeUrl({documentId:t}));Ae(this,Cn)[t]=vt(this,gn,ua).call(this,r)}return Ae(this,Cn)[t]},ua=function(t){const r=new DocSynchronizer({handle:t,onLoadSyncState:async n=>{if(!this.repo.storageSubsystem)return;const{storageId:o,isEphemeral:s}=this.repo.peerMetadataByPeerId[n]||{};if(!(!o||s))return this.repo.storageSubsystem.loadSyncState(t.documentId,o)}});return r.on("message",n=>this.emit("message",n)),r.on("open-doc",n=>this.emit("open-doc",n)),r.on("sync-state",n=>this.emit("sync-state",n)),r},Di=async function(t){const r=Array.from(Ae(this,In)),n=[];for(const o of r)await this.repo.sharePolicy(o,t)&&n.push(o);return n},Bs),Repo=(Fs=class extends EventEmitter6{constructor({storage:t,network:r=[],peerId:n,sharePolicy:o,isEphemeral:s=t===void 0,enableRemoteHeadsGossiping:a=!1}={}){super();dt(this,Vr);dt(this,Ur);ie(this,"networkSubsystem");ie(this,"storageSubsystem");ie(this,"saveDebounceRate",100);dt(this,ur,{});dt(this,Kr);ie(this,"sharePolicy",async()=>!0);ie(this,"peerMetadataByPeerId",{});dt(this,Mr,new RemoteHeadsSubscriptions);dt(this,Gr,!1);dt(this,ii,{});ie(this,"subscribeToRemotes",t=>{Ae(this,Gr)?(Ae(this,Ur).call(this,"subscribeToRemotes",{remotes:t}),Ae(this,Mr).subscribeToRemotes(t)):Ae(this,Ur).call(this,"WARN: subscribeToRemotes called but remote heads gossiping is not enabled")});ie(this,"storageId",async()=>{if(this.storageSubsystem)return this.storageSubsystem.id()});$t(this,Gr,a),$t(this,Ur,debug7("automerge-repo:repo")),this.sharePolicy=o??this.sharePolicy,this.on("document",async({handle:u,isNew:d})=>{if(c){const f=({handle:_,doc:p})=>{c.saveDoc(_.documentId,p)};if(u.on("heads-changed",throttle(f,this.saveDebounceRate)),d)await c.saveDoc(u.documentId,u.docSync());else{const _=await c.loadDoc(u.documentId);_&&u.update(()=>_)}}u.on("unavailable",()=>{Ae(this,Ur).call(this,"document unavailable",{documentId:u.documentId}),this.emit("unavailable-document",{documentId:u.documentId})}),this.networkSubsystem.isReady()?u.request():(u.awaitNetwork(),this.networkSubsystem.whenReady().then(()=>{u.networkReady()}).catch(f=>{Ae(this,Ur).call(this,"error waiting for network",{err:f})})),Ae(this,Kr).addDocument(u.documentId)}),this.on("delete-document",({documentId:u})=>{c&&c.removeDoc(u).catch(d=>{Ae(this,Ur).call(this,"error deleting document",{documentId:u,err:d})})}),$t(this,Kr,new CollectionSynchronizer(this)),Ae(this,Kr).on("message",u=>{Ae(this,Ur).call(this,`sending ${u.type} message to ${u.targetId}`),h.send(u)}),Ae(this,Gr)&&Ae(this,Kr).on("open-doc",({peerId:u,documentId:d})=>{Ae(this,Mr).subscribePeerToDoc(u,d)});const c=t?new StorageSubsystem(t):void 0;this.storageSubsystem=c;const l=(async()=>({storageId:await(c==null?void 0:c.id()),isEphemeral:s}))(),h=new NetworkSubsystem(r,n,l);this.networkSubsystem=h,h.on("peer",async({peerId:u,peerMetadata:d})=>{Ae(this,Ur).call(this,"peer connected",{peerId:u}),d&&(this.peerMetadataByPeerId[u]={...d}),this.sharePolicy(u).then(f=>{f&&Ae(this,Gr)&&Ae(this,Mr).addGenerousPeer(u)}).catch(f=>{console.log("error in share policy",{err:f})}),Ae(this,Kr).addPeer(u)}),h.on("peer-disconnected",({peerId:u})=>{Ae(this,Kr).removePeer(u),Ae(this,Mr).removePeer(u)}),h.on("message",async u=>{vt(this,Vr,da).call(this,u)}),Ae(this,Kr).on("sync-state",u=>{vt(this,Vr,fa).call(this,u);const d=Ae(this,ur)[u.documentId],{storageId:f}=this.peerMetadataByPeerId[u.peerId]||{};if(!f)return;const _=d.getRemoteHeads(f);u.syncState.theirHeads&&(!_||!headsAreSame(_,u.syncState.theirHeads))&&u.syncState.theirHeads&&(d.setRemoteHeads(f,u.syncState.theirHeads),f&&Ae(this,Gr)&&Ae(this,Mr).handleImmediateRemoteHeadsChanged(u.documentId,f,u.syncState.theirHeads))}),Ae(this,Gr)&&(Ae(this,Mr).on("notify-remote-heads",u=>{this.networkSubsystem.send({type:"remote-heads-changed",targetId:u.targetId,documentId:u.documentId,newHeads:{[u.storageId]:{heads:u.heads,timestamp:u.timestamp}}})}),Ae(this,Mr).on("change-remote-subs",u=>{Ae(this,Ur).call(this,"change-remote-subs",u);for(const d of u.peers)this.networkSubsystem.send({type:"remote-subscription-change",targetId:d,add:u.add,remove:u.remove})}),Ae(this,Mr).on("remote-heads-changed",u=>{Ae(this,ur)[u.documentId].setRemoteHeads(u.storageId,u.remoteHeads)}))}get handles(){return Ae(this,ur)}get peers(){return Ae(this,Kr).peers}getStorageIdOfPeer(t){var r;return(r=this.peerMetadataByPeerId[t])==null?void 0:r.storageId}create(t){const{documentId:r}=parseAutomergeUrl(generateAutomergeUrl()),n=vt(this,Vr,ci).call(this,{documentId:r,isNew:!0,initialValue:t});return this.emit("document",{handle:n,isNew:!0}),n}clone(t){if(!t.isReady())throw new Error(`Cloned handle is not yet in ready state.
        (Try await handle.waitForReady() first.)`);const r=t.docSync();if(!r)throw new Error("Cloned handle doesn't have a document.");const n=this.create();return n.update(()=>next_exports.clone(r)),n}find(t){const r=interpretAsDocumentId(t);if(Ae(this,ur)[r])return Ae(this,ur)[r].isUnavailable()&&setTimeout(()=>{Ae(this,ur)[r].emit("unavailable",{handle:Ae(this,ur)[r]})}),Ae(this,ur)[r];const n=vt(this,Vr,ci).call(this,{documentId:r,isNew:!1});return this.emit("document",{handle:n,isNew:!1}),n}delete(t){const r=interpretAsDocumentId(t);vt(this,Vr,ci).call(this,{documentId:r,isNew:!1}).delete(),delete Ae(this,ur)[r],this.emit("delete-document",{documentId:r})}async export(t){const r=interpretAsDocumentId(t),n=await vt(this,Vr,ci).call(this,{documentId:r,isNew:!1}).doc();if(n)return next_exports.save(n)}import(t){const r=next_exports.load(t),n=this.create();return n.update(()=>next_exports.clone(r)),n}async flush(t){if(!this.storageSubsystem)return;const r=t?t.map(n=>Ae(this,ur)[n]):Object.values(Ae(this,ur));await Promise.all(r.map(async n=>{const o=n.docSync();if(o)return this.storageSubsystem.saveDoc(n.documentId,o)}))}},Ur=new WeakMap,ur=new WeakMap,Kr=new WeakMap,Mr=new WeakMap,Gr=new WeakMap,Vr=new WeakSet,da=function(t){switch(t.type){case"remote-subscription-change":Ae(this,Gr)&&Ae(this,Mr).handleControlMessage(t);break;case"remote-heads-changed":Ae(this,Gr)&&Ae(this,Mr).handleRemoteHeads(t);break;case"sync":case"request":case"ephemeral":case"doc-unavailable":Ae(this,Kr).receiveMessage(t).catch(r=>{console.log("error receiving message",{err:r})})}},ii=new WeakMap,fa=function(t){if(!this.storageSubsystem)return;const{storageId:r,isEphemeral:n}=this.peerMetadataByPeerId[t.peerId]||{};if(!r||n)return;let o=Ae(this,ii)[r];o||(o=Ae(this,ii)[r]=throttle(({documentId:s,syncState:a})=>{this.storageSubsystem.saveSyncState(s,r,a)},this.saveDebounceRate)),o(t)},ci=function({documentId:t,isNew:r,initialValue:n}){if(Ae(this,ur)[t])return Ae(this,ur)[t];if(!t)throw new Error(`Invalid documentId ${t}`);const o=new DocHandle(t,{isNew:r,initialValue:n});return Ae(this,ur)[t]=o,o},Fs),NetworkAdapter=class extends EventEmitter6{constructor(){super(...arguments);ie(this,"peerId");ie(this,"peerMetadata")}},IndexedDBStorageAdapter=class{constructor(e="automerge",t="documents"){ie(this,"database");ie(this,"store");ie(this,"dbPromise");this.database=e,this.store=t,this.dbPromise=this.createDatabasePromise()}createDatabasePromise(){return new Promise((e,t)=>{const r=indexedDB.open(this.database,1);r.onerror=()=>{t(r.error)},r.onupgradeneeded=n=>{n.target.result.createObjectStore(this.store)},r.onsuccess=n=>{const o=n.target.result;e(o)}})}async load(e){const t=(await this.dbPromise).transaction(this.store),r=t.objectStore(this.store).get(e);return new Promise((n,o)=>{t.onerror=()=>{o(r.error)},r.onsuccess=s=>{const a=s.target.result;a&&typeof a=="object"&&"binary"in a?n(a.binary):n(void 0)}})}async save(e,t){const r=(await this.dbPromise).transaction(this.store,"readwrite");return r.objectStore(this.store).put({key:e,binary:t},e),new Promise((n,o)=>{r.onerror=()=>{o(r.error)},r.oncomplete=()=>{n()}})}async remove(e){const t=(await this.dbPromise).transaction(this.store,"readwrite");return t.objectStore(this.store).delete(e),new Promise((r,n)=>{t.onerror=()=>{n(t.error)},t.oncomplete=()=>{r()}})}async loadRange(e){const t=await this.dbPromise,r=e,n=[...e,"\uFFFF"],o=IDBKeyRange.bound(r,n),s=t.transaction(this.store),a=s.objectStore(this.store).openCursor(o),c=[];return new Promise((l,h)=>{s.onerror=()=>{h(a.error)},a.onsuccess=u=>{const d=u.target.result;d?(c.push({data:d.value.binary,key:d.key}),d.continue()):l(c)}})}async removeRange(e){const t=await this.dbPromise,r=e,n=[...e,"\uFFFF"],o=IDBKeyRange.bound(r,n),s=t.transaction(this.store,"readwrite");return s.objectStore(this.store).delete(o),new Promise((a,c)=>{s.onerror=()=>{c(s.error)},s.oncomplete=()=>{a()}})}},__dxlog_file$b="/home/runner/work/dxos/dxos/packages/core/mesh/teleport-extension-automerge-replicator/src/automerge-replicator.ts",RPC_TIMEOUT$2=1e4,NUM_RETRIES_BEFORE_BACKOFF=3,RETRY_BACKOFF=1e3,MAX_RETRIES=10,AutomergeReplicator=class{constructor(e,t={}){this._params=e,this._callbacks=t,this._opened=new Trigger}async onOpen(e){log("onOpen",{localPeerId:e.localPeerId,remotePeerId:e.remotePeerId},{F:__dxlog_file$b,L:60,S:this,C:(t,r)=>t(...r)}),this._rpc=createProtoRpcPeer({timeout:RPC_TIMEOUT$2,requested:{AutomergeReplicatorService:schema.getService("dxos.mesh.teleport.automerge.AutomergeReplicatorService")},exposed:{AutomergeReplicatorService:schema.getService("dxos.mesh.teleport.automerge.AutomergeReplicatorService")},handlers:{AutomergeReplicatorService:{startReplication:async t=>{var r,n;log("startReplication",{localPeerId:e.localPeerId,remotePeerId:e.remotePeerId,info:t},{F:__dxlog_file$b,L:73,S:this,C:(o,s)=>o(...s)}),await((n=(r=this._callbacks).onStartReplication)==null?void 0:n.call(r,t,e.remotePeerId))},sendSyncMessage:async t=>{var r,n;log("sendSyncMessage",{localPeerId:e.localPeerId,remotePeerId:e.remotePeerId,message:t},{F:__dxlog_file$b,L:77,S:this,C:(o,s)=>o(...s)}),await((n=(r=this._callbacks).onSyncMessage)==null?void 0:n.call(r,t))}}},port:await e.createPort("rpc",{contentType:'application/x-protobuf; messageType="dxos.rpc.Message"'})}),await this._rpc.open(),await this._rpc.rpc.AutomergeReplicatorService.startReplication({id:this._params.peerId}),this._opened.wake()}async onClose(e){var t,r,n;this._opened.reset(),await((t=this._rpc)==null?void 0:t.close()),this._rpc=void 0,await((n=(r=this._callbacks).onClose)==null?void 0:n.call(r,e))}async onAbort(e){var t,r,n;log("abort",{err:e},{F:__dxlog_file$b,L:98,S:this,C:(o,s)=>o(...s)});try{await((t=this._rpc)==null?void 0:t.abort())}catch(o){log.catch(o,void 0,{F:__dxlog_file$b,L:102,S:this,C:(s,a)=>s(...a)})}finally{await((n=(r=this._callbacks).onClose)==null?void 0:n.call(r,e))}}async sendSyncMessage(e){await this._opened.wait(),invariant$1(this._rpc,"RPC not initialized",{F:__dxlog_file$b,L:110,S:this,A:["this._rpc","'RPC not initialized'"]});let t=0;for(;;)try{await this._rpc.rpc.AutomergeReplicatorService.sendSyncMessage(e);break}catch(r){if(r instanceof RpcClosedError)return;if(log("sendSyncMessage error",{err:r},{F:__dxlog_file$b,L:122,S:this,C:(n,o)=>n(...o)}),t++,t>=MAX_RETRIES)throw new Error(`Failed to send sync message after ${MAX_RETRIES} retries. Last attempt failed with error: ${r}`);t%NUM_RETRIES_BEFORE_BACKOFF===0&&await sleep(RETRY_BACKOFF)}}};function _ts_decorate$9(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$a="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/echo-network-adapter.ts",EchoNetworkAdapter=class extends NetworkAdapter{constructor(e){super(),this._params=e,this._replicators=new Set,this._connections=new Map,this._lifecycleState=LifecycleState.CLOSED,this._connected=new Trigger}connect(e,t){this.peerId=e,this.peerMetadata=t,this._connected.wake()}send(e){const t=this._connections.get(e.targetId);if(!t)throw new Error("Connection not found.");t.writer.write(e).catch(r=>{t.isOpen&&log.catch(r,void 0,{F:__dxlog_file$a,L:49,S:this,C:(n,o)=>n(...o)})})}disconnect(){}async open(){invariant$1(this._lifecycleState===LifecycleState.CLOSED,void 0,{F:__dxlog_file$a,L:60,S:this,A:["this._lifecycleState === LifecycleState.CLOSED",""]}),this._lifecycleState=LifecycleState.OPEN,log("emit ready",void 0,{F:__dxlog_file$a,L:63,S:this,C:(e,t)=>e(...t)}),this.emit("ready",{network:this})}async close(){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file$a,L:71,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]});for(const e of this._replicators)await e.disconnect();this._replicators.clear(),this._lifecycleState=LifecycleState.CLOSED}async whenConnected(){await this._connected.wait({timeout:1e4})}async addReplicator(e){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file$a,L:87,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]}),invariant$1(this.peerId,void 0,{F:__dxlog_file$a,L:88,S:this,A:["this.peerId",""]}),invariant$1(!this._replicators.has(e),void 0,{F:__dxlog_file$a,L:89,S:this,A:["!this._replicators.has(replicator)",""]}),this._replicators.add(e),await e.connect({peerId:this.peerId,onConnectionOpen:this._onConnectionOpen.bind(this),onConnectionClosed:this._onConnectionClosed.bind(this),getContainingSpaceForDocument:this._params.getContainingSpaceForDocument})}async removeReplicator(e){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file$a,L:102,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]}),invariant$1(this._replicators.has(e),void 0,{F:__dxlog_file$a,L:103,S:this,A:["this._replicators.has(replicator)",""]}),await e.disconnect(),this._replicators.delete(e)}async shouldAdvertize(e,t){const r=this._connections.get(e);return r?r.connection.shouldAdvertize(t):!1}_onConnectionOpen(e){log("Connection opened",{peerId:e.peerId},{F:__dxlog_file$a,L:119,S:this,C:(o,s)=>o(...s)}),invariant$1(!this._connections.has(e.peerId),void 0,{F:__dxlog_file$a,L:120,S:this,A:["!this._connections.has(connection.peerId as PeerId)",""]});const t=e.readable.getReader(),r=e.writable.getWriter(),n={connection:e,reader:t,writer:r,isOpen:!0};this._connections.set(e.peerId,n),queueMicrotask(async()=>{try{for(;;){const{done:o,value:s}=await t.read();if(o)break;this.emit("message",s)}}catch(o){n.isOpen&&log.catch(o,void 0,{F:__dxlog_file$a,L:139,S:this,C:(s,a)=>s(...a)})}}),log("emit peer-candidate",{peerId:e.peerId},{F:__dxlog_file$a,L:144,S:this,C:(o,s)=>o(...s)}),this.emit("peer-candidate",{peerId:e.peerId,peerMetadata:{dxos_peerSource:"EchoNetworkAdapter"}})}_onConnectionClosed(e){log("Connection closed",{peerId:e.peerId},{F:__dxlog_file$a,L:155,S:this,C:(r,n)=>r(...n)});const t=this._connections.get(e.peerId);invariant$1(t,void 0,{F:__dxlog_file$a,L:157,S:this,A:["entry",""]}),t.isOpen=!1,this.emit("peer-disconnected",{peerId:e.peerId}),t.reader.cancel().catch(r=>log.catch(r,void 0,{F:__dxlog_file$a,L:162,S:this,C:(n,o)=>n(...o)})),t.writer.abort().catch(r=>log.catch(r,void 0,{F:__dxlog_file$a,L:163,S:this,C:(n,o)=>n(...o)})),this._connections.delete(e.peerId)}};_ts_decorate$9([synchronized],EchoNetworkAdapter.prototype,"open",null),_ts_decorate$9([synchronized],EchoNetworkAdapter.prototype,"close",null),_ts_decorate$9([synchronized],EchoNetworkAdapter.prototype,"addReplicator",null),_ts_decorate$9([synchronized],EchoNetworkAdapter.prototype,"removeReplicator",null);var LevelDBStorageAdapter=class extends Resource{constructor(e){super(),this._params=e}async load(e){try{return this._lifecycleState!==LifecycleState.OPEN?void 0:await this._params.db.get(e,{...encodingOptions})}catch(t){if(isLevelDbNotFoundError(t))return;throw t}}async save(e,t){var n,o,s,a;if(this._lifecycleState!==LifecycleState.OPEN)return;const r=this._params.db.batch();await((o=(n=this._params.callbacks)==null?void 0:n.beforeSave)==null?void 0:o.call(n,{path:e,batch:r})),r.put(e,export_Buffer.from(t),{...encodingOptions}),await r.write(),await((a=(s=this._params.callbacks)==null?void 0:s.afterSave)==null?void 0:a.call(s,e))}async remove(e){this._lifecycleState===LifecycleState.OPEN&&await this._params.db.del(e,{...encodingOptions})}async loadRange(e){if(this._lifecycleState!==LifecycleState.OPEN)return[];const t=[];for await(const[r,n]of this._params.db.iterator({gte:e,lte:[...e,"\uFFFF"],...encodingOptions}))t.push({key:r,data:n});return t}async removeRange(e){if(this._lifecycleState!==LifecycleState.OPEN)return;const t=this._params.db.batch();for await(const[r]of this._params.db.iterator({gte:e,lte:[...e,"\uFFFF"],...encodingOptions}))t.del(r,{...encodingOptions});await t.write()}},keyEncoder={encode:e=>export_Buffer.from(e.map(t=>t.replaceAll("%","%25").replaceAll("-","%2D")).join("-")),decode:e=>export_Buffer.from(e).toString().split("-").map(t=>t.replaceAll("%2D","-").replaceAll("%25","%")),format:"buffer"},encodingOptions={keyEncoding:keyEncoder,valueEncoding:"buffer"},isLevelDbNotFoundError=e=>e.code==="LEVEL_NOT_FOUND",__dxlog_file2$5="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/local-host-network-adapter.ts",LocalHostNetworkAdapter=class extends NetworkAdapter{constructor(){super(...arguments),this._peers=new Map,this._connected=new Trigger,this._isConnected=!1}ready(){this.emit("ready",{network:this})}connect(e){this.peerId=e,this._isConnected=!0,this._connected.wake()}send(e){const t=this._peers.get(e.targetId);invariant$1(t,"Peer not found.",{F:__dxlog_file2$5,L:51,S:this,A:["peer","'Peer not found.'"]}),t.send(e)}async close(){this._peers.forEach(e=>e.disconnect()),this.emit("close")}disconnect(){}async whenConnected(){await this._connected.wait({timeout:1e4})}syncRepo({id:e,syncMessage:t}){const r=this._getPeerId(e);return new Stream$2(({next:n,close:o})=>{invariant$1(!this._peers.has(r),"Peer already connected.",{F:__dxlog_file2$5,L:73,S:this,A:["!this._peers.has(peerId)","'Peer already connected.'"]}),this._peers.set(r,{connected:!0,send:s=>{n({syncMessage:cbor_exports.encode(s)})},disconnect:()=>{this._peers.delete(r),o(),this.emit("peer-disconnected",{peerId:r})}}),invariant$1(this._isConnected,void 0,{F:__dxlog_file2$5,L:90,S:this,A:["this._isConnected",""]}),this.emit("peer-candidate",{peerMetadata:{},peerId:r})})}async sendSyncMessage({id:e,syncMessage:t}){invariant$1(this._isConnected,void 0,{F:__dxlog_file2$5,L:99,S:this,A:["this._isConnected",""]});const r=cbor_exports.decode(t);this.emit("message",r)}async getHostInfo(){return invariant$1(this._isConnected,void 0,{F:__dxlog_file2$5,L:105,S:this,A:["this._isConnected",""]}),invariant$1(this.peerId,"Peer id not set.",{F:__dxlog_file2$5,L:106,S:this,A:["this.peerId","'Peer id not set.'"]}),{peerId:this.peerId}}_getPeerId(e){return e}},AutomergeStorageAdapter=class{constructor(e){this._directory=e,this._state="opened"}async load(e){if(this._state!=="opened")return;const t=this._getFilename(e),r=this._directory.getOrCreateFile(t),{size:n}=await r.stat();if(!n||n===0)return;const o=await r.read(0,n);return bufferToArray(o)}async save(e,t){var o,s;if(this._state!=="opened")return;const r=this._getFilename(e),n=this._directory.getOrCreateFile(r);await n.write(0,arrayToBuffer(t)),await((o=n.truncate)==null?void 0:o.call(n,t.length)),await((s=n.flush)==null?void 0:s.call(n))}async remove(e){if(this._state!=="opened")return;const t=this._getFilename(e);await this._directory.getOrCreateFile(t).destroy()}async loadRange(e){if(this._state!=="opened")return[];const t=this._getFilename(e),r=await this._directory.list();return Promise.all(r.filter(n=>n.startsWith(t)).map(async n=>{const o=this._directory.getOrCreateFile(n),{size:s}=await o.stat(),a=await o.read(0,s);return{key:this._getKeyFromFilename(n),data:bufferToArray(a)}}))}async removeRange(e){if(this._state!=="opened")return;const t=this._getFilename(e),r=await this._directory.list();await Promise.all(r.filter(n=>n.startsWith(t)).map(async n=>{await this._directory.getOrCreateFile(n).destroy()}))}async close(){this._state="closed"}_getFilename(e){return e.map(t=>t.replaceAll("%","%25").replaceAll("-","%2D")).join("-")}_getKeyFromFilename(e){return e.split("-").map(t=>t.replaceAll("%2D","-").replaceAll("%25","%"))}},__dxlog_file3$4="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/migrations.ts",levelMigration=async({db:e,directory:t})=>{if(await e.iterator({...encodingOptions}).next())return;const r=t.type===StorageType.IDB?new IndexedDBStorageAdapter(t.path,"data"):new AutomergeStorageAdapter(t),n=await r.loadRange([]);if(n.length===0)return;const o=e.batch();log.info("found chunks on old storage adapter",{chunks:n.length},{F:__dxlog_file3$4,L:36,S:void 0,C:(s,a)=>s(...a)});for(const{key:s,data:a}of await r.loadRange([]))a&&o.put(s,a,{...encodingOptions});await o.write()};function _ts_decorate2$4(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file4$3="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/automerge-host.ts",AutomergeHost=class{constructor({directory:e,db:t,indexMetadataStore:r}){this._ctx=new Context,this._echoNetworkAdapter=new EchoNetworkAdapter({getContainingSpaceForDocument:this._getContainingSpaceForDocument.bind(this)}),this._requestedDocs=new Set,this._directory=e,this._db=t,this._indexMetadataStore=r}async open(){var e,t;this._directory&&await levelMigration({db:this._db,directory:this._directory}),this._storage=new LevelDBStorageAdapter({db:this._db,callbacks:{beforeSave:async r=>this._beforeSave(r),afterSave:async()=>this._afterSave()}}),await((t=(e=this._storage).open)==null?void 0:t.call(e)),this._peerId=`host-${PublicKey.random().toHex()}`,this._clientNetwork=new LocalHostNetworkAdapter,this._repo=new Repo({peerId:this._peerId,network:[this._clientNetwork,this._echoNetworkAdapter],storage:this._storage,sharePolicy:this._sharePolicy.bind(this)}),this._clientNetwork.ready(),await this._echoNetworkAdapter.open(),await this._clientNetwork.whenConnected(),await this._echoNetworkAdapter.whenConnected()}async close(){var e,t;await((t=(e=this._storage).close)==null?void 0:t.call(e)),await this._clientNetwork.close(),await this._echoNetworkAdapter.close(),await this._ctx.dispose()}get repo(){return this._repo}async addReplicator(e){await this._echoNetworkAdapter.addReplicator(e)}async removeReplicator(e){await this._echoNetworkAdapter.removeReplicator(e)}async _sharePolicy(e,t){var r,n;if(e.startsWith("client-")||!t)return!1;if(!((r=this._repo.handles[t])!=null&&r.docSync())){const o=this._requestedDocs.has(`automerge:${t}`);return log("doc share policy check",{peerId:e,documentId:t,isRequested:o},{F:__dxlog_file4$3,L:149,S:this,C:(s,a)=>s(...a)}),o}return((n=this.repo.peerMetadataByPeerId[e])==null?void 0:n.dxos_peerSource)==="EchoNetworkAdapter"?this._echoNetworkAdapter.shouldAdvertize(e,{documentId:t}):!1}async _beforeSave({path:e,batch:t}){const r=this._repo.handles[e[0]];if(!r)return;const n=r.docSync();if(!n)return;const o=getSpaceKeyFromDoc(n)??void 0,s=getHeads(n),a=Object.keys(n.objects??{}).map(l=>objectPointerCodec.encode({documentId:r.documentId,objectId:l,spaceKey:o})),c=new Map(a.map(l=>[l,s]));this._indexMetadataStore.markDirty(c,t)}async _afterSave(){this._indexMetadataStore.notifyMarkedDirty()}_automergeDocs(){return mapValues$1(this._repo.handles,e=>({state:e.state,hasDoc:!!e.docSync(),heads:e.docSync()?next_exports.getHeads(e.docSync()):null,data:e.docSync()&&mapValues$1(e.docSync(),(t,r)=>{try{switch(r){case"access":case"links":return t;case"objects":return Object.keys(t);default:return`${t}`}}catch(n){return`${n}`}})}))}_automergePeers(){return this._repo.peers}async _getContainingSpaceForDocument(e){var n;const t=(n=this._repo.handles[e])==null?void 0:n.docSync();if(!t)return null;const r=getSpaceKeyFromDoc(t);return r?PublicKey.from(r):null}async flush({states:e}){await Promise.all((e==null?void 0:e.map(async({heads:t,documentId:r})=>{invariant$1(t,"heads are required for flush",{F:__dxlog_file4$3,L:243,S:this,A:["heads","'heads are required for flush'"]});const n=this.repo.handles[r]??this._repo.find(r);await waitForHeads(n,t)}))??[]),await this._repo.flush(e==null?void 0:e.map(({documentId:t})=>t))}syncRepo(e){return this._clientNetwork.syncRepo(e)}sendSyncMessage(e){return this._clientNetwork.sendSyncMessage(e)}async getHostInfo(){return this._clientNetwork.getHostInfo()}};_ts_decorate2$4([trace.info()],AutomergeHost.prototype,"_peerId",void 0),_ts_decorate2$4([trace.info({depth:null})],AutomergeHost.prototype,"_automergeDocs",null),_ts_decorate2$4([trace.info({depth:null})],AutomergeHost.prototype,"_automergePeers",null),_ts_decorate2$4([trace.span({showInBrowserTimeline:!0})],AutomergeHost.prototype,"flush",null),AutomergeHost=_ts_decorate2$4([trace.resource()],AutomergeHost);var getSpaceKeyFromDoc=e=>{var r;const t=((r=e.access)==null?void 0:r.spaceKey)??e.experimental_spaceKey;return t==null?null:String(t)},waitForHeads=async(e,t)=>{await e.whenReady();const r=new Set(t);await Event$1.wrap(e,"change").waitForCondition(()=>{for(const n of r.values())changeIsPresentInDoc(e.docSync(),n)&&r.delete(n);return r.size===0})},changeIsPresentInDoc=(e,t)=>!!getBackend(e).getChangeByHash(t);function _ts_decorate3$3(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file5$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/automerge-doc-loader.ts",AutomergeDocumentLoaderImpl=class{constructor(e,t){this._spaceKey=e,this._repo=t,this._spaceRootDocHandle=null,this._objectDocumentHandles=new Map,this._objectsPendingDocumentLoad=new Set,this.onObjectDocumentLoaded=new Event$1}getAllHandles(){return this._spaceRootDocHandle!=null?[this._spaceRootDocHandle,...new Set(this._objectDocumentHandles.values())]:[]}async loadSpaceRootDocHandle(e,t){if(this._spaceRootDocHandle==null)if(!t.rootUrl)log.error("Database opened with no rootUrl",{spaceKey:this._spaceKey},{F:__dxlog_file5$1,L:70,S:this,C:(r,n)=>r(...n)}),this._createContextBoundSpaceRootDocument(e);else{const r=await this._initDocHandle(e,t.rootUrl),n=r.docSync();invariant$1(n,void 0,{F:__dxlog_file5$1,L:75,S:this,A:["doc",""]}),n.access==null&&this._initDocAccess(r),this._spaceRootDocHandle=r}}loadObjectDocument(e){const t=Array.isArray(e)?e:[e];let r=!1;const n={};for(const o of t){if(invariant$1(this._spaceRootDocHandle,void 0,{F:__dxlog_file5$1,L:88,S:this,A:["this._spaceRootDocHandle",""]}),this._objectDocumentHandles.has(o)||this._objectsPendingDocumentLoad.has(o))continue;const s=this._spaceRootDocHandle.docSync();invariant$1(s,void 0,{F:__dxlog_file5$1,L:93,S:this,A:["spaceRootDoc",""]});const a=(s.links??{})[o];a==null?(this._objectsPendingDocumentLoad.add(o),log.info("loading delayed until object links are initialized",{objectId:o},{F:__dxlog_file5$1,L:97,S:this,C:(c,l)=>c(...l)})):(n[o]=a,r=!0)}r&&this._loadLinkedObjects(n)}onObjectLinksUpdated(e){if(!e)return;const t=Object.entries(e).filter(([r])=>this._objectsPendingDocumentLoad.has(r));this._loadLinkedObjects(Object.fromEntries(t)),t.forEach(([r])=>this._objectsPendingDocumentLoad.delete(r))}getSpaceRootDocHandle(){return invariant$1(this._spaceRootDocHandle,void 0,{F:__dxlog_file5$1,L:120,S:this,A:["this._spaceRootDocHandle",""]}),this._spaceRootDocHandle}createDocumentForObject(e){invariant$1(this._spaceRootDocHandle,void 0,{F:__dxlog_file5$1,L:125,S:this,A:["this._spaceRootDocHandle",""]});const t=this._repo.create();return this._initDocAccess(t),this.onObjectBoundToDocument(t,e),this._spaceRootDocHandle.change(r=>{r.links??(r.links={}),r.links[e]=t.url}),t}onObjectBoundToDocument(e,t){this._objectDocumentHandles.set(t,e)}clearHandleReferences(){const e=[...this._objectDocumentHandles.keys()];return this._objectDocumentHandles.clear(),this._spaceRootDocHandle=null,e}_loadLinkedObjects(e){if(e)for(const[t,r]of Object.entries(e)){const n={objectId:t,automergeUrl:r},o=this._objectDocumentHandles.get(t);if(o!=null&&o.url!==r){log.warn("object already inlined in a different document, ignoring the link",{...n,actualDocumentUrl:o.url},{F:__dxlog_file5$1,L:155,S:this,C:(a,c)=>a(...c)});continue}if((o==null?void 0:o.url)===r){log.warn("object document was already loaded",n,{F:__dxlog_file5$1,L:162,S:this,C:(a,c)=>a(...c)});continue}const s=this._repo.find(r);log.debug("document loading triggered",n,{F:__dxlog_file5$1,L:166,S:this,C:(a,c)=>a(...c)}),this._objectDocumentHandles.set(t,s),this._createObjectOnDocumentLoad(s,t)}}async _initDocHandle(e,t){const r=this._repo.find(t);for(;;)try{await warnAfterTimeout(5e3,"Automerge root doc load timeout (AutomergeDb)",async()=>{await cancelWithContext(e,r.whenReady())});break}catch(n){if(`${n}`.includes("Timeout")){log.info("wraparound",{id:r.documentId,state:r.state},{F:__dxlog_file5$1,L:182,S:this,C:(o,s)=>o(...s)});continue}throw n}if(r.state==="unavailable")throw new Error("Automerge document is unavailable");return r}_createContextBoundSpaceRootDocument(e){const t=this._repo.create();this._spaceRootDocHandle=t,e.onDispose(()=>{t.delete(),this._spaceRootDocHandle=null})}_initDocAccess(e){e.change(t=>{t.access??(t.access={spaceKey:this._spaceKey.toHex()}),t.access.spaceKey=this._spaceKey.toHex()})}async _createObjectOnDocumentLoad(e,t){var r;try{await e.doc(["ready"]);const n={objectId:t,docUrl:e.url};if(this.onObjectDocumentLoaded.listenerCount()===0){log.info("document loaded after all listeners were removed",n,{F:__dxlog_file5$1,L:218,S:this,C:(o,s)=>o(...s)});return}if(((r=this._objectDocumentHandles.get(t))==null?void 0:r.url)!==e.url){log.warn("object was rebound while a document was loading, discarding handle",n,{F:__dxlog_file5$1,L:223,S:this,C:(o,s)=>o(...s)});return}this.onObjectDocumentLoaded.emit({handle:e,objectId:t})}catch(n){const o=this.onObjectDocumentLoaded.listenerCount()>0;log.warn("failed to load a document",{objectId:t,automergeUrl:e.url,retryLoading:o,err:n},{F:__dxlog_file5$1,L:229,S:this,C:(s,a)=>s(...a)}),o&&await this._createObjectOnDocumentLoad(e,t)}}};_ts_decorate3$3([trace.span({showInBrowserTimeline:!0})],AutomergeDocumentLoaderImpl.prototype,"loadSpaceRootDocHandle",null),AutomergeDocumentLoaderImpl=_ts_decorate3$3([trace.resource()],AutomergeDocumentLoaderImpl);var __dxlog_file6$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-pipeline/src/automerge/mesh-echo-replicator.ts",MeshEchoReplicator=class{constructor(){this._connections=new Set,this._connectionsPerPeer=new Map,this._authorizedDevices=new ComplexMap(PublicKey.hash),this._context=null}async connect(e){this._context=e}async disconnect(){for(const e of this._connections)await e.close();this._connections.clear(),this._connectionsPerPeer.clear(),this._context=null}createExtension(){invariant$1(this._context,void 0,{F:__dxlog_file6$2,L:54,S:this,A:["this._context",""]});const e=new MeshReplicatorConnection({ownPeerId:this._context.peerId,onRemoteConnected:async()=>{log("onRemoteConnected",{peerId:e.peerId},{F:__dxlog_file6$2,L:59,S:this,C:(t,r)=>t(...r)}),invariant$1(this._context,void 0,{F:__dxlog_file6$2,L:60,S:this,A:["this._context",""]}),this._connectionsPerPeer.has(e.peerId)||(this._connectionsPerPeer.set(e.peerId,e),await e.enable(),this._context.onConnectionOpen(e))},onRemoteDisconnected:async()=>{var t;log("onRemoteDisconnected",{peerId:e.peerId},{F:__dxlog_file6$2,L:69,S:this,C:(r,n)=>r(...n)}),(t=this._context)==null||t.onConnectionClosed(e),await e.disable(),this._connectionsPerPeer.delete(e.peerId),this._connections.delete(e)},shouldAdvertize:async t=>{log("shouldAdvertize",{peerId:e.peerId,documentId:t.documentId},{F:__dxlog_file6$2,L:76,S:this,C:(r,n)=>r(...n)}),invariant$1(this._context,void 0,{F:__dxlog_file6$2,L:77,S:this,A:["this._context",""]});try{const r=await this._context.getContainingSpaceForDocument(t.documentId);if(!r)return log("space key not found for share policy check",{peerId:e.peerId,documentId:t.documentId},{F:__dxlog_file6$2,L:81,S:this,C:(s,a)=>s(...a)}),!1;const n=this._authorizedDevices.get(r);if(!e.remoteDeviceKey)return log("device key not found for share policy check",{peerId:e.peerId,documentId:t.documentId},{F:__dxlog_file6$2,L:91,S:this,C:(s,a)=>s(...a)}),!1;const o=(n==null?void 0:n.has(e.remoteDeviceKey))??!1;return log("share policy check",{localPeer:this._context.peerId,remotePeer:e.peerId,documentId:t.documentId,deviceKey:e.remoteDeviceKey,spaceKey:r,isAuthorized:o},{F:__dxlog_file6$2,L:99,S:this,C:(s,a)=>s(...a)}),o}catch(r){return log.catch(r,void 0,{F:__dxlog_file6$2,L:109,S:this,C:(n,o)=>n(...o)}),!1}}});return this._connections.add(e),e.replicatorExtension}authorizeDevice(e,t){log("authorizeDevice",{spaceKey:e,deviceKey:t},{F:__dxlog_file6$2,L:120,S:this,C:(r,n)=>r(...n)}),defaultMap(this._authorizedDevices,e,()=>new ComplexSet(PublicKey.hash)).add(t)}},MeshReplicatorConnection=class extends Resource{constructor(e){super(),this._params=e,this.remoteDeviceKey=null,this._remotePeerId=null,this._isEnabled=!1;let t;this.readable=new ReadableStream({start:r=>{t=r,this._ctx.onDispose(()=>r.close())}}),this.writable=new WritableStream({write:async(r,n)=>{this.replicatorExtension.sendSyncMessage({payload:cbor_exports.encode(r)}).catch(o=>{n.error(o)})}}),this.replicatorExtension=new AutomergeReplicator({peerId:this._params.ownPeerId},{onStartReplication:async(r,n)=>{this.remoteDeviceKey=n,this._remotePeerId=r.id,log("onStartReplication",{id:r.id,thisPeerId:this.peerId,remotePeerId:n.toHex()},{F:__dxlog_file6$2,L:185,S:this,C:(o,s)=>o(...s)}),await this._params.onRemoteConnected()},onSyncMessage:async({payload:r})=>{if(!this._isEnabled)return;const n=cbor_exports.decode(r);t.enqueue(n)},onClose:async()=>{this._isEnabled&&await this._params.onRemoteDisconnected()}})}get peerId(){return invariant$1(this._remotePeerId!=null,"Remote peer has not connected yet.",{F:__dxlog_file6$2,L:208,S:this,A:["this._remotePeerId != null","'Remote peer has not connected yet.'"]}),this._remotePeerId}async shouldAdvertize(e){return this._params.shouldAdvertize(e)}async enable(){invariant$1(this._remotePeerId!=null,"Remote peer has not connected yet.",{F:__dxlog_file6$2,L:221,S:this,A:["this._remotePeerId != null","'Remote peer has not connected yet.'"]}),this._isEnabled=!0}async disable(){this._isEnabled=!1}},FUNC_ERROR_TEXT$1="Expected a function",HASH_UNDEFINED$1="__lodash_hash_undefined__",INFINITY$1=1/0,funcTag$1="[object Function]",genTag$1="[object GeneratorFunction]",symbolTag$1="[object Symbol]",reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/,reLeadingDot$1=/^\./,rePropName$1=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reRegExpChar$1=/[\\^$.*+?()[\]{}|]/g,reEscapeChar$1=/\\(\\)?/g,reIsHostCtor$1=/^\[object .+?Constructor\]$/,freeGlobal$1=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf$1=typeof self=="object"&&self&&self.Object===Object&&self,root$1=freeGlobal$1||freeSelf$1||Function("return this")();function getValue$1(e,t){return e==null?void 0:e[t]}function isHostObject$1(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}var arrayProto$1=Array.prototype,funcProto$1=Function.prototype,objectProto$1=Object.prototype,coreJsData$1=root$1["__core-js_shared__"],maskSrcKey$1=function(){var e=/[^.]+$/.exec(coreJsData$1&&coreJsData$1.keys&&coreJsData$1.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),funcToString$1=funcProto$1.toString,hasOwnProperty$2=objectProto$1.hasOwnProperty,objectToString$1=objectProto$1.toString,reIsNative$1=RegExp("^"+funcToString$1.call(hasOwnProperty$2).replace(reRegExpChar$1,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Symbol$2=root$1.Symbol,splice$1=arrayProto$1.splice,Map$2=getNative$1(root$1,"Map"),nativeCreate$1=getNative$1(Object,"create"),symbolProto$1=Symbol$2?Symbol$2.prototype:void 0,symbolToString$1=symbolProto$1?symbolProto$1.toString:void 0;function Hash$1(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function hashClear$1(){this.__data__=nativeCreate$1?nativeCreate$1(null):{}}function hashDelete$1(e){return this.has(e)&&delete this.__data__[e]}function hashGet$1(e){var t=this.__data__;if(nativeCreate$1){var r=t[e];return r===HASH_UNDEFINED$1?void 0:r}return hasOwnProperty$2.call(t,e)?t[e]:void 0}function hashHas$1(e){var t=this.__data__;return nativeCreate$1?t[e]!==void 0:hasOwnProperty$2.call(t,e)}function hashSet$1(e,t){var r=this.__data__;return r[e]=nativeCreate$1&&t===void 0?HASH_UNDEFINED$1:t,this}Hash$1.prototype.clear=hashClear$1,Hash$1.prototype.delete=hashDelete$1,Hash$1.prototype.get=hashGet$1,Hash$1.prototype.has=hashHas$1,Hash$1.prototype.set=hashSet$1;function ListCache$1(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function listCacheClear$1(){this.__data__=[]}function listCacheDelete$1(e){var t=this.__data__,r=assocIndexOf$1(t,e);if(r<0)return!1;var n=t.length-1;return r==n?t.pop():splice$1.call(t,r,1),!0}function listCacheGet$1(e){var t=this.__data__,r=assocIndexOf$1(t,e);return r<0?void 0:t[r][1]}function listCacheHas$1(e){return assocIndexOf$1(this.__data__,e)>-1}function listCacheSet$1(e,t){var r=this.__data__,n=assocIndexOf$1(r,e);return n<0?r.push([e,t]):r[n][1]=t,this}ListCache$1.prototype.clear=listCacheClear$1,ListCache$1.prototype.delete=listCacheDelete$1,ListCache$1.prototype.get=listCacheGet$1,ListCache$1.prototype.has=listCacheHas$1,ListCache$1.prototype.set=listCacheSet$1;function MapCache$1(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function mapCacheClear$1(){this.__data__={hash:new Hash$1,map:new(Map$2||ListCache$1),string:new Hash$1}}function mapCacheDelete$1(e){return getMapData$1(this,e).delete(e)}function mapCacheGet$1(e){return getMapData$1(this,e).get(e)}function mapCacheHas$1(e){return getMapData$1(this,e).has(e)}function mapCacheSet$1(e,t){return getMapData$1(this,e).set(e,t),this}MapCache$1.prototype.clear=mapCacheClear$1,MapCache$1.prototype.delete=mapCacheDelete$1,MapCache$1.prototype.get=mapCacheGet$1,MapCache$1.prototype.has=mapCacheHas$1,MapCache$1.prototype.set=mapCacheSet$1;function assocIndexOf$1(e,t){for(var r=e.length;r--;)if(eq$1(e[r][0],t))return r;return-1}function baseGet(e,t){t=isKey(t,e)?[t]:castPath(t);for(var r=0,n=t.length;e!=null&&r<n;)e=e[toKey(t[r++])];return r&&r==n?e:void 0}function baseIsNative$1(e){if(!isObject$1(e)||isMasked$1(e))return!1;var t=isFunction$1(e)||isHostObject$1(e)?reIsNative$1:reIsHostCtor$1;return t.test(toSource$1(e))}function baseToString$1(e){if(typeof e=="string")return e;if(isSymbol$1(e))return symbolToString$1?symbolToString$1.call(e):"";var t=e+"";return t=="0"&&1/e==-INFINITY$1?"-0":t}function castPath(e){return isArray(e)?e:stringToPath(e)}function getMapData$1(e,t){var r=e.__data__;return isKeyable$1(t)?r[typeof t=="string"?"string":"hash"]:r.map}function getNative$1(e,t){var r=getValue$1(e,t);return baseIsNative$1(r)?r:void 0}function isKey(e,t){if(isArray(e))return!1;var r=typeof e;return r=="number"||r=="symbol"||r=="boolean"||e==null||isSymbol$1(e)?!0:reIsPlainProp.test(e)||!reIsDeepProp.test(e)||t!=null&&e in Object(t)}function isKeyable$1(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}function isMasked$1(e){return!!maskSrcKey$1&&maskSrcKey$1 in e}var stringToPath=memoize$1(function(e){e=toString$2(e);var t=[];return reLeadingDot$1.test(e)&&t.push(""),e.replace(rePropName$1,function(r,n,o,s){t.push(o?s.replace(reEscapeChar$1,"$1"):n||r)}),t});function toKey(e){if(typeof e=="string"||isSymbol$1(e))return e;var t=e+"";return t=="0"&&1/e==-INFINITY$1?"-0":t}function toSource$1(e){if(e!=null){try{return funcToString$1.call(e)}catch{}try{return e+""}catch{}}return""}function memoize$1(e,t){if(typeof e!="function"||t&&typeof t!="function")throw new TypeError(FUNC_ERROR_TEXT$1);var r=function(){var n=arguments,o=t?t.apply(this,n):n[0],s=r.cache;if(s.has(o))return s.get(o);var a=e.apply(this,n);return r.cache=s.set(o,a),a};return r.cache=new(memoize$1.Cache||MapCache$1),r}memoize$1.Cache=MapCache$1;function eq$1(e,t){return e===t||e!==e&&t!==t}var isArray=Array.isArray;function isFunction$1(e){var t=isObject$1(e)?objectToString$1.call(e):"";return t==funcTag$1||t==genTag$1}function isObject$1(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function isObjectLike$1(e){return!!e&&typeof e=="object"}function isSymbol$1(e){return typeof e=="symbol"||isObjectLike$1(e)&&objectToString$1.call(e)==symbolTag$1}function toString$2(e){return e==null?"":baseToString$1(e)}function get(e,t,r){var n=e==null?void 0:baseGet(e,t);return n===void 0?r:n}var lodash_get=get;const get$1=getDefaultExportFromCjs(lodash_get);(function(e){(function(t){t[t.HIDE_DELETED=0]="HIDE_DELETED",t[t.SHOW_DELETED=1]="SHOW_DELETED",t[t.SHOW_DELETED_ONLY=2]="SHOW_DELETED_ONLY"})(e.ShowDeletedOption||(e.ShowDeletedOption={})),function(t){t[t.ALL=0]="ALL",t[t.LOCAL=1]="LOCAL",t[t.REMOTE=2]="REMOTE"}(e.DataLocation||(e.DataLocation={}))})(QueryOptions||(QueryOptions={}));var lodash_isequal={exports:{}};lodash_isequal.exports,function(e,t){var r=200,n="__lodash_hash_undefined__",o=1,s=2,a=9007199254740991,c="[object Arguments]",l="[object Array]",h="[object AsyncFunction]",u="[object Boolean]",d="[object Date]",f="[object Error]",_="[object Function]",p="[object GeneratorFunction]",y="[object Map]",w="[object Number]",E="[object Null]",x="[object Object]",B="[object Promise]",P="[object Proxy]",U="[object RegExp]",F="[object Set]",G="[object String]",H="[object Symbol]",te="[object Undefined]",J="[object WeakMap]",le="[object ArrayBuffer]",z="[object DataView]",q="[object Float32Array]",he="[object Float64Array]",V="[object Int8Array]",_e="[object Int16Array]",ee="[object Int32Array]",W="[object Uint8Array]",re="[object Uint8ClampedArray]",ne="[object Uint16Array]",ge="[object Uint32Array]",de=/[\\^$.*+?()[\]{}|]/g,ye=/^\[object .+?Constructor\]$/,Ce=/^(?:0|[1-9]\d*)$/,ke={};ke[q]=ke[he]=ke[V]=ke[_e]=ke[ee]=ke[W]=ke[re]=ke[ne]=ke[ge]=!0,ke[c]=ke[l]=ke[le]=ke[u]=ke[z]=ke[d]=ke[f]=ke[_]=ke[y]=ke[w]=ke[x]=ke[U]=ke[F]=ke[G]=ke[J]=!1;var ae=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,Q=typeof self=="object"&&self&&self.Object===Object&&self,C=ae||Q||Function("return this")(),$=t&&!t.nodeType&&t,j=$&&!0&&e&&!e.nodeType&&e,O=j&&j.exports===$,k=O&&ae.process,ue=function(){try{return k&&k.binding&&k.binding("util")}catch{}}(),pe=ue&&ue.isTypedArray;function Oe(we,se){for(var Se=-1,oe=we==null?0:we.length,Ee=0,Te=[];++Se<oe;){var He=we[Se];se(He,Se,we)&&(Te[Ee++]=He)}return Te}function Le(we,se){for(var Se=-1,oe=se.length,Ee=we.length;++Se<oe;)we[Ee+Se]=se[Se];return we}function Me(we,se){for(var Se=-1,oe=we==null?0:we.length;++Se<oe;)if(se(we[Se],Se,we))return!0;return!1}function We(we,se){for(var Se=-1,oe=Array(we);++Se<we;)oe[Se]=se(Se);return oe}function Fe(we){return function(se){return we(se)}}function st(we,se){return we.has(se)}function ft(we,se){return we==null?void 0:we[se]}function rt(we){var se=-1,Se=Array(we.size);return we.forEach(function(oe,Ee){Se[++se]=[Ee,oe]}),Se}function lt(we,se){return function(Se){return we(se(Se))}}function At(we){var se=-1,Se=Array(we.size);return we.forEach(function(oe){Se[++se]=oe}),Se}var qe=Array.prototype,Je=Function.prototype,g=Object.prototype,b=C["__core-js_shared__"],T=Je.toString,ce=g.hasOwnProperty,fe=function(){var we=/[^.]+$/.exec(b&&b.keys&&b.keys.IE_PROTO||"");return we?"Symbol(src)_1."+we:""}(),ve=g.toString,Ne=RegExp("^"+T.call(ce).replace(de,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),tt=O?C.Buffer:void 0,ct=C.Symbol,ot=C.Uint8Array,it=g.propertyIsEnumerable,ut=qe.splice,dr=ct?ct.toStringTag:void 0,tr=Object.getOwnPropertySymbols,ir=tt?tt.isBuffer:void 0,Wr=lt(Object.keys,Object),qt=It(C,"DataView"),fr=It(C,"Map"),pr=It(C,"Promise"),Qt=It(C,"Set"),Nr=It(C,"WeakMap"),Ar=It(Object,"create"),jt=be(qt),Jr=be(fr),Xr=be(pr),Ut=be(Qt),Zr=be(Nr),Dr=ct?ct.prototype:void 0,Yt=Dr?Dr.valueOf:void 0;function _r(we){var se=-1,Se=we==null?0:we.length;for(this.clear();++se<Se;){var oe=we[se];this.set(oe[0],oe[1])}}function en(){this.__data__=Ar?Ar(null):{},this.size=0}function Gt(we){var se=this.has(we)&&delete this.__data__[we];return this.size-=se?1:0,se}function tn(we){var se=this.__data__;if(Ar){var Se=se[we];return Se===n?void 0:Se}return ce.call(se,we)?se[we]:void 0}function rn(we){var se=this.__data__;return Ar?se[we]!==void 0:ce.call(se,we)}function rr(we,se){var Se=this.__data__;return this.size+=this.has(we)?0:1,Se[we]=Ar&&se===void 0?n:se,this}_r.prototype.clear=en,_r.prototype.delete=Gt,_r.prototype.get=tn,_r.prototype.has=rn,_r.prototype.set=rr;function sr(we){var se=-1,Se=we==null?0:we.length;for(this.clear();++se<Se;){var oe=we[se];this.set(oe[0],oe[1])}}function nn(){this.__data__=[],this.size=0}function gr(we){var se=this.__data__,Se=Ie(se,we);if(Se<0)return!1;var oe=se.length-1;return Se==oe?se.pop():ut.call(se,Se,1),--this.size,!0}function sn(we){var se=this.__data__,Se=Ie(se,we);return Se<0?void 0:se[Se][1]}function an(we){return Ie(this.__data__,we)>-1}function Ht(we,se){var Se=this.__data__,oe=Ie(Se,we);return oe<0?(++this.size,Se.push([we,se])):Se[oe][1]=se,this}sr.prototype.clear=nn,sr.prototype.delete=gr,sr.prototype.get=sn,sr.prototype.has=an,sr.prototype.set=Ht;function nr(we){var se=-1,Se=we==null?0:we.length;for(this.clear();++se<Se;){var oe=we[se];this.set(oe[0],oe[1])}}function cn(){this.size=0,this.__data__={hash:new _r,map:new(fr||sr),string:new _r}}function lr(we){var se=Rt(this,we).delete(we);return this.size-=se?1:0,se}function ar(we){return Rt(this,we).get(we)}function qr(we){return Rt(this,we).has(we)}function Wt(we,se){var Se=Rt(this,we),oe=Se.size;return Se.set(we,se),this.size+=Se.size==oe?0:1,this}nr.prototype.clear=cn,nr.prototype.delete=lr,nr.prototype.get=ar,nr.prototype.has=qr,nr.prototype.set=Wt;function Jt(we){var se=-1,Se=we==null?0:we.length;for(this.__data__=new nr;++se<Se;)this.add(we[se])}function xr(we){return this.__data__.set(we,n),this}function wr(we){return this.__data__.has(we)}Jt.prototype.add=Jt.prototype.push=xr,Jt.prototype.has=wr;function hr(we){var se=this.__data__=new sr(we);this.size=se.size}function $r(){this.__data__=new sr,this.size=0}function Pr(we){var se=this.__data__,Se=se.delete(we);return this.size=se.size,Se}function Hr(we){return this.__data__.get(we)}function Qr(we){return this.__data__.has(we)}function me(we,se){var Se=this.__data__;if(Se instanceof sr){var oe=Se.__data__;if(!fr||oe.length<r-1)return oe.push([we,se]),this.size=++Se.size,this;Se=this.__data__=new nr(oe)}return Se.set(we,se),this.size=Se.size,this}hr.prototype.clear=$r,hr.prototype.delete=Pr,hr.prototype.get=Hr,hr.prototype.has=Qr,hr.prototype.set=me;function xe(we,se){var Se=Xe(we),oe=!Se&&Ue(we),Ee=!Se&&!oe&&at(we),Te=!Se&&!oe&&!Ee&&Mt(we),He=Se||oe||Ee||Te,et=He?We(we.length,String):[],Ze=et.length;for(var nt in we)ce.call(we,nt)&&!(He&&(nt=="length"||Ee&&(nt=="offset"||nt=="parent")||Te&&(nt=="buffer"||nt=="byteLength"||nt=="byteOffset")||br(nt,Ze)))&&et.push(nt);return et}function Ie(we,se){for(var Se=we.length;Se--;)if(De(we[Se][0],se))return Se;return-1}function Pe(we,se,Se){var oe=se(we);return Xe(we)?oe:Le(oe,Se(we))}function Re(we){return we==null?we===void 0?te:E:dr&&dr in Object(we)?Vt(we):Ge(we)}function Be(we){return Ot(we)&&Re(we)==c}function Ke(we,se,Se,oe,Ee){return we===se?!0:we==null||se==null||!Ot(we)&&!Ot(se)?we!==we&&se!==se:Qe(we,se,Se,oe,Ke,Ee)}function Qe(we,se,Se,oe,Ee,Te){var He=Xe(we),et=Xe(se),Ze=He?l:zt(we),nt=et?l:zt(se);Ze=Ze==c?x:Ze,nt=nt==c?x:nt;var pt=Ze==x,bt=nt==x,Nt=Ze==nt;if(Nt&&at(we)){if(!at(se))return!1;He=!0,pt=!1}if(Nt&&!pt)return Te||(Te=new hr),He||Mt(we)?ht(we,se,Se,oe,Ee,Te):_t(we,se,Ze,Se,oe,Ee,Te);if(!(Se&o)){var Pt=pt&&ce.call(we,"__wrapped__"),Xt=bt&&ce.call(se,"__wrapped__");if(Pt||Xt){var Er=Pt?we.value():we,Br=Xt?se.value():se;return Te||(Te=new hr),Ee(Er,Br,Se,oe,Te)}}return Nt?(Te||(Te=new hr),Tt(we,se,Se,oe,Ee,Te)):!1}function Ye(we){if(!xt(we)||$e(we))return!1;var se=St(we)?Ne:ye;return se.test(be(we))}function ze(we){return Ot(we)&&wt(we.length)&&!!ke[Re(we)]}function Ve(we){if(!je(we))return Wr(we);var se=[];for(var Se in Object(we))ce.call(we,Se)&&Se!="constructor"&&se.push(Se);return se}function ht(we,se,Se,oe,Ee,Te){var He=Se&o,et=we.length,Ze=se.length;if(et!=Ze&&!(He&&Ze>et))return!1;var nt=Te.get(we);if(nt&&Te.get(se))return nt==se;var pt=-1,bt=!0,Nt=Se&s?new Jt:void 0;for(Te.set(we,se),Te.set(se,we);++pt<et;){var Pt=we[pt],Xt=se[pt];if(oe)var Er=He?oe(Xt,Pt,pt,se,we,Te):oe(Pt,Xt,pt,we,se,Te);if(Er!==void 0){if(Er)continue;bt=!1;break}if(Nt){if(!Me(se,function(Br,yn){if(!st(Nt,yn)&&(Pt===Br||Ee(Pt,Br,Se,oe,Te)))return Nt.push(yn)})){bt=!1;break}}else if(!(Pt===Xt||Ee(Pt,Xt,Se,oe,Te))){bt=!1;break}}return Te.delete(we),Te.delete(se),bt}function _t(we,se,Se,oe,Ee,Te,He){switch(Se){case z:if(we.byteLength!=se.byteLength||we.byteOffset!=se.byteOffset)return!1;we=we.buffer,se=se.buffer;case le:return!(we.byteLength!=se.byteLength||!Te(new ot(we),new ot(se)));case u:case d:case w:return De(+we,+se);case f:return we.name==se.name&&we.message==se.message;case U:case G:return we==se+"";case y:var et=rt;case F:var Ze=oe&o;if(et||(et=At),we.size!=se.size&&!Ze)return!1;var nt=He.get(we);if(nt)return nt==se;oe|=s,He.set(we,se);var pt=ht(et(we),et(se),oe,Ee,Te,He);return He.delete(we),pt;case H:if(Yt)return Yt.call(we)==Yt.call(se)}return!1}function Tt(we,se,Se,oe,Ee,Te){var He=Se&o,et=Ct(we),Ze=et.length,nt=Ct(se),pt=nt.length;if(Ze!=pt&&!He)return!1;for(var bt=Ze;bt--;){var Nt=et[bt];if(!(He?Nt in se:ce.call(se,Nt)))return!1}var Pt=Te.get(we);if(Pt&&Te.get(se))return Pt==se;var Xt=!0;Te.set(we,se),Te.set(se,we);for(var Er=He;++bt<Ze;){Nt=et[bt];var Br=we[Nt],yn=se[Nt];if(oe)var Us=He?oe(yn,Br,Nt,se,we,Te):oe(Br,yn,Nt,we,se,Te);if(!(Us===void 0?Br===yn||Ee(Br,yn,Se,oe,Te):Us)){Xt=!1;break}Er||(Er=Nt=="constructor")}if(Xt&&!Er){var ui=we.constructor,di=se.constructor;ui!=di&&"constructor"in we&&"constructor"in se&&!(typeof ui=="function"&&ui instanceof ui&&typeof di=="function"&&di instanceof di)&&(Xt=!1)}return Te.delete(we),Te.delete(se),Xt}function Ct(we){return Pe(we,Dt,mr)}function Rt(we,se){var Se=we.__data__;return Tr(se)?Se[typeof se=="string"?"string":"hash"]:Se.map}function It(we,se){var Se=ft(we,se);return Ye(Se)?Se:void 0}function Vt(we){var se=ce.call(we,dr),Se=we[dr];try{we[dr]=void 0;var oe=!0}catch{}var Ee=ve.call(we);return oe&&(se?we[dr]=Se:delete we[dr]),Ee}var mr=tr?function(we){return we==null?[]:(we=Object(we),Oe(tr(we),function(se){return it.call(we,se)}))}:Ft,zt=Re;(qt&&zt(new qt(new ArrayBuffer(1)))!=z||fr&&zt(new fr)!=y||pr&&zt(pr.resolve())!=B||Qt&&zt(new Qt)!=F||Nr&&zt(new Nr)!=J)&&(zt=function(we){var se=Re(we),Se=se==x?we.constructor:void 0,oe=Se?be(Se):"";if(oe)switch(oe){case jt:return z;case Jr:return y;case Xr:return B;case Ut:return F;case Zr:return J}return se});function br(we,se){return se=se??a,!!se&&(typeof we=="number"||Ce.test(we))&&we>-1&&we%1==0&&we<se}function Tr(we){var se=typeof we;return se=="string"||se=="number"||se=="symbol"||se=="boolean"?we!=="__proto__":we===null}function $e(we){return!!fe&&fe in we}function je(we){var se=we&&we.constructor,Se=typeof se=="function"&&se.prototype||g;return we===Se}function Ge(we){return ve.call(we)}function be(we){if(we!=null){try{return T.call(we)}catch{}try{return we+""}catch{}}return""}function De(we,se){return we===se||we!==we&&se!==se}var Ue=Be(function(){return arguments}())?Be:function(we){return Ot(we)&&ce.call(we,"callee")&&!it.call(we,"callee")},Xe=Array.isArray;function gt(we){return we!=null&&wt(we.length)&&!St(we)}var at=ir||Kt;function mt(we,se){return Ke(we,se)}function St(we){if(!xt(we))return!1;var se=Re(we);return se==_||se==p||se==h||se==P}function wt(we){return typeof we=="number"&&we>-1&&we%1==0&&we<=a}function xt(we){var se=typeof we;return we!=null&&(se=="object"||se=="function")}function Ot(we){return we!=null&&typeof we=="object"}var Mt=pe?Fe(pe):ze;function Dt(we){return gt(we)?xe(we):Ve(we)}function Ft(){return[]}function Kt(){return!1}e.exports=mt}(lodash_isequal,lodash_isequal.exports);var lodash_isequalExports=lodash_isequal.exports;const isEqual2=getDefaultExportFromCjs(lodash_isequalExports);var IndexKind;(function(e){(function(t){t[t.SCHEMA_MATCH=0]="SCHEMA_MATCH",t[t.FIELD_MATCH=1]="FIELD_MATCH",t[t.FULL_TEXT=2]="FULL_TEXT"})(e.Kind||(e.Kind={}))})(IndexKind||(IndexKind={}));var staticImplements=()=>e=>e;function _ts_decorate$8(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var IndexSchema=class pa extends Resource{constructor(){super(...arguments),this._identifier=PublicKey.random().toString(),this.kind={kind:IndexKind.Kind.SCHEMA_MATCH},this.updated=new Event$1,this._index=new Map}get identifier(){return this._identifier}async update(t,r){var n;return(n=this._index.get(getTypeFromObject(r)))!=null&&n.has(t)?!1:(defaultMap(this._index,getTypeFromObject(r),new Set).add(t),!0)}async remove(t){for(const[r,n]of this._index.entries())if(n.has(t)){n.delete(t);return}}async find(t){if(t.inverted)return Array.from(this._index.entries()).filter(([n])=>!!t.typenames.includes(n??EXPANDO_TYPENAME)).flatMap(([,n])=>Array.from(n)).map(n=>({id:n,rank:0}));if(t.typenames.length===0)return Array.from(this._index.values()).flatMap(n=>Array.from(n)).map(n=>({id:n,rank:0}));const r=[];for(const n of t.typenames)n===EXPANDO_TYPENAME?r.push(...Array.from(this._index.get(null)??[]).map(o=>({id:o,rank:0}))):r.push(...Array.from(this._index.get(n)??[]).map(o=>({id:o,rank:0})));return r.flat()}async serialize(){return JSON.stringify({index:Array.from(this._index.entries()).map(([t,r])=>({type:t,ids:Array.from(r)}))})}static async load({serialized:t,identifier:r}){const n=new pa,o=JSON.parse(t).index;n._identifier=r;for(const{type:s,ids:a}of o)n._index.set(s,new Set(a));return n}};_ts_decorate$8([trace.span({showInBrowserTimeline:!0})],IndexSchema.prototype,"update",null),_ts_decorate$8([trace.span({showInBrowserTimeline:!0})],IndexSchema.prototype,"find",null),_ts_decorate$8([trace.span({showInBrowserTimeline:!0})],IndexSchema.prototype,"serialize",null),_ts_decorate$8([trace.span({showInBrowserTimeline:!0})],IndexSchema,"load",null),IndexSchema=_ts_decorate$8([trace.resource(),staticImplements()],IndexSchema);var getTypeFromObject=e=>{var t,r;return((r=(t=e.system)==null?void 0:t.type)==null?void 0:r.itemId)??null},IndexConstructors={[IndexKind.Kind.SCHEMA_MATCH]:IndexSchema};function _ts_decorate2$3(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$9="/home/runner/work/dxos/dxos/packages/core/echo/indexing/src/indexer.ts",INDEX_UPDATE_BATCH_SIZE=100,INDEX_COOLDOWN_TIME=100,INDEX_TIME_BUDGET=300,Indexer=class extends Resource{constructor({db:e,metadataStore:t,indexStore:r,loadDocuments:n}){super(),this._indexes=new ComplexMap(o=>o.kind===IndexKind.Kind.FIELD_MATCH?`${o.kind}:${o.field}`:o.kind),this._newIndexes=[],this.updated=new Event$1,this._lastRunFinishedAt=0,this._db=e,this._metadataStore=t,this._indexStore=r,this._loadDocuments=n}get initialized(){return this._lifecycleState===LifecycleState.OPEN}setConfig(e){var t;if(this._indexConfig){log.warn("Index config is already set",void 0,{F:__dxlog_file$9,L:84,S:this,C:(r,n)=>r(...n)});return}if(this._indexConfig=e,this._lifecycleState===LifecycleState.OPEN){for(const r of this._indexes.keys())(t=e.indexes)!=null&&t.some(n=>isEqual2(n,n))||this._indexes.delete(r);this._run.schedule()}}async _open(e){var t;this._indexConfig||log.warn("Index config is not set",void 0,{F:__dxlog_file$9,L:101,S:this,C:(r,n)=>r(...n)}),this._run=new DeferredTask(this._ctx,async()=>{var r;try{if(this._lifecycleState!==LifecycleState.OPEN||((r=this._indexConfig)==null?void 0:r.enabled)!==!0)return;const n=this._lastRunFinishedAt+INDEX_COOLDOWN_TIME-Date.now();n>0&&await sleepWithContext(this._ctx,n),this._newIndexes.length>0&&await this._promoteNewIndexes(),await this._indexUpdatedObjects()}finally{this._lastRunFinishedAt=Date.now()}}),await this._loadIndexes(),((t=this._indexConfig)==null?void 0:t.enabled)===!0&&(this._metadataStore.dirty.on(this._ctx,()=>this._run.schedule()),this._run.schedule())}async _close(e){await this._run.join();for(const t of this._indexes.values())await t.close();this._newIndexes.length=0,this._indexes.clear()}async _catch(e){log.catch(e,void 0,{F:__dxlog_file$9,L:146,S:this,C:(t,r)=>t(...r)})}async execQuery(e){var t;if(this._lifecycleState!==LifecycleState.OPEN||((t=this._indexConfig)==null?void 0:t.enabled)!==!0)throw new Error("Indexer is not initialized or not enabled");return(await Promise.all(Array.from(this._indexes.values()).map(r=>r.find(e)))).reduce((r,n)=>r.concat(n),[])}async reindex(e){const t=this._db.batch();this._metadataStore.markDirty(e,t),this._metadataStore.dropFromClean(Array.from(e.keys()),t),await t.write(),this._run.schedule()}async updateIndexes(){await this._run.runBlocking()}async _loadIndexes(){var t,r;const e=await this._indexStore.loadIndexKindsFromDisk();for(const[n,o]of e.entries())!this._indexConfig||(t=this._indexConfig.indexes)!=null&&t.some(s=>isEqual2(s,o))?await this._indexStore.load(n).then(s=>this._indexes.set(s.kind,s)).catch(s=>{log.warn("Failed to load index",{err:s,identifier:n},{F:__dxlog_file$9,L:182,S:this,C:(a,c)=>a(...c)})}):await this._indexStore.remove(n);for(const n of((r=this._indexConfig)==null?void 0:r.indexes)||[])if(!this._indexes.has(n)){const o=IndexConstructors[n.kind];invariant$1(o,`Index kind ${n.kind} is not supported`,{F:__dxlog_file$9,L:195,S:this,A:["IndexConstructor","`Index kind ${kind.kind} is not supported`"]}),this._newIndexes.push(new o(n))}await Promise.all(this._newIndexes.map(n=>n.open()))}async _promoteNewIndexes(){const e=await this._metadataStore.getAllIndexedDocuments();for await(const t of this._loadDocuments(e)){if(this._ctx.disposed)return;await this._updateIndexes(this._newIndexes,t)}this._newIndexes.forEach(t=>this._indexes.set(t.kind,t)),this._newIndexes.length=0,await this._saveIndexes(),this.updated.emit()}async _indexUpdatedObjects(){if(this._ctx.disposed)return;const e=await this._metadataStore.getDirtyDocuments();if(log("dirty objects to index",{count:e.size},{F:__dxlog_file$9,L:226,S:this,C:(s,a)=>s(...a)}),e.size===0||this._ctx.disposed)return;const t=Date.now(),r=[],n=async()=>{log("Saving index changes",{count:r.length,timeSinceStart:Date.now()-t},{F:__dxlog_file$9,L:234,S:this,C:(a,c)=>a(...c)}),await this._saveIndexes();const s=this._db.batch();this._metadataStore.markClean(new Map(r.map(a=>[a.id,a.heads])),s),await s.write()},o=[];for await(const s of this._loadDocuments(e)){if(this._ctx.disposed)return;if(o.push(...await this._updateIndexes(Array.from(this._indexes.values()),s)),r.push(...s),r.length>=INDEX_UPDATE_BATCH_SIZE&&(await n(),r.length=0),Date.now()-t>INDEX_TIME_BUDGET){r.length>0&&await n(),log("Indexing time budget exceeded",{time:Date.now()-t},{F:__dxlog_file$9,L:256,S:this,C:(a,c)=>a(...c)}),this._run.schedule();break}}await n(),o.some(Boolean)&&this.updated.emit(),log("Indexing finished",{time:Date.now()-t},{F:__dxlog_file$9,L:266,S:this,C:(s,a)=>s(...a)})}async _updateIndexes(e,t){const r=[];for(const n of e){if(this._ctx.disposed)return r;switch(n.kind.kind){case IndexKind.Kind.FIELD_MATCH:invariant$1(n.kind.field,"Field match index kind should have a field",{F:__dxlog_file$9,L:278,S:this,A:["index.kind.field","'Field match index kind should have a field'"]}),r.push(...await updateIndexWithObjects(n,t.filter(o=>n.kind.field in o.object)));break;case IndexKind.Kind.SCHEMA_MATCH:r.push(...await updateIndexWithObjects(n,t));break}}return r}async _saveIndexes(){for(const e of this._indexes.values()){if(this._ctx.disposed)return;await this._indexStore.save(e)}}};_ts_decorate2$3([synchronized],Indexer.prototype,"setConfig",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0})],Indexer.prototype,"_open",null),_ts_decorate2$3([synchronized],Indexer.prototype,"execQuery",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0})],Indexer.prototype,"reindex",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0})],Indexer.prototype,"_promoteNewIndexes",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0})],Indexer.prototype,"_indexUpdatedObjects",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0})],Indexer.prototype,"_updateIndexes",null),_ts_decorate2$3([trace.span({showInBrowserTimeline:!0}),synchronized],Indexer.prototype,"_saveIndexes",null),Indexer=_ts_decorate2$3([trace.resource()],Indexer);var updateIndexWithObjects=async(e,t)=>Promise.all(t.map(r=>e.update(r.id,r.object)));function _ts_decorate3$2(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file2$4="/home/runner/work/dxos/dxos/packages/core/echo/indexing/src/index-metadata-store.ts",IndexMetadataStore=class{constructor({db:e}){this.dirty=new Event$1,this.clean=new Event$1,this._lastSeen=e.sublevel("last-seen",{valueEncoding:headsEncoding,keyEncoding:"utf8"}),this._lastIndexed=e.sublevel("last-indexed",{valueEncoding:headsEncoding,keyEncoding:"utf8"}),trace.diagnostic({id:"indexed-documents",name:"Indexed Documents",fetch:async()=>{const[t,r]=await Promise.all([this.getDirtyDocuments(),this.getAllIndexedDocuments()]);return joinTables("id","id",Array.from(t.entries()).map(([n,o])=>({id:n,dirtyHeads:o.join(",")})),Array.from(r.entries()).map(([n,o])=>({id:n,indexedHeads:o.join(",")})))}})}async getDirtyDocuments(){return new Map(await this._lastSeen.iterator({}).all())}async getAllIndexedDocuments(){return new Map(await this._lastIndexed.iterator({}).all())}markDirty(e,t){log("mark dirty",{count:e.size},{F:__dxlog_file2$4,L:73,S:this,C:(r,n)=>r(...n)});for(const[r,n]of e.entries())t.put(r,n,{sublevel:this._lastSeen,valueEncoding:headsEncoding}),t.del(objectPointerCodec.convertV1ToV0(r),{sublevel:this._lastIndexed})}notifyMarkedDirty(){this.dirty.emit()}markClean(e,t){log("mark clean",{count:e.size},{F:__dxlog_file2$4,L:91,S:this,C:(r,n)=>r(...n)});for(const[r,n]of e.entries())t.put(r,n,{sublevel:this._lastIndexed,valueEncoding:headsEncoding}),t.del(r,{sublevel:this._lastSeen}),t.del(objectPointerCodec.convertV1ToV0(r),{sublevel:this._lastIndexed}),t.del(objectPointerCodec.convertV1ToV0(r),{sublevel:this._lastSeen})}dropFromClean(e,t){for(const r of e)t.del(r,{sublevel:this._lastIndexed})}};_ts_decorate3$2([trace.span({showInBrowserTimeline:!0})],IndexMetadataStore.prototype,"getDirtyDocuments",null),_ts_decorate3$2([trace.span({showInBrowserTimeline:!0})],IndexMetadataStore.prototype,"markDirty",null),_ts_decorate3$2([trace.span({showInBrowserTimeline:!0})],IndexMetadataStore.prototype,"markClean",null),IndexMetadataStore=_ts_decorate3$2([trace.resource()],IndexMetadataStore);var headsCodec=schema.getCodecForType("dxos.echo.query.Heads"),showedWarning=!1,headsEncoding={encode:e=>headsCodec.encode({hashes:e}),decode:e=>{try{return headsCodec.decode(e).hashes}catch{showedWarning||(showedWarning=!0,log.warn("Detected legacy encoding of heads in the indexer. \nRun `await dxos.client.repair()`",void 0,{F:__dxlog_file2$4,L:124,S:void 0,C:(n,o)=>n(...o)}));const t=Buffer.from(e).toString("utf8").replace(/"/g,"");invariant$1(t.length%64===0,"Invalid concatenated heads length",{F:__dxlog_file2$4,L:132,S:void 0,A:["concatenatedHeads.length % 64 === 0","'Invalid concatenated heads length'"]});const r=[];for(let n=0;n<t.length;n+=64)r.push(t.slice(n,n+64));return r}},format:"buffer"},__dxlog_file3$3="/home/runner/work/dxos/dxos/packages/core/echo/indexing/src/index-store.ts",CODEC_VERSION=2,IndexStore=class{constructor({db:e}){this._db=e,trace.diagnostic({id:"indexes",name:"Indexes",fetch:async()=>(await this._db.iterator(encodings$2).all()).map(([t,{index:r,...n}])=>({identifier:t,...n}))})}async save(e){await this._db.put(e.identifier,await indexCodec.encode(e),encodings$2)}async load(e){const t=await this._db.get(e,encodings$2);return indexCodec.decode(e,t)}async remove(e){await this._db.del(e,encodings$2)}async loadIndexKindsFromDisk(){const e=new Map;for await(const[t,r]of this._db.iterator(encodings$2))r.kind&&e.set(t,r.kind);{const t=[],r=Array.from(e.values());for(const n of r){if(!t.some(s=>isEqual2(s,n))){t.push(n);continue}const o=Array.from(e.entries());for(const[s,a]of o)isEqual2(a,n)&&(await this.remove(s),e.delete(s))}}return e}},encodings$2={keyEncoding:"utf8",valueEncoding:"json"},indexCodec={encode:async e=>({index:await e.serialize(),kind:e.kind,version:CODEC_VERSION}),decode:async(e,t)=>{invariant$1(t.version===CODEC_VERSION,`Index version ${t.version} is not supported`,{F:__dxlog_file3$3,L:105,S:void 0,A:["data.version === CODEC_VERSION","`Index version ${data.version} is not supported`"]});const r=IndexConstructors[t.kind.kind];return invariant$1(r,`Index kind ${t.kind.kind} is not supported`,{F:__dxlog_file3$3,L:107,S:void 0,A:["IndexConstructor","`Index kind ${data.kind.kind} is not supported`"]}),r.load({serialized:t.index,indexKind:t.kind,identifier:e})}};function _ts_decorate$7(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$8="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/automerge/automerge-context.ts";exposeModule("@automerge/automerge",next_exports);var RPC_TIMEOUT$1=2e4,AutomergeContext=class{constructor(e=void 0,t={}){this._dataService=e,this._adapter=void 0,this._peerId=`client-${PublicKey.random().toHex()}`,this.spaceFragmentationEnabled=t.spaceFragmentationEnabled??!1,this._dataService?(this._adapter=new LocalClientNetworkAdapter(this._dataService),this._repo=new Repo({peerId:this._peerId,network:[this._adapter],sharePolicy:async()=>!0}),this._adapter.ready()):this._repo=new Repo({network:[]}),trace.diagnostic({id:"working-set",name:"Objects in the working set",fetch:()=>Object.entries(this._repo.handles).flatMap(([r,n])=>{const o=n.docSync();if(!o)return[];const s=o.access.spaceKey;return Object.entries(o.objects).map(([a,c])=>{var l,h;return{objectId:a,docId:r,spaceKey:s,type:(h=(l=c.system)==null?void 0:l.type)==null?void 0:h.itemId}})})})}get repo(){return this._repo}async flush(e){var t;await((t=this._dataService)==null?void 0:t.flush(e,{timeout:RPC_TIMEOUT$1}))}_automergeDocs(){return mapValues$1(this._repo.handles,e=>{var t,r;return{state:e.state,hasDoc:!!e.docSync(),heads:e.docSync()?next_exports.getHeads(e.docSync()):null,data:((t=e.docSync())==null?void 0:t.doc)&&mapValues$1((r=e.docSync())==null?void 0:r.doc,(n,o)=>{try{switch(o){case"access":case"links":return n;case"objects":return Object.keys(n);default:return`${n}`}}catch(s){return`${s}`}})}})}_automergePeers(){return this._repo.peers}async close(){var e;await((e=this._adapter)==null?void 0:e.close())}};_ts_decorate$7([trace.info()],AutomergeContext.prototype,"_adapter",void 0),_ts_decorate$7([trace.info()],AutomergeContext.prototype,"_peerId",void 0),_ts_decorate$7([trace.info()],AutomergeContext.prototype,"spaceFragmentationEnabled",void 0),_ts_decorate$7([trace.info({depth:null})],AutomergeContext.prototype,"_automergeDocs",null),_ts_decorate$7([trace.info({depth:null})],AutomergeContext.prototype,"_automergePeers",null),AutomergeContext=_ts_decorate$7([trace.resource()],AutomergeContext);var LocalClientNetworkAdapter=class extends NetworkAdapter{constructor(e){super(),this._dataService=e,this._isClosed=!1,this._hostInfo=void 0,this._stream=void 0}ready(){invariant$1(!this._isClosed,void 0,{F:__dxlog_file$8,L:160,S:this,A:["!this._isClosed",""]}),this.emit("ready",{network:this})}connect(e){log("connecting...",void 0,{F:__dxlog_file$8,L:169,S:this,C:(t,r)=>t(...r)}),invariant$1(!this._isClosed,void 0,{F:__dxlog_file$8,L:172,S:this,A:["!this._isClosed",""]}),invariant$1(!this._stream,void 0,{F:__dxlog_file$8,L:173,S:this,A:["!this._stream",""]}),this.peerId=e,this._stream=this._dataService.syncRepo({id:e},{timeout:RPC_TIMEOUT$1}),this._stream.subscribe(t=>{this.emit("message",cbor_exports.decode(t.syncMessage))},t=>{t&&!this._isClosed&&log.catch(t,void 0,{F:__dxlog_file$8,L:189,S:this,C:(r,n)=>r(...n)}),this._hostInfo&&this.emit("peer-disconnected",{peerId:this._hostInfo.peerId}),this._isClosed||this.close().catch(r=>log.catch(r,void 0,{F:__dxlog_file$8,L:197,S:this,C:(n,o)=>n(...o)}))}),this._dataService.getHostInfo(void 0,{timeout:RPC_TIMEOUT$1}).then(t=>{this._hostInfo=t,this.emit("peer-candidate",{peerMetadata:{},peerId:this._hostInfo.peerId})}).catch(t=>{log.catch(t,void 0,{F:__dxlog_file$8,L:212,S:this,C:(r,n)=>r(...n)})})}disconnect(){}async close(){var e;log("closing...",void 0,{F:__dxlog_file$8,L:222,S:this,C:(t,r)=>t(...r)}),this._isClosed=!0,await((e=this._stream)==null?void 0:e.close()),this._stream=void 0,log("closed",void 0,{F:__dxlog_file$8,L:226,S:this,C:(t,r)=>t(...r)}),this.emit("close")}send(e){log("sending...",void 0,{F:__dxlog_file$8,L:231,S:this,C:(t,r)=>t(...r)}),invariant$1(this.peerId,void 0,{F:__dxlog_file$8,L:232,S:this,A:["this.peerId",""]}),invariant$1(!this._isClosed,void 0,{F:__dxlog_file$8,L:233,S:this,A:["!this._isClosed",""]}),this._dataService.sendSyncMessage({id:this.peerId,syncMessage:cbor_exports.encode(e)},{timeout:RPC_TIMEOUT$1}).then(()=>{log("sent",void 0,{F:__dxlog_file$8,L:243,S:this,C:(t,r)=>t(...r)})}).catch(t=>{this._isClosed||log.catch(t,void 0,{F:__dxlog_file$8,L:247,S:this,C:(r,n)=>r(...n)})})}};_ts_decorate$7([trace.info()],LocalClientNetworkAdapter.prototype,"_hostInfo",void 0),_ts_decorate$7([trace.info()],LocalClientNetworkAdapter.prototype,"_stream",void 0),LocalClientNetworkAdapter=_ts_decorate$7([trace.resource()],LocalClientNetworkAdapter);var isValidKeyPath=e=>Array.isArray(e)&&e.every(t=>typeof t=="string"||typeof t=="number"),idStyle={style:"color: #777"},listStyle={style:"list-style-type: none; padding: 0; margin: 0 0 0 12px; font-style: normal; position: relative"},liStyle={style:"min-height: 16px;"},nestedObjectContainerStyle={style:"margin: -2px 0 0; display: inline-flex"},keyStyle={style:"color: #881391"},defaultValueKeyStyle={style:"color: #777"},alteredValueKeyStyle={style:"color: #881391; font-weight: bolder"},nullStyle={style:"color: #777"},defaultKeys=["id","@type","@meta"],getHeader=(e,t,r)=>["span",{style:(r!=null&&r.nested?"padding: 2px 0 0;":"")+`
 height: 18px;`},`${e}`,["span",idStyle,`#${t}`]],formatValue=(e,t)=>typeof e>"u"?["span",nullStyle,"undefined"]:e==="null"?["span",nullStyle,"null"]:["span",nestedObjectContainerStyle,["object",{object:e,config:t}]],getBody=e=>["ol",listStyle,...Object.keys(e).map(t=>["li",liStyle,["span",defaultKeys.includes(t)?keyStyle:t.startsWith("[[")?defaultValueKeyStyle:alteredValueKeyStyle,t],["span",{},": "],formatValue(e[t],{nested:!0})])],symbolPath=Symbol("path"),symbolNamespace=Symbol("namespace"),symbolHandler=Symbol("handler"),symbolInternals=Symbol("internals"),TargetKey={new:(e,t,r)=>({path:e,namespace:t,type:r}),hash:e=>JSON.stringify(e)},_a,_b,_c,_d,EchoArray=(Wn=class extends Array{constructor(){super(...arguments),this[_a]=null,this[_b]=null,this[_c]=null,this[_d]=null}static get[Symbol.species](){return Array}},_a=symbolInternals,_b=symbolPath,_c=symbolNamespace,_d=symbolHandler,(()=>{const t=["push","pop","shift","unshift","splice","sort","reverse"];for(const r of t){const n=`array${r.slice(0,1).toUpperCase()}${r.slice(1)}`;Object.defineProperty(Wn.prototype,r,{enumerable:!1,value:function(...o){let s;return compositeRuntime.batch(()=>{const a=this[symbolHandler];s=a[n].apply(a,[this,this[symbolPath],...o])}),s}})}})(),Wn),getAutomergeObjectCore=e=>getObjectCoreFromEchoTarget(getProxyHandlerSlot(e).target),__dxlog_file3$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/automerge/doc-semaphore.ts",beingChanged=new WeakSet,docChangeSemaphore=e=>(log("begin change",{handled:getDebugName(e)},{F:__dxlog_file3$2,L:14,S:void 0,C:(t,r)=>t(...r)}),beingChanged.has(e)&&failedInvariant("Recursive call to doc.change"),beingChanged.add(e),()=>{log("end change",{handled:getDebugName(e)},{F:__dxlog_file3$2,L:22,S:void 0,C:(t,r)=>t(...r)}),beingChanged.delete(e)}),getDatabaseFromObject=e=>{var t,r;if(isEchoObject(e))return(r=(t=getObjectCoreFromEchoTarget(getProxyHandlerSlot(e).target))==null?void 0:t.database)==null?void 0:r._dbApi},getReferenceWithSpaceKey=e=>{const t=getDatabaseFromObject(e);return t&&new Reference(e.id,void 0,t.spaceKey.toHex())},getInlineAndLinkChanges=e=>{const t=new Set,r={};for(const{path:n,value:o}of e.patches)if(!(n.length<2))switch(n[0]){case"objects":n.length>=2&&t.add(n[1]);break;case"links":n.length>=2&&typeof o=="string"&&isValidAutomergeUrl(o)&&(r[n[1]]=o);break}return{inlineChangedObjects:[...t],linkedDocuments:r}};function _ts_decorate2$2(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file4$2="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/automerge/automerge-db.ts",THROTTLED_UPDATE_FREQUENCY=10,AutomergeDb=class{constructor(e,t,r,n,o){this.graph=e,this.automerge=t,this.spaceKey=r,this._initRootProxyFn=n,this._objects=new Map,this._updateEvent=new Event$1,this._isOpen=!1,this._ctx=new Context,this.opened=new Trigger,this.rootChanged=new Event$1,this._onDocumentUpdate=s=>{const a=this._processDocumentUpdate(s);this._rebindObjects(s.handle,a.objectsToRebind),this._automergeDocLoader.onObjectLinksUpdated(a.linkedDocuments),this._createInlineObjects(s.handle,a.createdObjectIds),this._emitUpdateEvent(a.updatedObjectIds)},this._objectsForNextUpdate=new Set,this._updateScheduler=new UpdateScheduler(this._ctx,async()=>{const s=[...this._objectsForNextUpdate];this._objectsForNextUpdate.clear(),this._emitUpdateEvent(s)},{maxFrequency:THROTTLED_UPDATE_FREQUENCY}),this._automergeDocLoader=new AutomergeDocumentLoaderImpl(this.spaceKey,t.repo),this._dbApi=o}async open(e){const t=performance.now();if(this._isOpen){log.info("Already open",void 0,{F:__dxlog_file4$2,L:86,S:this,C:(n,o)=>n(...o)});return}this._isOpen=!0,this._ctx.onDispose(this._unsubscribeFromHandles.bind(this)),this._automergeDocLoader.onObjectDocumentLoaded.on(this._ctx,this._onObjectDocumentLoaded.bind(this));try{await this._automergeDocLoader.loadSpaceRootDocHandle(this._ctx,e);const n=this._automergeDocLoader.getSpaceRootDocHandle(),o=n.docSync();invariant$1(o,void 0,{F:__dxlog_file4$2,L:97,S:this,A:["spaceRootDoc",""]});const s=Object.keys(o.objects??{});this._createInlineObjects(n,s),n.on("change",this._onDocumentUpdate)}catch(n){if(n instanceof ContextDisposedError)return;throw log.catch(n,void 0,{F:__dxlog_file4$2,L:105,S:this,C:(o,s)=>o(...s)}),n}const r=performance.now()-t;r>1e3&&log.warn("slow AM open",{docId:e.rootUrl,duration:r},{F:__dxlog_file4$2,L:111,S:this,C:(n,o)=>n(...o)}),this.opened.wake()}async close(){this._isOpen&&(this._isOpen=!1,this.opened.throw(new ContextDisposedError),this.opened.reset(),this._ctx.dispose(),this._ctx=new Context)}allObjectCores(){return Array.from(this._objects.values())}getAllObjectIds(){if(!(this._automergeDocLoader.getAllHandles().length>0))return[];const e=this._automergeDocLoader.getSpaceRootDocHandle().docSync();return e?[...new Set([...Object.keys(e.objects??{}),...Object.keys(e.links??{})])]:[]}async update(e){if(invariant$1(this._ctx,"Must be open",{F:__dxlog_file4$2,L:163,S:this,A:["this._ctx","'Must be open'"]}),e.rootUrl===this._automergeDocLoader.getSpaceRootDocHandle().url)return;this._unsubscribeFromHandles();const t=this._automergeDocLoader.clearHandleReferences();try{await this._automergeDocLoader.loadSpaceRootDocHandle(this._ctx,e);const r=this._automergeDocLoader.getSpaceRootDocHandle();await this._handleSpaceRootDocumentChange(r,t),r.on("change",this._onDocumentUpdate)}catch(r){if(r instanceof ContextDisposedError)return;throw log.catch(r,void 0,{F:__dxlog_file4$2,L:179,S:this,C:(n,o)=>n(...o)}),r}}getObjectCoreById(e){const t=this._objects.get(e);if(!t){this._automergeDocLoader.loadObjectDocument(e);return}if(!t.isDeleted())return invariant$1(t instanceof AutomergeObjectCore,void 0,{F:__dxlog_file4$2,L:195,S:this,A:["objCore instanceof AutomergeObjectCore",""]}),t}getObjectById(e){const t=this.getObjectCoreById(e);if(!t)return;const r=t.rootProxy;return invariant$1(isReactiveObject(r),void 0,{F:__dxlog_file4$2,L:206,S:this,A:["isReactiveObject(root)",""]}),r}async loadObjectById(e,{timeout:t}={}){var o;if((o=this._objects.get(e))!=null&&o.isDeleted())return Promise.resolve(void 0);const r=this.getObjectById(e);if(r)return Promise.resolve(r);this._automergeDocLoader.loadObjectDocument(e);const n=this._updateEvent.waitFor(s=>s.itemsUpdated.some(({id:a})=>a===e)).then(()=>this.getObjectById(e));return t?asyncTimeout(n,t):n}async batchLoadObjects(e,{inactivityTimeout:t=3e4}={}){var s;const r=new Array(e.length),n=[];for(let a=0;a<e.length;a++){const c=e[a],l=this.getObjectById(c);(s=this._objects.get(c))!=null&&s.isDeleted()?r[a]=void 0:l!=null?r[a]=l:n.push({id:c,resultIndex:a})}if(n.length===0)return r;const o=n.map(a=>a.id);return this._automergeDocLoader.loadObjectDocument(o),new Promise((a,c)=>{let l=null,h;const u=()=>{h=setTimeout(()=>{l==null||l(),c(new TimeoutError$2(t))},t)};l=this._updateEvent.on(({itemsUpdated:d})=>{var _;const f=d.map(p=>p.id);for(let p=n.length-1;p>=0;p--){const y=n[p];f.includes(y.id)&&(clearTimeout(h),r[y.resultIndex]=(_=this._objects.get(y.id))!=null&&_.isDeleted()?void 0:this.getObjectById(y.id),n.splice(p,1),u())}n.length===0&&(clearTimeout(h),l==null||l(),a(r))}),u()})}addCore(e){if(e.database){if(e.database!==this)throw new Error("Object already belongs to another database");e.isDeleted()&&e.setDeleted(!1);return}invariant$1(!this._objects.has(e.id),void 0,{F:__dxlog_file4$2,L:301,S:this,A:["!this._objects.has(core.id)",""]}),this._objects.set(e.id,e);let t;shouldObjectGoIntoFragmentedSpace(e)&&this.automerge.spaceFragmentationEnabled?(t=this._automergeDocLoader.createDocumentForObject(e.id),t.on("change",this._onDocumentUpdate)):(t=this._automergeDocLoader.getSpaceRootDocHandle(),this._automergeDocLoader.onObjectBoundToDocument(t,e.id)),e.bind({db:this,docHandle:t,path:["objects",e.id],assignFromLocalState:!0}),e.rootProxy||this._initRootProxyFn(e)}add(e){const t=getAutomergeObjectCore(e);return this.addCore(t),e}remove(e){const t=getAutomergeObjectCore(e);invariant$1(this._objects.has(t.id),void 0,{F:__dxlog_file4$2,L:338,S:this,A:["this._objects.has(core.id)",""]}),t.setDeleted(!0)}async flush(){await this.automerge.flush({states:this._automergeDocLoader.getAllHandles().filter(e=>!!e.docSync()).map(e=>({heads:getHeads(e.docSync()),documentId:e.documentId}))})}async _handleSpaceRootDocumentChange(e,t){var l,h;const r=e.docSync(),n=new Set(Object.keys(r.objects??{})),o=new Map(Object.entries(r.links??{})),s=new Map;s.set(e.url,{handle:e,objectIds:[]});const a=[],c=[...n.values()].filter(u=>!this._objects.has(u));for(const u of this._objects.values())if(n.has(u.id)){if(e.url===((l=u.docHandle)==null?void 0:l.url))continue;s.get(e.url).objectIds.push(u.id)}else if(o.has(u.id)){const d=o.get(u.id);if(d===((h=u.docHandle)==null?void 0:h.url))continue;const f=s.get(d);if(f!=null){f.objectIds.push(u.id);continue}const _=this.automerge.repo.find(d);await _.doc(["ready"]),s.set(d,{handle:_,objectIds:[u.id]})}else a.push(u.id);a.forEach(u=>this._objects.delete(u)),this._createInlineObjects(e,c);for(const{handle:u,objectIds:d}of s.values())this._rebindObjects(u,d);for(const u of t)this._objects.has(u)||this._automergeDocLoader.loadObjectDocument(u);this._automergeDocLoader.onObjectLinksUpdated(r.links),this.rootChanged.emit()}_emitUpdateEvent(e){e.length!==0&&compositeRuntime.batch(()=>{this._updateEvent.emit({spaceKey:this.spaceKey,itemsUpdated:e.map(t=>({id:t}))});for(const t of e){const r=this._objects.get(t);r&&r.notifyUpdate()}})}_processDocumentUpdate(e){const{inlineChangedObjects:t,linkedDocuments:r}=getInlineAndLinkChanges(e),n=[],o=[];for(const s of t){const a=this._objects.get(s);a?a!=null&&a.docHandle&&a.docHandle.url!==e.handle.url&&(log.warn("object bound to incorrect document, going to rebind",{updatedObject:s,documentUrl:a.docHandle.url,actualUrl:e.handle.url},{F:__dxlog_file4$2,L:443,S:this,C:(c,l)=>c(...l)}),o.push(s)):n.push(s)}return{updatedObjectIds:t,objectsToRebind:o,createdObjectIds:n,linkedDocuments:r}}_unsubscribeFromHandles(){for(const e of Object.values(this.automerge.repo.handles))e.off("change",this._onDocumentUpdate)}_onObjectDocumentLoaded({handle:e,objectId:t}){e.on("change",this._onDocumentUpdate),this._createObjectInDocument(e,t),this._scheduleThrottledUpdate([t])}_createInlineObjects(e,t){for(const r of t)invariant$1(!this._objects.has(r),void 0,{F:__dxlog_file4$2,L:477,S:this,A:["!this._objects.has(id)",""]}),this._createObjectInDocument(e,r)}_createObjectInDocument(e,t){invariant$1(!this._objects.get(t),void 0,{F:__dxlog_file4$2,L:483,S:this,A:["!this._objects.get(objectId)",""]});const r=new AutomergeObjectCore;r.id=t,this._objects.set(r.id,r),this._automergeDocLoader.onObjectBoundToDocument(e,t),r.bind({db:this,docHandle:e,path:["objects",r.id],assignFromLocalState:!1}),this._initRootProxyFn(r)}_rebindObjects(e,t){for(const r of t){const n=this._objects.get(r);invariant$1(n,void 0,{F:__dxlog_file4$2,L:500,S:this,A:["objectCore",""]}),n.bind({db:this,docHandle:e,path:n.mountPath,assignFromLocalState:!1}),this._automergeDocLoader.onObjectBoundToDocument(e,r)}}_scheduleThrottledUpdate(e){for(const t of e)this._objectsForNextUpdate.add(t);this._updateScheduler.trigger()}};_ts_decorate2$2([synchronized],AutomergeDb.prototype,"open",null),_ts_decorate2$2([synchronized],AutomergeDb.prototype,"close",null),_ts_decorate2$2([synchronized],AutomergeDb.prototype,"update",null);var shouldObjectGoIntoFragmentedSpace=e=>{var t;return((t=e.getType())==null?void 0:t.itemId)!==TYPE_PROPERTIES};function _using_ctx(){var e=typeof SuppressedError=="function"?SuppressedError:function(o,s){var a=new Error;return a.name="SuppressedError",a.suppressed=s,a.error=o,a},t={},r=[];function n(o,s){if(s!=null){if(Object(s)!==s)throw new TypeError("using declarations can only be used with objects, functions, null, or undefined.");if(o)var a=s[Symbol.asyncDispose||Symbol.for("Symbol.asyncDispose")];if(a==null&&(a=s[Symbol.dispose||Symbol.for("Symbol.dispose")]),typeof a!="function")throw new TypeError("Property [Symbol.dispose] is not a function.");r.push({v:s,d:a,a:o})}else o&&r.push({d:s,a:o});return s}return{e:t,u:n.bind(null,!1),a:n.bind(null,!0),d:function(){var o=this.e;function s(){for(;c=r.pop();)try{var c,l=c.d&&c.d.call(c.v);if(c.a)return Promise.resolve(l).then(s,a)}catch(h){return a(h)}if(o!==t)throw o}function a(c){return o=o!==t?new e(o,c):c,s()}return s()}}}var __dxlog_file6$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/automerge/automerge-object-core.ts",STRING_CRDT_LIMIT=3e5,META_NAMESPACE="meta",SYSTEM_NAMESPACE="system",AutomergeObjectCore=class{constructor(){this.id=PublicKey.random().toHex(),this.docHandle=void 0,this.linkCache=new Map,this.mountPath=[],this.updates=new Event$1,this.notifyUpdate=()=>{try{this.updates.emit()}catch(e){log.catch(e,void 0,{F:__dxlog_file6$1,L:242,S:this,C:(t,r)=>t(...r)}),throwUnhandledError(e)}}}initNewObject(e,t){invariant$1(!this.docHandle&&!this.doc,void 0,{F:__dxlog_file6$1,L:97,S:this,A:["!this.docHandle && !this.doc",""]}),e??(e={}),this.doc=next_exports.from({data:this.encode(e),meta:this.encode({keys:[],...t==null?void 0:t.meta}),system:{}})}bind(e){if(this.database=e.db,this.docHandle=e.docHandle,this.mountPath=e.path,this.linkCache){for(const n of this.linkCache.values())this.linkObject(n);this.linkCache=void 0}const t=this.doc;if(this.doc=void 0,e.assignFromLocalState)try{var r=_using_ctx();invariant$1(t,"assignFromLocalState",{F:__dxlog_file6$1,L:128,S:this,A:["doc","'assignFromLocalState'"]});const n=r.u(defer(docChangeSemaphore(this.docHandle??this)));this.docHandle.change(o=>{assignDeep(o,this.mountPath,t)})}catch(n){r.e=n}finally{r.d()}this.notifyUpdate()}getDoc(){var e;return this.doc??((e=this.docHandle)==null?void 0:e.docSync())??failedInvariant("Invalid state")}change(e,t){try{var r=_using_ctx();const n=r.u(defer(docChangeSemaphore(this.docHandle??this)));this.doc?(t?this.doc=next_exports.change(this.doc,t,e):this.doc=next_exports.change(this.doc,e),this.notifyUpdate()):(invariant$1(this.docHandle,void 0,{F:__dxlog_file6$1,L:162,S:this,A:["this.docHandle",""]}),this.docHandle.change(e,t))}catch(n){r.e=n}finally{r.d()}}changeAt(e,t,r){try{var n=_using_ctx();const o=n.u(defer(docChangeSemaphore(this.docHandle??this)));let s;if(this.doc){if(r){const{newDoc:a,newHeads:c}=next_exports.changeAt(this.doc,e,r,t);this.doc=a,s=c??void 0}else{const{newDoc:a,newHeads:c}=next_exports.changeAt(this.doc,e,t);this.doc=a,s=c??void 0}this.notifyUpdate()}else invariant$1(this.docHandle,void 0,{F:__dxlog_file6$1,L:190,S:this,A:["this.docHandle",""]}),s=this.docHandle.changeAt(e,t,r);return s}catch(o){n.e=o}finally{n.d()}}getDocAccessor(e=[]){invariant$1(isValidKeyPath(e),void 0,{F:__dxlog_file6$1,L:199,S:this,A:["isValidKeyPath(path)",""]});const t=this;return{handle:{docSync:()=>this.getDoc(),change:(r,n)=>{this.change(r,n)},changeAt:(r,n,o)=>this.changeAt(r,n,o),addListener:(r,n)=>{var o;r==="change"&&((o=this.docHandle)==null||o.on("change",n),this.updates.on(n))},removeListener:(r,n)=>{var o;r==="change"&&((o=this.docHandle)==null||o.off("change",n),this.updates.off(n))}},get path(){return[...t.mountPath,"data",...e]}}}linkObject(e){if(this.database){isReactiveObject(e)&&!isEchoObject(e)&&(invariant$1(this.database,"BUG",{F:__dxlog_file6$1,L:259,S:this,A:["this.database","'BUG'"]}),this.database._dbApi.add(e));const t=getAutomergeObjectCore(e);return t.database?t.database!==this.database?new Reference(t.id,void 0,t.database.spaceKey.toHex()):new Reference(t.id):(this.database.add(e),new Reference(t.id))}else return invariant$1(this.linkCache,void 0,{F:__dxlog_file6$1,L:275,S:this,A:["this.linkCache",""]}),invariant$1(e.id!=null,void 0,{F:__dxlog_file6$1,L:279,S:this,A:["obj.id != null",""]}),this.linkCache.set(e.id,e),new Reference(e.id)}lookupLink(e){return this.database?this.database.graph._lookupLink(e,this.database,this.notifyUpdate):(invariant$1(this.linkCache,void 0,{F:__dxlog_file6$1,L:294,S:this,A:["this.linkCache",""]}),this.linkCache.get(e.itemId))}encode(e){if(isReactiveObject(e))throw new TypeError("Linking is not allowed");if(e instanceof next_exports.RawString)return e;if(e===void 0)return null;if(e instanceof Reference)return encodeReference(e);if(Array.isArray(e))return e.map(t=>this.encode(t));if(typeof e=="object"&&e!==null){const t=Object.entries(e).filter(([r,n])=>n!==void 0);return Object.fromEntries(t.map(([r,n])=>[r,this.encode(n)]))}return typeof e=="string"&&e.length>STRING_CRDT_LIMIT?new next_exports.RawString(e):e}decode(e){return e===null?e:Array.isArray(e)?e.map(t=>this.decode(t)):e instanceof next_exports.RawString?e.toString():isEncodedReferenceObject(e)||looksLikeReferenceObject(e)?decodeReference(e):typeof e=="object"?Object.fromEntries(Object.entries(e).map(([t,r])=>[t,this.decode(r)])):e}arrayPush(e,t){const r=t.map(o=>this.encode(o));let n=-1;return this.change(o=>{const s=[...this.mountPath,...e],a=getDeep(o,s);invariant$1(Array.isArray(a),void 0,{F:__dxlog_file6$1,L:365,S:this,A:["Array.isArray(array)",""]}),n=a.push(...r)}),invariant$1(n!==-1,void 0,{F:__dxlog_file6$1,L:368,S:this,A:["newLength !== -1",""]}),n}_getRaw(e){const t=[...this.mountPath,...e];let r=this.getDoc();for(const n of t)r=r==null?void 0:r[n];return r}_setRaw(e,t){const r=[...this.mountPath,...e];this.change(n=>{assignDeep(n,r,t)})}getDecoded(e){return this.decode(this._getRaw(e))}setDecoded(e,t){this._setRaw(e,this.encode(t))}setType(e){this._setRaw([SYSTEM_NAMESPACE,"type"],this.encode(e))}setMeta(e){this._setRaw([META_NAMESPACE],this.encode(e))}delete(e){const t=[...this.mountPath,...e];this.change(r=>{const n=getDeep(r,t.slice(0,t.length-1));delete n[t[t.length-1]]})}getType(){const e=this.decode(this._getRaw([SYSTEM_NAMESPACE,"type"]));if(e)return invariant$1(e instanceof Reference,void 0,{F:__dxlog_file6$1,L:424,S:this,A:["value instanceof Reference",""]}),e}isDeleted(){const e=this._getRaw([SYSTEM_NAMESPACE,"deleted"]);return typeof e=="boolean"?e:!1}setDeleted(e){this._setRaw([SYSTEM_NAMESPACE,"deleted"],e)}},looksLikeReferenceObject=e=>typeof e=="object"&&e!==null&&Object.keys(e).length===3&&"itemId"in e&&"protocol"in e&&"host"in e,__dxlog_file7$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/echo-handler/echo-handler.ts",PROPERTY_ID="id",DATA_NAMESPACE="data",EchoReactiveHandler=(Bn=class{constructor(){this._proxyMap=new WeakMap,this._inspect=function(t,r,n){const o=this[symbolHandler],s=!!this[symbolInternals].core.getType(),a=o._getReified(this);return a.id=this[symbolInternals].core.id,`${s?"Typed":""}EchoObject ${n(a,{...r,compact:!0,showHidden:!1,customInspect:!1})}`}}init(t){if(invariant$1(t[symbolInternals],void 0,{F:__dxlog_file7$1,L:53,S:this,A:["target[symbolInternals]",""]}),invariant$1(!t[symbolIsProxy],void 0,{F:__dxlog_file7$1,L:54,S:this,A:["!(target as any)[symbolIsProxy]",""]}),invariant$1(Array.isArray(t[symbolPath]),void 0,{F:__dxlog_file7$1,L:55,S:this,A:["Array.isArray(target[symbolPath])",""]}),!Array.isArray(t))for(const r in t)typeof r!="symbol"&&delete t[r];defineHiddenProperty(t,symbolHandler,this),export_inspect.custom&&defineHiddenProperty(t,export_inspect.custom,this._inspect.bind(t))}ownKeys(t){const{value:r}=this.getDecodedValueAtPath(t),n=typeof r=="object"?Reflect.ownKeys(r):[];return isRootDataObject(t)&&n.push(PROPERTY_ID),n}getOwnPropertyDescriptor(t,r){const{value:n}=this.getDecodedValueAtPath(t);return isRootDataObject(t)&&r===PROPERTY_ID?{enumerable:!0,configurable:!0,writable:!1}:typeof n=="object"?Reflect.getOwnPropertyDescriptor(n,r):void 0}get(t,r,n){if(invariant$1(Array.isArray(t[symbolPath]),void 0,{F:__dxlog_file7$1,L:90,S:this,A:["Array.isArray(target[symbolPath])",""]}),t[symbolInternals].signal.notifyRead(),r===devtoolsFormatter)return this._getDevtoolsFormatter(t);if(isRootDataObject(t)){const s=this._handleRootObjectProperty(t,r);if(s!=null)return s}if(typeof r=="symbol")return Reflect.get(t,r);if(t instanceof EchoArray)return this._arrayGet(t,r);const o=this.getDecodedValueAtPath(t,r);return this._wrapInProxyIfRequired(t,o)}_handleRootObjectProperty(t,r){return r==="toJSON"?()=>this._toJSON(t):r===PROPERTY_ID?t[symbolInternals].core.id:null}_wrapInProxyIfRequired(t,r){const{value:n,dataPath:o,namespace:s}=r;if(n==null)return n;if(n[symbolIsProxy])return this._handleStoredSchema(t,n);if(n instanceof Reference)return this._handleStoredSchema(t,t[symbolInternals].core.lookupLink(n));if(Array.isArray(n)){const a=TargetKey.new(o,s,"array"),c=defaultMap(t[symbolInternals].targetsMap,a,()=>{const l=new EchoArray;return l[symbolInternals]=t[symbolInternals],l[symbolPath]=o,l[symbolNamespace]=s,l[symbolHandler]=this,l});return createReactiveProxy(c,this)}if(typeof n=="object"){const a=TargetKey.new(o,s,"record"),c=defaultMap(t[symbolInternals].targetsMap,a,()=>({[symbolInternals]:t[symbolInternals],[symbolPath]:o,[symbolNamespace]:s}));return createReactiveProxy(c,this)}return n}_handleStoredSchema(t,r){const n=t[symbolInternals].core.database;return r!=null&&n&&r instanceof StoredEchoSchema?n._dbApi.schemaRegistry.register(r):r}has(t,r){if(t instanceof EchoArray)return this._arrayHas(t,r);const{value:n}=this.getDecodedValueAtPath(t);return typeof n=="object"?Reflect.has(n,r):!1}defineProperty(t,r,n){return this.set(t,r,n.value,t)}getDecodedValueAtPath(t,r){const n=[...t[symbolPath]];r!=null&&n.push(r);const o=[getNamespace(t),...n];let s=t[symbolInternals].core.getDecoded(o);return s instanceof Reference&&(s=t[symbolInternals].core.lookupLink(s)),{namespace:getNamespace(t),value:s,dataPath:n}}_arrayGet(t,r){if(invariant$1(t instanceof EchoArray,void 0,{F:__dxlog_file7$1,L:210,S:this,A:["target instanceof EchoArray",""]}),r==="constructor")return Array.prototype.constructor;if(r!=="length"&&isNaN(parseInt(r)))return Reflect.get(t,r);const n=this.getDecodedValueAtPath(t,r);return this._wrapInProxyIfRequired(t,n)}_arrayHas(t,r){if(invariant$1(t instanceof EchoArray,void 0,{F:__dxlog_file7$1,L:222,S:this,A:["target instanceof EchoArray",""]}),typeof r=="string"){const n=parseInt(r),{value:o}=this.getDecodedValueAtPath(t,"length");if(invariant$1(typeof o=="number",void 0,{F:__dxlog_file7$1,L:226,S:this,A:["typeof length === 'number'",""]}),!isNaN(n))return n<o}return Reflect.has(t,r)}set(t,r,n,o){if(invariant$1(Array.isArray(t[symbolPath]),void 0,{F:__dxlog_file7$1,L:235,S:this,A:["Array.isArray(target[symbolPath])",""]}),invariant$1(typeof r=="string",void 0,{F:__dxlog_file7$1,L:236,S:this,A:["typeof prop === 'string'",""]}),t instanceof EchoArray&&r==="length")return this._arraySetLength(t,t[symbolPath],n),!0;const s=this.validateValue(t,[...t[symbolPath],r],n),a=[getNamespace(t),...t[symbolPath],r];if(s===void 0)t[symbolInternals].core.delete(a);else{const c=deepMapValues(s,(l,h)=>isReactiveObject(l)?this._linkReactiveHandler(t,l):h(l));t[symbolInternals].core.setDecoded(a,c)}return!0}_linkReactiveHandler(t,r){const n=isEchoObject(r)?r:createEchoObject(r),o=n[symbolInternals],s=n.id;if(invariant$1(typeof s=="string"&&s.length>0,void 0,{F:__dxlog_file7$1,L:274,S:this,A:["typeof objectId === 'string' && objectId.length > 0",""]}),t[symbolInternals].core.database){const a=o==null?void 0:o.core.database;return a?a!==t[symbolInternals].core.database?new Reference(s,void 0,a.spaceKey.toHex()):new Reference(s):(t[symbolInternals].core.database.add(n),new Reference(s))}else return invariant$1(t[symbolInternals].core.linkCache,void 0,{F:__dxlog_file7$1,L:289,S:this,A:["target[symbolInternals].core.linkCache",""]}),t[symbolInternals].core.linkCache.set(s,n),new Reference(s)}validateValue(t,r,n){invariant$1(r.length>0,void 0,{F:__dxlog_file7$1,L:296,S:this,A:["path.length > 0",""]}),throwIfCustomClass(r[r.length-1],n);const o=this.getSchema(t);if(o==null){const c=t[symbolInternals].core.getType();if(c)throw new Error(`Schema not found in schema registry: ${c.itemId}`);return n}const s=n instanceof DynamicEchoSchema?n.serializedSchema:n,a=SchemaValidator.getPropertySchema(o,r,c=>t[symbolInternals].core.getDecoded([getNamespace(t),...c]));return a==null||asserts(a)(s),s}getSchema(t){if(t[symbolNamespace]===META_NAMESPACE)return ObjectMetaSchema;if(!t[symbolInternals].core.database)return;const r=t[symbolInternals].core.getType();if(r==null)return;const n=t[symbolInternals].core.database.graph.runtimeSchemaRegistry.getSchema(r.itemId);if(n!=null)return n;if(r.protocol!=="protobuf")return t[symbolInternals].core.database._dbApi.schemaRegistry.getById(r.itemId)}getTypeReference(t){return t[symbolNamespace]===DATA_NAMESPACE?t[symbolInternals].core.getType():void 0}isDeleted(t){return t[symbolInternals].core.isDeleted()}arrayPush(t,r,...n){this._validateForArray(t,r,n,t.length);const o=this._encodeForArray(t,n);return t[symbolInternals].core.arrayPush([getNamespace(t),...r],o)}arrayPop(t,r){const n=this._getPropertyMountPath(t,r);let o;return t[symbolInternals].core.change(s=>{const a=getDeep(s,n);invariant$1(Array.isArray(a),void 0,{F:__dxlog_file7$1,L:364,S:this,A:["Array.isArray(array)",""]}),o=a.pop()}),o}arrayShift(t,r){const n=this._getPropertyMountPath(t,r);let o;return t[symbolInternals].core.change(s=>{const a=getDeep(s,n);invariant$1(Array.isArray(a),void 0,{F:__dxlog_file7$1,L:377,S:this,A:["Array.isArray(array)",""]}),o=a.shift()}),o}arrayUnshift(t,r,...n){this._validateForArray(t,r,n,0);const o=this._getPropertyMountPath(t,r),s=this._encodeForArray(t,n);let a=-1;return t[symbolInternals].core.change(c=>{const l=getDeep(c,o);invariant$1(Array.isArray(l),void 0,{F:__dxlog_file7$1,L:394,S:this,A:["Array.isArray(array)",""]}),a=l.unshift(...s)}),invariant$1(a!==-1,void 0,{F:__dxlog_file7$1,L:397,S:this,A:["newLength !== -1",""]}),a}arraySplice(t,r,n,o,...s){this._validateForArray(t,r,s,n);const a=this._getPropertyMountPath(t,r),c=this._encodeForArray(t,s);let l;return t[symbolInternals].core.change(h=>{const u=getDeep(h,a);invariant$1(Array.isArray(u),void 0,{F:__dxlog_file7$1,L:412,S:this,A:["Array.isArray(array)",""]}),o!=null?l=u.splice(n,o,...c):l=u.splice(n)}),invariant$1(l,void 0,{F:__dxlog_file7$1,L:419,S:this,A:["deletedElements",""]}),l}arraySort(t,r,n){const o=this._getPropertyMountPath(t,r);return t[symbolInternals].core.change(s=>{const a=getDeep(s,o);invariant$1(Array.isArray(a),void 0,{F:__dxlog_file7$1,L:429,S:this,A:["Array.isArray(array)",""]});const c=[...a].sort(n);assignDeep(s,o,c)}),t}arrayReverse(t,r){const n=this._getPropertyMountPath(t,r);return t[symbolInternals].core.change(o=>{const s=getDeep(o,n);invariant$1(Array.isArray(s),void 0,{F:__dxlog_file7$1,L:442,S:this,A:["Array.isArray(array)",""]});const a=[...s].reverse();assignDeep(o,n,a)}),t}getMeta(t){const r={[symbolInternals]:t[symbolInternals],[symbolPath]:[],[symbolNamespace]:META_NAMESPACE};return createReactiveProxy(r,this)}_arraySetLength(t,r,n){if(n<0)throw new RangeError("Invalid array length");const o=this._getPropertyMountPath(t,r);t[symbolInternals].core.change(s=>{const a=getDeep(s,o);invariant$1(Array.isArray(a),void 0,{F:__dxlog_file7$1,L:468,S:this,A:["Array.isArray(array)",""]});const c=[...a];c.length=n,assignDeep(s,o,c)})}_validateForArray(t,r,n,o){let s=o;for(const a of n)this.validateValue(t,[...r,String(s++)],a)}_encodeForArray(t,r){const n=deepMapValues(r,(o,s)=>isReactiveObject(o)?t[symbolInternals].core.linkObject(o):s(o));return t[symbolInternals].core.encode(n)}_getPropertyMountPath(t,r){return[...t[symbolInternals].core.mountPath,getNamespace(t),...r]}_toJSON(t){const r=t[symbolInternals].core.getType(),n=this._getReified(t);return{"@type":r?encodeReference(r):void 0,...t[symbolInternals].core.isDeleted()?{"@deleted":!0}:{},"@meta":{...this.getMeta(t)},"@id":t[symbolInternals].core.id,...deepMapValues(n,(o,s)=>o instanceof Reference?encodeReference(o):s(o))}}_getReified(t){const r=[...t[symbolPath]],n=[getNamespace(t),...r];return t[symbolInternals].core.getDecoded(n)}_getDevtoolsFormatter(t){return{header:r=>{var n;return getHeader(((n=this.getTypeReference(t))==null?void 0:n.itemId)??"EchoObject",t[symbolInternals].core.id,r)},hasBody:()=>!0,body:()=>{var n;let r=deepMapValues(this._getReified(t),(o,s)=>o instanceof Reference?t[symbolInternals].core.lookupLink(o):s(o));if(isRootDataObject(t)){const o={[symbolInternals]:t[symbolInternals],[symbolPath]:[],[symbolNamespace]:META_NAMESPACE},s=this._getReified(o);r={id:t[symbolInternals].core.id,"@type":(n=this.getTypeReference(t))==null?void 0:n.itemId,"@meta":s,...r,"[[Schema]]":this.getSchema(t),"[[Core]]":t[symbolInternals].core}}return getBody(r)}}}},Bn.instance=new Bn,Bn),throwIfCustomClass=(e,t)=>{if(t==null||Array.isArray(t)||t instanceof DynamicEchoSchema)return;const r=Object.getPrototypeOf(t);if(typeof t=="object"&&r!==Object.prototype)throw new Error(`class instances are not supported: setting ${r} on ${String(e)}`)},getObjectCoreFromEchoTarget=e=>e[symbolInternals].core,getNamespace=e=>e[symbolNamespace],isRootDataObject=e=>{const t=e[symbolPath];return!Array.isArray(t)||t.length>0?!1:getNamespace(e)===DATA_NAMESPACE},__dxlog_file8$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/echo-handler/create.ts",isEchoObject=e=>isReactiveObject(e)&&getProxyHandlerSlot(e).handler instanceof EchoReactiveHandler,createEchoObject=e=>{invariant$1(!isEchoObject(e),void 0,{F:__dxlog_file8$1,L:36,S:void 0,A:["!isEchoObject(init)",""]});const t=getSchema(e);if(t!=null&&validateSchema(t),validateInitialProps(e),isReactiveObject(e)){const r=e,n=getProxyHandlerSlot(r),o=getProxyHandlerSlot(getMeta(r)).target,s=new AutomergeObjectCore;s.rootProxy=r,n.handler=EchoReactiveHandler.instance;const a=n.target;return a[symbolInternals]={core:s,targetsMap:new ComplexMap(c=>JSON.stringify(c)),signal:compositeRuntime.createSignal()},s.updates.on(()=>a[symbolInternals].signal.notifyWrite()),a[symbolPath]=[],a[symbolNamespace]=DATA_NAMESPACE,n.handler._proxyMap.set(a,r),initCore(s,a),n.handler.init(a),saveTypeInAutomerge(a[symbolInternals],t),o&&o.keys.length>0&&a[symbolInternals].core.setMeta(o),r}else{const r=new AutomergeObjectCore,n={[symbolInternals]:{core:r,targetsMap:new ComplexMap(s=>JSON.stringify(s)),signal:compositeRuntime.createSignal()},[symbolPath]:[],[symbolNamespace]:DATA_NAMESPACE,...e};r.updates.on(()=>n[symbolInternals].signal.notifyWrite()),initCore(r,n);const o=createReactiveProxy(n,EchoReactiveHandler.instance);return r.rootProxy=o,saveTypeInAutomerge(n[symbolInternals],t),o}},initCore=(e,t)=>{PROPERTY_ID in t&&(t[symbolInternals].core.id=t[PROPERTY_ID],delete t[PROPERTY_ID]),e.initNewObject(linkAllNestedProperties(e,t))},initEchoReactiveObjectRootProxy=e=>{const t={[symbolInternals]:{core:e,targetsMap:new ComplexMap(r=>JSON.stringify(r)),signal:compositeRuntime.createSignal()},[symbolPath]:[],[symbolNamespace]:DATA_NAMESPACE};e.updates.on(()=>t[symbolInternals].signal.notifyWrite()),e.rootProxy=createReactiveProxy(t,EchoReactiveHandler.instance)},validateSchema=e=>{requireTypeReference(e),SchemaValidator.validateSchema(e)},saveTypeInAutomerge=(e,t)=>{t!=null&&e.core.setType(requireTypeReference(t))},validateInitialProps=(e,t=new Set)=>{if(!t.has(e)){t.add(e);for(const r in e){const n=e[r];n===void 0?delete e[r]:typeof n=="object"&&(n instanceof DynamicEchoSchema?(e[r]=n.serializedSchema,validateInitialProps(n.serializedSchema,t)):(throwIfCustomClass(r,n),validateInitialProps(e[r],t)))}}},linkAllNestedProperties=(e,t)=>deepMapValues(t,(r,n)=>isReactiveObject(r)?e.linkObject(r):n(r)),__dxlog_file9$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/query/filter.ts",Filter=class or{constructor(t,r={}){this.options={},this.type=t.type,this.properties=t.properties,this.text=t.text,this.predicate=t.predicate,this.not=t.not??!1,this.and=t.and??[],this.or=t.or??[],this.options=r}static from(t,r){if(t==null)return new or({},r);if(t instanceof or)return new or(t,r);if(typeof t=="function")return new or({predicate:t},r);if(typeof t=="string")return new or({text:t},r);if(Array.isArray(t))return new or({and:t.map(n=>or.from(n))},r);if(typeof t=="object")return new or({properties:t},r);throw new Error(`Invalid filter source: ${t}`)}static schema(t,r){const n=isSchema(t)?requireTypeReference(t):getReferenceWithSpaceKey(t);return invariant$1(n,"Invalid schema; check persisted in the database.",{F:__dxlog_file9$1,L:89,S:this,A:["typeReference","'Invalid schema; check persisted in the database.'"]}),this._fromTypeWithPredicate(n,r)}static typename(t,r){const n=Reference.fromLegacyTypename(t);return this._fromTypeWithPredicate(n,r)}static _fromTypeWithPredicate(t,r){switch(typeof r){case"function":return new or({type:t,predicate:r});case"object":return new or({type:t,properties:r});case"undefined":return new or({type:t});default:throw new TypeError("Invalid filter.")}}static not(t){return new or({...t,not:!t.not},t.options)}static and(...t){return new or({and:t.map(r=>or.from(r))})}static or(...t){return new or({or:t.map(r=>or.from(r))})}static fromProto(t){var n,o,s,a,c,l,h,u;const r={...t.options,spaces:((o=(n=t.options)==null?void 0:n.spaces)==null?void 0:o.length)===0||(s=t.options)==null?void 0:s.spaces,models:((c=(a=t.options)==null?void 0:a.models)==null?void 0:c.length)===0||(l=t.options)==null?void 0:l.models};return new or({type:t.type?Reference.fromValue(t.type):void 0,properties:t.properties,text:t.text,not:t.not,and:(h=t.and)==null?void 0:h.map(d=>or.fromProto(d)),or:(u=t.or)==null?void 0:u.map(d=>or.fromProto(d))},r)}get spaceKeys(){return this.options.spaces}toProto(){var t;return{properties:this.properties,type:(t=this.type)==null?void 0:t.encode(),text:this.text,not:this.not,and:this.and.map(r=>r.toProto()),or:this.or.map(r=>r.toProto()),options:this.options}}},filterMatch=(e,t)=>{if(!t)return!1;const r=filterMatchInner(e,t);return e.not&&!t.isDeleted()?!r:r},filterMatchInner=(e,t)=>{var n;const r=e.options.deleted??QueryOptions.ShowDeletedOption.HIDE_DELETED;if(t.isDeleted()){if(r===QueryOptions.ShowDeletedOption.HIDE_DELETED)return!1}else if(r===QueryOptions.ShowDeletedOption.SHOW_DELETED_ONLY)return!1;if(e.or.length){for(const o of e.or)if(filterMatch(o,t))return!0;return!1}if(e.type){const o=t.getType(),s=legacyGetDynamicSchemaTypename(t);if(e.type.protocol==="protobuf"&&s){if(s!==e.type.itemId)return!1}else if(!o&&e.type.itemId!==EXPANDO_TYPENAME||o&&!compareType(e.type,o,(n=t.database)==null?void 0:n.spaceKey))return!1}if(e.properties)for(const o in e.properties){invariant$1(o!=="@type",void 0,{F:__dxlog_file9$1,L:244,S:void 0,A:["key !== '@type'",""]});const s=e.properties[o];if((o==="id"?t.id:t.getDecoded(["data",o]))!==s)return!1}if(e.text!==void 0){const o=legacyGetTextForMatch(),s=e.text.toLowerCase();if(!o.toLowerCase().includes(s))return!1}if(e.predicate&&!compositeRuntime.untracked(()=>e.predicate(t.rootProxy)))return!1;for(const o of e.and)if(!filterMatch(o,t))return!1;return!0},compareType=(e,t,r)=>{const n=t.protocol!=="protobuf"?(t==null?void 0:t.host)??(r==null?void 0:r.toHex()):t.host??"dxos.org";return!(t.itemId!==e.itemId||t.protocol!==e.protocol||n!==e.host&&t.host!==e.host)},legacyGetDynamicSchemaTypename=e=>compositeRuntime.untracked(()=>{const t=e.rootProxy,r=getSchema(t);if(r instanceof DynamicEchoSchema)return r.id}),legacyGetTextForMatch=e=>"",areSignalsProhibited=!1,inUntrackedScope=!1,GuardSignal=class{constructor(e){this.debugInfo=e}notifyRead(){if(!inUntrackedScope&&areSignalsProhibited)throw new Error("Signal read is prohibited in this scope")}notifyWrite(){if(!inUntrackedScope&&areSignalsProhibited)throw new Error("Signal write is prohibited in this scope")}};registerSignalRuntime({createSignal:e=>new GuardSignal(e),batch:e=>{e()},untracked:e=>{const t=inUntrackedScope;try{return inUntrackedScope=!0,e()}finally{inUntrackedScope=t}}});var prohibitSignalActions=e=>{try{return areSignalsProhibited=!0,e()}finally{areSignalsProhibited=!1}},__dxlog_file10$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/query/query.ts",Query=class{constructor(e,t){this._queryContext=e,this._sources=new Set,this._signal=compositeRuntime.createSignal(),this._event=new Event$1,this._runningCtx=null,this._resultCache=void 0,this._objectCache=void 0,this._subscribers=0,this._filter=t,this._queryContext.sources.forEach(r=>this._sources.add(r)),this._queryContext.added.on(r=>{this._sources.has(r)||(this._sources.add(r),this._runningCtx!=null&&this._subscribeToSourceUpdates(this._runningCtx,r))}),this._queryContext.removed.on(r=>{r.close(),this._sources.delete(r)}),this._diagnostic={isActive:this._isActive,filter:JSON.stringify(this._filter),creationStack:new StackTrace},QUERIES.add(this._diagnostic),log("construct",{filter:this._filter.toProto()},{F:__dxlog_file10$1,L:163,S:this,C:(r,n)=>r(...n)})}get filter(){return this._filter}get results(){return this._checkQueryIsRunning(),this._signal.notifyRead(),this._ensureCachePresent(),this._resultCache}get objects(){return this._checkQueryIsRunning(),this._signal.notifyRead(),this._ensureCachePresent(),this._objectCache}get _isActive(){return this._runningCtx!=null}async run(e={timeout:1e3}){const t=this._filter,r=[...this._sources.values()].map(async s=>{try{return await asyncTimeout(s.run(t),e.timeout)}catch(a){a instanceof TimeoutError$2||log.catch(a,void 0,{F:__dxlog_file10$1,L:198,S:this,C:(c,l)=>c(...l)})}});if(r.length===0)return{objects:[],results:[]};const n=(await Promise.all(r)).flatMap(s=>s??[]),o=this._filterResults(t,n);return{results:o,objects:this._uniqueObjects(o)}}subscribe(e,t){invariant$1(!(!e&&(t!=null&&t.fire)),"Cannot fire without a callback.",{F:__dxlog_file10$1,L:220,S:this,A:["!(!callback && opts?.fire)","'Cannot fire without a callback.'"]}),log("subscribe",void 0,{F:__dxlog_file10$1,L:222,S:this,C:(o,s)=>o(...s)}),this._subscribers++;const r=e?this._event.on(e):void 0;this._handleQueryLifecycle();const n=()=>{log("unsubscribe",void 0,{F:__dxlog_file10$1,L:228,S:this,C:(o,s)=>o(...s)}),this._subscribers--,r==null||r(),this._handleQueryLifecycle()};if(e&&(t!=null&&t.fire))try{e(this)}catch(o){throw n(),o}return n}_ensureCachePresent(){this._resultCache||prohibitSignalActions(()=>{compositeRuntime.untracked(()=>{this._resultCache=this._filterResults(this._filter,Array.from(this._sources).flatMap(e=>e.getResults())),this._objectCache=this._uniqueObjects(this._resultCache)})})}_filterResults(e,t){return t.filter(r=>r.object&&filterMatch(e,getAutomergeObjectCore(r.object)))}_uniqueObjects(e){const t=new Set;return e.map(r=>r.object).filter(nonNullable).filter(r=>t.has(r.id)?!1:(t.add(r.id),!0))}_handleQueryLifecycle(){this._subscribers===0&&this._runningCtx!=null?(log("stop query",{filter:this._filter.toProto()},{F:__dxlog_file10$1,L:281,S:this,C:(e,t)=>e(...t)}),this._stop()):this._subscribers>0&&this._runningCtx==null&&(log("start query",{filter:this._filter.toProto()},{F:__dxlog_file10$1,L:284,S:this,C:(e,t)=>e(...t)}),this._start())}_start(){if(this._runningCtx==null){this._runningCtx=new Context({onError:e=>{log.catch(e,void 0,{F:__dxlog_file10$1,L:293,S:this,C:(t,r)=>t(...r)})}}),this._queryContext.start();for(const e of this._sources)this._subscribeToSourceUpdates(this._runningCtx,e);this._diagnostic.isActive=!0}}_stop(){var e;this._runningCtx&&((e=this._runningCtx.dispose())==null||e.catch(),this._queryContext.stop(),this._runningCtx=null,this._diagnostic.isActive=!1)}_subscribeToSourceUpdates(e,t){t.changed.on(e,()=>{this._resultCache=void 0,this._objectCache=void 0,compositeRuntime.untracked(()=>{this._event.emit(this),this._signal.notifyWrite()})}),t.update(this._filter)}_checkQueryIsRunning(){if(this._runningCtx==null)throw new Error("Query must have at least 1 subscriber for `.objects` and `.results` to be used. Use query.run() for single-use result retrieval.")}},QUERIES=new Set;trace.diagnostic({id:"client-queries",name:"Queries (Client)",fetch:()=>Array.from(QUERIES).map(e=>({isActive:e.isActive,filter:e.filter,creationStack:e.creationStack.getStack()}))});function _ts_decorate3$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file11$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/query/query-state.ts",QueryState=class extends Resource{constructor(e){super(),this._params=e,this._results=[],this._firstRun=!0,this.metrics={objectsReturned:0,objectsReturnedFromIndex:0,documentsLoaded:0,executionTime:0,indexQueryTime:0,documentLoadTime:0},this.filter=e.request.filter}get active(){return this._lifecycleState===LifecycleState.OPEN}getResults(){return this._results}async execQuery(){const e=Filter.fromProto(this._params.request.filter),t=performance.now(),r=await this._params.indexer.execQuery(filterToIndexQuery(e));this._firstRun&&(this.metrics.indexQueryTime=performance.now()-t);const n=performance.now(),o=(await Promise.all(r.map(async a=>{var d,f;this._firstRun&&this.metrics.objectsReturnedFromIndex++;const{objectId:c,documentId:l,spaceKey:h}=objectPointerCodec.decode(a.id);let u;if(h!==void 0)u=h;else{const _=this._params.automergeHost.repo.handles[l]??this._params.automergeHost.repo.find(l);if(_.isReady()||(this._firstRun&&this.metrics.documentsLoaded++,await _.whenReady()),this._ctx.disposed)return;u=getSpaceKeyFromDoc(_.docSync())}if(u&&!((f=(d=this._params.request.filter.options)==null?void 0:d.spaces)!=null&&f.length&&!this._params.request.filter.options.spaces.some(_=>_.equals(u))))return this._firstRun&&this.metrics.objectsReturned++,{id:c,spaceKey:PublicKey.from(u),rank:a.rank}}))).filter(nonNullable);if(this._firstRun&&(this.metrics.documentLoadTime=performance.now()-n),this._ctx.disposed)return{changed:!1};const s=this._results.length===o.length&&this._results.every(a=>o.some(c=>c.id===a.id))&&o.every(a=>this._results.some(c=>c.id===a.id));return this._firstRun&&(this.metrics.executionTime=performance.now()-t),this._firstRun=!1,s?{changed:!1}:(this._results=o,{changed:!0})}};_ts_decorate3$1([trace.info({depth:null})],QueryState.prototype,"filter",void 0),_ts_decorate3$1([trace.info()],QueryState.prototype,"metrics",void 0),_ts_decorate3$1([trace.info()],QueryState.prototype,"active",null),_ts_decorate3$1([trace.span({showInBrowserTimeline:!0,op:"db.query",attributes:{"db.system":"echo"}})],QueryState.prototype,"execQuery",null),QueryState=_ts_decorate3$1([trace.resource()],QueryState);var filterToIndexQuery=e=>{var t;return invariant$1(!(e.type&&e.or.length>0),"Cannot mix type and or filters.",{F:__dxlog_file11$1,L:177,S:void 0,A:["!(filter.type && filter.or.length > 0)","'Cannot mix type and or filters.'"]}),invariant$1(e.or.every(r=>!(r.type&&r.or.length>0)),"Cannot mix type and or filters.",{F:__dxlog_file11$1,L:178,S:void 0,A:["filter.or.every((subFilter) => !(subFilter.type && subFilter.or.length > 0))","'Cannot mix type and or filters.'"]}),e.type||e.or.length>0&&e.or.every(r=>!r.not&&r.type)?{typenames:(t=e.type)!=null&&t.itemId?[e.type.itemId]:e.or.map(r=>{var n;return(n=r.type)==null?void 0:n.itemId}).filter(nonNullable),inverted:e.not}:{typenames:[]}},__dxlog_file12$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/query/query-service.ts",QueryServiceImpl=class extends Resource{constructor(e){super(),this._params=e,this._queries=new Set,this._updateQueries=new DeferredTask(this._ctx,async()=>{await Promise.all(Array.from(this._queries).map(async t=>{try{const{changed:r}=await t.state.execQuery();r&&t.sendResults(t.state.getResults())}catch(r){log.catch(r,void 0,{F:__dxlog_file12$1,L:51,S:this,C:(n,o)=>n(...o)})}}))}),trace.diagnostic({id:"active-queries",name:"Active Queries",fetch:()=>Array.from(this._queries).map(t=>({filter:JSON.stringify(t.state.filter),metrics:t.state.metrics}))})}async _open(){this._params.indexer.updated.on(this._ctx,()=>this._updateQueries.schedule())}async _close(){await Promise.all(Array.from(this._queries).map(e=>e.close()))}async setConfig(e){if(this._params.indexer.initialized){log.warn("Indexer already initialized.",void 0,{F:__dxlog_file12$1,L:85,S:this,C:(t,r)=>t(...r)});return}this._params.indexer.setConfig(e)}execQuery(e){return new Stream$2(({next:t,close:r,ctx:n})=>{const o={state:new QueryState({indexer:this._params.indexer,automergeHost:this._params.automergeHost,request:e}),sendResults:s=>{n.disposed||t({queryId:e.queryId,results:s})},close:async()=>{r(),await o.state.close(),this._queries.delete(o)}};return this._queries.add(o),queueMicrotask(async()=>{await o.state.open();try{const{changed:s}=await o.state.execQuery();s&&o.sendResults(o.state.getResults())}catch(s){log.catch(s,void 0,{F:__dxlog_file12$1,L:122,S:this,C:(a,c)=>a(...c)})}}),o.close})}async reindex(){log.info("Reindexing all documents...",void 0,{F:__dxlog_file12$1,L:134,S:this,C:(r,n)=>r(...n)});const e=createDocumentsIterator(this._params.automergeHost),t=new Map;for await(const r of e()){for(const{id:n,heads:o}of r)t.set(n,o);t.size%100===0&&log.info("Collected documents...",{count:t.size},{F:__dxlog_file12$1,L:142,S:this,C:(n,o)=>n(...o)})}log.info("Marking all documents as dirty...",{count:t.size},{F:__dxlog_file12$1,L:146,S:this,C:(r,n)=>r(...n)}),await this._params.indexer.reindex(t)}},createDocumentsIterator=e=>async function*(){const t=new Set;async function*r(n){if(t.has(n.documentId))return;n.isReady()||await n.whenReady();const o=n.docSync(),s=getSpaceKeyFromDoc(o)??void 0;if(o.objects&&(yield Object.entries(o.objects).map(([a,c])=>({id:objectPointerCodec.encode({documentId:n.documentId,objectId:a,spaceKey:s}),object:c,heads:getHeads(o)}))),o.links)for(const a of Object.values(o.links)){if(t.has(a))continue;const c=e.repo.handles[a]??e.repo.find(a);for await(const l of r(c))yield l}t.add(n.documentId)}for(const n of Object.values(e.repo.handles))if(!t.has(n.documentId)){for await(const o of r(n))yield o;t.add(n.documentId)}},__dxlog_file13$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/dynamic-schema-registry.ts",DynamicSchemaRegistry=class{constructor(e){this.db=e,this._schemaById=new Map,this._schemaByType=new Map,this._unsubscribeFnById=new Map,this._onSchemaListChangeListeners=[],this.db.query(Filter.schema(StoredEchoSchema)).subscribe(({objects:t})=>{const r=new Set(t.map(s=>s.id)),n=t.filter(s=>!this._schemaById.has(s.id)),o=[...this._schemaById.keys()].filter(s=>!r.has(s));n.forEach(s=>this._register(s)),o.forEach(s=>this._unregisterById(s)),(n.length>0||o.length>0)&&this._notifySchemaListChanged()})}isRegistered(e){var r;const t=e instanceof DynamicEchoSchema?e.id:(r=getEchoObjectAnnotation(e))==null?void 0:r.storedSchemaId;return t!=null&&this.getById(t)!=null}getById(e){const t=this._schemaById.get(e);if(t!=null)return t;const r=this.db.getObjectById(e);if(r!=null){if(!(r instanceof StoredEchoSchema)){log.warn("type object is not a stored schema",{id:r==null?void 0:r.id},{F:__dxlog_file13$1,L:54,S:this,C:(n,o)=>n(...o)});return}return this._register(r)}}getRegisteredByTypename(e){return this._schemaByType.get(e)}async getAll(){return(await this.db.query(Filter.schema(StoredEchoSchema)).run()).objects.map(e=>this._register(e))}subscribe(e){return e([...this._schemaById.values()]),this._onSchemaListChangeListeners.push(e),()=>{const t=this._onSchemaListChangeListeners.indexOf(e);t>=0&&this._onSchemaListChangeListeners.splice(t,1)}}add(e){const t=getEchoObjectAnnotation(e);invariant$1(t,"use S.Struct({}).pipe(echoObject(...)) or class syntax to create a valid schema",{F:__dxlog_file13$1,L:83,S:this,A:["typeAnnotation","'use S.Struct({}).pipe(echoObject(...)) or class syntax to create a valid schema'"]});const r=create$2(StoredEchoSchema,{typename:t.typename,version:t.version,jsonSchema:{}}),n=e.annotations({[EchoObjectAnnotationId]:{...t,storedSchemaId:r.id}});r.jsonSchema=effectToJsonSchema(n);const o=this.db.add(r),s=this._register(o);return this._notifySchemaListChanged(),s}register(e){const t=this._schemaById.get(e.id);if(t!=null)return t;const r=this._register(e);return this._notifySchemaListChanged(),r}_register(e){const t=this._schemaById.get(e.id);if(t!=null)return t;const r=new DynamicEchoSchema(e),n=getAutomergeObjectCore(e).updates.on(()=>{r.invalidate()});return this._schemaById.set(e.id,r),this._schemaByType.set(e.typename,r),this._unsubscribeFnById.set(e.id,n),r}_unregisterById(e){var r;const t=this._schemaById.get(e);t!=null&&(this._schemaById.delete(e),this._schemaByType.delete(t.typename),(r=this._unsubscribeFnById.get(t.id))==null||r(),this._unsubscribeFnById.delete(t.id))}_notifySchemaListChanged(){const e=[...this._schemaById.values()];this._onSchemaListChangeListeners.forEach(t=>t(e))}};function _ts_decorate4$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file14$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/database.ts",EchoDatabaseImpl=class extends Resource{constructor(e){super(),this._rootUrl=void 0,this.pendingBatch=new Event$1;const t=r=>{initEchoReactiveObjectRootProxy(r)};this._automerge=new AutomergeDb(e.graph,e.automergeContext,e.spaceKey,t,this),this.schemaRegistry=new DynamicSchemaRegistry(this)}get graph(){return this._automerge.graph}get spaceKey(){return this._automerge.spaceKey}get rootUrl(){return this._rootUrl}async _open(e){this._rootUrl!==void 0&&await this._automerge.open({rootUrl:this._rootUrl})}async _close(e){}async setSpaceRoot(e){const t=this._rootUrl===void 0;this._rootUrl=e,this._lifecycleState===LifecycleState.OPEN&&(t?await this._automerge.open({rootUrl:e}):await this._automerge.update({rootUrl:e}))}getObjectById(e){return this._automerge.getObjectById(e)}add(e){if(isEchoObject(e))return this._automerge.add(e),e;{const t=getSchema(e);if(t!=null&&!this.schemaRegistry.isRegistered(t)&&!this.graph.runtimeSchemaRegistry.hasSchema(t))throw createSchemaNotRegisteredError(t);const r=createEchoObject(e);return this._automerge.add(r),r}}remove(e){return invariant$1(isEchoObject(e),void 0,{F:__dxlog_file14$1,L:156,S:this,A:["isEchoObject(obj)",""]}),this._automerge.remove(e)}query(e,t){return this._automerge.graph.query(e,{...t,spaces:[this.spaceKey]})}async flush(){await this._automerge.flush()}get objects(){return this._automerge.allObjectCores().map(e=>e.rootProxy)}get automerge(){return this._automerge}};_ts_decorate4$1([synchronized],EchoDatabaseImpl.prototype,"_open",null),_ts_decorate4$1([synchronized],EchoDatabaseImpl.prototype,"_close",null),_ts_decorate4$1([synchronized],EchoDatabaseImpl.prototype,"setSpaceRoot",null);var createSchemaNotRegisteredError=e=>{const t="Schema not registered";return e!=null&&e.typename?new Error(`${t} Schema: ${e.typename}`):new Error(t)},getTypenameOrThrow=e=>requireTypeReference(e).itemId,RuntimeSchemaRegistry=class{constructor(){this._schemaMap=new Map,this._schemaMap.set(StoredEchoSchema.typename,StoredEchoSchema)}get schemas(){return Array.from(this._schemaMap.values())}hasSchema(e){const t=getTypenameOrThrow(e);return this._schemaMap.has(t)}getSchema(e){return this._schemaMap.get(e)}registerSchema(...e){return e.forEach(t=>{const r=getTypenameOrThrow(t);if(this._schemaMap.has(r))throw new Error(`Schema was already registered: ${r}`);this._schemaMap.set(r,t)}),this}},__dxlog_file15$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/hypergraph.ts",Hypergraph=class{constructor(){this._databases=new ComplexMap(PublicKey.hash),this._owningObjects=new ComplexMap(PublicKey.hash),this._runtimeSchemaRegistry=new RuntimeSchemaRegistry,this._updateEvent=new Event$1,this._resolveEvents=new ComplexMap(PublicKey.hash),this._queryContexts=new Set,this._querySourceProviders=[]}get runtimeSchemaRegistry(){return this._runtimeSchemaRegistry}_register(e,t,r){this._databases.set(e,t),this._owningObjects.set(e,r),t.automerge._updateEvent.on(this._onUpdate.bind(this));const n=this._resolveEvents.get(e);if(n)for(const[o,s]of n){const a=t.getObjectById(o);a&&(log("resolve",{spaceKey:e,itemId:o},{F:__dxlog_file15$1,L:67,S:this,C:(c,l)=>c(...l)}),s.emit(a),n.delete(o))}for(const o of this._queryContexts.values())o.addQuerySource(new SpaceQuerySource(t))}_unregister(e){this._databases.delete(e)}_getOwningObject(e){return this._owningObjects.get(e)}query(e,t){const r=t==null?void 0:t.spaces;return invariant$1(!r||r.every(n=>n instanceof PublicKey),"Invalid spaces filter",{F:__dxlog_file15$1,L:93,S:this,A:["!spaces || spaces.every((space) => space instanceof PublicKey)","'Invalid spaces filter'"]}),new Query(this._createQueryContext(),Filter.from(e,t))}_lookupLink(e,t,r){if(e.host===void 0){const o=t.getObjectById(e.itemId);if(o)return o}const n=e.host?PublicKey.from(e.host):t==null?void 0:t.spaceKey;if(e.host){const o=this._databases.get(n);if(o){const s=o.getObjectById(e.itemId);if(s)return s}}OBJECT_DIAGNOSTICS.has(e.itemId)||OBJECT_DIAGNOSTICS.set(e.itemId,{objectId:e.itemId,spaceKey:n.toHex(),loadReason:"reference access",loadedStack:new StackTrace}),log("trap",{spaceKey:n,itemId:e.itemId},{F:__dxlog_file15$1,L:135,S:this,C:(o,s)=>o(...s)}),entry(this._resolveEvents,n).orInsert(new Map).deep(e.itemId).orInsert(new Event$1).value.on(new Context,r,{weak:!0})}registerQuerySourceProvider(e){this._querySourceProviders.push(e);for(const t of this._queryContexts.values())t.addQuerySource(e.create())}unregisterQuerySourceProvider(e){const t=this._querySourceProviders.indexOf(e);t!==-1&&this._querySourceProviders.splice(t,1)}_onUpdate(e){const t=this._resolveEvents.get(e.spaceKey);t&&compositeRuntime.batch(()=>{for(const r of e.itemsUpdated){const n=t.get(r.id);if(!n)continue;const o=this._databases.get(e.spaceKey);if(!o)continue;const s=o.getObjectById(r.id);s&&(log("resolve",{spaceKey:e.spaceKey,itemId:s.id},{F:__dxlog_file15$1,L:178,S:this,C:(a,c)=>a(...c)}),n.emit(s),t.delete(r.id))}}),this._updateEvent.emit(e)}_createQueryContext(){const e=new GraphQueryContext({onStart:()=>{this._queryContexts.add(e)},onStop:()=>{for(const t of e.sources)t.close();this._queryContexts.delete(e)}});for(const t of this._databases.values())e.addQuerySource(new SpaceQuerySource(t));for(const t of this._querySourceProviders)e.addQuerySource(t.create());return e}},GraphQueryContext=class{constructor(e){this._params=e,this.added=new Event$1,this.removed=new Event$1,this.sources=[]}start(){this._params.onStart()}stop(){this._params.onStop()}addQuerySource(e){this.sources.push(e),this.added.emit(e)}},SpaceQuerySource=class{constructor(e){this._database=e,this.changed=new Event$1,this._ctx=new Context,this._filter=void 0,this._results=void 0,this._onUpdate=t=>{this._filter&&prohibitSignalActions(()=>{t.itemsUpdated.some(r=>!this._results||this._results.find(n=>n.id===r.id)||this._database.automerge._objects.has(r.id)&&filterMatch(this._filter,this._database.automerge.getObjectCoreById(r.id)))&&(this._results=void 0,this.changed.emit())})}}get spaceKey(){return this._database.spaceKey}async run(e){if(!this._isValidSourceForFilter(e))return[];let t=[];return prohibitSignalActions(()=>{t=this._query(e)}),t}getResults(){return this._filter?(this._results||prohibitSignalActions(()=>{this._results=this._query(this._filter)}),this._results):[]}update(e){if(!this._isValidSourceForFilter(e)){this._filter=void 0;return}this._ctx.dispose().catch(),this._ctx=new Context,this._filter=e,this._database.automerge._updateEvent.on(this._ctx,this._onUpdate,{weak:!0}),this._results=void 0,this.changed.emit()}close(){this._filter=void 0,this._results=void 0,this._ctx.dispose().catch()}_query(e){return this._database.automerge.allObjectCores().filter(t=>filterMatch(e,t)).map(t=>({id:t.id,spaceKey:this.spaceKey,object:t.rootProxy,resolution:{source:"local",time:0}}))}_isValidSourceForFilter(e){return!(e.spaceKeys!==void 0&&!e.spaceKeys.some(t=>t.equals(this.spaceKey))||e.options.dataLocation&&e.options.dataLocation===QueryOptions.DataLocation.REMOTE)}},OBJECT_DIAGNOSTICS=new Map;trace.diagnostic({id:"referenced-objects",name:"Referenced Objects (Client)",fetch:()=>Array.from(OBJECT_DIAGNOSTICS.values()).map(e=>{var t;return{objectId:e.objectId,spaceKey:e.spaceKey,loadReason:e.loadReason,creationStack:(t=e.loadedStack)==null?void 0:t.getStack(),query:e.query}})});var __dxlog_file16$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/client/index-query-source-provider.ts",IndexQuerySourceProvider=class{constructor(e){this._params=e}create(){return new IndexQuerySource({service:this._params.service,objectLoader:this._params.objectLoader})}},IndexQuerySource=class{constructor(e){this._params=e,this.changed=new Event$1,this._filter=void 0,this._results=[]}getResults(){return this._results??[]}async run(e){return this._filter=e,new Promise((t,r)=>{this._queryIndex(e,n=>(t(n),1),r)})}update(e){var t;((t=e.options)==null?void 0:t.dataLocation)!==QueryOptions.DataLocation.LOCAL&&(this._filter=e,this._closeStream(),this._results=[],this.changed.emit(),this._queryIndex(e,r=>(this._results=r,this.changed.emit(),0)))}close(){this._results=void 0,this._closeStream()}_queryIndex(e,t,r){const n=Date.now();let o;this._stream&&log.warn("Query stream already open",void 0,{F:__dxlog_file16$1,L:104,S:this,C:(s,a)=>s(...a)}),this._stream=this._params.service.execQuery({filter:e.toProto()},{timeout:2e4}),this._stream.subscribe(async s=>{var l,h;await(o==null?void 0:o.dispose());const a=new Context;o=a;const c=(((l=s.results)==null?void 0:l.length)??0)>0?(await Promise.all(s.results.map(async u=>this._filterMapResult(a,n,u)))).filter(nonNullable):[];t(c)===1&&((h=this._stream)==null||h.close().catch())},s=>{s!=null&&r!=null&&r(s)})}async _filterMapResult(e,t,r){var s;OBJECT_DIAGNOSTICS.has(r.id)||OBJECT_DIAGNOSTICS.set(r.id,{objectId:r.id,spaceKey:r.spaceKey.toHex(),loadReason:"query",query:JSON.stringify(((s=this._filter)==null?void 0:s.toProto())??null)});const n=await this._params.objectLoader.loadObject(r.spaceKey,r.id);if(!n||e.disposed)return null;const o=getAutomergeObjectCore(n);return{id:n.id,spaceKey:o.database.spaceKey,object:n,match:{rank:r.rank},resolution:{source:"index",time:Date.now()-t}}}_closeStream(){var e;(e=this._stream)==null||e.close().catch(),this._stream=void 0}},OnResult;(function(e){e[e.CONTINUE=0]="CONTINUE",e[e.CLOSE_STREAM=1]="CLOSE_STREAM"})(OnResult||(OnResult={}));var __dxlog_file17$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/client/echo-client.ts",EchoClient=class extends Resource{constructor(e){super(),this._databases=new ComplexMap(PublicKey.hash),this._dataService=void 0,this._queryService=void 0,this._automergeContext=void 0,this._indexQuerySourceProvider=void 0,this._graph=new Hypergraph}get graph(){return this._graph}connectToService({dataService:e,queryService:t}){invariant$1(this._lifecycleState===LifecycleState.CLOSED,void 0,{F:__dxlog_file17$1,L:63,S:this,A:["this._lifecycleState === LifecycleState.CLOSED",""]}),this._dataService=e,this._queryService=t}disconnectFromService(){invariant$1(this._lifecycleState===LifecycleState.CLOSED,void 0,{F:__dxlog_file17$1,L:69,S:this,A:["this._lifecycleState === LifecycleState.CLOSED",""]}),this._dataService=void 0,this._queryService=void 0}async _open(e){invariant$1(this._dataService&&this._queryService,"Invalid state: not connected",{F:__dxlog_file17$1,L:75,S:this,A:["this._dataService && this._queryService","'Invalid state: not connected'"]}),this._automergeContext=new AutomergeContext(this._dataService,{spaceFragmentationEnabled:!0}),this._indexQuerySourceProvider=new IndexQuerySourceProvider({service:this._queryService,objectLoader:{loadObject:this._loadObject.bind(this)}}),this._graph.registerQuerySourceProvider(this._indexQuerySourceProvider)}async _close(e){var t;this._indexQuerySourceProvider&&this._graph.unregisterQuerySourceProvider(this._indexQuerySourceProvider);for(const r of this._databases.values())this._graph._unregister(r.spaceKey),await r.close();this._databases.clear(),await((t=this._automergeContext)==null?void 0:t.close()),this._automergeContext=void 0}constructDatabase({spaceKey:e,owningObject:t}){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file17$1,L:104,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]}),invariant$1(!this._databases.has(e),"Database already exists.",{F:__dxlog_file17$1,L:105,S:this,A:["!this._databases.has(spaceKey)","'Database already exists.'"]});const r=new EchoDatabaseImpl({automergeContext:this._automergeContext,graph:this._graph,spaceKey:e});return this._graph._register(e,r,t),this._databases.set(e,r),r}async _loadObject(e,t){const r=this._databases.get(e);if(r){try{await r.automerge.opened.wait()}catch(n){if(n instanceof ContextDisposedError)return;throw n}return await r.automerge.loadObjectById(t)}}},__dxlog_file18$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/host/automerge-metrics.ts",measureDocMetrics=e=>{const t=save(e),r=Date.now(),n=load(t),o=Date.now();free(n);const s=Date.now(),a=getAllChanges(e).length,c=Date.now();return c-s>300&&log.warn("getAllChanges took too long",{elapsed:c-s},{F:__dxlog_file18$1,L:30,S:void 0,C:(l,h)=>l(...h)}),{compressedByteSize:t.byteLength,loadTime:o-r,mutationCount:a}},DatabaseRoot=class{constructor(e){this._rootHandle=e}get url(){return this._rootHandle.url}get isLoaded(){return!!this._rootHandle.docSync()}getSpaceKey(){const e=this._docSync();return e?getSpaceKeyFromDoc(e):null}getInlineObjectCount(){const e=this._docSync();return e?Object.keys(e.objects??{}).length:null}getLinkedObjectCount(){const e=this._docSync();return e?Object.keys(e.links??{}).length:null}measureMetrics(){const e=this._docSync();return e?measureDocMetrics(e):null}_docSync(){return this._rootHandle.docSync()}},__dxlog_file19$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/host/documents-iterator.ts",LOG_VIEW_OPERATION_THRESHOLD=300,createSelectedDocumentsIterator=e=>async function*(t){var r;for(const[n,o]of t.entries())try{const{documentId:s,objectId:a}=objectPointerCodec.decode(n),c=e.repo.handles[s]??e.repo.find(s);c.isReady()||await c.whenReady();let l=c.docSync();invariant$1(l,void 0,{F:__dxlog_file19$1,L:37,S:this,A:["doc",""]});const h=getHeads(l);if(!equals(h,o)){const d=Date.now();l=view(l,o);const f=Date.now();f-d>LOG_VIEW_OPERATION_THRESHOLD&&log.info("Checking out document version is taking too long",{duration:f-d,requestedHeads:o,originalHeads:h},{F:__dxlog_file19$1,L:48,S:this,C:(_,p)=>_(...p)})}if(!((r=l.objects)!=null&&r[a])){yield[];continue}let u=n;if(objectPointerCodec.getVersion(n)===ObjectPointerVersion.V0){const d=getSpaceKeyFromDoc(l)??void 0;u=objectPointerCodec.encode({documentId:s,objectId:a,spaceKey:d})}yield[{id:u,object:l.objects[a],heads:o}]}catch(s){log.error("Error loading document",{heads:o,id:n,error:s},{F:__dxlog_file19$1,L:70,S:this,C:(a,c)=>a(...c)})}},__dxlog_file20$1="/home/runner/work/dxos/dxos/packages/core/echo/echo-db/src/host/echo-host.ts",INDEXER_CONFIG={enabled:!0,indexes:[{kind:IndexKind.Kind.SCHEMA_MATCH}]},EchoHost=class extends Resource{constructor({kv:e,storage:t}){super(),this._roots=new Map,this._indexMetadataStore=new IndexMetadataStore({db:e.sublevel("index-metadata")}),this._automergeHost=new AutomergeHost({db:e.sublevel("automerge"),indexMetadataStore:this._indexMetadataStore,directory:t==null?void 0:t.createDirectory("automerge")}),this._indexer=new Indexer({db:e,indexStore:new IndexStore({db:e.sublevel("index-storage")}),metadataStore:this._indexMetadataStore,loadDocuments:createSelectedDocumentsIterator(this._automergeHost)}),this._indexer.setConfig(INDEXER_CONFIG),this._queryService=new QueryServiceImpl({automergeHost:this._automergeHost,indexer:this._indexer}),this._dataService=new DataServiceImpl(this._automergeHost),this._meshEchoReplicator=new MeshEchoReplicator,trace.diagnostic({id:"database-roots",name:"Database Roots",fetch:async()=>Array.from(this._roots.values()).map(r=>({url:r.url,isLoaded:r.isLoaded,spaceKey:r.getSpaceKey(),inlineObjects:r.getInlineObjectCount(),linkedObjects:r.getLinkedObjectCount()}))}),trace.diagnostic({id:"database-root-metrics",name:"Database Roots (with metrics)",fetch:async()=>Array.from(this._roots.values()).map(r=>({url:r.url,isLoaded:r.isLoaded,spaceKey:r.getSpaceKey(),inlineObjects:r.getInlineObjectCount(),linkedObjects:r.getLinkedObjectCount(),...r.measureMetrics()??{}}))})}get queryService(){return this._queryService}get dataService(){return this._dataService}get automergeRepo(){return this._automergeHost.repo}get roots(){return this._roots}async _open(e){await this._automergeHost.open(),await this._indexer.open(e),await this._queryService.open(e),await this._automergeHost.addReplicator(this._meshEchoReplicator)}async _close(e){await this._automergeHost.removeReplicator(this._meshEchoReplicator),await this._queryService.close(e),await this._indexer.close(e),await this._automergeHost.close(),this._roots.clear()}async flush(){await this._automergeHost.repo.flush()}async updateIndexes(){await this._indexer.updateIndexes()}async createSpaceRoot(e){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file20$1,L:158,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]});const t=this._automergeHost.repo.create();return t.change(r=>{r.access={spaceKey:e.toHex()}}),await this._automergeHost.repo.flush([t.documentId]),await this.openSpaceRoot(t.url)}async openSpaceRoot(e){invariant$1(this._lifecycleState===LifecycleState.OPEN,void 0,{F:__dxlog_file20$1,L:171,S:this,A:["this._lifecycleState === LifecycleState.OPEN",""]});const t=this._automergeHost.repo.find(e);invariant$1(!this._roots.has(t.documentId),"Root document already exists.",{F:__dxlog_file20$1,L:173,S:this,A:["!this._roots.has(handle.documentId)","'Root document already exists.'"]});const r=new DatabaseRoot(t);return this._roots.set(t.documentId,r),r}async closeSpaceRoot(e){todo()}async addReplicator(e){await this._automergeHost.addReplicator(e)}async removeReplicator(e){await this._automergeHost.removeReplicator(e)}authorizeDevice(e,t){this._meshEchoReplicator.authorizeDevice(e,t)}replicateDocument(e){this._automergeHost._requestedDocs.add(e)}createReplicationExtension(){return this._meshEchoReplicator.createExtension()}};function _ts_decorate$6(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$7="/home/runner/work/dxos/dxos/packages/core/halo/keyring/src/keyring.ts",KeyRecord=schema.getCodecForType("dxos.halo.keyring.KeyRecord"),Keyring=class{constructor(e=createStorage({type:StorageType.RAM}).createDirectory("keyring")){this._storage=e,this._keyCache=new ComplexMap(PublicKey.hash),this.keysUpdate=new Event$1,invariant$1(subtleCrypto,"SubtleCrypto not available in this environment.",{F:__dxlog_file$7,L:30,S:this,A:["subtleCrypto","'SubtleCrypto not available in this environment.'"]})}async sign(e,t){const r=await this._getKey(e);return new Uint8Array(await subtleCrypto.sign({name:"ECDSA",hash:"SHA-256"},r.privateKey,t))}async createKey(){const e=await subtleCrypto.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);return await this._setKey(e),keyPairToPublicKey(e)}async _getKey(e){if(!this._keyCache.has(e)){const t=this._storage.getOrCreateFile(e.toHex()),{size:r}=await t.stat();if(r===0)throw new Error(`Key not found: ${e.toHex()}`);const n=await t.read(0,r);await t.close();const o=KeyRecord.decode(n),s=PublicKey.from(o.publicKey);invariant$1(e.equals(s),"Corrupted keyring: Key mismatch",{F:__dxlog_file$7,L:77,S:this,A:["key.equals(publicKey)","'Corrupted keyring: Key mismatch'"]}),invariant$1(o.privateKey,"Corrupted keyring: Missing private key",{F:__dxlog_file$7,L:78,S:this,A:["record.privateKey","'Corrupted keyring: Missing private key'"]});const a={publicKey:await subtleCrypto.importKey("raw",o.publicKey,{name:"ECDSA",namedCurve:"P-256"},!0,["verify"]),privateKey:await subtleCrypto.importKey("pkcs8",o.privateKey,{name:"ECDSA",namedCurve:"P-256"},!0,["sign"])};this._keyCache.set(s,a)}return this._keyCache.get(e)}async _setKey(e){var o;const t=await keyPairToPublicKey(e);this._keyCache.set(t,e);const r={publicKey:t.asUint8Array(),privateKey:new Uint8Array(await subtleCrypto.exportKey("pkcs8",e.privateKey))},n=this._storage.getOrCreateFile(t.toHex());await n.write(0,arrayToBuffer(KeyRecord.encode(r))),await n.close(),await((o=n.flush)==null?void 0:o.call(n)),this.keysUpdate.emit()}deleteKey(e){return todo("We need a method to delete a file.")}async list(){const e=[];for(const t of await this._storage.list()){const r=t.split("/").pop();invariant$1(r,"Invalid file name",{F:__dxlog_file$7,L:134,S:this,A:["fileName","'Invalid file name'"]}),e.push({publicKey:PublicKey.fromHex(r).asUint8Array()})}return e}async importKeyPair(e){return await this._setKey(e),keyPairToPublicKey(e)}};_ts_decorate$6([synchronized],Keyring.prototype,"_getKey",null),_ts_decorate$6([synchronized],Keyring.prototype,"_setKey",null);var keyPairToPublicKey=async e=>PublicKey.from(new Uint8Array(await subtleCrypto.exportKey("raw",e.publicKey))),Runtime;(function(e){(function(t){(function(r){(function(n){n[n.RAM=0]="RAM",n[n.IDB=1]="IDB",n[n.CHROME=2]="CHROME",n[n.FIREFOX=3]="FIREFOX",n[n.NODE=4]="NODE",n[n.WEBFS=5]="WEBFS",n[n.LEVELJS=11]="LEVELJS",n[n.JSONDOWN=12]="JSONDOWN"})(r.StorageDriver||(r.StorageDriver={}))})(t.Storage||(t.Storage={}))})(e.Client||(e.Client={}))})(Runtime||(Runtime={}));var lib={},boolean$1={};Object.defineProperty(boolean$1,"__esModule",{value:!0}),boolean$1.boolean=void 0;const boolean=function(e){switch(Object.prototype.toString.call(e)){case"[object String]":return["true","t","yes","y","on","1"].includes(e.trim().toLowerCase());case"[object Number]":return e.valueOf()===1;case"[object Boolean]":return e.valueOf();default:return!1}};boolean$1.boolean=boolean;var isBooleanable$1={};Object.defineProperty(isBooleanable$1,"__esModule",{value:!0}),isBooleanable$1.isBooleanable=void 0;const isBooleanable=function(e){switch(Object.prototype.toString.call(e)){case"[object String]":return["true","t","yes","y","on","1","false","f","no","n","off","0"].includes(e.trim().toLowerCase());case"[object Number]":return[0,1].includes(e.valueOf());case"[object Boolean]":return!0;default:return!1}};isBooleanable$1.isBooleanable=isBooleanable,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.isBooleanable=e.boolean=void 0;const t=boolean$1;Object.defineProperty(e,"boolean",{enumerable:!0,get:function(){return t.boolean}});const r=isBooleanable$1;Object.defineProperty(e,"isBooleanable",{enumerable:!0,get:function(){return r.isBooleanable}})}(lib);var lodash_ismatch={exports:{}};lodash_ismatch.exports,function(e,t){var r=200,n="__lodash_hash_undefined__",o=1,s=2,a=9007199254740991,c="[object Arguments]",l="[object Array]",h="[object Boolean]",u="[object Date]",d="[object Error]",f="[object Function]",_="[object GeneratorFunction]",p="[object Map]",y="[object Number]",w="[object Object]",E="[object Promise]",x="[object RegExp]",B="[object Set]",P="[object String]",U="[object Symbol]",F="[object WeakMap]",G="[object ArrayBuffer]",H="[object DataView]",te="[object Float32Array]",J="[object Float64Array]",le="[object Int8Array]",z="[object Int16Array]",q="[object Int32Array]",he="[object Uint8Array]",V="[object Uint8ClampedArray]",_e="[object Uint16Array]",ee="[object Uint32Array]",W=/[\\^$.*+?()[\]{}|]/g,re=/^\[object .+?Constructor\]$/,ne=/^(?:0|[1-9]\d*)$/,ge={};ge[te]=ge[J]=ge[le]=ge[z]=ge[q]=ge[he]=ge[V]=ge[_e]=ge[ee]=!0,ge[c]=ge[l]=ge[G]=ge[h]=ge[H]=ge[u]=ge[d]=ge[f]=ge[p]=ge[y]=ge[w]=ge[x]=ge[B]=ge[P]=ge[F]=!1;var de=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,ye=typeof self=="object"&&self&&self.Object===Object&&self,Ce=de||ye||Function("return this")(),ke=t&&!t.nodeType&&t,ae=ke&&!0&&e&&!e.nodeType&&e,Q=ae&&ae.exports===ke,C=Q&&de.process,$=function(){try{return C&&C.binding("util")}catch{}}(),j=$&&$.isTypedArray;function O(be,De){for(var Ue=-1,Xe=be?be.length:0;++Ue<Xe;)if(De(be[Ue],Ue,be))return!0;return!1}function k(be,De){for(var Ue=-1,Xe=Array(be);++Ue<be;)Xe[Ue]=De(Ue);return Xe}function ue(be){return function(De){return be(De)}}function pe(be,De){return be==null?void 0:be[De]}function Oe(be){var De=!1;if(be!=null&&typeof be.toString!="function")try{De=!!(be+"")}catch{}return De}function Le(be){var De=-1,Ue=Array(be.size);return be.forEach(function(Xe,gt){Ue[++De]=[gt,Xe]}),Ue}function Me(be,De){return function(Ue){return be(De(Ue))}}function We(be){var De=-1,Ue=Array(be.size);return be.forEach(function(Xe){Ue[++De]=Xe}),Ue}var Fe=Array.prototype,st=Function.prototype,ft=Object.prototype,rt=Ce["__core-js_shared__"],lt=function(){var be=/[^.]+$/.exec(rt&&rt.keys&&rt.keys.IE_PROTO||"");return be?"Symbol(src)_1."+be:""}(),At=st.toString,qe=ft.hasOwnProperty,Je=ft.toString,g=RegExp("^"+At.call(qe).replace(W,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=Ce.Symbol,T=Ce.Uint8Array,ce=ft.propertyIsEnumerable,fe=Fe.splice,ve=Me(Object.keys,Object),Ne=Be(Ce,"DataView"),tt=Be(Ce,"Map"),ct=Be(Ce,"Promise"),ot=Be(Ce,"Set"),it=Be(Ce,"WeakMap"),ut=Be(Object,"create"),dr=_t(Ne),tr=_t(tt),ir=_t(ct),Wr=_t(ot),qt=_t(it),fr=b?b.prototype:void 0,pr=fr?fr.valueOf:void 0;function Qt(be){var De=-1,Ue=be?be.length:0;for(this.clear();++De<Ue;){var Xe=be[De];this.set(Xe[0],Xe[1])}}function Nr(){this.__data__=ut?ut(null):{}}function Ar(be){return this.has(be)&&delete this.__data__[be]}function jt(be){var De=this.__data__;if(ut){var Ue=De[be];return Ue===n?void 0:Ue}return qe.call(De,be)?De[be]:void 0}function Jr(be){var De=this.__data__;return ut?De[be]!==void 0:qe.call(De,be)}function Xr(be,De){var Ue=this.__data__;return Ue[be]=ut&&De===void 0?n:De,this}Qt.prototype.clear=Nr,Qt.prototype.delete=Ar,Qt.prototype.get=jt,Qt.prototype.has=Jr,Qt.prototype.set=Xr;function Ut(be){var De=-1,Ue=be?be.length:0;for(this.clear();++De<Ue;){var Xe=be[De];this.set(Xe[0],Xe[1])}}function Zr(){this.__data__=[]}function Dr(be){var De=this.__data__,Ue=Jt(De,be);if(Ue<0)return!1;var Xe=De.length-1;return Ue==Xe?De.pop():fe.call(De,Ue,1),!0}function Yt(be){var De=this.__data__,Ue=Jt(De,be);return Ue<0?void 0:De[Ue][1]}function _r(be){return Jt(this.__data__,be)>-1}function en(be,De){var Ue=this.__data__,Xe=Jt(Ue,be);return Xe<0?Ue.push([be,De]):Ue[Xe][1]=De,this}Ut.prototype.clear=Zr,Ut.prototype.delete=Dr,Ut.prototype.get=Yt,Ut.prototype.has=_r,Ut.prototype.set=en;function Gt(be){var De=-1,Ue=be?be.length:0;for(this.clear();++De<Ue;){var Xe=be[De];this.set(Xe[0],Xe[1])}}function tn(){this.__data__={hash:new Qt,map:new(tt||Ut),string:new Qt}}function rn(be){return Pe(this,be).delete(be)}function rr(be){return Pe(this,be).get(be)}function sr(be){return Pe(this,be).has(be)}function nn(be,De){return Pe(this,be).set(be,De),this}Gt.prototype.clear=tn,Gt.prototype.delete=rn,Gt.prototype.get=rr,Gt.prototype.has=sr,Gt.prototype.set=nn;function gr(be){var De=-1,Ue=be?be.length:0;for(this.__data__=new Gt;++De<Ue;)this.add(be[De])}function sn(be){return this.__data__.set(be,n),this}function an(be){return this.__data__.has(be)}gr.prototype.add=gr.prototype.push=sn,gr.prototype.has=an;function Ht(be){this.__data__=new Ut(be)}function nr(){this.__data__=new Ut}function cn(be){return this.__data__.delete(be)}function lr(be){return this.__data__.get(be)}function ar(be){return this.__data__.has(be)}function qr(be,De){var Ue=this.__data__;if(Ue instanceof Ut){var Xe=Ue.__data__;if(!tt||Xe.length<r-1)return Xe.push([be,De]),this;Ue=this.__data__=new Gt(Xe)}return Ue.set(be,De),this}Ht.prototype.clear=nr,Ht.prototype.delete=cn,Ht.prototype.get=lr,Ht.prototype.has=ar,Ht.prototype.set=qr;function Wt(be,De){var Ue=Rt(be)||Ct(be)?k(be.length,String):[],Xe=Ue.length,gt=!!Xe;for(var at in be)qe.call(be,at)&&!(gt&&(at=="length"||Qe(at,Xe)))&&Ue.push(at);return Ue}function Jt(be,De){for(var Ue=be.length;Ue--;)if(Tt(be[Ue][0],De))return Ue;return-1}function xr(be){return Je.call(be)}function wr(be,De,Ue,Xe,gt){return be===De?!0:be==null||De==null||!br(be)&&!Tr(De)?be!==be&&De!==De:hr(be,De,wr,Ue,Xe,gt)}function hr(be,De,Ue,Xe,gt,at){var mt=Rt(be),St=Rt(De),wt=l,xt=l;mt||(wt=Ke(be),wt=wt==c?w:wt),St||(xt=Ke(De),xt=xt==c?w:xt);var Ot=wt==w&&!Oe(be),Mt=xt==w&&!Oe(De),Dt=wt==xt;if(Dt&&!Ot)return at||(at=new Ht),mt||je(be)?me(be,De,Ue,Xe,gt,at):xe(be,De,wt,Ue,Xe,gt,at);if(!(gt&s)){var Ft=Ot&&qe.call(be,"__wrapped__"),Kt=Mt&&qe.call(De,"__wrapped__");if(Ft||Kt){var we=Ft?be.value():be,se=Kt?De.value():De;return at||(at=new Ht),Ue(we,se,Xe,gt,at)}}return Dt?(at||(at=new Ht),Ie(be,De,Ue,Xe,gt,at)):!1}function $r(be,De,Ue,Xe){var gt=Ue.length,at=gt;if(be==null)return!at;for(be=Object(be);gt--;){var mt=Ue[gt];if(mt[2]?mt[1]!==be[mt[0]]:!(mt[0]in be))return!1}for(;++gt<at;){mt=Ue[gt];var St=mt[0],wt=be[St],xt=mt[1];if(mt[2]){if(wt===void 0&&!(St in be))return!1}else{var Ot=new Ht,Mt;if(!(Mt===void 0?wr(xt,wt,Xe,o|s,Ot):Mt))return!1}}return!0}function Pr(be){if(!br(be)||ze(be))return!1;var De=mr(be)||Oe(be)?g:re;return De.test(_t(be))}function Hr(be){return Tr(be)&&zt(be.length)&&!!ge[Je.call(be)]}function Qr(be){if(!Ve(be))return ve(be);var De=[];for(var Ue in Object(be))qe.call(be,Ue)&&Ue!="constructor"&&De.push(Ue);return De}function me(be,De,Ue,Xe,gt,at){var mt=gt&s,St=be.length,wt=De.length;if(St!=wt&&!(mt&&wt>St))return!1;var xt=at.get(be);if(xt&&at.get(De))return xt==De;var Ot=-1,Mt=!0,Dt=gt&o?new gr:void 0;for(at.set(be,De),at.set(De,be);++Ot<St;){var Ft=be[Ot],Kt=De[Ot];if(Xe)var we=mt?Xe(Kt,Ft,Ot,De,be,at):Xe(Ft,Kt,Ot,be,De,at);if(we!==void 0){if(we)continue;Mt=!1;break}if(Dt){if(!O(De,function(se,Se){if(!Dt.has(Se)&&(Ft===se||Ue(Ft,se,Xe,gt,at)))return Dt.add(Se)})){Mt=!1;break}}else if(!(Ft===Kt||Ue(Ft,Kt,Xe,gt,at))){Mt=!1;break}}return at.delete(be),at.delete(De),Mt}function xe(be,De,Ue,Xe,gt,at,mt){switch(Ue){case H:if(be.byteLength!=De.byteLength||be.byteOffset!=De.byteOffset)return!1;be=be.buffer,De=De.buffer;case G:return!(be.byteLength!=De.byteLength||!Xe(new T(be),new T(De)));case h:case u:case y:return Tt(+be,+De);case d:return be.name==De.name&&be.message==De.message;case x:case P:return be==De+"";case p:var St=Le;case B:var wt=at&s;if(St||(St=We),be.size!=De.size&&!wt)return!1;var xt=mt.get(be);if(xt)return xt==De;at|=o,mt.set(be,De);var Ot=me(St(be),St(De),Xe,gt,at,mt);return mt.delete(be),Ot;case U:if(pr)return pr.call(be)==pr.call(De)}return!1}function Ie(be,De,Ue,Xe,gt,at){var mt=gt&s,St=Ge(be),wt=St.length,xt=Ge(De),Ot=xt.length;if(wt!=Ot&&!mt)return!1;for(var Mt=wt;Mt--;){var Dt=St[Mt];if(!(mt?Dt in De:qe.call(De,Dt)))return!1}var Ft=at.get(be);if(Ft&&at.get(De))return Ft==De;var Kt=!0;at.set(be,De),at.set(De,be);for(var we=mt;++Mt<wt;){Dt=St[Mt];var se=be[Dt],Se=De[Dt];if(Xe)var oe=mt?Xe(Se,se,Dt,De,be,at):Xe(se,Se,Dt,be,De,at);if(!(oe===void 0?se===Se||Ue(se,Se,Xe,gt,at):oe)){Kt=!1;break}we||(we=Dt=="constructor")}if(Kt&&!we){var Ee=be.constructor,Te=De.constructor;Ee!=Te&&"constructor"in be&&"constructor"in De&&!(typeof Ee=="function"&&Ee instanceof Ee&&typeof Te=="function"&&Te instanceof Te)&&(Kt=!1)}return at.delete(be),at.delete(De),Kt}function Pe(be,De){var Ue=be.__data__;return Ye(De)?Ue[typeof De=="string"?"string":"hash"]:Ue.map}function Re(be){for(var De=Ge(be),Ue=De.length;Ue--;){var Xe=De[Ue],gt=be[Xe];De[Ue]=[Xe,gt,ht(gt)]}return De}function Be(be,De){var Ue=pe(be,De);return Pr(Ue)?Ue:void 0}var Ke=xr;(Ne&&Ke(new Ne(new ArrayBuffer(1)))!=H||tt&&Ke(new tt)!=p||ct&&Ke(ct.resolve())!=E||ot&&Ke(new ot)!=B||it&&Ke(new it)!=F)&&(Ke=function(be){var De=Je.call(be),Ue=De==w?be.constructor:void 0,Xe=Ue?_t(Ue):void 0;if(Xe)switch(Xe){case dr:return H;case tr:return p;case ir:return E;case Wr:return B;case qt:return F}return De});function Qe(be,De){return De=De??a,!!De&&(typeof be=="number"||ne.test(be))&&be>-1&&be%1==0&&be<De}function Ye(be){var De=typeof be;return De=="string"||De=="number"||De=="symbol"||De=="boolean"?be!=="__proto__":be===null}function ze(be){return!!lt&&lt in be}function Ve(be){var De=be&&be.constructor,Ue=typeof De=="function"&&De.prototype||ft;return be===Ue}function ht(be){return be===be&&!br(be)}function _t(be){if(be!=null){try{return At.call(be)}catch{}try{return be+""}catch{}}return""}function Tt(be,De){return be===De||be!==be&&De!==De}function Ct(be){return Vt(be)&&qe.call(be,"callee")&&(!ce.call(be,"callee")||Je.call(be)==c)}var Rt=Array.isArray;function It(be){return be!=null&&zt(be.length)&&!mr(be)}function Vt(be){return Tr(be)&&It(be)}function mr(be){var De=br(be)?Je.call(be):"";return De==f||De==_}function zt(be){return typeof be=="number"&&be>-1&&be%1==0&&be<=a}function br(be){var De=typeof be;return!!be&&(De=="object"||De=="function")}function Tr(be){return!!be&&typeof be=="object"}function $e(be,De){return be===De||$r(be,De,Re(De))}var je=j?ue(j):Hr;function Ge(be){return It(be)?Wt(be):Qr(be)}e.exports=$e}(lodash_ismatch,lodash_ismatch.exports);var lodash_ismatchExports=lodash_ismatch.exports;const isMatch=getDefaultExportFromCjs(lodash_ismatchExports);var FUNC_ERROR_TEXT="Expected a function",HASH_UNDEFINED="__lodash_hash_undefined__",INFINITY=1/0,funcTag="[object Function]",genTag="[object GeneratorFunction]",symbolTag="[object Symbol]",reLeadingDot=/^\./,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reEscapeChar=/\\(\\)?/g,reIsHostCtor=/^\[object .+?Constructor\]$/,freeGlobal=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,freeSelf=typeof self=="object"&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")();function getValue(e,t){return e==null?void 0:e[t]}function isHostObject(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}var arrayProto=Array.prototype,funcProto=Function.prototype,objectProto=Object.prototype,coreJsData=root["__core-js_shared__"],maskSrcKey=function(){var e=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),funcToString=funcProto.toString,hasOwnProperty$1=objectProto.hasOwnProperty,objectToString=objectProto.toString,reIsNative=RegExp("^"+funcToString.call(hasOwnProperty$1).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Symbol$1=root.Symbol,splice=arrayProto.splice,Map$1=getNative(root,"Map"),nativeCreate=getNative(Object,"create"),symbolProto=Symbol$1?Symbol$1.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function Hash(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{}}function hashDelete(e){return this.has(e)&&delete this.__data__[e]}function hashGet(e){var t=this.__data__;if(nativeCreate){var r=t[e];return r===HASH_UNDEFINED?void 0:r}return hasOwnProperty$1.call(t,e)?t[e]:void 0}function hashHas(e){var t=this.__data__;return nativeCreate?t[e]!==void 0:hasOwnProperty$1.call(t,e)}function hashSet(e,t){var r=this.__data__;return r[e]=nativeCreate&&t===void 0?HASH_UNDEFINED:t,this}Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet;function ListCache(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function listCacheClear(){this.__data__=[]}function listCacheDelete(e){var t=this.__data__,r=assocIndexOf(t,e);if(r<0)return!1;var n=t.length-1;return r==n?t.pop():splice.call(t,r,1),!0}function listCacheGet(e){var t=this.__data__,r=assocIndexOf(t,e);return r<0?void 0:t[r][1]}function listCacheHas(e){return assocIndexOf(this.__data__,e)>-1}function listCacheSet(e,t){var r=this.__data__,n=assocIndexOf(r,e);return n<0?r.push([e,t]):r[n][1]=t,this}ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet;function MapCache(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function mapCacheClear(){this.__data__={hash:new Hash,map:new(Map$1||ListCache),string:new Hash}}function mapCacheDelete(e){return getMapData(this,e).delete(e)}function mapCacheGet(e){return getMapData(this,e).get(e)}function mapCacheHas(e){return getMapData(this,e).has(e)}function mapCacheSet(e,t){return getMapData(this,e).set(e,t),this}MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet;function assocIndexOf(e,t){for(var r=e.length;r--;)if(eq(e[r][0],t))return r;return-1}function baseIsNative(e){if(!isObject(e)||isMasked(e))return!1;var t=isFunction(e)||isHostObject(e)?reIsNative:reIsHostCtor;return t.test(toSource(e))}function baseToString(e){if(typeof e=="string")return e;if(isSymbol(e))return symbolToString?symbolToString.call(e):"";var t=e+"";return t=="0"&&1/e==-INFINITY?"-0":t}function getMapData(e,t){var r=e.__data__;return isKeyable(t)?r[typeof t=="string"?"string":"hash"]:r.map}function getNative(e,t){var r=getValue(e,t);return baseIsNative(r)?r:void 0}function isKeyable(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}function isMasked(e){return!!maskSrcKey&&maskSrcKey in e}memoize(function(e){e=toString$1(e);var t=[];return reLeadingDot.test(e)&&t.push(""),e.replace(rePropName,function(r,n,o,s){t.push(o?s.replace(reEscapeChar,"$1"):n||r)}),t});function toSource(e){if(e!=null){try{return funcToString.call(e)}catch{}try{return e+""}catch{}}return""}function memoize(e,t){if(typeof e!="function"||t&&typeof t!="function")throw new TypeError(FUNC_ERROR_TEXT);var r=function(){var n=arguments,o=t?t.apply(this,n):n[0],s=r.cache;if(s.has(o))return s.get(o);var a=e.apply(this,n);return r.cache=s.set(o,a),a};return r.cache=new(memoize.Cache||MapCache),r}memoize.Cache=MapCache;function eq(e,t){return e===t||e!==e&&t!==t}function isFunction(e){var t=isObject(e)?objectToString.call(e):"";return t==funcTag||t==genTag}function isObject(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function isObjectLike(e){return!!e&&typeof e=="object"}function isSymbol(e){return typeof e=="symbol"||isObjectLike(e)&&objectToString.call(e)==symbolTag}function toString$1(e){return e==null?"":baseToString(e)}var localforage={exports:{}};(function(e,t){(function(r){e.exports=r()})(function(){return function r(n,o,s){function a(h,u){if(!o[h]){if(!n[h]){var d=typeof commonjsRequire=="function"&&commonjsRequire;if(!u&&d)return d(h,!0);if(c)return c(h,!0);var f=new Error("Cannot find module '"+h+"'");throw f.code="MODULE_NOT_FOUND",f}var _=o[h]={exports:{}};n[h][0].call(_.exports,function(p){var y=n[h][1][p];return a(y||p)},_,_.exports,r,n,o,s)}return o[h].exports}for(var c=typeof commonjsRequire=="function"&&commonjsRequire,l=0;l<s.length;l++)a(s[l]);return a}({1:[function(r,n,o){(function(s){var a=s.MutationObserver||s.WebKitMutationObserver,c;if(a){var l=0,h=new a(p),u=s.document.createTextNode("");h.observe(u,{characterData:!0}),c=function(){u.data=l=++l%2}}else if(!s.setImmediate&&typeof s.MessageChannel<"u"){var d=new s.MessageChannel;d.port1.onmessage=p,c=function(){d.port2.postMessage(0)}}else"document"in s&&"onreadystatechange"in s.document.createElement("script")?c=function(){var w=s.document.createElement("script");w.onreadystatechange=function(){p(),w.onreadystatechange=null,w.parentNode.removeChild(w),w=null},s.document.documentElement.appendChild(w)}:c=function(){setTimeout(p,0)};var f,_=[];function p(){f=!0;for(var w,E,x=_.length;x;){for(E=_,_=[],w=-1;++w<x;)E[w]();x=_.length}f=!1}n.exports=y;function y(w){_.push(w)===1&&!f&&c()}}).call(this,typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(r,n,o){var s=r(1);function a(){}var c={},l=["REJECTED"],h=["FULFILLED"],u=["PENDING"];n.exports=d;function d(U){if(typeof U!="function")throw new TypeError("resolver must be a function");this.state=u,this.queue=[],this.outcome=void 0,U!==a&&y(this,U)}d.prototype.catch=function(U){return this.then(null,U)},d.prototype.then=function(U,F){if(typeof U!="function"&&this.state===h||typeof F!="function"&&this.state===l)return this;var G=new this.constructor(a);if(this.state!==u){var H=this.state===h?U:F;_(G,H,this.outcome)}else this.queue.push(new f(G,U,F));return G};function f(U,F,G){this.promise=U,typeof F=="function"&&(this.onFulfilled=F,this.callFulfilled=this.otherCallFulfilled),typeof G=="function"&&(this.onRejected=G,this.callRejected=this.otherCallRejected)}f.prototype.callFulfilled=function(U){c.resolve(this.promise,U)},f.prototype.otherCallFulfilled=function(U){_(this.promise,this.onFulfilled,U)},f.prototype.callRejected=function(U){c.reject(this.promise,U)},f.prototype.otherCallRejected=function(U){_(this.promise,this.onRejected,U)};function _(U,F,G){s(function(){var H;try{H=F(G)}catch(te){return c.reject(U,te)}H===U?c.reject(U,new TypeError("Cannot resolve promise with itself")):c.resolve(U,H)})}c.resolve=function(U,F){var G=w(p,F);if(G.status==="error")return c.reject(U,G.value);var H=G.value;if(H)y(U,H);else{U.state=h,U.outcome=F;for(var te=-1,J=U.queue.length;++te<J;)U.queue[te].callFulfilled(F)}return U},c.reject=function(U,F){U.state=l,U.outcome=F;for(var G=-1,H=U.queue.length;++G<H;)U.queue[G].callRejected(F);return U};function p(U){var F=U&&U.then;if(U&&(typeof U=="object"||typeof U=="function")&&typeof F=="function")return function(){F.apply(U,arguments)}}function y(U,F){var G=!1;function H(z){G||(G=!0,c.reject(U,z))}function te(z){G||(G=!0,c.resolve(U,z))}function J(){F(te,H)}var le=w(J);le.status==="error"&&H(le.value)}function w(U,F){var G={};try{G.value=U(F),G.status="success"}catch(H){G.status="error",G.value=H}return G}d.resolve=E;function E(U){return U instanceof this?U:c.resolve(new this(a),U)}d.reject=x;function x(U){var F=new this(a);return c.reject(F,U)}d.all=B;function B(U){var F=this;if(Object.prototype.toString.call(U)!=="[object Array]")return this.reject(new TypeError("must be an array"));var G=U.length,H=!1;if(!G)return this.resolve([]);for(var te=new Array(G),J=0,le=-1,z=new this(a);++le<G;)q(U[le],le);return z;function q(he,V){F.resolve(he).then(_e,function(ee){H||(H=!0,c.reject(z,ee))});function _e(ee){te[V]=ee,++J===G&&!H&&(H=!0,c.resolve(z,te))}}}d.race=P;function P(U){var F=this;if(Object.prototype.toString.call(U)!=="[object Array]")return this.reject(new TypeError("must be an array"));var G=U.length,H=!1;if(!G)return this.resolve([]);for(var te=-1,J=new this(a);++te<G;)le(U[te]);return J;function le(z){F.resolve(z).then(function(q){H||(H=!0,c.resolve(J,q))},function(q){H||(H=!0,c.reject(J,q))})}}},{1:1}],3:[function(r,n,o){(function(s){typeof s.Promise!="function"&&(s.Promise=r(2))}).call(this,typeof commonjsGlobal<"u"?commonjsGlobal:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(r,n,o){var s=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(me){return typeof me}:function(me){return me&&typeof Symbol=="function"&&me.constructor===Symbol&&me!==Symbol.prototype?"symbol":typeof me};function a(me,xe){if(!(me instanceof xe))throw new TypeError("Cannot call a class as a function")}function c(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var l=c();function h(){try{if(!l||!l.open)return!1;var me=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),xe=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!me||xe)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function u(me,xe){me=me||[],xe=xe||{};try{return new Blob(me,xe)}catch(Be){if(Be.name!=="TypeError")throw Be;for(var Ie=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,Pe=new Ie,Re=0;Re<me.length;Re+=1)Pe.append(me[Re]);return Pe.getBlob(xe.type)}}typeof Promise>"u"&&r(3);var d=Promise;function f(me,xe){xe&&me.then(function(Ie){xe(null,Ie)},function(Ie){xe(Ie)})}function _(me,xe,Ie){typeof xe=="function"&&me.then(xe),typeof Ie=="function"&&me.catch(Ie)}function p(me){return typeof me!="string"&&(console.warn(me+" used as a key, but it is not a string."),me=String(me)),me}function y(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var w="local-forage-detect-blob-support",E=void 0,x={},B=Object.prototype.toString,P="readonly",U="readwrite";function F(me){for(var xe=me.length,Ie=new ArrayBuffer(xe),Pe=new Uint8Array(Ie),Re=0;Re<xe;Re++)Pe[Re]=me.charCodeAt(Re);return Ie}function G(me){return new d(function(xe){var Ie=me.transaction(w,U),Pe=u([""]);Ie.objectStore(w).put(Pe,"key"),Ie.onabort=function(Re){Re.preventDefault(),Re.stopPropagation(),xe(!1)},Ie.oncomplete=function(){var Re=navigator.userAgent.match(/Chrome\/(\d+)/),Be=navigator.userAgent.match(/Edge\//);xe(Be||!Re||parseInt(Re[1],10)>=43)}}).catch(function(){return!1})}function H(me){return typeof E=="boolean"?d.resolve(E):G(me).then(function(xe){return E=xe,E})}function te(me){var xe=x[me.name],Ie={};Ie.promise=new d(function(Pe,Re){Ie.resolve=Pe,Ie.reject=Re}),xe.deferredOperations.push(Ie),xe.dbReady?xe.dbReady=xe.dbReady.then(function(){return Ie.promise}):xe.dbReady=Ie.promise}function J(me){var xe=x[me.name],Ie=xe.deferredOperations.pop();if(Ie)return Ie.resolve(),Ie.promise}function le(me,xe){var Ie=x[me.name],Pe=Ie.deferredOperations.pop();if(Pe)return Pe.reject(xe),Pe.promise}function z(me,xe){return new d(function(Ie,Pe){if(x[me.name]=x[me.name]||de(),me.db)if(xe)te(me),me.db.close();else return Ie(me.db);var Re=[me.name];xe&&Re.push(me.version);var Be=l.open.apply(l,Re);xe&&(Be.onupgradeneeded=function(Ke){var Qe=Be.result;try{Qe.createObjectStore(me.storeName),Ke.oldVersion<=1&&Qe.createObjectStore(w)}catch(Ye){if(Ye.name==="ConstraintError")console.warn('The database "'+me.name+'" has been upgraded from version '+Ke.oldVersion+" to version "+Ke.newVersion+', but the storage "'+me.storeName+'" already exists.');else throw Ye}}),Be.onerror=function(Ke){Ke.preventDefault(),Pe(Be.error)},Be.onsuccess=function(){var Ke=Be.result;Ke.onversionchange=function(Qe){Qe.target.close()},Ie(Ke),J(me)}})}function q(me){return z(me,!1)}function he(me){return z(me,!0)}function V(me,xe){if(!me.db)return!0;var Ie=!me.db.objectStoreNames.contains(me.storeName),Pe=me.version<me.db.version,Re=me.version>me.db.version;if(Pe&&(me.version!==xe&&console.warn('The database "'+me.name+`" can't be downgraded from version `+me.db.version+" to version "+me.version+"."),me.version=me.db.version),Re||Ie){if(Ie){var Be=me.db.version+1;Be>me.version&&(me.version=Be)}return!0}return!1}function _e(me){return new d(function(xe,Ie){var Pe=new FileReader;Pe.onerror=Ie,Pe.onloadend=function(Re){var Be=btoa(Re.target.result||"");xe({__local_forage_encoded_blob:!0,data:Be,type:me.type})},Pe.readAsBinaryString(me)})}function ee(me){var xe=F(atob(me.data));return u([xe],{type:me.type})}function W(me){return me&&me.__local_forage_encoded_blob}function re(me){var xe=this,Ie=xe._initReady().then(function(){var Pe=x[xe._dbInfo.name];if(Pe&&Pe.dbReady)return Pe.dbReady});return _(Ie,me,me),Ie}function ne(me){te(me);for(var xe=x[me.name],Ie=xe.forages,Pe=0;Pe<Ie.length;Pe++){var Re=Ie[Pe];Re._dbInfo.db&&(Re._dbInfo.db.close(),Re._dbInfo.db=null)}return me.db=null,q(me).then(function(Be){return me.db=Be,V(me)?he(me):Be}).then(function(Be){me.db=xe.db=Be;for(var Ke=0;Ke<Ie.length;Ke++)Ie[Ke]._dbInfo.db=Be}).catch(function(Be){throw le(me,Be),Be})}function ge(me,xe,Ie,Pe){Pe===void 0&&(Pe=1);try{var Re=me.db.transaction(me.storeName,xe);Ie(null,Re)}catch(Be){if(Pe>0&&(!me.db||Be.name==="InvalidStateError"||Be.name==="NotFoundError"))return d.resolve().then(function(){if(!me.db||Be.name==="NotFoundError"&&!me.db.objectStoreNames.contains(me.storeName)&&me.version<=me.db.version)return me.db&&(me.version=me.db.version+1),he(me)}).then(function(){return ne(me).then(function(){ge(me,xe,Ie,Pe-1)})}).catch(Ie);Ie(Be)}}function de(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function ye(me){var xe=this,Ie={db:null};if(me)for(var Pe in me)Ie[Pe]=me[Pe];var Re=x[Ie.name];Re||(Re=de(),x[Ie.name]=Re),Re.forages.push(xe),xe._initReady||(xe._initReady=xe.ready,xe.ready=re);var Be=[];function Ke(){return d.resolve()}for(var Qe=0;Qe<Re.forages.length;Qe++){var Ye=Re.forages[Qe];Ye!==xe&&Be.push(Ye._initReady().catch(Ke))}var ze=Re.forages.slice(0);return d.all(Be).then(function(){return Ie.db=Re.db,q(Ie)}).then(function(Ve){return Ie.db=Ve,V(Ie,xe._defaultConfig.version)?he(Ie):Ve}).then(function(Ve){Ie.db=Re.db=Ve,xe._dbInfo=Ie;for(var ht=0;ht<ze.length;ht++){var _t=ze[ht];_t!==xe&&(_t._dbInfo.db=Ie.db,_t._dbInfo.version=Ie.version)}})}function Ce(me,xe){var Ie=this;me=p(me);var Pe=new d(function(Re,Be){Ie.ready().then(function(){ge(Ie._dbInfo,P,function(Ke,Qe){if(Ke)return Be(Ke);try{var Ye=Qe.objectStore(Ie._dbInfo.storeName),ze=Ye.get(me);ze.onsuccess=function(){var Ve=ze.result;Ve===void 0&&(Ve=null),W(Ve)&&(Ve=ee(Ve)),Re(Ve)},ze.onerror=function(){Be(ze.error)}}catch(Ve){Be(Ve)}})}).catch(Be)});return f(Pe,xe),Pe}function ke(me,xe){var Ie=this,Pe=new d(function(Re,Be){Ie.ready().then(function(){ge(Ie._dbInfo,P,function(Ke,Qe){if(Ke)return Be(Ke);try{var Ye=Qe.objectStore(Ie._dbInfo.storeName),ze=Ye.openCursor(),Ve=1;ze.onsuccess=function(){var ht=ze.result;if(ht){var _t=ht.value;W(_t)&&(_t=ee(_t));var Tt=me(_t,ht.key,Ve++);Tt!==void 0?Re(Tt):ht.continue()}else Re()},ze.onerror=function(){Be(ze.error)}}catch(ht){Be(ht)}})}).catch(Be)});return f(Pe,xe),Pe}function ae(me,xe,Ie){var Pe=this;me=p(me);var Re=new d(function(Be,Ke){var Qe;Pe.ready().then(function(){return Qe=Pe._dbInfo,B.call(xe)==="[object Blob]"?H(Qe.db).then(function(Ye){return Ye?xe:_e(xe)}):xe}).then(function(Ye){ge(Pe._dbInfo,U,function(ze,Ve){if(ze)return Ke(ze);try{var ht=Ve.objectStore(Pe._dbInfo.storeName);Ye===null&&(Ye=void 0);var _t=ht.put(Ye,me);Ve.oncomplete=function(){Ye===void 0&&(Ye=null),Be(Ye)},Ve.onabort=Ve.onerror=function(){var Tt=_t.error?_t.error:_t.transaction.error;Ke(Tt)}}catch(Tt){Ke(Tt)}})}).catch(Ke)});return f(Re,Ie),Re}function Q(me,xe){var Ie=this;me=p(me);var Pe=new d(function(Re,Be){Ie.ready().then(function(){ge(Ie._dbInfo,U,function(Ke,Qe){if(Ke)return Be(Ke);try{var Ye=Qe.objectStore(Ie._dbInfo.storeName),ze=Ye.delete(me);Qe.oncomplete=function(){Re()},Qe.onerror=function(){Be(ze.error)},Qe.onabort=function(){var Ve=ze.error?ze.error:ze.transaction.error;Be(Ve)}}catch(Ve){Be(Ve)}})}).catch(Be)});return f(Pe,xe),Pe}function C(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){ge(xe._dbInfo,U,function(Be,Ke){if(Be)return Re(Be);try{var Qe=Ke.objectStore(xe._dbInfo.storeName),Ye=Qe.clear();Ke.oncomplete=function(){Pe()},Ke.onabort=Ke.onerror=function(){var ze=Ye.error?Ye.error:Ye.transaction.error;Re(ze)}}catch(ze){Re(ze)}})}).catch(Re)});return f(Ie,me),Ie}function $(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){ge(xe._dbInfo,P,function(Be,Ke){if(Be)return Re(Be);try{var Qe=Ke.objectStore(xe._dbInfo.storeName),Ye=Qe.count();Ye.onsuccess=function(){Pe(Ye.result)},Ye.onerror=function(){Re(Ye.error)}}catch(ze){Re(ze)}})}).catch(Re)});return f(Ie,me),Ie}function j(me,xe){var Ie=this,Pe=new d(function(Re,Be){if(me<0){Re(null);return}Ie.ready().then(function(){ge(Ie._dbInfo,P,function(Ke,Qe){if(Ke)return Be(Ke);try{var Ye=Qe.objectStore(Ie._dbInfo.storeName),ze=!1,Ve=Ye.openKeyCursor();Ve.onsuccess=function(){var ht=Ve.result;if(!ht){Re(null);return}me===0||ze?Re(ht.key):(ze=!0,ht.advance(me))},Ve.onerror=function(){Be(Ve.error)}}catch(ht){Be(ht)}})}).catch(Be)});return f(Pe,xe),Pe}function O(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){ge(xe._dbInfo,P,function(Be,Ke){if(Be)return Re(Be);try{var Qe=Ke.objectStore(xe._dbInfo.storeName),Ye=Qe.openKeyCursor(),ze=[];Ye.onsuccess=function(){var Ve=Ye.result;if(!Ve){Pe(ze);return}ze.push(Ve.key),Ve.continue()},Ye.onerror=function(){Re(Ye.error)}}catch(Ve){Re(Ve)}})}).catch(Re)});return f(Ie,me),Ie}function k(me,xe){xe=y.apply(this,arguments);var Ie=this.config();me=typeof me!="function"&&me||{},me.name||(me.name=me.name||Ie.name,me.storeName=me.storeName||Ie.storeName);var Pe=this,Re;if(!me.name)Re=d.reject("Invalid arguments");else{var Be=me.name===Ie.name&&Pe._dbInfo.db,Ke=Be?d.resolve(Pe._dbInfo.db):q(me).then(function(Qe){var Ye=x[me.name],ze=Ye.forages;Ye.db=Qe;for(var Ve=0;Ve<ze.length;Ve++)ze[Ve]._dbInfo.db=Qe;return Qe});me.storeName?Re=Ke.then(function(Qe){if(Qe.objectStoreNames.contains(me.storeName)){var Ye=Qe.version+1;te(me);var ze=x[me.name],Ve=ze.forages;Qe.close();for(var ht=0;ht<Ve.length;ht++){var _t=Ve[ht];_t._dbInfo.db=null,_t._dbInfo.version=Ye}var Tt=new d(function(Ct,Rt){var It=l.open(me.name,Ye);It.onerror=function(Vt){var mr=It.result;mr.close(),Rt(Vt)},It.onupgradeneeded=function(){var Vt=It.result;Vt.deleteObjectStore(me.storeName)},It.onsuccess=function(){var Vt=It.result;Vt.close(),Ct(Vt)}});return Tt.then(function(Ct){ze.db=Ct;for(var Rt=0;Rt<Ve.length;Rt++){var It=Ve[Rt];It._dbInfo.db=Ct,J(It._dbInfo)}}).catch(function(Ct){throw(le(me,Ct)||d.resolve()).catch(function(){}),Ct})}}):Re=Ke.then(function(Qe){te(me);var Ye=x[me.name],ze=Ye.forages;Qe.close();for(var Ve=0;Ve<ze.length;Ve++){var ht=ze[Ve];ht._dbInfo.db=null}var _t=new d(function(Tt,Ct){var Rt=l.deleteDatabase(me.name);Rt.onerror=function(){var It=Rt.result;It&&It.close(),Ct(Rt.error)},Rt.onblocked=function(){console.warn('dropInstance blocked for database "'+me.name+'" until all open connections are closed')},Rt.onsuccess=function(){var It=Rt.result;It&&It.close(),Tt(It)}});return _t.then(function(Tt){Ye.db=Tt;for(var Ct=0;Ct<ze.length;Ct++){var Rt=ze[Ct];J(Rt._dbInfo)}}).catch(function(Tt){throw(le(me,Tt)||d.resolve()).catch(function(){}),Tt})})}return f(Re,xe),Re}var ue={_driver:"asyncStorage",_initStorage:ye,_support:h(),iterate:ke,getItem:Ce,setItem:ae,removeItem:Q,clear:C,length:$,key:j,keys:O,dropInstance:k};function pe(){return typeof openDatabase=="function"}var Oe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Le="~~local_forage_type~",Me=/^~~local_forage_type~([^~]+)~/,We="__lfsc__:",Fe=We.length,st="arbf",ft="blob",rt="si08",lt="ui08",At="uic8",qe="si16",Je="si32",g="ur16",b="ui32",T="fl32",ce="fl64",fe=Fe+st.length,ve=Object.prototype.toString;function Ne(me){var xe=me.length*.75,Ie=me.length,Pe,Re=0,Be,Ke,Qe,Ye;me[me.length-1]==="="&&(xe--,me[me.length-2]==="="&&xe--);var ze=new ArrayBuffer(xe),Ve=new Uint8Array(ze);for(Pe=0;Pe<Ie;Pe+=4)Be=Oe.indexOf(me[Pe]),Ke=Oe.indexOf(me[Pe+1]),Qe=Oe.indexOf(me[Pe+2]),Ye=Oe.indexOf(me[Pe+3]),Ve[Re++]=Be<<2|Ke>>4,Ve[Re++]=(Ke&15)<<4|Qe>>2,Ve[Re++]=(Qe&3)<<6|Ye&63;return ze}function tt(me){var xe=new Uint8Array(me),Ie="",Pe;for(Pe=0;Pe<xe.length;Pe+=3)Ie+=Oe[xe[Pe]>>2],Ie+=Oe[(xe[Pe]&3)<<4|xe[Pe+1]>>4],Ie+=Oe[(xe[Pe+1]&15)<<2|xe[Pe+2]>>6],Ie+=Oe[xe[Pe+2]&63];return xe.length%3===2?Ie=Ie.substring(0,Ie.length-1)+"=":xe.length%3===1&&(Ie=Ie.substring(0,Ie.length-2)+"=="),Ie}function ct(me,xe){var Ie="";if(me&&(Ie=ve.call(me)),me&&(Ie==="[object ArrayBuffer]"||me.buffer&&ve.call(me.buffer)==="[object ArrayBuffer]")){var Pe,Re=We;me instanceof ArrayBuffer?(Pe=me,Re+=st):(Pe=me.buffer,Ie==="[object Int8Array]"?Re+=rt:Ie==="[object Uint8Array]"?Re+=lt:Ie==="[object Uint8ClampedArray]"?Re+=At:Ie==="[object Int16Array]"?Re+=qe:Ie==="[object Uint16Array]"?Re+=g:Ie==="[object Int32Array]"?Re+=Je:Ie==="[object Uint32Array]"?Re+=b:Ie==="[object Float32Array]"?Re+=T:Ie==="[object Float64Array]"?Re+=ce:xe(new Error("Failed to get type for BinaryArray"))),xe(Re+tt(Pe))}else if(Ie==="[object Blob]"){var Be=new FileReader;Be.onload=function(){var Ke=Le+me.type+"~"+tt(this.result);xe(We+ft+Ke)},Be.readAsArrayBuffer(me)}else try{xe(JSON.stringify(me))}catch(Ke){console.error("Couldn't convert value into a JSON string: ",me),xe(null,Ke)}}function ot(me){if(me.substring(0,Fe)!==We)return JSON.parse(me);var xe=me.substring(fe),Ie=me.substring(Fe,fe),Pe;if(Ie===ft&&Me.test(xe)){var Re=xe.match(Me);Pe=Re[1],xe=xe.substring(Re[0].length)}var Be=Ne(xe);switch(Ie){case st:return Be;case ft:return u([Be],{type:Pe});case rt:return new Int8Array(Be);case lt:return new Uint8Array(Be);case At:return new Uint8ClampedArray(Be);case qe:return new Int16Array(Be);case g:return new Uint16Array(Be);case Je:return new Int32Array(Be);case b:return new Uint32Array(Be);case T:return new Float32Array(Be);case ce:return new Float64Array(Be);default:throw new Error("Unkown type: "+Ie)}}var it={serialize:ct,deserialize:ot,stringToBuffer:Ne,bufferToString:tt};function ut(me,xe,Ie,Pe){me.executeSql("CREATE TABLE IF NOT EXISTS "+xe.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],Ie,Pe)}function dr(me){var xe=this,Ie={db:null};if(me)for(var Pe in me)Ie[Pe]=typeof me[Pe]!="string"?me[Pe].toString():me[Pe];var Re=new d(function(Be,Ke){try{Ie.db=openDatabase(Ie.name,String(Ie.version),Ie.description,Ie.size)}catch(Qe){return Ke(Qe)}Ie.db.transaction(function(Qe){ut(Qe,Ie,function(){xe._dbInfo=Ie,Be()},function(Ye,ze){Ke(ze)})},Ke)});return Ie.serializer=it,Re}function tr(me,xe,Ie,Pe,Re,Be){me.executeSql(Ie,Pe,Re,function(Ke,Qe){Qe.code===Qe.SYNTAX_ERR?Ke.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[xe.storeName],function(Ye,ze){ze.rows.length?Be(Ye,Qe):ut(Ye,xe,function(){Ye.executeSql(Ie,Pe,Re,Be)},Be)},Be):Be(Ke,Qe)},Be)}function ir(me,xe){var Ie=this;me=p(me);var Pe=new d(function(Re,Be){Ie.ready().then(function(){var Ke=Ie._dbInfo;Ke.db.transaction(function(Qe){tr(Qe,Ke,"SELECT * FROM "+Ke.storeName+" WHERE key = ? LIMIT 1",[me],function(Ye,ze){var Ve=ze.rows.length?ze.rows.item(0).value:null;Ve&&(Ve=Ke.serializer.deserialize(Ve)),Re(Ve)},function(Ye,ze){Be(ze)})})}).catch(Be)});return f(Pe,xe),Pe}function Wr(me,xe){var Ie=this,Pe=new d(function(Re,Be){Ie.ready().then(function(){var Ke=Ie._dbInfo;Ke.db.transaction(function(Qe){tr(Qe,Ke,"SELECT * FROM "+Ke.storeName,[],function(Ye,ze){for(var Ve=ze.rows,ht=Ve.length,_t=0;_t<ht;_t++){var Tt=Ve.item(_t),Ct=Tt.value;if(Ct&&(Ct=Ke.serializer.deserialize(Ct)),Ct=me(Ct,Tt.key,_t+1),Ct!==void 0){Re(Ct);return}}Re()},function(Ye,ze){Be(ze)})})}).catch(Be)});return f(Pe,xe),Pe}function qt(me,xe,Ie,Pe){var Re=this;me=p(me);var Be=new d(function(Ke,Qe){Re.ready().then(function(){xe===void 0&&(xe=null);var Ye=xe,ze=Re._dbInfo;ze.serializer.serialize(xe,function(Ve,ht){ht?Qe(ht):ze.db.transaction(function(_t){tr(_t,ze,"INSERT OR REPLACE INTO "+ze.storeName+" (key, value) VALUES (?, ?)",[me,Ve],function(){Ke(Ye)},function(Tt,Ct){Qe(Ct)})},function(_t){if(_t.code===_t.QUOTA_ERR){if(Pe>0){Ke(qt.apply(Re,[me,Ye,Ie,Pe-1]));return}Qe(_t)}})})}).catch(Qe)});return f(Be,Ie),Be}function fr(me,xe,Ie){return qt.apply(this,[me,xe,Ie,1])}function pr(me,xe){var Ie=this;me=p(me);var Pe=new d(function(Re,Be){Ie.ready().then(function(){var Ke=Ie._dbInfo;Ke.db.transaction(function(Qe){tr(Qe,Ke,"DELETE FROM "+Ke.storeName+" WHERE key = ?",[me],function(){Re()},function(Ye,ze){Be(ze)})})}).catch(Be)});return f(Pe,xe),Pe}function Qt(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){var Be=xe._dbInfo;Be.db.transaction(function(Ke){tr(Ke,Be,"DELETE FROM "+Be.storeName,[],function(){Pe()},function(Qe,Ye){Re(Ye)})})}).catch(Re)});return f(Ie,me),Ie}function Nr(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){var Be=xe._dbInfo;Be.db.transaction(function(Ke){tr(Ke,Be,"SELECT COUNT(key) as c FROM "+Be.storeName,[],function(Qe,Ye){var ze=Ye.rows.item(0).c;Pe(ze)},function(Qe,Ye){Re(Ye)})})}).catch(Re)});return f(Ie,me),Ie}function Ar(me,xe){var Ie=this,Pe=new d(function(Re,Be){Ie.ready().then(function(){var Ke=Ie._dbInfo;Ke.db.transaction(function(Qe){tr(Qe,Ke,"SELECT key FROM "+Ke.storeName+" WHERE id = ? LIMIT 1",[me+1],function(Ye,ze){var Ve=ze.rows.length?ze.rows.item(0).key:null;Re(Ve)},function(Ye,ze){Be(ze)})})}).catch(Be)});return f(Pe,xe),Pe}function jt(me){var xe=this,Ie=new d(function(Pe,Re){xe.ready().then(function(){var Be=xe._dbInfo;Be.db.transaction(function(Ke){tr(Ke,Be,"SELECT key FROM "+Be.storeName,[],function(Qe,Ye){for(var ze=[],Ve=0;Ve<Ye.rows.length;Ve++)ze.push(Ye.rows.item(Ve).key);Pe(ze)},function(Qe,Ye){Re(Ye)})})}).catch(Re)});return f(Ie,me),Ie}function Jr(me){return new d(function(xe,Ie){me.transaction(function(Pe){Pe.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(Re,Be){for(var Ke=[],Qe=0;Qe<Be.rows.length;Qe++)Ke.push(Be.rows.item(Qe).name);xe({db:me,storeNames:Ke})},function(Re,Be){Ie(Be)})},function(Pe){Ie(Pe)})})}function Xr(me,xe){xe=y.apply(this,arguments);var Ie=this.config();me=typeof me!="function"&&me||{},me.name||(me.name=me.name||Ie.name,me.storeName=me.storeName||Ie.storeName);var Pe=this,Re;return me.name?Re=new d(function(Be){var Ke;me.name===Ie.name?Ke=Pe._dbInfo.db:Ke=openDatabase(me.name,"","",0),me.storeName?Be({db:Ke,storeNames:[me.storeName]}):Be(Jr(Ke))}).then(function(Be){return new d(function(Ke,Qe){Be.db.transaction(function(Ye){function ze(Tt){return new d(function(Ct,Rt){Ye.executeSql("DROP TABLE IF EXISTS "+Tt,[],function(){Ct()},function(It,Vt){Rt(Vt)})})}for(var Ve=[],ht=0,_t=Be.storeNames.length;ht<_t;ht++)Ve.push(ze(Be.storeNames[ht]));d.all(Ve).then(function(){Ke()}).catch(function(Tt){Qe(Tt)})},function(Ye){Qe(Ye)})})}):Re=d.reject("Invalid arguments"),f(Re,xe),Re}var Ut={_driver:"webSQLStorage",_initStorage:dr,_support:pe(),iterate:Wr,getItem:ir,setItem:fr,removeItem:pr,clear:Qt,length:Nr,key:Ar,keys:jt,dropInstance:Xr};function Zr(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Dr(me,xe){var Ie=me.name+"/";return me.storeName!==xe.storeName&&(Ie+=me.storeName+"/"),Ie}function Yt(){var me="_localforage_support_test";try{return localStorage.setItem(me,!0),localStorage.removeItem(me),!1}catch{return!0}}function _r(){return!Yt()||localStorage.length>0}function en(me){var xe=this,Ie={};if(me)for(var Pe in me)Ie[Pe]=me[Pe];return Ie.keyPrefix=Dr(me,xe._defaultConfig),_r()?(xe._dbInfo=Ie,Ie.serializer=it,d.resolve()):d.reject()}function Gt(me){var xe=this,Ie=xe.ready().then(function(){for(var Pe=xe._dbInfo.keyPrefix,Re=localStorage.length-1;Re>=0;Re--){var Be=localStorage.key(Re);Be.indexOf(Pe)===0&&localStorage.removeItem(Be)}});return f(Ie,me),Ie}function tn(me,xe){var Ie=this;me=p(me);var Pe=Ie.ready().then(function(){var Re=Ie._dbInfo,Be=localStorage.getItem(Re.keyPrefix+me);return Be&&(Be=Re.serializer.deserialize(Be)),Be});return f(Pe,xe),Pe}function rn(me,xe){var Ie=this,Pe=Ie.ready().then(function(){for(var Re=Ie._dbInfo,Be=Re.keyPrefix,Ke=Be.length,Qe=localStorage.length,Ye=1,ze=0;ze<Qe;ze++){var Ve=localStorage.key(ze);if(Ve.indexOf(Be)===0){var ht=localStorage.getItem(Ve);if(ht&&(ht=Re.serializer.deserialize(ht)),ht=me(ht,Ve.substring(Ke),Ye++),ht!==void 0)return ht}}});return f(Pe,xe),Pe}function rr(me,xe){var Ie=this,Pe=Ie.ready().then(function(){var Re=Ie._dbInfo,Be;try{Be=localStorage.key(me)}catch{Be=null}return Be&&(Be=Be.substring(Re.keyPrefix.length)),Be});return f(Pe,xe),Pe}function sr(me){var xe=this,Ie=xe.ready().then(function(){for(var Pe=xe._dbInfo,Re=localStorage.length,Be=[],Ke=0;Ke<Re;Ke++){var Qe=localStorage.key(Ke);Qe.indexOf(Pe.keyPrefix)===0&&Be.push(Qe.substring(Pe.keyPrefix.length))}return Be});return f(Ie,me),Ie}function nn(me){var xe=this,Ie=xe.keys().then(function(Pe){return Pe.length});return f(Ie,me),Ie}function gr(me,xe){var Ie=this;me=p(me);var Pe=Ie.ready().then(function(){var Re=Ie._dbInfo;localStorage.removeItem(Re.keyPrefix+me)});return f(Pe,xe),Pe}function sn(me,xe,Ie){var Pe=this;me=p(me);var Re=Pe.ready().then(function(){xe===void 0&&(xe=null);var Be=xe;return new d(function(Ke,Qe){var Ye=Pe._dbInfo;Ye.serializer.serialize(xe,function(ze,Ve){if(Ve)Qe(Ve);else try{localStorage.setItem(Ye.keyPrefix+me,ze),Ke(Be)}catch(ht){(ht.name==="QuotaExceededError"||ht.name==="NS_ERROR_DOM_QUOTA_REACHED")&&Qe(ht),Qe(ht)}})})});return f(Re,Ie),Re}function an(me,xe){if(xe=y.apply(this,arguments),me=typeof me!="function"&&me||{},!me.name){var Ie=this.config();me.name=me.name||Ie.name,me.storeName=me.storeName||Ie.storeName}var Pe=this,Re;return me.name?Re=new d(function(Be){me.storeName?Be(Dr(me,Pe._defaultConfig)):Be(me.name+"/")}).then(function(Be){for(var Ke=localStorage.length-1;Ke>=0;Ke--){var Qe=localStorage.key(Ke);Qe.indexOf(Be)===0&&localStorage.removeItem(Qe)}}):Re=d.reject("Invalid arguments"),f(Re,xe),Re}var Ht={_driver:"localStorageWrapper",_initStorage:en,_support:Zr(),iterate:rn,getItem:tn,setItem:sn,removeItem:gr,clear:Gt,length:nn,key:rr,keys:sr,dropInstance:an},nr=function(me,xe){return me===xe||typeof me=="number"&&typeof xe=="number"&&isNaN(me)&&isNaN(xe)},cn=function(me,xe){for(var Ie=me.length,Pe=0;Pe<Ie;){if(nr(me[Pe],xe))return!0;Pe++}return!1},lr=Array.isArray||function(me){return Object.prototype.toString.call(me)==="[object Array]"},ar={},qr={},Wt={INDEXEDDB:ue,WEBSQL:Ut,LOCALSTORAGE:Ht},Jt=[Wt.INDEXEDDB._driver,Wt.WEBSQL._driver,Wt.LOCALSTORAGE._driver],xr=["dropInstance"],wr=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(xr),hr={description:"",driver:Jt.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function $r(me,xe){me[xe]=function(){var Ie=arguments;return me.ready().then(function(){return me[xe].apply(me,Ie)})}}function Pr(){for(var me=1;me<arguments.length;me++){var xe=arguments[me];if(xe)for(var Ie in xe)xe.hasOwnProperty(Ie)&&(lr(xe[Ie])?arguments[0][Ie]=xe[Ie].slice():arguments[0][Ie]=xe[Ie])}return arguments[0]}var Hr=function(){function me(xe){a(this,me);for(var Ie in Wt)if(Wt.hasOwnProperty(Ie)){var Pe=Wt[Ie],Re=Pe._driver;this[Ie]=Re,ar[Re]||this.defineDriver(Pe)}this._defaultConfig=Pr({},hr),this._config=Pr({},this._defaultConfig,xe),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return me.prototype.config=function(xe){if((typeof xe>"u"?"undefined":s(xe))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var Ie in xe){if(Ie==="storeName"&&(xe[Ie]=xe[Ie].replace(/\W/g,"_")),Ie==="version"&&typeof xe[Ie]!="number")return new Error("Database version must be a number.");this._config[Ie]=xe[Ie]}return"driver"in xe&&xe.driver?this.setDriver(this._config.driver):!0}else return typeof xe=="string"?this._config[xe]:this._config},me.prototype.defineDriver=function(xe,Ie,Pe){var Re=new d(function(Be,Ke){try{var Qe=xe._driver,Ye=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!xe._driver){Ke(Ye);return}for(var ze=wr.concat("_initStorage"),Ve=0,ht=ze.length;Ve<ht;Ve++){var _t=ze[Ve],Tt=!cn(xr,_t);if((Tt||xe[_t])&&typeof xe[_t]!="function"){Ke(Ye);return}}var Ct=function(){for(var It=function(br){return function(){var Tr=new Error("Method "+br+" is not implemented by the current driver"),$e=d.reject(Tr);return f($e,arguments[arguments.length-1]),$e}},Vt=0,mr=xr.length;Vt<mr;Vt++){var zt=xr[Vt];xe[zt]||(xe[zt]=It(zt))}};Ct();var Rt=function(It){ar[Qe]&&console.info("Redefining LocalForage driver: "+Qe),ar[Qe]=xe,qr[Qe]=It,Be()};"_support"in xe?xe._support&&typeof xe._support=="function"?xe._support().then(Rt,Ke):Rt(!!xe._support):Rt(!0)}catch(It){Ke(It)}});return _(Re,Ie,Pe),Re},me.prototype.driver=function(){return this._driver||null},me.prototype.getDriver=function(xe,Ie,Pe){var Re=ar[xe]?d.resolve(ar[xe]):d.reject(new Error("Driver not found."));return _(Re,Ie,Pe),Re},me.prototype.getSerializer=function(xe){var Ie=d.resolve(it);return _(Ie,xe),Ie},me.prototype.ready=function(xe){var Ie=this,Pe=Ie._driverSet.then(function(){return Ie._ready===null&&(Ie._ready=Ie._initDriver()),Ie._ready});return _(Pe,xe,xe),Pe},me.prototype.setDriver=function(xe,Ie,Pe){var Re=this;lr(xe)||(xe=[xe]);var Be=this._getSupportedDrivers(xe);function Ke(){Re._config.driver=Re.driver()}function Qe(Ve){return Re._extend(Ve),Ke(),Re._ready=Re._initStorage(Re._config),Re._ready}function Ye(Ve){return function(){var ht=0;function _t(){for(;ht<Ve.length;){var Tt=Ve[ht];return ht++,Re._dbInfo=null,Re._ready=null,Re.getDriver(Tt).then(Qe).catch(_t)}Ke();var Ct=new Error("No available storage method found.");return Re._driverSet=d.reject(Ct),Re._driverSet}return _t()}}var ze=this._driverSet!==null?this._driverSet.catch(function(){return d.resolve()}):d.resolve();return this._driverSet=ze.then(function(){var Ve=Be[0];return Re._dbInfo=null,Re._ready=null,Re.getDriver(Ve).then(function(ht){Re._driver=ht._driver,Ke(),Re._wrapLibraryMethodsWithReady(),Re._initDriver=Ye(Be)})}).catch(function(){Ke();var Ve=new Error("No available storage method found.");return Re._driverSet=d.reject(Ve),Re._driverSet}),_(this._driverSet,Ie,Pe),this._driverSet},me.prototype.supports=function(xe){return!!qr[xe]},me.prototype._extend=function(xe){Pr(this,xe)},me.prototype._getSupportedDrivers=function(xe){for(var Ie=[],Pe=0,Re=xe.length;Pe<Re;Pe++){var Be=xe[Pe];this.supports(Be)&&Ie.push(Be)}return Ie},me.prototype._wrapLibraryMethodsWithReady=function(){for(var xe=0,Ie=wr.length;xe<Ie;xe++)$r(this,wr[xe])},me.prototype.createInstance=function(xe){return new me(xe)},me}(),Qr=new Hr;n.exports=Qr},{3:3}]},{},[4])(4)})})(localforage);var localforageExports=localforage.exports;const localforage2=getDefaultExportFromCjs(localforageExports);function _ts_decorate$5(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let configRootType,validateConfig,ConfigResource;configRootType=schema.getCodecForType("dxos.config.Config"),validateConfig=e=>{if(!("version"in e))throw new InvalidConfigError("Version not specified");if((e==null?void 0:e.version)!==1)throw new InvalidConfigError(`Invalid config version: ${e.version}`);const t=configRootType.protoType.verify(e);if(t)throw new InvalidConfigError(t);return e},ConfigResource=Symbol.for("dxos.resource.Config"),Config=class{constructor(e={},...t){this._config=validateConfig(defaultsDeep(e,...t,{version:1}))}get values(){return this._config}get(e,t){return get$1(this._config,e,t)}find(e,t){const r=get$1(this._config,e);if(Array.isArray(r))return r.find(n=>isMatch(n,t))}getUnchecked(e,t){return get$1(this._config,e,t)}getOrThrow(e){const t=get$1(this._config,e);if(!t)throw new Error(`Config option not present: ${e}`);return t}},Config=_ts_decorate$5([trace.resource({annotation:ConfigResource})],Config);var PERFORMING_CONFIG_SAVE=!1,SaveConfig=async e=>{if(PERFORMING_CONFIG_SAVE){log.warn("Already performing config save");return}PERFORMING_CONFIG_SAVE=!0;try{await localforage2.setItem("dxos.org/settings/config",e)}catch(t){return log.warn("Failed to save config",{err:t}),{}}finally{PERFORMING_CONFIG_SAVE=!1}},__dxlog_file$6="/home/runner/work/dxos/dxos/packages/core/mesh/websocket-rpc/src/token-auth.ts",WebSocketWithTokenAuth=class extends WebSocket3{constructor(e,t){const r=export_Buffer.from(t).toString("base64").replace(/=*$/,""),n=[`base64url.bearer.authorization.dxos.org.${r}`];super(e,n),log("encodedToken",{encodedToken:r},{F:__dxlog_file$6,L:55,S:this,C:(o,s)=>o(...s)})}};function _ts_decorate$4(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file2$3;__dxlog_file2$3="/home/runner/work/dxos/dxos/packages/core/mesh/websocket-rpc/src/client.ts",WebsocketRpcClient=class{constructor(e){this._params=e,this._connectTrigger=new Trigger,this.connected=new Event$1,this.disconnected=new Event$1,this.error=new Event$1,this._rpc=createProtoRpcPeer({requested:this._params.requested,exposed:this._params.exposed,handlers:this._params.handlers,noHandshake:this._params.noHandshake,port:{send:t=>{this._socket.send(t)},subscribe:t=>{this._socket.onmessage=async r=>{typeof Blob<"u"&&r.data instanceof Blob?t(export_Buffer.from(await r.data.arrayBuffer())):t(r.data)}}}})}get url(){return this._params.url}async open(){this._params.authenticationToken?this._socket=new WebSocketWithTokenAuth(this._params.url,this._params.authenticationToken):this._socket=new WebSocket3(this._params.url),this._socket.onopen=async()=>{log("Socket open",void 0,{F:__dxlog_file2$3,L:62,S:this,C:(e,t)=>e(...t)});try{await this._rpc.open(),log(`RPC open ${this._params.url}`,void 0,{F:__dxlog_file2$3,L:65,S:this,C:(e,t)=>e(...t)}),this.connected.emit(),this._connectTrigger.wake()}catch(e){this.error.emit(e)}},this._socket.onclose=async()=>{log(`Disconnected ${this._params.url}`,void 0,{F:__dxlog_file2$3,L:74,S:this,C:(e,t)=>e(...t)}),this.disconnected.emit(),await this.close()},this._socket.onerror=e=>{log.error(e.message??"Socket error",{url:this._params.url},{F:__dxlog_file2$3,L:81,S:this,C:(r,n)=>r(...n)});const t=e.error??new Error(e.message);this.error.emit(t),this._connectTrigger.throw(t)},await this._connectTrigger.wait()}async close(){var e,t;try{await((e=this._rpc)==null?void 0:e.close())}catch(r){log.catch(r,void 0,{F:__dxlog_file2$3,L:94,S:this,C:(n,o)=>n(...o)})}(t=this._socket)==null||t.close()}get rpc(){return this._rpc.rpc}},_ts_decorate$4([logInfo],WebsocketRpcClient.prototype,"url",null),index$1=Object.freeze(Object.defineProperty({__proto__:null,WebSocketWithTokenAuth,WebsocketRpcClient},Symbol.toStringTag,{value:"Module"}));var browserLevel={},abstractLevel$1={},abstractLevel={},levelSupports={};levelSupports.supports=function e(...t){const r=t.reduce((n,o)=>Object.assign(n,o),{});return Object.assign(r,{snapshots:r.snapshots||!1,permanence:r.permanence||!1,seek:r.seek||!1,clear:r.clear||!1,getMany:r.getMany||!1,keyIterator:r.keyIterator||!1,valueIterator:r.valueIterator||!1,iteratorNextv:r.iteratorNextv||!1,iteratorAll:r.iteratorAll||!1,status:r.status||!1,createIfMissing:r.createIfMissing||!1,errorIfExists:r.errorIfExists||!1,deferredOpen:r.deferredOpen||!1,promises:r.promises||!1,streams:r.streams||!1,encodings:Object.assign({},r.encodings),events:Object.assign({},r.events),additionalMethods:Object.assign({},r.additionalMethods)})};var levelTranscoder={},moduleError=class extends Error{constructor(e,t){super(e||""),typeof t=="object"&&t!==null&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},encodings$1={};let lazy=null;var textEndec$1=function(){return lazy===null&&(lazy={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),lazy},formats$2={},encoding={};const ModuleError$8=moduleError,formats$1=new Set(["buffer","view","utf8"]);let Encoding$2=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!formats$1.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new ModuleError$8(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new ModuleError$8(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new ModuleError$8(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}};encoding.Encoding=Encoding$2;const{Buffer:Buffer$2}=buffer||{},{Encoding:Encoding$1}=encoding,textEndec=textEndec$1;let BufferFormat$2=class extends Encoding$1{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new ViewFormat$2({encode:this.encode,decode:e=>this.decode(Buffer$2.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}},ViewFormat$2=class extends Encoding$1{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new BufferFormat$2({encode:e=>{const t=this.encode(e);return Buffer$2.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}},UTF8Format$2=class extends Encoding$1{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new BufferFormat$2({encode:e=>Buffer$2.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=textEndec();return new ViewFormat$2({encode:r=>e.encode(this.encode(r)),decode:r=>this.decode(t.decode(r)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}};formats$2.BufferFormat=BufferFormat$2,formats$2.ViewFormat=ViewFormat$2,formats$2.UTF8Format=UTF8Format$2;const{Buffer:Buffer$1}=buffer||{Buffer:{isBuffer:()=>!1}},{textEncoder:textEncoder$1,textDecoder}=textEndec$1(),{BufferFormat:BufferFormat$1,ViewFormat:ViewFormat$1,UTF8Format:UTF8Format$1}=formats$2,identity=e=>e;encodings$1.utf8=new UTF8Format$1({encode:function(e){return Buffer$1.isBuffer(e)?e.toString("utf8"):ArrayBuffer.isView(e)?textDecoder.decode(e):String(e)},decode:identity,name:"utf8",createViewTranscoder(){return new ViewFormat$1({encode:function(e){return ArrayBuffer.isView(e)?e:textEncoder$1.encode(e)},decode:function(e){return textDecoder.decode(e)},name:`${this.name}+view`})},createBufferTranscoder(){return new BufferFormat$1({encode:function(e){return Buffer$1.isBuffer(e)?e:ArrayBuffer.isView(e)?Buffer$1.from(e.buffer,e.byteOffset,e.byteLength):Buffer$1.from(String(e),"utf8")},decode:function(e){return e.toString("utf8")},name:`${this.name}+buffer`})}}),encodings$1.json=new UTF8Format$1({encode:JSON.stringify,decode:JSON.parse,name:"json"}),encodings$1.buffer=new BufferFormat$1({encode:function(e){return Buffer$1.isBuffer(e)?e:ArrayBuffer.isView(e)?Buffer$1.from(e.buffer,e.byteOffset,e.byteLength):Buffer$1.from(String(e),"utf8")},decode:identity,name:"buffer",createViewTranscoder(){return new ViewFormat$1({encode:function(e){return ArrayBuffer.isView(e)?e:Buffer$1.from(String(e),"utf8")},decode:function(e){return Buffer$1.from(e.buffer,e.byteOffset,e.byteLength)},name:`${this.name}+view`})}}),encodings$1.view=new ViewFormat$1({encode:function(e){return ArrayBuffer.isView(e)?e:textEncoder$1.encode(e)},decode:identity,name:"view",createBufferTranscoder(){return new BufferFormat$1({encode:function(e){return Buffer$1.isBuffer(e)?e:ArrayBuffer.isView(e)?Buffer$1.from(e.buffer,e.byteOffset,e.byteLength):Buffer$1.from(String(e),"utf8")},decode:identity,name:`${this.name}+buffer`})}}),encodings$1.hex=new BufferFormat$1({encode:function(e){return Buffer$1.isBuffer(e)?e:Buffer$1.from(String(e),"hex")},decode:function(e){return e.toString("hex")},name:"hex"}),encodings$1.base64=new BufferFormat$1({encode:function(e){return Buffer$1.isBuffer(e)?e:Buffer$1.from(String(e),"base64")},decode:function(e){return e.toString("base64")},name:"base64"});const ModuleError$7=moduleError,encodings=encodings$1,{Encoding}=encoding,{BufferFormat,ViewFormat,UTF8Format}=formats$2,kFormats=Symbol("formats"),kEncodings=Symbol("encodings"),validFormats=new Set(["buffer","view","utf8"]);let Transcoder$1=class{constructor(e){if(Array.isArray(e)){if(!e.every(t=>validFormats.has(t)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[kEncodings]=new Map,this[kFormats]=new Set(e);for(const t in encodings)try{this.encoding(t)}catch(r){if(r.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw r}}encodings(){return Array.from(new Set(this[kEncodings].values()))}encoding(e){let t=this[kEncodings].get(e);if(t===void 0){if(typeof e=="string"&&e!==""){if(t=lookup[e],!t)throw new ModuleError$7(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof e!="object"||e===null)throw new TypeError("First argument 'encoding' must be a string or object");t=from(e)}const{name:r,format:n}=t;if(!this[kFormats].has(n))if(this[kFormats].has("view"))t=t.createViewTranscoder();else if(this[kFormats].has("buffer"))t=t.createBufferTranscoder();else if(this[kFormats].has("utf8"))t=t.createUTF8Transcoder();else throw new ModuleError$7(`Encoding '${r}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const o of[e,r,t.name,t.commonName])this[kEncodings].set(o,t)}return t}};levelTranscoder.Transcoder=Transcoder$1;function from(e){if(e instanceof Encoding)return e;const t="type"in e&&typeof e.type=="string"?e.type:void 0,r=e.name||t||`anonymous-${anonymousCount++}`;switch(detectFormat(e)){case"view":return new ViewFormat({...e,name:r});case"utf8":return new UTF8Format({...e,name:r});case"buffer":return new BufferFormat({...e,name:r});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function detectFormat(e){return"format"in e&&e.format!==void 0?e.format:"buffer"in e&&typeof e.buffer=="boolean"?e.buffer?"buffer":"utf8":"code"in e&&Number.isInteger(e.code)?"view":"buffer"}const aliases={binary:encodings.buffer,"utf-8":encodings.utf8},lookup={...encodings,...aliases};let anonymousCount=0;var catering={},nextTickBrowser$1=typeof queueMicrotask=="function"?queueMicrotask:e=>Promise.resolve().then(e),nextTick=nextTickBrowser$1;catering.fromCallback=function(e,t){if(e===void 0){var r=new Promise(function(n,o){e=function(s,a){s?o(s):n(a)}});e[t!==void 0?t:"promise"]=r}else if(typeof e!="function")throw new TypeError("Callback must be a function");return e},catering.fromPromise=function(e,t){if(t===void 0)return e;e.then(function(r){nextTick(()=>t(null,r))}).catch(function(r){nextTick(()=>t(r))})};var abstractIterator={},common={};common.getCallback=function(e,t){return typeof e=="function"?e:t},common.getOptions=function(e,t){return typeof e=="object"&&e!==null?e:t!==void 0?t:{}};const{fromCallback:fromCallback$3}=catering,ModuleError$6=moduleError,{getOptions:getOptions$2,getCallback:getCallback$2}=common,kPromise$3=Symbol("promise"),kCallback$1=Symbol("callback"),kWorking=Symbol("working"),kHandleOne$1=Symbol("handleOne"),kHandleMany$1=Symbol("handleMany"),kAutoClose=Symbol("autoClose"),kFinishWork=Symbol("finishWork"),kReturnMany=Symbol("returnMany"),kClosing=Symbol("closing"),kHandleClose=Symbol("handleClose"),kClosed=Symbol("closed"),kCloseCallbacks$1=Symbol("closeCallbacks"),kKeyEncoding$1=Symbol("keyEncoding"),kValueEncoding$1=Symbol("valueEncoding"),kAbortOnClose=Symbol("abortOnClose"),kLegacy=Symbol("legacy"),kKeys=Symbol("keys"),kValues=Symbol("values"),kLimit=Symbol("limit"),kCount=Symbol("count"),emptyOptions$1=Object.freeze({}),noop$1=()=>{};let warnedEnd=!1;class CommonIterator{constructor(t,r,n){if(typeof t!="object"||t===null){const o=t===null?"null":typeof t;throw new TypeError(`The first argument must be an abstract-level database, received ${o}`)}if(typeof r!="object"||r===null)throw new TypeError("The second argument must be an options object");this[kClosed]=!1,this[kCloseCallbacks$1]=[],this[kWorking]=!1,this[kClosing]=!1,this[kAutoClose]=!1,this[kCallback$1]=null,this[kHandleOne$1]=this[kHandleOne$1].bind(this),this[kHandleMany$1]=this[kHandleMany$1].bind(this),this[kHandleClose]=this[kHandleClose].bind(this),this[kKeyEncoding$1]=r[kKeyEncoding$1],this[kValueEncoding$1]=r[kValueEncoding$1],this[kLegacy]=n,this[kLimit]=Number.isInteger(r.limit)&&r.limit>=0?r.limit:1/0,this[kCount]=0,this[kAbortOnClose]=!!r.abortOnClose,this.db=t,this.db.attachResource(this),this.nextTick=t.nextTick}get count(){return this[kCount]}get limit(){return this[kLimit]}next(t){let r;if(t===void 0)r=new Promise((n,o)=>{t=(s,a,c)=>{s?o(s):this[kLegacy]?a===void 0&&c===void 0?n():n([a,c]):n(a)}});else if(typeof t!="function")throw new TypeError("Callback must be a function");return this[kClosing]?this.nextTick(t,new ModuleError$6("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[kWorking]?this.nextTick(t,new ModuleError$6("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[kWorking]=!0,this[kCallback$1]=t,this[kCount]>=this[kLimit]?this.nextTick(this[kHandleOne$1],null):this._next(this[kHandleOne$1])),r}_next(t){this.nextTick(t)}nextv(t,r,n){return n=getCallback$2(r,n),n=fromCallback$3(n,kPromise$3),r=getOptions$2(r,emptyOptions$1),Number.isInteger(t)?(this[kClosing]?this.nextTick(n,new ModuleError$6("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[kWorking]?this.nextTick(n,new ModuleError$6("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(t<1&&(t=1),this[kLimit]<1/0&&(t=Math.min(t,this[kLimit]-this[kCount])),this[kWorking]=!0,this[kCallback$1]=n,t<=0?this.nextTick(this[kHandleMany$1],null,[]):this._nextv(t,r,this[kHandleMany$1])),n[kPromise$3]):(this.nextTick(n,new TypeError("The first argument 'size' must be an integer")),n[kPromise$3])}_nextv(t,r,n){const o=[],s=(a,c,l)=>{if(a)return n(a);if(this[kLegacy]?c===void 0&&l===void 0:c===void 0)return n(null,o);o.push(this[kLegacy]?[c,l]:c),o.length===t?n(null,o):this._next(s)};this._next(s)}all(t,r){return r=getCallback$2(t,r),r=fromCallback$3(r,kPromise$3),t=getOptions$2(t,emptyOptions$1),this[kClosing]?this.nextTick(r,new ModuleError$6("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[kWorking]?this.nextTick(r,new ModuleError$6("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[kWorking]=!0,this[kCallback$1]=r,this[kAutoClose]=!0,this[kCount]>=this[kLimit]?this.nextTick(this[kHandleMany$1],null,[]):this._all(t,this[kHandleMany$1])),r[kPromise$3]}_all(t,r){let n=this[kCount];const o=[],s=()=>{const c=this[kLimit]<1/0?Math.min(1e3,this[kLimit]-n):1e3;c<=0?this.nextTick(r,null,o):this._nextv(c,emptyOptions$1,a)},a=(c,l)=>{c?r(c):l.length===0?r(null,o):(o.push.apply(o,l),n+=l.length,s())};s()}[kFinishWork](){const t=this[kCallback$1];return this[kAbortOnClose]&&t===null?noop$1:(this[kWorking]=!1,this[kCallback$1]=null,this[kClosing]&&this._close(this[kHandleClose]),t)}[kReturnMany](t,r,n){this[kAutoClose]?this.close(t.bind(null,r,n)):t(r,n)}seek(t,r){if(r=getOptions$2(r,emptyOptions$1),!this[kClosing]){if(this[kWorking])throw new ModuleError$6("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const n=this.db.keyEncoding(r.keyEncoding||this[kKeyEncoding$1]),o=n.format;r.keyEncoding!==o&&(r={...r,keyEncoding:o});const s=this.db.prefixKey(n.encode(t),o);this._seek(s,r)}}}_seek(t,r){throw new ModuleError$6("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(t){return t=fromCallback$3(t,kPromise$3),this[kClosed]?this.nextTick(t):this[kClosing]?this[kCloseCallbacks$1].push(t):(this[kClosing]=!0,this[kCloseCallbacks$1].push(t),this[kWorking]?this[kAbortOnClose]&&this[kFinishWork]()(new ModuleError$6("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[kHandleClose])),t[kPromise$3]}_close(t){this.nextTick(t)}[kHandleClose](){this[kClosed]=!0,this.db.detachResource(this);const t=this[kCloseCallbacks$1];this[kCloseCallbacks$1]=[];for(const r of t)r()}async*[Symbol.asyncIterator](){try{let t;for(;(t=await this.next())!==void 0;)yield t}finally{this[kClosed]||await this.close()}}}let AbstractIterator$3=class extends CommonIterator{constructor(e,t){super(e,t,!0),this[kKeys]=t.keys!==!1,this[kValues]=t.values!==!1}[kHandleOne$1](e,t,r){const n=this[kFinishWork]();if(e)return n(e);try{t=this[kKeys]&&t!==void 0?this[kKeyEncoding$1].decode(t):void 0,r=this[kValues]&&r!==void 0?this[kValueEncoding$1].decode(r):void 0}catch(o){return n(new IteratorDecodeError("entry",o))}t===void 0&&r===void 0||this[kCount]++,n(null,t,r)}[kHandleMany$1](e,t){const r=this[kFinishWork]();if(e)return this[kReturnMany](r,e);try{for(const n of t){const o=n[0],s=n[1];n[0]=this[kKeys]&&o!==void 0?this[kKeyEncoding$1].decode(o):void 0,n[1]=this[kValues]&&s!==void 0?this[kValueEncoding$1].decode(s):void 0}}catch(n){return this[kReturnMany](r,new IteratorDecodeError("entries",n))}this[kCount]+=t.length,this[kReturnMany](r,null,t)}end(e){return!warnedEnd&&typeof console<"u"&&(warnedEnd=!0,console.warn(new ModuleError$6("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}},AbstractKeyIterator$2=class extends CommonIterator{constructor(e,t){super(e,t,!1)}[kHandleOne$1](e,t){const r=this[kFinishWork]();if(e)return r(e);try{t=t!==void 0?this[kKeyEncoding$1].decode(t):void 0}catch(n){return r(new IteratorDecodeError("key",n))}t!==void 0&&this[kCount]++,r(null,t)}[kHandleMany$1](e,t){const r=this[kFinishWork]();if(e)return this[kReturnMany](r,e);try{for(let n=0;n<t.length;n++){const o=t[n];t[n]=o!==void 0?this[kKeyEncoding$1].decode(o):void 0}}catch(n){return this[kReturnMany](r,new IteratorDecodeError("keys",n))}this[kCount]+=t.length,this[kReturnMany](r,null,t)}},AbstractValueIterator$2=class extends CommonIterator{constructor(e,t){super(e,t,!1)}[kHandleOne$1](e,t){const r=this[kFinishWork]();if(e)return r(e);try{t=t!==void 0?this[kValueEncoding$1].decode(t):void 0}catch(n){return r(new IteratorDecodeError("value",n))}t!==void 0&&this[kCount]++,r(null,t)}[kHandleMany$1](e,t){const r=this[kFinishWork]();if(e)return this[kReturnMany](r,e);try{for(let n=0;n<t.length;n++){const o=t[n];t[n]=o!==void 0?this[kValueEncoding$1].decode(o):void 0}}catch(n){return this[kReturnMany](r,new IteratorDecodeError("values",n))}this[kCount]+=t.length,this[kReturnMany](r,null,t)}};class IteratorDecodeError extends ModuleError$6{constructor(t,r){super(`Iterator could not decode ${t}`,{code:"LEVEL_DECODE_ERROR",cause:r})}}for(const e of["_ended property","_nexting property","_end method"])Object.defineProperty(AbstractIterator$3.prototype,e.split(" ")[0],{get(){throw new ModuleError$6(`The ${e} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new ModuleError$6(`The ${e} has been removed`,{code:"LEVEL_LEGACY"})}});AbstractIterator$3.keyEncoding=kKeyEncoding$1,AbstractIterator$3.valueEncoding=kValueEncoding$1,abstractIterator.AbstractIterator=AbstractIterator$3,abstractIterator.AbstractKeyIterator=AbstractKeyIterator$2,abstractIterator.AbstractValueIterator=AbstractValueIterator$2;var defaultKvIterator={};const{AbstractKeyIterator:AbstractKeyIterator$1,AbstractValueIterator:AbstractValueIterator$1}=abstractIterator,kIterator=Symbol("iterator"),kCallback=Symbol("callback"),kHandleOne=Symbol("handleOne"),kHandleMany=Symbol("handleMany");let DefaultKeyIterator$1=class extends AbstractKeyIterator$1{constructor(e,t){super(e,t),this[kIterator]=e.iterator({...t,keys:!0,values:!1}),this[kHandleOne]=this[kHandleOne].bind(this),this[kHandleMany]=this[kHandleMany].bind(this)}},DefaultValueIterator$1=class extends AbstractValueIterator$1{constructor(e,t){super(e,t),this[kIterator]=e.iterator({...t,keys:!1,values:!0}),this[kHandleOne]=this[kHandleOne].bind(this),this[kHandleMany]=this[kHandleMany].bind(this)}};for(const e of[DefaultKeyIterator$1,DefaultValueIterator$1]){const t=e===DefaultKeyIterator$1,r=t?n=>n[0]:n=>n[1];e.prototype._next=function(n){this[kCallback]=n,this[kIterator].next(this[kHandleOne])},e.prototype[kHandleOne]=function(n,o,s){const a=this[kCallback];n?a(n):a(null,t?o:s)},e.prototype._nextv=function(n,o,s){this[kCallback]=s,this[kIterator].nextv(n,o,this[kHandleMany])},e.prototype._all=function(n,o){this[kCallback]=o,this[kIterator].all(n,this[kHandleMany])},e.prototype[kHandleMany]=function(n,o){const s=this[kCallback];n?s(n):s(null,o.map(r))},e.prototype._seek=function(n,o){this[kIterator].seek(n,o)},e.prototype._close=function(n){this[kIterator].close(n)}}defaultKvIterator.DefaultKeyIterator=DefaultKeyIterator$1,defaultKvIterator.DefaultValueIterator=DefaultValueIterator$1;var deferredIterator={};const{AbstractIterator:AbstractIterator$2,AbstractKeyIterator,AbstractValueIterator}=abstractIterator,ModuleError$5=moduleError,kNut=Symbol("nut"),kUndefer$1=Symbol("undefer"),kFactory=Symbol("factory");let DeferredIterator$1=class extends AbstractIterator$2{constructor(e,t){super(e,t),this[kNut]=null,this[kFactory]=()=>e.iterator(t),this.db.defer(()=>this[kUndefer$1]())}},DeferredKeyIterator$1=class extends AbstractKeyIterator{constructor(e,t){super(e,t),this[kNut]=null,this[kFactory]=()=>e.keys(t),this.db.defer(()=>this[kUndefer$1]())}},DeferredValueIterator$1=class extends AbstractValueIterator{constructor(e,t){super(e,t),this[kNut]=null,this[kFactory]=()=>e.values(t),this.db.defer(()=>this[kUndefer$1]())}};for(const e of[DeferredIterator$1,DeferredKeyIterator$1,DeferredValueIterator$1])e.prototype[kUndefer$1]=function(){this.db.status==="open"&&(this[kNut]=this[kFactory]())},e.prototype._next=function(t){this[kNut]!==null?this[kNut].next(t):this.db.status==="opening"?this.db.defer(()=>this._next(t)):this.nextTick(t,new ModuleError$5("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._nextv=function(t,r,n){this[kNut]!==null?this[kNut].nextv(t,r,n):this.db.status==="opening"?this.db.defer(()=>this._nextv(t,r,n)):this.nextTick(n,new ModuleError$5("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._all=function(t,r){this[kNut]!==null?this[kNut].all(r):this.db.status==="opening"?this.db.defer(()=>this._all(t,r)):this.nextTick(r,new ModuleError$5("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},e.prototype._seek=function(t,r){this[kNut]!==null?this[kNut]._seek(t,r):this.db.status==="opening"&&this.db.defer(()=>this._seek(t,r))},e.prototype._close=function(t){this[kNut]!==null?this[kNut].close(t):this.db.status==="opening"?this.db.defer(()=>this._close(t)):this.nextTick(t)};deferredIterator.DeferredIterator=DeferredIterator$1,deferredIterator.DeferredKeyIterator=DeferredKeyIterator$1,deferredIterator.DeferredValueIterator=DeferredValueIterator$1;var defaultChainedBatch={},abstractChainedBatch={};const{fromCallback:fromCallback$2}=catering,ModuleError$4=moduleError,{getCallback:getCallback$1,getOptions:getOptions$1}=common,kPromise$2=Symbol("promise"),kStatus$1=Symbol("status"),kOperations$1=Symbol("operations"),kFinishClose=Symbol("finishClose"),kCloseCallbacks=Symbol("closeCallbacks");let AbstractChainedBatch$1=class{constructor(e){if(typeof e!="object"||e===null){const t=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${t}`)}this[kOperations$1]=[],this[kCloseCallbacks]=[],this[kStatus$1]="open",this[kFinishClose]=this[kFinishClose].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[kOperations$1].length}put(e,t,r){if(this[kStatus$1]!=="open")throw new ModuleError$4("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e)||this.db._checkValue(t);if(n)throw n;const o=r&&r.sublevel!=null?r.sublevel:this.db,s=r,a=o.keyEncoding(r&&r.keyEncoding),c=o.valueEncoding(r&&r.valueEncoding),l=a.format;r={...r,keyEncoding:l,valueEncoding:c.format},o!==this.db&&(r.sublevel=null);const h=o.prefixKey(a.encode(e),l),u=c.encode(t);return this._put(h,u,r),this[kOperations$1].push({...s,type:"put",key:e,value:t}),this}_put(e,t,r){}del(e,t){if(this[kStatus$1]!=="open")throw new ModuleError$4("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const r=this.db._checkKey(e);if(r)throw r;const n=t&&t.sublevel!=null?t.sublevel:this.db,o=t,s=n.keyEncoding(t&&t.keyEncoding),a=s.format;return t={...t,keyEncoding:a},n!==this.db&&(t.sublevel=null),this._del(n.prefixKey(s.encode(e),a),t),this[kOperations$1].push({...o,type:"del",key:e}),this}_del(e,t){}clear(){if(this[kStatus$1]!=="open")throw new ModuleError$4("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[kOperations$1]=[],this}_clear(){}write(e,t){return t=getCallback$1(e,t),t=fromCallback$2(t,kPromise$2),e=getOptions$1(e),this[kStatus$1]!=="open"?this.nextTick(t,new ModuleError$4("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(t):(this[kStatus$1]="writing",this._write(e,r=>{this[kStatus$1]="closing",this[kCloseCallbacks].push(()=>t(r)),r||this.db.emit("batch",this[kOperations$1]),this._close(this[kFinishClose])})),t[kPromise$2]}_write(e,t){}close(e){return e=fromCallback$2(e,kPromise$2),this[kStatus$1]==="closing"?this[kCloseCallbacks].push(e):this[kStatus$1]==="closed"?this.nextTick(e):(this[kCloseCallbacks].push(e),this[kStatus$1]!=="writing"&&(this[kStatus$1]="closing",this._close(this[kFinishClose]))),e[kPromise$2]}_close(e){this.nextTick(e)}[kFinishClose](){this[kStatus$1]="closed",this.db.detachResource(this);const e=this[kCloseCallbacks];this[kCloseCallbacks]=[];for(const t of e)t()}};abstractChainedBatch.AbstractChainedBatch=AbstractChainedBatch$1;const{AbstractChainedBatch}=abstractChainedBatch,ModuleError$3=moduleError,kEncoded=Symbol("encoded");let DefaultChainedBatch$1=class extends AbstractChainedBatch{constructor(e){super(e),this[kEncoded]=[]}_put(e,t,r){this[kEncoded].push({...r,type:"put",key:e,value:t})}_del(e,t){this[kEncoded].push({...t,type:"del",key:e})}_clear(){this[kEncoded]=[]}_write(e,t){this.db.status==="opening"?this.db.defer(()=>this._write(e,t)):this.db.status==="open"?this[kEncoded].length===0?this.nextTick(t):this.db._batch(this[kEncoded],e,t):this.nextTick(t,new ModuleError$3("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}};defaultChainedBatch.DefaultChainedBatch=DefaultChainedBatch$1;const ModuleError$2=moduleError,hasOwnProperty=Object.prototype.hasOwnProperty,rangeOptions$1=new Set(["lt","lte","gt","gte"]);var rangeOptions_1=function(e,t){const r={};for(const n in e)if(hasOwnProperty.call(e,n)&&!(n==="keyEncoding"||n==="valueEncoding")){if(n==="start"||n==="end")throw new ModuleError$2(`The legacy range option '${n}' has been removed`,{code:"LEVEL_LEGACY"});if(n==="encoding")throw new ModuleError$2("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});rangeOptions$1.has(n)?r[n]=t.encode(e[n]):r[n]=e[n]}return r.reverse=!!r.reverse,r.limit=Number.isInteger(r.limit)&&r.limit>=0?r.limit:-1,r},nextTickBrowser,hasRequiredNextTickBrowser;function requireNextTickBrowser(){if(hasRequiredNextTickBrowser)return nextTickBrowser;hasRequiredNextTickBrowser=1;const e=queueMicrotask_1;return nextTickBrowser=function(t,...r){r.length===0?e(t):e(()=>t(...r))},nextTickBrowser}var abstractSublevelIterator={},hasRequiredAbstractSublevelIterator;function requireAbstractSublevelIterator(){if(hasRequiredAbstractSublevelIterator)return abstractSublevelIterator;hasRequiredAbstractSublevelIterator=1;const{AbstractIterator:e,AbstractKeyIterator:t,AbstractValueIterator:r}=abstractIterator,n=Symbol("unfix"),o=Symbol("iterator"),s=Symbol("handleOne"),a=Symbol("handleMany"),c=Symbol("callback");class l extends e{constructor(f,_,p,y){super(f,_),this[o]=p,this[n]=y,this[s]=this[s].bind(this),this[a]=this[a].bind(this),this[c]=null}[s](f,_,p){const y=this[c];if(f)return y(f);_!==void 0&&(_=this[n](_)),y(f,_,p)}[a](f,_){const p=this[c];if(f)return p(f);for(const y of _){const w=y[0];w!==void 0&&(y[0]=this[n](w))}p(f,_)}}class h extends t{constructor(f,_,p,y){super(f,_),this[o]=p,this[n]=y,this[s]=this[s].bind(this),this[a]=this[a].bind(this),this[c]=null}[s](f,_){const p=this[c];if(f)return p(f);_!==void 0&&(_=this[n](_)),p(f,_)}[a](f,_){const p=this[c];if(f)return p(f);for(let y=0;y<_.length;y++){const w=_[y];w!==void 0&&(_[y]=this[n](w))}p(f,_)}}class u extends r{constructor(f,_,p){super(f,_),this[o]=p}}for(const d of[l,h])d.prototype._next=function(f){this[c]=f,this[o].next(this[s])},d.prototype._nextv=function(f,_,p){this[c]=p,this[o].nextv(f,_,this[a])},d.prototype._all=function(f,_){this[c]=_,this[o].all(f,this[a])};for(const d of[u])d.prototype._next=function(f){this[o].next(f)},d.prototype._nextv=function(f,_,p){this[o].nextv(f,_,p)},d.prototype._all=function(f,_){this[o].all(f,_)};for(const d of[l,h,u])d.prototype._seek=function(f,_){this[o].seek(f,_)},d.prototype._close=function(f){this[o].close(f)};return abstractSublevelIterator.AbstractSublevelIterator=l,abstractSublevelIterator.AbstractSublevelKeyIterator=h,abstractSublevelIterator.AbstractSublevelValueIterator=u,abstractSublevelIterator}var abstractSublevel,hasRequiredAbstractSublevel;function requireAbstractSublevel(){if(hasRequiredAbstractSublevel)return abstractSublevel;hasRequiredAbstractSublevel=1;const e=moduleError,{Buffer:t}=buffer||{},{AbstractSublevelIterator:r,AbstractSublevelKeyIterator:n,AbstractSublevelValueIterator:o}=requireAbstractSublevelIterator(),s=Symbol("prefix"),a=Symbol("upperBound"),c=Symbol("prefixRange"),l=Symbol("parent"),h=Symbol("unfix"),u=new TextEncoder,d={separator:"!"};abstractSublevel=function({AbstractLevel:E}){class x extends E{static defaults(P){if(typeof P=="string")throw new e("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(P&&P.open)throw new e("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return P==null?d:P.separator?P:{...P,separator:"!"}}constructor(P,U,F){const{separator:G,manifest:H,...te}=x.defaults(F);U=w(U,G);const J=G.charCodeAt(0)+1,le=P[l]||P;if(!u.encode(U).every(he=>he>J&&he<127))throw new e(`Prefix must use bytes > ${J} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(f(le,H),te);const z=(P.prefix||"")+G+U+G,q=z.slice(0,-1)+String.fromCharCode(J);this[l]=le,this[s]=new p(z),this[a]=new p(q),this[h]=new y,this.nextTick=le.nextTick}prefixKey(P,U){if(U==="utf8")return this[s].utf8+P;if(P.byteLength===0)return this[s][U];if(U==="view"){const F=this[s].view,G=new Uint8Array(F.byteLength+P.byteLength);return G.set(F,0),G.set(P,F.byteLength),G}else{const F=this[s].buffer;return t.concat([F,P],F.byteLength+P.byteLength)}}[c](P,U){P.gte!==void 0?P.gte=this.prefixKey(P.gte,U):P.gt!==void 0?P.gt=this.prefixKey(P.gt,U):P.gte=this[s][U],P.lte!==void 0?P.lte=this.prefixKey(P.lte,U):P.lt!==void 0?P.lt=this.prefixKey(P.lt,U):P.lte=this[a][U]}get prefix(){return this[s].utf8}get db(){return this[l]}_open(P,U){this[l].open({passive:!0},U)}_put(P,U,F,G){this[l].put(P,U,F,G)}_get(P,U,F){this[l].get(P,U,F)}_getMany(P,U,F){this[l].getMany(P,U,F)}_del(P,U,F){this[l].del(P,U,F)}_batch(P,U,F){this[l].batch(P,U,F)}_clear(P,U){this[c](P,P.keyEncoding),this[l].clear(P,U)}_iterator(P){this[c](P,P.keyEncoding);const U=this[l].iterator(P),F=this[h].get(this[s].utf8.length,P.keyEncoding);return new r(this,P,U,F)}_keys(P){this[c](P,P.keyEncoding);const U=this[l].keys(P),F=this[h].get(this[s].utf8.length,P.keyEncoding);return new n(this,P,U,F)}_values(P){this[c](P,P.keyEncoding);const U=this[l].values(P);return new o(this,P,U)}}return{AbstractSublevel:x}};const f=function(E,x){return{...E.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...x,encodings:{utf8:_(E,"utf8"),buffer:_(E,"buffer"),view:_(E,"view")}}},_=function(E,x){return E.supports.encodings[x]?E.keyEncoding(x).name===x:!1};class p{constructor(x){this.utf8=x,this.view=u.encode(x),this.buffer=t?t.from(this.view.buffer,0,this.view.byteLength):{}}}class y{constructor(){this.cache=new Map}get(x,B){let P=this.cache.get(B);return P===void 0&&(B==="view"?P=(function(U,F){return F.subarray(U)}).bind(null,x):P=(function(U,F){return F.slice(U)}).bind(null,x),this.cache.set(B,P)),P}}const w=function(E,x){let B=0,P=E.length;for(;B<P&&E[B]===x;)B++;for(;P>B&&E[P-1]===x;)P--;return E.slice(B,P)};return abstractSublevel}const{supports}=levelSupports,{Transcoder}=levelTranscoder,{EventEmitter}=eventsExports,{fromCallback:fromCallback$1}=catering,ModuleError$1=moduleError,{AbstractIterator:AbstractIterator$1}=abstractIterator,{DefaultKeyIterator,DefaultValueIterator}=defaultKvIterator,{DeferredIterator,DeferredKeyIterator,DeferredValueIterator}=deferredIterator,{DefaultChainedBatch}=defaultChainedBatch,{getCallback,getOptions}=common,rangeOptions=rangeOptions_1,kPromise$1=Symbol("promise"),kLanded=Symbol("landed"),kResources=Symbol("resources"),kCloseResources=Symbol("closeResources"),kOperations=Symbol("operations"),kUndefer=Symbol("undefer"),kDeferOpen=Symbol("deferOpen"),kOptions$1=Symbol("options"),kStatus=Symbol("status"),kDefaultOptions=Symbol("defaultOptions"),kTranscoder=Symbol("transcoder"),kKeyEncoding=Symbol("keyEncoding"),kValueEncoding=Symbol("valueEncoding"),noop=()=>{};let AbstractLevel$1=class extends EventEmitter{constructor(e,t){if(super(),typeof e!="object"||e===null)throw new TypeError("The first argument 'manifest' must be an object");t=getOptions(t);const{keyEncoding:r,valueEncoding:n,passive:o,...s}=t;this[kResources]=new Set,this[kOperations]=[],this[kDeferOpen]=!0,this[kOptions$1]=s,this[kStatus]="opening",this.supports=supports(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:e.snapshots!==!1,permanence:e.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[kTranscoder]=new Transcoder(formats(this)),this[kKeyEncoding]=this[kTranscoder].encoding(r||"utf8"),this[kValueEncoding]=this[kTranscoder].encoding(n||"utf8");for(const a of this[kTranscoder].encodings())this.supports.encodings[a.commonName]||(this.supports.encodings[a.commonName]=!0);this[kDefaultOptions]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[kKeyEncoding].commonName,valueEncoding:this[kValueEncoding].commonName}),key:Object.freeze({keyEncoding:this[kKeyEncoding].commonName})},this.nextTick(()=>{this[kDeferOpen]&&this.open({passive:!1},noop)})}get status(){return this[kStatus]}keyEncoding(e){return this[kTranscoder].encoding(e??this[kKeyEncoding])}valueEncoding(e){return this[kTranscoder].encoding(e??this[kValueEncoding])}open(e,t){t=getCallback(e,t),t=fromCallback$1(t,kPromise$1),e={...this[kOptions$1],...getOptions(e)},e.createIfMissing=e.createIfMissing!==!1,e.errorIfExists=!!e.errorIfExists;const r=n=>{this[kStatus]==="closing"||this[kStatus]==="opening"?this.once(kLanded,n?()=>r(n):r):this[kStatus]!=="open"?t(new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:n})):t()};return e.passive?this[kStatus]==="opening"?this.once(kLanded,r):this.nextTick(r):this[kStatus]==="closed"||this[kDeferOpen]?(this[kDeferOpen]=!1,this[kStatus]="opening",this.emit("opening"),this._open(e,n=>{if(n){this[kStatus]="closed",this[kCloseResources](()=>{this.emit(kLanded),r(n)}),this[kUndefer]();return}this[kStatus]="open",this[kUndefer](),this.emit(kLanded),this[kStatus]==="open"&&this.emit("open"),this[kStatus]==="open"&&this.emit("ready"),r()})):this[kStatus]==="open"?this.nextTick(r):this.once(kLanded,()=>this.open(e,t)),t[kPromise$1]}_open(e,t){this.nextTick(t)}close(e){e=fromCallback$1(e,kPromise$1);const t=r=>{this[kStatus]==="opening"||this[kStatus]==="closing"?this.once(kLanded,r?t(r):t):this[kStatus]!=="closed"?e(new ModuleError$1("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:r})):e()};if(this[kStatus]==="open"){this[kStatus]="closing",this.emit("closing");const r=n=>{this[kStatus]="open",this[kUndefer](),this.emit(kLanded),t(n)};this[kCloseResources](()=>{this._close(n=>{if(n)return r(n);this[kStatus]="closed",this[kUndefer](),this.emit(kLanded),this[kStatus]==="closed"&&this.emit("closed"),t()})})}else this[kStatus]==="closed"?this.nextTick(t):this.once(kLanded,()=>this.close(e));return e[kPromise$1]}[kCloseResources](e){if(this[kResources].size===0)return this.nextTick(e);let t=this[kResources].size,r=!0;const n=()=>{--t===0&&(r?this.nextTick(e):e())};for(const o of this[kResources])o.close(n);r=!1,this[kResources].clear()}_close(e){this.nextTick(e)}get(e,t,r){if(r=getCallback(t,r),r=fromCallback$1(r,kPromise$1),t=getOptions(t,this[kDefaultOptions].entry),this[kStatus]==="opening")return this.defer(()=>this.get(e,t,r)),r[kPromise$1];if(maybeError(this,r))return r[kPromise$1];const n=this._checkKey(e);if(n)return this.nextTick(r,n),r[kPromise$1];const o=this.keyEncoding(t.keyEncoding),s=this.valueEncoding(t.valueEncoding),a=o.format,c=s.format;return(t.keyEncoding!==a||t.valueEncoding!==c)&&(t=Object.assign({},t,{keyEncoding:a,valueEncoding:c})),this._get(this.prefixKey(o.encode(e),a),t,(l,h)=>{if(l)return(l.code==="LEVEL_NOT_FOUND"||l.notFound||/NotFound/i.test(l))&&(l.code||(l.code="LEVEL_NOT_FOUND"),l.notFound||(l.notFound=!0),l.status||(l.status=404)),r(l);try{h=s.decode(h)}catch(u){return r(new ModuleError$1("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:u}))}r(null,h)}),r[kPromise$1]}_get(e,t,r){this.nextTick(r,new Error("NotFound"))}getMany(e,t,r){if(r=getCallback(t,r),r=fromCallback$1(r,kPromise$1),t=getOptions(t,this[kDefaultOptions].entry),this[kStatus]==="opening")return this.defer(()=>this.getMany(e,t,r)),r[kPromise$1];if(maybeError(this,r))return r[kPromise$1];if(!Array.isArray(e))return this.nextTick(r,new TypeError("The first argument 'keys' must be an array")),r[kPromise$1];if(e.length===0)return this.nextTick(r,null,[]),r[kPromise$1];const n=this.keyEncoding(t.keyEncoding),o=this.valueEncoding(t.valueEncoding),s=n.format,a=o.format;(t.keyEncoding!==s||t.valueEncoding!==a)&&(t=Object.assign({},t,{keyEncoding:s,valueEncoding:a}));const c=new Array(e.length);for(let l=0;l<e.length;l++){const h=e[l],u=this._checkKey(h);if(u)return this.nextTick(r,u),r[kPromise$1];c[l]=this.prefixKey(n.encode(h),s)}return this._getMany(c,t,(l,h)=>{if(l)return r(l);try{for(let u=0;u<h.length;u++)h[u]!==void 0&&(h[u]=o.decode(h[u]))}catch(u){return r(new ModuleError$1(`Could not decode one or more of ${h.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:u}))}r(null,h)}),r[kPromise$1]}_getMany(e,t,r){this.nextTick(r,null,new Array(e.length).fill(void 0))}put(e,t,r,n){if(n=getCallback(r,n),n=fromCallback$1(n,kPromise$1),r=getOptions(r,this[kDefaultOptions].entry),this[kStatus]==="opening")return this.defer(()=>this.put(e,t,r,n)),n[kPromise$1];if(maybeError(this,n))return n[kPromise$1];const o=this._checkKey(e)||this._checkValue(t);if(o)return this.nextTick(n,o),n[kPromise$1];const s=this.keyEncoding(r.keyEncoding),a=this.valueEncoding(r.valueEncoding),c=s.format,l=a.format;(r.keyEncoding!==c||r.valueEncoding!==l)&&(r=Object.assign({},r,{keyEncoding:c,valueEncoding:l}));const h=this.prefixKey(s.encode(e),c),u=a.encode(t);return this._put(h,u,r,d=>{if(d)return n(d);this.emit("put",e,t),n()}),n[kPromise$1]}_put(e,t,r,n){this.nextTick(n)}del(e,t,r){if(r=getCallback(t,r),r=fromCallback$1(r,kPromise$1),t=getOptions(t,this[kDefaultOptions].key),this[kStatus]==="opening")return this.defer(()=>this.del(e,t,r)),r[kPromise$1];if(maybeError(this,r))return r[kPromise$1];const n=this._checkKey(e);if(n)return this.nextTick(r,n),r[kPromise$1];const o=this.keyEncoding(t.keyEncoding),s=o.format;return t.keyEncoding!==s&&(t=Object.assign({},t,{keyEncoding:s})),this._del(this.prefixKey(o.encode(e),s),t,a=>{if(a)return r(a);this.emit("del",e),r()}),r[kPromise$1]}_del(e,t,r){this.nextTick(r)}batch(e,t,r){if(!arguments.length){if(this[kStatus]==="opening")return new DefaultChainedBatch(this);if(this[kStatus]!=="open")throw new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof e=="function"?r=e:r=getCallback(t,r),r=fromCallback$1(r,kPromise$1),t=getOptions(t,this[kDefaultOptions].empty),this[kStatus]==="opening")return this.defer(()=>this.batch(e,t,r)),r[kPromise$1];if(maybeError(this,r))return r[kPromise$1];if(!Array.isArray(e))return this.nextTick(r,new TypeError("The first argument 'operations' must be an array")),r[kPromise$1];if(e.length===0)return this.nextTick(r),r[kPromise$1];const n=new Array(e.length),{keyEncoding:o,valueEncoding:s,...a}=t;for(let c=0;c<e.length;c++){if(typeof e[c]!="object"||e[c]===null)return this.nextTick(r,new TypeError("A batch operation must be an object")),r[kPromise$1];const l=Object.assign({},e[c]);if(l.type!=="put"&&l.type!=="del")return this.nextTick(r,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),r[kPromise$1];const h=this._checkKey(l.key);if(h)return this.nextTick(r,h),r[kPromise$1];const u=l.sublevel!=null?l.sublevel:this,d=u.keyEncoding(l.keyEncoding||o),f=d.format;if(l.key=u.prefixKey(d.encode(l.key),f),l.keyEncoding=f,l.type==="put"){const _=this._checkValue(l.value);if(_)return this.nextTick(r,_),r[kPromise$1];const p=u.valueEncoding(l.valueEncoding||s);l.value=p.encode(l.value),l.valueEncoding=p.format}u!==this&&(l.sublevel=null),n[c]=l}return this._batch(n,a,c=>{if(c)return r(c);this.emit("batch",e),r()}),r[kPromise$1]}_batch(e,t,r){this.nextTick(r)}sublevel(e,t){return this._sublevel(e,AbstractSublevel.defaults(t))}_sublevel(e,t){return new AbstractSublevel(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=getCallback(e,t),t=fromCallback$1(t,kPromise$1),e=getOptions(e,this[kDefaultOptions].empty),this[kStatus]==="opening")return this.defer(()=>this.clear(e,t)),t[kPromise$1];if(maybeError(this,t))return t[kPromise$1];const r=e,n=this.keyEncoding(e.keyEncoding);return e=rangeOptions(e,n),e.keyEncoding=n.format,e.limit===0?this.nextTick(t):this._clear(e,o=>{if(o)return t(o);this.emit("clear",r),t()}),t[kPromise$1]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if(e=rangeOptions(e,t),e.keys=e.keys!==!1,e.values=e.values!==!1,e[AbstractIterator$1.keyEncoding]=t,e[AbstractIterator$1.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,this[kStatus]==="opening")return new DeferredIterator(this,e);if(this[kStatus]!=="open")throw new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new AbstractIterator$1(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if(e=rangeOptions(e,t),e[AbstractIterator$1.keyEncoding]=t,e[AbstractIterator$1.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,this[kStatus]==="opening")return new DeferredKeyIterator(this,e);if(this[kStatus]!=="open")throw new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new DefaultKeyIterator(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),r=this.valueEncoding(e&&e.valueEncoding);if(e=rangeOptions(e,t),e[AbstractIterator$1.keyEncoding]=t,e[AbstractIterator$1.valueEncoding]=r,e.keyEncoding=t.format,e.valueEncoding=r.format,this[kStatus]==="opening")return new DeferredValueIterator(this,e);if(this[kStatus]!=="open")throw new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new DefaultValueIterator(this,e)}defer(e){if(typeof e!="function")throw new TypeError("The first argument must be a function");this[kOperations].push(e)}[kUndefer](){if(this[kOperations].length===0)return;const e=this[kOperations];this[kOperations]=[];for(const t of e)t()}attachResource(e){if(typeof e!="object"||e===null||typeof e.close!="function")throw new TypeError("The first argument must be a resource object");this[kResources].add(e)}detachResource(e){this[kResources].delete(e)}_chainedBatch(){return new DefaultChainedBatch(this)}_checkKey(e){if(e==null)return new ModuleError$1("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(e==null)return new ModuleError$1("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}};AbstractLevel$1.prototype.nextTick=requireNextTickBrowser();const{AbstractSublevel}=requireAbstractSublevel()({AbstractLevel:AbstractLevel$1});abstractLevel.AbstractLevel=AbstractLevel$1,abstractLevel.AbstractSublevel=AbstractSublevel;const maybeError=function(e,t){return e[kStatus]!=="open"?(e.nextTick(t,new ModuleError$1("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},formats=function(e){return Object.keys(e.supports.encodings).filter(t=>!!e.supports.encodings[t])};abstractLevel$1.AbstractLevel=abstractLevel.AbstractLevel,abstractLevel$1.AbstractSublevel=abstractLevel.AbstractSublevel,abstractLevel$1.AbstractIterator=abstractIterator.AbstractIterator,abstractLevel$1.AbstractKeyIterator=abstractIterator.AbstractKeyIterator,abstractLevel$1.AbstractValueIterator=abstractIterator.AbstractValueIterator,abstractLevel$1.AbstractChainedBatch=abstractChainedBatch.AbstractChainedBatch;var runParallelLimit_1=runParallelLimit;const queueMicrotask$1=queueMicrotask_1;function runParallelLimit(e,t,r){if(typeof t!="number")throw new Error("second argument must be a Number");let n,o,s,a,c,l=!0,h;Array.isArray(e)?(n=[],s=o=e.length):(a=Object.keys(e),n={},s=o=a.length);function u(f){function _(){r&&r(f,n),r=null}l?queueMicrotask$1(_):_()}function d(f,_,p){if(n[f]=p,_&&(c=!0),--s===0||_)u(_);else if(!c&&h<o){let y;a?(y=a[h],h+=1,e[y](function(w,E){d(y,w,E)})):(y=h,h+=1,e[y](function(w,E){d(y,w,E)}))}}h=t,s?a?a.some(function(f,_){return e[f](function(p,y){d(f,p,y)}),_===t-1}):e.some(function(f,_){return f(function(p,y){d(_,p,y)}),_===t-1}):u(null),l=!1}var iterator={},keyRange=function e(t){const r=t.gte!==void 0?t.gte:t.gt!==void 0?t.gt:void 0,n=t.lte!==void 0?t.lte:t.lt!==void 0?t.lt:void 0,o=t.gte===void 0,s=t.lte===void 0;return r!==void 0&&n!==void 0?IDBKeyRange.bound(r,n,o,s):r!==void 0?IDBKeyRange.lowerBound(r,o):n!==void 0?IDBKeyRange.upperBound(n,s):null};const textEncoder=new TextEncoder;var deserialize$2=function(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):textEncoder.encode(e)};const{AbstractIterator}=abstractLevel$1,createKeyRange$1=keyRange,deserialize$1=deserialize$2,kCache=Symbol("cache"),kFinished=Symbol("finished"),kOptions=Symbol("options"),kCurrentOptions=Symbol("currentOptions"),kPosition=Symbol("position"),kLocation$1=Symbol("location"),kFirst=Symbol("first"),emptyOptions={};let Iterator$1=class extends AbstractIterator{constructor(e,t,r){super(e,r),this[kCache]=[],this[kFinished]=this.limit===0,this[kOptions]=r,this[kCurrentOptions]={...r},this[kPosition]=void 0,this[kLocation$1]=t,this[kFirst]=!0}_nextv(e,t,r){if(this[kFirst]=!1,this[kFinished])return this.nextTick(r,null,[]);if(this[kCache].length>0)return e=Math.min(e,this[kCache].length),this.nextTick(r,null,this[kCache].splice(0,e));this[kPosition]!==void 0&&(this[kOptions].reverse?(this[kCurrentOptions].lt=this[kPosition],this[kCurrentOptions].lte=void 0):(this[kCurrentOptions].gt=this[kPosition],this[kCurrentOptions].gte=void 0));let n;try{n=createKeyRange$1(this[kCurrentOptions])}catch{return this[kFinished]=!0,this.nextTick(r,null,[])}const o=this.db.db.transaction([this[kLocation$1]],"readonly"),s=o.objectStore(this[kLocation$1]),a=[];if(this[kOptions].reverse){const c=!this[kOptions].values&&s.openKeyCursor?"openKeyCursor":"openCursor";s[c](n,"prev").onsuccess=l=>{const h=l.target.result;if(h){const{key:u,value:d}=h;this[kPosition]=u,a.push([this[kOptions].keys&&u!==void 0?deserialize$1(u):void 0,this[kOptions].values&&d!==void 0?deserialize$1(d):void 0]),a.length<e?h.continue():maybeCommit(o)}else this[kFinished]=!0}}else{let c,l;const h=()=>{if(c===void 0||l===void 0)return;const u=Math.max(c.length,l.length);u===0||e===1/0?this[kFinished]=!0:this[kPosition]=c[u-1],a.length=u;for(let d=0;d<u;d++){const f=c[d],_=l[d];a[d]=[this[kOptions].keys&&f!==void 0?deserialize$1(f):void 0,this[kOptions].values&&_!==void 0?deserialize$1(_):void 0]}maybeCommit(o)};this[kOptions].keys||e<1/0?s.getAllKeys(n,e<1/0?e:void 0).onsuccess=u=>{c=u.target.result,h()}:(c=[],this.nextTick(h)),this[kOptions].values?s.getAll(n,e<1/0?e:void 0).onsuccess=u=>{l=u.target.result,h()}:(l=[],this.nextTick(h))}o.onabort=()=>{r(o.error||new Error("aborted by user")),r=null},o.oncomplete=()=>{r(null,a),r=null}}_next(e){if(this[kCache].length>0){const[t,r]=this[kCache].shift();this.nextTick(e,null,t,r)}else if(this[kFinished])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[kFirst]&&(this[kFirst]=!1,t=1),this._nextv(t,emptyOptions,(r,n)=>{if(r)return e(r);this[kCache]=n,this._next(e)})}}_all(e,t){this[kFirst]=!1;const r=this[kCache].splice(0,this[kCache].length),n=this.limit-this.count-r.length;if(n<=0)return this.nextTick(t,null,r);this._nextv(n,emptyOptions,(o,s)=>{if(o)return t(o);r.length>0&&(s=r.concat(s)),t(null,s)})}_seek(e,t){this[kFirst]=!0,this[kCache]=[],this[kFinished]=!1,this[kPosition]=void 0,this[kCurrentOptions]={...this[kOptions]};let r;try{r=createKeyRange$1(this[kOptions])}catch{this[kFinished]=!0;return}r!==null&&!r.includes(e)?this[kFinished]=!0:this[kOptions].reverse?this[kCurrentOptions].lte=e:this[kCurrentOptions].gte=e}};iterator.Iterator=Iterator$1;function maybeCommit(e){typeof e.commit=="function"&&e.commit()}var clear$1=function e(t,r,n,o,s){if(o.limit===0)return t.nextTick(s);const a=t.db.transaction([r],"readwrite"),c=a.objectStore(r);let l=0;a.oncomplete=function(){s()},a.onabort=function(){s(a.error||new Error("aborted by user"))};const h=c.openKeyCursor?"openKeyCursor":"openCursor",u=o.reverse?"prev":"next";c[h](n,u).onsuccess=function(d){const f=d.target.result;f&&(c.delete(f.key).onsuccess=function(){(o.limit<=0||++l<o.limit)&&f.continue()})}};const{AbstractLevel}=abstractLevel$1,ModuleError=moduleError,parallel=runParallelLimit_1,{fromCallback}=catering,{Iterator}=iterator,deserialize=deserialize$2,clear=clear$1,createKeyRange=keyRange,DEFAULT_PREFIX="level-js-",kIDB=Symbol("idb"),kNamePrefix=Symbol("namePrefix"),kLocation=Symbol("location"),kVersion=Symbol("version"),kStore=Symbol("store"),kOnComplete=Symbol("onComplete"),kPromise=Symbol("promise");class BrowserLevel extends AbstractLevel{constructor(t,r,n){if(typeof r=="function"||typeof n=="function")throw new ModuleError("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:o,version:s,...a}=r||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},a),typeof t!="string")throw new Error("constructor requires a location string argument");this[kLocation]=t,this[kNamePrefix]=o??DEFAULT_PREFIX,this[kVersion]=parseInt(s||1,10),this[kIDB]=null}get location(){return this[kLocation]}get namePrefix(){return this[kNamePrefix]}get version(){return this[kVersion]}get db(){return this[kIDB]}get type(){return"browser-level"}_open(t,r){const n=indexedDB.open(this[kNamePrefix]+this[kLocation],this[kVersion]);n.onerror=function(){r(n.error||new Error("unknown error"))},n.onsuccess=()=>{this[kIDB]=n.result,r()},n.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(this[kLocation])||s.createObjectStore(this[kLocation])}}[kStore](t){return this[kIDB].transaction([this[kLocation]],t).objectStore(this[kLocation])}[kOnComplete](t,r){const n=t.transaction;n.onabort=function(){r(n.error||new Error("aborted by user"))},n.oncomplete=function(){r(null,t.result)}}_get(t,r,n){const o=this[kStore]("readonly");let s;try{s=o.get(t)}catch(a){return this.nextTick(n,a)}this[kOnComplete](s,function(a,c){if(a)return n(a);if(c===void 0)return n(new ModuleError("Entry not found",{code:"LEVEL_NOT_FOUND"}));n(null,deserialize(c))})}_getMany(t,r,n){const o=this[kStore]("readonly"),s=t.map(a=>c=>{let l;try{l=o.get(a)}catch(h){return c(h)}l.onsuccess=()=>{const h=l.result;c(null,h===void 0?h:deserialize(h))},l.onerror=h=>{h.stopPropagation(),c(l.error)}});parallel(s,16,n)}_del(t,r,n){const o=this[kStore]("readwrite");let s;try{s=o.delete(t)}catch(a){return this.nextTick(n,a)}this[kOnComplete](s,n)}_put(t,r,n,o){const s=this[kStore]("readwrite");let a;try{a=s.put(r,t)}catch(c){return this.nextTick(o,c)}this[kOnComplete](a,o)}_iterator(t){return new Iterator(this,this[kLocation],t)}_batch(t,r,n){const o=this[kStore]("readwrite"),s=o.transaction;let a=0,c;s.onabort=function(){n(c||s.error||new Error("aborted by user"))},s.oncomplete=function(){n()};function l(){const h=t[a++],u=h.key;let d;try{d=h.type==="del"?o.delete(u):o.put(h.value,u)}catch(f){c=f,s.abort();return}a<t.length?d.onsuccess=l:typeof s.commit=="function"&&s.commit()}l()}_clear(t,r){let n,o;try{n=createKeyRange(t)}catch{return this.nextTick(r)}if(t.limit>=0)return clear(this,this[kLocation],n,t,r);try{const s=this[kStore]("readwrite");o=n?s.delete(n):s.clear()}catch(s){return this.nextTick(r,s)}this[kOnComplete](o,r)}_close(t){this[kIDB].close(),this.nextTick(t)}}BrowserLevel.destroy=function(e,t,r){typeof t=="function"&&(r=t,t=DEFAULT_PREFIX),r=fromCallback(r,kPromise);const n=indexedDB.deleteDatabase(t+e);return n.onsuccess=function(){r()},n.onerror=function(o){r(o)},r[kPromise]},browserLevel.BrowserLevel=BrowserLevel;var Level=browserLevel.BrowserLevel,createLevel$1=e=>new Level(e),subscribeToFeeds=({feedStore:e},{feedKeys:t})=>new Stream$2(({next:r})=>{const n=new EventSubscriptions,o=new ComplexMap(PublicKey.hash),s=()=>{const{feeds:a}=e;a.filter(c=>!(t!=null&&t.length)||t.some(l=>l.equals(c.key))).forEach(c=>{o.has(c.key)||(o.set(c.key,c),c.on("close",s),n.add(()=>c.off("close",s)))}),r({feeds:Array.from(o.values()).map(c=>{var l;return{feedKey:c.key,length:c.properties.length,bytes:c.core.byteLength,downloaded:((l=c.core.bitfield)==null?void 0:l.data.toBuffer())??new Uint8Array}})})};return n.add(e.feedOpened.on(s)),s(),()=>{n.clear()}}),subscribeToFeedBlocks=({feedStore:e},{feedKey:t,maxBlocks:r=10})=>new Stream$2(({next:n})=>{if(!t)return;const o=new EventSubscriptions,s=setTimeout(async()=>{const a=e.getFeed(t);if(!a)return;const c=async()=>{const l=new FeedIterator(a);await l.open();const h=[];for await(const u of l)if(h.push(u),h.length>=a.properties.length)break;n({blocks:h.slice(-r)}),await l.close()};a.on("append",c),o.add(()=>a.off("append",c)),a.on("truncate",c),o.add(()=>a.off("truncate",c)),await c()});return()=>{o.clear(),clearTimeout(s)}}),subscribeToNetworkStatus=({signalManager:e})=>new Stream$2(({next:t,close:r})=>{const n=()=>{try{const o=e.getStatus();t({servers:o})}catch(o){r(o)}};e.statusChanged.on(()=>n()),n()}),subscribeToSignal=({signalManager:e})=>new Stream$2(({next:t})=>{const r=new Context;return e.onMessage.on(r,n=>{t({message:{author:n.author.asUint8Array(),recipient:n.recipient.asUint8Array(),payload:n.payload},receivedAt:new Date})}),e.swarmEvent.on(r,n=>{t({swarmEvent:n.swarmEvent,topic:n.topic.asUint8Array(),receivedAt:new Date})}),()=>r.dispose()}),subscribeToSwarmInfo=({networkManager:e})=>new Stream$2(({next:t})=>{var n;const r=()=>{var s;const o=(s=e.connectionLog)==null?void 0:s.swarms;o&&t({data:o})};(n=e.connectionLog)==null||n.update.on(r),r()}),subscribeToSpaces=(e,{spaceKeys:t=[]})=>new Stream$2(({next:r})=>{let n;const o=async()=>{const a=[...e.spaceManager.spaces.values()].filter(c=>!(t!=null&&t.length)||t.some(l=>l.equals(c.key)));r({spaces:a.map(c=>{const l=e.metadataStore.spaces.find(h=>h.key.equals(c.key));return{key:c.key,isOpen:c.isOpen,timeframe:l==null?void 0:l.dataTimeframe,genesisFeed:c.genesisFeedKey,controlFeed:c.controlFeedKey,dataFeed:c.dataFeedKey}})})},s=setTimeout(async()=>{await e.initialized.wait(),n=e.dataSpaceManager.updated.on(()=>o()),await o()});return()=>{n==null||n(),clearTimeout(s)}}),subscribeToKeyringKeys=({keyring:e})=>new Stream$2(({next:t,ctx:r})=>{const n=async()=>{t({keys:await e.list()})};e.keysUpdate.on(r,n),scheduleTask(r,n)}),subscribeToMetadata=({context:e})=>new Stream$2(({next:t,ctx:r})=>{e.metadataStore.update.on(r,n=>t({metadata:n})),t({metadata:e.metadataStore.metadata})}),DevtoolsHostEvents=class{constructor(){this.ready=new Event$1}},DevtoolsServiceImpl=class{constructor(e){this.params=e}events(e){return new Stream$2(({next:t})=>{this.params.events.ready.on(()=>{t({ready:{}})})})}async getConfig(e){return{config:JSON.stringify(this.params.config.values)}}async getStorageInfo(){var r,n;const e=await((n=(r=this.params.context.storage).getDiskInfo)==null?void 0:n.call(r))??{used:0},t=typeof navigator=="object"?await navigator.storage.estimate():void 0;return{type:this.params.context.storage.type,storageUsage:e.used,originUsage:(t==null?void 0:t.usage)??0,usageQuota:(t==null?void 0:t.quota)??0}}async getBlobs(){return{blobs:await this.params.context.blobStore.list()}}async getSnapshots(){return{snapshots:await this.params.context.snapshotStore.listSnapshots()}}resetStorage(e){throw new Error}enableDebugLogging(e){throw new Error}disableDebugLogging(e){throw new Error}subscribeToKeyringKeys(e){return subscribeToKeyringKeys({keyring:this.params.context.keyring})}subscribeToCredentialMessages(e){throw new Error}subscribeToSpaces(e){return subscribeToSpaces(this.params.context,e)}subscribeToItems(e){throw new Error}subscribeToFeeds(e){return subscribeToFeeds({feedStore:this.params.context.feedStore},e)}subscribeToFeedBlocks(e){return subscribeToFeedBlocks({feedStore:this.params.context.feedStore},e)}getSpaceSnapshot(e){throw new Error}saveSpaceSnapshot(e){throw new Error}clearSnapshots(e){throw new Error}getNetworkPeers(e){throw new Error}subscribeToNetworkTopics(e){throw new Error}subscribeToSignalStatus(e){return subscribeToNetworkStatus({signalManager:this.params.context.signalManager})}subscribeToSignal(){return subscribeToSignal({signalManager:this.params.context.signalManager})}subscribeToSwarmInfo(){return subscribeToSwarmInfo({networkManager:this.params.context.networkManager})}subscribeToMetadata(){return subscribeToMetadata({context:this.params.context})}},__dxlog_file$5="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/identity/authenticator.ts",Credential=schema.getCodecForType("dxos.halo.credentials.Credential"),createAuthProvider=e=>async t=>{const r=await e.createCredential({assertion:{"@type":"dxos.halo.credentials.Auth"},subject:e.getIssuer(),nonce:t});return Credential.encode(r)},TrustedKeySetAuthVerifier=class{constructor(e){this._params=e,this._ctx=new Context}async close(){await this._ctx.dispose()}get verifier(){return async(e,t)=>{const r=Credential.decode(t);log("authenticating...",{credential:r},{F:__dxlog_file$5,L:56,S:this,C:(a,c)=>a(...c)});const n=await verifyCredential(r);if(n.kind==="fail")return log("Invalid credential",{result:n},{F:__dxlog_file$5,L:60,S:this,C:(a,c)=>a(...c)}),!1;if(!r.proof.nonce||!export_Buffer.from(e).equals(r.proof.nonce))return log("Invalid nonce",{nonce:e,credential:r},{F:__dxlog_file$5,L:65,S:this,C:(a,c)=>a(...c)}),!1;if(this._isTrustedKey(r.issuer))return log("key is not currently in trusted set, waiting...",{key:r.issuer},{F:__dxlog_file$5,L:70,S:this,C:(a,c)=>a(...c)}),!0;const o=new Trigger;this._ctx.onDispose(()=>{o.wake(!1)});const s=this._params.update.on(this._ctx,()=>{this._isTrustedKey(r.issuer)?(log("auth success",{key:r.issuer},{F:__dxlog_file$5,L:81,S:this,C:(a,c)=>a(...c)}),o.wake(!0)):log("key is not currently in trusted set, waiting...",{key:r.issuer},{F:__dxlog_file$5,L:84,S:this,C:(a,c)=>a(...c)})});try{return await o.wait({timeout:this._params.authTimeout})}catch{return!1}finally{s()}}}_isTrustedKey(e){return this._params.trustedKeysProvider().has(e)}};function _ts_decorate$3(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file2$2="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/identity/identity.ts",Identity=class{constructor({space:e,signer:t,identityKey:r,deviceKey:n,presence:o}){this.stateUpdate=new Event$1,this.space=e,this._signer=t,this._presence=o,this.identityKey=r,this.deviceKey=n,log.trace("dxos.halo.device",{deviceKey:n},{F:__dxlog_file2$2,L:67,S:this,C:(s,a)=>s(...a)}),this._deviceStateMachine=new DeviceStateMachine({identityKey:this.identityKey,deviceKey:this.deviceKey,onUpdate:()=>this.stateUpdate.emit()}),this._profileStateMachine=new ProfileStateMachine({identityKey:this.identityKey,onUpdate:()=>this.stateUpdate.emit()}),this.authVerifier=new TrustedKeySetAuthVerifier({trustedKeysProvider:()=>new ComplexSet(PublicKey.hash,this.authorizedDeviceKeys.keys()),update:this.stateUpdate,authTimeout:AUTH_TIMEOUT})}get authorizedDeviceKeys(){return this._deviceStateMachine.authorizedDeviceKeys}async open(e){await this.space.spaceState.addCredentialProcessor(this._deviceStateMachine),await this.space.spaceState.addCredentialProcessor(this._profileStateMachine),await this.space.open(e)}async close(e){var t;await((t=this._presence)==null?void 0:t.destroy()),await this.authVerifier.close(),await this.space.spaceState.removeCredentialProcessor(this._profileStateMachine),await this.space.spaceState.removeCredentialProcessor(this._deviceStateMachine),await this.space.close()}async ready(){await this._deviceStateMachine.deviceChainReady.wait(),await this.controlPipeline.state.waitUntilReachedTargetTimeframe({timeout:LOAD_CONTROL_FEEDS_TIMEOUT})}get profileDocument(){return this._profileStateMachine.profile}get controlPipeline(){return this.space.controlPipeline}get haloSpaceKey(){return this.space.key}get haloGenesisFeedKey(){return this.space.genesisFeedKey}get deviceCredentialChain(){return this._deviceStateMachine.deviceCredentialChain}get presence(){return this._presence}getIdentityCredentialSigner(){return invariant$1(this._deviceStateMachine.deviceCredentialChain,"Device credential chain is not ready.",{F:__dxlog_file2$2,L:145,S:this,A:["this._deviceStateMachine.deviceCredentialChain","'Device credential chain is not ready.'"]}),createCredentialSignerWithChain(this._signer,this._deviceStateMachine.deviceCredentialChain,this.deviceKey)}getDeviceCredentialSigner(){return createCredentialSignerWithKey(this._signer,this.deviceKey)}async admitDevice({deviceKey:e,controlFeedKey:t,dataFeedKey:r}){log("Admitting device:",{identityKey:this.identityKey,hostDevice:this.deviceKey,deviceKey:e,controlFeedKey:t,dataFeedKey:r},{F:__dxlog_file2$2,L:161,S:this,C:(o,s)=>o(...s)});const n=this.getIdentityCredentialSigner();await writeMessages(this.controlPipeline.writer,[await n.createCredential({subject:e,assertion:{"@type":"dxos.halo.credentials.AuthorizedDevice",identityKey:this.identityKey,deviceKey:e}}),await n.createCredential({subject:t,assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:this.haloSpaceKey,deviceKey:e,identityKey:this.identityKey,designation:AdmittedFeed.Designation.CONTROL}}),await n.createCredential({subject:r,assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:this.haloSpaceKey,deviceKey:e,identityKey:this.identityKey,designation:AdmittedFeed.Designation.DATA}})].map(o=>({credential:{credential:o}})))}};_ts_decorate$3([trace.span()],Identity.prototype,"open",null),_ts_decorate$3([trace.span()],Identity.prototype,"close",null),Identity=_ts_decorate$3([trace.resource()],Identity);function _ts_decorate2$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file3$1="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/identity/identity-manager.ts",DEVICE_PRESENCE_ANNOUNCE_INTERVAL=1e4,DEVICE_PRESENCE_OFFLINE_TIMEOUT=2e4,IdentityManager=class{constructor(e,t,r,n,o){this._metadataStore=e,this._keyring=t,this._feedStore=r,this._spaceManager=n,this.stateUpdate=new Event$1;const{devicePresenceAnnounceInterval:s=DEVICE_PRESENCE_ANNOUNCE_INTERVAL,devicePresenceOfflineTimeout:a=DEVICE_PRESENCE_OFFLINE_TIMEOUT}=o??{};this._devicePresenceAnnounceInterval=s,this._devicePresenceOfflineTimeout=a}get identity(){return this._identity}async open(e){var n;const t=PublicKey.random().toHex();log.trace("dxos.halo.identity-manager.open",trace$1.begin({id:t}),{F:__dxlog_file3$1,L:104,S:this,C:(o,s)=>o(...s)});const r=this._metadataStore.getIdentityRecord();log("identity record",{identityRecord:r},{F:__dxlog_file3$1,L:107,S:this,C:(o,s)=>o(...s)}),r&&(this._identity=await this._constructIdentity(r),await this._identity.open(e),await this._identity.ready(),log.trace("dxos.halo.identity",{identityKey:r.identityKey,displayName:(n=this._identity.profileDocument)==null?void 0:n.displayName},{F:__dxlog_file3$1,L:112,S:this,C:(o,s)=>o(...s)}),this.stateUpdate.emit()),log.trace("dxos.halo.identity-manager.open",trace$1.end({id:t}),{F:__dxlog_file3$1,L:119,S:this,C:(o,s)=>o(...s)})}async close(){var e;await((e=this._identity)==null?void 0:e.close(new Context))}async createIdentity({displayName:e,deviceProfile:t}={}){var s;invariant$1(!this._identity,"Identity already exists.",{F:__dxlog_file3$1,L:128,S:this,A:["!this._identity","'Identity already exists.'"]}),log("creating identity...",void 0,{F:__dxlog_file3$1,L:129,S:this,C:(a,c)=>a(...c)});const r=await this._keyring.createKey(),n={identityKey:await this._keyring.createKey(),deviceKey:await this._keyring.createKey(),haloSpace:{key:await this._keyring.createKey(),genesisFeedKey:r,controlFeedKey:r,dataFeedKey:await this._keyring.createKey()}},o=await this._constructIdentity(n);await o.open(new Context);{const a=new CredentialGenerator(this._keyring,n.identityKey,n.deviceKey);invariant$1(n.haloSpace.genesisFeedKey,"Genesis feed key is required.",{F:__dxlog_file3$1,L:148,S:this,A:["identityRecord.haloSpace.genesisFeedKey","'Genesis feed key is required.'"]}),invariant$1(n.haloSpace.dataFeedKey,"Data feed key is required.",{F:__dxlog_file3$1,L:149,S:this,A:["identityRecord.haloSpace.dataFeedKey","'Data feed key is required.'"]});const c=[...await a.createSpaceGenesis(n.haloSpace.key,n.haloSpace.genesisFeedKey),await a.createFeedAdmission(n.haloSpace.key,n.haloSpace.dataFeedKey,AdmittedFeed.Designation.DATA)];e&&c.push(await a.createProfileCredential({displayName:e})),c.push(await a.createDeviceAuthorization(n.deviceKey)),c.push(await a.createDeviceProfile({...this.createDefaultDeviceProfile(),...t}));for(const l of c)await o.controlPipeline.writer.write({credential:{credential:l}})}return await this._metadataStore.setIdentityRecord(n),this._identity=o,await this._identity.ready(),log.trace("dxos.halo.identity",{identityKey:n.identityKey,displayName:(s=this._identity.profileDocument)==null?void 0:s.displayName},{F:__dxlog_file3$1,L:191,S:this,C:(a,c)=>a(...c)}),this.stateUpdate.emit(),log("created identity",{identityKey:o.identityKey,deviceKey:o.deviceKey,profile:o.profileDocument},{F:__dxlog_file3$1,L:197,S:this,C:(a,c)=>a(...c)}),o}createDefaultDeviceProfile(){var t,r,n,o,s;let e;return isNode()?e=DeviceType.AGENT:(t=platform.name)!=null&&t.startsWith("iOS")||(r=platform.name)!=null&&r.startsWith("Android")?e=DeviceType.MOBILE:globalThis.__args?e=DeviceType.NATIVE:e=DeviceType.BROWSER,{type:e,platform:platform.name,platformVersion:platform.version,architecture:typeof((n=platform.os)==null?void 0:n.architecture)=="number"?String(platform.os.architecture):void 0,os:(o=platform.os)==null?void 0:o.family,osVersion:(s=platform.os)==null?void 0:s.version}}async acceptIdentity(e){var n;log("accepting identity",{params:e},{F:__dxlog_file3$1,L:235,S:this,C:(o,s)=>o(...s)}),invariant$1(!this._identity,"Identity already exists.",{F:__dxlog_file3$1,L:236,S:this,A:["!this._identity","'Identity already exists.'"]});const t={identityKey:e.identityKey,deviceKey:e.deviceKey,haloSpace:{key:e.haloSpaceKey,genesisFeedKey:e.haloGenesisFeedKey,controlFeedKey:e.controlFeedKey,dataFeedKey:e.dataFeedKey,controlTimeframe:e.controlTimeframe}},r=await this._constructIdentity(t);return await r.open(new Context),this._identity=r,await this._metadataStore.setIdentityRecord(t),await this._identity.ready(),log.trace("dxos.halo.identity",{identityKey:t.identityKey,displayName:(n=this._identity.profileDocument)==null?void 0:n.displayName},{F:__dxlog_file3$1,L:255,S:this,C:(o,s)=>o(...s)}),await this.updateDeviceProfile({...this.createDefaultDeviceProfile(),...e.deviceProfile}),this.stateUpdate.emit(),log("accepted identity",{identityKey:r.identityKey,deviceKey:r.deviceKey},{F:__dxlog_file3$1,L:265,S:this,C:(o,s)=>o(...s)}),r}async updateProfile(e){invariant$1(this._identity,"Identity not initialized.",{F:__dxlog_file3$1,L:273,S:this,A:["this._identity","'Identity not initialized.'"]});const t=await this._identity.getIdentityCredentialSigner().createCredential({subject:this._identity.identityKey,assertion:{"@type":"dxos.halo.credentials.IdentityProfile",profile:e}}),r=await this._identity.controlPipeline.writer.write({credential:{credential:t}});return await this._identity.controlPipeline.state.waitUntilTimeframe(new Timeframe([[r.feedKey,r.seq]])),this.stateUpdate.emit(),e}async updateDeviceProfile(e){invariant$1(this._identity,"Identity not initialized.",{F:__dxlog_file3$1,L:290,S:this,A:["this._identity","'Identity not initialized.'"]});const t=await this._identity.getDeviceCredentialSigner().createCredential({subject:this._identity.deviceKey,assertion:{"@type":"dxos.halo.credentials.DeviceProfile",profile:e}}),r=await this._identity.controlPipeline.writer.write({credential:{credential:t}});return await this._identity.controlPipeline.state.waitUntilTimeframe(new Timeframe([[r.feedKey,r.seq]])),this.stateUpdate.emit(),{deviceKey:this._identity.deviceKey,kind:DeviceKind.CURRENT,presence:Device.PresenceState.ONLINE,profile:e}}async _constructIdentity(e){invariant$1(!this._identity,void 0,{F:__dxlog_file3$1,L:316,S:this,A:["!this._identity",""]}),log("constructing identity",{identityRecord:e},{F:__dxlog_file3$1,L:317,S:this,C:(c,l)=>c(...l)});const t=new Gossip({localPeerId:e.deviceKey}),r=new Presence({announceInterval:this._devicePresenceAnnounceInterval,offlineTimeout:this._devicePresenceOfflineTimeout,identityKey:e.deviceKey,gossip:t});invariant$1(e.haloSpace.controlFeedKey,void 0,{F:__dxlog_file3$1,L:330,S:this,A:["identityRecord.haloSpace.controlFeedKey",""]});const n=await this._feedStore.openFeed(e.haloSpace.controlFeedKey,{writable:!0});invariant$1(e.haloSpace.dataFeedKey,void 0,{F:__dxlog_file3$1,L:334,S:this,A:["identityRecord.haloSpace.dataFeedKey",""]});const o=await this._feedStore.openFeed(e.haloSpace.dataFeedKey,{writable:!0,sparse:!0}),s=await this._constructSpace({spaceRecord:e.haloSpace,swarmIdentity:{peerKey:e.deviceKey,credentialProvider:createAuthProvider(createCredentialSignerWithKey(this._keyring,e.deviceKey)),credentialAuthenticator:deferFunction(()=>a.authVerifier.verifier)},gossip:t,identityKey:e.identityKey});await s.setControlFeed(n),await s.setDataFeed(o);const a=new Identity({space:s,presence:r,signer:this._keyring,identityKey:e.identityKey,deviceKey:e.deviceKey});return log("done",{identityKey:e.identityKey},{F:__dxlog_file3$1,L:360,S:this,C:(c,l)=>c(...l)}),e.haloSpace.controlTimeframe&&a.controlPipeline.state.setTargetTimeframe(e.haloSpace.controlTimeframe),a.stateUpdate.on(()=>this.stateUpdate.emit()),a}async _constructSpace({spaceRecord:e,swarmIdentity:t,identityKey:r,gossip:n}){return this._spaceManager.constructSpace({metadata:{key:e.key,genesisFeedKey:e.genesisFeedKey},swarmIdentity:t,onAuthorizedConnection:o=>{o.addExtension("dxos.mesh.teleport.gossip",n.createExtension({remotePeerId:o.remotePeerId}))},onAuthFailure:()=>{log.warn("auth failure",void 0,{F:__dxlog_file3$1,L:385,S:this,C:(o,s)=>o(...s)})},memberKey:r,onDelegatedInvitationStatusChange:async()=>{},onMemberRolesChanged:async()=>{}})}};_ts_decorate2$1([trace.span({showInBrowserTimeline:!0})],IdentityManager.prototype,"open",null),IdentityManager=_ts_decorate2$1([trace.resource()],IdentityManager);var __dxlog_file4$1="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/identity/identity-service.ts",IdentityServiceImpl=class{constructor(e,t,r,n){this._createIdentity=e,this._identityManager=t,this._keyring=r,this._onProfileUpdate=n}async createIdentity(e){var t;return await this._createIdentity({displayName:(t=e.profile)==null?void 0:t.displayName,deviceProfile:e.deviceProfile}),this._getIdentity()}async recoverIdentity(e){return todo()}queryIdentity(){return new Stream$2(({next:e})=>{const t=()=>e({identity:this._getIdentity()});return t(),this._identityManager.stateUpdate.on(t)})}_getIdentity(){if(this._identityManager.identity)return{identityKey:this._identityManager.identity.identityKey,spaceKey:this._identityManager.identity.space.key,profile:this._identityManager.identity.profileDocument}}async updateProfile(e){var t;return invariant$1(this._identityManager.identity,"Identity not initialized.",{F:__dxlog_file4$1,L:61,S:this,A:["this._identityManager.identity","'Identity not initialized.'"]}),await this._identityManager.updateProfile(e),await((t=this._onProfileUpdate)==null?void 0:t.call(this,this._identityManager.identity.profileDocument)),this._getIdentity()}async signPresentation({presentation:e,nonce:t}){return invariant$1(this._identityManager.identity,"Identity not initialized.",{F:__dxlog_file4$1,L:68,S:this,A:["this._identityManager.identity","'Identity not initialized.'"]}),await signPresentation({presentation:e,signer:this._keyring,signerKey:this._identityManager.identity.deviceKey,chain:this._identityManager.identity.deviceCredentialChain,nonce:t})}},__dxlog_file5="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/device-invitation-protocol.ts",DeviceInvitationProtocol=class{constructor(e,t,r){this._keyring=e,this._getIdentity=t,this._acceptIdentity=r}toJSON(){return{}}checkCanInviteNewMembers(){}getInvitationContext(){return{kind:Invitation.Kind.DEVICE}}async delegate(){throw new Error("delegation not supported")}async cancelDelegation(){throw new Error("delegation not supported")}async admit(e,t){invariant$1(t.device,void 0,{F:__dxlog_file5,L:50,S:this,A:["request.device",""]});const r=this._getIdentity();return await r.admitDevice(t.device),{device:{identityKey:r.identityKey,haloSpaceKey:r.haloSpaceKey,genesisFeedKey:r.haloGenesisFeedKey,controlTimeframe:r.controlPipeline.state.timeframe}}}checkInvitation(e){try{if(this._getIdentity())return new AlreadyJoinedError("Currently only one identity per client is supported.")}catch{}}createIntroduction(){return{}}async createAdmissionRequest(e){const t=await this._keyring.createKey(),r=await this._keyring.createKey(),n=await this._keyring.createKey();return{device:{deviceKey:t,controlFeedKey:r,dataFeedKey:n,profile:e}}}async accept(e,t){invariant$1(e.device,void 0,{F:__dxlog_file5,L:95,S:this,A:["response.device",""]});const{identityKey:r,haloSpaceKey:n,genesisFeedKey:o,controlTimeframe:s}=e.device;invariant$1(t.device,void 0,{F:__dxlog_file5,L:98,S:this,A:["request.device",""]});const{deviceKey:a,controlFeedKey:c,dataFeedKey:l,profile:h}=t.device;return await this._acceptIdentity({identityKey:r,deviceKey:a,haloSpaceKey:n,haloGenesisFeedKey:o,controlFeedKey:c,dataFeedKey:l,controlTimeframe:s,deviceProfile:h}),{identityKey:r}}},stateToString=e=>{var t;return((t=Object.entries(Invitation.State).find(([r,n])=>n===e))==null?void 0:t[0])??"unknown"},tryAcquireBeforeContextDisposed=async(e,t)=>{let r;return cancelWithContext(e,(async()=>{if(r=await t.acquire(),e.disposed)throw r.release(),r=void 0,new ContextDisposedError;return r})())},__dxlog_file6="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/invitation-guest-extenstion.ts",OPTIONS_TIMEOUT=1e4,InvitationGuestExtension=class extends RpcExtension{constructor(e,t){super({requested:{InvitationHostService:schema.getService("dxos.halo.invitations.InvitationHostService")},exposed:{InvitationHostService:schema.getService("dxos.halo.invitations.InvitationHostService")}}),this._invitationFlowMutex=e,this._callbacks=t,this._ctx=new Context,this._remoteOptionsTrigger=new Trigger,this._invitationFlowLock=null}hasFlowLock(){return this._invitationFlowLock!=null}async getHandlers(){return{InvitationHostService:{options:async e=>{invariant$1(!this._remoteOptions,"Remote options already set.",{F:__dxlog_file6,L:63,S:this,A:["!this._remoteOptions","'Remote options already set.'"]}),this._remoteOptions=e,this._remoteOptionsTrigger.wake()},introduce:()=>{throw new Error("Method not allowed.")},authenticate:()=>{throw new Error("Method not allowed.")},admit:()=>{throw new Error("Method not allowed.")}}}}async onOpen(e){var t;await super.onOpen(e);try{if(log("guest acquire lock",void 0,{F:__dxlog_file6,L:84,S:this,C:(r,n)=>r(...n)}),this._invitationFlowLock=await tryAcquireBeforeContextDisposed(this._ctx,this._invitationFlowMutex),log("guest lock acquired",void 0,{F:__dxlog_file6,L:86,S:this,C:(r,n)=>r(...n)}),await cancelWithContext(this._ctx,this.rpc.InvitationHostService.options({role:Options.Role.GUEST})),log("options sent",void 0,{F:__dxlog_file6,L:88,S:this,C:(r,n)=>r(...n)}),await cancelWithContext(this._ctx,this._remoteOptionsTrigger.wait({timeout:OPTIONS_TIMEOUT})),log("options received",void 0,{F:__dxlog_file6,L:90,S:this,C:(r,n)=>r(...n)}),((t=this._remoteOptions)==null?void 0:t.role)!==Options.Role.HOST)throw new InvalidInvitationExtensionRoleError(void 0,{expected:Options.Role.HOST,remoteOptions:this._remoteOptions,remotePeerId:e.remotePeerId});this._callbacks.onOpen(this._ctx,e)}catch(r){this._invitationFlowLock!=null&&this._callbacks.onError(r),this._ctx.disposed||e.close(r)}}async onClose(){await this._destroy()}async onAbort(){await this._destroy()}async _destroy(){await this._ctx.dispose(),this._invitationFlowLock!=null&&(this._invitationFlowLock.release(),this._invitationFlowLock=null,log("invitation flow lock released",void 0,{F:__dxlog_file6,L:123,S:this,C:(e,t)=>e(...t)}))}},__dxlog_file7="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/invitation-host-extension.ts",OPTIONS_TIMEOUT2=1e4,MAX_OTP_ATTEMPTS=3,InvitationHostExtension=class extends RpcExtension{constructor(e,t){super({requested:{InvitationHostService:schema.getService("dxos.halo.invitations.InvitationHostService")},exposed:{InvitationHostService:schema.getService("dxos.halo.invitations.InvitationHostService")}}),this._invitationFlowMutex=e,this._callbacks=t,this._ctx=new Context,this._remoteOptionsTrigger=new Trigger,this._challenge=void 0,this.guestProfile=void 0,this.authenticationPassed=!1,this.authenticationRetry=0,this.completedTrigger=new Trigger,this._invitationFlowLock=null}hasFlowLock(){return this._invitationFlowLock!=null}async getHandlers(){return{InvitationHostService:{options:async e=>{invariant$1(!this._remoteOptions,"Remote options already set.",{F:__dxlog_file7,L:101,S:this,A:["!this._remoteOptions","'Remote options already set.'"]}),this._remoteOptions=e,this._remoteOptionsTrigger.wake()},introduce:async e=>{const{profile:t,invitationId:r}=e,n=PublicKey.random().toHex();log.trace("dxos.sdk.invitation-handler.host.introduce",trace$1.begin({id:n}),{F:__dxlog_file7,L:110,S:this,C:(s,a)=>s(...a)});const o=this._requireActiveInvitation();return this._assertInvitationState(Invitation.State.CONNECTED),r!==(o==null?void 0:o.invitationId)?(log.warn("incorrect invitationId",{expected:o.invitationId,actual:r},{F:__dxlog_file7,L:116,S:this,C:(s,a)=>s(...a)}),this._callbacks.onError(new Error("Incorrect invitationId.")),scheduleTask(this._ctx,()=>this.close()),{authMethod:Invitation.AuthMethod.NONE}):(log("guest introduced themselves",{guestProfile:t},{F:__dxlog_file7,L:125,S:this,C:(s,a)=>s(...a)}),this.guestProfile=t,this._callbacks.onStateUpdate(Invitation.State.READY_FOR_AUTHENTICATION),this._challenge=o.authMethod===Invitation.AuthMethod.KNOWN_PUBLIC_KEY?randomBytes$1(32):void 0,log.trace("dxos.sdk.invitation-handler.host.introduce",trace$1.end({id:n}),{F:__dxlog_file7,L:132,S:this,C:(s,a)=>s(...a)}),{authMethod:o.authMethod,challenge:this._challenge})},authenticate:async({authCode:e,signedChallenge:t})=>{const r=PublicKey.random().toHex();log.trace("dxos.sdk.invitation-handler.host.authenticate",trace$1.begin({id:r}),{F:__dxlog_file7,L:141,S:this,C:(s,a)=>s(...a)});const n=this._requireActiveInvitation();log("received authentication request",{authCode:e},{F:__dxlog_file7,L:144,S:this,C:(s,a)=>s(...a)});let o=AuthenticationResponse.Status.OK;switch(this._assertInvitationState([Invitation.State.AUTHENTICATING,Invitation.State.READY_FOR_AUTHENTICATION]),this._callbacks.onStateUpdate(Invitation.State.AUTHENTICATING),n.authMethod){case Invitation.AuthMethod.NONE:return log("authentication not required",void 0,{F:__dxlog_file7,L:152,S:this,C:(s,a)=>s(...a)}),{status:AuthenticationResponse.Status.OK};case Invitation.AuthMethod.SHARED_SECRET:{n.authCode&&(this.authenticationRetry++>MAX_OTP_ATTEMPTS?o=AuthenticationResponse.Status.INVALID_OPT_ATTEMPTS:e!==n.authCode?o=AuthenticationResponse.Status.INVALID_OTP:this.authenticationPassed=!0);break}case Invitation.AuthMethod.KNOWN_PUBLIC_KEY:{if(!n.guestKeypair){o=AuthenticationResponse.Status.INTERNAL_ERROR;break}this._challenge&&verify(this._challenge,export_Buffer.from(t??[]),n.guestKeypair.publicKey.asBuffer())?this.authenticationPassed=!0:o=AuthenticationResponse.Status.INVALID_SIGNATURE;break}default:{log.error("invalid authentication method",{authMethod:n.authMethod},{F:__dxlog_file7,L:190,S:this,C:(s,a)=>s(...a)}),o=AuthenticationResponse.Status.INTERNAL_ERROR;break}}return[AuthenticationResponse.Status.OK,AuthenticationResponse.Status.INVALID_OTP].includes(o)?(log.trace("dxos.sdk.invitation-handler.host.authenticate",trace$1.end({id:r,data:{status:o}}),{F:__dxlog_file7,L:202,S:this,C:(s,a)=>s(...a)}),{status:o}):(this._callbacks.onError(new Error(`Authentication failed, with status=${o}`)),scheduleTask(this._ctx,()=>this.close()),{status:o})},admit:async e=>{const t=PublicKey.random().toHex();log.trace("dxos.sdk.invitation-handler.host.admit",trace$1.begin({id:t}),{F:__dxlog_file7,L:208,S:this,C:(n,o)=>n(...o)});const r=this._requireActiveInvitation();try{if(isAuthenticationRequired(r)&&(this._assertInvitationState(Invitation.State.AUTHENTICATING),!this.authenticationPassed))throw new Error("Not authenticated");const n=await this._callbacks.admit(e);return log.trace("dxos.sdk.invitation-handler.host.admit",trace$1.end({id:t}),{F:__dxlog_file7,L:222,S:this,C:(o,s)=>o(...s)}),n}catch(n){throw this._callbacks.onError(n),n}}}}}async onOpen(e){var t;await super.onOpen(e);try{log("host acquire lock",void 0,{F:__dxlog_file7,L:237,S:this,C:(n,o)=>n(...o)}),this._invitationFlowLock=await tryAcquireBeforeContextDisposed(this._ctx,this._invitationFlowMutex),log("host lock acquired",void 0,{F:__dxlog_file7,L:239,S:this,C:(n,o)=>n(...o)});const r=this._requireActiveInvitation().state;if(this._callbacks.onStateUpdate(Invitation.State.CONNECTING),await this.rpc.InvitationHostService.options({role:Options.Role.HOST}),log("options sent",void 0,{F:__dxlog_file7,L:243,S:this,C:(n,o)=>n(...o)}),await cancelWithContext(this._ctx,this._remoteOptionsTrigger.wait({timeout:OPTIONS_TIMEOUT2})),log("options received",void 0,{F:__dxlog_file7,L:245,S:this,C:(n,o)=>n(...o)}),((t=this._remoteOptions)==null?void 0:t.role)!==Options.Role.GUEST)throw this._callbacks.onStateUpdate(r),new InvalidInvitationExtensionRoleError(void 0,{expected:Options.Role.GUEST,remoteOptions:this._remoteOptions,remotePeerId:e.remotePeerId});this._callbacks.onStateUpdate(Invitation.State.CONNECTED),this._callbacks.onOpen(this._ctx,e)}catch(r){this._invitationFlowLock!=null&&this._callbacks.onError(r),this._ctx.disposed||e.close(r)}}_requireActiveInvitation(){const e=this._callbacks.activeInvitation;if(e==null)throw scheduleTask(this._ctx,()=>this.close()),new Error("Active invitation not found");return e}_assertInvitationState(e){const t=this._requireActiveInvitation(),r=Array.isArray(e)?e:[e];if(!r.includes(t.state))throw scheduleTask(this._ctx,()=>this.close()),new InvariantViolation(`Expected ${stateToString(t.state)} to be one of [${r.map(stateToString).join(", ")}]`)}async onClose(){await this._destroy()}async onAbort(){await this._destroy()}async _destroy(){var e;await this._ctx.dispose(),this._invitationFlowLock!=null&&((e=this._invitationFlowLock)==null||e.release(),this._invitationFlowLock=null,log("invitation flow lock released",void 0,{F:__dxlog_file7,L:300,S:this,C:(t,r)=>t(...r)}))}},isAuthenticationRequired=e=>e.authMethod!==Invitation.AuthMethod.NONE,__dxlog_file8="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/invitation-topology.ts",InvitationTopology=class{constructor(e){this._role=e,this._seenPeers=new ComplexSet(PublicKey.hash)}init(e){invariant$1(!this._controller,"Already initialized.",{F:__dxlog_file8,L:42,S:this,A:["!this._controller","'Already initialized.'"]}),this._controller=e}update(){invariant$1(this._controller,"Not initialized.",{F:__dxlog_file8,L:47,S:this,A:["this._controller","'Not initialized.'"]});const{ownPeerId:e,candidates:t,connected:r,allPeers:n}=this._controller.getState();if(this._role===Options.Role.GUEST)return;if(r.length>0){r.forEach(s=>this._seenPeers.add(s));return}const o=t.find(s=>!this._seenPeers.has(s));this._seenPeers=new ComplexSet(PublicKey.hash,n.filter(s=>this._seenPeers.has(s))),o!=null&&(log("invitation connect",{ownPeerId:e,remotePeerId:o},{F:__dxlog_file8,L:69,S:this,C:(s,a)=>s(...a)}),this._controller.connect(o),this._seenPeers.add(o))}async onOffer(e){return invariant$1(this._controller,"Not initialized.",{F:__dxlog_file8,L:76,S:this,A:["this._controller","'Not initialized.'"]}),!this._seenPeers.has(e)}async destroy(){this._seenPeers.clear()}toString(){return`InvitationTopology(${this._role===Options.Role.GUEST?"guest":"host"})`}},__dxlog_file9="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/invitations-handler.ts",MAX_DELEGATED_INVITATION_HOST_TRIES=3,InvitationsHandler=class{constructor(e,t){this._networkManager=e,this._defaultTeleportParams=t}handleInvitationFlow(e,t,r,n){const o=this._createGuardedState(e,n,t),s=()=>{const c=new InvitationHostExtension(o.mutex,{get activeInvitation(){return e.disposed?null:o.current},onStateUpdate:l=>(o.set(c,l),o.current),admit:async l=>{var h,u;try{const d=((h=l.device)==null?void 0:h.deviceKey)??((u=l.space)==null?void 0:u.deviceKey);invariant$1(d,void 0,{F:__dxlog_file9,L:90,S:this,A:["deviceKey",""]});const f=await r.admit(n,l,c.guestProfile);return c.completedTrigger.wake(d),f}catch(d){throw o.error(c,d),d}},onOpen:(l,h)=>{let u=!1;l.onDispose(()=>{u||o.error(c,new ContextDisposedError)}),scheduleTask(l,async()=>{const d=PublicKey.random().toHex();try{log.trace("dxos.sdk.invitations-handler.host.onOpen",trace$1.begin({id:d}),{F:__dxlog_file9,L:115,S:this,C:(_,p)=>_(...p)}),log("connected",{...r.toJSON()},{F:__dxlog_file9,L:116,S:this,C:(_,p)=>_(...p)});const f=await c.completedTrigger.wait({timeout:n.timeout});log("admitted guest",{guest:f,...r.toJSON()},{F:__dxlog_file9,L:118,S:this,C:(_,p)=>_(...p)}),o.set(c,Invitation.State.SUCCESS),log.trace("dxos.sdk.invitations-handler.host.onOpen",trace$1.end({id:d}),{F:__dxlog_file9,L:120,S:this,C:(_,p)=>_(...p)}),u=!0,n.multiUse||await e.dispose()}catch(f){f instanceof TimeoutError$2?o.set(c,Invitation.State.TIMEOUT)&&log("timeout",{...r.toJSON()},{F:__dxlog_file9,L:129,S:this,C:(_,p)=>_(...p)}):o.error(c,f)&&log.error("failed",f,{F:__dxlog_file9,L:133,S:this,C:(_,p)=>_(...p)}),log.trace("dxos.sdk.invitations-handler.host.onOpen",trace$1.error({id:d,error:f}),{F:__dxlog_file9,L:136,S:this,C:(_,p)=>_(...p)}),h.close(f)}})},onError:l=>{if(l instanceof InvalidInvitationExtensionRoleError){log("invalid role",{...l.context},{F:__dxlog_file9,L:144,S:this,C:(h,u)=>h(...u)});return}l instanceof TimeoutError$2?o.set(c,Invitation.State.TIMEOUT)&&log("timeout",{err:l},{F:__dxlog_file9,L:149,S:this,C:(h,u)=>h(...u)}):o.error(c,l)&&log.error("failed",l,{F:__dxlog_file9,L:153,S:this,C:(h,u)=>h(...u)})}});return c};n.lifetime&&n.created&&(n.created.getTime()+n.lifetime*1e3<Date.now()?log.warn("invitation has already expired",void 0,{F:__dxlog_file9,L:164,S:this,C:(c,l)=>c(...l)}):scheduleTask(e,async()=>{await a.close(),o.set(null,Invitation.State.EXPIRED),await e.dispose()},n.created.getTime()+n.lifetime*1e3-Date.now()));let a;scheduleTask(e,async()=>{a=await this._joinSwarm(e,n,Options.Role.HOST,s),o.set(null,Invitation.State.CONNECTING)})}acceptInvitation(e,t,r,n,o,s){const{timeout:a=INVITATION_TIMEOUT}=n;s&&invariant$1(n.kind===Invitation.Kind.DEVICE,"deviceProfile provided for non-device invitation",{F:__dxlog_file9,L:197,S:this,A:["invitation.kind === Invitation.Kind.DEVICE","'deviceProfile provided for non-device invitation'"]});const c=new ComplexSet(PublicKey.hash),l=this._createGuardedState(e,n,t),h=f=>{const _=l.mutex.isLocked()&&!f.hasFlowLock();return log("should cancel invitation flow",{isLockedByAnotherConnection:_,invitationType:Invitation.Type.DELEGATED,triedPeers:c.size},{F:__dxlog_file9,L:205,S:this,C:(p,y)=>p(...y)}),_?!1:n.type!==Invitation.Type.DELEGATED||c.size>=MAX_DELEGATED_INVITATION_HOST_TRIES};let u=!1;const d=()=>{const f=new InvitationGuestExtension(l.mutex,{onStateUpdate:_=>{l.set(f,_)},onOpen:(_,p)=>{if(c.add(p.remotePeerId),u){p.close();return}_.onDispose(async()=>{log("extension disposed",{admitted:u,currentState:l.current.state},{F:__dxlog_file9,L:233,S:this,C:(y,w)=>y(...w)}),u||(l.error(f,new ContextDisposedError),h(f)&&await e.dispose())}),scheduleTask(_,async()=>{const y=PublicKey.random().toHex();try{log.trace("dxos.sdk.invitations-handler.guest.onOpen",trace$1.begin({id:y}),{F:__dxlog_file9,L:245,S:this,C:(P,U)=>P(...U)}),scheduleTask(_,()=>{l.set(f,Invitation.State.TIMEOUT),p.close()},a),log("connected",{...r.toJSON()},{F:__dxlog_file9,L:256,S:this,C:(P,U)=>P(...U)}),l.set(f,Invitation.State.CONNECTED),log("introduce",{...r.toJSON()},{F:__dxlog_file9,L:260,S:this,C:(P,U)=>P(...U)});const w=await f.rpc.InvitationHostService.introduce({invitationId:n.invitationId,...r.createIntroduction()});if(log("introduce response",{...r.toJSON(),response:w},{F:__dxlog_file9,L:265,S:this,C:(P,U)=>P(...U)}),n.authMethod=w.authMethod,isAuthenticationRequired(n))switch(n.authMethod){case Invitation.AuthMethod.SHARED_SECRET:await this._handleGuestOtpAuth(f,P=>l.set(f,P),o,{timeout:a});break;case Invitation.AuthMethod.KNOWN_PUBLIC_KEY:await this._handleGuestKpkAuth(f,P=>l.set(f,P),n,w);break}log("request admission",{...r.toJSON()},{F:__dxlog_file9,L:291,S:this,C:(P,U)=>P(...U)});const E=await r.createAdmissionRequest(s),x=await f.rpc.InvitationHostService.admit(E);u=!0;const B=await r.accept(x,E);log("admitted by host",{...r.toJSON()},{F:__dxlog_file9,L:302,S:this,C:(P,U)=>P(...U)}),await l.complete({...l.current,...B,state:Invitation.State.SUCCESS}),log.trace("dxos.sdk.invitations-handler.guest.onOpen",trace$1.end({id:y}),{F:__dxlog_file9,L:308,S:this,C:(P,U)=>P(...U)})}catch(w){w instanceof TimeoutError$2?(log("timeout",{...r.toJSON()},{F:__dxlog_file9,L:311,S:this,C:(E,x)=>E(...x)}),l.set(f,Invitation.State.TIMEOUT)):(log("auth failed",w,{F:__dxlog_file9,L:314,S:this,C:(E,x)=>E(...x)}),l.error(f,w)),p.close(w),log.trace("dxos.sdk.invitations-handler.guest.onOpen",trace$1.error({id:y,error:w}),{F:__dxlog_file9,L:318,S:this,C:(E,x)=>E(...x)})}})},onError:_=>{_ instanceof InvalidInvitationExtensionRoleError||(_ instanceof TimeoutError$2?(log("timeout",{...r.toJSON()},{F:__dxlog_file9,L:327,S:this,C:(p,y)=>p(...y)}),l.set(f,Invitation.State.TIMEOUT)):(log("auth failed",_,{F:__dxlog_file9,L:330,S:this,C:(p,y)=>p(...y)}),l.error(f,_)))}});return f};scheduleTask(e,async()=>{const f=r.checkInvitation(n);f?(t.error(f),await e.dispose()):(invariant$1(n.swarmKey,void 0,{F:__dxlog_file9,L:345,S:this,A:["invitation.swarmKey",""]}),await this._joinSwarm(e,n,Options.Role.GUEST,d),l.set(null,Invitation.State.CONNECTING))})}async _joinSwarm(e,t,r,n){var a;let o;r===Options.Role.GUEST?o="invitation guest":t.kind===Invitation.Kind.DEVICE?o="invitation host for device":o=`invitation host for space ${(a=t.spaceKey)==null?void 0:a.truncate()}`;const s=await this._networkManager.joinSwarm({topic:t.swarmKey,peerId:PublicKey.random(),protocolProvider:createTeleportProtocolFactory(async c=>{c.addExtension("dxos.halo.invitations",n())},this._defaultTeleportParams),topology:new InvitationTopology(r),label:o});return e.onDispose(()=>s.close()),s}_createGuardedState(e,t,r){const n=new Mutex;let o=null,s={...t};const a=c=>e.disposed||c!==null&&n.isLocked()&&!c.hasFlowLock()?!1:c==null||o!==c||this._isNotTerminal(s.state);return{mutex:n,get current(){return s},complete:c=>(s={...s,...c},r.next(s),e.dispose()),set:(c,l)=>a(c)?(this._logStateUpdate(s,c,l),s={...s,state:l},r.next(s),o=c,!0):!1,error:(c,l)=>a(c)?(this._logStateUpdate(s,c,Invitation.State.ERROR),s={...s,state:Invitation.State.ERROR},r.next(s),r.error(l),o=c,!0):!1}}_logStateUpdate(e,t,r){log("invitation state update",{actor:t==null?void 0:t.constructor.name,newState:stateToString(r),oldState:stateToString(e.state)},{F:__dxlog_file9,L:438,S:this,C:(n,o)=>n(...o)})}_isNotTerminal(e){return![Invitation.State.SUCCESS,Invitation.State.ERROR,Invitation.State.CANCELLED,Invitation.State.TIMEOUT,Invitation.State.EXPIRED].includes(e)}async _handleGuestOtpAuth(e,t,r,n){for(let o=1;o<=MAX_OTP_ATTEMPTS;o++){log("guest waiting for authentication code...",void 0,{F:__dxlog_file9,L:462,S:this,C:(c,l)=>c(...l)}),t(Invitation.State.READY_FOR_AUTHENTICATION);const s=await r.wait(n);log("sending authentication request",void 0,{F:__dxlog_file9,L:466,S:this,C:(c,l)=>c(...l)}),t(Invitation.State.AUTHENTICATING);const a=await e.rpc.InvitationHostService.authenticate({authCode:s});if(a.status===void 0||a.status===AuthenticationResponse.Status.OK)break;if(a.status===AuthenticationResponse.Status.INVALID_OTP){if(o===MAX_OTP_ATTEMPTS)throw new Error(`Maximum retry attempts: ${MAX_OTP_ATTEMPTS}`);log("retrying invalid code",{attempt:o},{F:__dxlog_file9,L:477,S:this,C:(c,l)=>c(...l)}),r.reset()}}}async _handleGuestKpkAuth(e,t,r,n){var a;if(((a=r.guestKeypair)==null?void 0:a.privateKey)==null)throw new Error("keypair missing in the invitation");if(n.challenge==null)throw new Error("challenge missing in the introduction");log("sending authentication request",void 0,{F:__dxlog_file9,L:496,S:this,C:(c,l)=>c(...l)}),t(Invitation.State.AUTHENTICATING);const o=sign(export_Buffer.from(n.challenge),r.guestKeypair.privateKey),s=await e.rpc.InvitationHostService.authenticate({signedChallenge:o});if(s.status!==AuthenticationResponse.Status.OK)throw new Error(`Authentication failed with code: ${s.status}`)}},createAdmissionKeypair=()=>{const e=createKeyPair();return{publicKey:PublicKey.from(e.publicKey),privateKey:e.secretKey}},InvitationsServiceImpl=class{constructor(e){this._invitationsManager=e}getLoggingContext(){return{}}createInvitation(e){return new Stream$2(({next:t,close:r})=>{this._invitationsManager.createInvitation(e).then(n=>n.subscribe(t,r,r)).catch(r)})}acceptInvitation(e){const t=this._invitationsManager.acceptInvitation(e);return new Stream$2(({next:r,close:n})=>{t.subscribe(r,n,n)})}async authenticate(e){return this._invitationsManager.authenticate(e)}async cancelInvitation(e){return this._invitationsManager.cancelInvitation(e)}queryInvitations(){return new Stream$2(({next:e,ctx:t})=>{this._invitationsManager.invitationCreated.on(t,r=>{e({action:QueryInvitationsResponse.Action.ADDED,type:QueryInvitationsResponse.Type.CREATED,invitations:[r]})}),this._invitationsManager.invitationAccepted.on(t,r=>{e({action:QueryInvitationsResponse.Action.ADDED,type:QueryInvitationsResponse.Type.ACCEPTED,invitations:[r]})}),this._invitationsManager.removedCreated.on(t,r=>{e({action:QueryInvitationsResponse.Action.REMOVED,type:QueryInvitationsResponse.Type.CREATED,invitations:[r]})}),this._invitationsManager.removedAccepted.on(t,r=>{e({action:QueryInvitationsResponse.Action.REMOVED,type:QueryInvitationsResponse.Type.ACCEPTED,invitations:[r]})}),this._invitationsManager.saved.on(t,r=>{e({action:QueryInvitationsResponse.Action.SAVED,type:QueryInvitationsResponse.Type.CREATED,invitations:[r]})}),e({action:QueryInvitationsResponse.Action.ADDED,type:QueryInvitationsResponse.Type.CREATED,invitations:this._invitationsManager.getCreatedInvitations(),existing:!0}),e({action:QueryInvitationsResponse.Action.ADDED,type:QueryInvitationsResponse.Type.ACCEPTED,invitations:this._invitationsManager.getAcceptedInvitations(),existing:!0}),this._invitationsManager.onPersistentInvitationsLoaded(t,()=>{e({action:QueryInvitationsResponse.Action.LOAD_COMPLETE,type:QueryInvitationsResponse.Type.CREATED})})})}},__dxlog_file10="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/space-invitation-protocol.ts",SpaceInvitationProtocol=class{constructor(e,t,r,n){this._spaceManager=e,this._signingContext=t,this._keyring=r,this._spaceKey=n}toJSON(){return{deviceKey:this._signingContext.deviceKey,spaceKey:this._spaceKey}}checkCanInviteNewMembers(){if(this._spaceKey==null)return new InvalidInvitationError("No spaceKey was provided for a space invitation.");const e=this._spaceManager.spaces.get(this._spaceKey);if(e==null)return new SpaceNotFoundError(this._spaceKey);if(!(e!=null&&e.inner.spaceState.hasMembershipManagementPermission(this._signingContext.identityKey)))return new AuthorizationError("No member management permission.")}getInvitationContext(){return{kind:Invitation.Kind.SPACE,spaceKey:this._spaceKey}}async admit(e,t,r){invariant$1(this._spaceKey,void 0,{F:__dxlog_file10,L:76,S:this,A:["this._spaceKey",""]});const n=this._spaceManager.spaces.get(this._spaceKey);invariant$1(n,void 0,{F:__dxlog_file10,L:78,S:this,A:["space",""]}),invariant$1(t.space,void 0,{F:__dxlog_file10,L:80,S:this,A:["request.space",""]});const{identityKey:o,deviceKey:s}=t.space;if(n.inner.spaceState.getMemberRole(o)!==SpaceMember.Role.REMOVED)throw new AlreadyJoinedError;log("writing guest credentials",{host:this._signingContext.deviceKey,guest:s},{F:__dxlog_file10,L:87,S:this,C:(l,h)=>l(...h)});const a=await createAdmissionCredentials(this._signingContext.credentialSigner,o,n.key,n.inner.genesisFeedKey,e.role??SpaceMember.Role.ADMIN,n.inner.spaceState.membershipChainHeads,r,e.delegationCredentialId);invariant$1(a[0].credential,void 0,{F:__dxlog_file10,L:101,S:this,A:["credentials[0].credential",""]});const c=a[0].credential.credential;return invariant$1(getCredentialAssertion(c)["@type"]==="dxos.halo.credentials.SpaceMember",void 0,{F:__dxlog_file10,L:103,S:this,A:["getCredentialAssertion(spaceMemberCredential)['@type'] === 'dxos.halo.credentials.SpaceMember'",""]}),await writeMessages(n.inner.controlPipeline.writer,a),{space:{credential:c,controlTimeframe:n.inner.controlPipeline.state.timeframe}}}async delegate(e){var n,o;invariant$1(this._spaceKey,void 0,{F:__dxlog_file10,L:116,S:this,A:["this._spaceKey",""]});const t=this._spaceManager.spaces.get(this._spaceKey);invariant$1(t,void 0,{F:__dxlog_file10,L:118,S:this,A:["space",""]}),e.authMethod===Invitation.AuthMethod.KNOWN_PUBLIC_KEY&&invariant$1((n=e.guestKeypair)==null?void 0:n.publicKey,void 0,{F:__dxlog_file10,L:120,S:this,A:["invitation.guestKeypair?.publicKey",""]}),log("writing delegate space invitation",{host:this._signingContext.deviceKey,id:e.invitationId},{F:__dxlog_file10,L:123,S:this,C:(s,a)=>s(...a)});const r=await createDelegatedSpaceInvitationCredential(this._signingContext.credentialSigner,t.key,{invitationId:e.invitationId,authMethod:e.authMethod,swarmKey:e.swarmKey,role:e.role??SpaceMember.Role.ADMIN,expiresOn:e.lifetime?new Date((((o=e.created)==null?void 0:o.getTime())??Date.now())+e.lifetime):void 0,multiUse:e.multiUse??!1,guestKey:e.authMethod===Invitation.AuthMethod.KNOWN_PUBLIC_KEY?e.guestKeypair.publicKey:void 0});return invariant$1(r.credential,void 0,{F:__dxlog_file10,L:143,S:this,A:["credential.credential",""]}),await writeMessages(t.inner.controlPipeline.writer,[r]),r.credential.credential.id}async cancelDelegation(e){invariant$1(this._spaceKey,void 0,{F:__dxlog_file10,L:149,S:this,A:["this._spaceKey",""]}),invariant$1(e.type===Invitation.Type.DELEGATED&&e.delegationCredentialId,void 0,{F:__dxlog_file10,L:150,S:this,A:["invitation.type === Invitation.Type.DELEGATED && invitation.delegationCredentialId",""]});const t=this._spaceManager.spaces.get(this._spaceKey);invariant$1(t,void 0,{F:__dxlog_file10,L:152,S:this,A:["space",""]}),log("cancelling delegated space invitation",{host:this._signingContext.deviceKey,id:e.invitationId},{F:__dxlog_file10,L:154,S:this,C:(n,o)=>n(...o)});const r=await createCancelDelegatedSpaceInvitationCredential(this._signingContext.credentialSigner,t.key,e.delegationCredentialId);invariant$1(r.credential,void 0,{F:__dxlog_file10,L:161,S:this,A:["credential.credential",""]}),await writeMessages(t.inner.controlPipeline.writer,[r])}checkInvitation(e){if(e.spaceKey==null)return new InvalidInvitationError("No spaceKey was provided for a space invitation.");if(this._spaceManager.spaces.has(e.spaceKey))return new AlreadyJoinedError("Already joined space.")}createIntroduction(){return{profile:this._signingContext.getProfile()}}async createAdmissionRequest(){const e=await this._keyring.createKey(),t=await this._keyring.createKey();return{space:{identityKey:this._signingContext.identityKey,deviceKey:this._signingContext.deviceKey,controlFeedKey:e,dataFeedKey:t}}}async accept(e){invariant$1(e.space,void 0,{F:__dxlog_file10,L:196,S:this,A:["response.space",""]});const{credential:t,controlTimeframe:r,dataTimeframe:n}=e.space,o=getCredentialAssertion(t);if(invariant$1(o["@type"]==="dxos.halo.credentials.SpaceMember","Invalid credential",{F:__dxlog_file10,L:199,S:this,A:["assertion['@type'] === 'dxos.halo.credentials.SpaceMember'","'Invalid credential'"]}),invariant$1(t.subject.id.equals(this._signingContext.identityKey),void 0,{F:__dxlog_file10,L:200,S:this,A:["credential.subject.id.equals(this._signingContext.identityKey)",""]}),this._spaceManager.spaces.has(o.spaceKey))throw new AlreadyJoinedError("Already joined space.");return await this._spaceManager.acceptSpace({spaceKey:o.spaceKey,genesisFeedKey:o.genesisFeedKey,controlTimeframe:r,dataTimeframe:n}),await this._signingContext.recordCredential(t),{spaceKey:o.spaceKey}}},__dxlog_file11="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/invitations/invitations-manager.ts",InvitationsManager=class{constructor(e,t,r){this._invitationsHandler=e,this._getHandler=t,this._metadataStore=r,this._createInvitations=new Map,this._acceptInvitations=new Map,this.invitationCreated=new Event$1,this.invitationAccepted=new Event$1,this.removedCreated=new Event$1,this.removedAccepted=new Event$1,this.saved=new Event$1,this._persistentInvitationsLoadedEvent=new Event$1,this._persistentInvitationsLoaded=!1}async createInvitation(e){if(e.invitationId){const c=this._createInvitations.get(e.invitationId);if(c)return c}const t=this._getHandler(e),r=t.checkCanInviteNewMembers();if(r!=null)throw r;const n=this._createInvitation(t,e),{ctx:o,stream:s,observableInvitation:a}=this._createObservableInvitation(t,n);this._createInvitations.set(n.invitationId,a),this.invitationCreated.emit(n),this._onInvitationComplete(a,async()=>{this._createInvitations.delete(a.get().invitationId),this.removedCreated.emit(a.get()),a.get().persistent&&await this._safeDeleteInvitation(a.get())});try{await this._persistIfRequired(t,s,n)}catch(c){return log.catch(c,void 0,{F:__dxlog_file11,L:82,S:this,C:(l,h)=>l(...h)}),await a.cancel(),a}return this._invitationsHandler.handleInvitationFlow(o,s,t,a.get()),a}async loadPersistentInvitations(){if(this._persistentInvitationsLoaded)return{invitations:this.getCreatedInvitations().filter(e=>e.persistent)};try{const e=this._metadataStore.getInvitations().filter(t=>!hasInvitationExpired(t)).map(t=>(invariant$1(!this._createInvitations.get(t.invitationId),"invitation already exists",{F:__dxlog_file11,L:103,S:this,A:["!this._createInvitations.get(persistentInvitation.invitationId)","'invitation already exists'"]}),this.createInvitation({...t,persistent:!1})));return{invitations:(await Promise.all(e)).map(t=>t.get())}}catch(e){return log.catch(e,void 0,{F:__dxlog_file11,L:110,S:this,C:(t,r)=>t(...r)}),{invitations:[]}}finally{this._persistentInvitationsLoadedEvent.emit(),this._persistentInvitationsLoaded=!0}}acceptInvitation(e){const t=e.invitation,r=this._acceptInvitations.get(t.invitationId);if(r)return r;const n=this._getHandler(t),{ctx:o,invitation:s,stream:a,otpEnteredTrigger:c}=this._createObservableAcceptingInvitation(n,t);return this._invitationsHandler.acceptInvitation(o,a,n,t,c,e.deviceProfile),this._acceptInvitations.set(s.get().invitationId,s),this.invitationAccepted.emit(s.get()),this._onInvitationComplete(s,()=>{this._acceptInvitations.delete(s.get().invitationId),this.removedAccepted.emit(s.get())}),s}async authenticate({invitationId:e,authCode:t}){log("authenticating...",void 0,{F:__dxlog_file11,L:140,S:this,C:(n,o)=>n(...o)}),invariant$1(e,void 0,{F:__dxlog_file11,L:141,S:this,A:["invitationId",""]});const r=this._acceptInvitations.get(e);r?await r.authenticate(t):log.warn("invalid invitation",{invitationId:e},{F:__dxlog_file11,L:144,S:this,C:(n,o)=>n(...o)})}async cancelInvitation({invitationId:e}){log("cancelInvitation...",{invitationId:e},{F:__dxlog_file11,L:151,S:this,C:(n,o)=>n(...o)}),invariant$1(e,void 0,{F:__dxlog_file11,L:152,S:this,A:["invitationId",""]});const t=this._createInvitations.get(e);if(t){t.get().persistent&&await this._metadataStore.removeInvitation(e),t.get().type===Invitation.Type.DELEGATED&&await this._getHandler(t.get()).cancelDelegation(t.get()),await t.cancel(),this._createInvitations.delete(e),this.removedCreated.emit(t.get());return}const r=this._acceptInvitations.get(e);r&&(await r.cancel(),this._acceptInvitations.delete(e),this.removedAccepted.emit(r.get()))}getCreatedInvitations(){return[...this._createInvitations.values()].map(e=>e.get())}getAcceptedInvitations(){return[...this._acceptInvitations.values()].map(e=>e.get())}onPersistentInvitationsLoaded(e,t){this._persistentInvitationsLoaded?t():this._persistentInvitationsLoadedEvent.once(e,()=>t())}_createInvitation(e,t){const{invitationId:r=PublicKey.random().toHex(),type:n=Invitation.Type.INTERACTIVE,authMethod:o=Invitation.AuthMethod.SHARED_SECRET,state:s=Invitation.State.INIT,timeout:a=INVITATION_TIMEOUT,swarmKey:c=PublicKey.random(),persistent:l=(t==null?void 0:t.authMethod)!==Invitation.AuthMethod.KNOWN_PUBLIC_KEY,created:h=new Date,guestKeypair:u=void 0,role:d=SpaceMember.Role.ADMIN,lifetime:f=86400,multiUse:_=!1}=t??{},p=(t==null?void 0:t.authCode)??(o===Invitation.AuthMethod.SHARED_SECRET?generatePasscode(AUTHENTICATION_CODE_LENGTH):void 0);return{invitationId:r,type:n,authMethod:o,state:s,swarmKey:c,authCode:p,timeout:a,persistent:l&&n!==Invitation.Type.DELEGATED,guestKeypair:u??(o===Invitation.AuthMethod.KNOWN_PUBLIC_KEY?createAdmissionKeypair():void 0),created:h,lifetime:f,role:d,multiUse:_,delegationCredentialId:t==null?void 0:t.delegationCredentialId,...e.getInvitationContext()}}_createObservableInvitation(e,t){const r=new PushStream$1,n=new Context({onError:s=>{r.error(s),n.dispose()}});n.onDispose(()=>{log("complete",{...e.toJSON()},{F:__dxlog_file11,L:241,S:this,C:(s,a)=>s(...a)}),r.complete()});const o=new CancellableInvitation({initialInvitation:t,subscriber:r.observable,onCancel:async()=>{r.next({...t,state:Invitation.State.CANCELLED}),await n.dispose()}});return{ctx:n,stream:r,observableInvitation:o}}_createObservableAcceptingInvitation(e,t){const r=new Trigger,n=new PushStream$1,o=new Context({onError:a=>{a instanceof TimeoutError$2?(log("timeout",{...e.toJSON()},{F:__dxlog_file11,L:261,S:this,C:(c,l)=>c(...l)}),n.next({...t,state:Invitation.State.TIMEOUT})):(log.warn("auth failed",a,{F:__dxlog_file11,L:264,S:this,C:(c,l)=>c(...l)}),n.next({...t,state:Invitation.State.ERROR})),o.dispose()}});o.onDispose(()=>{log("complete",{...e.toJSON()},{F:__dxlog_file11,L:271,S:this,C:(a,c)=>a(...c)}),n.complete()});const s=new AuthenticatingInvitation({initialInvitation:t,subscriber:n.observable,onCancel:async()=>{n.next({...t,state:Invitation.State.CANCELLED}),await o.dispose()},onAuthenticate:async a=>{r.wake(a)}});return{ctx:o,invitation:s,stream:n,otpEnteredTrigger:r}}async _persistIfRequired(e,t,r){if(r.type===Invitation.Type.DELEGATED&&r.delegationCredentialId==null){const n=await e.delegate(r);t.next({...r,delegationCredentialId:n})}else r.persistent&&(await this._metadataStore.addInvitation(r),this.saved.emit(r))}async _safeDeleteInvitation(e){try{await this._metadataStore.removeInvitation(e.invitationId)}catch(t){log.catch(t,void 0,{F:__dxlog_file11,L:307,S:this,C:(r,n)=>r(...n)})}}_onInvitationComplete(e,t){e.subscribe(()=>{},()=>{},t)}};function _ts_decorate3(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var ClientRpcServer=class{constructor(e){this._handlerCache=new Map,this._callMetrics=new MapCounter;const{serviceRegistry:t,handleCall:r,handleStream:n,...o}=e;this._handleCall=r,this._handleStream=n,this._serviceRegistry=t,this._rpcPeer=new RpcPeer({...o,callHandler:(s,a)=>{const[c,l]=parseMethodName(s),h=(u,d)=>this._getServiceHandler(c).call(u,d);return this._callMetrics.inc(`${c}.${l} request`),this._handleCall?this._handleCall(l,a,h):h(l,a)},streamHandler:(s,a)=>{const[c,l]=parseMethodName(s),h=(u,d)=>this._getServiceHandler(c).callStream(u,d);return this._callMetrics.inc(`${c}.${l} request stream`),this._handleStream?Stream$2.map(Stream$2.unwrapPromise(this._handleStream(l,a,h)),u=>(this._callMetrics.inc(`${c}.${l} response stream`),u)):h(l,a)}})}get _services(){return Object.keys(this._serviceRegistry.services)}async open(){await this._rpcPeer.open()}async close(){await this._rpcPeer.close()}_getServiceHandler(e){if(!this._handlerCache.has(e)){const[t,r]=Object.entries(this._serviceRegistry.descriptors).find(([o,s])=>s.name===e)??raise$1(new Error(`Service not available: ${e}`)),n=this._serviceRegistry.services[t];if(!n)throw new Error(`Service not available: ${e}`);this._handlerCache.set(e,r.createServer(n))}return this._handlerCache.get(e)}};_ts_decorate3([trace.metricsCounter()],ClientRpcServer.prototype,"_callMetrics",void 0),_ts_decorate3([trace.info()],ClientRpcServer.prototype,"_services",null),ClientRpcServer=_ts_decorate3([trace.resource()],ClientRpcServer);var AutomergeSpaceState=class{constructor(e){this._onNewRoot=e,this.rootUrl=void 0,this.lastEpoch=void 0,this.onNewEpoch=new Event$1,this._isProcessingRootDocs=!1}async processCredential(e){checkCredentialType(e,"dxos.halo.credentials.Epoch")&&(this.lastEpoch=e,e.subject.assertion.automergeRoot&&(this.rootUrl=e.subject.assertion.automergeRoot,this._isProcessingRootDocs&&this._onNewRoot(this.rootUrl)),this.onNewEpoch.emit(e))}startProcessingRootDocs(){this._isProcessingRootDocs||(this.rootUrl&&this._onNewRoot(this.rootUrl),this._isProcessingRootDocs=!0)}async ensureEpochInitialized(){await this.onNewEpoch.waitForCondition(()=>!!this.lastEpoch)}},__dxlog_file12="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/spaces/notarization-plugin.ts",DEFAULT_RETRY_TIMEOUT=1e3,DEFAULT_SUCCESS_DELAY=1e3,DEFAULT_NOTARIZE_TIMEOUT=1e4,WRITER_NOT_SET_ERROR_CODE="WRITER_NOT_SET",NotarizationPlugin=class{constructor(){this._ctx=new Context,this._extensionOpened=new Event$1,this._extensions=new Set,this._processedCredentials=new ComplexSet(PublicKey.hash),this._processCredentialsTriggers=new ComplexMap(PublicKey.hash)}get hasWriter(){return!!this._writer}async open(){}async close(){await this._ctx.dispose()}async notarize({ctx:e,credentials:t,timeout:r=DEFAULT_NOTARIZE_TIMEOUT,retryTimeout:n=DEFAULT_RETRY_TIMEOUT,successDelay:o=DEFAULT_SUCCESS_DELAY}){log("notarize",{credentials:t},{F:__dxlog_file12,L:90,S:this,C:(u,d)=>u(...d)}),invariant$1(t.every(u=>u.id),"Credentials must have an id",{F:__dxlog_file12,L:91,S:this,A:["credentials.every((credential) => credential.id)","'Credentials must have an id'"]});const s=new Trigger,a=this._ctx.derive({onError:u=>{log.warn("Notarization error",{err:u},{F:__dxlog_file12,L:99,S:this,C:(d,f)=>d(...f)}),a.dispose(),s.throw(u)}});e==null||e.onDispose(()=>a.dispose()),r!==0&&scheduleTask(a,()=>{log.warn("Notarization timeout",{timeout:r,peers:Array.from(this._extensions).map(u=>u.remotePeerId)},{F:__dxlog_file12,L:111,S:this,C:(u,d)=>u(...d)}),a.dispose(),s.throw(new TimeoutError$2(r,"Notarization timed out"))},r);const c=Promise.all(t.map(u=>this._waitUntilProcessed(u.id))),l=new Set,h=new DeferredTask(a,async()=>{try{if(this._extensions.size===0)return;const u=[...this._extensions].find(d=>!l.has(d));if(!u){log.info("Exhausted all peers to notarize with",{retryIn:n},{F:__dxlog_file12,L:136,S:this,C:(d,f)=>d(...f)}),l.clear(),scheduleTask(a,()=>h.schedule(),n);return}l.add(u),log("try notarizing",{peer:u.localPeerId,credentialId:t.map(d=>d.id)},{F:__dxlog_file12,L:143,S:this,C:(d,f)=>d(...f)}),await u.rpc.NotarizationService.notarize({credentials:t.filter(d=>!this._processedCredentials.has(d.id))}),log("success",void 0,{F:__dxlog_file12,L:147,S:this,C:(d,f)=>d(...f)}),await sleep(o)}catch(u){!a.disposed&&!u.message.includes(WRITER_NOT_SET_ERROR_CODE)&&log.info("error notarizing (recoverable)",u,{F:__dxlog_file12,L:151,S:this,C:(d,f)=>d(...f)}),h.schedule()}});h.schedule(),this._extensionOpened.on(a,()=>h.schedule());try{await Promise.race([rejectOnDispose(a),c,s.wait()]),log("done",void 0,{F:__dxlog_file12,L:162,S:this,C:(u,d)=>u(...d)})}finally{await a.dispose()}}async processCredential(e){var t;e.id&&((t=this._processCredentialsTriggers.get(e.id))==null||t.wake(),this._processedCredentials.add(e.id),this._processCredentialsTriggers.delete(e.id))}setWriter(e){invariant$1(!this._writer,"Writer already set.",{F:__dxlog_file12,L:181,S:this,A:["!this._writer","'Writer already set.'"]}),this._writer=e}async _waitUntilProcessed(e){this._processedCredentials.has(e)||await entry(this._processCredentialsTriggers,e).orInsert(new Trigger).value.wait()}async _onNotarize(e){if(!this._writer)throw new Error(WRITER_NOT_SET_ERROR_CODE);for(const t of e.credentials??[])invariant$1(t.id,"Credential must have an id",{F:__dxlog_file12,L:200,S:this,A:["credential.id","'Credential must have an id'"]}),!this._processedCredentials.has(t.id)&&await this._writer.write(t)}createExtension(){const e=new NotarizationTeleportExtension({onOpen:async()=>{log("extension opened",{peer:e.localPeerId},{F:__dxlog_file12,L:211,S:this,C:(t,r)=>t(...r)}),this._extensions.add(e),this._extensionOpened.emit()},onClose:async()=>{log("extension closed",{peer:e.localPeerId},{F:__dxlog_file12,L:216,S:this,C:(t,r)=>t(...r)}),this._extensions.delete(e)},onNotarize:this._onNotarize.bind(this)});return e}},NotarizationTeleportExtension=class extends RpcExtension{constructor(e){super({requested:{NotarizationService:schema.getService("dxos.mesh.teleport.notarization.NotarizationService")},exposed:{NotarizationService:schema.getService("dxos.mesh.teleport.notarization.NotarizationService")}}),this._params=e}async getHandlers(){return{NotarizationService:{notarize:async e=>{await this._params.onNotarize(e)}}}}async onOpen(e){await super.onOpen(e),await this._params.onOpen()}async onClose(e){await this._params.onClose(),await super.onClose(e)}};function _ts_decorate4(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file13="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/spaces/data-space.ts",DataSpace=class{constructor(e){this._ctx=new Context,this._notarizationPlugin=new NotarizationPlugin,this._cache=void 0,this._automergeSpaceState=new AutomergeSpaceState(t=>this._onNewAutomergeRoot(t)),this._state=SpaceState.CLOSED,this.error=void 0,this.stateUpdate=new Event$1,this.metrics={},this._inner=e.inner,this._inner.stateUpdate.on(this._ctx,()=>this.stateUpdate.emit()),this._gossip=e.gossip,this._presence=e.presence,this._keyring=e.keyring,this._feedStore=e.feedStore,this._metadataStore=e.metadataStore,this._signingContext=e.signingContext,this._callbacks=e.callbacks??{},this._echoHost=e.echoHost,this.authVerifier=new TrustedKeySetAuthVerifier({trustedKeysProvider:()=>new ComplexSet(PublicKey.hash,Array.from(this._inner.spaceState.members.values()).filter(t=>t.role!==SpaceMember.Role.REMOVED).map(t=>t.key)),update:this._inner.stateUpdate,authTimeout:AUTH_TIMEOUT}),this._cache=e.cache,this._state=e.initialState,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:141,S:this,C:(t,r)=>t(...r)})}get key(){return this._inner.key}get isOpen(){return this._inner.isOpen}get state(){return this._state}get inner(){return this._inner}get presence(){return this._presence}get notarizationPlugin(){return this._notarizationPlugin}get cache(){return this._cache}get automergeSpaceState(){return this._automergeSpaceState}get _automergeInfo(){return{rootUrl:this._automergeSpaceState.rootUrl,lastEpoch:this._automergeSpaceState.lastEpoch}}async open(){await this._open()}async _open(){await this._gossip.open(),await this._notarizationPlugin.open(),await this._inner.spaceState.addCredentialProcessor(this._notarizationPlugin),await this._inner.spaceState.addCredentialProcessor(this._automergeSpaceState),await this._inner.open(new Context),this._state=SpaceState.CONTROL_ONLY,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:199,S:this,C:(e,t)=>e(...t)}),this.stateUpdate.emit(),this.metrics={},this.metrics.open=new Date}async close(){await this._close()}async _close(){var e,t;await((t=(e=this._callbacks).beforeClose)==null?void 0:t.call(e)),this._state=SpaceState.CLOSED,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:213,S:this,C:(r,n)=>r(...n)}),await this._ctx.dispose(),this._ctx=new Context,await this.authVerifier.close(),await this._inner.close(),await this._inner.spaceState.removeCredentialProcessor(this._automergeSpaceState),await this._inner.spaceState.removeCredentialProcessor(this._notarizationPlugin),await this._notarizationPlugin.close(),await this._presence.destroy(),await this._gossip.close()}async postMessage(e,t){return this._gossip.postMessage(e,t)}listen(e,t){return this._gossip.listen(e,t)}initializeDataPipelineAsync(){scheduleTask(this._ctx,async()=>{try{this.metrics.pipelineInitBegin=new Date,await this.initializeDataPipeline()}catch(e){if(e instanceof CancelledError||e instanceof ContextDisposedError){log("data pipeline initialization cancelled",e,{F:__dxlog_file13,L:246,S:this,C:(t,r)=>t(...r)});return}log.error("Error initializing data pipeline",e,{F:__dxlog_file13,L:250,S:this,C:(t,r)=>t(...r)}),this._state=SpaceState.ERROR,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:252,S:this,C:(t,r)=>t(...r)}),this.error=e,this.stateUpdate.emit()}finally{this.metrics.ready=new Date}})}async initializeDataPipeline(){var e,t,r,n;if(this._state!==SpaceState.CONTROL_ONLY)throw new SystemError("Invalid operation");this._state=SpaceState.INITIALIZING,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:268,S:this,C:(o,s)=>o(...s)}),await this._initializeAndReadControlPipeline(),await sleep(1),this._automergeSpaceState.startProcessingRootDocs(),await cancelWithContext(this._ctx,this.automergeSpaceState.ensureEpochInitialized()),log("data pipeline ready",void 0,{F:__dxlog_file13,L:280,S:this,C:(o,s)=>o(...s)}),await((t=(e=this._callbacks).beforeReady)==null?void 0:t.call(e)),this._state=SpaceState.READY,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:284,S:this,C:(o,s)=>o(...s)}),this.stateUpdate.emit(),await((n=(r=this._callbacks).afterReady)==null?void 0:n.call(r))}async _initializeAndReadControlPipeline(){await this._inner.controlPipeline.state.waitUntilReachedTargetTimeframe({ctx:this._ctx,breakOnStall:!1}),this.metrics.controlPipelineReady=new Date,await this._createWritableFeeds(),log("writable feeds created",void 0,{F:__dxlog_file13,L:300,S:this,C:(e,t)=>e(...t)}),this.stateUpdate.emit(),this.notarizationPlugin.hasWriter||this.notarizationPlugin.setWriter(createMappedFeedWriter(e=>({credential:{credential:e}}),this._inner.controlPipeline.writer))}async _createWritableFeeds(){const e=[];if(!this.inner.controlFeedKey){const t=await this._feedStore.openFeed(await this._keyring.createKey(),{writable:!0});await this.inner.setControlFeed(t),e.push(await this._signingContext.credentialSigner.createCredential({subject:t.key,assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:this.key,deviceKey:this._signingContext.deviceKey,identityKey:this._signingContext.identityKey,designation:AdmittedFeed.Designation.CONTROL}}))}if(!this.inner.dataFeedKey){const t=await this._feedStore.openFeed(await this._keyring.createKey(),{writable:!0,sparse:!0});await this.inner.setDataFeed(t),e.push(await this._signingContext.credentialSigner.createCredential({subject:t.key,assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:this.key,deviceKey:this._signingContext.deviceKey,identityKey:this._signingContext.identityKey,designation:AdmittedFeed.Designation.DATA}}))}e.length>0&&(await this.notarizationPlugin.notarize({ctx:this._ctx,credentials:e,timeout:0}),await this._metadataStore.setWritableFeedKeys(this.key,this.inner.controlFeedKey,this.inner.dataFeedKey))}_onNewAutomergeRoot(e){log("loading automerge root doc for space",{space:this.key,rootUrl:e},{F:__dxlog_file13,L:366,S:this,C:(r,n)=>r(...n)}),this._echoHost.replicateDocument(e);const t=this._echoHost.automergeRepo.find(e);queueMicrotask(async()=>{var r;try{if(await warnAfterTimeout(5e3,"Automerge root doc load timeout (DataSpace)",async()=>{await cancelWithContext(this._ctx,t.whenReady())}),this._ctx.disposed)return;(r=(t.docSync()??failedInvariant()).access)!=null&&r.spaceKey||t.change(n=>{n.access={spaceKey:this.key.toHex()}}),this._echoHost.roots.has(t.documentId)?log.warn("echo database root already exists",{space:this.key,rootUrl:e},{F:__dxlog_file13,L:393,S:this,C:(n,o)=>n(...o)}):await this._echoHost.openSpaceRoot(t.url)}catch(n){if(n instanceof ContextDisposedError)return;log.warn("error loading automerge root doc",{space:this.key,rootUrl:e,err:n},{F:__dxlog_file13,L:399,S:this,C:(o,s)=>o(...s)})}})}async updateOwnProfile(e){const t=await this._signingContext.credentialSigner.createCredential({subject:this._signingContext.identityKey,assertion:{"@type":"dxos.halo.credentials.MemberProfile",profile:e}});await this.inner.controlPipeline.writer.write({credential:{credential:t}})}async createEpoch(e){var n,o,s,a,c,l,h,u,d,f,_,p,y,w;let t;switch(e==null?void 0:e.migration){case void 0:case CreateEpochRequest.Migration.NONE:t={previousId:(n=this._automergeSpaceState.lastEpoch)==null?void 0:n.id,number:(((o=this._automergeSpaceState.lastEpoch)==null?void 0:o.subject.assertion.number)??-1)+1,timeframe:((s=this._automergeSpaceState.lastEpoch)==null?void 0:s.subject.assertion.timeframe)??new Timeframe,automergeRoot:(c=(a=this._automergeSpaceState.lastEpoch)==null?void 0:a.subject.assertion)==null?void 0:c.automergeRoot};break;case CreateEpochRequest.Migration.INIT_AUTOMERGE:{const E=this._echoHost.automergeRepo.create();t={previousId:(l=this._automergeSpaceState.lastEpoch)==null?void 0:l.id,number:(((h=this._automergeSpaceState.lastEpoch)==null?void 0:h.subject.assertion.number)??-1)+1,timeframe:((u=this._automergeSpaceState.lastEpoch)==null?void 0:u.subject.assertion.timeframe)??new Timeframe,automergeRoot:E.url}}break;case CreateEpochRequest.Migration.PRUNE_AUTOMERGE_ROOT_HISTORY:{const E=this._automergeSpaceState.rootUrl,x=this._echoHost.automergeRepo.find(E);await cancelWithContext(this._ctx,asyncTimeout(x.whenReady(),1e4));const B=this._echoHost.automergeRepo.create(x.docSync());invariant$1(typeof B.url=="string"&&B.url.length>0,void 0,{F:__dxlog_file13,L:449,S:this,A:["typeof newRoot.url === 'string' && newRoot.url.length > 0",""]}),t={previousId:(d=this._automergeSpaceState.lastEpoch)==null?void 0:d.id,number:(((f=this._automergeSpaceState.lastEpoch)==null?void 0:f.subject.assertion.number)??-1)+1,timeframe:((_=this._automergeSpaceState.lastEpoch)==null?void 0:_.subject.assertion.timeframe)??new Timeframe,automergeRoot:B.url}}break;case CreateEpochRequest.Migration.FRAGMENT_AUTOMERGE_ROOT:{log.info("Fragmenting",void 0,{F:__dxlog_file13,L:461,S:this,C:(te,J)=>te(...J)});const E=this._automergeSpaceState.rootUrl,x=this._echoHost.automergeRepo.find(E);await cancelWithContext(this._ctx,asyncTimeout(x.whenReady(),1e4));const B=Object.entries(x.docSync().objects),P=findPropertiesObject(x.docSync()),U=B.filter(([te])=>te!==(P==null?void 0:P[0]));invariant$1(P,"Properties not found",{F:__dxlog_file13,L:471,S:this,A:["properties","'Properties not found'"]});const F={...x.docSync(),objects:Object.fromEntries([P])},G=this._echoHost.automergeRepo.create(F);invariant$1(typeof G.url=="string"&&G.url.length>0,void 0,{F:__dxlog_file13,L:476,S:this,A:["typeof newRoot.url === 'string' && newRoot.url.length > 0",""]});const H=new AutomergeDocumentLoaderImpl(this.key,this._echoHost.automergeRepo);await H.loadSpaceRootDocHandle(this._ctx,{rootUrl:G.url}),U.forEach(([te,J])=>{H.createDocumentForObject(te).change(le=>{assignDeep(le,["objects",te],J)})}),t={previousId:(p=this._automergeSpaceState.lastEpoch)==null?void 0:p.id,number:(((y=this._automergeSpaceState.lastEpoch)==null?void 0:y.subject.assertion.number)??-1)+1,timeframe:((w=this._automergeSpaceState.lastEpoch)==null?void 0:w.subject.assertion.timeframe)??new Timeframe,automergeRoot:G.url}}break}if(!t)return;const r=await this.inner.controlPipeline.writer.write({credential:{credential:await this._signingContext.credentialSigner.createCredential({subject:this.key,assertion:{"@type":"dxos.halo.credentials.Epoch",...t}})}});await this.inner.controlPipeline.state.waitUntilTimeframe(new Timeframe([[r.feedKey,r.seq]]))}async activate(){this._state===SpaceState.INACTIVE&&(await this._metadataStore.setSpaceState(this.key,SpaceState.ACTIVE),await this._open(),this.initializeDataPipelineAsync())}async deactivate(){this._state!==SpaceState.INACTIVE&&(await this._metadataStore.setSpaceState(this.key,SpaceState.INACTIVE),await this._close(),this._state=SpaceState.INACTIVE,log("new state",{state:SpaceState[this._state]},{F:__dxlog_file13,L:542,S:this,C:(e,t)=>e(...t)}),this.stateUpdate.emit())}};_ts_decorate4([trace.info()],DataSpace.prototype,"_inner",void 0),_ts_decorate4([trace.info()],DataSpace.prototype,"key",null),_ts_decorate4([trace.info({enum:SpaceState})],DataSpace.prototype,"state",null),_ts_decorate4([trace.info({depth:null})],DataSpace.prototype,"_automergeInfo",null),_ts_decorate4([synchronized],DataSpace.prototype,"open",null),_ts_decorate4([synchronized],DataSpace.prototype,"close",null),_ts_decorate4([trace.span({showInBrowserTimeline:!0})],DataSpace.prototype,"initializeDataPipeline",null),_ts_decorate4([trace.span({showInBrowserTimeline:!0})],DataSpace.prototype,"_initializeAndReadControlPipeline",null),_ts_decorate4([timed(1e4)],DataSpace.prototype,"_createWritableFeeds",null),_ts_decorate4([synchronized],DataSpace.prototype,"activate",null),_ts_decorate4([synchronized],DataSpace.prototype,"deactivate",null),DataSpace=_ts_decorate4([trackLeaks("open","close"),trace.resource()],DataSpace);var findPropertiesObject=e=>{var t;for(const r in e.objects??{}){const n=e.objects[r];if(((t=n.system.type)==null?void 0:t.itemId)===TYPE_PROPERTIES)return[r,n]}},spaceGenesis=async(e,t,r,n)=>{const o=[await createCredential({signer:e,issuer:r.key,subject:r.key,assertion:{"@type":"dxos.halo.credentials.SpaceGenesis",spaceKey:r.key}}),await createCredential({signer:e,issuer:r.key,subject:t.identityKey,assertion:{"@type":"dxos.halo.credentials.SpaceMember",spaceKey:r.key,role:SpaceMember.Role.OWNER,profile:t.getProfile(),genesisFeedKey:r.controlFeedKey??failUndefined()}}),await t.credentialSigner.createCredential({subject:r.controlFeedKey??failUndefined(),assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:r.key,identityKey:t.identityKey,deviceKey:t.deviceKey,designation:AdmittedFeed.Designation.CONTROL}}),await t.credentialSigner.createCredential({subject:r.dataFeedKey??failUndefined(),assertion:{"@type":"dxos.halo.credentials.AdmittedFeed",spaceKey:r.key,identityKey:t.identityKey,deviceKey:t.deviceKey,designation:AdmittedFeed.Designation.DATA}}),await t.credentialSigner.createCredential({subject:r.key??failUndefined(),assertion:{"@type":"dxos.halo.credentials.Epoch",number:0,previousId:void 0,timeframe:new Timeframe,snapshotCid:void 0,automergeRoot:n}})];for(const s of o)await r.controlPipeline.writer.write({credential:{credential:s}});return o};function _ts_decorate5(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file14="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/spaces/data-space-manager.ts",PRESENCE_ANNOUNCE_INTERVAL=1e4,PRESENCE_OFFLINE_TIMEOUT=2e4,DataSpaceManager=class{constructor(e,t,r,n,o,s,a,c){this._spaceManager=e,this._metadataStore=t,this._keyring=r,this._signingContext=n,this._feedStore=o,this._echoHost=s,this._invitationsManager=a,this._ctx=new Context,this.updated=new Event$1,this._spaces=new ComplexMap(PublicKey.hash),this._isOpen=!1,this._instanceId=PublicKey.random().toHex();const{spaceMemberPresenceAnnounceInterval:l=PRESENCE_ANNOUNCE_INTERVAL,spaceMemberPresenceOfflineTimeout:h=PRESENCE_OFFLINE_TIMEOUT}=c??{};this._spaceMemberPresenceAnnounceInterval=l,this._spaceMemberPresenceOfflineTimeout=h,trace.diagnostic({id:"spaces",name:"Spaces",fetch:async()=>Array.from(this._spaces.values()).map(u=>{var p;const d=u.automergeSpaceState.rootUrl,f=(p=d?this._echoHost.automergeRepo.find(d):void 0)==null?void 0:p.docSync(),_=f&&findPropertiesObject(f);return{key:u.key.toHex(),state:SpaceState[u.state],name:(_==null?void 0:_[1].data.name)??null,inlineObjects:f?Object.keys(f.objects??{}).length:null,linkedObjects:f?Object.keys(f.links??{}).length:null,credentials:u.inner.spaceState.credentials.length,members:u.inner.spaceState.members.size,rootUrl:d}})})}get spaces(){return this._spaces}async open(){log("open",void 0,{F:__dxlog_file14,L:144,S:this,C:(e,t)=>e(...t)}),log.trace("dxos.echo.data-space-manager.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file14,L:145,S:this,C:(e,t)=>e(...t)}),log("metadata loaded",{spaces:this._metadataStore.spaces.length},{F:__dxlog_file14,L:146,S:this,C:(e,t)=>e(...t)}),await forEachAsync(this._metadataStore.spaces,async e=>{try{log("load space",{spaceMetadata:e},{F:__dxlog_file14,L:150,S:this,C:(t,r)=>t(...r)}),await this._constructSpace(e)}catch(t){log.error("Error loading space",{spaceMetadata:e,err:t},{F:__dxlog_file14,L:153,S:this,C:(r,n)=>r(...n)})}}),this._isOpen=!0,this.updated.emit();for(const e of this._spaces.values())e.state!==SpaceState.INACTIVE&&e.initializeDataPipelineAsync();log.trace("dxos.echo.data-space-manager.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file14,L:166,S:this,C:(e,t)=>e(...t)})}async close(){log("close",void 0,{F:__dxlog_file14,L:171,S:this,C:(e,t)=>e(...t)}),this._isOpen=!1,await this._ctx.dispose();for(const e of this._spaces.values())await e.close()}async createSpace(){invariant$1(this._isOpen,"Not open.",{F:__dxlog_file14,L:184,S:this,A:["this._isOpen","'Not open.'"]});const e=await this._keyring.createKey(),t=await this._keyring.createKey(),r=await this._keyring.createKey(),n={key:e,genesisFeedKey:t,controlFeedKey:t,dataFeedKey:r,state:SpaceState.ACTIVE};log("creating space...",{spaceKey:e},{F:__dxlog_file14,L:196,S:this,C:(l,h)=>l(...h)});const o=await this._echoHost.createSpaceRoot(e),s=await this._constructSpace(n),a=await spaceGenesis(this._keyring,this._signingContext,s.inner,o.url);await this._metadataStore.addSpace(n);const c=a[1];return invariant$1(getCredentialAssertion(c)["@type"]==="dxos.halo.credentials.SpaceMember",void 0,{F:__dxlog_file14,L:205,S:this,A:["getCredentialAssertion(memberCredential)['@type'] === 'dxos.halo.credentials.SpaceMember'",""]}),await this._signingContext.recordCredential(c),await s.initializeDataPipeline(),this.updated.emit(),s}async acceptSpace(e){log("accept space",{opts:e},{F:__dxlog_file14,L:217,S:this,C:(n,o)=>n(...o)}),invariant$1(this._isOpen,"Not open.",{F:__dxlog_file14,L:218,S:this,A:["this._isOpen","'Not open.'"]}),invariant$1(!this._spaces.has(e.spaceKey),"Space already exists.",{F:__dxlog_file14,L:219,S:this,A:["!this._spaces.has(opts.spaceKey)","'Space already exists.'"]});const t={key:e.spaceKey,genesisFeedKey:e.genesisFeedKey,controlTimeframe:e.controlTimeframe,dataTimeframe:e.dataTimeframe},r=await this._constructSpace(t);return await this._metadataStore.addSpace(t),r.initializeDataPipelineAsync(),this.updated.emit(),r}async waitUntilSpaceReady(e){await cancelWithContext(this._ctx,this.updated.waitForCondition(()=>{const t=this._spaces.get(e);return!!t&&t.state===SpaceState.READY}))}async _constructSpace(e){log("construct space",{metadata:e},{F:__dxlog_file14,L:252,S:this,C:(c,l)=>c(...l)});const t=new Gossip({localPeerId:this._signingContext.deviceKey}),r=new Presence({announceInterval:this._spaceMemberPresenceAnnounceInterval,offlineTimeout:this._spaceMemberPresenceOfflineTimeout,identityKey:this._signingContext.identityKey,gossip:t}),n=e.controlFeedKey&&await this._feedStore.openFeed(e.controlFeedKey,{writable:!0}),o=e.dataFeedKey&&await this._feedStore.openFeed(e.dataFeedKey,{writable:!0,sparse:!0}),s=await this._spaceManager.constructSpace({metadata:e,swarmIdentity:{peerKey:this._signingContext.deviceKey,credentialProvider:createAuthProvider(this._signingContext.credentialSigner),credentialAuthenticator:deferFunction(()=>a.authVerifier.verifier)},onAuthorizedConnection:c=>{c.addExtension("dxos.mesh.teleport.gossip",t.createExtension({remotePeerId:c.remotePeerId})),c.addExtension("dxos.mesh.teleport.notarization",a.notarizationPlugin.createExtension()),this._echoHost.authorizeDevice(s.key,c.remotePeerId),c.addExtension("dxos.mesh.teleport.automerge",this._echoHost.createReplicationExtension())},onAuthFailure:()=>{log.warn("auth failure",void 0,{F:__dxlog_file14,L:289,S:this,C:(c,l)=>c(...l)})},onMemberRolesChanged:async c=>{(a==null?void 0:a.state)===SpaceState.READY&&this._handleMemberRoleChanges(r,s.protocol,c)},memberKey:this._signingContext.identityKey,onDelegatedInvitationStatusChange:(c,l)=>this._handleInvitationStatusChange(a,c,l)});n&&await s.setControlFeed(n),o&&await s.setDataFeed(o);const a=new DataSpace({inner:s,initialState:e.state===SpaceState.INACTIVE?SpaceState.INACTIVE:SpaceState.CLOSED,metadataStore:this._metadataStore,gossip:t,presence:r,keyring:this._keyring,feedStore:this._feedStore,echoHost:this._echoHost,signingContext:this._signingContext,callbacks:{beforeReady:async()=>{log("before space ready",{space:s.key},{F:__dxlog_file14,L:316,S:this,C:(c,l)=>c(...l)})},afterReady:async()=>{log("after space ready",{space:s.key,open:this._isOpen},{F:__dxlog_file14,L:319,S:this,C:(c,l)=>c(...l)}),this._isOpen&&(await this._createDelegatedInvitations(a,[...s.spaceState.invitations.entries()]),this._handleMemberRoleChanges(r,s.protocol,[...s.spaceState.members.values()]),this.updated.emit())},beforeClose:async()=>{log("before space close",{space:s.key},{F:__dxlog_file14,L:327,S:this,C:(c,l)=>c(...l)})}},cache:e.cache});return r.newPeer.on(c=>{a.state===SpaceState.READY&&this._handleNewPeerConnected(s,c)}),e.state!==SpaceState.INACTIVE&&await a.open(),e.controlTimeframe&&a.inner.controlPipeline.state.setTargetTimeframe(e.controlTimeframe),this._spaces.set(e.key,a),a}_handleMemberRoleChanges(e,t,r){let n=0;for(const o of r){if(o.key.equals(e.getLocalState().identityKey))continue;const s=e.getPeersByIdentityKey(o.key).map(a=>a.peerId&&t.sessions.get(a.peerId)).filter(a=>(a&&o.role===SpaceMember.Role.REMOVED!=(a.authStatus===AuthStatus.FAILURE))??!1);s.forEach(a=>{a.close().catch(log.error)}),n+=s.length}log("processed member role changes",{roleChangeCount:r.length,peersOnline:e.getPeersOnline().length,closedSessions:n},{F:__dxlog_file14,L:367,S:this,C:(o,s)=>o(...s)}),t.updateTopology()}_handleNewPeerConnected(e,t){if(e.spaceState.getMemberRole(t.identityKey)===SpaceMember.Role.REMOVED){const r=t.peerId&&e.protocol.sessions.get(t.peerId);r!=null&&(log("closing a session with a removed peer",{peerId:t.peerId},{F:__dxlog_file14,L:381,S:this,C:(n,o)=>n(...o)}),r.close().catch(log.error))}}async _handleInvitationStatusChange(e,t,r){(e==null?void 0:e.state)===SpaceState.READY&&(r?await this._createDelegatedInvitations(e,[[t.credentialId,t.invitation]]):await this._invitationsManager.cancelInvitation(t.invitation))}async _createDelegatedInvitations(e,t){const r=t.map(([n,o])=>this._invitationsManager.createInvitation({type:Invitation.Type.DELEGATED,kind:Invitation.Kind.SPACE,spaceKey:e.key,authMethod:o.authMethod,invitationId:o.invitationId,swarmKey:o.swarmKey,guestKeypair:o.guestKey?{publicKey:o.guestKey}:void 0,lifetime:o.expiresOn?o.expiresOn.getTime()-Date.now():void 0,multiUse:o.multiUse,delegationCredentialId:n,persistent:!1}));await Promise.all(r)}};_ts_decorate5([synchronized],DataSpaceManager.prototype,"open",null),_ts_decorate5([synchronized],DataSpaceManager.prototype,"close",null),_ts_decorate5([synchronized],DataSpaceManager.prototype,"createSpace",null),_ts_decorate5([synchronized],DataSpaceManager.prototype,"acceptSpace",null),DataSpaceManager=_ts_decorate5([trackLeaks("open","close")],DataSpaceManager);var __dxlog_file15="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/spaces/spaces-service.ts",SpacesServiceImpl=class{constructor(e,t,r){this._identityManager=e,this._spaceManager=t,this._getDataSpaceManager=r}async createSpace(){this._requireIdentity();const e=await(await this._getDataSpaceManager()).createSpace();return await this._updateMetrics(),this._serializeSpace(e)}async updateSpace({spaceKey:e,state:t}){const r=(await this._getDataSpaceManager()).spaces.get(e)??raise$1(new SpaceNotFoundError(e));if(t)switch(t){case SpaceState.ACTIVE:await r.activate();break;case SpaceState.INACTIVE:await r.deactivate();break;default:throw new ApiError("Invalid space state")}}async updateMemberRole(e){const t=this._requireIdentity(),r=this._spaceManager.spaces.get(e.spaceKey);if(r==null)throw new SpaceNotFoundError(e.spaceKey);if(!r.spaceState.hasMembershipManagementPermission(t.identityKey))throw new AuthorizationError("No member management permission.",{spaceKey:r.key,role:r.spaceState.getMemberRole(t.identityKey)});const n=await createAdmissionCredentials(t.getIdentityCredentialSigner(),e.memberKey,r.key,r.genesisFeedKey,e.newRole,r.spaceState.membershipChainHeads);invariant$1(n[0].credential,void 0,{F:__dxlog_file15,L:97,S:this,A:["credentials[0].credential",""]});const o=n[0].credential.credential;invariant$1(getCredentialAssertion(o)["@type"]==="dxos.halo.credentials.SpaceMember",void 0,{F:__dxlog_file15,L:99,S:this,A:["getCredentialAssertion(spaceMemberCredential)['@type'] === 'dxos.halo.credentials.SpaceMember'",""]}),await writeMessages(r.controlPipeline.writer,n)}querySpaces(){return new Stream$2(({next:e,ctx:t})=>{const r=new UpdateScheduler(t,async()=>{const n=await this._getDataSpaceManager(),o=Array.from(n.spaces.values()).map(s=>this._serializeSpace(s));log("update",{spaces:o},{F:__dxlog_file15,L:110,S:this,C:(s,a)=>s(...a)}),await this._updateMetrics(),e({spaces:o})},{maxFrequency:2});scheduleTask(t,async()=>{const n=await this._getDataSpaceManager(),o=new EventSubscriptions;t.onDispose(()=>o.clear());const s=()=>{o.clear();for(const a of n.spaces.values())o.add(a.stateUpdate.on(t,()=>r.forceTrigger())),o.add(a.presence.updated.on(t,()=>r.trigger())),o.add(a.automergeSpaceState.onNewEpoch.on(t,()=>r.trigger())),o.add(a.inner.controlPipeline.state.timeframeUpdate.on(t,()=>r.trigger()))};n.updated.on(t,()=>{s(),r.trigger()}),s(),r.trigger()}),this._identityManager.identity||e({spaces:[]})})}async postMessage({spaceKey:e,channel:t,message:r}){await((await this._getDataSpaceManager()).spaces.get(e)??raise$1(new SpaceNotFoundError(e))).postMessage(getChannelId(t),r)}subscribeMessages({spaceKey:e,channel:t}){return new Stream$2(({ctx:r,next:n})=>{scheduleTask(r,async()=>{const o=((await this._getDataSpaceManager()).spaces.get(e)??raise$1(new SpaceNotFoundError(e))).listen(getChannelId(t),s=>{n(s)});r.onDispose(()=>o.unsubscribe())})})}queryCredentials({spaceKey:e,noTail:t}){return new Stream$2(({ctx:r,next:n,close:o})=>{const s=this._spaceManager.spaces.get(e)??raise$1(new SpaceNotFoundError(e)),a={processCredential:async c=>{n(c)}};r.onDispose(()=>s.spaceState.removeCredentialProcessor(a)),scheduleTask(r,async()=>{await s.spaceState.addCredentialProcessor(a),t&&o()})})}async writeCredentials({spaceKey:e,credentials:t}){const r=this._spaceManager.spaces.get(e)??raise$1(new SpaceNotFoundError(e));for(const n of t??[])if(n.proof)await r.controlPipeline.writer.write({credential:{credential:n}});else{invariant$1(!n.id,"Id on unsigned credentials is not allowed",{F:__dxlog_file15,L:198,S:this,A:["!credential.id","'Id on unsigned credentials is not allowed'"]}),invariant$1(this._identityManager.identity,"Identity is not available",{F:__dxlog_file15,L:199,S:this,A:["this._identityManager.identity","'Identity is not available'"]});const o=this._identityManager.identity.getIdentityCredentialSigner();invariant$1(n.issuer.equals(o.getIssuer()),void 0,{F:__dxlog_file15,L:201,S:this,A:["credential.issuer.equals(signer.getIssuer())",""]});const s=await o.createCredential({subject:n.subject.id,assertion:n.subject.assertion});await r.controlPipeline.writer.write({credential:{credential:s}})}}async createEpoch({spaceKey:e,migration:t}){await((await this._getDataSpaceManager()).spaces.get(e)??raise$1(new SpaceNotFoundError(e))).createEpoch({migration:t})}_serializeSpace(e){var t;return{spaceKey:e.key,state:e.state,error:e.error?encodeError(e.error):void 0,pipeline:{currentEpoch:e.automergeSpaceState.lastEpoch,appliedEpoch:e.automergeSpaceState.lastEpoch,controlFeeds:e.inner.controlPipeline.state.feeds.map(r=>r.key),currentControlTimeframe:e.inner.controlPipeline.state.timeframe,targetControlTimeframe:e.inner.controlPipeline.state.targetTimeframe,totalControlTimeframe:e.inner.controlPipeline.state.endTimeframe,dataFeeds:void 0,startDataTimeframe:void 0,currentDataTimeframe:void 0,targetDataTimeframe:void 0,totalDataTimeframe:void 0},members:Array.from(e.inner.spaceState.members.values()).map(r=>{var o;const n=e.presence.getPeersOnline().filter(({identityKey:s})=>s.equals(r.key));return(o=this._identityManager.identity)!=null&&o.identityKey.equals(r.key)&&n.push(e.presence.getLocalState()),{identity:{identityKey:r.key,profile:r.profile??{}},role:r.role,presence:n.length>0?SpaceMember$1.PresenceState.ONLINE:SpaceMember$1.PresenceState.OFFLINE,peerStates:n}}),creator:(t=e.inner.spaceState.creator)==null?void 0:t.key,cache:e.cache,metrics:e.metrics}}_requireIdentity(){if(!this._identityManager.identity)throw new IdentityNotInitializedError("This device has no HALO identity available. See https://docs.dxos.org/guide/platform/halo");return this._identityManager.identity}async _updateMetrics(){var r;const e=await this._getDataSpaceManager(),t=(r=this._identityManager.identity)==null?void 0:r.identityKey.truncate();t&&trace.metrics.gauge("echo.space.count",e.spaces.size,{tags:{identity:t}})}},getChannelId=e=>`user-channel/${e}`;function _ts_decorate6(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file16="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/services/service-context.ts",ServiceContext=class extends Resource{constructor(e,t,r,n,o){super(),this.storage=e,this.level=t,this.networkManager=r,this.signalManager=n,this._runtimeParams=o,this.initialized=new Trigger,this._handlerFactories=new Map,this._instanceId=PublicKey.random().toHex(),this.metadataStore=new MetadataStore(e.createDirectory("metadata")),this.snapshotStore=new SnapshotStore(e.createDirectory("snapshots")),this.blobStore=new BlobStore(e.createDirectory("blobs")),this.keyring=new Keyring(e.createDirectory("keyring")),this.feedStore=new FeedStore({factory:new FeedFactory({root:e.createDirectory("feeds"),signer:this.keyring,hypercore:{valueEncoding,stats:!0}})}),this.spaceManager=new SpaceManager({feedStore:this.feedStore,networkManager:this.networkManager,blobStore:this.blobStore,metadataStore:this.metadataStore,snapshotStore:this.snapshotStore}),this.identityManager=new IdentityManager(this.metadataStore,this.keyring,this.feedStore,this.spaceManager,this._runtimeParams),this.echoHost=new EchoHost({kv:this.level,storage:this.storage}),this.invitations=new InvitationsHandler(this.networkManager,o==null?void 0:o.invitationConnectionDefaultParams),this.invitationsManager=new InvitationsManager(this.invitations,s=>this.getInvitationHandler(s),this.metadataStore),this._handlerFactories.set(Invitation.Kind.DEVICE,()=>new DeviceInvitationProtocol(this.keyring,()=>this.identityManager.identity??failUndefined(),this._acceptIdentity.bind(this)))}async _open(e){var r;await this._checkStorageVersion(),log("opening...",void 0,{F:__dxlog_file16,L:152,S:this,C:(n,o)=>n(...o)}),log.trace("dxos.sdk.service-context.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file16,L:153,S:this,C:(n,o)=>n(...o)}),await this.signalManager.open(),await this.networkManager.open(),await this.echoHost.open(e),await this.metadataStore.load(),await this.spaceManager.open(),await this.identityManager.open(e),this.identityManager.identity&&await this._initialize(e);const t=await this.invitationsManager.loadPersistentInvitations();log("loaded persistent invitations",{count:(r=t.invitations)==null?void 0:r.length},{F:__dxlog_file16,L:166,S:this,C:(n,o)=>n(...o)}),log.trace("dxos.sdk.service-context.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file16,L:168,S:this,C:(n,o)=>n(...o)}),log("opened",void 0,{F:__dxlog_file16,L:169,S:this,C:(n,o)=>n(...o)})}async _close(e){var t;log("closing...",void 0,{F:__dxlog_file16,L:173,S:this,C:(r,n)=>r(...n)}),this._deviceSpaceSync&&this.identityManager.identity&&await this.identityManager.identity.space.spaceState.removeCredentialProcessor(this._deviceSpaceSync),await((t=this.dataSpaceManager)==null?void 0:t.close()),await this.identityManager.close(),await this.spaceManager.close(),await this.feedStore.close(),await this.metadataStore.close(),await this.echoHost.close(e),await this.networkManager.close(),await this.signalManager.close(),log("closed",void 0,{F:__dxlog_file16,L:185,S:this,C:(r,n)=>r(...n)})}async createIdentity(e={}){const t=await this.identityManager.createIdentity(e);return await this._initialize(new Context),t}getInvitationHandler(e){const t=this._handlerFactories.get(e.kind);return invariant$1(t,`Unknown invitation kind: ${e.kind}`,{F:__dxlog_file16,L:196,S:this,A:["factory","`Unknown invitation kind: ${invitation.kind}`"]}),t(e)}async broadcastProfileUpdate(e){if(!(!e||!this.dataSpaceManager))for(const t of this.dataSpaceManager.spaces.values())await t.updateOwnProfile(e)}async _acceptIdentity(e){const t=await this.identityManager.acceptIdentity(e);return await this._initialize(new Context),t}async _checkStorageVersion(){if(await this.metadataStore.load(),this.metadataStore.version!==STORAGE_VERSION)throw new InvalidStorageVersionError(STORAGE_VERSION,this.metadataStore.version)}async _initialize(e){log("initializing spaces...",void 0,{F:__dxlog_file16,L:227,S:this,C:(n,o)=>n(...o)});const t=this.identityManager.identity??failUndefined(),r={credentialSigner:t.getIdentityCredentialSigner(),identityKey:t.identityKey,deviceKey:t.deviceKey,getProfile:()=>t.profileDocument,recordCredential:async n=>{await t.controlPipeline.writer.write({credential:{credential:n}})}};this.dataSpaceManager=new DataSpaceManager(this.spaceManager,this.metadataStore,this.keyring,r,this.feedStore,this.echoHost,this.invitationsManager,this._runtimeParams),await this.dataSpaceManager.open(),this._handlerFactories.set(Invitation.Kind.SPACE,n=>(invariant$1(this.dataSpaceManager,"dataSpaceManager not initialized yet",{F:__dxlog_file16,L:252,S:this,A:["this.dataSpaceManager","'dataSpaceManager not initialized yet'"]}),new SpaceInvitationProtocol(this.dataSpaceManager,r,this.keyring,n.spaceKey))),this.initialized.wake(),this._deviceSpaceSync={processCredential:async n=>{const o=getCredentialAssertion(n);if(o["@type"]==="dxos.halo.credentials.SpaceMember"&&!o.spaceKey.equals(t.space.key)){if(!this.dataSpaceManager){log("dataSpaceManager not initialized yet, ignoring space admission",{details:o},{F:__dxlog_file16,L:268,S:this,C:(s,a)=>s(...a)});return}if(this.dataSpaceManager.spaces.has(o.spaceKey)){log("space already exists, ignoring space admission",{details:o},{F:__dxlog_file16,L:272,S:this,C:(s,a)=>s(...a)});return}try{log("accepting space recorded in halo",{details:o},{F:__dxlog_file16,L:277,S:this,C:(s,a)=>s(...a)}),await this.dataSpaceManager.acceptSpace({spaceKey:o.spaceKey,genesisFeedKey:o.genesisFeedKey})}catch(s){log.catch(s,void 0,{F:__dxlog_file16,L:283,S:this,C:(a,c)=>a(...c)})}}}},await t.space.spaceState.addCredentialProcessor(this._deviceSpaceSync)}};_ts_decorate6([trace.span()],ServiceContext.prototype,"_open",null),_ts_decorate6([trace.span()],ServiceContext.prototype,"_initialize",null),ServiceContext=_ts_decorate6([safeInstanceof("dxos.client-services.ServiceContext"),trace.resource()],ServiceContext);var ServiceRegistry=class{constructor(e,t={}){this._serviceBundle=e,this._handlers=t}get descriptors(){return this._serviceBundle}get services(){return this._handlers}setServices(e){this._handlers=e}addService(e,t){this._handlers[e]=t}removeService(e){delete this._handlers[e]}},DXOS_VERSION$1="0.5.8",getPlatform=()=>{if(process$1.browser)if(typeof window<"u"){const{userAgent:e}=window.navigator;return{type:Platform.PLATFORM_TYPE.BROWSER,userAgent:e,uptime:Math.floor((Date.now()-window.performance.timeOrigin)/1e3)}}else return{type:Platform.PLATFORM_TYPE.SHARED_WORKER,uptime:Math.floor((Date.now()-performance.timeOrigin)/1e3)};else{const{platform:e,version:t,arch:r}=process$1;return{type:Platform.PLATFORM_TYPE.NODE,platform:e,arch:r,runtime:t,uptime:Math.floor(process$1.uptime()),memory:process$1.memoryUsage()}}},__dxlog_file17="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/diagnostics/diagnostics.ts",DEFAULT_TIMEOUT=1e3,createDiagnostics=async(e,t,r)=>{const n={created:new Date().toISOString(),platform:getPlatform(),client:{version:DXOS_VERSION$1,storage:{version:STORAGE_VERSION}},trace:TRACE_PROCESSOR.getDiagnostics()};return await Promise.all([(async()=>{invariant$1(e.LoggingService,"SystemService is not available.",{F:__dxlog_file17,L:110,S:void 0,A:["clientServices.LoggingService","'SystemService is not available.'"]}),n.metrics=await getFirstStreamValue(e.LoggingService.queryMetrics({}),{timeout:DEFAULT_TIMEOUT}).catch(()=>{})})(),(async()=>{n.storage=await asyncTimeout(getStorageDiagnostics(),DEFAULT_TIMEOUT).catch(()=>{})})(),async()=>{var s;const o=t.identityManager.identity;if(o){n.identity={identityKey:o.identityKey,spaceKey:o.space.key,profile:o.profileDocument};const{devices:a}=await getFirstStreamValue(e.DevicesService.queryDevices(),{timeout:DEFAULT_TIMEOUT}).catch(()=>{})??{};n.devices=a,t.dataSpaceManager&&(n.spaces=await Promise.all(Array.from(t.dataSpaceManager.spaces.values()).map(h=>getSpaceStats(h))??[]));const{feeds:c=[]}=await getFirstStreamValue(e.DevtoolsHost.subscribeToFeeds({}),{timeout:DEFAULT_TIMEOUT}).catch(()=>{})??{};n.feeds=c.map(({feedKey:h,bytes:u,length:d})=>({feedKey:h,bytes:u,length:d}));const l=await getFirstStreamValue(e.NetworkService.queryStatus(),{timeout:DEFAULT_TIMEOUT}).catch(()=>{});n.networkStatus=l,n.swarms=(s=t.networkManager.connectionLog)==null?void 0:s.swarms}}]),n.config=r.values,n},getSpaceStats=async e=>{const t={key:e.key,metrics:e.metrics,epochs:e.inner.spaceState.credentials.filter(credentialTypeFilter("dxos.halo.credentials.Epoch")).map(r=>({...r.subject.assertion,id:r.id})),members:Array.from(e.inner.spaceState.members.values()).map(r=>{var n;return{role:r.role,identity:{identityKey:r.key,profile:{displayName:(n=r.assertion.profile)==null?void 0:n.displayName}},presence:e.presence.getPeersOnline().filter(({identityKey:o})=>o.equals(r.key)).length>0?SpaceMember$1.PresenceState.ONLINE:SpaceMember$1.PresenceState.OFFLINE}}),pipeline:{currentEpoch:e.automergeSpaceState.lastEpoch,appliedEpoch:e.automergeSpaceState.lastEpoch,controlFeeds:e.inner.controlPipeline.state.feeds.map(r=>r.key),currentControlTimeframe:e.inner.controlPipeline.state.timeframe,targetControlTimeframe:e.inner.controlPipeline.state.targetTimeframe,totalControlTimeframe:e.inner.controlPipeline.state.endTimeframe}};if(t.metrics){const{open:r,ready:n}=t.metrics;t.metrics.startupTime=r&&n&&n.getTime()-r.getTime()}return t},getStorageDiagnostics=async()=>{if(typeof navigator>"u"||!navigator.storage)return;const e=new Map,t=await navigator.storage.getDirectory();for await(const r of t==null?void 0:t.keys()){const n=r.indexOf("-",r.indexOf("-")+1);n!==-1&&e.set(r.slice(0,n),(e.get(r.slice(0,n))??0)+1)}return Array.from(e.entries()).sort((r,n)=>n[1]-r[1]).map(([r,n])=>({file:r,count:n}))},__dxlog_file18="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/diagnostics/browser-diagnostics-broadcast.ts",CHANNEL_NAME="dxos.diagnostics.broadcast",MessageType;(function(e){e.PROBE="probe",e.PROBE_ACK="probe-ack",e.REQUEST_DIAGNOSTICS="request-diagnostics",e.RECEIVE_DIAGNOSTICS="receive-diagnostics"})(MessageType||(MessageType={}));var createCollectDiagnosticsBroadcastSender=()=>({broadcastDiagnosticsRequest:async()=>{let e="probe-ack",t;try{const r=new Trigger;return t=new BroadcastChannel(CHANNEL_NAME),t.onmessage=n=>{e===n.data.type&&r.wake(n.data)},t.postMessage({type:"probe"}),await r.wait({timeout:200}),e="receive-diagnostics",r.reset(),t.postMessage({type:"request-diagnostics"}),(await r.wait({timeout:5e3})).payload}catch(r){const n=r instanceof Error?r.message:JSON.stringify(r);return{expectedResponse:e,errorDescription:n}}finally{safeClose(t)}}}),createCollectDiagnosticsBroadcastHandler=e=>{let t;return{start:()=>{t=new BroadcastChannel(CHANNEL_NAME),t.onmessage=async r=>{try{if(r.data.type==="probe")t==null||t.postMessage({type:"probe-ack"});else if(r.data.type==="request-diagnostics"){const n=await e.getDiagnostics({});t==null||t.postMessage({type:"receive-diagnostics",payload:n})}}catch(n){log.catch(n,void 0,{F:__dxlog_file18,L:77,S:void 0,C:(o,s)=>o(...s)})}}},stop:()=>{safeClose(t),t=void 0}}},safeClose=e=>{try{e==null||e.close()}catch{}},__dxlog_file19="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/devices/devices-service.ts",DevicesServiceImpl=class{constructor(e){this._identityManager=e}async updateDevice(e){return this._identityManager.updateDeviceProfile(e)}queryDevices(){return new Stream$2(({next:e})=>{const t=()=>{var l,h;const c=(l=this._identityManager.identity)==null?void 0:l.authorizedDeviceKeys;if(!c)e({devices:[]});else{invariant$1((h=this._identityManager.identity)==null?void 0:h.presence,"presence not present",{F:__dxlog_file19,L:32,S:this,A:["this._identityManager.identity?.presence","'presence not present'"]});const u=this._identityManager.identity.presence.getPeersOnline();e({devices:Array.from(c.entries()).map(([d,f])=>{var y,w;const _=(y=this._identityManager.identity)==null?void 0:y.deviceKey.equals(d),p=u.find(E=>E.identityKey.equals(d));return{deviceKey:d,kind:(w=this._identityManager.identity)!=null&&w.deviceKey.equals(d)?DeviceKind.CURRENT:DeviceKind.TRUSTED,profile:f,presence:_||p?Device.PresenceState.ONLINE:Device.PresenceState.OFFLINE}})})}};let r=!1,n=!1;const o=()=>{var c;r||((c=this._identityManager.identity)==null||c.stateUpdate.on(()=>{t()}),r=!0)},s=()=>{var c,l;n||((l=(c=this._identityManager.identity)==null?void 0:c.presence)==null||l.updated.on(()=>{t()}),n=!0)},a=new EventSubscriptions;return this._identityManager.identity&&(o(),s()),a.add(this._identityManager.stateUpdate.on(()=>{t(),this._identityManager.identity&&(o(),s())})),t(),()=>a.clear()})}};function _ts_decorate7(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file20="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/locks/browser.ts",Message;(function(e){e.ACQUIRING="acquiring"})(Message||(Message={}));var Lock=class{constructor({lockKey:e,onAcquire:t,onRelease:r}){this._broadcastChannel=new BroadcastChannel("vault-resource-lock"),this._releaseTrigger=new Trigger,this._lockKey=e,this._onAcquire=t,this._onRelease=r,this._broadcastChannel.onmessage=this._onMessage.bind(this)}get lockKey(){return this._lockKey}async acquire(){this._broadcastChannel.postMessage({message:"acquiring"});try{log("aquiring lock...",void 0,{F:__dxlog_file20,L:42,S:this,C:(e,t)=>e(...t)}),await asyncTimeout(this._requestLock(),RESOURCE_LOCK_TIMEOUT),log("acquired lock",void 0,{F:__dxlog_file20,L:44,S:this,C:(e,t)=>e(...t)})}catch{log("stealing lock...",void 0,{F:__dxlog_file20,L:46,S:this,C:(e,t)=>e(...t)}),await this._requestLock(!0),log("stolen lock",void 0,{F:__dxlog_file20,L:48,S:this,C:(e,t)=>e(...t)})}}async release(){this._releaseTrigger.wake()}_onMessage(e){e.data.message==="acquiring"&&this._releaseTrigger.wake()}async _requestLock(e=!1){log("requesting lock...",{steal:e},{F:__dxlog_file20,L:63,S:this,C:(r,n)=>r(...n)});const t=new Trigger;navigator.locks.request(this._lockKey,{steal:e},async()=>{var r,n;await((r=this._onAcquire)==null?void 0:r.call(this)),t.wake(),this._releaseTrigger=new Trigger,await this._releaseTrigger.wait(),log("releasing lock...",void 0,{F:__dxlog_file20,L:72,S:this,C:(o,s)=>o(...s)}),await((n=this._onRelease)==null?void 0:n.call(this)),log("released lock",void 0,{F:__dxlog_file20,L:74,S:this,C:(o,s)=>o(...s)})}).catch(async()=>{var r;await((r=this._onRelease)==null?void 0:r.call(this))}),await t.wait(),log("recieved lock",{steal:e},{F:__dxlog_file20,L:81,S:this,C:(r,n)=>r(...n)})}};_ts_decorate7([logInfo],Lock.prototype,"lockKey",null);var LoggingServiceImpl=class{constructor(){this._logs=new Event$1,this._started=Date.now(),this._sessionId=PublicKey.random().toHex(),this._logProcessor=(e,t)=>{this._logs.emit(t)}}async open(){log.runtimeConfig.processors.push(this._logProcessor)}async close(){const e=log.runtimeConfig.processors.findIndex(t=>t===this._logProcessor);log.runtimeConfig.processors.splice(e,1)}async controlMetrics({reset:e,record:t}){return e&&tracer.clear(),t===!0?tracer.start():t===!1&&tracer.stop(),{recording:tracer.recording}}queryMetrics({interval:e=5e3}){const t=r=>{const n=tracer.get(r)??[];return{key:r,stats:numericalValues(n,"duration")}};return new Stream$2(({next:r})=>{const n=()=>{const s={timestamp:new Date,values:[t("dxos.echo.pipeline.control"),t("dxos.echo.pipeline.data")].filter(Boolean)};r({timestamp:new Date,metrics:s})};n();const o=setInterval(n,Math.max(e,1e3));return()=>{clearInterval(o)}})}queryLogs(e){return new Stream$2(({ctx:t,next:r})=>{const n=o=>{var a,c,l,h;if(LOG_PROCESSING>0||(a=o.meta)!=null&&a.F.includes("logging-service")||o.context&&Object.values(o.context).some(u=>typeof u=="string"&&u.includes("LoggingService"))||!shouldLog(o,e))return;const s={...o,context:jsonify$1(getContextFromEntry(o)),timestamp:new Date,meta:{file:((c=o.meta)==null?void 0:c.F)??"",line:((l=o.meta)==null?void 0:l.L)??0,scope:{hostSessionId:this._sessionId,uptimeSeconds:(Date.now()-this._started)/1e3,name:getDebugName((h=o.meta)==null?void 0:h.S)}}};try{LOG_PROCESSING++,r(s)}finally{LOG_PROCESSING--}};this._logs.on(t,n)})}},matchFilter=(e,t,r,n)=>{switch(n){case QueryLogsRequest.MatchingOptions.INCLUSIVE:return t>=e.level&&(!e.pattern||r.includes(e.pattern));case QueryLogsRequest.MatchingOptions.EXPLICIT:return t===e.level&&(!e.pattern||r.includes(e.pattern))}},shouldLog=(e,t)=>{const r=t.options??QueryLogsRequest.MatchingOptions.INCLUSIVE;return t.filters===void 0?r===QueryLogsRequest.MatchingOptions.INCLUSIVE:t.filters.some(n=>{var o;return matchFilter(n,e.level,((o=e.meta)==null?void 0:o.F)??"",r)})},LOG_PROCESSING=0,NetworkServiceImpl=class{constructor(e,t){this.networkManager=e,this.signalManager=t}queryStatus(){return new Stream$2(({next:e})=>{const t=()=>{var o;e({swarm:this.networkManager.connectionState,connectionInfo:(o=this.networkManager.connectionLog)==null?void 0:o.swarms,signaling:this.signalManager.getStatus().map(({host:s,state:a})=>({server:s,state:a}))})},r=this.networkManager.connectionStateChanged.on(()=>t()),n=this.signalManager.statusChanged.on(()=>t());return t(),()=>{r(),n()}})}async updateConfig(e){await this.networkManager.setConnectionState(e.swarm)}},getRootPath=e=>{const{dataRoot:t=isNode()?DX_DATA:"dxos/storage"}=e??{};return`${t}/`},isPersistent=e=>{const{persistent:t=!1}=e??{};return e.dataStore!==void 0&&e.dataStore!==Runtime.Client.Storage.StorageDriver.RAM||t},StorageDriver=Runtime.Client.Storage.StorageDriver,createStorageObjects=e=>{const{persistent:t=!1,keyStore:r,dataStore:n}=e??{};if(t&&n===StorageDriver.RAM)throw new InvalidConfigError("RAM storage cannot be used in persistent mode.");if(!t&&n!==void 0&&n!==StorageDriver.RAM)throw new InvalidConfigError("Cannot use a persistent storage in not persistent mode.");if(t&&r===StorageDriver.RAM)throw new InvalidConfigError("RAM key storage cannot be used in persistent mode.");if(!t&&r!==StorageDriver.RAM&&r!==void 0)throw new InvalidConfigError("Cannot use a persistent key storage in not persistent mode.");return{storage:createStorage({type:t?toStorageType(n):StorageType.RAM,root:getRootPath(e)})}},toStorageType=e=>{switch(e){case void 0:return;case StorageDriver.RAM:return StorageType.RAM;case StorageDriver.CHROME:return StorageType.CHROME;case StorageDriver.FIREFOX:return StorageType.FIREFOX;case StorageDriver.IDB:return StorageType.IDB;case StorageDriver.NODE:return StorageType.NODE;case StorageDriver.WEBFS:return StorageType.WEBFS;default:throw new Error(`Invalid storage type: ${StorageDriver[e]}`)}},createLevel=async e=>{const t=isPersistent(e)?path_default.join(getRootPath(e),"level"):`/tmp/dxos-${PublicKey.random().toHex()}`,r=createLevel$1(t);return await r.open(),r},SystemServiceImpl=class{constructor({config:e,statusUpdate:t,getDiagnostics:r,onUpdateStatus:n,getCurrentStatus:o,onReset:s}){this._config=e,this._statusUpdate=t,this._getCurrentStatus=o,this._getDiagnostics=r,this._onUpdateStatus=n,this._onReset=s}async getConfig(){var e,t;return((t=await((e=this._config)==null?void 0:e.call(this)))==null?void 0:t.values)??{}}async getDiagnostics({keys:e}={}){const t=await this._getDiagnostics();return{timestamp:new Date,diagnostics:JSON.parse(JSON.stringify(t,jsonKeyReplacer({truncate:e===GetDiagnosticsRequest.KEY_OPTION.TRUNCATE,humanize:e===GetDiagnosticsRequest.KEY_OPTION.HUMANIZE})))}}async getPlatform(){return getPlatform()}async updateStatus({status:e}){await this._onUpdateStatus(e)}queryStatus({interval:e=3e3}={}){return new Stream$2(({next:t})=>{const r=()=>{t({status:this._getCurrentStatus()})};r();const n=this._statusUpdate.on(()=>r()),o=setInterval(r,e);return()=>{clearInterval(o),n()}})}async reset(){await this._onReset()}};function _ts_decorate8(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file21="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/services/service-host.ts",ClientServicesHost=class{constructor({config:e,transportFactory:t,signalManager:r,storage:n,level:o,lockKey:s,callbacks:a,runtimeParams:c}={}){this._tracingService=TRACE_PROCESSOR.createTraceSender(),this._statusUpdate=new Event$1,this._opening=!1,this._open=!1,this._storage=n,this._level=o,this._callbacks=a,this._runtimeParams=c,e&&this.initialize({config:e,transportFactory:t,signalManager:r}),s&&(this._resourceLock=new Lock({lockKey:s,onAcquire:()=>{this._opening||this.open(new Context)},onRelease:()=>this.close()})),this._systemService=new SystemServiceImpl({config:()=>this._config,statusUpdate:this._statusUpdate,getCurrentStatus:()=>this.isOpen?SystemStatus.ACTIVE:SystemStatus.INACTIVE,getDiagnostics:()=>createDiagnostics(this._serviceRegistry.services,this._serviceContext,this._config),onUpdateStatus:async l=>{var h,u;!this.isOpen&&l===SystemStatus.ACTIVE?await((h=this._resourceLock)==null?void 0:h.acquire()):this.isOpen&&l===SystemStatus.INACTIVE&&await((u=this._resourceLock)==null?void 0:u.release())},onReset:async()=>{await this.reset()}}),this.diagnosticsBroadcastHandler=createCollectDiagnosticsBroadcastHandler(this._systemService),this._loggingService=new LoggingServiceImpl,this._serviceRegistry=new ServiceRegistry(clientServiceBundle,{SystemService:this._systemService,TracingService:this._tracingService})}get isOpen(){return this._open}get config(){return this._config}get context(){return this._serviceContext}get serviceRegistry(){return this._serviceRegistry}get descriptors(){return this._serviceRegistry.descriptors}get services(){return this._serviceRegistry.services}initialize({config:e,...t}){var s,a;invariant$1(!this._open,"service host is open",{F:__dxlog_file21,L:189,S:this,A:["!this._open","'service host is open'"]}),log("initializing...",void 0,{F:__dxlog_file21,L:190,S:this,C:(c,l)=>c(...l)}),e&&(invariant$1(!this._config,"config already set",{F:__dxlog_file21,L:193,S:this,A:["!this._config","'config already set'"]}),this._config=e,this._storage||(this._storage=createStorageObjects(e.get("runtime.client.storage",{})).storage)),t.signalManager||log.warn("running signaling without telemetry metadata.",void 0,{F:__dxlog_file21,L:201,S:this,C:(c,l)=>c(...l)});const{connectionLog:r=!0,transportFactory:n=createSimplePeerTransportFactory({iceServers:(s=this._config)==null?void 0:s.get("runtime.services.ice")}),signalManager:o=new WebsocketSignalManager(((a=this._config)==null?void 0:a.get("runtime.services.signaling"))??[])}=t;this._signalManager=o,invariant$1(!this._networkManager,"network manager already set",{F:__dxlog_file21,L:212,S:this,A:["!this._networkManager","'network manager already set'"]}),this._networkManager=new NetworkManager({log:r,transportFactory:n,signalManager:o}),log("initialized",void 0,{F:__dxlog_file21,L:219,S:this,C:(c,l)=>c(...l)})}async open(e){var o,s,a,c;if(this._open)return;const t=PublicKey.random().toHex();log.trace("dxos.client-services.host.open",trace$1.begin({id:t}),{F:__dxlog_file21,L:230,S:this,C:(l,h)=>l(...h)}),invariant$1(this._config,"config not set",{F:__dxlog_file21,L:232,S:this,A:["this._config","'config not set'"]}),invariant$1(this._storage,"storage not set",{F:__dxlog_file21,L:233,S:this,A:["this._storage","'storage not set'"]}),invariant$1(this._signalManager,"signal manager not set",{F:__dxlog_file21,L:234,S:this,A:["this._signalManager","'signal manager not set'"]}),invariant$1(this._networkManager,"network manager not set",{F:__dxlog_file21,L:235,S:this,A:["this._networkManager","'network manager not set'"]}),this._opening=!0,log("opening...",{lockKey:(o=this._resourceLock)==null?void 0:o.lockKey},{F:__dxlog_file21,L:238,S:this,C:(l,h)=>l(...h)}),await((s=this._resourceLock)==null?void 0:s.acquire()),this._level||(this._level=await createLevel(this._config.get("runtime.client.storage",{}))),await this._level.open(),await this._loggingService.open(),this._serviceContext=new ServiceContext(this._storage,this._level,this._networkManager,this._signalManager,this._runtimeParams),this._serviceRegistry.setServices({SystemService:this._systemService,IdentityService:new IdentityServiceImpl(l=>this._createIdentity(l),this._serviceContext.identityManager,this._serviceContext.keyring,l=>this._serviceContext.broadcastProfileUpdate(l)),InvitationsService:new InvitationsServiceImpl(this._serviceContext.invitationsManager),DevicesService:new DevicesServiceImpl(this._serviceContext.identityManager),SpacesService:new SpacesServiceImpl(this._serviceContext.identityManager,this._serviceContext.spaceManager,async()=>(await this._serviceContext.initialized.wait(),this._serviceContext.dataSpaceManager)),DataService:this._serviceContext.echoHost.dataService,QueryService:this._serviceContext.echoHost.queryService,NetworkService:new NetworkServiceImpl(this._serviceContext.networkManager,this._serviceContext.signalManager),LoggingService:this._loggingService,TracingService:this._tracingService,DevtoolsHost:new DevtoolsServiceImpl({events:new DevtoolsHostEvents,config:this._config,context:this._serviceContext})}),await this._serviceContext.open(e);const r=(a=this._config)==null?void 0:a.get("runtime.client.devtoolsProxy");r&&(this._devtoolsProxy=new WebsocketRpcClient({url:r,requested:{},exposed:clientServiceBundle,handlers:this.services}),this._devtoolsProxy.open()),this.diagnosticsBroadcastHandler.start(),this._opening=!1,this._open=!0,this._statusUpdate.emit();const n=(c=this._serviceContext.identityManager.identity)==null?void 0:c.deviceKey;log("opened",{deviceKey:n},{F:__dxlog_file21,L:314,S:this,C:(l,h)=>l(...h)}),log.trace("dxos.client-services.host.open",trace$1.end({id:t}),{F:__dxlog_file21,L:315,S:this,C:(l,h)=>l(...h)})}async close(){var t,r,n;if(!this._open)return;const e=(t=this._serviceContext.identityManager.identity)==null?void 0:t.deviceKey;log("closing...",{deviceKey:e},{F:__dxlog_file21,L:326,S:this,C:(o,s)=>o(...s)}),this.diagnosticsBroadcastHandler.stop(),await((r=this._devtoolsProxy)==null?void 0:r.close()),this._serviceRegistry.setServices({SystemService:this._systemService}),await this._loggingService.close(),await this._serviceContext.close(),await((n=this._level)==null?void 0:n.close()),this._open=!1,this._statusUpdate.emit(),log("closed",{deviceKey:e},{F:__dxlog_file21,L:335,S:this,C:(o,s)=>o(...s)})}async reset(){var t,r,n;const e=PublicKey.random().toHex();log.trace("dxos.sdk.client-services-host.reset",trace$1.begin({id:e}),{F:__dxlog_file21,L:340,S:this,C:(o,s)=>o(...s)}),log.info("resetting...",void 0,{F:__dxlog_file21,L:342,S:this,C:(o,s)=>o(...s)}),await((t=this._serviceContext)==null?void 0:t.close()),await this._storage.reset(),log.info("reset",void 0,{F:__dxlog_file21,L:345,S:this,C:(o,s)=>o(...s)}),log.trace("dxos.sdk.client-services-host.reset",trace$1.end({id:e}),{F:__dxlog_file21,L:346,S:this,C:(o,s)=>o(...s)}),await((n=(r=this._callbacks)==null?void 0:r.onReset)==null?void 0:n.call(r))}async _createIdentity(e){const t=await this._serviceContext.createIdentity(e);await this._serviceContext.initialized.wait();const r=(await this._serviceContext.dataSpaceManager.createSpace()).automergeSpaceState.rootUrl;invariant$1(r,void 0,{F:__dxlog_file21,L:358,S:this,A:["automergeIndex",""]});const n=await this._serviceContext.echoHost.automergeRepo.find(r);await n.whenReady();const o={system:{type:encodeReference(getTypeReference(Properties))},data:{[defaultKey]:t.identityKey.toHex()},meta:{keys:[]}},s=PublicKey.random().toHex();return n.change(a=>{assignDeep(a,["objects",s],o)}),await this._serviceContext.echoHost.flush(),t}};_ts_decorate8([trace.info()],ClientServicesHost.prototype,"_opening",void 0),_ts_decorate8([trace.info()],ClientServicesHost.prototype,"_open",void 0),_ts_decorate8([synchronized,trace.span()],ClientServicesHost.prototype,"open",null),_ts_decorate8([synchronized,trace.span()],ClientServicesHost.prototype,"close",null),ClientServicesHost=_ts_decorate8([trace.resource()],ClientServicesHost);let GET_DIAGNOSTICS_RPC_TIMEOUT,DiagnosticsCollector,findSystemServiceProvider,findConfigs;ClientServicesProviderResource=Symbol.for("dxos.resource.ClientServices"),GET_DIAGNOSTICS_RPC_TIMEOUT=1e4,DiagnosticsCollector=(Jn=class{static async collect(t=findConfigs(),r=findSystemServiceProvider(),n={}){var c,l;const o=await((l=(c=r==null?void 0:r.services)==null?void 0:c.SystemService)==null?void 0:l.getDiagnostics({keys:n.humanize?GetDiagnosticsRequest.KEY_OPTION.HUMANIZE:n.truncate?GetDiagnosticsRequest.KEY_OPTION.TRUNCATE:void 0},{timeout:GET_DIAGNOSTICS_RPC_TIMEOUT})),s={config:t,trace:TRACE_PROCESSOR.getDiagnostics()},a=o!=null?{client:s,services:o}:{client:s,broadcast:await this.broadcastSender.broadcastDiagnosticsRequest()};return JSON.parse(JSON.stringify(a,jsonKeyReplacer(n)))}},Jn.broadcastSender=createCollectDiagnosticsBroadcastSender(),Jn),findSystemServiceProvider=()=>{var e,t;return((t=(e=TRACE_PROCESSOR.findResourcesByAnnotation(ClientServicesProviderResource).find(r=>{var n,o;return((o=(n=r.instance.deref())==null?void 0:n.services)==null?void 0:o.SystemService)!=null}))==null?void 0:e.instance)==null?void 0:t.deref())??null},findConfigs=()=>TRACE_PROCESSOR.findResourcesByAnnotation(ConfigResource).map(e=>e.instance.deref()).filter(nonNullable),function(e){e[e.NONE=0]="NONE",e[e.FULLSCREEN=1]="FULLSCREEN"}(ShellDisplay||(ShellDisplay={})),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.INITIALIZE_IDENTITY=1]="INITIALIZE_IDENTITY",e[e.INITIALIZE_IDENTITY_FROM_INVITATION=2]="INITIALIZE_IDENTITY_FROM_INVITATION",e[e.IDENTITY=3]="IDENTITY",e[e.SHARE_IDENTITY=4]="SHARE_IDENTITY",e[e.EDIT_PROFILE=5]="EDIT_PROFILE",e[e.SPACE=6]="SPACE",e[e.JOIN_SPACE=7]="JOIN_SPACE",e[e.STATUS=8]="STATUS"}(ShellLayout||(ShellLayout={}));var __dxlog_file$4="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/vault/shell-runtime.ts",ShellRuntimeImpl=class{constructor(e){this._port=e,this.layoutUpdate=new Event$1,this.invitationUrlUpdate=new Event$1,this._layout=ShellLayout.DEFAULT,this._invitationUrl=typeof window<"u"?window.location.origin:void 0,this._deviceInvitationParam="deviceInvitationCode",this._spaceInvitationParam="spaceInvitationCode"}get layout(){return this._layout}get invitationCode(){return this._invitationCode}get spaceKey(){return this._spaceKey}get invitationUrl(){return this._invitationUrl}get deviceInvitationParam(){return this._deviceInvitationParam}get spaceInvitationParam(){return this._spaceInvitationParam}setLayout({layout:e,invitationCode:t,spaceKey:r}){this._layout=e,this._invitationCode=t,this._spaceKey=r,this.layoutUpdate.emit({layout:e,invitationCode:t,spaceKey:r})}setInvitationUrl({invitationUrl:e,deviceInvitationParam:t,spaceInvitationParam:r}){this._invitationUrl=e,this._deviceInvitationParam=t,this._spaceInvitationParam=r,this.invitationUrlUpdate.emit({invitationUrl:e,deviceInvitationParam:t,spaceInvitationParam:r})}async setAppContext(e){invariant$1(this._appRpc,"runtime not open",{F:__dxlog_file$4,L:76,S:this,A:["this._appRpc","'runtime not open'"]}),await this._appRpc.rpc.AppService.setContext(e)}async open(){this._appRpc=createProtoRpcPeer({requested:appServiceBundle,exposed:shellServiceBundle,handlers:{ShellService:{setLayout:async e=>{this._layout=e.layout,this._invitationCode=e.invitationCode,this._spaceKey=e.spaceKey,this.layoutUpdate.emit(e)},setInvitationUrl:async e=>{this._invitationUrl=e.invitationUrl,this._deviceInvitationParam=e.deviceInvitationParam,this._spaceInvitationParam=e.spaceInvitationParam,this.invitationUrlUpdate.emit(e)}}},port:this._port}),await this._appRpc.open()}async close(){var e;await((e=this._appRpc)==null?void 0:e.close()),this._appRpc=void 0}};function _ts_decorate$2(e,t,r,n){var o=arguments.length,s=o<3?t:n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file2$1="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/vault/iframe-host-runtime.ts",LOCK_KEY="DXOS_RESOURCE_LOCK",IFrameHostRuntime=class{constructor({config:e,origin:t,appPort:r,shellPort:n}){this._ready=new Trigger,this._configProvider=e,this.origin=t,this._appPort=r,this._shellPort=n,this._shellPort&&(this._shellRuntime=new ShellRuntimeImpl(this._shellPort))}get services(){return this._clientServices}get shell(){return this._shellRuntime}async start(){var e;log("starting...",void 0,{F:__dxlog_file2$1,L:73,S:this,C:(t,r)=>t(...r)});try{this._config=await getAsyncValue(this._configProvider),this._transportFactory=createSimplePeerTransportFactory({iceServers:this._config.get("runtime.services.ice")});const t=this._config.get("runtime.services.signaling");this._clientServices=new ClientServicesHost({lockKey:LOCK_KEY,config:this._config,signalManager:t?new WebsocketSignalManager(t):new MemorySignalManager(new MemorySignalManagerContext),transportFactory:this._transportFactory});const r={handleCall:async(n,o,s)=>{const a=await this._ready.wait({timeout:PROXY_CONNECTION_TIMEOUT});if(a)throw a;return s(n,o)},handleStream:async(n,o,s)=>{const a=await this._ready.wait({timeout:PROXY_CONNECTION_TIMEOUT});if(a)throw a;return s(n,o)}};this._clientRpc=new ClientRpcServer({serviceRegistry:this._clientServices.serviceRegistry,port:this._appPort,...r}),await Promise.all([this._clientServices.open(new Context),this._clientRpc.open(),(e=this._shellRuntime)==null?void 0:e.open()]),this._ready.wake(void 0),log("started",void 0,{F:__dxlog_file2$1,L:116,S:this,C:(n,o)=>n(...o)})}catch(t){this._ready.wake(t),log.catch(t,void 0,{F:__dxlog_file2$1,L:119,S:this,C:(r,n)=>r(...n)})}}async stop(){var e;log("stopping...",void 0,{F:__dxlog_file2$1,L:124,S:this,C:(t,r)=>t(...r)}),await this._clientRpc.close(),await this._clientServices.close(),await((e=this._shellRuntime)==null?void 0:e.close()),log("stopped",void 0,{F:__dxlog_file2$1,L:128,S:this,C:(t,r)=>t(...r)})}};_ts_decorate$2([logInfo],IFrameHostRuntime.prototype,"origin",void 0);var __dxlog_file3="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/vault/shared-worker-connection.ts",SharedWorkerConnection=class{constructor({config:e,systemPort:t,shellPort:r}){this._id=String(Math.floor(Math.random()*1e6)),this._release=new Trigger,this._configProvider=e,this._systemPort=t,this._shellPort=r,this._shellPort&&(this._shellRuntime=new ShellRuntimeImpl(this._shellPort))}get shell(){return this._shellRuntime}async open(e){var r;this._config=await getAsyncValue(this._configProvider),this._transportService=new SimplePeerTransportService({iceServers:this._config.get("runtime.services.ice")}),this._systemRpc=createProtoRpcPeer({requested:workerServiceBundle,exposed:iframeServiceBundle,handlers:{BridgeService:this._transportService},port:this._systemPort,timeout:200});let t;if(typeof navigator<"u"){t=this._lockKey(e.origin),this._release=new Trigger;const n=new Trigger;navigator.locks.request(t,async()=>{n.wake(),await this._release.wait()}),await n.wait()}try{await this._systemRpc.open(),await this._systemRpc.rpc.WorkerService.start({lockKey:t,...e})}catch(n){throw log.catch(n,void 0,{F:__dxlog_file3,L:95,S:this,C:(o,s)=>o(...s)}),new RemoteServiceConnectionError("Failed to connect to worker")}await((r=this._shellRuntime)==null?void 0:r.open())}async close(){var e;this._release.wake(),await((e=this._shellRuntime)==null?void 0:e.close());try{await this._systemRpc.rpc.WorkerService.stop()}catch{}await this._systemRpc.close()}_lockKey(e){return`${e}-${this._id}`}};function _ts_decorate2(e,t,r,n){var o=arguments.length,s=o<3?t:n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file4="/home/runner/work/dxos/dxos/packages/sdk/client-services/src/packlets/vault/worker-session.ts",WorkerSession=class{constructor({serviceHost:e,systemPort:t,appPort:r,shellPort:n,readySignal:o}){this._startTrigger=new Trigger,this.onClose=new Callback,invariant$1(e,void 0,{F:__dxlog_file4,L:54,S:this,A:["serviceHost",""]}),this._serviceHost=e;const s={handleCall:async(a,c,l)=>{const h=await o.wait({timeout:PROXY_CONNECTION_TIMEOUT});if(h)throw h;return l(a,c)},handleStream:async(a,c,l)=>{const h=await o.wait({timeout:PROXY_CONNECTION_TIMEOUT});if(h)throw h;return l(a,c)}};this._clientRpc=new ClientRpcServer({serviceRegistry:this._serviceHost.serviceRegistry,port:r,...s}),this._shellClientRpc=n?new ClientRpcServer({serviceRegistry:this._serviceHost.serviceRegistry,port:n,...s}):void 0,this._iframeRpc=createProtoRpcPeer({requested:iframeServiceBundle,exposed:workerServiceBundle,handlers:{WorkerService:{start:async a=>{this.origin=a.origin,this.lockKey=a.lockKey,this.observabilityGroup=a.observabilityGroup,this.signalTelemetryEnabled=a.signalTelemetryEnabled,this._startTrigger.wake()},stop:async()=>{setTimeout(async()=>{try{await this.close()}catch(a){log.catch(a,void 0,{F:__dxlog_file4,L:108,S:this,C:(c,l)=>c(...l)})}})}}},port:t,timeout:1e3}),this.bridgeService=this._iframeRpc.rpc.BridgeService}async open(){log.info("opening...",void 0,{F:__dxlog_file4,L:122,S:this,C:(e,t)=>e(...t)}),await Promise.all([this._clientRpc.open(),this._iframeRpc.open(),this._maybeOpenShell()]),await this._startTrigger.wait({timeout:PROXY_CONNECTION_TIMEOUT}),this.lockKey&&this._afterLockReleases(this.lockKey,()=>this.close()),log.info("opened",void 0,{F:__dxlog_file4,L:133,S:this,C:(e,t)=>e(...t)})}async close(){log.info("closing...",void 0,{F:__dxlog_file4,L:137,S:this,C:(e,t)=>e(...t)});try{await this.onClose.callIfSet()}catch(e){log.catch(e,void 0,{F:__dxlog_file4,L:141,S:this,C:(t,r)=>t(...r)})}await Promise.all([this._clientRpc.close(),this._iframeRpc.close()]),log.info("closed",void 0,{F:__dxlog_file4,L:145,S:this,C:(e,t)=>e(...t)})}async _maybeOpenShell(){try{this._shellClientRpc&&await asyncTimeout(this._shellClientRpc.open(),1e3)}catch{log.info("No shell connected.",void 0,{F:__dxlog_file4,L:152,S:this,C:(e,t)=>e(...t)})}}_afterLockReleases(e,t){return navigator.locks.request(e,()=>{}).then(t)}};_ts_decorate2([logInfo],WorkerSession.prototype,"origin",void 0),_ts_decorate2([logInfo],WorkerSession.prototype,"lockKey",void 0),index=Object.freeze(Object.defineProperty({__proto__:null,get ClientRpcServer(){return ClientRpcServer},get ClientServicesHost(){return ClientServicesHost},ClientServicesProviderResource,get DataSpace(){return DataSpace},get DataSpaceManager(){return DataSpaceManager},DeviceInvitationProtocol,DevtoolsHostEvents,DevtoolsServiceImpl,DiagnosticsCollector,IFrameHostRuntime,get Identity(){return Identity},get IdentityManager(){return IdentityManager},IdentityServiceImpl,InvitationsHandler,InvitationsManager,InvitationsServiceImpl,Lock,get ServiceContext(){return ServiceContext},ServiceRegistry,SharedWorkerConnection,ShellRuntimeImpl,SpaceInvitationProtocol,SpacesServiceImpl,TrustedKeySetAuthVerifier,WorkerSession,createAdmissionKeypair,createAuthProvider,createCollectDiagnosticsBroadcastHandler,createCollectDiagnosticsBroadcastSender,createDiagnostics,createLevel,createStorageObjects,findPropertiesObject,subscribeToFeedBlocks,subscribeToFeeds,subscribeToNetworkStatus,subscribeToSignal,subscribeToSpaces,subscribeToSwarmInfo},Symbol.toStringTag,{value:"Module"}));var uaParser={exports:{}};(function(e,t){(function(r,n){var o="1.0.38",s="",a="?",c="function",l="undefined",h="object",u="string",d="major",f="model",_="name",p="type",y="vendor",w="version",E="architecture",x="console",B="mobile",P="tablet",U="smarttv",F="wearable",G="embedded",H=500,te="Amazon",J="Apple",le="ASUS",z="BlackBerry",q="Browser",he="Chrome",V="Edge",_e="Firefox",ee="Google",W="Huawei",re="LG",ne="Microsoft",ge="Motorola",de="Opera",ye="Samsung",Ce="Sharp",ke="Sony",ae="Xiaomi",Q="Zebra",C="Facebook",$="Chromium OS",j="Mac OS",O=function(qe,Je){var g={};for(var b in qe)Je[b]&&Je[b].length%2===0?g[b]=Je[b].concat(qe[b]):g[b]=qe[b];return g},k=function(qe){for(var Je={},g=0;g<qe.length;g++)Je[qe[g].toUpperCase()]=qe[g];return Je},ue=function(qe,Je){return typeof qe===u?pe(Je).indexOf(pe(qe))!==-1:!1},pe=function(qe){return qe.toLowerCase()},Oe=function(qe){return typeof qe===u?qe.replace(/[^\d\.]/g,s).split(".")[0]:n},Le=function(qe,Je){if(typeof qe===u)return qe=qe.replace(/^\s\s*/,s),typeof Je===l?qe:qe.substring(0,H)},Me=function(qe,Je){for(var g=0,b,T,ce,fe,ve,Ne;g<Je.length&&!ve;){var tt=Je[g],ct=Je[g+1];for(b=T=0;b<tt.length&&!ve&&tt[b];)if(ve=tt[b++].exec(qe),ve)for(ce=0;ce<ct.length;ce++)Ne=ve[++T],fe=ct[ce],typeof fe===h&&fe.length>0?fe.length===2?typeof fe[1]==c?this[fe[0]]=fe[1].call(this,Ne):this[fe[0]]=fe[1]:fe.length===3?typeof fe[1]===c&&!(fe[1].exec&&fe[1].test)?this[fe[0]]=Ne?fe[1].call(this,Ne,fe[2]):n:this[fe[0]]=Ne?Ne.replace(fe[1],fe[2]):n:fe.length===4&&(this[fe[0]]=Ne?fe[3].call(this,Ne.replace(fe[1],fe[2])):n):this[fe]=Ne||n;g+=2}},We=function(qe,Je){for(var g in Je)if(typeof Je[g]===h&&Je[g].length>0){for(var b=0;b<Je[g].length;b++)if(ue(Je[g][b],qe))return g===a?n:g}else if(ue(Je[g],qe))return g===a?n:g;return qe},Fe={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},st={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},ft={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[w,[_,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[w,[_,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[_,w],[/opios[\/ ]+([\w\.]+)/i],[w,[_,de+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[w,[_,de+" GX"]],[/\bopr\/([\w\.]+)/i],[w,[_,de]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[w,[_,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[_,w],[/\bddg\/([\w\.]+)/i],[w,[_,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[w,[_,"UC"+q]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[w,[_,"WeChat"]],[/konqueror\/([\w\.]+)/i],[w,[_,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[w,[_,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[w,[_,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[w,[_,"Smart Lenovo "+q]],[/(avast|avg)\/([\w\.]+)/i],[[_,/(.+)/,"$1 Secure "+q],w],[/\bfocus\/([\w\.]+)/i],[w,[_,_e+" Focus"]],[/\bopt\/([\w\.]+)/i],[w,[_,de+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[w,[_,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[w,[_,"Dolphin"]],[/coast\/([\w\.]+)/i],[w,[_,de+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[w,[_,"MIUI "+q]],[/fxios\/([-\w\.]+)/i],[w,[_,_e]],[/\bqihu|(qi?ho?o?|360)browser/i],[[_,"360 "+q]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[_,/(.+)/,"$1 "+q],w],[/samsungbrowser\/([\w\.]+)/i],[w,[_,ye+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[_,/_/g," "],w],[/metasr[\/ ]?([\d\.]+)/i],[w,[_,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[_,"Sogou Mobile"],w],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[_,w],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[_],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[_,C],w],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[_,w],[/\bgsa\/([\w\.]+) .*safari\//i],[w,[_,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[w,[_,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[w,[_,he+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[_,he+" WebView"],w],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[w,[_,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[_,w],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[w,[_,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[w,_],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[_,[w,We,Fe]],[/(webkit|khtml)\/([\w\.]+)/i],[_,w],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[_,"Netscape"],w],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[w,[_,_e+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[_,w],[/(cobalt)\/([\w\.]+)/i],[_,[w,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[E,"amd64"]],[/(ia32(?=;))/i],[[E,pe]],[/((?:i[346]|x)86)[;\)]/i],[[E,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[E,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[E,"armhf"]],[/windows (ce|mobile); ppc;/i],[[E,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[E,/ower/,s,pe]],[/(sun4\w)[;\)]/i],[[E,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[E,pe]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[f,[y,ye],[p,P]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[f,[y,ye],[p,B]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[f,[y,J],[p,B]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[f,[y,J],[p,P]],[/(macintosh);/i],[f,[y,J]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[f,[y,Ce],[p,B]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[f,[y,W],[p,P]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[f,[y,W],[p,B]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[f,/_/g," "],[y,ae],[p,B]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[f,/_/g," "],[y,ae],[p,P]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[f,[y,"OPPO"],[p,B]],[/\b(opd2\d{3}a?) bui/i],[f,[y,"OPPO"],[p,P]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[f,[y,"Vivo"],[p,B]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[f,[y,"Realme"],[p,B]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[f,[y,ge],[p,B]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[f,[y,ge],[p,P]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[f,[y,re],[p,P]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[f,[y,re],[p,B]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[f,[y,"Lenovo"],[p,P]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[f,/_/g," "],[y,"Nokia"],[p,B]],[/(pixel c)\b/i],[f,[y,ee],[p,P]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[f,[y,ee],[p,B]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[f,[y,ke],[p,B]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[f,"Xperia Tablet"],[y,ke],[p,P]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[f,[y,"OnePlus"],[p,B]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[f,[y,te],[p,P]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[f,/(.+)/g,"Fire Phone $1"],[y,te],[p,B]],[/(playbook);[-\w\),; ]+(rim)/i],[f,y,[p,P]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[f,[y,z],[p,B]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[f,[y,le],[p,P]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[f,[y,le],[p,B]],[/(nexus 9)/i],[f,[y,"HTC"],[p,P]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[y,[f,/_/g," "],[p,B]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[f,[y,"Acer"],[p,P]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[f,[y,"Meizu"],[p,B]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[f,[y,"Ulefone"],[p,B]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[y,f,[p,B]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[y,f,[p,P]],[/(surface duo)/i],[f,[y,ne],[p,P]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[f,[y,"Fairphone"],[p,B]],[/(u304aa)/i],[f,[y,"AT&T"],[p,B]],[/\bsie-(\w*)/i],[f,[y,"Siemens"],[p,B]],[/\b(rct\w+) b/i],[f,[y,"RCA"],[p,P]],[/\b(venue[\d ]{2,7}) b/i],[f,[y,"Dell"],[p,P]],[/\b(q(?:mv|ta)\w+) b/i],[f,[y,"Verizon"],[p,P]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[f,[y,"Barnes & Noble"],[p,P]],[/\b(tm\d{3}\w+) b/i],[f,[y,"NuVision"],[p,P]],[/\b(k88) b/i],[f,[y,"ZTE"],[p,P]],[/\b(nx\d{3}j) b/i],[f,[y,"ZTE"],[p,B]],[/\b(gen\d{3}) b.+49h/i],[f,[y,"Swiss"],[p,B]],[/\b(zur\d{3}) b/i],[f,[y,"Swiss"],[p,P]],[/\b((zeki)?tb.*\b) b/i],[f,[y,"Zeki"],[p,P]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[y,"Dragon Touch"],f,[p,P]],[/\b(ns-?\w{0,9}) b/i],[f,[y,"Insignia"],[p,P]],[/\b((nxa|next)-?\w{0,9}) b/i],[f,[y,"NextBook"],[p,P]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[y,"Voice"],f,[p,B]],[/\b(lvtel\-)?(v1[12]) b/i],[[y,"LvTel"],f,[p,B]],[/\b(ph-1) /i],[f,[y,"Essential"],[p,B]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[f,[y,"Envizen"],[p,P]],[/\b(trio[-\w\. ]+) b/i],[f,[y,"MachSpeed"],[p,P]],[/\btu_(1491) b/i],[f,[y,"Rotor"],[p,P]],[/(shield[\w ]+) b/i],[f,[y,"Nvidia"],[p,P]],[/(sprint) (\w+)/i],[y,f,[p,B]],[/(kin\.[onetw]{3})/i],[[f,/\./g," "],[y,ne],[p,B]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[f,[y,Q],[p,P]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[f,[y,Q],[p,B]],[/smart-tv.+(samsung)/i],[y,[p,U]],[/hbbtv.+maple;(\d+)/i],[[f,/^/,"SmartTV"],[y,ye],[p,U]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[y,re],[p,U]],[/(apple) ?tv/i],[y,[f,J+" TV"],[p,U]],[/crkey/i],[[f,he+"cast"],[y,ee],[p,U]],[/droid.+aft(\w+)( bui|\))/i],[f,[y,te],[p,U]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[f,[y,Ce],[p,U]],[/(bravia[\w ]+)( bui|\))/i],[f,[y,ke],[p,U]],[/(mitv-\w{5}) bui/i],[f,[y,ae],[p,U]],[/Hbbtv.*(technisat) (.*);/i],[y,f,[p,U]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[y,Le],[f,Le],[p,U]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,U]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[y,f,[p,x]],[/droid.+; (shield) bui/i],[f,[y,"Nvidia"],[p,x]],[/(playstation [345portablevi]+)/i],[f,[y,ke],[p,x]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[f,[y,ne],[p,x]],[/((pebble))app/i],[y,f,[p,F]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[f,[y,J],[p,F]],[/droid.+; (glass) \d/i],[f,[y,ee],[p,F]],[/droid.+; (wt63?0{2,3})\)/i],[f,[y,Q],[p,F]],[/(quest( \d| pro)?)/i],[f,[y,C],[p,F]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[y,[p,G]],[/(aeobc)\b/i],[f,[y,te],[p,G]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[f,[p,B]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[f,[p,P]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,P]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,B]],[/(android[-\w\. ]{0,9});.+buil/i],[f,[y,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[w,[_,V+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[w,[_,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[_,w],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[w,_]],os:[[/microsoft (windows) (vista|xp)/i],[_,w],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[_,[w,We,st]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[w,We,st],[_,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[w,/_/g,"."],[_,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[_,j],[w,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[w,_],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[_,w],[/\(bb(10);/i],[w,[_,z]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[w,[_,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[w,[_,_e+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[w,[_,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[w,[_,"watchOS"]],[/crkey\/([\d\.]+)/i],[w,[_,he+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[_,$],w],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[_,w],[/(sunos) ?([\w\.\d]*)/i],[[_,"Solaris"],w],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[_,w]]},rt=function(qe,Je){if(typeof qe===h&&(Je=qe,qe=n),!(this instanceof rt))return new rt(qe,Je).getResult();var g=typeof r!==l&&r.navigator?r.navigator:n,b=qe||(g&&g.userAgent?g.userAgent:s),T=g&&g.userAgentData?g.userAgentData:n,ce=Je?O(ft,Je):ft,fe=g&&g.userAgent==b;return this.getBrowser=function(){var ve={};return ve[_]=n,ve[w]=n,Me.call(ve,b,ce.browser),ve[d]=Oe(ve[w]),fe&&g&&g.brave&&typeof g.brave.isBrave==c&&(ve[_]="Brave"),ve},this.getCPU=function(){var ve={};return ve[E]=n,Me.call(ve,b,ce.cpu),ve},this.getDevice=function(){var ve={};return ve[y]=n,ve[f]=n,ve[p]=n,Me.call(ve,b,ce.device),fe&&!ve[p]&&T&&T.mobile&&(ve[p]=B),fe&&ve[f]=="Macintosh"&&g&&typeof g.standalone!==l&&g.maxTouchPoints&&g.maxTouchPoints>2&&(ve[f]="iPad",ve[p]=P),ve},this.getEngine=function(){var ve={};return ve[_]=n,ve[w]=n,Me.call(ve,b,ce.engine),ve},this.getOS=function(){var ve={};return ve[_]=n,ve[w]=n,Me.call(ve,b,ce.os),fe&&!ve[_]&&T&&T.platform&&T.platform!="Unknown"&&(ve[_]=T.platform.replace(/chrome os/i,$).replace(/macos/i,j)),ve},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return b},this.setUA=function(ve){return b=typeof ve===u&&ve.length>H?Le(ve,H):ve,this},this.setUA(b),this};rt.VERSION=o,rt.BROWSER=k([_,w,d]),rt.CPU=k([E]),rt.DEVICE=k([f,y,p,x,B,U,P,F,G]),rt.ENGINE=rt.OS=k([_,w]),e.exports&&(t=e.exports=rt),t.UAParser=rt;var lt=typeof r!==l&&(r.jQuery||r.Zepto);if(lt&&!lt.ua){var At=new rt;lt.ua=At.getResult(),lt.ua.get=function(){return At.getUA()},lt.ua.set=function(qe){At.setUA(qe);var Je=At.getResult();for(var g in Je)lt.ua[g]=Je[g]}}})(typeof window=="object"?window:commonjsGlobal)})(uaParser,uaParser.exports);var uaParserExports=uaParser.exports,__dxlog_file$3="/home/runner/work/dxos/dxos/packages/core/mesh/rpc-tunnel/src/ports/iframe.ts",browser,os;if(typeof navigator<"u"){const e=new uaParserExports.UAParser(navigator.userAgent);browser=e.getBrowser().name,os=e.getOS().name}let sendToIFrame,sendToParentWindow,__dxlog_file2,DXOS_VERSION,ClientRuntime;sendToIFrame=(e,t,r)=>{if(!e.contentWindow){log("IFrame content window missing",{origin:t},{F:__dxlog_file$3,L:24,S:void 0,C:(n,o)=>n(...o)});return}browser==="Chrome"&&os==="iOS"?e.contentWindow.postMessage(r,t):e.contentWindow.postMessage(r,t,[r.payload])},sendToParentWindow=(e,t)=>{browser==="Chrome"&&os==="iOS"?window.parent.postMessage(t,e):window.parent.postMessage(t,e,[t.payload])},createIFramePort=({channel:e,iframe:t,origin:r,onOrigin:n})=>({send:async o=>{if(!r){log("no origin set",{channel:e},{F:__dxlog_file$3,L:62,S:void 0,C:(c,l)=>c(...l)});return}log("sending",{channel:e,data:o.length},{F:__dxlog_file$3,L:66,S:void 0,C:(c,l)=>c(...l)});const s=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),a={channel:e,payload:s};t?sendToIFrame(t,r,a):sendToParentWindow(r,a)},subscribe:o=>{const s=a=>{if(!t&&a.source!==window.parent||t&&a.source!==t.contentWindow)return;const c=a.data&&typeof a.data=="object"&&"channel"in a.data&&"payload"in a.data?a.data:void 0;(c==null?void 0:c.channel)===e&&(r||(r=a.origin,n==null||n(r)),log("received",c,{F:__dxlog_file$3,L:98,S:void 0,C:(l,h)=>l(...h)}),o(new Uint8Array(c.payload)))};return window.addEventListener("message",s),()=>window.removeEventListener("message",s)}}),createIFrame=(e,t,{hidden:r=!0,allow:n}={})=>{const o=()=>{const s=document.createElement("iframe");return s.id=t,s.src=e,r&&s.setAttribute("style","display: none;"),n&&s.setAttribute("allow",n),document.body.appendChild(s),s};return document.getElementById(t)??o()},__dxlog_file2="/home/runner/work/dxos/dxos/packages/core/mesh/rpc-tunnel/src/ports/worker.ts",createWorkerPort=({port:e,channel:t,subscribe:r})=>({send:async n=>{const o=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);e.postMessage({channel:t,payload:o},[o])},subscribe:r??(n=>{const o=s=>{const a=s.data;t&&a.channel!==t||(log.debug("Recieved message",a,{F:__dxlog_file2,L:46,S:void 0,C:(c,l)=>c(...l)}),n(new Uint8Array(a.payload)))};return e.onmessage=o,()=>{e.onmessage=null}})}),DXOS_VERSION="0.5.8",ClientRuntime=class{constructor({spaces:e,halo:t,mesh:r,shell:n}){this.spaces=e,this.halo=t,this.mesh=r,this.shell=n}async open(){await this.mesh._open(),await this.spaces._open(),await this.halo._open()}async close(){await this.halo._close(),await this.spaces._close(),await this.mesh._close()}};function _ts_decorate$1(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}var __dxlog_file$2="/home/runner/work/dxos/dxos/packages/sdk/client/src/client/client.ts",Client=class{constructor(e={}){var r,n;this.version=DXOS_VERSION,this.reloaded=new Event$1,this._ctx=new Context,this._statusUpdate=new Event$1,this._initialized=!1,this._resetting=!1,this._status=MulticastObservable.from(this._statusUpdate,null),this._echoClient=new EchoClient({}),this._instanceId=PublicKey.random().toHex(),typeof window<"u"&&window.location.protocol!=="https:"&&window.location.protocol!=="socket:"&&!window.location.hostname.endsWith("localhost")&&log.warn(`DXOS Client will not function in a non-secure context ${window.location.origin}. Either serve with a certificate or use a tunneling service (https://docs.dxos.org/guide/kube/tunneling.html).`,void 0,{F:__dxlog_file$2,L:112,S:this,C:(o,s)=>o(...s)}),this._options=e;const t=(r=e.config)==null?void 0:r.get("runtime.client.log.filter");if(t){const o=(n=e.config)==null?void 0:n.get("runtime.client.log.prefix");log.config({filter:t,prefix:o},void 0,{F:__dxlog_file$2,L:123,S:this,C:(s,a)=>s(...a)})}this._echoClient.graph.runtimeSchemaRegistry.registerSchema(Properties)}[export_inspect.custom](){return inspectObject(this)}toJSON(){var e,t,r;return{initialized:this.initialized,spaces:(e=this._runtime)==null?void 0:e.spaces,halo:(t=this._runtime)==null?void 0:t.halo,mesh:(r=this._runtime)==null?void 0:r.mesh}}get config(){return invariant$1(this._config,"Client not initialized.",{F:__dxlog_file$2,L:147,S:this,A:["this._config","'Client not initialized.'"]}),this._config}get services(){return invariant$1(this._services,"Client not initialized.",{F:__dxlog_file$2,L:155,S:this,A:["this._services","'Client not initialized.'"]}),this._services}get initialized(){return this._initialized}get status(){return this._status}get spaces(){return invariant$1(this._runtime,"Client not initialized.",{F:__dxlog_file$2,L:176,S:this,A:["this._runtime","'Client not initialized.'"]}),this._runtime.spaces}get halo(){return invariant$1(this._runtime,"Client not initialized.",{F:__dxlog_file$2,L:184,S:this,A:["this._runtime","'Client not initialized.'"]}),this._runtime.halo}get mesh(){return invariant$1(this._runtime,"Client not initialized.",{F:__dxlog_file$2,L:192,S:this,A:["this._runtime","'Client not initialized.'"]}),this._runtime.mesh}get shell(){return invariant$1(this._runtime,"Client not initialized.",{F:__dxlog_file$2,L:200,S:this,A:["this._runtime","'Client not initialized.'"]}),invariant$1(this._runtime.shell,"Shell not available.",{F:__dxlog_file$2,L:201,S:this,A:["this._runtime.shell","'Shell not available.'"]}),this._runtime.shell}get experimental(){const e=this;return{get graph(){return e._echoClient.graph}}}addSchema(...e){const t=e.filter(r=>!this._echoClient.graph.runtimeSchemaRegistry.hasSchema(r));return t.length>0&&this._echoClient.graph.runtimeSchemaRegistry.registerSchema(...t),this}async diagnostics(e={}){var t;return invariant$1((t=this._services)==null?void 0:t.services.SystemService,"SystemService is not available.",{F:__dxlog_file$2,L:239,S:this,A:["this._services?.services.SystemService","'SystemService is not available.'"]}),DiagnosticsCollector.collect(this._config,this.services,e)}async repair(){var t,r,n,o,s,a,c,l;const e={};{const h=this.spaces.get().map(u=>{var d;return(d=u._data.pipeline.currentEpoch)==null?void 0:d.subject.assertion.automergeRoot.slice(10)}).filter(Boolean);if(e.OPFSRemovedFiles=0,typeof navigator<"u"&&navigator.storage){const u=await navigator.storage.getDirectory();for await(const d of u==null?void 0:u.keys())d.includes("automerge_")&&!h.some(f=>d.includes(f))&&(await u.removeEntry(d),e.OPFSRemovedFiles++)}}{const h={runtime:{client:{storage:{dataStore:(n=(r=(t=this.config.values.runtime)==null?void 0:t.client)==null?void 0:r.storage)==null?void 0:n.dataStore}}}};await SaveConfig(h),e.storageConfig=h}{e.levelDBRemovedEntries=0;const h=await createLevel(((a=(s=(o=this._config)==null?void 0:o.values.runtime)==null?void 0:s.client)==null?void 0:a.storage)??{}),u=[h.sublevel("index-store"),h.sublevel("index-metadata").sublevel("clean"),h.sublevel("index-metadata").sublevel("dirty")];for(const d of u)e.levelDBRemovedEntries+=(await d.keys().all()).length,await d.clear()}return await((l=(c=this._services)==null?void 0:c.services.QueryService)==null?void 0:l.reindex(void 0,{timeout:3e4})),log.info("Repair succeeded",{repairSummary:e},{F:__dxlog_file$2,L:307,S:this,C:(h,u)=>h(...u)}),e}async initialize(){if(this._initialized)return;log.trace("dxos.sdk.client.open",trace$1.begin({id:this._instanceId}),{F:__dxlog_file$2,L:321,S:this,C:(n,o)=>n(...o)});const{createClientServices:e,IFrameManager:t,ShellManager:r}=await __vitePreload(async()=>{const{createClientServices:n,IFrameManager:o,ShellManager:s}=await import("./index3.js").then(async a=>(await a.__tla,a));return{createClientServices:n,IFrameManager:o,ShellManager:s}},[]);if(this._ctx=new Context,this._config=this._options.config??new Config,this._services=await(this._options.services??e(this._config,this._options.createWorker)),this._iframeManager=this._options.shell?new t({source:new URL(this._options.shell,window.location.origin)}):void 0,this._shellManager=this._iframeManager?new r(this._iframeManager):void 0,await this._open(),invariant$1(this._runtime,"Client runtime initialization failed.",{F:__dxlog_file$2,L:334,S:this,A:["this._runtime","'Client runtime initialization failed.'"]}),typeof window<"u"){const{mountDevtoolsHooks:n}=await __vitePreload(async()=>{const{mountDevtoolsHooks:o}=await import("./index2.js").then(async s=>(await s.__tla,s));return{mountDevtoolsHooks:o}},[]);n({client:this})}this._initialized=!0,log.trace("dxos.sdk.client.open",trace$1.end({id:this._instanceId}),{F:__dxlog_file$2,L:343,S:this,C:(n,o)=>n(...o)})}async _open(){var _,p,y,w;log("opening...",void 0,{F:__dxlog_file$2,L:347,S:this,C:(E,x)=>E(...x)}),invariant$1(this._services,void 0,{F:__dxlog_file$2,L:348,S:this,A:["this._services",""]});const{SpaceList:e}=await __vitePreload(async()=>{const{SpaceList:E}=await import("./space-list-GVMAD426.js").then(async x=>(await x.__tla,x));return{SpaceList:E}},[]),{HaloProxy:t}=await __vitePreload(async()=>{const{HaloProxy:E}=await import("./halo-proxy-QUHLRYRO.js").then(async x=>(await x.__tla,x));return{HaloProxy:E}},[]),{MeshProxy:r}=await __vitePreload(async()=>{const{MeshProxy:E}=await import("./mesh-proxy-GMDPR3VZ.js").then(async x=>(await x.__tla,x));return{MeshProxy:E}},[]),{IFrameClientServicesHost:n,IFrameClientServicesProxy:o,Shell:s}=await __vitePreload(async()=>{const{IFrameClientServicesHost:E,IFrameClientServicesProxy:x,Shell:B}=await import("./index3.js").then(async P=>(await P.__tla,P));return{IFrameClientServicesHost:E,IFrameClientServicesProxy:x,Shell:B}},[]),a=new Trigger;(_=this._services.closed)==null||_.on(async E=>{log("terminated",{resetting:this._resetting},{F:__dxlog_file$2,L:356,S:this,C:(x,B)=>x(...B)}),E instanceof ApiError&&(log.error("fatal",{error:E},{F:__dxlog_file$2,L:358,S:this,C:(x,B)=>x(...B)}),a.wake(E)),this._resetting||(await this._close(),await this._open(),this.reloaded.emit())}),await this._services.open(),this._echoClient.connectToService({dataService:this._services.services.DataService??raise$1(new Error("DataService not available")),queryService:this._services.services.QueryService??raise$1(new Error("QueryService not available"))}),await this._echoClient.open(this._ctx);const c=new r(this._services,this._instanceId),l=new t(this._services,this._instanceId),h=new e(this._services,this._echoClient,()=>{var E;return(E=l.identity.get())==null?void 0:E.identityKey},this._instanceId),u=this._services instanceof o||this._services instanceof n?this._services._shellManager:this._shellManager,d=u?new s({shellManager:u,identity:l.identity,devices:l.devices,spaces:h}):void 0;this._runtime=new ClientRuntime({spaces:h,halo:l,mesh:c,shell:d}),invariant$1(this._services.services.SystemService,"SystemService is not available.",{F:__dxlog_file$2,L:398,S:this,A:["this._services.services.SystemService","'SystemService is not available.'"]}),this._statusStream=this._services.services.SystemService.queryStatus({interval:3e3}),this._statusStream.subscribe(async({status:E})=>{this._statusTimeout&&clearTimeout(this._statusTimeout),a.wake(void 0),this._statusUpdate.emit(E),this._statusTimeout=setTimeout(()=>{this._statusUpdate.emit(null)},STATUS_TIMEOUT)},E=>{a.wake(E),E&&this._statusUpdate.emit(null)});const f=await a.wait();if(f)throw f;if(await this._runtime.open(),await((p=this._iframeManager)==null?void 0:p.open()),await((y=this._shellManager)==null?void 0:y.open()),(w=this._iframeManager)==null?void 0:w.iframe){const E=this._iframeManager.source.origin==="null"?this._iframeManager.source.toString().split("/").slice(0,3).join("/"):this._iframeManager.source.origin;this._shellClientProxy=createProtoRpcPeer({exposed:clientServiceBundle,handlers:this._services.services,port:createIFramePort({channel:DEFAULT_CLIENT_CHANNEL,iframe:this._iframeManager.iframe,origin:E}),handlerRpcOptions:{timeout:6e4}}),await this._shellClientProxy.open()}log("opened",void 0,{F:__dxlog_file$2,L:452,S:this,C:(E,x)=>E(...x)})}async destroy(){this._initialized&&(await this._close(),this._statusUpdate.emit(null),await this._ctx.dispose(),this._initialized=!1)}async _close(){var e,t,r;log("closing...",void 0,{F:__dxlog_file$2,L:474,S:this,C:(n,o)=>n(...o)}),this._statusTimeout&&clearTimeout(this._statusTimeout),await((e=this._statusStream)==null?void 0:e.close()),await((t=this._runtime)==null?void 0:t.close()),await this._echoClient.close(this._ctx),await((r=this._services)==null?void 0:r.close()),log("closed",void 0,{F:__dxlog_file$2,L:480,S:this,C:(n,o)=>n(...o)})}async resumeHostServices(){invariant$1(this.services.services.SystemService,"SystemService is not available.",{F:__dxlog_file$2,L:489,S:this,A:["this.services.services.SystemService","'SystemService is not available.'"]}),await this.services.services.SystemService.updateStatus({status:SystemStatus.ACTIVE})}async reset(){var e,t;if(!this._initialized)throw new ApiError("Client not open.");log("resetting...",void 0,{F:__dxlog_file$2,L:502,S:this,C:(r,n)=>r(...n)}),this._resetting=!0,invariant$1((e=this._services)==null?void 0:e.services.SystemService,"SystemService is not available.",{F:__dxlog_file$2,L:504,S:this,A:["this._services?.services.SystemService","'SystemService is not available.'"]}),await((t=this._services)==null?void 0:t.services.SystemService.reset()),await this._close(),await this._open(),this._resetting=!1,this.reloaded.emit(),log("reset complete",void 0,{F:__dxlog_file$2,L:510,S:this,C:(r,n)=>r(...n)})}};_ts_decorate$1([trace.info()],Client.prototype,"version",void 0),_ts_decorate$1([trace.info()],Client.prototype,"_services",void 0),_ts_decorate$1([trace.info()],Client.prototype,"_initialized",void 0),_ts_decorate$1([trace.info()],Client.prototype,"_resetting",void 0),_ts_decorate$1([trace.info()],Client.prototype,"_instanceId",void 0),_ts_decorate$1([trace.info({depth:null})],Client.prototype,"toJSON",null),_ts_decorate$1([synchronized],Client.prototype,"initialize",null),_ts_decorate$1([synchronized],Client.prototype,"destroy",null),_ts_decorate$1([synchronized],Client.prototype,"reset",null),Client=_ts_decorate$1([trace.resource()],Client);let __dxlog_file$1,createObservable,lodash_isequalwith;RPC_TIMEOUT=2e4,__dxlog_file$1="/home/runner/work/dxos/dxos/packages/sdk/client/src/invitations/invitations-proxy.ts",createObservable=e=>{const t=new PushStream$1;return e.subscribe(r=>{t.next(r)},r=>{r?t.error(r):t.complete()}),t.observable},InvitationsProxy=class{constructor(e,t,r){this._invitationsService=e,this._identityService=t,this._getInvitationContext=r,this._createdUpdate=new Event$1,this._acceptedUpdate=new Event$1,this._savedUpdate=new Event$1,this._created=MulticastObservable.from(this._createdUpdate,[]),this._accepted=MulticastObservable.from(this._acceptedUpdate,[]),this._saved=MulticastObservable.from(this._savedUpdate,[]),this._invitations=new Set,this._invitationsLoaded=new Trigger,this._opened=!1}get created(){return this._created}get accepted(){return this._accepted}get saved(){return this._saved}get isOpen(){return this._opened}async open(){if(this._opened)return;log("opening...",this._getInvitationContext(),{F:__dxlog_file$1,L:94,S:this,C:(o,s)=>o(...s)}),this._ctx=new Context;const e=new Trigger,t=new Trigger,r=new Trigger,n=this._invitationsService.queryInvitations(void 0,{timeout:RPC_TIMEOUT});n.subscribe(({action:o,type:s,invitations:a,existing:c})=>{switch(o){case QueryInvitationsResponse.Action.ADDED:{log("remote invitations added",{type:s,invitations:a},{F:__dxlog_file$1,L:105,S:this,C:(l,h)=>l(...h)}),a==null||a.filter(l=>this._matchesInvitationContext(l)).filter(l=>!this._invitations.has(l.invitationId)).forEach(l=>{s===QueryInvitationsResponse.Type.CREATED?this.share(l):this.join(l)}),c&&(s===QueryInvitationsResponse.Type.CREATED?t.wake():r.wake());break}case QueryInvitationsResponse.Action.REMOVED:{log("remote invitations removed",{type:s,invitations:a},{F:__dxlog_file$1,L:120,S:this,C:(u,d)=>u(...d)});const l=s===QueryInvitationsResponse.Type.CREATED?this._created:this._accepted,h=s===QueryInvitationsResponse.Type.CREATED?this._createdUpdate:this._acceptedUpdate;a==null||a.forEach(u=>{var f;const d=l.get().findIndex(_=>_.get().invitationId===u.invitationId);(f=l.get()[d])==null||f.cancel(),d>=0&&h.emit([...l.get().slice(0,d),...l.get().slice(d+1)])}),c&&r.wake();break}case QueryInvitationsResponse.Action.LOAD_COMPLETE:{e.wake();break}case QueryInvitationsResponse.Action.SAVED:{log("remote invitations saved",{invitations:a},{F:__dxlog_file$1,L:141,S:this,C:(l,h)=>l(...h)}),this._savedUpdate.emit(a??[]);break}}}),this._ctx.onDispose(()=>n.close()),await e.wait(),await r.wait(),await t.wait(),this._opened=!0,log("opened",this._getInvitationContext(),{F:__dxlog_file$1,L:154,S:this,C:(o,s)=>o(...s)})}async close(){this._opened&&(log("closing...",this._getInvitationContext(),{F:__dxlog_file$1,L:162,S:this,C:(e,t)=>e(...t)}),await this._ctx.dispose(),this._createdUpdate.emit([]),this._acceptedUpdate.emit([]),log("closed",this._getInvitationContext(),{F:__dxlog_file$1,L:166,S:this,C:(e,t)=>e(...t)}))}getInvitationOptions(){return{invitationId:PublicKey.random().toHex(),type:Invitation.Type.INTERACTIVE,authMethod:Invitation.AuthMethod.SHARED_SECRET,state:Invitation.State.INIT,swarmKey:PublicKey.random(),...this._getInvitationContext()}}share(e){const t={...this.getInvitationOptions(),...e};this._invitations.add(t.invitationId);const r=this._created.get().find(o=>o.get().invitationId===t.invitationId);if(r)return r;const n=new CancellableInvitation({initialInvitation:t,subscriber:createObservable(this._invitationsService.createInvitation(t)),onCancel:async()=>{const o=n.get().invitationId;invariant$1(o,"Invitation missing identifier",{F:__dxlog_file$1,L:195,S:this,A:["invitationId","'Invitation missing identifier'"]}),await this._invitationsService.cancelInvitation({invitationId:o})}});return this._createdUpdate.emit([...this._created.get(),n]),n}join(e,t){typeof e=="string"&&(e=InvitationEncoder.decode(e)),invariant$1(e&&e.swarmKey,void 0,{F:__dxlog_file$1,L:208,S:this,A:["invitation && invitation.swarmKey",""]}),this._invitations.add(e.invitationId);const r=e.invitationId,n=this._accepted.get().find(s=>s.get().invitationId===r);if(n)return n;const o=new AuthenticatingInvitation({initialInvitation:e,subscriber:createObservable(this._invitationsService.acceptInvitation({invitation:e,deviceProfile:t})),onCancel:async()=>{const s=o.get().invitationId;invariant$1(s,"Invitation missing identifier",{F:__dxlog_file$1,L:222,S:this,A:["invitationId","'Invitation missing identifier'"]}),await this._invitationsService.cancelInvitation({invitationId:s})},onAuthenticate:async s=>{const a=o.get().invitationId;invariant$1(a,"Invitation missing identifier",{F:__dxlog_file$1,L:227,S:this,A:["invitationId","'Invitation missing identifier'"]}),await this._invitationsService.authenticate({invitationId:a,authCode:s})}});return this._acceptedUpdate.emit([...this._accepted.get(),o]),o}_matchesInvitationContext(e){const t=this._getInvitationContext();return log("checking invitation context",{invitation:e,context:t},{F:__dxlog_file$1,L:239,S:this,C:(r,n)=>r(...n)}),Object.entries(t).reduce((r,[n,o])=>{const s=e[n];return s instanceof PublicKey&&o instanceof PublicKey?r&&s.equals(o):r&&s===o},!0)}},lodash_isequalwith={exports:{}},lodash_isequalwith.exports,function(e,t){var r=200,n="__lodash_hash_undefined__",o=1,s=2,a=9007199254740991,c="[object Arguments]",l="[object Array]",h="[object Boolean]",u="[object Date]",d="[object Error]",f="[object Function]",_="[object GeneratorFunction]",p="[object Map]",y="[object Number]",w="[object Object]",E="[object Promise]",x="[object RegExp]",B="[object Set]",P="[object String]",U="[object Symbol]",F="[object WeakMap]",G="[object ArrayBuffer]",H="[object DataView]",te="[object Float32Array]",J="[object Float64Array]",le="[object Int8Array]",z="[object Int16Array]",q="[object Int32Array]",he="[object Uint8Array]",V="[object Uint8ClampedArray]",_e="[object Uint16Array]",ee="[object Uint32Array]",W=/[\\^$.*+?()[\]{}|]/g,re=/^\[object .+?Constructor\]$/,ne=/^(?:0|[1-9]\d*)$/,ge={};ge[te]=ge[J]=ge[le]=ge[z]=ge[q]=ge[he]=ge[V]=ge[_e]=ge[ee]=!0,ge[c]=ge[l]=ge[G]=ge[h]=ge[H]=ge[u]=ge[d]=ge[f]=ge[p]=ge[y]=ge[w]=ge[x]=ge[B]=ge[P]=ge[F]=!1;var de=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,ye=typeof self=="object"&&self&&self.Object===Object&&self,Ce=de||ye||Function("return this")(),ke=t&&!t.nodeType&&t,ae=ke&&!0&&e&&!e.nodeType&&e,Q=ae&&ae.exports===ke,C=Q&&de.process,$=function(){try{return C&&C.binding("util")}catch{}}(),j=$&&$.isTypedArray;function O($e,je){for(var Ge=-1,be=$e?$e.length:0;++Ge<be;)if(je($e[Ge],Ge,$e))return!0;return!1}function k($e,je){for(var Ge=-1,be=Array($e);++Ge<$e;)be[Ge]=je(Ge);return be}function ue($e){return function(je){return $e(je)}}function pe($e,je){return $e==null?void 0:$e[je]}function Oe($e){var je=!1;if($e!=null&&typeof $e.toString!="function")try{je=!!($e+"")}catch{}return je}function Le($e){var je=-1,Ge=Array($e.size);return $e.forEach(function(be,De){Ge[++je]=[De,be]}),Ge}function Me($e,je){return function(Ge){return $e(je(Ge))}}function We($e){var je=-1,Ge=Array($e.size);return $e.forEach(function(be){Ge[++je]=be}),Ge}var Fe=Array.prototype,st=Function.prototype,ft=Object.prototype,rt=Ce["__core-js_shared__"],lt=function(){var $e=/[^.]+$/.exec(rt&&rt.keys&&rt.keys.IE_PROTO||"");return $e?"Symbol(src)_1."+$e:""}(),At=st.toString,qe=ft.hasOwnProperty,Je=ft.toString,g=RegExp("^"+At.call(qe).replace(W,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),b=Ce.Symbol,T=Ce.Uint8Array,ce=ft.propertyIsEnumerable,fe=Fe.splice,ve=Me(Object.keys,Object),Ne=Pe(Ce,"DataView"),tt=Pe(Ce,"Map"),ct=Pe(Ce,"Promise"),ot=Pe(Ce,"Set"),it=Pe(Ce,"WeakMap"),ut=Pe(Object,"create"),dr=ze(Ne),tr=ze(tt),ir=ze(ct),Wr=ze(ot),qt=ze(it),fr=b?b.prototype:void 0,pr=fr?fr.valueOf:void 0;function Qt($e){var je=-1,Ge=$e?$e.length:0;for(this.clear();++je<Ge;){var be=$e[je];this.set(be[0],be[1])}}function Nr(){this.__data__=ut?ut(null):{}}function Ar($e){return this.has($e)&&delete this.__data__[$e]}function jt($e){var je=this.__data__;if(ut){var Ge=je[$e];return Ge===n?void 0:Ge}return qe.call(je,$e)?je[$e]:void 0}function Jr($e){var je=this.__data__;return ut?je[$e]!==void 0:qe.call(je,$e)}function Xr($e,je){var Ge=this.__data__;return Ge[$e]=ut&&je===void 0?n:je,this}Qt.prototype.clear=Nr,Qt.prototype.delete=Ar,Qt.prototype.get=jt,Qt.prototype.has=Jr,Qt.prototype.set=Xr;function Ut($e){var je=-1,Ge=$e?$e.length:0;for(this.clear();++je<Ge;){var be=$e[je];this.set(be[0],be[1])}}function Zr(){this.__data__=[]}function Dr($e){var je=this.__data__,Ge=Jt(je,$e);if(Ge<0)return!1;var be=je.length-1;return Ge==be?je.pop():fe.call(je,Ge,1),!0}function Yt($e){var je=this.__data__,Ge=Jt(je,$e);return Ge<0?void 0:je[Ge][1]}function _r($e){return Jt(this.__data__,$e)>-1}function en($e,je){var Ge=this.__data__,be=Jt(Ge,$e);return be<0?Ge.push([$e,je]):Ge[be][1]=je,this}Ut.prototype.clear=Zr,Ut.prototype.delete=Dr,Ut.prototype.get=Yt,Ut.prototype.has=_r,Ut.prototype.set=en;function Gt($e){var je=-1,Ge=$e?$e.length:0;for(this.clear();++je<Ge;){var be=$e[je];this.set(be[0],be[1])}}function tn(){this.__data__={hash:new Qt,map:new(tt||Ut),string:new Qt}}function rn($e){return Ie(this,$e).delete($e)}function rr($e){return Ie(this,$e).get($e)}function sr($e){return Ie(this,$e).has($e)}function nn($e,je){return Ie(this,$e).set($e,je),this}Gt.prototype.clear=tn,Gt.prototype.delete=rn,Gt.prototype.get=rr,Gt.prototype.has=sr,Gt.prototype.set=nn;function gr($e){var je=-1,Ge=$e?$e.length:0;for(this.__data__=new Gt;++je<Ge;)this.add($e[je])}function sn($e){return this.__data__.set($e,n),this}function an($e){return this.__data__.has($e)}gr.prototype.add=gr.prototype.push=sn,gr.prototype.has=an;function Ht($e){this.__data__=new Ut($e)}function nr(){this.__data__=new Ut}function cn($e){return this.__data__.delete($e)}function lr($e){return this.__data__.get($e)}function ar($e){return this.__data__.has($e)}function qr($e,je){var Ge=this.__data__;if(Ge instanceof Ut){var be=Ge.__data__;if(!tt||be.length<r-1)return be.push([$e,je]),this;Ge=this.__data__=new Gt(be)}return Ge.set($e,je),this}Ht.prototype.clear=nr,Ht.prototype.delete=cn,Ht.prototype.get=lr,Ht.prototype.has=ar,Ht.prototype.set=qr;function Wt($e,je){var Ge=_t($e)||ht($e)?k($e.length,String):[],be=Ge.length,De=!!be;for(var Ue in $e)qe.call($e,Ue)&&!(De&&(Ue=="length"||Be(Ue,be)))&&Ge.push(Ue);return Ge}function Jt($e,je){for(var Ge=$e.length;Ge--;)if(Ve($e[Ge][0],je))return Ge;return-1}function xr($e){return Je.call($e)}function wr($e,je,Ge,be,De){return $e===je?!0:$e==null||je==null||!mr($e)&&!zt(je)?$e!==$e&&je!==je:hr($e,je,wr,Ge,be,De)}function hr($e,je,Ge,be,De,Ue){var Xe=_t($e),gt=_t(je),at=l,mt=l;Xe||(at=Re($e),at=at==c?w:at),gt||(mt=Re(je),mt=mt==c?w:mt);var St=at==w&&!Oe($e),wt=mt==w&&!Oe(je),xt=at==mt;if(xt&&!St)return Ue||(Ue=new Ht),Xe||br($e)?Qr($e,je,Ge,be,De,Ue):me($e,je,at,Ge,be,De,Ue);if(!(De&s)){var Ot=St&&qe.call($e,"__wrapped__"),Mt=wt&&qe.call(je,"__wrapped__");if(Ot||Mt){var Dt=Ot?$e.value():$e,Ft=Mt?je.value():je;return Ue||(Ue=new Ht),Ge(Dt,Ft,be,De,Ue)}}return xt?(Ue||(Ue=new Ht),xe($e,je,Ge,be,De,Ue)):!1}function $r($e){if(!mr($e)||Qe($e))return!1;var je=It($e)||Oe($e)?g:re;return je.test(ze($e))}function Pr($e){return zt($e)&&Vt($e.length)&&!!ge[Je.call($e)]}function Hr($e){if(!Ye($e))return ve($e);var je=[];for(var Ge in Object($e))qe.call($e,Ge)&&Ge!="constructor"&&je.push(Ge);return je}function Qr($e,je,Ge,be,De,Ue){var Xe=De&s,gt=$e.length,at=je.length;if(gt!=at&&!(Xe&&at>gt))return!1;var mt=Ue.get($e);if(mt&&Ue.get(je))return mt==je;var St=-1,wt=!0,xt=De&o?new gr:void 0;for(Ue.set($e,je),Ue.set(je,$e);++St<gt;){var Ot=$e[St],Mt=je[St];if(be)var Dt=Xe?be(Mt,Ot,St,je,$e,Ue):be(Ot,Mt,St,$e,je,Ue);if(Dt!==void 0){if(Dt)continue;wt=!1;break}if(xt){if(!O(je,function(Ft,Kt){if(!xt.has(Kt)&&(Ot===Ft||Ge(Ot,Ft,be,De,Ue)))return xt.add(Kt)})){wt=!1;break}}else if(!(Ot===Mt||Ge(Ot,Mt,be,De,Ue))){wt=!1;break}}return Ue.delete($e),Ue.delete(je),wt}function me($e,je,Ge,be,De,Ue,Xe){switch(Ge){case H:if($e.byteLength!=je.byteLength||$e.byteOffset!=je.byteOffset)return!1;$e=$e.buffer,je=je.buffer;case G:return!($e.byteLength!=je.byteLength||!be(new T($e),new T(je)));case h:case u:case y:return Ve(+$e,+je);case d:return $e.name==je.name&&$e.message==je.message;case x:case P:return $e==je+"";case p:var gt=Le;case B:var at=Ue&s;if(gt||(gt=We),$e.size!=je.size&&!at)return!1;var mt=Xe.get($e);if(mt)return mt==je;Ue|=o,Xe.set($e,je);var St=Qr(gt($e),gt(je),be,De,Ue,Xe);return Xe.delete($e),St;case U:if(pr)return pr.call($e)==pr.call(je)}return!1}function xe($e,je,Ge,be,De,Ue){var Xe=De&s,gt=Tr($e),at=gt.length,mt=Tr(je),St=mt.length;if(at!=St&&!Xe)return!1;for(var wt=at;wt--;){var xt=gt[wt];if(!(Xe?xt in je:qe.call(je,xt)))return!1}var Ot=Ue.get($e);if(Ot&&Ue.get(je))return Ot==je;var Mt=!0;Ue.set($e,je),Ue.set(je,$e);for(var Dt=Xe;++wt<at;){xt=gt[wt];var Ft=$e[xt],Kt=je[xt];if(be)var we=Xe?be(Kt,Ft,xt,je,$e,Ue):be(Ft,Kt,xt,$e,je,Ue);if(!(we===void 0?Ft===Kt||Ge(Ft,Kt,be,De,Ue):we)){Mt=!1;break}Dt||(Dt=xt=="constructor")}if(Mt&&!Dt){var se=$e.constructor,Se=je.constructor;se!=Se&&"constructor"in $e&&"constructor"in je&&!(typeof se=="function"&&se instanceof se&&typeof Se=="function"&&Se instanceof Se)&&(Mt=!1)}return Ue.delete($e),Ue.delete(je),Mt}function Ie($e,je){var Ge=$e.__data__;return Ke(je)?Ge[typeof je=="string"?"string":"hash"]:Ge.map}function Pe($e,je){var Ge=pe($e,je);return $r(Ge)?Ge:void 0}var Re=xr;(Ne&&Re(new Ne(new ArrayBuffer(1)))!=H||tt&&Re(new tt)!=p||ct&&Re(ct.resolve())!=E||ot&&Re(new ot)!=B||it&&Re(new it)!=F)&&(Re=function($e){var je=Je.call($e),Ge=je==w?$e.constructor:void 0,be=Ge?ze(Ge):void 0;if(be)switch(be){case dr:return H;case tr:return p;case ir:return E;case Wr:return B;case qt:return F}return je});function Be($e,je){return je=je??a,!!je&&(typeof $e=="number"||ne.test($e))&&$e>-1&&$e%1==0&&$e<je}function Ke($e){var je=typeof $e;return je=="string"||je=="number"||je=="symbol"||je=="boolean"?$e!=="__proto__":$e===null}function Qe($e){return!!lt&&lt in $e}function Ye($e){var je=$e&&$e.constructor,Ge=typeof je=="function"&&je.prototype||ft;return $e===Ge}function ze($e){if($e!=null){try{return At.call($e)}catch{}try{return $e+""}catch{}}return""}function Ve($e,je){return $e===je||$e!==$e&&je!==je}function ht($e){return Ct($e)&&qe.call($e,"callee")&&(!ce.call($e,"callee")||Je.call($e)==c)}var _t=Array.isArray;function Tt($e){return $e!=null&&Vt($e.length)&&!It($e)}function Ct($e){return zt($e)&&Tt($e)}function Rt($e,je,Ge){Ge=typeof Ge=="function"?Ge:void 0;var be=Ge?Ge($e,je):void 0;return be===void 0?wr($e,je,Ge):!!be}function It($e){var je=mr($e)?Je.call($e):"";return je==f||je==_}function Vt($e){return typeof $e=="number"&&$e>-1&&$e%1==0&&$e<=a}function mr($e){var je=typeof $e;return!!$e&&(je=="object"||je=="function")}function zt($e){return!!$e&&typeof $e=="object"}var br=j?ue(j):Pr;function Tr($e){return Tt($e)?Wt($e):Hr($e)}e.exports=Rt}(lodash_isequalwith,lodash_isequalwith.exports);var lodash_isequalwithExports=lodash_isequalwith.exports;const isEqualWith=getDefaultExportFromCjs(lodash_isequalwithExports);function _ts_decorate(e,t,r,n){var o=arguments.length,s=o<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,r):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s}let __dxlog_file;__dxlog_file="/home/runner/work/dxos/dxos/packages/sdk/client/src/echo/space-proxy.ts",SpaceProxy=class{constructor(e,t,r){this._clientServices=e,this._data=t,this._ctx=new Context,this._stateUpdate=new Event$1,this._pipelineUpdate=new Event$1,this._databaseInitialized=new Trigger,this._initializationComplete=new Trigger,this._initializing=!1,this._initialized=!1,this._state=MulticastObservable.from(this._stateUpdate,SpaceState.CLOSED),this._pipeline=MulticastObservable.from(this._pipelineUpdate,{}),this._membersUpdate=new Event$1,this._members=MulticastObservable.from(this._membersUpdate,[]),this._databaseOpen=!1,this._error=void 0,this._properties=void 0,log("construct",{key:t.spaceKey,state:SpaceState[t.state]},{F:__dxlog_file,L:90,S:this,C:(o,s)=>o(...s)}),invariant$1(this._clientServices.services.InvitationsService,"InvitationsService not available",{F:__dxlog_file,L:91,S:this,A:["this._clientServices.services.InvitationsService","'InvitationsService not available'"]}),this._invitationsProxy=new InvitationsProxy(this._clientServices.services.InvitationsService,this._clientServices.services.IdentityService,()=>({kind:Invitation.Kind.SPACE,spaceKey:this.key})),this._db=r.constructDatabase({spaceKey:this.key,owningObject:this});const n=this;this._internal={get data(){return n._data},createEpoch:this._createEpoch.bind(this),removeMember:this._removeMember.bind(this)},this._error=this._data.error?decodeError(this._data.error):void 0,this._stateUpdate.emit(this._currentState),this._pipelineUpdate.emit(t.pipeline??{}),this._membersUpdate.emit(t.members??[])}get key(){return this._data.spaceKey}get db(){return this._db}get isOpen(){return this._data.state===SpaceState.READY&&this._initialized}get properties(){if(!this._initialized)throw new Error("Space is not initialized");return invariant$1(this._properties,"Properties not available",{F:__dxlog_file,L:140,S:this,A:["this._properties","'Properties not available'"]}),this._properties}get state(){return this._state}get pipeline(){return this._pipeline}get invitations(){return this._invitationsProxy.created}get members(){return this._members}get internal(){return this._internal}get error(){return this._error}get _currentState(){return this._data.state===SpaceState.READY&&!this._initialized?SpaceState.INITIALIZING:this._data.state}async _processSpaceUpdate(e){var a,c;const t=shouldUpdate(this._data,e),r=shouldPipelineUpdate(this._data,e),n=shouldMembersUpdate(this._data.members,e.members),o=e.state===SpaceState.READY&&!(this._initialized||this._initializing),s=this._data.state!==SpaceState.READY&&e.state===SpaceState.READY&&!this._databaseOpen;if(log("update",{key:e.spaceKey,prevState:SpaceState[this._data.state],state:SpaceState[e.state],emitEvent:t,emitPipelineEvent:r,emitMembersEvent:n,isFirstTimeInitializing:o,isReopening:s},{F:__dxlog_file,L:209,S:this,C:(l,h)=>l(...h)}),this._data=e,o?await this._initialize():s&&await this._initializeDb(),e.error&&(this._error=decodeError(e.error)),this._initialized){const l=(c=(a=e.pipeline)==null?void 0:a.currentEpoch)==null?void 0:c.subject.assertion.automergeRoot;l&&await this._db.setSpaceRoot(l)}t&&this._stateUpdate.emit(this._currentState),r&&this._pipelineUpdate.emit(e.pipeline??{}),n&&this._membersUpdate.emit(e.members)}async _initialize(){this._initializing||this._initialized||(log("initializing...",{space:this.key},{F:__dxlog_file,L:257,S:this,C:(e,t)=>e(...t)}),this._initializing=!0,await this._invitationsProxy.open(),await this._initializeDb(),this._initialized=!0,this._initializing=!1,this._initializationComplete.wake(),this._stateUpdate.emit(this._currentState),this._data.members&&this._membersUpdate.emit(this._data.members),log("initialized",{space:this.key},{F:__dxlog_file,L:267,S:this,C:(e,t)=>e(...t)}))}async _initializeDb(){var t;this._databaseOpen=!0;{let r;(t=this._data.pipeline)!=null&&t.currentEpoch&&(invariant$1(checkCredentialType(this._data.pipeline.currentEpoch,"dxos.halo.credentials.Epoch"),void 0,{F:__dxlog_file,L:277,S:this,A:["checkCredentialType(this._data.pipeline.currentEpoch, 'dxos.halo.credentials.Epoch')",""]}),r=this._data.pipeline.currentEpoch.subject.assertion.automergeRoot),r!==void 0&&await this._db.setSpaceRoot(r),await this._db.open()}log("ready",void 0,{F:__dxlog_file,L:287,S:this,C:(r,n)=>r(...n)}),this._databaseInitialized.wake();const e=new Trigger;{const r=this._db.query(Filter.schema(Properties),{dataLocation:QueryOptions.DataLocation.LOCAL}).subscribe(n=>{n.objects.length===1&&(this._properties=n.objects[0],e.wake(),this._stateUpdate.emit(this._currentState),scheduleMicroTask(this._ctx,()=>{r()}))},{fire:!0})}await warnAfterTimeout(5e3,"Finding properties for a space",()=>cancelWithContext(this._ctx,e.wait()))}async _destroy(){log("destroying...",void 0,{F:__dxlog_file,L:324,S:this,C:(e,t)=>e(...t)}),await this._ctx.dispose(),await this._invitationsProxy.close(),await this._db.close(),this._databaseOpen=!1,log("destroyed",void 0,{F:__dxlog_file,L:329,S:this,C:(e,t)=>e(...t)})}async open(){await this._clientServices.services.SpacesService.updateSpace({spaceKey:this.key,state:SpaceState.ACTIVE})}async close(){await this._db.flush(),await this._clientServices.services.SpacesService.updateSpace({spaceKey:this.key,state:SpaceState.INACTIVE})}async waitUntilReady(){return await cancelWithContext(this._ctx,this._initializationComplete.wait()),this}async postMessage(e,t){invariant$1(this._clientServices.services.SpacesService,"SpacesService not available",{F:__dxlog_file,L:353,S:this,A:["this._clientServices.services.SpacesService","'SpacesService not available'"]}),await this._clientServices.services.SpacesService.postMessage({spaceKey:this.key,channel:e,message:{...t,"@type":t["@type"]||"google.protobuf.Struct"}},{timeout:RPC_TIMEOUT})}listen(e,t){invariant$1(this._clientServices.services.SpacesService,"SpacesService not available",{F:__dxlog_file,L:368,S:this,A:["this._clientServices.services.SpacesService","'SpacesService not available'"]});const r=this._clientServices.services.SpacesService.subscribeMessages({spaceKey:this.key,channel:e},{timeout:RPC_TIMEOUT});return r.subscribe(t),()=>r.close()}share(e){return log("create invitation",e,{F:__dxlog_file,L:381,S:this,C:(t,r)=>t(...r)}),this._invitationsProxy.share({...e,spaceKey:this.key})}updateMemberRole(e){return this._clientServices.services.SpacesService.updateMemberRole({spaceKey:this.key,memberKey:e.memberKey,newRole:e.newRole})}createSnapshot(){return todo()}toJSON(){return{key:this.key.toHex(),state:SpaceState[this.state.get()]}}async _createEpoch({migration:e}={}){await this._clientServices.services.SpacesService.createEpoch({spaceKey:this.key,migration:e})}async _removeMember(e){return this._clientServices.services.SpacesService.updateMemberRole({spaceKey:this.key,memberKey:e,newRole:SpaceMember.Role.REMOVED})}},_ts_decorate([trace.info()],SpaceProxy.prototype,"_initializing",void 0),_ts_decorate([trace.info()],SpaceProxy.prototype,"_initialized",void 0),_ts_decorate([trace.info()],SpaceProxy.prototype,"key",null),_ts_decorate([trace.info()],SpaceProxy.prototype,"isOpen",null),_ts_decorate([trace.info({depth:2})],SpaceProxy.prototype,"properties",null),_ts_decorate([trace.info({enum:SpaceState})],SpaceProxy.prototype,"_currentState",null),_ts_decorate([synchronized],SpaceProxy.prototype,"_processSpaceUpdate",null),_ts_decorate([trace.span({showInBrowserTimeline:!0})],SpaceProxy.prototype,"_initializeDb",null),_ts_decorate([synchronized],SpaceProxy.prototype,"_destroy",null),SpaceProxy=_ts_decorate([trace.resource()],SpaceProxy);var shouldUpdate=(e,t)=>e.state!==t.state,shouldPipelineUpdate=(e,t)=>!isEqualWith(e.pipeline,t.pipeline,loadashEqualityFn),shouldMembersUpdate=(e,t)=>t?!isEqualWith(e,t,loadashEqualityFn):!1,TextKind;(function(e){e[e.PLAIN=0]="PLAIN",e[e.RICH=1]="RICH"})(TextKind||(TextKind={}));const dxos={Client,InvitationEncoder,Expando};window.dxos=dxos,document.dispatchEvent(new CustomEvent("dxos",{detail:dxos}))})();export{clientServiceBundle as $,ApiError as A,DEFAULT_SHELL_CHANNEL as B,ConnectionState$2 as C,DeviceKind as D,EventSubscriptions as E,createIFramePort as F,createProtoRpcPeer as G,RemoteServiceConnectionTimeout as H,InvitationsProxy as I,createWorkerPort as J,DEFAULT_VAULT_URL as K,DEFAULT_INTERNAL_CHANNEL as L,MulticastObservable as M,PROXY_CONNECTION_TIMEOUT as N,parseFilter as O,PublicKey as P,QueryOptions as Q,RPC_TIMEOUT as R,SpaceProxy as S,Trigger as T,LogLevel as U,ShellLayout as V,ComplexSet as W,ClientServicesProviderResource as X,Config as Y,createLibDataChannelTransportFactory as Z,__vitePreload as _,__tla,Event$1 as a,setIdentityTags as a0,synchronized as a1,shellServiceBundle as a2,appServiceBundle as a3,safariCheck as a4,getAsyncValue as a5,WebsocketRpcClient as a6,schema as a7,getProfilePath as a8,DX_RUNTIME as a9,Connection as aa,ConnectionLimiter as ab,ConnectionLog as ac,ConnectionState as ad,EventType as ae,LibDataChannelTransport as af,MAX_CONCURRENT_INITIATING_CONNECTIONS as ag,MMSTTopology as ah,MemoryTransport as ai,MemoryTransportFactory as aj,NetworkManager as ak,SimplePeerTransport as al,SimplePeerTransportService as am,Swarm as an,SwarmMapper as ao,SwarmMessenger as ap,TransportKind as aq,createSimplePeerTransportFactory as ar,createTeleportProtocolFactory as as,DEFAULT_VAULT_ORIGIN as at,SystemStatus as au,index$2 as av,index$1 as aw,index as ax,invariant$1 as b,Invitation as c,asyncTimeout as d,export_inspect as e,AUTH_TIMEOUT as f,trace as g,Context as h,inspectObject as i,TRACE_PROCESSOR as j,createBundledRpcServer as k,log as l,importModule as m,joinTables as n,PushStream$1 as o,SpaceState as p,defaultKey as q,failUndefined as r,scheduleTask as s,trace$1 as t,CREATE_SPACE_TIMEOUT as u,create$2 as v,todo as w,Properties as x,createIFrame as y,ShellDisplay as z};
